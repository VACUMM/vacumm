
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Warm pool &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="index.html"><img src="static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">Home</a>|&nbsp;</li>
        <li><a href="contents.html">Docs</a>|&nbsp;</li>
        <li><a href="user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Warm pool</a><ul>
<li><a class="reference internal" href="#prealables">Préalables</a></li>
<li><a class="reference internal" href="#extension-de-la-warm-pool-a-une-date-donnee">Extension de la <em>Warm pool</em> à une date donnée</a></li>
<li><a class="reference internal" href="#evolution-temporelle-de-la-warm-pool">Évolution temporelle de la <em>warm pool</em></a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/user.desc.proc.warmpool.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="warm-pool">
<span id="user-desc-proc-warmpool"></span><h1>Warm pool<a class="headerlink" href="#warm-pool" title="Permalink to this headline">¶</a></h1>
<p>L’objectif est d’estimer l’accumulation d’eau à la fin de l’été au fond du Golfe de Gascogne,
dans le modèles et les observations satellites.</p>
<div class="section" id="prealables">
<h2>Préalables<a class="headerlink" href="#prealables" title="Permalink to this headline">¶</a></h2>
<p>Un préalable essentiel aux diagnostics est la colocalisation des SST du modèle et satellite,
lue toutes les deux vers minuit.
Cela implique deux considérations importantes :</p>
<blockquote>
<div><ul class="simple">
<li>Les scripts doivent être capables de sappliquer à des données satellites sur grille curvilinéaire.</li>
<li>La colocalisation implique l’interpolation spatiale d’un des deux champs vers la grille de plus basse résolution.</li>
</ul>
</div></blockquote>
<p>La première étape consiste donc à comparer les résolutions des champs en entrée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">resol</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.basemap</span> <span class="k">import</span> <span class="n">merc</span>

<span class="c1"># Résolution du modèle</span>
<span class="n">grid_mod</span> <span class="o">=</span> <span class="n">MARS3D</span><span class="p">(</span><span class="n">cfgmod</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">get_grid</span><span class="p">()</span>
<span class="n">xres_mod</span><span class="p">,</span> <span class="n">yres_mod</span> <span class="o">=</span> <span class="n">resol</span><span class="p">(</span><span class="n">grid_mod</span><span class="p">)</span>

<span class="c1"># Résolution du modèle</span>
<span class="n">grid_sat</span> <span class="o">=</span> <span class="n">Satellite</span><span class="p">(</span><span class="n">cfgsat</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">get_grid</span><span class="p">()</span>
<span class="n">xres_sat</span><span class="p">,</span> <span class="n">yres_sat</span> <span class="o">=</span> <span class="n">resol</span><span class="p">(</span><span class="n">grid_sat</span><span class="p">)</span>

<span class="c1"># Conversions en mètres</span>
<span class="n">xres_mod</span><span class="p">,</span> <span class="n">yres_mod</span> <span class="o">=</span> <span class="n">merc</span><span class="p">(</span><span class="n">xres_mod</span><span class="p">,</span> <span class="n">yres_mod</span><span class="p">)</span>
<span class="n">xres_sat</span><span class="p">,</span> <span class="n">yres_sat</span> <span class="o">=</span> <span class="n">merc</span><span class="p">(</span><span class="n">xres_sat</span><span class="p">,</span> <span class="n">yres_sat</span><span class="p">)</span>

<span class="c1"># Resolution commune X &amp; Y</span>
<span class="n">res_mod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xres_mod</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yres_mod</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">res_sat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xres_sat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yres_sat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Nous devons maintenant choisir quelle sera la grille cible (modèle ou satellite ?).
On se base pour cela sur un facteur limite à définir,
que l’on utilise pour comparer la résolution des deux grilles,
en favorisant le type rectangulaire rectangulaire :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plus le facteur est faible, plus la résolution de la grille</span>
<span class="c1"># satellite curvilinéaire doit être fine pour que cette dernière soit choisie</span>
<span class="n">ratio_curvgrid_choice</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="c1"># Maintenant, le choix</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">isgrid</span>
<span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">grid_sat</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># La grille satellite est bien curvilinéaire</span>

    <span class="n">choose_sat</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_mod</span> <span class="o">/</span> <span class="n">res_sat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ratio_grid_choice</span>

<span class="k">else</span><span class="p">:</span> <span class="c1"># Cas de deux grilles rectangulaires</span>

    <span class="n">choose_sat</span> <span class="o">=</span> <span class="n">res_sat</span> <span class="o">&gt;</span> <span class="n">res_mod</span>
</pre></div>
</div>
<p>Nous devons maintenant colocaliser les champs :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Minuit</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">midnight_interval</span>
<span class="n">midnight</span> <span class="o">=</span> <span class="n">midnight_interval</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
<span class="n">cdms2</span><span class="o">.</span><span class="n">setAutoBounds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Lecture des données vers minuit.</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">MARS3D</span><span class="p">(</span><span class="n">cfgmod</span><span class="p">,</span> <span class="n">midnight</span><span class="p">)</span><span class="o">.</span><span class="n">load_sst</span><span class="p">()</span>
<span class="n">sat</span> <span class="o">=</span> <span class="n">Satellite</span><span class="p">(</span><span class="n">cfgsat</span><span class="p">,</span> <span class="n">midnight</span><span class="p">)</span><span class="o">.</span><span class="n">load_sst</span><span class="p">()</span>

<span class="c1"># Regrillage</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.regridding</span> <span class="k">import</span> <span class="n">regrid2d</span>
<span class="k">if</span> <span class="n">choose_sat</span><span class="p">:</span> <span class="c1"># Vers grille satellite</span>

    <span class="n">mod</span> <span class="o">=</span> <span class="n">regrid2d</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">grid_sat</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span> <span class="c1"># Vers grille modèle</span>

    <span class="n">sat</span> <span class="o">=</span> <span class="n">regrid2d</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">grid_mod</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Par défaut,
la méthode d’interpolation est choisie par la fonction
<a class="reference internal" href="library/misc.grid.regridding.html#vacumm.misc.grid.regridding.regrid_method" title="vacumm.misc.grid.regridding.regrid_method"><code class="xref py py-func docutils literal notranslate"><span class="pre">regrid_method()</span></code></a> en se basant
sur le rapport des résolutions des deux grilles.
Pour plus d’information, voir la section “<span class="xref std std-ref">user.desc.proc.regridding</span>”.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Le regrillage vers une grille satellite curvilinéaire nécessite
d’avoir l’exécutable <strong class="program">scrip</strong> accessible dans la variable d’environnement
<span class="target" id="index-0"></span><a class="reference external" href="https://matplotlib.org/faq/environment_variables_faq.html#envvar-PATH" title="(in Matplotlib v3.0.2)"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PATH</span></code></a>.</p>
</div>
<p>On suppose par la suite que les SST sont colocalisées.</p>
</div>
<div class="section" id="extension-de-la-warm-pool-a-une-date-donnee">
<span id="user-desc-proc-warmpool-extent"></span><h2>Extension de la <em>Warm pool</em> à une date donnée<a class="headerlink" href="#extension-de-la-warm-pool-a-une-date-donnee" title="Permalink to this headline">¶</a></h2>
<p>La <em>warm pool</em> satellite est tracée avec une palette grise
sur un fond de SST du modèle, dont la <em>warm pool</em>  est elle aussi
mise en valeur (avec un contour, par exemple rouge) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inits</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.plot</span> <span class="k">import</span> <span class="n">map2</span>

<span class="c1"># Définition de la warm pool</span>
<span class="n">wp_temp</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">wp_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
<span class="n">wp_linewidth</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="c1"># SST du modèle</span>
<span class="n">levels_mod</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">N</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">map2</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_mod</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">wp_temp</span> <span class="ow">and</span> <span class="n">mod</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">wp_temp</span><span class="p">):</span>
    <span class="n">map2</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">wp_temp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">wp_linewidth</span><span class="p">,</span>
        <span class="n">contour_colors</span><span class="o">=</span><span class="n">wp_color</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="sa">u</span><span class="s1">&#39;Pas de warm pool dans le modèle&#39;</span>

<span class="c1"># SST satellite seulement sur la warm pool</span>
<span class="n">sat</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">wp_temp</span><span class="p">)</span> <span class="c1"># On masque ailleurs</span>
<span class="n">levels_sat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">N</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">wp_temp</span> <span class="ow">and</span> <span class="n">sat</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">wp_temp</span><span class="p">):</span>
    <span class="n">map2</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_sat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cmap_grey&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="sa">u</span><span class="s1">&#39;Pas de warm pool dans les données satellites&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="evolution-temporelle-de-la-warm-pool">
<h2>Évolution temporelle de la <em>warm pool</em><a class="headerlink" href="#evolution-temporelle-de-la-warm-pool" title="Permalink to this headline">¶</a></h2>
<p>Le but est de comparer une mesure de l’évolution temporelle de la
<em>warm pool</em> du modèle et des données satellites.
Cette dernière est estimée en $km^2$ dans trois cas différents, à partir
des SST colocalisées :</p>
<blockquote>
<div><ul class="simple">
<li>Dans le modèle.</li>
<li>Dans le modèle, mais avec un masque commun aux observations.</li>
<li>Dans les observations, avec un masque commun au modèle.</li>
</ul>
</div></blockquote>
<p>À titre indicatif, une estimation du recouvrement des
<em>warm pool</em> modélisée et observée est fournie à travers deux indices
au cours du temps, en se basant sur les champs colocalisés avec même masque :</p>
<blockquote>
<div><ul class="simple">
<li>La fraction de <em>warm pool</em> commune rapportée à la <em>warm pool</em> modélisée.</li>
<li>La fraction de <em>warm pool</em> commune rapportée à la <em>warm pool</em> observée.</li>
</ul>
</div></blockquote>
<p>Pour procéder, nous devons effectuer une boucle temporelle sur les dates
à minuit de l’interval de temps considéré.
Afin d’optimiser un peu les traitements, nous pouvons créer une classe dédiée
à la colocalisation des SST, dont le coeur se base ce qui a été présenté précédemment :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Coloc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Colocalize model and observation SST</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; coloc = Coloc(grid_mod, grid_sst, ratio = ratio_curvgrid_choice)</span>
<span class="sd">        &gt;&gt;&gt; sst_mod, sst_sat = coloc(sst_mod, sst_sat)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_mod</span><span class="p">,</span> <span class="n">grid_sst</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_mod</span> <span class="o">=</span> <span class="n">grid_mod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_sat</span> <span class="o">=</span> <span class="n">grid_sat</span>

        <span class="c1"># Cf. plus haut</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choose_sat</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sst_mod</span><span class="p">,</span> <span class="n">sst_sat</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_sat</span><span class="p">:</span>
            <span class="n">sst_mod</span> <span class="o">=</span> <span class="n">regrid2</span><span class="p">(</span><span class="n">sst_mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_sat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sst_sat</span> <span class="o">=</span> <span class="n">regrid2</span><span class="p">(</span><span class="n">sst_sat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_mod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sst_mod</span><span class="p">,</span> <span class="n">sst_sat</span>
</pre></div>
</div>
<p>La boucle temporelle peut s’écrire ainsi en supposant
que l’ont traite les données par blocs de <code class="docutils literal notranslate"><span class="pre">nmaxdays</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Taille des blocs XYT en jours</span>
<span class="n">nmaxdays</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># Colocalisateur</span>
<span class="n">coloc</span> <span class="o">=</span> <span class="n">Coloc</span><span class="p">(</span><span class="n">grid_mod</span><span class="p">,</span> <span class="n">grid_sat</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio_curvgrid_choice</span><span class="p">)</span>


<span class="c1"># Initialisations</span>
<span class="n">ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">MOD</span><span class="o">=</span><span class="p">[],</span> <span class="n">mod</span><span class="o">=</span><span class="p">[],</span> <span class="n">sat</span><span class="o">=</span><span class="p">[])</span> <span class="c1"># Extensions</span>
<span class="n">rec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mod</span><span class="o">=</span><span class="p">[],</span> <span class="n">sat</span><span class="o">=</span><span class="p">[])</span> <span class="c1"># Recouvrements</span>
<span class="n">ctimes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">areas</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># On boucle sur les jours</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">IterDates</span><span class="p">,</span> <span class="n">Intervals</span>
<span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">Intervals</span><span class="p">((</span><span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span><span class="p">),</span> <span class="p">(</span><span class="n">nmaxdays</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)):</span>

    <span class="c1"># Lecture</span>
    <span class="n">block_mod</span> <span class="o">=</span> <span class="n">MARS3D</span><span class="p">(</span><span class="n">cfgmod</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">load_sst</span><span class="p">()</span>
    <span class="n">block_sat</span> <span class="o">=</span> <span class="n">Satellite</span><span class="p">(</span><span class="n">cfgsat</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">load_sst</span><span class="p">()</span>

    <span class="c1"># Colocalisation</span>
    <span class="n">mod</span><span class="p">,</span> <span class="n">sat</span> <span class="o">=</span> <span class="n">coloc</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">sat</span><span class="p">)</span>

    <span class="c1"># Surface de chaque cellule</span>
    <span class="k">if</span> <span class="n">areas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">meshweights</span><span class="p">,</span> <span class="n">get_xy</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">getGrid</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="n">meshweights</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># proj -&gt; m2</span>
        <span class="n">areas</span> <span class="o">*=</span> <span class="mf">1e-6</span> <span class="c1"># km2</span>

    <span class="c1"># Boucle à minuit</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">IterDates</span><span class="p">(</span><span class="n">midnight_interval</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">))):</span>

        <span class="c1"># Extraction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">block_mod</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;ccb&#39;</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sat</span> <span class="o">=</span> <span class="n">block_sat</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;ccb&#39;</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Calcul des masques</span>
        <span class="n">wp_mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">&gt;</span><span class="n">wp_temp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">wp_sat</span> <span class="o">=</span> <span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">&gt;</span><span class="n">wp_temp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># Aire totale dans le modèle</span>
        <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;MOD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">wp_mod</span><span class="o">*</span><span class="n">areas</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># Fusion des masques modèle/satellite</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">mod</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>

        <span class="c1"># Aire du modèle masqué</span>
        <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">wp_mod</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="n">areas</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># Aire des données satellites</span>
        <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">wp_sat</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="n">areas</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># Recouvrement</span>
        <span class="n">intersect</span> <span class="o">=</span> <span class="p">(</span><span class="n">wp_mod</span><span class="o">*</span><span class="n">wp_sat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">0.</span> <span class="k">else</span> <span class="n">intersect</span><span class="o">/</span><span class="n">ext</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">0.</span> <span class="k">else</span> <span class="n">intersect</span><span class="o">/</span><span class="n">ext</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">])</span>

        <span class="c1"># Dates</span>
        <span class="n">ctimes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">())</span>

<span class="c1"># Concatenations et formattages</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.axes</span> <span class="k">import</span> <span class="n">create_time</span>
<span class="n">taxis</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">ctimes</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">taxis</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ext</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;km^2&#39;</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span>
    <span class="n">var</span><span class="p">[:]</span> <span class="o">*=</span> <span class="mf">100.</span>
<span class="n">ext</span><span class="p">[</span><span class="s1">&#39;MOD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Full model warm pool extent&#39;</span>
<span class="n">ext</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Model warm pool extent restricted to satellite&#39;</span>
<span class="n">ext</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Satellite warm pool extent&#39;</span>
<span class="n">rec</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Fraction of model warm pool common to satellite&#39;</span>
<span class="n">rec</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Fraction of satellite warm pool common to model&#39;</span>

<span class="c1"># Tracé des extensions</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.plot</span> <span class="k">import</span> <span class="n">curve2</span>
<span class="n">curve2</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="s1">&#39;MOD&#39;</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">curve2</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">curve2</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Tracé des fractions de recouvrement</span>
<span class="n">curve2</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">twin</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">curve2</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">],</span> <span class="s1">&#39;bs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On suppose ici que <code class="docutils literal notranslate"><span class="pre">date_max</span></code> désigne une borne ouverte de l’intervalle de temps :
elle n’est donc jamais atteinte explicitement.
Ainsi, l’intervalle <code class="docutils literal notranslate"><span class="pre">('2000',</span> <span class="pre">'2001')</span></code> ne bouclera que sur l’année 2000.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">Home</a>|&nbsp;</li>
        <li><a href="contents.html">Docs</a>|&nbsp;</li>
        <li><a href="user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>