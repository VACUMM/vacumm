
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.diag.spectrum &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.diag.spectrum</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2015)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span>
<span class="kn">from</span> <span class="nn">vacumm.misc</span> <span class="k">import</span> <span class="n">kwfilter</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">resol</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">P</span>
<span class="kn">import</span> <span class="nn">cdms2</span>

<div class="viewcode-block" id="get_kxky"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.get_kxky">[docs]</a><span class="k">def</span> <span class="nf">get_kxky</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate 2D wavenumbers&quot;&quot;&quot;</span>
    <span class="c1"># to work with dimensional axes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">Lx</span> <span class="o">=</span> <span class="n">nlon</span><span class="o">*</span><span class="n">dx</span>
    <span class="n">Ly</span> <span class="o">=</span> <span class="n">nlat</span><span class="o">*</span><span class="n">dy</span>
    <span class="c1"># to work with non-dimensional axes</span>
    <span class="c1"># Lx = N.pi</span>
    <span class="c1"># Ly = Lx * nlat / nlon * dy / dx</span>
    <span class="n">coefx</span> <span class="o">=</span> <span class="n">Lx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">coefy</span> <span class="o">=</span> <span class="n">Ly</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;Lx : </span><span class="si">%s</span><span class="s2"> Ly : </span><span class="si">%s</span><span class="s2"> coefx : </span><span class="si">%s</span><span class="s2"> coefy : </span><span class="si">%s</span><span class="s2">  </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span><span class="p">,</span><span class="n">coefx</span><span class="p">,</span><span class="n">coefy</span><span class="p">)</span>
    <span class="n">kx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">nlon</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">nlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">coefx</span>
    <span class="n">ky</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">coefy</span>
    <span class="p">[</span><span class="n">kkx</span><span class="p">,</span><span class="n">kky</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="p">)</span>
    <span class="n">kk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">kkx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kky</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="p">,</span><span class="n">kkx</span><span class="p">,</span><span class="n">kky</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span></div>


<div class="viewcode-block" id="get_spec"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.get_spec">[docs]</a><span class="k">def</span> <span class="nf">get_spec</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the spectrum of a 2D variable</span>

<span class="sd">    :Return: specvar,nbwave,dk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the resolution in meters</span>
    <span class="n">kwresol</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;resol_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;var1 must be a MV2 array to compute dx and dy&#39;</span><span class="p">)</span>
        <span class="n">kwresol</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ldx</span><span class="p">,</span> <span class="n">ldy</span> <span class="o">=</span> <span class="n">resol</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwresol</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="ow">or</span> <span class="n">ldx</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="ow">or</span> <span class="n">ldy</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var1</span><span class="p">):</span> <span class="n">var1</span><span class="o">=</span> <span class="n">var1</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var2</span><span class="p">):</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>


    <span class="c1"># Part 1 - estimate of the wavenumbers</span>
    <span class="p">[</span><span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="p">,</span><span class="n">kkx</span><span class="p">,</span><span class="n">kky</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_kxky</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;dx = </span><span class="si">%s</span><span class="s2">, fy = </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;kx = &quot;</span><span class="p">,</span><span class="n">kx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;ky = &quot;</span><span class="p">,</span><span class="n">ky</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;kkx[0:3,2] = &quot;</span><span class="p">,</span><span class="n">kkx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;kky[0:3,1] = &quot;</span><span class="p">,</span><span class="n">kky</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;kk[0:3,3] = &quot;</span><span class="p">,</span><span class="n">kk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;shape&quot;</span><span class="p">,</span><span class="n">kx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">ky</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">kkx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">kky</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">kk</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Part 2 - estimate of the spectrum</span>
    <span class="c1"># - fast fourier transform</span>
    <span class="k">if</span> <span class="n">fft</span><span class="p">:</span>
        <span class="n">hat_phi1</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
        <span class="n">hat_phi1</span><span class="o">=</span><span class="n">hat_phi1</span><span class="o">*</span><span class="n">hat_phi1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">hat_phi1</span><span class="o">=</span><span class="n">hat_phi1</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># useless</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hat_phi1</span> <span class="o">=</span> <span class="n">var1</span>

    <span class="k">if</span> <span class="n">var2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fft</span><span class="p">:</span>
            <span class="n">hat_phi2</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span>
            <span class="n">hat_phi2</span><span class="o">=</span><span class="n">hat_phi2</span><span class="o">*</span><span class="n">hat_phi2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">hat_phi2</span><span class="o">=</span><span class="n">hat_phi2</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># useless</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hat_phi2</span> <span class="o">=</span> <span class="n">var2</span>
        <span class="n">hat_spec</span> <span class="o">=</span> <span class="n">hat_phi1</span> <span class="o">+</span> <span class="n">hat_phi2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hat_spec</span> <span class="o">=</span> <span class="n">hat_phi1</span>
    <span class="c1"># - integration of the spectrum</span>
    <span class="c1">#   shift to have values centered on the intervals</span>
    <span class="n">dk</span> <span class="o">=</span> <span class="n">kx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">kx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dk_half</span> <span class="o">=</span> <span class="n">dk</span><span class="o">/</span><span class="mi">2</span>  <span class="c1"># half of the interval</span>
    <span class="n">k_</span><span class="o">=</span> <span class="n">kx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">var1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dk</span>
    <span class="n">specvar</span> <span class="o">=</span> <span class="n">k_</span><span class="o">*</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_</span><span class="p">)):</span>
        <span class="c1"># get indexes that satisfy two conditions</span>
        <span class="c1"># integration over a spectral width</span>
        <span class="n">specvar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">hat_spec</span><span class="p">[</span> <span class="p">(</span><span class="n">kk</span><span class="o">&lt;=</span><span class="n">k_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">dk_half</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kk</span><span class="o">&gt;</span><span class="n">k_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">dk_half</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Normalisation (Danioux 2011)</span>
    <span class="n">specvar</span> <span class="o">/=</span> <span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">var1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dk</span>

    <span class="c1"># Dimensionalization to be able to compare with the litterature</span>
    <span class="n">nbwave</span> <span class="o">=</span> <span class="n">k_</span><span class="o">*</span><span class="mf">1000.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span>     <span class="c1"># from rad/m to km/m</span>
    <span class="n">dk</span> <span class="o">*=</span> <span class="mf">1000.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">specvar</span> <span class="o">*=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">1000.0</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Normalized co-spectrum : </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">specvar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Normalized spectrum : </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">specvar</span>
    <span class="k">return</span> <span class="n">specvar</span><span class="p">,</span><span class="n">nbwave</span><span class="p">,</span><span class="n">dk</span></div>

<div class="viewcode-block" id="get_cospec"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.get_cospec">[docs]</a><span class="k">def</span> <span class="nf">get_cospec</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Co-sprectum of two variables&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="save_spec"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.save_spec">[docs]</a><span class="k">def</span> <span class="nf">save_spec</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">absc</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1">#tmpabsc=N.column_stack((N.load(filename)[&#39;nbwave&#39;],absc))</span>
        <span class="n">tmpvar</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">N</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="s1">&#39;spectrum&#39;</span><span class="p">],</span><span class="n">var</span><span class="p">))</span>
        <span class="n">tmptime</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmpvar</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">tmptime</span> <span class="o">=</span> <span class="n">time</span>
    <span class="n">N</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">spectrum</span><span class="o">=</span><span class="n">tmpvar</span><span class="p">,</span><span class="n">nbwave</span><span class="o">=</span><span class="n">absc</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="n">tmptime</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_loglog_kspec"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.plot_loglog_kspec">[docs]</a><span class="k">def</span> <span class="nf">plot_loglog_kspec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">abscisse</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slope</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># bound the range of the abscisses</span>
    <span class="n">abs_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">abscisse</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">abscisse</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">abs_min</span> <span class="o">=</span> <span class="n">abs_min</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># 90 percent of the value</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">abscisse</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">abscisse</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="n">abs_max</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># 110 percent of the value</span>
    <span class="n">ord_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">ord_min</span> <span class="o">=</span> <span class="n">ord_min</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># 90 percent of the value</span>
    <span class="n">ord_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">ord_max</span> <span class="o">=</span> <span class="n">ord_max</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># 110 percent of the value</span>
    <span class="c1"># straight line with a slope of k**slope</span>
    <span class="n">a</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">abscisse</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">abscisse</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">abscisse</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="n">slope</span>
    <span class="n">line</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="n">abscisse</span><span class="o">**</span><span class="n">slope</span>
    <span class="c1"># figure</span>
    <span class="n">P</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">P</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">abscisse</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">basex</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">abscisse</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">basex</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">text</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">abscisse</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">abscisse</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">abscisse</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span><span class="n">text</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">abs_min</span><span class="p">,</span><span class="n">abs_max</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">P</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_semilogx_kspec"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.plot_semilogx_kspec">[docs]</a><span class="k">def</span> <span class="nf">plot_semilogx_kspec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">abscisse</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># bound the range of the abscisses</span>
    <span class="n">abs_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">abscisse</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">abscisse</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">abs_min</span> <span class="o">=</span> <span class="n">abs_min</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># 90 percent of the value</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">abscisse</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">abscisse</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="n">abs_max</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># 110 percent of the value</span>
    <span class="n">ord_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">ord_min</span> <span class="o">=</span> <span class="n">ord_min</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># 90 percent of the value</span>
    <span class="n">ord_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">ord_max</span> <span class="o">=</span> <span class="n">ord_max</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># 110 percent of the value</span>
    <span class="c1"># figure</span>
    <span class="n">P</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">P</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">abscisse</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">basex</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">abs_min</span><span class="p">,</span><span class="n">abs_max</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">P</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="energy_spectrum"><a class="viewcode-back" href="../../../library/diag.spectrum.html#vacumm.diag.spectrum.energy_spectrum">[docs]</a><span class="k">def</span> <span class="nf">energy_spectrum</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dispfig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">latmean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the energy spectrum of a 2D variable&quot;&quot;&quot;</span>
    <span class="c1"># Guess dx and/or dy</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;var must be a MV2 array to compute dx and dy&#39;</span><span class="p">)</span>
        <span class="n">kwresol</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ldx</span><span class="p">,</span> <span class="n">ldy</span> <span class="o">=</span> <span class="n">resol</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwresol</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="ow">or</span> <span class="n">ldx</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="ow">or</span> <span class="n">ldy</span>

    <span class="k">if</span> <span class="n">latmean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;You must provide explicitly latmean&#39;</span><span class="p">)</span>
        <span class="n">latmean</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Numpy arrays</span>
    <span class="n">sshbox</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">else</span> <span class="n">var</span>

    <span class="c1">#####################################################</span>
    <span class="c1"># estimate of the spatial resolution and the latitude</span>
    <span class="c1">#####################################################</span>

    <span class="n">grav</span> <span class="o">=</span> <span class="mf">9.81</span>
    <span class="c1">#latmean = int(float(latmean))</span>
    <span class="c1">#dx = int(grid[0])*np.cos(np.pi*latmean/180.)</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mf">24.</span><span class="o">*</span><span class="mf">3600.</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">latmean</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
    <span class="n">gof0</span> <span class="o">=</span> <span class="n">grav</span><span class="o">/</span><span class="n">f0</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;the spatial resolution of the grid is constant </span><span class="se">\n</span><span class="s2"> dx = </span><span class="si">%s</span><span class="s2"> m, dy = </span><span class="si">%s</span><span class="s2"> m&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;the averaged latitude is </span><span class="si">%s</span><span class="s2"> degrees</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">latmean</span><span class="p">)</span>


    <span class="c1">###############################################</span>
    <span class="c1">#  1ST PART ANALYZE FROM THE SEA SURFACE HEIGHT</span>
    <span class="c1">#  --------------------------------------------</span>
    <span class="c1">###############################################</span>

    <span class="c1"># zonal average and its removing from ssh</span>
    <span class="c1"># mean on i (we erase 1 dimension)</span>
    <span class="c1"># and duplication along i (depends on sshbox.mean(1).shape)</span>
    <span class="c1"># then we need to transpose to have constant value along i and variations along j</span>
    <span class="c1">#revoir sshbox = sshbox - N.tile( sshbox.mean(1),(sshbox.shape[1],1) ).T</span>
    <span class="c1"># plot of ssh (box domain)</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(sshbox,sshbox.shape[0],sshbox.shape[1],&#39;ssh_box_minus_iaverage&#39;)</span>

    <span class="c1"># estimate of the rms to further check</span>
    <span class="n">sshbox_rms</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">sshbox</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;rms of the ssh over the region of interest (from physical field) : </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">sshbox_rms</span>

    <span class="c1">################################</span>
    <span class="c1"># create a double periodic field</span>
    <span class="c1">################################</span>

    <span class="n">ssh2per</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">sshbox</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">ssh2per</span><span class="p">[</span><span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sshbox</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::]</span>
    <span class="n">ssh2per</span><span class="p">[::,</span><span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">ssh2per</span><span class="p">[::,</span><span class="mi">0</span><span class="p">:</span><span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(ssh2per,ssh2per.shape[0],ssh2per.shape[1],&#39;ssh_double_periodic&#39;)</span>
    <span class="k">del</span> <span class="n">sshbox</span>

    <span class="c1"># estimate of the rms to further check</span>
    <span class="n">ssh2per_rms</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">ssh2per</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;rms of the double periodic ssh over the region of interest (from physical field) : </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">ssh2per_rms</span>

    <span class="c1">################################</span>
    <span class="c1"># wavenumber spectrum of the ssh (double periodic field)</span>
    <span class="c1">################################</span>

    <span class="c1"># estimate of the spectrum</span>
    <span class="n">ssh2per_spec</span><span class="p">,</span> <span class="n">ssh2per_k</span><span class="p">,</span> <span class="n">dk</span> <span class="o">=</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">ssh2per</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="s1">&#39;x2k&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>  <span class="c1"># sshbox in physical space</span>

    <span class="c1"># make sure the FFT is correct : we must have the same rms either from physics or from wavenumbers</span>
    <span class="n">ssh2per_rmsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">ssh2per_spec</span><span class="o">*</span><span class="n">dk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;rms of the ssh over the region of interest (from wave number fields) : </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">ssh2per_rmsk</span>

    <span class="c1"># figure</span>
    <span class="k">if</span> <span class="n">dispfig</span><span class="p">:</span> <span class="n">plot_loglog_kspec</span><span class="p">(</span><span class="n">ssh2per_spec</span><span class="p">,</span> <span class="n">ssh2per_k</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;ssh2per_spec&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPECTRUM OF SSH (double periodic)&#39;</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ctime</span><span class="p">),</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavenumber (cycles/km)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;SSH [m^2/(cycle/km)]&#39;</span><span class="p">,</span>
        <span class="n">slope</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>


    <span class="c1">###########################################</span>
    <span class="c1"># the ssh pectrum after doubling the domain</span>
    <span class="c1"># is much better than the previous one</span>
    <span class="c1">###########################################</span>

    <span class="c1">####################################################</span>
    <span class="c1">#  2ND PART ANALYZIS FROM THE GEOSTROPHIC VELOCITIES</span>
    <span class="c1">#  -------------------------------------------------</span>
    <span class="c1">####################################################</span>

    <span class="c1">###########################################</span>
    <span class="c1"># estimate of the geostrophic velocities (from the spectrum of the periodic field of ssh)</span>
    <span class="c1">###########################################</span>

    <span class="c1"># estimate of the wavenumbers</span>
    <span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="p">,</span><span class="n">kkx</span><span class="p">,</span><span class="n">kky</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span> <span class="o">=</span> <span class="n">get_kxky</span><span class="p">(</span><span class="n">ssh2per</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># estimate of the velocities from the spectrum of the ssh</span>
    <span class="n">ussh</span> <span class="o">=</span> <span class="o">-</span><span class="n">gof0</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">kky</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ssh2per</span><span class="p">))</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">vssh</span> <span class="o">=</span>  <span class="n">gof0</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">kkx</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ssh2per</span><span class="p">))</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(ussh,ussh.shape[0],ussh.shape[1],&#39;ussh (from double periodic field spectral method) &#39;)</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(vssh,vssh.shape[0],vssh.shape[1],&#39;vssh (from double periodic field and spectral method) &#39;)</span>
    <span class="n">ssh2per_shape</span> <span class="o">=</span> <span class="n">ssh2per</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">del</span> <span class="n">ssh2per</span>

    <span class="c1">#######################################################</span>
    <span class="c1"># wavenumber co-spectrum of the geostrophic velocities (eke)</span>
    <span class="c1">#######################################################</span>

    <span class="c1"># estimate of the co-spectrum</span>
    <span class="n">uv2per_cospec</span><span class="p">,</span><span class="n">eke_k</span><span class="p">,</span><span class="n">dk</span> <span class="o">=</span> <span class="n">get_cospec</span><span class="p">(</span><span class="n">ussh</span><span class="p">,</span> <span class="n">vssh</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># estimate of the eke to further check</span>
    <span class="n">uv2per_rmsk</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">((</span><span class="n">uv2per_cospec</span><span class="o">*</span><span class="n">dk</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;eke over the region of interest (from physical field) : </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">uv2per_rmsk</span>
    <span class="c1"># make sure the FFT is correct : we must have the same rms either from physics or from wavenumbers</span>
    <span class="c1">#ssh2per_rmsk = N.sqrt( (ssh2per_spec*dk).mean() )</span>
    <span class="c1">#if verbose: print &quot;eke over the region of interest (from physical field) : %s \n&quot; %sshbox_rms</span>
    <span class="c1">#if verbose: print &quot;rms of the ssh over the region of interest (from wave number fields) : %s \n&quot; %ssh2per_rmsk</span>
    <span class="c1">#if verbose: print &quot;rms difference (wavenumber - physics) : %s \n&quot; %(ssh2per_rmsk-ssh2per_rms)</span>

    <span class="c1"># figure</span>
    <span class="k">if</span> <span class="n">dispfig</span><span class="p">:</span>
        <span class="n">plot_loglog_kspec</span><span class="p">(</span><span class="n">uv2per_cospec</span><span class="p">,</span> <span class="n">eke_k</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;eke2per_spec&#39;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPECTRUM OF EKE&#39;</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ctime</span><span class="p">),</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavenumber (cycles/km)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;EKE [(m/s)^2/(cycle/km)]&#39;</span><span class="p">)</span>


    <span class="c1">####################################################</span>
    <span class="c1">#  3RD PART ESTIMATE OF THE FLUXES OF ENERGY</span>
    <span class="c1">#  -------------------------------------------------</span>
    <span class="c1">####################################################</span>

    <span class="c1">###########################################</span>
    <span class="c1"># estimate of the production of eke</span>
    <span class="c1">###########################################</span>

    <span class="c1"># geostrophic velocities in the spectral space are non zero in the bottom-left corner</span>
    <span class="n">ug</span> <span class="o">=</span> <span class="n">ussh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="k">del</span> <span class="n">ussh</span>
    <span class="n">ug</span><span class="p">[</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],::]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ug</span><span class="p">[::,</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">vg</span> <span class="o">=</span> <span class="n">vssh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="k">del</span> <span class="n">vssh</span>
    <span class="n">vg</span><span class="p">[</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],::]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">vg</span><span class="p">[::,</span><span class="n">ssh2per_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(ug,ug.shape[0],ug.shape[1],&#39;ug (from the spectrum of the periodic ssh)&#39;)</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(vg,vg.shape[0],vg.shape[1],&#39;vg (from the spectrum of the periodic ssh)&#39;)</span>


    <span class="n">u</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ug</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">vg</span><span class="p">)</span>

    <span class="n">ugx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">kkx</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">ugy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">kky</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">vgx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">kkx</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">vgy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">kky</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">term_u</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ug</span><span class="o">*</span><span class="n">ugx</span> <span class="o">+</span> <span class="n">vg</span><span class="o">*</span><span class="n">ugy</span><span class="p">)</span>
    <span class="n">term_v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ug</span><span class="o">*</span><span class="n">vgx</span> <span class="o">+</span> <span class="n">vg</span><span class="o">*</span><span class="n">vgy</span><span class="p">)</span>
    <span class="n">eke_prod</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span> <span class="n">u</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">*</span><span class="n">term_u</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">*</span><span class="n">term_v</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">eke_prod_phys1</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">eke_prod</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(eke_prod_phys1,eke_prod_phys1.shape[0],eke_prod_phys1.shape[1],&#39;eke_prod_phys1&#39;)</span>

    <span class="n">term_u</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kkx</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ug</span><span class="o">*</span><span class="n">ug</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kky</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">vg</span><span class="o">*</span><span class="n">ug</span><span class="p">)</span>
    <span class="n">term_v</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kkx</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">ug</span><span class="o">*</span><span class="n">vg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kky</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">vg</span><span class="o">*</span><span class="n">vg</span><span class="p">)</span>
    <span class="n">eke_prod</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span> <span class="n">u</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">*</span><span class="n">term_u</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">*</span><span class="n">term_v</span> <span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">eke_prod_phys2</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">eke_prod</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(eke_prod_phys2,eke_prod_phys2.shape[0],eke_prod_phys2.shape[1],&#39;eke_prod_phys2&#39;)</span>
    <span class="c1">#if options.dispfig: plot.contour_xy(eke_prod_phys1-eke_prod_phys2,eke_prod_phys2.shape[0],eke_prod_phys2.shape[1],&#39;diff_eke_prod&#39;)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">eke_prod_phys1</span><span class="o">-</span><span class="n">eke_prod_phys2</span>

    <span class="c1"># estimate of the total energy flux of the momentum equation</span>
    <span class="n">gg_spec</span><span class="p">,</span> <span class="n">gg_k</span><span class="p">,</span> <span class="n">dk</span> <span class="o">=</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">eke_prod</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># phi in Fourier space</span>

    <span class="c1"># choose kmax1 such that it corresponds to gg_k(kmax1) &lt; 1/(3*dx)*1000 [km/m] (2dx Shanon + take into account diffusion)</span>
    <span class="n">kmax1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gg_k</span><span class="o">&gt;=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">,</span><span class="n">gg_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;Shanon criterium kmax1 = </span><span class="si">%s</span><span class="s2">, gg_k(kmax1) = </span><span class="si">%s</span><span class="s2">, gg_k(kmax1+1) = </span><span class="si">%s</span><span class="s2">, 1/(3.0*dx)*1000. = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">kmax1</span><span class="p">,</span><span class="n">gg_k</span><span class="p">[</span><span class="n">kmax1</span><span class="p">],</span><span class="n">gg_k</span><span class="p">[</span><span class="n">kmax1</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)</span>
    <span class="c1"># integration from large scales to small ones (shift one large scales)</span>
    <span class="n">tpi</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">gg_spec</span><span class="p">[</span> <span class="n">i</span><span class="p">:</span><span class="n">kmax1</span> <span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax1</span><span class="p">)]</span> <span class="p">)</span>
    <span class="n">tpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.</span>

    <span class="c1"># figure</span>
    <span class="k">if</span> <span class="n">dispfig</span><span class="p">:</span>
        <span class="n">plot_semilogx_kspec</span><span class="p">(</span><span class="n">tpi</span><span class="p">,</span> <span class="n">gg_k</span><span class="p">[:</span><span class="n">kmax1</span><span class="p">],</span> <span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;ssh_spec&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;TOTAL ENERGY FLUX&#39;</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ctime</span><span class="p">),</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavenumber (cycles/km)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Sum of EKE from small scales to k [(m/s)^2/(cycle/km)]&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;The end !&quot;</span>

    <span class="k">del</span> <span class="n">grav</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">gof0</span><span class="p">,</span><span class="n">sshbox_rms</span><span class="p">,</span><span class="n">ssh2per_rms</span><span class="p">,</span><span class="n">dk</span><span class="p">,</span><span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="p">,</span><span class="n">kkx</span><span class="p">,</span><span class="n">kky</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span><span class="p">,</span><span class="n">uv2per_rmsk</span><span class="p">,</span><span class="n">ug</span><span class="p">,</span><span class="n">vg</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">term_u</span><span class="p">,</span><span class="n">term_v</span><span class="p">,</span><span class="n">ugx</span><span class="p">,</span><span class="n">ugy</span><span class="p">,</span><span class="n">vgx</span><span class="p">,</span><span class="n">vgy</span><span class="p">,</span><span class="n">eke_prod</span><span class="p">,</span><span class="n">eke_prod_phys1</span><span class="p">,</span><span class="n">eke_prod_phys2</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">gg_spec</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ssh2per_spec</span><span class="p">,</span> <span class="n">ssh2per_k</span><span class="p">,</span> <span class="n">uv2per_cospec</span><span class="p">,</span> <span class="n">eke_k</span><span class="p">,</span> <span class="n">tpi</span><span class="p">,</span> <span class="n">gg_k</span><span class="p">[:</span><span class="n">kmax1</span><span class="p">]</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>