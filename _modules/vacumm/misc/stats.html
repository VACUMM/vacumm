
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.misc.stats &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.misc.stats</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;Statistical tools&quot;&quot;&quot;</span>

<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2015)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span><span class="o">,</span><span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">MA</span><span class="o">,</span><span class="nn">MV2</span>
<span class="kn">import</span> <span class="nn">cdms2</span>
<span class="kn">import</span> <span class="nn">cdtime</span>
<span class="kn">from</span> <span class="nn">genutil.statistics</span> <span class="k">import</span> <span class="n">percentiles</span>

<span class="kn">from</span> <span class="nn">vacumm</span> <span class="k">import</span> <span class="n">VACUMMError</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.axes</span> <span class="k">import</span> <span class="n">isaxis</span><span class="p">,</span> <span class="n">create_time</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">get_grid</span><span class="p">,</span> <span class="n">set_grid</span>
<span class="kn">from</span> <span class="nn">vacumm.misc</span> <span class="k">import</span> <span class="n">MV2_axisConcatenate</span><span class="p">,</span> <span class="n">set_atts</span><span class="p">,</span> <span class="n">cp_atts</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.io</span> <span class="k">import</span> <span class="n">netcdf4</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">comptime</span><span class="p">,</span> <span class="n">reltime</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;corr_proba&#39;</span><span class="p">,</span> <span class="s1">&#39;ensrank&#39;</span><span class="p">,</span> <span class="s1">&#39;qtmin&#39;</span><span class="p">,</span> <span class="s1">&#39;qtmax&#39;</span><span class="p">,</span> <span class="s1">&#39;qtminmax&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StatAccum&#39;</span><span class="p">,</span> <span class="s1">&#39;StatAccumError&#39;</span><span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<div class="viewcode-block" id="corr_proba"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.corr_proba">[docs]</a><span class="k">def</span> <span class="nf">corr_proba</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">ndataset</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Probability of rejecting correlations</span>

<span class="sd">    - **r**: Correlation coefficient</span>
<span class="sd">    - **ndata**: Number of records use for correlations</span>
<span class="sd">    - **ndataset**, optional:  Number of datasets (1 for autocorrelations, else 2) [default: 2]</span>

<span class="sd">    .. todo::</span>

<span class="sd">        This must be rewritten using :mod:`scipy.stats`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: use scipy for betai and _gamma?</span>
    <span class="kn">from</span> <span class="nn">genutil.salstat</span> <span class="k">import</span> <span class="n">betai</span><span class="p">,</span><span class="n">_gammaln</span>

    <span class="c1"># Basic tests</span>
    <span class="n">ndata</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">ndata</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">MA</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">MA</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="mf">1.</span><span class="p">),</span><span class="n">r</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Degree of freedom</span>
    <span class="k">if</span> <span class="n">dof</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ndata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ndata</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">ndataset</span>

    <span class="c1"># Advanced test: prevent extreme values by locally decreasing the dof</span>
    <span class="n">reduc</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">MA</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">MA</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="o">-</span><span class="mf">600.</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">reduc</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dfr</span> <span class="o">=</span> <span class="n">df</span><span class="o">/</span><span class="n">reduc</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">MV2</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dfr</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">r</span><span class="p">)))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dfr</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">/</span><span class="p">(</span><span class="n">dfr</span><span class="o">+</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">_gammaln</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="n">_gammaln</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-</span><span class="n">_gammaln</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">MA</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">MA</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Perfom the test and format the variable</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">betai</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">),</span><span class="n">axes</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;corr_proba&#39;</span> <span class="p">;</span> <span class="n">prob</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">id</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Probability of rejection&#39;</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span>

    <span class="k">return</span> <span class="n">prob</span></div>


<div class="viewcode-block" id="ensrank"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.ensrank">[docs]</a><span class="k">def</span> <span class="nf">ensrank</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">gethist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getnrz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the rank of a reference (observations) in an ensemble</span>

<span class="sd">    If ``nens`` is the size of the ensemble,</span>
<span class="sd">    the rank may go from ``0`` to ``nens``.</span>

<span class="sd">    - **obs**, (...): Observation array</span>
<span class="sd">    - **ens**, (nens,...): Ensemble array</span>
<span class="sd">    - **getrank**, optional: If True, return also the rank histogram</span>
<span class="sd">    - **getnrz**, optional: If True, return also non recovery zones</span>
<span class="sd">    - **centered**, optional: Center the ensemble data on the observations</span>
<span class="sd">      before computing the rank</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check</span>
    <span class="n">ens</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">nens</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Your ensemble is too small (nens=</span><span class="si">%i</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">nens</span>

    <span class="c1"># Inits</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">rank</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span>
    <span class="n">rank</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Rank&#39;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">rank</span><span class="o">.</span><span class="n">units</span>
    <span class="n">nrz</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">nrz</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;nrz&#39;</span>
    <span class="n">nrz</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Non recovery zones&#39;</span>
    <span class="n">nrz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked</span>

    <span class="c1"># Sort ensemble at each pixel and compute the min biais</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">obs</span>
    <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
        <span class="n">bias</span> <span class="o">-=</span> <span class="n">bias</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nrz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">bias</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="n">bias</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nrz</span><span class="p">)</span>
    <span class="n">nrz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nrz</span><span class="p">)</span>


    <span class="c1"># Index of member  = rank</span>
    <span class="n">rank</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bias</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">bias</span>

    <span class="c1">## Apply observation mask</span>
    <span class="c1">#nrz[:] = MV2.masked_where(MV2.getmask(obs), nrz, copy=0)</span>
    <span class="c1">#rank[:] = MV2.masked_where(MV2.getmask(obs), rank, copy=0)</span>

    <span class="c1"># Rank histogram</span>
    <span class="k">if</span> <span class="n">gethist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nens</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Out</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">gethist</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">hist</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">getnrz</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">nrz</span><span class="p">,</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="qtminmax"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.qtminmax">[docs]</a><span class="k">def</span> <span class="nf">qtminmax</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">qt</span><span class="o">=</span><span class="mf">5.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get min and max using quantiles</span>

<span class="sd">    This is useful for very asymmetic distributions</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: A numeric array.</span>
<span class="sd">        - **qt**, optional: Percentile used to define min and max</span>

<span class="sd">            - Single number: ``qt`` -&gt; ``[qt, 100-qt]``</span>
<span class="sd">            - Two elements: used directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var</span><span class="p">):</span> <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qt</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">qt</span> <span class="o">=</span> <span class="p">[</span><span class="n">qt</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="n">qt</span><span class="p">]</span>
    <span class="n">qt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">qt</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">100.</span><span class="p">))</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">qt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span></div>

<div class="viewcode-block" id="qtmin"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.qtmin">[docs]</a><span class="k">def</span> <span class="nf">qtmin</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">qt</span><span class="o">=</span><span class="mf">5.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get min max using quantiles</span>

<span class="sd">    This is useful for very asymmetic distributions</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: A numeric array.</span>
<span class="sd">        - **qt**, optional: Percentile used to define min</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var</span><span class="p">):</span> <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
    <span class="n">qt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">([</span><span class="n">qt</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">qt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vmin</span></div>

<div class="viewcode-block" id="qtmax"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.qtmax">[docs]</a><span class="k">def</span> <span class="nf">qtmax</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">qt</span><span class="o">=</span><span class="mf">95.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get max using quantiles</span>

<span class="sd">    This is useful for very asymmetic distributions</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: A numeric array.</span>
<span class="sd">        - **qt**, optional: Percentile used to define max</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var</span><span class="p">):</span> <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
    <span class="n">qt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">([</span><span class="n">qt</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">qt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vmax</span></div>


<div class="viewcode-block" id="StatAccumError"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccumError">[docs]</a><span class="k">class</span> <span class="nc">StatAccumError</span><span class="p">(</span><span class="n">VACUMMError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="StatAccum"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum">[docs]</a><span class="k">class</span> <span class="nc">StatAccum</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Statistics accumulator</span>

<span class="sd">    :Generic params:</span>

<span class="sd">        - **t/sall**: Perform all the statistics by default.</span>
<span class="sd">        - **withtime**, optional: Input does not contain a time dimension.</span>

<span class="sd">    :Single:</span>
<span class="sd">        - **tcount/scount**: Number of observations taken into account</span>
<span class="sd">        - **tavail/savail**: Percentage of available observations</span>
<span class="sd">        - **tmean/smean**: Temporal (t) / Spatial (s) average</span>
<span class="sd">        - **tstd/sstd**: Temporal (t) / Spatial (s) std</span>

<span class="sd">    :Dual:</span>
<span class="sd">        - **tall**: Perform all the following statistics by default.</span>
<span class="sd">        - **tbias/sbias**: Temporal (t) / Spatial (s) bias</span>
<span class="sd">        - **trms/srms**: Temporal (t) / Spatial (s) RMS</span>
<span class="sd">        - **tcrms/scrms**: Temporal (t) / Spatial (s) centered RMS</span>
<span class="sd">        - **tcorr/scorr**: Temporal (t) / Spatial (s) Correlation</span>

<span class="sd">    :Example:</span>


<span class="sd">        &gt;&gt;&gt; sa = StatAccum(tbias=True, srms=True)</span>
<span class="sd">        &gt;&gt;&gt; sa += ssta1, sstb1</span>
<span class="sd">        &gt;&gt;&gt; sa += ssta2, sstb2</span>
<span class="sd">        &gt;&gt;&gt; tbias = sa.get_tbias()</span>
<span class="sd">        &gt;&gt;&gt; srms = sa.get_srms()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">single_stats</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span>
    <span class="n">dual_stats</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;crms&#39;</span><span class="p">,</span> <span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="s1">&#39;avail&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="n">single_stats</span> <span class="o">+</span> <span class="n">dual_stats</span>
    <span class="n">_single_accums</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;sqr&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;hist&#39;</span>
    <span class="n">_dual_accums</span> <span class="o">=</span> <span class="s1">&#39;prod&#39;</span><span class="p">,</span>
    <span class="n">default_restart_file</span> <span class="o">=</span> <span class="s1">&#39;stataccum_restart.nc&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">tall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tavail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tstd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tbias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tcrms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tcorr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tcount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sstd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sbias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">srms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scrms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scorr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restart_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">withtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Restart?</span>
        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restart</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">restart_file</span> <span class="o">=</span> <span class="n">restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span> <span class="o">=</span> <span class="n">restart_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="s1">&#39;st&#39;</span><span class="p">:</span>
                <span class="n">activate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">stype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_stats</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">stype</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">stype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">activate</span> <span class="o">|=</span> <span class="n">value</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">activate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="o">=</span> <span class="n">withtime</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tall</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sall</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span>
                            <span class="s2">&quot;You must set the &#39;bins&#39; keyword to make histograms&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tall</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sall</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;hbin&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Histogram bin centers&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dual</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span>

<div class="viewcode-block" id="StatAccum.append"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append data to the accumulator&quot;&quot;&quot;</span>
        <span class="c1"># Initialization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Two variables?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nitems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="o">&gt;</span><span class="mi">1</span>

            <span class="c1"># Do we have time in input variables</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Flags</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tbias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcorr</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sbias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmean</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trms</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tavail</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smean</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">savail</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmean</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcorr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsqr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcorr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcorr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smean</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssqr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstd</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Check spatial statistics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span> <span class="ow">and</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">savail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scount</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Init template for output temporal statistics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span> <span class="o">=</span> <span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">=</span> <span class="p">()</span>
                <span class="n">selspace</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">tpl</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">selspace</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">tpl</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                        <span class="nb">delattr</span><span class="p">(</span><span class="n">tpl</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span> <span class="o">+=</span> <span class="n">tpl</span><span class="p">,</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                        <span class="n">htpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_t2ht_</span><span class="p">(</span><span class="n">tpl</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">+=</span> <span class="n">htpl</span><span class="p">,</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">()[</span><span class="n">selspace</span><span class="p">]</span><span class="o">*</span><span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thbase</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

            <span class="c1"># Save some attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atts</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">att</span><span class="p">):</span>
                        <span class="n">attr</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_atts</span> <span class="o">+=</span> <span class="n">attr</span><span class="p">,</span>


            <span class="c1"># Init accumulated variables</span>

            <span class="c1"># - temporal statistics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsum</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="c1"># - square</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsqr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tsqr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsqr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="c1"># - product</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tprod</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># - count</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># - min/max</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="c1"># - histograms</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_thist</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thbase</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="c1"># - spatial statistics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">#                for name in self.all_stats:</span>
<span class="c1">#                    if not getattr(self, &#39;s&#39;+name): continue</span>
<span class="c1">#                    self._sstats[name] = []</span>
<span class="c1">#                    setattr(self, &#39;_s&#39;+name, [])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scount</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span><span class="s2">&quot;Cant&#39; accumulate statistics since they are all are OFF.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span><span class="s2">&quot;You must always provide two variables for accumulating stats&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span><span class="s2">&quot;Compared variables must have the same shape: </span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># As 2D (time-space) zero-filled arrays</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">item0</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">item0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
            <span class="n">item1</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">item1</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask0</span> <span class="o">|</span> <span class="n">mask1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask0</span>
        <span class="n">item0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="p">:</span>
            <span class="n">item0m</span> <span class="o">=</span> <span class="n">item0</span>
        <span class="n">item0</span> <span class="o">=</span> <span class="n">item0</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
            <span class="n">item1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="p">:</span>
                <span class="n">item1m</span> <span class="o">=</span> <span class="n">item1</span>
            <span class="n">item1</span> <span class="o">=</span> <span class="n">item1</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># Accumulate</span>

        <span class="c1"># - temporal statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span> <span class="o">+=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">+=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tsum</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">item0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsum</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">item1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsqr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tsqr</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">item0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsqr</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">item1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tprod</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tprod</span><span class="p">[:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">item0</span><span class="o">*</span><span class="n">item1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">item0m</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vmin</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">item1m</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vmin</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">vmin</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">:</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">item0m</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vmax</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">item1m</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vmax</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">vmax</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                <span class="n">indices0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">item0</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">indices0</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">indices1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">item1</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
                    <span class="n">indices1</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">):</span>
                    <span class="n">valid0</span> <span class="o">=</span> <span class="n">indices0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">valid0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ib</span><span class="p">]</span> <span class="o">+=</span> <span class="n">valid0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                        <span class="n">valid1</span> <span class="o">=</span> <span class="n">indices1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">valid1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_thist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ib</span><span class="p">]</span> <span class="o">+=</span> <span class="n">valid1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">indices0</span><span class="p">,</span> <span class="n">valid0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="k">del</span> <span class="n">indices1</span><span class="p">,</span> <span class="n">valid1</span>


        <span class="c1"># - spatial statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span>

            <span class="c1"># Count</span>
            <span class="n">scount</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#            if self.savail:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scount</span><span class="p">)</span>

            <span class="c1"># Base</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssum</span><span class="p">:</span>
                <span class="n">ssum</span> <span class="o">=</span> <span class="n">item0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="n">ssum</span> <span class="o">+=</span> <span class="n">item1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssqr</span><span class="p">:</span>
                <span class="n">ssqr</span> <span class="o">=</span> <span class="p">(</span><span class="n">item0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">ssqr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">item1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sprod</span><span class="p">:</span>
                <span class="n">sprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">item0</span><span class="o">*</span><span class="n">item1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="p">:</span>
                <span class="n">smin</span> <span class="o">=</span> <span class="n">item0m</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">smin</span> <span class="o">+=</span> <span class="n">item1m</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span><span class="p">:</span>
                <span class="n">smax</span> <span class="o">=</span> <span class="n">item0m</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">smax</span> <span class="o">+=</span> <span class="n">item1m</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span><span class="p">:</span>
                <span class="n">indices0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">item0</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">indices0</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                    <span class="n">indices1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">item1</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
                    <span class="n">indices1</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">shist</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">item0</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="p">),</span> <span class="s1">&#39;l&#39;</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="n">shist</span> <span class="o">+=</span> <span class="n">shist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>

                <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">):</span>
                    <span class="n">valid0</span> <span class="o">=</span> <span class="n">indices0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">shist</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+=</span> <span class="n">valid0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span>
                        <span class="n">valid1</span> <span class="o">=</span> <span class="n">indices1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">shist</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+=</span> <span class="n">valid1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="c1"># Stats</span>
            <span class="n">sstats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base2stats_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">scount</span><span class="p">,</span> <span class="n">ssum</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssum</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">ssqr</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssqr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sprod</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sprod</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">smin</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smax</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">shist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">srms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scorr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scount</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shist</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sstats</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="c1">#                self._sstats[key].append(val)</span>
<span class="c1">#                getattr(self, &#39;_s&#39;+key).append(val)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">([],</span> <span class="p">[]))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="c1"># Time axes (for concatenation)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Save iterative status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="StatAccum.isempty"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.isempty">[docs]</a>    <span class="k">def</span> <span class="nf">isempty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="o">==</span><span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">_template_t2ht_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpl</span><span class="p">):</span>
        <span class="n">htpl</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,)</span><span class="o">+</span><span class="n">tpl</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">htpl</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">]</span><span class="o">+</span><span class="n">tpl</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
        <span class="n">set_grid</span><span class="p">(</span><span class="n">htpl</span><span class="p">,</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">tpl</span><span class="p">))</span>
        <span class="n">cp_atts</span><span class="p">(</span><span class="n">tpl</span><span class="p">,</span> <span class="n">htpl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">htpl</span>

    <span class="k">def</span> <span class="nf">_asarray_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge a list of arrays along time&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="k">def</span> <span class="nf">_aslist_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split an array along time&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dump_array_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump an array or a list of them in a nctdf file&quot;&quot;&quot;</span>
        <span class="n">istime</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">ishist</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span> <span class="ow">in</span> <span class="nb">id</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asarray_</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">istime</span> <span class="ow">and</span> <span class="n">ishist</span><span class="p">),</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ishist</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">istime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="s1">&#39;fd&#39;</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="mf">1e20</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_array_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">istime</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">istime</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aslist_</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span>

<div class="viewcode-block" id="StatAccum.dump"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump the current instance to a netcdf file&quot;&quot;&quot;</span>

        <span class="c1"># File</span>
        <span class="n">netcdf4</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span>
        <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_restart_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span> <span class="o">=</span> <span class="n">restart_file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">restart_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">restart_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># Config</span>
        <span class="c1"># - what was initially asked and some more</span>
        <span class="k">for</span> <span class="n">sname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_stats</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;sqr&#39;</span><span class="p">,</span> <span class="s1">&#39;prod&#39;</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="s1">&#39;st&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">sname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">sname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># - current status</span>
        <span class="n">f</span><span class="o">.</span><span class="n">iterindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span>
        <span class="n">f</span><span class="o">.</span><span class="n">nitems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">withtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">lasttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">nitems</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># Still no data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="c1"># - already had some data</span>
        <span class="n">f</span><span class="o">.</span><span class="n">dual</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span>
        <span class="n">f</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt</span>
        <span class="n">f</span><span class="o">.</span><span class="n">nts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nts</span>
        <span class="n">f</span><span class="o">.</span><span class="n">tstats</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">sstats</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">)</span>

        <span class="c1"># Spatial statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span>

            <span class="c1"># Time axes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
                <span class="n">taxes</span> <span class="o">=</span> <span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span><span class="p">):</span>
                    <span class="n">taxis</span> <span class="o">=</span> <span class="n">MV2_axisConcatenate</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
                    <span class="n">taxis</span><span class="o">.</span><span class="n">stataccum_oldid</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">taxis</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">taxes</span> <span class="o">+=</span> <span class="n">taxis</span><span class="p">,</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)]</span>

            <span class="c1"># Count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scount</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;scount&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">taxes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Other stats</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;s</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="n">taxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">taxes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Temporal statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span>

            <span class="c1"># Main axis</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

            <span class="c1"># Count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;tcount&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

            <span class="c1"># Other stats</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dual_accums</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_single_accums</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_t&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dual_accums</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dump_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;t</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>


            <span class="c1"># Templates</span>
            <span class="n">ttemplates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span><span class="p">]</span>
<span class="c1">#            if self.thist:</span>
<span class="c1">#                ttemplates.append(self._thtemplates)</span>
            <span class="k">for</span> <span class="n">ttpls</span> <span class="ow">in</span> <span class="n">ttemplates</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ttpl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ttpls</span><span class="p">):</span>
<span class="c1">#                    ttpl = ttpl.clone(copyData=0)</span>
<span class="c1">#                    for ia, axis in enumerate(ttpl.getAxisList()): #FIXME:grid cloning</span>
<span class="c1">#                        ttpl.setAxis(ia, axis.clone(copyData=0))</span>
                    <span class="n">_add_id_prefix_</span><span class="p">(</span><span class="n">ttpl</span><span class="p">,</span> <span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ttpl</span><span class="p">)</span>
                    <span class="n">_rm_id_prefix_</span><span class="p">(</span><span class="n">ttpl</span><span class="p">,</span> <span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">)</span>

        <span class="c1"># Attributes</span>
        <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">atts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atts</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
            <span class="n">var</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_atts&#39;</span><span class="o">%</span><span class="n">ivar</span>
            <span class="n">var</span><span class="o">.</span><span class="n">stataccum_id</span> <span class="o">=</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;var_att_axis&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

<span class="c1">#        self._ttemplates, self._thtemplates, self._atts, self._tbase</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span></div>


<div class="viewcode-block" id="StatAccum.load"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterindex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nowtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the current instance from a netcdf file</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **restart_file**, optional: Netcdf restart file.</span>
<span class="sd">            - **iterindex**, optional: If given, the restart file is not loaded if</span>
<span class="sd">              ``iterindex`` is greater or equal to the file&#39;s ``iterindex`` attribute.</span>
<span class="sd">            - **nowtime**, optional: If given, the restart file is not loaded if</span>
<span class="sd">              ``nowtime`` is greater or equal to the file&#39;s ``lasttime`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># File</span>
        <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span>
        <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_restart_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span> <span class="o">=</span> <span class="n">restart_file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

        <span class="c1"># Config</span>
        <span class="c1"># - check status</span>
        <span class="k">if</span> <span class="n">iterindex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span> <span class="o">=</span> <span class="n">iterindex</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;iterindex&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">iterindex</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">nowtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">nowtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lasttime&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">withtime</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span>
                <span class="ow">and</span> <span class="n">reltime</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lasttime</span><span class="p">,</span> <span class="s1">&#39;hours since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span>
                <span class="n">reltime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span><span class="p">,</span> <span class="s1">&#39;hours since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># - what was initially asked and some more</span>
        <span class="k">for</span> <span class="n">sname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_stats</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;sqr&#39;</span><span class="p">,</span> <span class="s1">&#39;prod&#39;</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="s1">&#39;st&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">sname</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">sname</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">sname</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="c1"># - current status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">iterindex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nitems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">nitems</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">withtime</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span>  <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">withtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttime</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">s2c</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lasttime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;hbin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># Still no data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># - already had some data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dual</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">nt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">nts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tstats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">sstats</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Spatial statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span>

            <span class="c1"># Time axes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span><span class="p">):</span>
                    <span class="n">taxis</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">tvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aslist_</span><span class="p">(</span><span class="n">taxis</span><span class="p">[:])</span>
                    <span class="n">oldid</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">stataccum_oldid</span>
                    <span class="k">for</span> <span class="n">tvals</span> <span class="ow">in</span> <span class="n">tvalues</span><span class="p">:</span>
                        <span class="n">tx</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">tvals</span><span class="p">,</span> <span class="n">taxis</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">oldid</span><span class="p">)</span>
                        <span class="n">cp_atts</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">oldid</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>

            <span class="c1"># Count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;scount&#39;</span><span class="p">)</span>

            <span class="c1"># Other stats</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_stats</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">:</span> <span class="c1"># single var</span>
                    <span class="n">vid</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">key</span>
                    <span class="k">if</span> <span class="n">vid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vid</span><span class="p">),</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># two vars</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">):</span>
                        <span class="n">vid</span> <span class="o">=</span> <span class="s1">&#39;s</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">vid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vid</span><span class="p">),</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual_stats</span><span class="p">:</span>
                <span class="n">vid</span> <span class="o">=</span> <span class="s1">&#39;s</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">key</span>
                <span class="k">if</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vid</span><span class="p">)</span>

        <span class="c1"># Temporal statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span>

            <span class="c1"># Count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;tcount&#39;</span><span class="p">)</span>

            <span class="c1"># Other stats</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dual_accums</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_single_accums</span><span class="p">:</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="n">key</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dual_accums</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tid</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">tid</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_array_</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">tid</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># Templates</span>
            <span class="c1"># - base arrays</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tbase</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thbase</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">),</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
            <span class="c1"># - cdat templates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">i</span>
                <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">vname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vname</span> <span class="o">!=</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;atts&#39;</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">ttpl</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
                <span class="n">_rm_id_prefix_</span><span class="p">(</span><span class="n">ttpl</span><span class="p">,</span> <span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span> <span class="o">+=</span> <span class="n">ttpl</span><span class="p">,</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_t2ht_</span><span class="p">(</span><span class="n">ttpl</span><span class="p">),</span>

        <span class="c1"># Attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atts</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nitems</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;var</span><span class="si">%i</span><span class="s1">_atts&#39;</span><span class="o">%</span><span class="n">ivar</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stataccum_id&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stataccum_id&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atts</span> <span class="o">+=</span> <span class="n">attrs</span><span class="p">,</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span></div>




    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base2stats_</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">sqr</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span>
            <span class="n">domean</span><span class="p">,</span> <span class="n">dostd</span><span class="p">,</span> <span class="n">dobias</span><span class="p">,</span> <span class="n">dorms</span><span class="p">,</span> <span class="n">docrms</span><span class="p">,</span> <span class="n">docorr</span><span class="p">,</span> <span class="n">doavail</span><span class="p">,</span>
            <span class="n">docount</span><span class="p">,</span> <span class="n">domin</span><span class="p">,</span> <span class="n">domax</span><span class="p">,</span>
            <span class="n">dohist</span><span class="p">):</span>

        <span class="c1"># Denominators</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">count</span><span class="o">==</span><span class="mi">0</span>
            <span class="n">count_</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">countd</span> <span class="o">=</span>  <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">count_</span><span class="p">)</span>
<span class="c1">#            bad = count&lt;2</span>
<span class="c1">#            count = N.where(bad, 2, count)</span>
<span class="c1">#            countdm1 =  N.where(bad, 0., 1./(count-1))</span>
<span class="c1">#            del count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">countd</span> <span class="o">=</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.</span><span class="o">/</span><span class="n">count</span>
<span class="c1">#            countdm1 = 0. if scount &lt; 2 else 1./(count-1)</span>

        <span class="c1"># Check dual inputs</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39; sum&#39;</span><span class="p">,</span><span class="s1">&#39; sqr&#39;</span><span class="p">,</span><span class="s1">&#39; prod&#39;</span><span class="p">,</span><span class="s1">&#39; vmin&#39;</span><span class="p">,</span><span class="s1">&#39; vmax&#39;</span><span class="p">,</span><span class="s1">&#39; hist&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">dual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">dual</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">dual</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sum0</span><span class="p">,</span> <span class="n">sum1</span> <span class="o">=</span> <span class="nb">sum</span>
            <span class="k">if</span> <span class="n">sqr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sqr0</span><span class="p">,</span> <span class="n">sqr1</span> <span class="o">=</span> <span class="n">sqr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sum0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sqr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sqr0</span> <span class="o">=</span> <span class="n">sqr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Init</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Count</span>
        <span class="k">if</span> <span class="n">docount</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Availability</span>
        <span class="k">if</span> <span class="n">doavail</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="n">size</span>

       <span class="c1"># Mean</span>
        <span class="k">if</span> <span class="n">domean</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum0</span> <span class="o">*</span> <span class="n">countd</span>
            <span class="k">if</span> <span class="n">dual</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">sum1</span> <span class="o">*</span> <span class="n">countd</span>


        <span class="c1"># Standard deviation &amp; sum(Xi&#39;^2) &amp; sum(Yi&#39;^2)</span>
        <span class="k">if</span> <span class="n">dostd</span> <span class="ow">or</span> <span class="n">docorr</span><span class="p">:</span>
            <span class="n">sqrp0</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sum0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">countd</span> <span class="c1"># sum(Xi&#39;^2)</span>
            <span class="n">sqrp0</span> <span class="o">+=</span> <span class="n">sqr0</span>
            <span class="k">if</span> <span class="n">dostd</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqrp0</span> <span class="o">*</span> <span class="n">countd</span><span class="p">)</span><span class="c1">#m1)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">docorr</span><span class="p">:</span> <span class="k">del</span> <span class="n">sqrp0</span>
            <span class="k">if</span> <span class="n">dual</span><span class="p">:</span>
                <span class="n">sqrp1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sum1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">countd</span> <span class="c1"># sum(Yi&#39;^2)</span>
                <span class="n">sqrp1</span> <span class="o">+=</span> <span class="n">sqr1</span>
                <span class="k">if</span> <span class="n">dostd</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqrp1</span> <span class="o">*</span> <span class="n">countd</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">docorr</span><span class="p">:</span> <span class="k">del</span> <span class="n">sqrp1</span>

        <span class="c1"># Bias</span>
        <span class="k">if</span> <span class="n">dobias</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum1</span><span class="o">-</span><span class="n">sum0</span><span class="p">)</span> <span class="o">*</span> <span class="n">countd</span>

        <span class="c1"># Absolute RMS</span>
        <span class="k">if</span> <span class="n">dorms</span><span class="p">:</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">sqr0</span> <span class="o">+</span> <span class="n">sqr1</span>
            <span class="n">rms</span> <span class="o">-=</span> <span class="n">prod</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rms</span> <span class="o">*</span> <span class="n">countd</span><span class="p">)</span><span class="c1">#m1)</span>
            <span class="k">del</span> <span class="n">sqr0</span><span class="p">,</span> <span class="n">sqr1</span><span class="p">,</span> <span class="n">rms</span>

        <span class="c1"># sum(Xi&#39;Yi&#39;)</span>
        <span class="k">if</span> <span class="n">docrms</span> <span class="ow">or</span> <span class="n">docorr</span><span class="p">:</span>
            <span class="n">prodp</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">-</span> <span class="n">sum0</span> <span class="o">*</span> <span class="n">sum1</span> <span class="o">*</span> <span class="n">countd</span>

        <span class="c1"># Centered RMS</span>
        <span class="k">if</span> <span class="n">docrms</span><span class="p">:</span>
            <span class="n">crms</span> <span class="o">=</span> <span class="n">sqrp0</span> <span class="o">+</span> <span class="n">sqrp1</span>
            <span class="n">crms</span> <span class="o">-=</span> <span class="n">prodp</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">docorr</span><span class="p">:</span> <span class="k">del</span> <span class="n">prodp</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;crms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">crms</span> <span class="o">*</span> <span class="n">countd</span><span class="p">)</span><span class="c1">#m1)</span>
            <span class="k">del</span> <span class="n">crms</span>

        <span class="c1"># Correlation</span>
        <span class="k">if</span> <span class="n">docorr</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prodp</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqrp0</span><span class="o">*</span><span class="n">sqrp1</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">prodp</span><span class="p">,</span> <span class="n">sqrp0</span><span class="p">,</span> <span class="n">sqrp1</span>

        <span class="c1"># Min/max</span>
        <span class="k">if</span> <span class="n">domin</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span> <span class="k">if</span> <span class="n">dual</span> <span class="k">else</span> <span class="n">vmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domax</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span> <span class="k">if</span> <span class="n">dual</span> <span class="k">else</span> <span class="n">vmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Histograms</span>
        <span class="k">if</span> <span class="n">dohist</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span> <span class="k">if</span> <span class="n">dual</span> <span class="k">else</span> <span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_checkstat_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get statistics &#39;</span><span class="si">%s</span><span class="s2">&#39; since still nothing has been accumulated&quot;</span><span class="o">%</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StatAccumError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get statistics &#39;</span><span class="si">%s</span><span class="s2">&#39; since it set to OFF&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_masks_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">mask0</span> <span class="o">=</span> <span class="n">count</span><span class="o">&lt;</span><span class="mi">1</span>
<span class="c1">#        mask1 = count&lt;2</span>
        <span class="k">del</span> <span class="n">count</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">]:</span>
                <span class="n">masks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask0</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]:</span>
                <span class="n">masks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask0</span>
        <span class="k">return</span> <span class="n">masks</span>



    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_var_</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">templates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">htemplates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Some inits</span>
        <span class="n">ist</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;Temporal &#39;</span> <span class="k">if</span> <span class="n">ist</span> <span class="k">else</span> <span class="s1">&#39;Spatial &#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;copy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Aways have a list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span><span class="p">]</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">single</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">templates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">templates</span> <span class="o">=</span> <span class="p">[</span><span class="n">templates</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">htemplates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">htemplates</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">htemplates</span> <span class="o">=</span> <span class="p">[</span><span class="n">htemplates</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">({},</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>

        <span class="c1"># Long_name</span>
        <span class="n">long_name</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;avail&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;availability&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;count&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;average&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;standard deviation&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;bias&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;bias&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;rms&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;absolute RMS difference&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;crms&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;centered RMS difference&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;corr&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;correlation&#39;</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;hist&#39;</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39;histogram&#39;</span>

        <span class="c1"># Type change</span>
        <span class="k">if</span> <span class="s1">&#39;count&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vv</span><span class="p">):</span>

            <span class="c1"># From template or not</span>
            <span class="n">hvar</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="c1"># Histogram-like variables: first axis = bins</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">htemplates</span> <span class="ow">and</span> <span class="n">hvar</span>
            <span class="k">if</span> <span class="n">templates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># From axis (sstats)</span>
                <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
<span class="c1">#                    if hvar and not ist:</span>
<span class="c1">#                        v = N.ma.transpose(v) # time first, not bins</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">templates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="c1">#                    try:</span>
<span class="c1">#                        var.setAxis(int(hist), templates[i])</span>
<span class="c1">#                    except:</span>
<span class="c1">#                        pass</span>
                    <span class="k">if</span> <span class="n">hist</span><span class="p">:</span>
                        <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">htemplates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                 <span class="c1"># From variable (tstats)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">htemplates</span> <span class="k">if</span> <span class="n">hvar</span> <span class="k">else</span> <span class="n">templates</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">v</span>

            <span class="c1"># Type</span>
            <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

            <span class="c1"># Mask</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">size</span><span class="o">!=</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span>
                <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Attributes</span>
            <span class="c1"># - id and long_name</span>
            <span class="n">var</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">long_name</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="n">suffix</span>
            <span class="c1"># - single stats</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s2">&quot;long_name&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>
            <span class="c1"># - dual stats</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;crms&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span> <span class="c1"># loop on both variables attributes</span>
                    <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">attr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
                        <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s2">&quot;long_name&quot;</span> <span class="ow">in</span> <span class="n">attr</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">long_name</span><span class="o">==</span><span class="n">long_name</span><span class="p">:</span>
                        <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>
            <span class="n">vv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

        <span class="k">if</span> <span class="n">single</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>


<div class="viewcode-block" id="StatAccum.get_tstats"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tstats">[docs]</a>    <span class="k">def</span> <span class="nf">get_tstats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all temporal statistics as a dictionary&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstats</span><span class="p">:</span> <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># From cache</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cache_titerindex&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tstats</span>

        <span class="c1"># Compute stats</span>
        <span class="n">tstats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base2stats_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsum</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsum</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tsqr</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsqr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tprod</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tprod</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbias</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcrms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcorr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tavail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcount</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thist</span><span class="p">)</span>

        <span class="c1"># Masks</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_masks_</span><span class="p">(</span><span class="n">tstats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcount</span><span class="p">)</span>

        <span class="c1"># Format and cache</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">templates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ttemplates</span><span class="p">,</span> <span class="n">htemplates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thtemplates</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atts</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">baxis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tstats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_var_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tstats</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_titerindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span>
        <span class="k">del</span> <span class="n">masks</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tstats</span></div>

<div class="viewcode-block" id="StatAccum.get_tavail"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tavail">[docs]</a>    <span class="k">def</span> <span class="nf">get_tavail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal availability&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tavail&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;avail&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tcount"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tcount">[docs]</a>    <span class="k">def</span> <span class="nf">get_tcount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal count&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tcount&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tmean"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tmean">[docs]</a>    <span class="k">def</span> <span class="nf">get_tmean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal standard deviation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tmean&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tstd"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tstd">[docs]</a>    <span class="k">def</span> <span class="nf">get_tstd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal mean&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tstd&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tbias"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tbias">[docs]</a>    <span class="k">def</span> <span class="nf">get_tbias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal bias&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tbias&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_trms"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_trms">[docs]</a>    <span class="k">def</span> <span class="nf">get_trms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal absolute RMS difference&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;trms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;rms&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tcrms"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tcrms">[docs]</a>    <span class="k">def</span> <span class="nf">get_tcrms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal centered RMS difference&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tcrms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;crms&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_tcorr"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_tcorr">[docs]</a>    <span class="k">def</span> <span class="nf">get_tcorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal correlation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;tcorr&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_thist"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_thist">[docs]</a>    <span class="k">def</span> <span class="nf">get_thist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the temporal histogram&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;thist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()[</span><span class="s1">&#39;hist&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_sstats"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_sstats">[docs]</a>    <span class="k">def</span> <span class="nf">get_sstats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all spatial statistics as a dictionary&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstats</span><span class="p">:</span> <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># From cache</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cache_siterindex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_sstats</span>

        <span class="c1"># Aggregate pure numeric stats</span>
        <span class="n">sstats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">stype</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sstats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">sstats</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asarray_</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asarray_</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sstats</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asarray_</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

<span class="c1">#        # Availability</span>
<span class="c1">#        if self.savail:</span>
<span class="c1">#            if self.smask is not None:</span>
<span class="c1">#                if isinstance(self.smask , N.ndarray):</span>
<span class="c1">#                    maxcount =  (~self.smask).astype(&#39;l&#39;).sum()</span>
<span class="c1">#                else:</span>
<span class="c1">#                    maxcount = self.smask</span>
<span class="c1">#            else:</span>
<span class="c1">#                maxcount = self._scount.max()</span>
<span class="c1">#            sstats[&#39;avail&#39;] = self._scount*1./maxcount</span>

        <span class="c1"># Masks</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_masks_</span><span class="p">(</span><span class="n">sstats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asarray_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scount</span><span class="p">))</span>

        <span class="c1"># Time axes</span>
        <span class="n">stimes</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
            <span class="p">[</span><span class="n">MV2_axisConcatenate</span><span class="p">(</span><span class="n">stime</span><span class="p">)</span> <span class="k">for</span> <span class="n">stime</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stimes</span><span class="p">]</span>

        <span class="c1"># Format and cache</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">templates</span><span class="o">=</span><span class="n">stimes</span><span class="p">,</span> <span class="n">htemplates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baxis</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_sstats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_var_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="n">masks</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sstats</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_siterindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterindex</span>
        <span class="k">del</span> <span class="n">masks</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_sstats</span></div>

<div class="viewcode-block" id="StatAccum.get_savail"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_savail">[docs]</a>    <span class="k">def</span> <span class="nf">get_savail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial availability&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;savail&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;avail&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_scount"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_scount">[docs]</a>    <span class="k">def</span> <span class="nf">get_scount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial count&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;scount&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_smean"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_smean">[docs]</a>    <span class="k">def</span> <span class="nf">get_smean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial standard deviation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;smean&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_sstd"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_sstd">[docs]</a>    <span class="k">def</span> <span class="nf">get_sstd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial mean&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;sstd&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_sbias"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_sbias">[docs]</a>    <span class="k">def</span> <span class="nf">get_sbias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial bias&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;sbias&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_srms"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_srms">[docs]</a>    <span class="k">def</span> <span class="nf">get_srms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial absolute RMS difference&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;srms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;rms&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_scrms"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_scrms">[docs]</a>    <span class="k">def</span> <span class="nf">get_scrms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial centered RMS difference&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;scrms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;crms&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_scorr"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_scorr">[docs]</a>    <span class="k">def</span> <span class="nf">get_scorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial correlation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;scorr&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_shist"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_shist">[docs]</a>    <span class="k">def</span> <span class="nf">get_shist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spatial histogram&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkstat_</span><span class="p">(</span><span class="s1">&#39;shist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()[</span><span class="s1">&#39;hist&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StatAccum.get_stats"><a class="viewcode-back" href="../../../library/misc.stats.html#vacumm.misc.stats.StatAccum.get_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all statistics as dict&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tstats</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sstats</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">stats</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span></div>

<span class="k">def</span> <span class="nf">_get_var_and_axes_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a list of a variable and its axes&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">exc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="p">[</span><span class="n">exc</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">+</span><span class="n">var</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="o">!=</span><span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">(),</span> <span class="n">var</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exc</span><span class="p">:</span> <span class="k">return</span> <span class="n">out</span>
    <span class="n">exc0</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
    <span class="n">exc1</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exc0</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exc1</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_rm_id_prefix_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove prefix in ids of a variable and its axes&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_get_var_and_axes_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>

<span class="k">def</span> <span class="nf">_add_id_prefix_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add prefix in ids of a variable and its axes when not present&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_get_var_and_axes_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>