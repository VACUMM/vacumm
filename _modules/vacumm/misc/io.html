
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.misc.io &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.misc.io</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;In/Output tools&quot;&quot;&quot;</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2017)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="k">import</span> <span class="n">format_exc</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span><span class="o">,</span> <span class="nn">MV2</span><span class="o">,</span> <span class="nn">cdms2</span><span class="o">,</span> <span class="nn">cdtime</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">P</span><span class="o">,</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">_geoslib</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">LineCollection</span><span class="p">,</span> <span class="n">PolyCollection</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">Basemap</span>

<span class="kn">from</span> <span class="nn">..__init__</span> <span class="k">import</span> <span class="n">VACUMMError</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;list_forecast_files&#39;</span><span class="p">,</span> <span class="s1">&#39;NcIterBestEstimate&#39;</span><span class="p">,</span> <span class="s1">&#39;NcIterBestEstimateError&#39;</span><span class="p">,</span> <span class="s1">&#39;NcFileObj&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ncfind_var&#39;</span><span class="p">,</span> <span class="s1">&#39;ncfind_axis&#39;</span><span class="p">,</span> <span class="s1">&#39;ncfind_obj&#39;</span><span class="p">,</span> <span class="s1">&#39;ncget_var&#39;</span><span class="p">,</span> <span class="s1">&#39;ncread_var&#39;</span><span class="p">,</span> <span class="s1">&#39;ncread_files&#39;</span><span class="p">,</span> <span class="s1">&#39;ncread_best_estimate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ncget_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;ncget_time&#39;</span><span class="p">,</span><span class="s1">&#39;ncget_lon&#39;</span><span class="p">,</span><span class="s1">&#39;ncget_lat&#39;</span><span class="p">,</span><span class="s1">&#39;ncget_level&#39;</span><span class="p">,</span> <span class="s1">&#39;ncmatch_obj&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ncget_axis&#39;</span><span class="p">,</span> <span class="s1">&#39;netcdf3&#39;</span><span class="p">,</span> <span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="s1">&#39;ncread_axis&#39;</span><span class="p">,</span> <span class="s1">&#39;ncread_obj&#39;</span><span class="p">,</span> <span class="s1">&#39;ncget_fgrid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;grib_read_files&#39;</span><span class="p">,</span> <span class="s1">&#39;nccache_get_time&#39;</span><span class="p">,</span> <span class="s1">&#39;grib2nc&#39;</span><span class="p">,</span> <span class="s1">&#39;grib_get_names&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Shapes&#39;</span><span class="p">,</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span> <span class="s1">&#39;XYZMerger&#39;</span><span class="p">,</span> <span class="s1">&#39;write_snx&#39;</span><span class="p">,</span> <span class="s1">&#39;ColoredFormatter&#39;</span><span class="p">,</span> <span class="s1">&#39;Logger&#39;</span><span class="p">,</span> <span class="s1">&#39;TermColors&#39;</span>
    <span class="s1">&#39;NcIterTimeSlice&#39;</span><span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="n">MA</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span>
<span class="n">MV</span> <span class="o">=</span> <span class="n">MV2</span>


<span class="k">class</span> <span class="nc">ColPrinter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to print formatted columns with header and frame</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **columns**: A list of column descriptions like [[&#39;Year&#39;,6,&#39;%i&#39;],...]</span>
<span class="sd">          where the fist element is the title</span>
<span class="sd">          of the column, the second is the width of the</span>
<span class="sd">          column, and the last is the format of data.</span>
<span class="sd">        - **file**, optional: Output to file instead of stdout.</span>
<span class="sd">        - **align**, optional: Text alignment of titles in header, in (&#39;left&#39;,&#39;right&#39;,&#39;center&#39;).</span>
<span class="sd">        - **left,right,top,bottom**, optional: String to draw part of a frame</span>
<span class="sd">        - **frame**: Shortcut to left=right=&#39;|&#39;,  and top=bottom=&#39;-&#39;</span>
<span class="sd">        - **headsep**, optional: Header separator. If empty or None, not printed.</span>
<span class="sd">        - **colsep**, optional: Column separator.</span>
<span class="sd">        - **print_header**, optional: Printer once object created.</span>

<span class="sd">    .. Note::</span>

<span class="sd">        Obviously, you must use monospaced fonts</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; p = ColPrinter([[&#39;Year&#39;,6,&#39;%i&#39;],[&#39;Value&#39;,7,&#39;%4.1f&#39;]], headsep=&#39;=&#39;,align=&#39;center&#39;,frame=True)</span>
<span class="sd">        ------------------</span>
<span class="sd">        |  Year   Value  |</span>
<span class="sd">        |================|</span>
<span class="sd">        &gt;&gt;&gt; p(2000,25.9)</span>
<span class="sd">        | 2000   25.9    |</span>
<span class="sd">        &gt;&gt;&gt; p(2001,23.7)</span>
<span class="sd">        | 2001   23.7    |</span>
<span class="sd">        &gt;&gt;&gt; p.close()</span>
<span class="sd">        ------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">headsep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">colsep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span>
        <span class="n">print_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Inputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Input must be a list or tuple of 3-element lists&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>  <span class="ow">and</span> \
            <span class="nb">type</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">,]</span>
        <span class="k">if</span> <span class="n">align</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="s1">&#39;center&#39;</span><span class="p">]:</span>
            <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">bb</span><span class="p">,</span><span class="nb">eval</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">bb</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">colsep</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="n">headsep</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headsep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">headsep</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headsep</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headsep</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">headsep</span><span class="p">)</span>

         <span class="c1"># Loop on columns</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> \
              <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
              <span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;This description of column must contain the column title (string), the column width (int) and the string format for data (string): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">col</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">align</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># File case</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Print header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_header</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bottom__printed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">,</span><span class="n">file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print bottom and close the file (if file mode) &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">,</span><span class="n">file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_left</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_right</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print top frame &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__left</span><span class="p">())</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__right</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">*</span> <span class="n">n</span><span class="p">)[:</span><span class="n">n</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print header (stop + header text + header separator) &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__left</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__right</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headsep</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">headsep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print header separator line &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headsep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span> <span class="o">+</span> \
              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__left</span><span class="p">())</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_left</span><span class="p">)</span> <span class="o">+</span> \
              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__right</span><span class="p">())</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_left</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headsep</span> <span class="o">*</span> <span class="n">n</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_right</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print bottom frame &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bottom__printed</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__left</span><span class="p">())</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__right</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span> <span class="o">*</span> <span class="n">n</span><span class="p">)[:</span><span class="n">n</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bottom__printed</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print data in columns</span>

<span class="sd">        Arguments refer to the data.</span>
<span class="sd">        The number of arguments must be the same as the number of columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;You must give a number of data equal to the number of columns (</span><span class="si">%i</span><span class="s1">): </span><span class="si">%i</span><span class="s1">&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="n">dds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">dds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">dd</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__left</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_colsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dds</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__right</span><span class="p">())</span>

<span class="n">col_printer</span> <span class="o">=</span> <span class="n">ColPrinter</span> <span class="c1"># compat</span>



<div class="viewcode-block" id="list_forecast_files"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.list_forecast_files">[docs]</a><span class="k">def</span> <span class="nf">list_forecast_files</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">nopat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patfmtfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a list of forecast files according to a file pattern</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **filepattern**: It can be either:</span>

<span class="sd">            - a global matching pattern (``&quot;file??.nc&quot;``),</span>
<span class="sd">            - a date pattern (``&quot;file%Y-%m-%d.nc&quot;``),</span>
<span class="sd">            - an url (``&quot;http://site.net/file.nc&quot;``),</span>
<span class="sd">            - a list of files.</span>

<span class="sd">        - **time**: A time selector (``(&#39;2000&#39;, &#39;2001&#39;, &#39;co&#39;)``).</span>

<span class="sd">          .. warning::</span>
<span class="sd">              This argument is *mandatory* if ``filepattern`` is a date pattern,</span>
<span class="sd">              and *not used* if ``filepattern`` is of another type.</span>

<span class="sd">        - **check**, optional: Check if local files exist.</span>
<span class="sd">        - **nopat**, optional: Never consider that input patterns have date patterns.</span>
<span class="sd">        - **patfreq**, optional: Frequency of files to generate file names for each date</span>
<span class="sd">           when ``filepattern`` is a date pattern.</span>
<span class="sd">        - **patfmtfunc**, optional: Function to use in place of</span>
<span class="sd">           :func:`~vacumm.misc.atime.strftime` to generate file names.</span>
<span class="sd">           It must take as arguments a date pattern and a CDAT component time.</span>
<span class="sd">        - **sort**, optional: If True, files are sorted alphabetically after being listed;</span>
<span class="sd">          if a callable function, they are sorted using this function (``files=sort(files)``).</span>

<span class="sd">          .. warning:: Files are sorted alphabetically by default!</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; &#39;Prefered way&#39;</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files(&#39;mrsPRVMR_r0_%Y-%m-%d_00.nc&#39;, (&#39;2010-08-06&#39;, &#39;2010-08-15&#39;))</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files(&#39;http://www.ifremer.fr/data/mrsPRVMR_r0_%Y-%m-%d_00.nc&#39;, (&#39;2010-08-06&#39;, &#39;2010-08-15&#39;))</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files(&#39;mrsPRVMR_r0_%Y-%m-%d_*.nc&#39;, (&#39;2010-08-06&#39;, &#39;2010-08-15&#39;))</span>

<span class="sd">        &gt;&gt;&gt; &#39;Possible way&#39;</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files(&#39;mrsPRVMR_r0_2010-05-??_00.nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files([&#39;mrsPRVMR_r0_2010-05-??_00.nc&#39;, &#39;mrsPRVMR_r0_2010-05-??_60.nc&#39;])</span>

<span class="sd">        &gt;&gt;&gt; &#39;Just ot filter in existing files&#39;</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files([&#39;mrsPRVMR_r0_2010-05-06_00.nc&#39;, &#39;mrsPRVMR_r0_2010-05-07_00.nc&#39;])</span>

<span class="sd">        &gt;&gt;&gt; &#39;Simple conversion to list&#39;</span>
<span class="sd">        &gt;&gt;&gt; list_forecast_files(&#39;http://www.ifremer.fr/data/mrsPRVMR_r0_2010-05-06_00.nc&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sfp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sfp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">300</span><span class="p">:</span> <span class="n">sfp</span> <span class="o">=</span> <span class="n">sfp</span><span class="p">[:</span><span class="mi">300</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Guessing file list using:&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;   filepattern: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">sfp</span>
        <span class="nb">print</span> <span class="s1">&#39;   time selector: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="p">)</span>

    <span class="c1"># A list of file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filepat</span> <span class="ow">in</span> <span class="n">filepattern</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list_forecast_files</span><span class="p">(</span><span class="n">filepat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
                <span class="n">patfreq</span><span class="o">=</span><span class="n">patfreq</span><span class="p">,</span> <span class="n">patfmtfunc</span><span class="o">=</span><span class="n">patfmtfunc</span><span class="p">,</span> <span class="n">patmargin</span><span class="o">=</span><span class="n">patmargin</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nopat</span><span class="o">=</span><span class="n">nopat</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


    <span class="c1"># Date pattern</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">nopat</span> <span class="ow">and</span> <span class="n">has_time_pattern</span><span class="p">(</span><span class="n">filepattern</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">atime</span> <span class="k">import</span> <span class="n">pat2freq</span><span class="p">,</span><span class="n">IterDates</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">is_interval</span><span class="p">,</span> <span class="n">pat2glob</span><span class="p">,</span> <span class="n">filter_time_selector</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">selectors</span><span class="o">.</span><span class="n">Selector</span><span class="p">):</span>
            <span class="n">seltime</span> <span class="o">=</span> <span class="n">filter_time_selector</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">noslice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seltime</span><span class="o">.</span><span class="n">components</span><span class="p">():</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">comps</span> <span class="o">=</span> <span class="n">split_selector</span><span class="p">(</span><span class="n">seltime</span><span class="p">)</span> <span class="c1"># FIXME: include positional components</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="n">itv</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">spec</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_interval</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_time</span><span class="p">(</span><span class="n">itv</span><span class="p">):</span>
                        <span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">itv</span><span class="p">,</span> <span class="s1">&#39;ccb&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">itv</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">itv_union</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_interval</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_time</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;ccb&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Your file pattern contains date pattern (like &quot;%Y&quot;), &#39;</span>
                    <span class="s1">&#39;so you must provide a valid absolute time interval such as (date1,date2,&quot;co&quot;)&#39;</span>
                    <span class="s1">&#39; or at least a valid single date&#39;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">patfmtfunc</span> <span class="o">=</span> <span class="n">patfmtfunc</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">patfmtfunc</span><span class="p">)</span> <span class="k">else</span> <span class="n">strftime</span>

        <span class="c1"># Guess the minimal frequency</span>
        <span class="n">lmargin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">patfreq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">patfreq</span> <span class="o">=</span> <span class="n">pat2freq</span><span class="p">(</span><span class="n">filepattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Detected frequency for looping on possible dates: &#39;</span><span class="o">+</span><span class="n">patfreq</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patfreq</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>

            <span class="c1">#  Reform</span>
            <span class="n">patfreq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">patfreq</span><span class="p">)</span>

            <span class="c1"># Guess left margin when possible</span>
            <span class="n">gfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pat2glob</span><span class="p">(</span><span class="n">filepattern</span><span class="p">))</span>
            <span class="n">gfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gfiles</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">lmargin</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">has_magic</span><span class="p">(</span><span class="n">filepattern</span><span class="p">):</span>
                <span class="n">date0</span> <span class="o">=</span> <span class="n">date1</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;seconds since 200&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gfiles</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">date0</span> <span class="o">=</span> <span class="n">strptime</span><span class="p">(</span><span class="n">gfiles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">filepattern</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span>
                        <span class="n">date1</span> <span class="o">=</span> <span class="n">strptime</span><span class="p">(</span><span class="n">gfiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">filepattern</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">date0</span><span class="o">.</span><span class="n">value</span><span class="o">&gt;=</span><span class="n">reltime</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                        <span class="ow">or</span> <span class="n">date1</span><span class="o">.</span><span class="n">value</span><span class="o">&lt;=</span><span class="n">reltime</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">):</span> <span class="k">break</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">date0</span><span class="p">,</span> <span class="n">date1</span><span class="p">]:</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">date1</span><span class="p">)</span><span class="o">-</span><span class="n">adatetime</span><span class="p">(</span><span class="n">date0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">lmargin</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="s1">&#39;2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Seconds</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span>
                            <span class="n">patfreq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lmargin</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="s1">&#39;2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Days</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span>
                            <span class="n">patfreq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lmargin</span> <span class="o">=</span> <span class="mi">1</span>
             <span class="c1">#FIXME: make it work with date+glob patterns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lmargin</span> <span class="o">=</span> <span class="n">patfreq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1">#        # Add margin to time interval</span>
<span class="c1">#        if patmargin is None:</span>
<span class="c1">#</span>
<span class="c1">#            # Guess margin from a second time pattern (like %Y_%%Y.nc)</span>
<span class="c1">#            fp2 = patfmtfunc(filepattern, now())</span>
<span class="c1">#            if has_time_pattern(fp2):</span>
<span class="c1">#                for fn in glob(pat2glob(fp2):</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#        elif not isinstance(patmargin, tuple):</span>
<span class="c1">#            patmargin = (1, patmargin)</span>

        <span class="c1"># Make a loop on dates</span>
        <span class="n">itertime</span> <span class="o">=</span> <span class="p">(</span><span class="n">round_date</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patfreq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;floor&#39;</span><span class="p">),</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">itertime</span> <span class="o">=</span> <span class="n">add_margin</span><span class="p">(</span><span class="n">itertime</span><span class="p">,</span> <span class="p">(</span><span class="n">lmargin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">patfreq</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">iterdates</span> <span class="o">=</span> <span class="n">IterDates</span><span class="p">(</span><span class="n">itertime</span><span class="p">,</span> <span class="n">patfreq</span><span class="p">,</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">iterdates</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">patfmtfunc</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">check</span> <span class="ow">or</span> <span class="n">glob</span><span class="o">.</span><span class="n">has_magic</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># Simple remote file or file object</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CdmsFile</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">filepattern</span><span class="p">:</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">filepattern</span><span class="p">]</span>

    <span class="c1"># Glob pattern</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check</span> <span class="ow">or</span> <span class="n">glob</span><span class="o">.</span><span class="n">has_magic</span><span class="p">(</span><span class="n">filepattern</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filepattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">filepattern</span><span class="p">]</span>

    <span class="c1"># Unique</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>

    <span class="c1"># Count</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;No file found with this file pattern &quot;</span><span class="si">%s</span><span class="s1">&quot; and time interval </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Found </span><span class="si">%i</span><span class="s1"> files&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="c1"># Sort files</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="ncfind_var"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncfind_var">[docs]</a><span class="k">def</span> <span class="nf">ncfind_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find a variable in a netcdf file using :func:`ncfind_obj`</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">res</span> <span class="o">=</span>  <span class="n">ncfind_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="n">regexp</span><span class="p">,</span>
                      <span class="n">ids</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">listvariables</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ncfind_axis"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncfind_axis">[docs]</a><span class="k">def</span> <span class="nf">ncfind_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find an axis in a netcdf file using :func:`ncfind_obj`</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">res</span> <span class="o">=</span>  <span class="n">ncfind_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="n">regexp</span><span class="p">,</span>
                      <span class="n">ids</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">listdimension</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ncfind_obj"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncfind_obj">[docs]</a><span class="k">def</span> <span class="nf">ncfind_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find a variable or an axis in netcdf file using a name, list of names</span>
<span class="sd">    or matching attributes such as standard_name, long_name and units.</span>

<span class="sd">    Objects are checked using :func:`ncmatch_obj`.</span>
<span class="sd">    It first checks the standard_name, then the names (ids), the axis, and finally</span>
<span class="sd">    the long_names and units.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; f = cdms2.open(&#39;temp.nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ncfind_obj(f, &#39;temp&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ncfind_obj(f, [&#39;temperature&#39;,&#39;temp&#39;])</span>
<span class="sd">        &gt;&gt;&gt; ncfind_obj(f, (&#39;temperature&#39;,&#39;TEMP&#39;), ignorecase=False)</span>
<span class="sd">        &gt;&gt;&gt; ncfind_obj(f, dict(standard_name=&quot;sea_surface_temperature&quot;))</span>
<span class="sd">        &gt;&gt;&gt; ncfind_obj(f, &#39;lon&#39;)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: A cdms2.dataset.CdmsFile.</span>
<span class="sd">        - **name**: A string or list of string to look for,</span>
<span class="sd">          or a dictionary with keys &quot;name&quot;, &quot;standard_name&quot;, &quot;long_name&quot;, &#39;units&#39; and &#39;axis&#39;.</span>
<span class="sd">        - **ignorecase**, optional: Ignore name case when searching variable.</span>
<span class="sd">        - **regexp**, optional: Interpret long_names and units as regular expressions</span>
<span class="sd">          that must be compiled.</span>
<span class="sd">        - **searchmode**, optional: Search order when ``specs`` is a dictionary</span>
<span class="sd">          and not a OrderedDict. It defaults</span>
<span class="sd">          to ``None`` or ``&#39;snlua&#39;`` which means:</span>
<span class="sd">          *standard_name -&gt; name -&gt; long_name -&gt; units -&gt; axis* (first letters).</span>
<span class="sd">          If ``name`` is an OrderedDict, it simply acts as a filter to restrict search.</span>

<span class="sd">    :Return:</span>

<span class="sd">        The first matching object name, or None if not found.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>

    <span class="c1"># Searched terms</span>
    <span class="n">withdict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="n">standard_name</span> <span class="o">=</span> <span class="n">long_name</span> <span class="o">=</span> <span class="n">units</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">check_list</span><span class="p">(</span><span class="n">refname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refname</span> <span class="ow">in</span> <span class="n">specs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]):</span>
            <span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">withdict</span><span class="p">:</span> <span class="c1"># Using a dictionary</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Useful functions</span>
        <span class="k">def</span> <span class="nf">check_aliases</span><span class="p">(</span><span class="n">refname</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">refname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                        <span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">specs</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
        <span class="n">re_flag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span> <span class="k">if</span> <span class="n">ignorecase</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">def</span> <span class="nf">check_regexp</span><span class="p">(</span><span class="n">refname</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">refname</span> <span class="ow">in</span> <span class="n">specs</span> <span class="ow">and</span> <span class="n">regexp</span><span class="p">:</span> <span class="c1"># Regular expression</span>
                <span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">re_flag</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
                                  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Id</span>
        <span class="n">check_aliases</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">)</span>
        <span class="n">check_list</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

        <span class="c1"># Standard name</span>
        <span class="n">check_aliases</span><span class="p">(</span><span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_names&#39;</span><span class="p">)</span>
        <span class="n">check_list</span><span class="p">(</span><span class="s1">&#39;standard_name&#39;</span><span class="p">)</span>

        <span class="c1"># Axis</span>
        <span class="k">if</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="c1"># Long_name</span>
        <span class="n">check_aliases</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;long_names&#39;</span><span class="p">)</span>
        <span class="n">check_list</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">)</span>
        <span class="n">check_regexp</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">)</span>

        <span class="c1"># Units</span>
        <span class="n">check_list</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>
        <span class="n">check_regexp</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Using a list of ids</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">specs</span><span class="p">}</span>
        <span class="n">check_list</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="c1"># Order and filter the search</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="n">filter_search</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">searchmode</span><span class="p">)</span>

    <span class="c1"># Loop on targets to match attributes</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">listvariables</span><span class="p">()</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="n">listdimension</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># loop on attribute types</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span> <span class="c1"># Loop on targets</span>
            <span class="k">if</span> <span class="n">match_atts</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="p">{</span><span class="n">att</span><span class="p">:</span><span class="n">val</span><span class="p">},</span> <span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># Not found</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">id</span></div>

<span class="k">def</span> <span class="nf">filter_search</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Order and filter the search&quot;&quot;&quot;</span>
    <span class="c1"># - get order</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">]</span>
    <span class="n">all_keys0</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">searchmode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="n">searchmode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">searchmode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_keys0</span><span class="p">)</span>
    <span class="n">searchmode</span> <span class="o">=</span> <span class="n">searchmode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key0</span> <span class="ow">in</span> <span class="n">searchmode</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">all_keys</span><span class="p">[</span><span class="n">all_keys0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key0</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">key0</span> <span class="ow">in</span> <span class="n">all_keys0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># - reorder specs</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>

<div class="viewcode-block" id="ncmatch_obj"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncmatch_obj">[docs]</a><span class="k">def</span> <span class="nf">ncmatch_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standard_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">long_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if an MV2 object (typicaly from a netcdf file) matches names, standard_names, etc</span>


<span class="sd">    It first checks the standard_name, then the names (ids), the axis, and finally</span>
<span class="sd">    the long_names and units.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **obj**: A MV2 array.</span>
<span class="sd">        - **standard_name**, optional: List of possible standard_names.</span>
<span class="sd">        - **id**, optional: Name (id) of this array, wich defaults to the id attribute.</span>
<span class="sd">        - **axis**, optional: Axis type, as one of &#39;x, &#39;y&#39;, &#39;z&#39;, &#39;t&#39;.</span>
<span class="sd">        - **long_name**, optional: List of possible long_names or callable expression</span>
<span class="sd">          (such as regular expression method).</span>
<span class="sd">        - **units**, optional: Same as ``long_names`` but for units.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; ncmatch_obj(sst, standard_name=&#39;sea_surface_temperature&#39;, id=[&#39;sst&#39;])</span>
<span class="sd">        &gt;&gt;&gt; import re</span>
<span class="sd">        &gt;&gt;&gt; ncmatch_obj(sst, long_name=re.compile(&#39;sea surface temp&#39;).match)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Format</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">search</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">search</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># Order and filter the search</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">filter_search</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="n">searchmode</span><span class="p">)</span>

    <span class="c1"># Check attributes</span>
    <span class="k">return</span> <span class="n">match_atts</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">ignorecase</span><span class="p">)</span></div>


<div class="viewcode-block" id="ncget_var"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_var">[docs]</a><span class="k">def</span> <span class="nf">ncget_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a variable object as returned by :meth:`cdms2.dataset.CdmsFile.getVariable`</span>
<span class="sd">    which is equivalent to ``f[varname]``.</span>

<span class="sd">    :Return: A cdms2.fvariable.FileVariable or None if not found.</span>

<span class="sd">    :See: :func:`ncfind_var()`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">oldvname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vname</span> <span class="o">=</span> <span class="n">ncfind_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Variable not found </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oldvname</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">var</span> <span class="o">=</span>  <span class="n">f</span><span class="o">.</span><span class="n">getVariable</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="ncread_obj"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncread_obj">[docs]</a><span class="k">def</span> <span class="nf">ncread_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read an arbitrary netcdf object (axis or variable)&quot;&quot;&quot;</span>
    <span class="c1"># Inits</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">ignorecase</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignorecase&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ncname</span> <span class="o">=</span> <span class="n">ncfind_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">nfo</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Object not found </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ncname</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">ncread_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ncname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">ncread_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ncname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="ncread_axis"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncread_axis">[docs]</a><span class="k">def</span> <span class="nf">ncread_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a 1D axis</span>

<span class="sd">    .. note:: Please use :func:`ncread_var` to read 2D axes.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mode**, optional: if ``&#39;raise&#39;`` raises an :exc:`IOError`</span>
<span class="sd">          if not found, else returns ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Inits</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">ncname</span> <span class="o">=</span> <span class="n">ncfind_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">nfo</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;raise&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Axis not found </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">ncname</span><span class="p">)</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">set_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">axis</span></div>


<div class="viewcode-block" id="ncread_var"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncread_var">[docs]</a><span class="k">def</span> <span class="nf">ncread_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a variable in a netcdf file and some more</span>

<span class="sd">    In addition to a simple ``f(vname, *args, **kwargs)```:</span>

<span class="sd">        - ``vname`` can be a list of var names, and it takes the first</span>
<span class="sd">          one found, ignoring the case by default.</span>
<span class="sd">        - If a variable is on a grid that is stored as curvilinear</span>
<span class="sd">          but is rectangular in real, it convert its grid to a rectanguar grid</span>

<span class="sd">    If variabe is not found, it raises</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: File descriptor.</span>
<span class="sd">        - **vname**: Variable name(s) (see :func:`ncfind_var`).</span>
<span class="sd">        - **ignorecase**, optional: Case insensitive search for the name of variable.</span>
<span class="sd">        - Other arguments and keywords are passed to ``f``.</span>
<span class="sd">        - **atts**: Dictionary of attributes to apply.</span>

<span class="sd">        - **squeeze**, optional: A single argument (or a list of them) interpreted</span>
<span class="sd">          as a squeeze specification passed to :func:`~vacumm.misc.misc.squeeze_variable`,</span>
<span class="sd">          to squeeze out singleton axes.</span>
<span class="sd">        - **torect**, optional: If True, try to convert output grid to rectanguar</span>
<span class="sd">          using :func:`~vacumm.misc.grid.misc.curv2rect`.</span>
<span class="sd">        - **mode**, optional: if ``&#39;raise&#39;`` raises an :exc:`IOError`</span>
<span class="sd">          if not found, else returns ``None``.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; var = ncread_var(f, [&#39;u&#39;, &#39;u2&#39;], lon=(45, 47), atts={&#39;id&#39;:&#39;U&#39;})</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Inits</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="n">ignorecase</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ignorecase&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">torect</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;torect&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwgrid</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
    <span class="n">samp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;samp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">)</span>
    <span class="n">searchmode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;searchmode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">squeeze</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">squeeze</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="p">[</span><span class="n">squeeze</span><span class="p">]</span>
    <span class="n">oldvname</span> <span class="o">=</span> <span class="n">vname</span>

    <span class="c1"># Find</span>
    <span class="n">vname</span> <span class="o">=</span> <span class="n">ncfind_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">nfo</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;raise&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Variable not found </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oldvname</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># Read</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Extra stuff</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">_process_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">torect</span><span class="p">,</span> <span class="n">samp</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">kwgrid</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">return</span> <span class="n">var</span></div>

<span class="k">def</span> <span class="nf">_process_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">torect</span><span class="p">,</span> <span class="n">samp</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">kwgrid</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">atts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    - **samp**, optional: Undersample rate as a list of the same size as</span>
<span class="sd">      the rank of the variable. Set values to 0, 1 for no undersampling.</span>
<span class="sd">    - **torect**, optional: If True, try to convert output grid to rectanguar</span>
<span class="sd">      using :func:`~vacumm.misc.grid.misc.curv2rect`.</span>
<span class="sd">    - **grid**, optional: A grid to regrid the variable on.</span>
<span class="sd">    - **grid_&lt;keyword&gt;**, optional: ``keyword`` is passed to</span>
<span class="sd">      :func:`~vacumm.misc.grid.regridding.regrid`.</span>
<span class="sd">    - **squeeze**, optional: Argument passed to :func:`squeeze_variable` to squeeze out singleton axes.</span>
<span class="sd">            - Extra kwargs are used to refine the **selector** initialized with ``select``.</span>
<span class="sd">    - **atts**: attributes dict (or list of attributes dict for each varname)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># To rectangular grid?</span>
    <span class="k">if</span> <span class="n">torect</span><span class="p">:</span>
        <span class="n">curv2rect</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

    <span class="c1"># Undersample</span>
    <span class="k">if</span> <span class="n">samp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span><span class="o">!=</span><span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">nfo</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Sampling keyword (&quot;samp&quot;) must have&#39;</span>
                <span class="s1">&#39; a size equal to the rank of the variable (</span><span class="si">%i</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samp</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">samp</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">samp</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">samp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">*</span><span class="n">samp</span><span class="p">)</span>

    <span class="c1"># Regrid</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">regrid2d</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwgrid</span><span class="p">)</span>

    <span class="c1"># Squeeze</span>
    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">squeeze</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ss</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="k">break</span>

    <span class="c1"># Attributes</span>
    <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">var</span>

<div class="viewcode-block" id="ncget_axis"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_axis">[docs]</a><span class="k">def</span> <span class="nf">ncget_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">checker</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an axis in a netcdf file by searching all axes and variables</span>

<span class="sd">    If ``checker`` is a list, dict or tuple, :func:`ncfind_axis`</span>
<span class="sd">    is called directly to search for the axis within the file.</span>

<span class="sd">    :Param:</span>

<span class="sd">        - **checker**: Can be either</span>

<span class="sd">            - A generic name such as &#39;x&#39; or &#39;lon&#39;,</span>
<span class="sd">            - A function to check that an object is an axis.</span>
<span class="sd">              of appropriate type (such as :func:`~vacumm.misc.axes.islon`).</span>
<span class="sd">              This function must accept the &#39;ro&#39; keyword (&#39;readonly&#39;).</span>
<span class="sd">            - An argument to :func:`ncfind_axis`: list, dict, tuple.</span>

<span class="sd">        - **ids**, optional: A list of ids to focus search.</span>

<span class="sd">    :Return: The axis or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checker</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">checker</span> <span class="o">=</span> <span class="n">get_checker</span><span class="p">(</span><span class="n">checker</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checker</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="n">axid</span> <span class="o">=</span> <span class="n">ncfind_obj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">checker</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">axid</span><span class="p">]</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>  <span class="c1"># to fix a cdms bug</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">set_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
        <span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">axis</span>

    <span class="c1"># Targets</span>
    <span class="n">dimids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">listdimension</span><span class="p">()</span>
    <span class="n">varids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">listvariables</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">varids</span><span class="o">+</span><span class="n">dimids</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

    <span class="c1"># Loop on targets</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">checker</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="k">break</span>
<span class="c1">#            if id in varids:</span>
<span class="c1">#                return f(id)</span>
<span class="c1">#            return f.getAxis(id)</span>
        <span class="k">elif</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">varids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">listdimnames</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">checker</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">aid</span><span class="p">],</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">):</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>  <span class="c1"># to fix a cdms bug</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">set_atts</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="n">checker</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis</span></div>


<div class="viewcode-block" id="ncget_lon"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_lon">[docs]</a><span class="k">def</span> <span class="nf">ncget_lon</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get longitude axis of a netcdf file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: Netcdf file name or object.</span>
<span class="sd">        - **ids**, optional: List of ids to help searching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncget_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">islon</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span></div>

<div class="viewcode-block" id="ncget_lat"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_lat">[docs]</a><span class="k">def</span> <span class="nf">ncget_lat</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get latitude axis of a netcdf file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: Netcdf file name or object.</span>
<span class="sd">        - **ids**, optional: List of ids to help searching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncget_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">islat</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span></div>

<div class="viewcode-block" id="ncget_time"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_time">[docs]</a><span class="k">def</span> <span class="nf">ncget_time</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get time axis of a netcdf file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: Netcdf file name or object.</span>
<span class="sd">        - **ids**, optional: List of ids to help searching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncget_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">istime</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span></div>

<div class="viewcode-block" id="ncget_level"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_level">[docs]</a><span class="k">def</span> <span class="nf">ncget_level</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get level axis of a netcdf file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: Netcdf file name or object.</span>
<span class="sd">        - **ids**, optional: List of ids to help searching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncget_axis</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">islevel</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="n">checkaxis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span></div>

<div class="viewcode-block" id="ncget_grid"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_grid">[docs]</a><span class="k">def</span> <span class="nf">ncget_grid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a grid of a netcdf file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: Netcdf file name or object.</span>
<span class="sd">        - **ids**, optional: List of ids to help searching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span>

    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">listvariables</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
<span class="c1">#            grid = grid.clone()</span>
            <span class="k">break</span>
    <span class="k">del</span> <span class="n">nfo</span>
    <span class="k">if</span> <span class="n">torect</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">curv2rect</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="ncget_fgrid"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncget_fgrid">[docs]</a><span class="k">def</span> <span class="nf">ncget_fgrid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">gg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the file grid that matches a transient grid or variable</span>

<span class="sd">    Matching is checked using ids of longitudes and latitudes.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: file name or object.</span>
<span class="sd">        - **gg**: cdms2 grid or variable with a grid.</span>

<span class="sd">    :Return: A :class:`FileGrid` instance or ``None``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span>

    <span class="c1"># From a variable</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

    <span class="c1"># Current grid</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">gg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">lonid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">latid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># Loop on file grids</span>
    <span class="kn">from</span> <span class="nn">vacumm.misc.io</span> <span class="k">import</span> <span class="n">NcFileObj</span>
    <span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fgrid</span> <span class="ow">in</span> <span class="n">nfo</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">grids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">flon</span> <span class="o">=</span> <span class="n">fgrid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">fgrid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="n">flonid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flon</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">flon</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">flatid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lonid</span><span class="p">,</span> <span class="n">latid</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="n">flonid</span><span class="p">,</span> <span class="n">flatid</span><span class="p">):</span>
            <span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fgrid</span>
    <span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="n">_nccache_time</span> <span class="o">=</span> <span class="p">{}</span>
<div class="viewcode-block" id="nccache_get_time"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.nccache_get_time">[docs]</a><span class="k">def</span> <span class="nf">nccache_get_time</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a time axis from cache or netcdf file</span>

<span class="sd">    A time axis not in cache is read using :func:`ncget_time`,</span>
<span class="sd">    them stored in cache.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **f**: File object or name.</span>
<span class="sd">        - **timeid**, optional: Single or list of time ids for :func:`ncget_time`.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; taxis = nccache_get_time(&#39;myfile.nc&#39;, [&#39;time&#39;,&#39;time_counter&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check cache</span>
    <span class="c1"># - file name</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">f</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1"># - from cache</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">_nccache_time</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_nccache_time</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>

    <span class="c1"># Read it</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">ncget_time</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">timeid</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">,</span> <span class="n">checkaxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_nccache_time</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxis</span>
    <span class="k">return</span> <span class="n">taxis</span></div>

<span class="k">class</span> <span class="nc">NcIterTimeSlice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic netcdf file iterator with a fixed slice&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">tslice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepopen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoclose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tslice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslice</span> <span class="o">=</span> <span class="n">tslice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclose</span> <span class="o">=</span> <span class="n">autoclose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span> <span class="o">=</span> <span class="n">keepopen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">timeid</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Last iteration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="c1"># Open current file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># from next one</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="o">.</span><span class="n">f</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># first time used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">f</span>

        <span class="c1"># Get time axis</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;_vacumm_timeid&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_vacumm_timeid</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="n">nccache_get_time</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeid</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">taxis</span>

        <span class="c1"># Real slice</span>
        <span class="n">tslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tslice</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)))</span>

        <span class="c1"># Finalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tslice</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file descriptors that can be closed&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="NcIterBestEstimate"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcIterBestEstimate">[docs]</a><span class="k">class</span> <span class="nc">NcIterBestEstimate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator on netcdf forecast files</span>

<span class="sd">    This class is useful for reading the best estimate of netcdf forcast files.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **files**: A list of netcdf files.</span>
<span class="sd">        - **toffset**, optional: An integer or tuple of (&lt;num&gt;, &#39;&lt;units&gt;&#39;)</span>
<span class="sd">          to skip the first time steps of each files.</span>
<span class="sd">        - **timeid**, optional: Time id. If ``None``, it is guessed</span>
<span class="sd">          using :meth:`guess_timeid`.</span>
<span class="sd">        - **tslices**, optional: A list of time slices</span>
<span class="sd">          (typically taken from a previous loop on file),</span>
<span class="sd">          to prevent guessing them.</span>
<span class="sd">        - **keepopen**, optional: Keep all file descriptor open,</span>
<span class="sd">          else close those who can be closed once no longer used.</span>
<span class="sd">        - **autoclose**: Deprecated.</span>

<span class="sd">    :Iterator: At each iteration, it returns ``f,tslice``</span>

<span class="sd">        - ``f``: the file descriptor (may be closed),</span>
<span class="sd">        - ``tslice``: the time slice</span>

<span class="sd">            - A :class:`slice` instance.</span>
<span class="sd">            - ``None`` if not time is found (thus no slice to perform).</span>
<span class="sd">            - ``False``: if nothing to read at all.</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; for f, tslice in NcIterBestEstimate(ncfiles, toffset=(1,&#39;day&#39;)):</span>
<span class="sd">    ...     if tslice is False or time is None: continue</span>
<span class="sd">    ...     var = f(time=tslice)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">toffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tslices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepopen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoclose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seltime</span> <span class="o">=</span> <span class="n">time</span> <span class="c1">#[time] if isinstance(time,list) else time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslices</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">tslices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tslices</span>
        <span class="k">if</span> <span class="n">toffset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">toffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toffset</span> <span class="o">=</span> <span class="n">toffset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">timeid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclose</span> <span class="o">=</span> <span class="n">autoclose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span> <span class="o">=</span> <span class="n">keepopen</span>
        <span class="kn">from</span> <span class="nn">atime</span> <span class="k">import</span> <span class="n">add</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">add</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seltime</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">md5</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="NcIterBestEstimate.next"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcIterBestEstimate.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Last iteration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="c1"># Check cache of time slices</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tslices</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">f</span>
            <span class="n">tslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tslices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">tslice</span>

        <span class="c1"># Open current file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># from next one</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="o">.</span><span class="n">f</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># first time used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">f</span>

        <span class="c1"># Check file cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;_vacumm_nibe_tslices&#39;</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_vacumm_nibe_tslices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Get time axis</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;_vacumm_timeid&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_vacumm_timeid</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="n">nccache_get_time</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeid</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeid</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">taxis</span>

        <span class="c1"># Get base time slice of current file</span>
        <span class="n">ijk</span> <span class="o">=</span> <span class="n">tsel2slice</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seltime</span><span class="p">,</span> <span class="n">asind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nonone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ijk</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="c1"># nothing</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ijk</span>

        <span class="c1"># Offset</span>
        <span class="n">ctimes</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">subseltime</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ctimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">),</span> <span class="n">ctimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;cc&#39;</span><span class="p">)</span>
            <span class="n">subtaxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="o">*</span><span class="n">ijk</span><span class="p">)</span>
            <span class="n">ijo</span> <span class="o">=</span> <span class="n">subtaxis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">subseltime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ijo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ijo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="c1"># nothing</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">ijo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">j</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="c1"># nothing</span>
            <span class="n">subtaxis</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Truncate to next file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span><span class="p">:</span>

            <span class="c1"># Start of slice</span>
            <span class="k">if</span> <span class="n">subtaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subtaxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="o">*</span><span class="n">ijk</span><span class="p">)</span>
                <span class="n">ct0</span> <span class="o">=</span> <span class="n">subtaxis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ct0</span> <span class="o">=</span> <span class="n">ctimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># End of slice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span> <span class="o">=</span> <span class="n">NcFileObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">taxisnext</span> <span class="o">=</span> <span class="n">nccache_get_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeid</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">ct1</span> <span class="o">=</span> <span class="n">taxisnext</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ct1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ct1</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">)</span>
                <span class="n">bb</span> <span class="o">=</span> <span class="s1">&#39;co&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">taxisnext</span><span class="p">):</span> <span class="c1"># Next file too short for offset</span>
                    <span class="n">ct1</span> <span class="o">=</span> <span class="n">ctimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bb</span> <span class="o">=</span><span class="s1">&#39;cc&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># First step starting from offset</span>
                    <span class="n">ct1</span> <span class="o">=</span> <span class="n">taxisnext</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toffset</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bb</span> <span class="o">=</span> <span class="s1">&#39;co&#39;</span>
            <span class="n">subseltime</span> <span class="o">=</span> <span class="p">(</span><span class="n">ct0</span><span class="p">,</span> <span class="n">ct1</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
            <span class="n">ijo</span> <span class="o">=</span> <span class="n">subtaxis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">subseltime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ijo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ijo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="c1"># nothing</span>
            <span class="n">io</span><span class="p">,</span> <span class="n">jo</span><span class="p">,</span> <span class="n">ko</span> <span class="o">=</span> <span class="n">ijo</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">jo</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ctimes</span>

        <span class="c1"># Finalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tslice</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">_vacumm_nibe_tslices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tslice</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">tslice</span></div>

<div class="viewcode-block" id="NcIterBestEstimate.empty"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcIterBestEstimate.empty">[docs]</a>    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Nothing to read from this file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">_vacumm_nibe_tslices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NcIterBestEstimate.close"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcIterBestEstimate.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file descriptors that can be closed&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepopen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nfonext</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="NcIterBestEstimateError"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcIterBestEstimateError">[docs]</a><span class="k">class</span> <span class="nc">NcIterBestEstimateError</span><span class="p">(</span><span class="n">VACUMMError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="NcFileObj"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcFileObj">[docs]</a><span class="k">class</span> <span class="nc">NcFileObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple class to properly manage file object or name</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; nfo = NcFileObj(&#39;myfile.nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nfo.f(&#39;sst&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nfo.close() # or del nfo: close file descriptor</span>

<span class="sd">        &gt;&gt;&gt; f = cdms2.open(path)</span>
<span class="sd">        &gt;&gt;&gt; nfo = NcFileObj(f)</span>
<span class="sd">        &gt;&gt;&gt; nfo.f(&#39;sst&#39;)</span>
<span class="sd">        &gt;&gt;&gt; del nfo # or nfo.close(): here has no effect (descriptor still open)</span>
<span class="sd">        &gt;&gt;&gt; f.close()</span>
<span class="sd">        &gt;&gt;&gt; nfo = NcFileObj(f)</span>
<span class="sd">        &gt;&gt;&gt; nfo.close() # close file descriptor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">NcFileObj</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">f</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;path&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s1">&#39;_status_&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">_status_</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">ncfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Unknown file type </span><span class="si">%s</span><span class="s1"> (not a file name or a netcdf file object)&#39;</span><span class="o">%</span><span class="n">ncfile</span><span class="p">)</span>
<div class="viewcode-block" id="NcFileObj.isclosed"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcFileObj.isclosed">[docs]</a>    <span class="k">def</span> <span class="nf">isclosed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span></div>
<div class="viewcode-block" id="NcFileObj.ispath"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcFileObj.ispath">[docs]</a>    <span class="k">def</span> <span class="nf">ispath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span></div>
<div class="viewcode-block" id="NcFileObj.isopen"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcFileObj.isopen">[docs]</a>    <span class="k">def</span> <span class="nf">isopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span></div>
<div class="viewcode-block" id="NcFileObj.close"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.NcFileObj.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    <span class="fm">__del__</span> <span class="o">=</span> <span class="n">close</span></div>

<div class="viewcode-block" id="ncread_best_estimate"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncread_best_estimate">[docs]</a><span class="k">def</span> <span class="nf">ncread_best_estimate</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the best estimate of a variable through a set of netcdf forecast files</span>

<span class="sd">    .. warning:: This function is deprecated.</span>
<span class="sd">        Please use :func:`ncread_files` switching the first</span>
<span class="sd">        two argument.</span>

<span class="sd">    This is equivalent to::</span>

<span class="sd">        ncread_files(varname, filepattern, *args, **kwargs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncread_files</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">filepattern</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ncread_files"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ncread_files">[docs]</a><span class="k">def</span> <span class="nf">ncread_files</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">toffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nibeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nopat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">patfmtfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bestestimate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the best estimate of a variable through a set of netcdf files</span>

<span class="sd">    .. warning:: Files are listed using function :func:`list_forecast_files`.</span>
<span class="sd">        Please read its documentation before using current function.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; var = ncread_files(&quot;r0_2010-%m-%d_00.nc&quot;, &#39;xe&#39;,</span>
<span class="sd">            (&#39;2010-08-10&#39;, &#39;2010-08-15&#39;, &#39;cc&#39;), samp=[2, 1, 3])</span>
<span class="sd">        &gt;&gt;&gt; var = ncread_files(&quot;http://www.net/r0_2010-%m-%d_00.nc&quot;, &#39;xe&#39;,</span>
<span class="sd">            (&#39;2010-08-10&#39;, &#39;2010-08-15&#39;, &#39;cc&#39;),</span>
<span class="sd">            timeid=&#39;TIME&#39;, toffset=(1, &#39;day&#39;))</span>
<span class="sd">        &gt;&gt;&gt; var = ncread_files(&quot;r0_2010-??-??_00.nc&quot;, &#39;xe&#39;,</span>
<span class="sd">            select=dict(lon=(-10,-5), z=slice(23,24)), grid=smallgrid)</span>
<span class="sd">        &gt;&gt;&gt; xe, sst = ncread_files(&quot;myfiles*.nc&quot;, [(&#39;xe&#39;, &#39;sla&#39;),(&#39;sst&#39;,&#39;temp&#39;),&#39;u&#39;])</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **varname**: Name of the netcdf variable to read.</span>

<span class="sd">            - If a simple name, it reads this variable.</span>
<span class="sd">            - If a list of names, it reads them all.</span>
<span class="sd">            - If a list of list of names, each variable is searched for</span>
<span class="sd">              using the sublist of names.</span>

<span class="sd">        - **filepattern**: File pattern. See :func:`list_forecast_files`</span>
<span class="sd">          for more information.</span>
<span class="sd">        - **time**, optional: Time selector. This keyword is *mandatory*</span>
<span class="sd">          if ``filepattern`` has date patterns.</span>
<span class="sd">        - **toffset**: Skip the first time steps. See :class:`NcIterBestEstimate`</span>
<span class="sd">          for more information.</span>
<span class="sd">        - **select**, optional: An additional selector for reading</span>
<span class="sd">          the variable. It can be a dictionary or a :class:`~cdms2.selectors.Selector`</span>
<span class="sd">          instance (see :func:`~vacumm.misc.misc.create_selector`).</span>
<span class="sd">        - **atts**: attributes dict (or list of attributes dict for each varname)</span>
<span class="sd">          (see :func:`ncread_var`.)</span>
<span class="sd">        - **samp**, optional: Undersample rate as a list of the same size as</span>
<span class="sd">          the rank of the variable. Set values to 0, 1 for no undersampling.</span>
<span class="sd">        - **grid**, optional: A grid to regrid the variable on.</span>
<span class="sd">        - **grid_&lt;keyword&gt;**, optional: ``keyword`` is passed to</span>
<span class="sd">          :func:`~vacumm.misc.grid.regridding.regrid`.</span>
<span class="sd">        - **timeid**, optional: Time id (otherwise it is guessed).</span>
<span class="sd">        - **ignorecase**, optional: Ignore variable name case (see :func:`ncfind_var`).</span>
<span class="sd">        - **torect**, optional: If True, try to convert output grid to rectanguar</span>
<span class="sd">          using :func:`~vacumm.misc.grid.misc.curv2rect` (see :func:`ncread_var`).</span>
<span class="sd">        - Extra kwargs are used to refine the **selector** initialized with ``select``.</span>
<span class="sd">        - **squeeze**, optional: Argument passed to :func:`ncread_var`</span>
<span class="sd">          to squeeze out singleton axes.</span>
<span class="sd">        - **searchmode**, optional: Search order (see :func:`ncfind_obj`).</span>
<span class="sd">        - **sort/nopat/patfreq/patfmtfunc/check**, optional: These arguments are passed to</span>
<span class="sd">          :func:`list_forecast_files`.</span>

<span class="sd">    :Raise: :class:`NcIterBestEstimateError` in case of error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the list of files</span>
    <span class="n">ncfiles</span> <span class="o">=</span> <span class="n">list_forecast_files</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">nopat</span><span class="o">=</span><span class="n">nopat</span><span class="p">,</span>
        <span class="n">patfreq</span><span class="o">=</span><span class="n">patfreq</span><span class="p">,</span> <span class="n">patfmtfunc</span><span class="o">=</span><span class="n">patfmtfunc</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncfiles</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NcIterBestEstimateError</span><span class="p">(</span><span class="s1">&#39;No valid file found with pattern: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filepattern</span><span class="p">)</span>
    <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">varname</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Reading best estimate variable(s): &#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">]),</span> <span class="s1">&#39;; time:&#39;</span><span class="p">,</span> <span class="n">time</span>
        <span class="nb">print</span> <span class="s1">&#39;Using files:&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">])</span>

    <span class="c1"># Some inits</span>
    <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="p">[</span><span class="n">atts</span><span class="p">]</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">atts</span><span class="p">,</span> <span class="n">nvar</span><span class="p">)</span>
    <span class="n">allvars</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nvar</span><span class="p">)]</span>
    <span class="n">kwgrid</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
    <span class="c1"># - base selector</span>
    <span class="n">selects</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">nvar</span><span class="p">)</span>
    <span class="n">selectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_selector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selects</span><span class="p">]</span>
    <span class="c1"># - iterator on files</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">toffset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bestestimate</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">NcIterTimeSlice</span><span class="p">(</span><span class="n">ncfiles</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="n">timeid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">NcIterBestEstimate</span><span class="p">(</span><span class="n">ncfiles</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeid</span><span class="o">=</span><span class="n">timeid</span><span class="p">,</span> <span class="n">toffset</span><span class="o">=</span><span class="n">toffset</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">nibeid</span><span class="p">)</span>
    <span class="c1"># - undepsampling</span>
    <span class="k">if</span> <span class="n">samp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">samp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samp</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
        <span class="n">samp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samp</span><span class="p">]</span>
    <span class="c1"># - output grid</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">grid.regridding</span> <span class="k">import</span> <span class="n">regrid2d</span>
    <span class="c1"># - time</span>
    <span class="n">time_units</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">newgrid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tvars</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span> <span class="c1"># vars with time?</span>
    <span class="n">itaxes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Loop on files</span>
    <span class="k">for</span> <span class="n">ifile</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tslice</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>

        <span class="c1"># Refine selector specs with time slice</span>
        <span class="n">kwseltime</span> <span class="o">=</span> <span class="p">{</span><span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span><span class="p">:</span><span class="n">tslice</span><span class="p">}</span> <span class="k">if</span> <span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">tslice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tslice</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
<span class="c1">#        seltime = selector(**kwseltime)</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Loop on variables</span>
        <span class="k">for</span> <span class="n">iv</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varnames</span><span class="p">):</span>

            <span class="c1"># Refine this selector</span>
            <span class="n">seltime</span> <span class="o">=</span> <span class="n">selectors</span><span class="p">[</span><span class="n">iv</span><span class="p">](</span><span class="o">**</span><span class="n">kwseltime</span><span class="p">)</span>

            <span class="c1"># Find variable name</span>
            <span class="n">oldvn</span> <span class="o">=</span> <span class="n">vn</span>
            <span class="n">vn</span> <span class="o">=</span> <span class="n">ncfind_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="n">ignorecase</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> variable not found&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">oldvn</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check time</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">withtime</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">getAxisIds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">withtime</span><span class="p">:</span>
                <span class="n">itaxes</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="n">tvars</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tslice</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> variable because time slice not compatible&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">oldvn</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">seltime</span> <span class="c1"># with time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">selectors</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="c1"># no time</span>

            <span class="c1"># Infos</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Processing file no&#39;</span><span class="p">,</span> <span class="n">ifile</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;, variable:&#39;</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="s1">&#39;, time slice :&#39;</span><span class="p">,</span> <span class="n">tslice</span>
                <span class="k">if</span> <span class="n">withtime</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">taxis</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
                    <span class="n">ctimes</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
                    <span class="nb">print</span> <span class="s1">&#39;  Available:&#39;</span><span class="p">,</span> <span class="n">ctimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">ctimes</span>

            <span class="c1"># Read the variable</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;  Selecting:&#39;</span><span class="p">,</span> <span class="n">sel</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">ncread_var</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">ignorecase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span>
                                 <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">samp</span><span class="o">=</span><span class="n">samp</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">,</span>
                                 <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iv</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">atts</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;  Loaded:&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Error when reading. Skipping. Message: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">format_exc</span><span class="p">()</span><span class="c1">#e.message</span>
                <span class="k">continue</span>


            <span class="c1"># Fix time units (that may vary between files)</span>
            <span class="k">if</span> <span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">withtime</span><span class="p">:</span>
                <span class="n">this_time_units</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">iterator</span><span class="o">.</span><span class="n">timeid</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
                <span class="k">if</span> <span class="n">time_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">time_units</span> <span class="o">=</span> <span class="n">this_time_units</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">are_same_units</span><span class="p">(</span><span class="n">this_time_units</span><span class="p">,</span> <span class="n">time_units</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ch_units</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">time_units</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="c1"># Update</span>
            <span class="k">if</span> <span class="n">withtime</span> <span class="ow">or</span> <span class="n">ifile</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># append first time or variables with time</span>
                <span class="n">allvars</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tvars</span> <span class="ow">and</span> <span class="n">ifile</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># no time for all variables</span>
                <span class="k">break</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Read only one file if no variable with time</span>
        <span class="k">if</span> <span class="n">ifile</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tvars</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Concatenate</span>
    <span class="kn">from</span> <span class="nn">misc</span> <span class="k">import</span> <span class="n">MV2_concatenate</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nvar</span><span class="p">):</span>

        <span class="c1"># Check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvars</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;No valid data found using varname(s): </span><span class="si">%s</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;filepattern: </span><span class="si">%s</span><span class="s1">, time: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">varnames</span><span class="p">[</span><span class="n">iv</span><span class="p">],</span> <span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="c1"># Reorder and merge</span>
        <span class="n">allvars</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MV2_concatenate</span><span class="p">(</span><span class="n">allvars</span><span class="p">[</span><span class="n">iv</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">itaxes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">allvars</span></div>



<div class="viewcode-block" id="grib_get_names"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.grib_get_names">[docs]</a><span class="k">def</span> <span class="nf">grib_get_names</span><span class="p">(</span><span class="n">gribfile</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list of a grib file parameter unique names (using grib message&#39;s shortName).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">pygrib</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">pygrib</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gribfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">messages</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">shortName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shortName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span></div>


<div class="viewcode-block" id="grib_read_files"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.grib_read_files">[docs]</a><span class="k">def</span> <span class="nf">grib_read_files</span><span class="p">(</span>
    <span class="n">filepattern</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">torect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read cdms2 variables through one or a set of grib files.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; vardict = grib_read_files(&quot;r0_2010-%m-%d_00.grb&quot;, &#39;u&#39;,</span>
<span class="sd">                (&#39;2010-08-10&#39;, &#39;2010-08-15&#39;, &#39;cc&#39;), samp=[2, 1, 3])</span>
<span class="sd">        &gt;&gt;&gt; vardict = grib_read_files(&quot;r0_2010-??-??_00.grb&quot;, dict(shortName:&#39;u&#39;),</span>
<span class="sd">                select=dict(lon=(-10.0,-5.0), lat=slice(100,200)), grid=smallgrid)</span>
<span class="sd">        &gt;&gt;&gt; vardict = grib_read_files(&quot;myfiles*.grb&quot;, [dict(shortName=[&#39;u&#39;, &#39;u10&#39;]), dict(shortName=[&#39;v&#39;,&#39;v10&#39;])])</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **filepattern**: must be:</span>
<span class="sd">            - File pattern. See :func:`list_forecast_files` for more information.</span>
<span class="sd">            - One or more string(s) of the files(s) to be processed. string(s) may contain wildcard characters.</span>
<span class="sd">        - **varname**: Name of the grib variable(s) to read.</span>
<span class="sd">            - If a simple name, it reads this variable **using the grib message&#39;s shortName**.</span>
<span class="sd">            - If a list of names, it reads them all.</span>
<span class="sd">            If a name is a dict, then it is used as grib selector in which case</span>
<span class="sd">            the user should not specify selectors which may interfer with the select keyword</span>
<span class="sd">            (see :func:`~pygrib.open.select`).</span>
<span class="sd">        - **time**, optional: Time selector for files and data. This keyword is *mandatory*</span>
<span class="sd">          if ``filepattern`` has date patterns.</span>

<span class="sd">        - **select**, optional: An additional selector applied after data have been loaded.</span>
<span class="sd">          It can be a dictionary or a :class:`~cdms2.selectors.Selector`</span>
<span class="sd">          instance (see :func:`~vacumm.misc.misc.create_selector`).</span>

<span class="sd">        - **torect**, optional: If True, try to convert output grid to rectanguar</span>
<span class="sd">          using :func:`~vacumm.misc.grid.misc.curv2rect` (see :func:`ncread_var`).</span>
<span class="sd">        - **samp**, optional: Undersample rate as a list of the same size as</span>
<span class="sd">          the rank of the variable. Set values to 0, 1 for no undersampling.</span>
<span class="sd">        - **grid**, optional: A grid to regrid the variable on.</span>
<span class="sd">        - **grid_&lt;keyword&gt;**, optional: ``keyword`` is passed to</span>
<span class="sd">          :func:`~vacumm.misc.grid.regridding.regrid`.</span>
<span class="sd">        - **squeeze**, optional: Argument passed to :func:`ncread_var` to squeeze out singleton axes.</span>
<span class="sd">        - **atts**: attributes dict (or list of attributes dict for each varname)</span>

<span class="sd">        - *verbose*: function to be called for logging (sys.stderr if True,</span>
<span class="sd">            disabled with False)</span>

<span class="sd">    :Return:</span>

<span class="sd">        If varname is a list of names or dicts:</span>
<span class="sd">        - a dict of loaded variables as :class:`cdms2.tvariable.TransientVariable`</span>
<span class="sd">          this dict keys are are filled with the corresponding varname value if it is a string, or wiht</span>
<span class="sd">          the loaded message&#39;s shortName/name/parameterName.</span>
<span class="sd">        Else:</span>
<span class="sd">        - the loaded variable as :class:`cdms2.tvariable.TransientVariable`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">_time</span><span class="o">,</span> <span class="nn">traceback</span>
    <span class="kn">import</span> <span class="nn">cdms2</span><span class="o">,</span> <span class="nn">pygrib</span>
    <span class="kn">from</span> <span class="nn">axes</span> <span class="k">import</span> <span class="n">create_lat</span><span class="p">,</span> <span class="n">create_lon</span>
    <span class="kn">from</span> <span class="nn">atime</span> <span class="k">import</span> <span class="n">create_time</span><span class="p">,</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">adatetime</span>
    <span class="kn">from</span> <span class="nn">grid</span> <span class="k">import</span> <span class="n">create_grid</span><span class="p">,</span> <span class="n">set_grid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="n">s</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">%</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># List of variables</span>
    <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">varname</span>
    <span class="n">verbose</span><span class="p">(</span>
        <span class="s1">&#39;grib_read_files:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  filepattern: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  time: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  varname: </span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="o">%</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">- &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">])))</span>
    <span class="c1"># List of files</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">list_forecast_files</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">filepattern</span> <span class="o">=</span> <span class="p">(</span><span class="n">filepattern</span><span class="p">,)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">filepattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No valid file found with pattern </span><span class="si">%r</span><span class="s1"> and time </span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
    <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;number of matching files: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>
    <span class="c1">#verbose(&#39;- %s&#39;%(&#39;\n- &#39;.join(files)))</span>
    <span class="k">if</span> <span class="n">time</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">adatetime</span><span class="p">,</span> <span class="n">time</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">vardict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># Load grib data</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">pygrib</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shortName</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;  select: </span><span class="si">%s</span><span class="s1"> message</span><span class="si">%s</span><span class="s1"> matching preselection </span><span class="si">%r</span><span class="s1"> (took </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">:</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="c1"># use provided special datetime object if present</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">validDate</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">validDate</span>
                    <span class="c1"># use validityDate exposed as YYYYMMDD and validityTime exposed as HHMM (or HMM or HH or H)</span>
                    <span class="k">elif</span> <span class="n">m</span><span class="o">.</span><span class="n">validityDate</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">validityTime</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%04d</span><span class="s1">00&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">validityDate</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">validityTime</span><span class="p">)</span> <span class="c1"># pad validityTime and add 00 seconds</span>
                    <span class="c1"># or use dataDate &amp; dataTime &amp; forecastTime ??</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t know how to handle datetime for message:</span><span class="se">\n</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">time</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dt</span> <span class="o">&gt;=</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">gridType</span> <span class="o">==</span> <span class="s1">&#39;regular_ll&#39;</span><span class="p">:</span>
                        <span class="n">latitudes</span><span class="p">,</span><span class="n">longitudes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">distinctLatitudes</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">distinctLongitudes</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">latitudes</span><span class="p">,</span><span class="n">longitudes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">latlons</span><span class="p">()</span>
                    <span class="n">kn</span> <span class="o">=</span> <span class="n">n</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kn</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">kn</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shortName&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameterName&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">kn</span><span class="p">:</span> <span class="n">kn</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">shortName</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">kn</span> <span class="ow">in</span> <span class="n">vardict</span><span class="p">:</span> <span class="n">vardict</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">vardict</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">datetime</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                        <span class="n">latitudes</span><span class="o">=</span><span class="n">latitudes</span><span class="p">,</span> <span class="n">longitudes</span><span class="o">=</span><span class="n">longitudes</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">values</span>
                    <span class="p">))</span>
                    <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;    message name: </span><span class="si">%r</span><span class="s1">, shortName: </span><span class="si">%r</span><span class="s1">, datetime: </span><span class="si">%s</span><span class="s1">, gridType: </span><span class="si">%r</span><span class="s1">, latitude</span><span class="si">%s</span><span class="s1">, longitude</span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">gridType</span><span class="p">,</span> <span class="n">latitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">longitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">)))</span>
                    <span class="k">del</span> <span class="n">m</span>
                <span class="k">del</span> <span class="n">ms</span>
    <span class="c1"># Transform loaded data into cdms2 variable</span>
    <span class="n">kwgrid</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">vardict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">vardict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">create_lat</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;latitudes&#39;</span><span class="p">])</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;longitudes&#39;</span><span class="p">])</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">],</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span> <span class="n">long_name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="n">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
        <span class="n">vatts</span> <span class="o">=</span> <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iv</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">atts</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">**</span><span class="n">select</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">_process_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">torect</span><span class="p">,</span> <span class="n">samp</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">kwgrid</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
        <span class="n">vardict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
    <span class="c1"># Return variable or dict of variables</span>
    <span class="k">return</span> <span class="n">vardict</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">single</span> <span class="ow">and</span> <span class="n">vardict</span><span class="p">)</span> <span class="k">else</span> <span class="n">vardict</span></div>


<div class="viewcode-block" id="grib2nc"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.grib2nc">[docs]</a><span class="k">def</span> <span class="nf">grib2nc</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ***Currently for test purpose only***</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">varlist</span> <span class="o">=</span> <span class="n">grib_read_files</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncoutfile</span><span class="p">:</span>
        <span class="nb">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;Writing to netcdf file:&#39;</span><span class="p">,</span> <span class="n">ncoutfile</span>
        <span class="n">netcdf3</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ncoutfile</span><span class="p">):</span>
            <span class="nb">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;File already exists:&#39;</span><span class="p">,</span> <span class="n">ncoutfile</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ncoutfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">varlist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;  </span><span class="si">%r</span><span class="s1"> not found&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="nb">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;  </span><span class="si">%r</span><span class="s1"> (</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="k">class</span> <span class="nc">CachedRecord</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for managing cached records</span>

<span class="sd">    ** It cannot be used by itself **</span>

<span class="sd">    The following class variables must be defined:</span>

<span class="sd">    - _cache_file: cache file name</span>
<span class="sd">    - _time_range: (&#39;2000-12-01 12:00&#39;,&#39;2005-10-01&#39;,&#39;co&#39;) OR (1, &#39;day&#39;, &#39;cc&#39;)</span>
<span class="sd">    - _var_info: ((&#39;lon&#39;,&#39;Longitude&#39;, &#39;degrees east&#39;, None),(&#39;hs&#39;,&#39;Wave Height&#39;, &#39;m&#39;, (0., 20)),)</span>
<span class="sd">    - _station_info: ([&#39;Start Bay&#39;, &#39;2007-12-25&#39;],[&#39;Long Bay&#39;, &#39;2004-05-18&#39;])</span>
<span class="sd">    - _dt: (1800, cdtime.Seconds)</span>
<span class="sd">    - _time_units: &#39;seconds since 2000-01-01&#39;</span>

<span class="sd">    The following methods must be defined:</span>

<span class="sd">    - _load_from_source_:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_verbose_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_missing_value</span> <span class="o">=</span> <span class="mf">1.e20</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span> <span class="o">%</span><span class="nb">vars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode</span> <span class="o">=</span> <span class="n">time_range</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode</span><span class="p">:</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>

        <span class="n">_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">sn</span> <span class="k">for</span> <span class="n">sn</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">un</span><span class="p">,</span> <span class="n">vr</span> <span class="ow">in</span> <span class="n">_var_info</span><span class="p">]</span>
        <span class="n">_station_info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">name</span><span class="p">,</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_origin</span><span class="p">)]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span>  <span class="n">time_origin</span> <span class="ow">in</span> <span class="n">_buoy_info</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cache</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_print_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose_level</span> <span class="o">&gt;=</span> <span class="n">level</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;!WARNING! &#39;</span><span class="o">+</span><span class="n">text</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buoy_type</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">_warn_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print available variables&quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s1">&#39;Available variables:&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a variable</span>

<span class="sd">        - **var_name**: Name of the variable</span>

<span class="sd">        Return: A 1D :mod:`MV2` variable</span>

<span class="sd">        See: :meth:`plot()`, :meth:`show_variables()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Time range</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="s1">&#39; Wrong name of variable (&quot;</span><span class="si">%s</span><span class="s1">&quot;). Please use .show_variables() to list available variables&#39;</span><span class="o">%</span><span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_range</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a variable</span>

<span class="sd">        @see: :meth:`get()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var_name</span><span class="p">,</span><span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot a variable</span>

<span class="sd">        - **var_name**: Name of the variable</span>
<span class="sd">        - *time*: Plot only within this time range (like (&#39;2007-01-01&#39;,&#39;2007-02-01&#39;,&#39;co&#39;)</span>
<span class="sd">        - *show*: Show the figure [default: None]</span>
<span class="sd">        - All other keywords are passed to :func:`vacumm.misc.plot.curve()`</span>

<span class="sd">        Example:</span>

<span class="sd">        &gt;&gt;&gt; myvar = mybuoy.plot(&#39;baro&#39;)</span>

<span class="sd">        See: :meth:`get()`, :meth:`show_variables()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#       # Time range</span>
<span class="c1">#       time_range = self._get_time_range_(time_range)</span>
<span class="c1">#       if time_range != self._time_range:</span>
<span class="c1">#           self.load(time_range)</span>
<span class="c1">#</span>
        <span class="c1"># Variable</span>
        <span class="k">assert</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="s1">&#39; Wrong name of variable. Please use .show_variables() to list available variables&#39;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>

        <span class="c1"># Keywords</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
            <span class="s1">&#39;marker&#39;</span><span class="p">:</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mf">4.</span><span class="p">,</span>
            <span class="s1">&#39;mfc&#39;</span><span class="p">:</span><span class="s1">&#39;#00ffff&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> buoy </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">buoy_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">buoy_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">att</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Plot</span>
        <span class="n">curve</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_</span><span class="p">(</span><span class="s1">&#39;No variables to save&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_warn_</span><span class="p">(</span><span class="s1">&#39;No write access to file:&#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="n">att</span> <span class="o">=</span> <span class="s1">&#39;buoy_&#39;</span><span class="o">+</span><span class="n">att</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_url&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;Cache updated&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;Saved to &#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buoy</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Search for the buoy</span>
        <span class="n">buoy_names</span> <span class="o">=</span> <span class="n">_channelcoast_list_</span><span class="p">(</span><span class="n">buoy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">buoy_names</span><span class="p">),</span> <span class="s1">&#39;No buoy matching: &#39;</span><span class="o">+</span><span class="n">buoy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_name</span> <span class="o">=</span> <span class="n">buoy_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_id</span> <span class="o">=</span> <span class="n">buoy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">buoy_name</span><span class="p">,</span> <span class="n">time_origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buoy_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">buoy_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_origin</span> <span class="o">=</span> <span class="n">time_origin</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Tuning</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span> <span class="o">%</span><span class="nb">vars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode</span> <span class="o">=</span> <span class="n">time_range</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode</span><span class="p">:</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_Buoy_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_Buoy_</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_time_range_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="c1"># Directly specified</span>
            <span class="kn">from</span> <span class="nn">.atime</span> <span class="k">import</span> <span class="n">time_selector</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="n">time_selector</span><span class="p">(</span><span class="o">*</span><span class="n">time_range</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">time_range</span> <span class="ow">in</span>  <span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># Everything possible</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_origin</span><span class="p">,</span> <span class="n">now</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">else</span> <span class="p">:</span><span class="c1">#if hasattr(self, &#39;_time_range&#39;): # Default specified time range</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_range</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Default bound indicators</span>
            <span class="n">time_range</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_origin</span><span class="p">:</span> <span class="c1"># Check not too old</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_origin</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">time_range</span>

    <span class="k">def</span> <span class="nf">_check_time_range_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="n">time_axis</span><span class="p">,</span> <span class="n">getbounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a time_range is included in an time axis&quot;&quot;&quot;</span>

        <span class="c1"># Format time range</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>

        <span class="c1"># Get right time axis</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_axis</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">getbounds</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="n">time_axis</span> <span class="o">=</span> <span class="n">time_axis</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">time_axis</span><span class="p">):</span>
            <span class="n">time_axis</span> <span class="o">=</span> <span class="n">time_axis</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>

        <span class="c1"># Get axis range</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">)</span>
        <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">time_axis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>

        <span class="c1"># Convert to closed bounds</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ibound</span><span class="p">,</span> <span class="n">isign</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ibound</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                <span class="n">time_range</span><span class="p">[</span><span class="n">ibound</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_range</span><span class="p">[</span><span class="n">ibound</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">isign</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Check bounds</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">t0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode</span><span class="p">,</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getbounds</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if time_range is included in in-memory variables, else, check cache and load from it&quot;&quot;&quot;</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_cache</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the cache&quot;&quot;&quot;</span>

        <span class="n">buoy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_id</span>

        <span class="c1"># Time bounds</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;CHECK CACHE TIME RANGE &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time_range</span><span class="p">))</span>
        <span class="n">t0_request</span><span class="p">,</span> <span class="n">t1_request</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">time_range</span>

        <span class="c1"># Update or create?</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="k">raise</span> <span class="s1">&#39;a&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="o">%</span><span class="nb">vars</span><span class="p">()):</span>  <span class="c1"># Create</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;CREATE&#39;</span><span class="p">)</span>
            <span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">),</span> <span class="s1">&#39;cc&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_source_</span><span class="p">(</span><span class="n">time_range</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="o">%</span><span class="nb">vars</span><span class="p">(),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Update</span>

            <span class="c1"># Check cache time range</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="p">)</span>
            <span class="n">cache_time</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">cache_time</span><span class="p">)</span>
            <span class="n">cache_time</span> <span class="o">=</span> <span class="n">cache_time</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">cache_time</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">t0_good</span><span class="p">,</span> <span class="n">t1_good</span><span class="p">,</span> <span class="n">t0_cache</span><span class="p">,</span> <span class="n">t1_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">cache_time</span><span class="p">,</span> <span class="n">getbounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Check first date</span>
            <span class="n">vars_new</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t0_good</span><span class="p">:</span>
                <span class="c1"># First date of cache is too recent</span>
                <span class="n">vars_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_source_</span><span class="p">((</span><span class="n">t0_request</span><span class="p">,</span> <span class="n">t0_cache</span><span class="p">,</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">))</span>
                <span class="n">vars_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_cache_</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_before</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_names</span><span class="p">:</span>
                        <span class="n">vars_new</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars_before</span><span class="p">[</span><span class="n">vn</span><span class="p">],</span> <span class="n">vars_current</span><span class="p">[</span><span class="n">vn</span><span class="p">])</span>
            <span class="c1"># Check last date</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t1_good</span><span class="p">:</span>
                <span class="n">vars_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_source_</span><span class="p">((</span><span class="n">t1_cache</span><span class="p">,</span> <span class="n">t1_request</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="o">+</span><span class="n">time_range</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_after</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_new</span><span class="p">):</span>
                        <span class="c1"># We just append to file</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;APPEND TO FILE&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="n">vars_after</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="o">%</span><span class="nb">vars</span><span class="p">(),</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39; loading from cache &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time_range</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_cache_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># We append to var before saving</span>
                        <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_names</span><span class="p">:</span>
                            <span class="n">vars_new</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vars_after</span><span class="p">[</span><span class="n">vn</span><span class="p">],</span> <span class="p">)</span>

            <span class="c1"># Here we completely change the cache</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_new</span><span class="p">):</span>

                <span class="c1"># Merge</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_</span><span class="p">(</span><span class="s1">&#39;MERGING&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">un</span><span class="p">,</span> <span class="n">vr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_info</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span> <span class="o">=</span> <span class="n">MV</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vars_new</span><span class="p">[</span><span class="n">sn</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sn</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">ln</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">un</span>

                <span class="c1"># Save</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="o">%</span><span class="nb">vars</span><span class="p">(),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Update in memory variables</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_cache_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_from_cache_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load variables from cache&quot;&quot;&quot;</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">buoy_id</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_id</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_file</span><span class="o">%</span><span class="nb">vars</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">time_range</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span>




<div class="viewcode-block" id="Shapes"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes">[docs]</a><span class="k">class</span> <span class="nc">Shapes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class to read shapefiles and return GEOS objects</span>
<span class="sd">    Inspired from basemap.readshapefile</span>

<span class="sd">    Here are the conversion rules from shapefile to GEOS objects :</span>

<span class="sd">        - Points and multipoints are interpreted as :class:`Points`.</span>
<span class="sd">        - Polylines are interpreted as :class:`LineString`.</span>
<span class="sd">        - Polygons are interpreted as :class:`Polygons`.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **input**: Refers to a shapefile or is a shapes isntance ;</span>
<span class="sd">          if a shapefile, it assumes that &lt;input&gt;.shp contains points,</span>
<span class="sd">          multipoints, lines or polygons, and that &lt;input&gt;.dbf contains their attributes.</span>
<span class="sd">        - **proj*, optional: A projection function to convert coordinates. It must accept</span>
<span class="sd">          the &quot;inverse&quot; keyword.</span>
<span class="sd">        - **m*, optional: A Basemap instance for converting for plotting.</span>
<span class="sd">        - *inverse*, optional: Inverset the conversion with proj .</span>
<span class="sd">        - **clip*, optional: If in the form ``(xmin,ymin,xmax,ymax)``,</span>
<span class="sd">          clips to this box ; if a polygon like argument,</span>
<span class="sd">          it clips to this polygon</span>
<span class="sd">          (see :func:`~vacumm.misc.grid.masking.polygons()` for arguments).</span>
<span class="sd">          If simply ``True`` and *m* is present, it clips to the bounds of *m*.</span>
<span class="sd">        - **min_area*, optional: Minimal area to keep a polygon</span>
<span class="sd">        - **samp**, optional: An integer to undersample coordinates of polygons and lines.</span>
<span class="sd">        - **shapetype**, optional:</span>

<span class="sd">            - If 0, it must only deal with points ;</span>
<span class="sd">            - if 1, only polylines ;</span>
<span class="sd">            - if 2, only polygons (conversion 1&lt;-&gt;2 is automatic).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">POINTS</span> <span class="o">=</span> <span class="n">POINT</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LINES</span> <span class="o">=</span> <span class="n">LINE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">POLYGONS</span> <span class="o">=</span> <span class="n">POLYS</span> <span class="o">=</span> <span class="n">POLY</span> <span class="o">=</span> <span class="n">POLYGON</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">INPUT_POINTS</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">INPUT_MULTIPOINTS</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">INPUT_POLYLINES</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">INPUT_POLYGONS</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">shapetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">samp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="c1"># Inits</span>
<span class="c1">#        if isinstance(input, list) and input: input = input[0]</span>
        <span class="n">from_file</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">map</span>
        <span class="n">default_proj</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="n">m</span>

        <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>

            <span class="c1"># From a shapefile</span>
            <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.dbf&#39;</span><span class="p">):</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;shp&#39;</span><span class="p">,</span> <span class="p">):</span><span class="c1">#, &#39;dbf&#39;:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">fname</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">shapefile</span> <span class="k">import</span> <span class="n">Reader</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">mpl_toolkits.basemap.shapefile</span> <span class="k">import</span> <span class="n">Reader</span>
                <span class="n">newreader</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">shp</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">input_type</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapeType</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;Cannot read </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">Trying with shapelib&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">shapelib</span> <span class="k">import</span> <span class="n">ShapeFile</span>
                <span class="n">newreader</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">shp</span> <span class="o">=</span> <span class="n">ShapeFile</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">input_type</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="nb">input</span>
<span class="c1">#           dbf = dbflib.open(input)</span>
            <span class="k">if</span> <span class="n">default_proj</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">default_proj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">default_proj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span> <span class="c1"># From coordinates</span>
            <span class="n">in_coords</span> <span class="o">=</span> <span class="nb">input</span>
            <span class="n">input_type</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_coords</span><span class="p">)</span> <span class="ow">or</span> <span class="n">in_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># From a Shapes (or super) instance</span>
            <span class="n">in_coords</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">_m</span> <span class="c1"># overwrite m keyword</span>
            <span class="n">default_proj</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">_proj</span>
            <span class="n">input_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POINTS</span><span class="p">,</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POLYLINES</span><span class="p">,</span>
                <span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POLYGONS</span><span class="p">][</span><span class="nb">input</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">_info</span>

        <span class="c1"># Get coordinates</span>
        <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newreader</span><span class="p">:</span>
                <span class="n">nshapes</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">numRecords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nshapes</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nshapes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POINTS</span><span class="p">,</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_MULTIPOINTS</span><span class="p">]:</span> <span class="c1"># A Point or MultiPoint file</span>
            <span class="k">if</span> <span class="n">shapetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shapetype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Your shape type is not point&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span>

            <span class="c1"># Loop on shape groups</span>
            <span class="k">for</span> <span class="n">iobj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nshapes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">newreader</span><span class="p">:</span>
                        <span class="n">all_points</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">iobj</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">points</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">all_points</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">read_object</span><span class="p">(</span><span class="n">iobj</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_points</span> <span class="o">=</span> <span class="n">in_coords</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_points</span><span class="p">)</span>

            <span class="c1"># Merge coordinates</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

<span class="c1">#               if from_file: self._info.append(dbf.read_record(iobj))</span>

        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POLYLINES</span><span class="p">,</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POLYGONS</span><span class="p">]:</span> <span class="c1"># A Polyline or Polygon file</span>

            <span class="c1"># Shape type</span>
            <span class="k">if</span> <span class="n">shapetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shapetype</span> <span class="o">==</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">POINTS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Your shape type is point, not polyline or polygon&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">shapetype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">input_type</span><span class="o">==</span><span class="n">Shapes</span><span class="o">.</span><span class="n">INPUT_POLYLINES</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">LINES</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Shapes</span><span class="o">.</span><span class="n">POLYGONS</span>

            <span class="c1"># Loop on shape groups</span>
            <span class="k">for</span> <span class="n">iobj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nshapes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">newreader</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapeRecord</span><span class="p">(</span><span class="n">iobj</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">all_points</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">points</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_points</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">nparts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nparts</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">all_polys</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_points</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">all_polys</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nparts</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">all_polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_points</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">ip</span><span class="p">]:</span><span class="n">obj</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="c1">#xxxxxxxx</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">all_polys</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">read_object</span><span class="p">(</span><span class="n">iobj</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_polys</span> <span class="o">=</span> <span class="n">in_coords</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_polys</span><span class="p">)</span>

            <span class="c1"># Merge coordinates</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Input shapefile must only contains 2D shapes&#39;</span>

        <span class="c1"># Bounds</span>
        <span class="k">if</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">del</span> <span class="n">xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpmin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypmin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Projection</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="k">elif</span> <span class="n">default_proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="o">=</span> <span class="n">default_proj</span>
        <span class="k">elif</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
<span class="c1">#            self._proj = None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m_projsync</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">):</span> <span class="c1"># same projection as of map?</span>
            <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_m_projsync</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">allclose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_m_projsync</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_m_projsync</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


        <span class="c1"># Clipping zone with projected coordinates</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_zone_</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>

        <span class="c1"># Convert to shapes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shaper</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>

            <span class="c1"># Numeric array</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

            <span class="c1"># Under sampling</span>
            <span class="k">if</span> <span class="n">samp</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">samp</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[::</span><span class="n">samp</span><span class="p">]</span>

            <span class="c1"># Projection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">91</span> <span class="ow">and</span> <span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&gt;-</span><span class="mi">91</span><span class="p">:</span>
                    <span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">89.99</span><span class="p">,</span> <span class="mf">89.99</span><span class="p">)</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Convert to shape instance</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaper</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

            <span class="c1"># Clip</span>
            <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="n">clip_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">]</span>

            <span class="c1"># Minimal area</span>
            <span class="k">if</span> <span class="n">min_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaper</span> <span class="ow">is</span> <span class="n">Polygon</span> <span class="ow">and</span> <span class="n">min_area</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sh</span><span class="p">:</span> <span class="n">sh</span><span class="o">.</span><span class="n">area</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_area</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>

            <span class="c1"># Store</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>


        <span class="c1"># Final bounds</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">min_area</span><span class="p">:</span>

            <span class="c1"># Normal coordinates</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># min(self.xmin, xy[0].min())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># max(self.xmax, xy[0].max())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># min(self.ymin, xy[1].min())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># max(self.ymax, xy[1].max())</span>
            <span class="k">del</span> <span class="n">xy</span>

        <span class="c1"># Projected coordinates</span>
        <span class="n">xyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpmin</span> <span class="o">=</span> <span class="n">xyp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1">#min(self.xpmin, xyp[0].min())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpmax</span> <span class="o">=</span> <span class="n">xyp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1">#max(self.xpmax, xyp[0].max())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypmin</span> <span class="o">=</span> <span class="n">xyp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1">#min(self.ypmin, xyp[1].min())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypmax</span> <span class="o">=</span> <span class="n">xyp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1">#max(self.ypmax, xyp[1].max())</span>
        <span class="k">del</span> <span class="n">xyp</span>


        <span class="c1"># Finalize</span>
        <span class="k">if</span> <span class="n">from_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newreader</span><span class="p">:</span>
            <span class="n">shp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1">#           dbf.close()</span>
        <span class="c1"># Sort by area?</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sorted</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_clip_zone_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a projected polygon or None&quot;&quot;&quot;</span>
        <span class="c1"># From grid</span>
        <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">clip</span><span class="p">):</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

        <span class="c1"># From dictionary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
           <span class="k">if</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="n">clip</span> <span class="ow">and</span> <span class="s1">&#39;lat&#39;</span> <span class="ow">in</span> <span class="n">clip</span><span class="p">:</span>
               <span class="n">clip</span> <span class="o">=</span> <span class="p">[</span><span class="n">clip</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">clip</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">clip</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">clip</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

           <span class="k">else</span><span class="p">:</span>
               <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># No clipping</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Guess or set it</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Normal polygon</span>
            <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">)</span>

            <span class="c1"># Guess from map</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_projsync</span><span class="p">:</span>
                    <span class="n">proj</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymax</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">xmin</span><span class="p">],</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">ymax</span><span class="p">],</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>



<div class="viewcode-block" id="Shapes.clip"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clip to zone</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **zone**: ``[xmin, ymin, xmax, ymax]``</span>
<span class="sd">            - **copy**, optional: If ``True``, make a copy of current instance,</span>
<span class="sd">              else simply rehandled the list of shapes.</span>
<span class="sd">            - If ``copy==True``, Other parameters are passed to the initialization</span>
<span class="sd">              of the new instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_zone_</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newshapes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                        <span class="n">intersections</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
                        <span class="n">newshapes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_shaper</span><span class="p">),</span> <span class="n">intersections</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span> <span class="o">=</span> <span class="n">newshapes</span>
                <span class="k">if</span> <span class="n">sort</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#   def join_lines(self, poly=True):</span>
<span class="c1">#       # Array of end points</span>
<span class="c1">#       nsh = len(self)</span>
<span class="c1">#       ends = N.zeros((2*nsh, 3))</span>
<span class="c1">#       for i in xrange(nsh):</span>
<span class="c1">#           ends[i, 0:1] = self._shapes[i][0]</span>
<span class="c1">#           ends[i+1, 0:1] = self._shapes[i][-1]</span>
<span class="c1">#           ends[i:i+2, 2] = float(i)</span>
<span class="c1">#       # Distances</span>
<span class="c1">#       xx = ends[:, 0].reshape((nsh*2, nsh*2))</span>
<span class="c1">#       yy = ends[:, 1].reshape((nsh*2, nsh*2))</span>
<span class="c1">#       dst = (xx-xx.transpose())**2+(yy-yy.transpose())**2</span>
<span class="c1">#       new_shapes = []</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<span class="c1">#    def project(self, proj=True, inverse=False):</span>
<span class="c1">#        &quot;&quot;&quot;Project shapes using proj</span>
<span class="c1">#</span>
<span class="c1">#        - **proj**: A Basemap instance or pure projection instance (from Basemap).</span>
<span class="c1">#          If True, a mercator projection is used.</span>
<span class="c1">#        - *inverse*: Inverse projection [default: False]</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        if proj is True:</span>
<span class="c1">#            proj=merc(lon=(self.xmin, self.xmax), lat=(self.ymin, self.ymax))</span>
<span class="c1">#        for i, shape in enumerate(self):</span>
<span class="c1">#            bb = shape.boundary</span>
<span class="c1">#            if self._type == 0:</span>
<span class="c1">#                bb = proj(b[0], b[1], inverse=inverse)</span>
<span class="c1">#            else:</span>
<span class="c1">#                bb[:, 0], bb[:, 1] = proj(bb[:, 0], bb[:, 1], inverse=inverse)</span>
<span class="c1">#            self._shapes[i] = self._shaper(bb)</span>
<span class="c1">#        if isinstance(proj, Basemap): proj = proj.projtran</span>
<span class="c1">#        self._proj.append((proj, inverse))</span>

<div class="viewcode-block" id="Shapes.sort"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort shapes according to their surface or length</span>

<span class="sd">        - *reverse*: If True, greater polygons are first [default: True]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span> <span class="n">p1</span><span class="o">.</span><span class="n">area</span><span class="p">()),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sorted</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">boundary</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">boundary</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sorted</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sorted</span> <span class="o">=</span> <span class="mi">0</span></div>
<div class="viewcode-block" id="Shapes.sorted"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.sorted">[docs]</a>    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted</span></div>

<div class="viewcode-block" id="Shapes.get_type"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of shapes</span>

<span class="sd">        - :attr:`POINTS` = Points,</span>
<span class="sd">        - :attr:`LINES` = LineStrings = PolyLines</span>
<span class="sd">        - :attr:`POLYGONS` = Polygons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span></div>

<div class="viewcode-block" id="Shapes.is_type"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.is_type">[docs]</a>    <span class="k">def</span> <span class="nf">is_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check type</span>

<span class="sd">        :Example:</span>

<span class="sd">            &gt;&gt;&gt; self.is_type(self.POLYS)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">==</span><span class="nb">type</span></div>

    <span class="k">def</span> <span class="nf">_get_proj_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a valid projection function to operate on shapes coordinates&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_proj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">):</span> <span class="c1"># already projected</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">):</span> <span class="c1"># from map</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span>

            <span class="c1"># using grid.basemap.get_proj</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">:</span>
                <span class="n">gg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gg</span> <span class="o">=</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">],</span>
                    <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">],</span> <span class="o">-</span><span class="mf">89.99</span><span class="p">,</span> <span class="mf">89.99</span><span class="p">))</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">return</span> <span class="n">get_proj</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">):</span> <span class="c1"># already projected</span>

            <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># no projection -&gt; project back</span>
                <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="ow">not</span> <span class="n">inverse</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">:</span> <span class="c1">#re-projection</span>
                <span class="n">old_proj</span> <span class="o">=</span> <span class="n">proj</span>
                <span class="k">def</span> <span class="nf">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">old_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="p">)))</span>
                    <span class="k">return</span> <span class="n">old_proj</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># no need to project</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">proj</span>



<div class="viewcode-block" id="Shapes.get_shapes"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_shapes">[docs]</a>    <span class="k">def</span> <span class="nf">get_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of geos objects (polygons, etc)</span>

<span class="sd">        :Param:</span>

<span class="sd">            - **key**: A slice selector applied to the list.</span>
<span class="sd">            - **proj**: ``True``, or a callable to project or re-project coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Objects to work on</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapes</span><span class="p">]</span>

        <span class="c1"># Projection</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

        <span class="c1"># Loop on shapes</span>
        <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">proj_shape</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="k">return</span> <span class="n">polys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">polys</span></div>

<div class="viewcode-block" id="Shapes.get_data"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the numeric version of the list of geos objects (polygons, etc)</span>

<span class="sd">        :Param:</span>

<span class="sd">            - **key**: A slice selector applied to the list.</span>
<span class="sd">            - **proj**: ``True``, or a callable to project or re-project coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># Projection</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

        <span class="c1"># Shapes to work on</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapes</span><span class="p">]</span>

        <span class="c1"># Loop on shapes</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span>
            <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span><span class="p">):</span> <span class="c1"># Points</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">proj</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># Lines</span>
                    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">del</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Shapes.get_points"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_points">[docs]</a>    <span class="k">def</span> <span class="nf">get_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all the points from all the shapes as a tuple (x,y)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([[],[]])</span>

        <span class="c1"># Projection</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

        <span class="c1"># Shapes to work on</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapes</span><span class="p">]</span>

        <span class="c1"># Loop in shapes</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span><span class="p">):</span>
                <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">yy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">yy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proj</span><span class="p">:</span> <span class="k">return</span> <span class="n">proj</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proj</span><span class="p">:</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">proj</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">])</span></div>

<div class="viewcode-block" id="Shapes.get_xy"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_xy">[docs]</a>    <span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shortcut to ``get_points(split=false)``&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span></div>
    <span class="n">xy</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xy</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;XY coordinates as a (2,npts) array&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Shapes.resol"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.resol">[docs]</a>    <span class="k">def</span> <span class="nf">resol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the mean &quot;resolution&quot; of the shapes based on the first shape</span>

<span class="sd">        - **deg**:</span>

<span class="sd">            - if ``False``: return a resolution in meters has a the median distance between points</span>
<span class="sd">            - if ``True``: return the median distance between points as a resolution in degrees ``(xres,yres)``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="kn">from</span> <span class="nn">vacumm.misc.grid.misc</span> <span class="k">import</span> <span class="n">resol</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deg</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">):</span> <span class="c1"># m-&gt;deg</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">resol</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="n">y0</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">deg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">resol</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resol</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shapes.get_map"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.get_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the associated basemap instance if set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span><span class="o">.</span><span class="n">map</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span></div>

<div class="viewcode-block" id="Shapes.plot"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Shapes.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">autoscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot shapes</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **select**, optional: argument for selecting shapes in the list [defaul: None].</span>
<span class="sd">            - **fill**, optional: Force filling (True/False), else guessed from shpe type, ie filling for polygons only [default: None]</span>
<span class="sd">            - **ax**, optional: Axes instance.</span>
<span class="sd">            - **m**, optional: :class:`~vacumm.misc.core_plot.Map` instance</span>
<span class="sd">              (created with :func:`~vacumm.misc.plot.map2`) or a :class:`~mpl_toolkits.basemap.Basemap` instance.</span>
<span class="sd">            - **points**, optional: Plots shapes as points.</span>
<span class="sd">            - **lines**, optional: Plot shapes as lines (if a of type :attr:`POINTS`).</span>
<span class="sd">            - **fill_&lt;params&gt;**, optional: ``&lt;param&gt;`` is passed to</span>
<span class="sd">              :class:`~matplotlib.collections.PolyCollection`.</span>
<span class="sd">            - **lines_&lt;params&gt;**, optional: ``&lt;param&gt;`` is passed to</span>
<span class="sd">              :class:`~matplotlib.collections.LineCollection` or to :class:`~matplotlib.collections.PolyCollection`.</span>
<span class="sd">            - **points_&lt;params&gt;**, optional: ``&lt;param&gt;`` is passed to</span>
<span class="sd">              :class:`~matplotlib.pyplot.scatter`.</span>
<span class="sd">            - **m_&lt;params&gt;**, optional: ``&lt;param&gt;`` is passed to</span>
<span class="sd">              :class:`~vacumm.misc.plot.map2` if ``m is True``.</span>
<span class="sd">            - **autoscale**, optional: Autoscale axis limits?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Keywords</span>
        <span class="n">kwpoints</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">)</span>
        <span class="n">kwlines</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;lines&#39;</span><span class="p">)</span>
        <span class="n">kwpoints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">kwpoints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linewidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwlines</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">)</span>
        <span class="n">kwlines</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linestyles&#39;</span><span class="p">,</span> <span class="s1">&#39;solid&#39;</span><span class="p">)</span>
        <span class="n">kwlines</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="n">kwlines</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">kwpoints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">kwfill</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;fill&#39;</span><span class="p">)</span>
        <span class="n">kwfill</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwlines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POLYGONS</span><span class="p">):</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1"># Map</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">m</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">!=</span><span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">core_plot</span> <span class="k">import</span> <span class="n">Map</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">get_current</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">kwmap</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span><span class="s1">&#39;m_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No shape found, thus nothing to plot&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kwmap</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">):</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span><span class="o">*.</span><span class="mi">05</span>
                    <span class="n">kwmap</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="o">+</span><span class="n">dx</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kwmap</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">):</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span><span class="o">*.</span><span class="mi">05</span>
                    <span class="n">kwmap</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="o">+</span><span class="n">dy</span><span class="p">)</span>
            <span class="n">kwmap</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">kwmap</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="s1">&#39;merc&#39;</span><span class="p">)</span>
            <span class="n">kwmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">kwmap</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">isbm</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Basemap</span><span class="p">)</span>

        <span class="c1"># Plot on what?</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;axes&#39;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">P</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Plot what?</span>
        <span class="k">if</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># Polygons or lines</span>
        <span class="n">oo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POINTS</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fill</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POLYGONS</span><span class="p">))</span> <span class="ow">or</span> <span class="n">fill</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># Polygons</span>
                <span class="k">if</span> <span class="n">fillcolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">land</span>
                <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">kwfill</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">*</span><span class="n">kv</span><span class="p">)</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">PolyCollection</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfill</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwlines</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="n">oo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isbm</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">set_axes_limits</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Points</span>
        <span class="k">if</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwpoints</span><span class="p">)</span>
            <span class="n">oo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isbm</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">set_axes_limits</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Special properties</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="s1">&#39;set_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="s1">&#39;set_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c1"># Finalize</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">autoscale</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">oo</span></div></div>

<div class="viewcode-block" id="XYZ"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ">[docs]</a><span class="k">class</span> <span class="nc">XYZ</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to manipulate xyz data (randomly spaced)</span>

<span class="sd">    - **xyz**: It can be either</span>

<span class="sd">        - a .xyz ascii file, or a netcdf/grd file with variables ``x``, ``y`` and ``z``,</span>
<span class="sd">        - a (x,y,z) tuple,</span>
<span class="sd">        - a (3, npts) array,</span>
<span class="sd">        - another XYZ instance.</span>

<span class="sd">    - *long_name*: Long name</span>
<span class="sd">    - *units* Units</span>
<span class="sd">    - *tranform*: It can be either</span>

<span class="sd">        - a factor applied to z at initialisation</span>
<span class="sd">        - a fonction that takes z as the only argument to filter its data.</span>

<span class="sd">    - *exc*: Polygons to exclude data (see :meth:`exclude`).</span>
<span class="sd">             Several polygons must be passed as a tuple (poly1, poly2, ...).</span>
<span class="sd">    - *sel*: Polygons to select data (see :meth:`select`).</span>
<span class="sd">             Several polygons must be passed as a tuple (poly1, poly2, ...).</span>
<span class="sd">    - load_&lt;keywords&gt;: keywords are passed to :func:`numpy.loadtxt`</span>
<span class="sd">    - rsamp_&lt;keywords&gt;: keywords are passed to :func:`rsamp`</span>
<span class="sd">    - Other keywords are set as atrributes.</span>


<span class="sd">    Slicing:</span>

<span class="sd">    - len(obj): number of xyz data</span>
<span class="sd">    - obj[1:3]: [(x0,y0,z0),(x1,y1,z1)]</span>

<span class="sd">    Operations :</span>

<span class="sd">    &gt;&gt;&gt; xyz += 2</span>
<span class="sd">    &gt;&gt;&gt; xyz3 = xyz1 + xyz2/2. # concatenation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">trans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">magnet</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rsamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Load data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">XYZ</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">units</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">units</span>
            <span class="k">if</span> <span class="n">long_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">long_name</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">long_name</span>
<span class="c1">#           if m is None: m = XYZ._m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">_selections</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">xyz</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="c1"># Direct</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
            <span class="c1"># Read from file</span>
            <span class="k">if</span> <span class="n">xyz</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.grd&#39;</span><span class="p">):</span>
                <span class="c1"># Netcdf or grid file</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ascii file</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;xyz must be either a .xyz file or a tuple of (x, y, z) values&#39;</span>
        <span class="c1"># Float64 are needed for polygons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">operator</span><span class="o">.</span><span class="n">isNumberType</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">*=</span> <span class="n">trans</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">long_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transp</span><span class="p">(</span><span class="n">transp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_magnet</span><span class="p">(</span><span class="n">magnet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rsamp</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">rsamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">=</span> <span class="n">rsamp</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xres_man</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_man</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now update arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;XYZ:&#39;</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> total npts: </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> full extension: xmin=</span><span class="si">%g</span><span class="s1"> xmax=</span><span class="si">%g</span><span class="s1"> ymin=</span><span class="si">%g</span><span class="s1"> ymax=</span><span class="si">%g</span><span class="s1"> zmin=</span><span class="si">%g</span><span class="s1"> zmax=</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> selection polygon(s)&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> exclusion polygon(s)&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> filtered extension: xmin=</span><span class="si">%g</span><span class="s1"> xmax=</span><span class="si">%g</span><span class="s1"> ymin=</span><span class="si">%g</span><span class="s1"> ymax=</span><span class="si">%g</span><span class="s1"> zmin=</span><span class="si">%g</span><span class="s1"> zmax=</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span>\
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="XYZ.copy"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copy&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Consolidate to remove exceptions and selections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consolidate</span><span class="p">()</span>
            <span class="c1"># Load</span>
            <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="c1"># Transparency</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">get_transp</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consolidate</span><span class="p">()</span>
            <span class="c1"># Concatenate arrays</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">l</span><span class="p">))))</span>
            <span class="c1"># Now update everything</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">operator</span><span class="o">.</span><span class="n">isNumberType</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="s1">&#39;Only scalars are allowed for such arithmetic operation&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">-=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">operator</span><span class="o">.</span><span class="n">isNumberType</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="s1">&#39;Only scalars are allowed for such arithmetic operation&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__idiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">operator</span><span class="o">.</span><span class="n">isNumberType</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="s1">&#39;Only scalars are allowed for such arithmetic operation&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">/=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">newxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#       if not isinstance(other, (float, int)):</span>
<span class="c1">#           newxyz = self.copy().consolidate()</span>
<span class="c1">#           if hasattr(other, &#39;_transp&#39;) and not other._transp:</span>
<span class="c1">#               # Handle transparency</span>
<span class="c1">#               newxyz.exclude(other)</span>
<span class="c1">#               newxyz.consolidate()</span>
<span class="c1">#           else: # Simply load with no opacity</span>
<span class="c1">#               other = self._load_(other)</span>
<span class="c1">#       else:</span>
<span class="c1">#           newxyz = self.copy()</span>
        <span class="n">newxyz</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">newxyz</span>
    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">newxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newxyz</span> <span class="o">-=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">newxyz</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">newxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newxyz</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">newxyz</span>
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">newxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newxyz</span> <span class="o">/=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">newxyz</span>

    <span class="k">def</span> <span class="nf">_load_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="c1"># Load for adding</span>
        <span class="c1"># - already a XYZ</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span> <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># - XYZ via .xyz() (like shapes/shorelines or mergers)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">xyz</span>
        <span class="c1"># - load it (from file or array)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Mask (1==good)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
        <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npt</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>

        <span class="c1"># Radius underspampling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rsamp_old&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_old</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span>
            <span class="n">kwrsamp</span><span class="o">=</span><span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;rsamp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="o">=</span> <span class="n">rsamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwrsamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_old</span>

        <span class="c1"># Selections</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">):</span>
            <span class="n">smask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npt</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="n">rectmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npt</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">:</span>

                <span class="c1"># Mask is good only within N/S/W/E limits of the polygon</span>
                <span class="n">rectmask</span><span class="p">[:]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&gt;=</span><span class="n">pl</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&lt;=</span><span class="n">pl</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">&amp;</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&gt;=</span><span class="n">pl</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&lt;=</span><span class="n">pl</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

                <span class="c1"># Mask is good only within the polygon</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">[</span><span class="n">rectmask</span><span class="p">]:</span>
                    <span class="n">smask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Point</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">rectmask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">&amp;=</span> <span class="n">smask</span>
            <span class="k">del</span> <span class="n">smask</span>

        <span class="c1"># Exclusions</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>

            <span class="c1"># Check if inclusions and magnet zone</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">exc</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">magnet</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">incs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">magnet</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># We check only good points within the N/S/W/E limits of the polygon</span>
            <span class="n">good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">&amp;</span> \
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&gt;=</span><span class="n">exc</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&lt;=</span><span class="n">exc</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&gt;=</span><span class="n">exc</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&lt;=</span><span class="n">exc</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

            <span class="c1"># Mask is bad within the polygon</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">[</span><span class="n">good</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">Point</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

                <span class="c1"># Check inclusions and magnet zone</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>

                    <span class="c1"># Inclusions = exclusions of exclusions</span>
                    <span class="k">for</span> <span class="n">inc</span> <span class="ow">in</span> <span class="n">incs</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">out</span><span class="p">:</span> <span class="k">break</span>

                    <span class="c1"># Magnet zone</span>
                    <span class="k">if</span> <span class="n">magnet</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">radius</span><span class="p">,</span> <span class="n">xmgt</span><span class="p">,</span> <span class="n">ymgt</span> <span class="o">=</span> <span class="n">magnet</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xmgt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ymgt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">radius</span>
                        <span class="k">del</span> <span class="n">dst</span>

                <span class="c1"># Apply</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="k">del</span> <span class="n">good</span>
        <span class="k">del</span> <span class="n">ii</span>

        <span class="c1"># Limits</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ymean</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No more points after exclusion&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymean</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Resolution</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xres_mauto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_mauto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xres_dauto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_dauto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xres_mauto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_mauto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xres_dauto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_dauto</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#       del self._m</span>
<span class="c1">#       self._m = None</span>

<div class="viewcode-block" id="XYZ.consolidate"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.consolidate">[docs]</a>    <span class="k">def</span> <span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply radius undersampling and all exclusions and selections to data and reset them&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_rsamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_selections</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_exclusions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="XYZ.mask"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.mask">[docs]</a>    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current mask due to exclusion and selection polygons</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`exclude` :meth:`select`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span></div>

    <span class="k">def</span> <span class="nf">_clip_mask_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">inverse</span><span class="p">):</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">([</span><span class="n">zone</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">good</span> <span class="o">&amp;</span> \
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&gt;=</span><span class="n">zone</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">&lt;=</span><span class="n">zone</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">&amp;</span> \
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&gt;=</span><span class="n">zone</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">&lt;=</span><span class="n">zone</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">good</span><span class="p">):</span>
            <span class="n">good</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ii</span>
        <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">good</span> <span class="o">=</span> <span class="o">~</span><span class="n">good</span>
        <span class="k">return</span> <span class="n">good</span>

<div class="viewcode-block" id="XYZ.clip"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Geographical selection of part of the data</span>

<span class="sd">        - *zone*: (xmin,ymin,xmax,ymax) or a float/int a complex polygon (see :func:`~vacumm.misc.grid.masking.polygons`).</span>
<span class="sd">        - *margin*: Margin around ``zone`` relative to the resolution (see :meth:`resol`)</span>
<span class="sd">        - *inverse*: Inverse the selection.</span>
<span class="sd">        - *mask*: ``zone`` must be interpreted as a mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">zone</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>
            <span class="k">if</span> <span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span>
            <span class="k">if</span> <span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span>
            <span class="k">if</span> <span class="n">zone</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span>
            <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res</span><span class="p">()</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">margin</span><span class="o">*</span><span class="n">xres</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">margin</span><span class="o">*</span><span class="n">xres</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">margin</span><span class="o">*</span><span class="n">yres</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">zone</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">margin</span><span class="o">*</span><span class="n">yres</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_mask_</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">inverse</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1">#       xyz.include(*self._inclusions)</span>
        <span class="n">xyz</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span></div>

<div class="viewcode-block" id="XYZ.zone"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.zone">[docs]</a>    <span class="k">def</span> <span class="nf">zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get xmin,ymin,xmax,ymax</span>

<span class="sd">        - *poly*: if True, return zone as a Polygon instance&quot;&quot;&quot;</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xmin</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ymin</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xmax</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ymax</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">poly</span><span class="p">:</span> <span class="k">return</span> <span class="n">polygons</span><span class="p">([</span><span class="n">zone</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">zone</span></div>

<span class="c1">#   def get_map(self):</span>
<span class="c1">#       &quot;&quot;&quot;Return the map instance or None&quot;&quot;&quot;</span>
<span class="c1">#       return self._m</span>


<div class="viewcode-block" id="XYZ.set_transp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.set_transp">[docs]</a>    <span class="k">def</span> <span class="nf">set_transp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`transp`</span>

<span class="sd">        .. note::</span>

<span class="sd">            Useful only for mixing :class:`~vacumm.misc.io.XYZ` instances&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transp</span> <span class="o">=</span> <span class="n">transp</span></div>
<div class="viewcode-block" id="XYZ.get_transp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_transp">[docs]</a>    <span class="k">def</span> <span class="nf">get_transp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get :attr:`transp`</span>

<span class="sd">        .. note::</span>

<span class="sd">            Useful only for mixing :class:`~vacumm.misc.io.XYZ` instances&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transp</span></div>
    <span class="n">transp</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_transp</span><span class="p">,</span> <span class="n">set_transp</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Transparency boolean attribute&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.set_magnet"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.set_magnet">[docs]</a>    <span class="k">def</span> <span class="nf">set_magnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magnet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the magnet integer attribute.</span>
<span class="sd">        If set to ``0``, no magnet effect.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Useful only for mixing :class:`~vacumm.misc.io.XYZ` instances&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">magnet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">magnet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_magnet</span> <span class="o">=</span> <span class="n">magnet</span></div>
<div class="viewcode-block" id="XYZ.get_magnet"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_magnet">[docs]</a>    <span class="k">def</span> <span class="nf">get_magnet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the magnet integer attribute</span>

<span class="sd">        .. note::</span>

<span class="sd">            Useful only for mixing :class:`~vacumm.misc.io.XYZ` instances&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magnet</span></div>
    <span class="n">magnet</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_magnet</span><span class="p">,</span> <span class="n">set_magnet</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Magnet integer attribute&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.set_rsamp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.set_rsamp">[docs]</a>    <span class="k">def</span> <span class="nf">set_rsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the radius sampling :attr:`rsamp`</span>
<span class="sd">        If set to ``0``, no sampling.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rsamp</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">rsamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">=</span> <span class="n">rsamp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rsamp_old&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rsamp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span></div>
<div class="viewcode-block" id="XYZ.get_rsamp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_rsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_rsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the radius sampling :attr:`rsamp`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span></div>
<div class="viewcode-block" id="XYZ.reset_rsamp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.reset_rsamp">[docs]</a>    <span class="k">def</span> <span class="nf">reset_rsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset :attr:`rsamp` without affecting data &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rsamp_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsamp_mask</span> <span class="o">=</span> <span class="kc">None</span></div>
    <span class="n">del_rsamp</span> <span class="o">=</span> <span class="n">reset_rsamp</span>
    <span class="n">rsmap</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_rsamp</span><span class="p">,</span> <span class="n">set_rsamp</span><span class="p">,</span> <span class="n">del_rsamp</span><span class="p">,</span> <span class="s2">&quot;Radius of unsersampling&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.tocfg"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.tocfg">[docs]</a>    <span class="k">def</span> <span class="nf">tocfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump one or all parameters as options to a cfg section</span>

<span class="sd">        - **cfg**: ConfigParser object</span>
<span class="sd">        - **section**: Section of cfg</span>
<span class="sd">        - *param*: A single or a list of parameter names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List of params</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">,</span> <span class="s1">&#39;xmax&#39;</span><span class="p">,</span> <span class="s1">&#39;ymin&#39;</span><span class="p">,</span> <span class="s1">&#39;ymax&#39;</span><span class="p">,</span><span class="s1">&#39;zmin&#39;</span><span class="p">,</span><span class="s1">&#39;zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;transp&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;xres&#39;</span><span class="p">,</span><span class="s1">&#39;yres&#39;</span><span class="p">,</span><span class="s1">&#39;exclusions&#39;</span><span class="p">,</span> <span class="s1">&#39;selections&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">allowed</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span><span class="p">]</span>
        <span class="c1"># Get string</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">):</span>
             <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">param</span><span class="o">+</span><span class="s1">&#39;_mauto&#39;</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;sions&#39;</span><span class="p">):</span>
             <span class="c1"># selections, exclusions</span>
             <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
             <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">param</span><span class="p">):</span>
                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="c1"># exclusions and inclusions</span>
                    <span class="n">exc</span><span class="p">,</span> <span class="n">incs</span> <span class="o">=</span> <span class="n">var</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                       <span class="c1"># no inclusions</span>
                       <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                       <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
                       <span class="k">for</span> <span class="n">inc</span> <span class="ow">in</span> <span class="n">incs</span><span class="p">:</span>
                          <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inc</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                          <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exc</span><span class="p">,</span> <span class="n">polys</span><span class="p">))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="c1"># normal case</span>
                     <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
          <span class="k">elif</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">]:</span>
              <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">param</span><span class="p">)</span>
          <span class="c1"># Check section</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
              <span class="n">cfg</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
          <span class="c1"># Dump</span>
          <span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span></div>


<div class="viewcode-block" id="XYZ.get_xmin"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_xmin">[docs]</a>    <span class="k">def</span> <span class="nf">get_xmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span></div>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xmin</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;X min&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_xmax"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_xmax">[docs]</a>    <span class="k">def</span> <span class="nf">get_xmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xmax</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;X max&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_ymin"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_ymin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ymin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span></div>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_ymin</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Y min&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_ymax"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_ymax">[docs]</a>    <span class="k">def</span> <span class="nf">get_ymax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_ymax</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Y max&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_zmin"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_zmin">[docs]</a>    <span class="k">def</span> <span class="nf">get_zmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span></div>
    <span class="n">zmin</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_zmin</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Z min&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_zmax"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_zmax">[docs]</a>    <span class="k">def</span> <span class="nf">get_zmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>
    <span class="n">zmax</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_zmax</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Z max&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.exclude"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.exclude">[docs]</a>    <span class="k">def</span> <span class="nf">exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">zones</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one or more zones where data are not used.</span>

<span class="sd">        A zone can be :</span>

<span class="sd">        - an argument to :func:`~vacumm.misc.grid.masking.polygons` to get a :class:`_geoslib.Polygon` instance,</span>
<span class="sd">        - another :class:XYZ` instance from which the convex hull (see :meth:`hull`) is used as a delimiting area</span>

<span class="sd">        :Usage:</span>

<span class="sd">        &gt;&gt;&gt; xyz.exclude([[-8,43],[-5.5,43],[-6,45.]],[[-10,45],[-7,47],[-10,49.]])</span>
<span class="sd">        &gt;&gt;&gt; xyz.exclude(polygon1,polygon2)</span>
<span class="sd">        &gt;&gt;&gt; xyz.exclude(xyz1,[-5,42,-3,48.])</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`select` :meth:`exclusions`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zones</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">XYZ</span><span class="p">):</span>
                <span class="n">zone</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">shadows</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># inclusions</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">([</span><span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">zone</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zone</span> <span class="o">=</span> <span class="n">exc</span><span class="p">,</span> <span class="n">polygons</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zone</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">([</span><span class="n">zone</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span></div>
<div class="viewcode-block" id="XYZ.select"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">zones</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one or more zone (polygons) where only these data are used</span>

<span class="sd">        A zone is an argument to :func:`~vacumm.misc.grid.masking.polygons` to get a :class:`_geoslib.Polygon` instance.</span>

<span class="sd">        :Usage:</span>

<span class="sd">        &gt;&gt;&gt; xyz.select([[-8,43],[-5.5,43],[-6,45.]],[[-10,45],[-7,47],[-10,49.]])</span>
<span class="sd">        &gt;&gt;&gt; xyz.select(polygon1,polygon2)</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`exclude`  :meth:`selections`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">polygons</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">zones</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span></div>
<div class="viewcode-block" id="XYZ.reset_selections"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.reset_selections">[docs]</a>    <span class="k">def</span> <span class="nf">reset_selections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all selections&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span></div>
<div class="viewcode-block" id="XYZ.reset_exclusions"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.reset_exclusions">[docs]</a>    <span class="k">def</span> <span class="nf">reset_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all exclusions&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_</span><span class="p">()</span></div>
<div class="viewcode-block" id="XYZ.selections"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.selections">[docs]</a>    <span class="k">def</span> <span class="nf">selections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all selection polygons as a tuple&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span></div>
<div class="viewcode-block" id="XYZ.exclusions"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.exclusions">[docs]</a>    <span class="k">def</span> <span class="nf">exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all exclusion polygons as a tuple&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span></div>


    <span class="k">def</span> <span class="nf">_filter_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - var can be a list</span>
<span class="sd">        - mask can be</span>
<span class="sd">            - &#39;valid&#39;, True</span>
<span class="sd">            - False, None</span>
<span class="sd">            - &#39;revert&#39;, &#39;masked&#39;</span>
<span class="sd">            - mask array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rever&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;inver&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">]</span>
<span class="c1">#       if isinstance(var, list):</span>
<span class="c1">#           return [var[i] for i, m in enumerate(self._mask) if m]</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_x"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_x">[docs]</a>    <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get valid X positions&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_x</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Valid X positions&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_y"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_y">[docs]</a>    <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get valid Y positions&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_y</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Valid Y positions&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_z"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_z">[docs]</a>    <span class="k">def</span> <span class="nf">get_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get valid Z values&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_z</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Valid Z values&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_xy"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_xy">[docs]</a>    <span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return coordinates as a (2, npts) array :attr:`xy`</span>

<span class="sd">        - ``xy()[0]``: X</span>
<span class="sd">        - ``xy()[1]``: Y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">)])</span></div>
    <span class="n">xy</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xy</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Coordinates as a (2, npts) array&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="XYZ.get_xyz"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return coordinates and data as a (3, npts) array :attr:`xyz`</span>

<span class="sd">        - ``xy()[0]``: X</span>
<span class="sd">        - ``xy()[1]``: Y</span>
<span class="sd">        - ``xy()[2]``: Z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">mask</span><span class="p">)])</span></div>
    <span class="n">xyz</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xyz</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Coordinates and data as a (3, npts) array&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.astuple"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.astuple">[docs]</a>    <span class="k">def</span> <span class="nf">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shortcut to ``xyz(split=True)`` (see :meth:`xyz`)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.interp"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.interp">[docs]</a>    <span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyo</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate to (xo,yo) positions using :class:`nat.Natgrid`</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **xo**: Output X</span>
<span class="sd">            - **yo**: Output Y</span>
<span class="sd">            - *xyz*: If True, return a :class:`XYZ` instance instead of a :mod:`numpy` array</span>
<span class="sd">            - **interp_&lt;param&gt;**, optional: ``&lt;param&gt;`` is passed to the</span>
<span class="sd">              :func:`~vacumm.misc.grid.regridding.xy2xy` interpolation routine.</span>
<span class="sd">            - Other params are passed to XYZ initialization for the output dataset.</span>

<span class="sd">        :Returns: An XYZ instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: Natgrid still required by this module ??</span>
        <span class="c1"># from nat import Natgrid</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyo</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="n">xyo</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyo</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
            <span class="n">xo</span> <span class="o">=</span> <span class="n">xyo</span><span class="o">.</span><span class="n">x</span>
            <span class="n">yo</span> <span class="o">=</span> <span class="n">xyo</span><span class="o">.</span><span class="n">y</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyo</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">):</span>
            <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="n">xyo</span><span class="o">.</span><span class="n">xy</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyo</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
            <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">xyo</span><span class="o">.</span><span class="n">xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Wrong input type&#39;</span>
        <span class="n">kwinterp</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;interp_&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">grid.regridding</span> <span class="k">import</span> <span class="n">xy2xy</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">xy2xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwinterp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xyz</span><span class="p">:</span> <span class="k">return</span> <span class="n">zo</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">((</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="XYZ.hull"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.hull">[docs]</a>    <span class="k">def</span> <span class="nf">hull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the convex hull</span>

<span class="sd">        :Returns: Depends on ``out``</span>

<span class="sd">        - ``&quot;xy&quot;``: (xhull, yhull)</span>
<span class="sd">        - ``&quot;ind&quot;``: indices of points</span>
<span class="sd">        - ``&quot;poly&quot;``: :class:`_geoslib.Polygon` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">convex_hull</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">)),</span> <span class="n">poly</span><span class="o">=</span><span class="n">out</span><span class="o">==</span><span class="s1">&#39;poly&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="XYZ.shadows"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.shadows">[docs]</a>    <span class="k">def</span> <span class="nf">shadows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the polygons defining the &#39;shadow&#39; of this dataset.</span>

<span class="sd">        It consists of a tuple of two elements:</span>

<span class="sd">            - the convex hull as a polygon,</span>
<span class="sd">            - a list of exclusion polygons that intersect the convex hull.</span>

<span class="sd">        Therefore, a point in the shadow must be inside the convex hull polygon,</span>
<span class="sd">        and outside the exclusion polygons.</span>

<span class="sd">        :Returns: (hull_poly, [exclusion_poly1,...])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hull_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">)</span>
        <span class="n">exc_polys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">hull_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                <span class="n">exc_polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="c1">#FIXME: inclusions</span>
        <span class="n">magnet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_magnet</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_magnet</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">get_magnet</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xres</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yres</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_magnet</span><span class="p">()</span>
            <span class="n">magnet</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="k">return</span> <span class="n">hull_poly</span><span class="p">,</span> <span class="n">exc_polys</span><span class="p">,</span> <span class="n">magnet</span></div>


<div class="viewcode-block" id="XYZ.contains"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.contains">[docs]</a>    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if one or several points are within a the convex hull</span>

<span class="sd">        - **x,y**: X,Y positions as floats or lists or an :mod:`numpy` arrays.</span>

<span class="sd">        .. seealso:</span>

<span class="sd">            :meth:`hull`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">)</span> <span class="o">&amp;</span> \
                  <span class="p">(</span><span class="n">y</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
            <span class="n">xg</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">good</span><span class="p">)</span>
            <span class="n">yg</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">good</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">)</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">hull</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="k">return</span> <span class="n">out</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">hull</span><span class="p">)</span></div>


<div class="viewcode-block" id="XYZ.resol"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.resol">[docs]</a>    <span class="k">def</span> <span class="nf">resol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convex_hull_method</span><span class="o">=</span><span class="s1">&#39;delaunay&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="p">[],</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the mean resolution.</span>

<span class="sd">        Algorithm: Median distances between facets of triangles</span>

<span class="sd">        :Returns: (xres,yres)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Coordinates</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deg</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proj_</span><span class="p">(</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1">#       if method.startswith(&#39;tri&#39;): # Using the median length of triangles</span>
        <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">Delaunay</span>

        <span class="n">coord</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">t</span><span class="o">=</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
           <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">p2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">p2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
           <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">p3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">p3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
           <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">p3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">p3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">xres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">t</span><span class="p">,</span> <span class="n">distances</span>

<span class="c1">#       else: # Using the convex hull</span>
<span class="c1">#</span>
<span class="c1">#           # Convex hull polygon</span>
<span class="c1">#           hull = convex_hull((x, y), poly=True, method=convex_hull_method)</span>
<span class="c1">#</span>
<span class="c1">#           # Area</span>
<span class="c1">#           # - max = convex hull</span>
<span class="c1">#           area = hull.area()</span>
<span class="c1">#           # - substract intersections with exclusions</span>
<span class="c1">#           #FIXME: xyz.resol: non overlapping exclusions+inclusions</span>
<span class="c1">#           for e in exc+self.exclusions():</span>
<span class="c1">#               if isinstance(e, tuple):</span>
<span class="c1">#                   e, incs = e</span>
<span class="c1">#               else:</span>
<span class="c1">#                   incs = []</span>
<span class="c1">#               if hull.intersects(e):</span>
<span class="c1">#                   for i in hull.intersection(e):</span>
<span class="c1">#                       area -= i.area()</span>
<span class="c1">#</span>
<span class="c1">#           # Area and mean resolution</span>
<span class="c1">#           xres = yres = N.sqrt(area/len(x))</span>

        <span class="k">return</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span></div>

<div class="viewcode-block" id="XYZ.set_res"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.set_res">[docs]</a>    <span class="k">def</span> <span class="nf">set_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the resolution of the dataset</span>

<span class="sd">        If ``yres`` is not, it is set to ``xres``.</span>
<span class="sd">        When a value is **negative**, it is supposed to be in **meters** (not in degrees)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">xres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xres_man</span> <span class="o">=</span> <span class="n">xres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yres_man</span> <span class="o">=</span> <span class="n">yres</span></div>

<div class="viewcode-block" id="XYZ.get_res"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_res">[docs]</a>    <span class="k">def</span> <span class="nf">get_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the mean X and Y resolutions in meters or degrees&quot;&quot;&quot;</span>
        <span class="c1"># Get manual or auto resolutions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xres_man</span> <span class="ow">and</span> <span class="n">auto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xres_man</span>
        <span class="k">elif</span> <span class="n">deg</span><span class="p">:</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xres_dauto</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xres_mauto</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_man</span> <span class="ow">and</span> <span class="n">auto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_man</span>
        <span class="k">elif</span> <span class="n">deg</span><span class="p">:</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_dauto</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yres_mauto</span>
        <span class="c1"># Conversions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_res_</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_res_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">degres</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">degres</span><span class="p">:</span> <span class="c1"># need degrees</span>
            <span class="k">if</span> <span class="n">xres</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="o">-</span><span class="n">m2deg</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yres</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="o">-</span><span class="n">m2deg</span><span class="p">(</span><span class="n">yres</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># need meters</span>
            <span class="k">if</span> <span class="n">xres</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">deg2m</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ymean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yres</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">deg2m</span><span class="p">(</span><span class="n">yres</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span>


    <span class="k">def</span> <span class="nf">_proj_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a proper projection or None&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">proj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proj</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">vacumm.misc.grid.basemap</span> <span class="k">import</span> <span class="n">get_proj</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">proj</span>

<div class="viewcode-block" id="XYZ.get_grid"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.get_grid">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relres</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">degres</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;xyz_grid&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a rectangular grid based on x/y positions and resolution</span>

<span class="sd">        - *res*: Resolution. It can be:</span>

<span class="sd">                - a float where then ``xres=yres=res``</span>
<span class="sd">                - a tuple as ``(xres,yres)``</span>
<span class="sd">                - else it is guessed using :meth:`get_res` (and maybe :meth:`resol`)` and multiplied by ``relres``</span>

<span class="sd">        - *relres*: Relative resolution factor applied to ``res`` when resolution is guessed (``res=None``)</span>
<span class="sd">        - *degres*: When ``res`` is explicitly given, it interpreted as degrees is ``degres`` is True.</span>
<span class="sd">        - *xmin,xmax,ymin,ymax*: Bounds of the grid. If not specified, bounds of the dataset are used (see :meth:`xmin`, etc).</span>

<span class="sd">        .. note::</span>

<span class="sd">            Resolutions are adjusted when they are not mutiple of grid extensions (slightly decreased).</span>
<span class="sd">            Therefore, extensions of the grid are always preserved.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`resol`, :meth:`togrid`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Resolution</span>
<span class="c1">#       proj = self._proj_(proj)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Auto</span>
            <span class="c1"># Meters</span>
<span class="c1">#           dx, dy = tuple([r*relres for r in self.get_res(deg=False, auto=True)])</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">r</span><span class="o">*</span><span class="n">relres</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
<span class="c1">#           # To degrees</span>
<span class="c1">#           dx, dy = self._get_res_(-dx, -dy, True)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Manual</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Same for X and Y</span>
                <span class="n">xres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">degres</span><span class="p">:</span> <span class="c1"># Given in meters</span>
                <span class="n">xres</span> <span class="o">=</span> <span class="o">-</span><span class="n">xres</span>
                <span class="n">yres</span> <span class="o">=</span> <span class="o">-</span><span class="n">yres</span>
            <span class="c1"># Now in degrees</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_res_</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Bounds</span>
        <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>
        <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span>
        <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span>
        <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span>

        <span class="c1"># Rectifications</span>
        <span class="n">xratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
        <span class="n">yratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span>
        <span class="n">dx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="n">xratio</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">xratio</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="p">(</span><span class="n">yratio</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">yratio</span><span class="p">)</span>

        <span class="c1"># Grid</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">+</span><span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">+</span><span class="n">dy</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="k">return</span> <span class="n">grid</span></div>
    <span class="n">grid</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_grid</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Rectangular grid based on x/y positions and resolution&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.togrid"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.togrid">[docs]</a>    <span class="k">def</span> <span class="nf">togrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate to a regular grid</span>

<span class="sd">        - **grid**: The output grid. It can be either:</span>

<span class="sd">            - a (x,y) tuple or a grid or a :mod:`MV2` variable with a grid,</span>
<span class="sd">            - ``None``, thus guessed using :meth:`grid`</span>

<span class="sd">        - *mask*: It can be either:</span>

<span class="sd">            - ``None``, ``False`` or ``MV2.nomask``: no masking</span>
<span class="sd">            - an array: this mask array is directly applied</span>
<span class="sd">            - a :class:`Shapes` instance (or :class:`~vacumm.bathy.shorelines.ShoreLine`) or a single char GSHHS resolution (and optionally &#39;s&#39; for Histolitt)</span>
<span class="sd">            - a callable fonction so that ``mask = thisfunc(mask, **kwmask)``</span>
<span class="sd">            - a float: data with this value are masked</span>

<span class="sd">        - *mask_&lt;param&gt;*: &lt;param&gt; is passed to :func:`~vacumm.misc.grid.masking.polygon_mask` for evaluation of mask thanks to the polygons.</span>
<span class="sd">        - *grid_&lt;param&gt;*: &lt;param&gt; is passed to :func:`grid`.</span>
<span class="sd">        - *cgrid*: If ``True``, returns bathy at U- and V-points, else at T-points</span>
<span class="sd">        - Other keyparam are passed to :func:`~vacumm.misc.grid.regridding.griddata` for regridding.</span>

<span class="sd">        Return: ``(Zx,Zy)`` OR ``Z`` depending on cgrid.</span>

<span class="sd">        .. seealso:</span>

<span class="sd">            :func:`~vacumm.misc.grid.masking.polygon_mask` :class:`~vacumm.misc.grid.basemap.GSHHS_BM`</span>
<span class="sd">            :class:`Shapes`  :class:`~vacumm.bathy.shorelines.ShoreLine`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Grid</span>
        <span class="n">kwgrid</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;grid_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="o">**</span><span class="n">kwgrid</span><span class="p">)</span>

        <span class="c1"># Interpolation</span>
        <span class="n">kwmask</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;mask_&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cgrid</span><span class="o">=</span><span class="n">cgrid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cgrid</span><span class="p">:</span> <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span>

        <span class="c1"># Mask from polygons</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">Shapes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>

            <span class="c1"># Clip for polygons</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">kwmask</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">*</span><span class="n">clip</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">*</span><span class="n">clip</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="n">ymin</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="n">xmax</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">ymax</span><span class="o">+</span><span class="n">dy</span><span class="p">]</span>

            <span class="c1"># Get polygons</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">Shapes</span><span class="p">):</span> <span class="c1"># Direct</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># GSHHS</span>
                <span class="kn">from</span> <span class="nn">grid.basemap</span> <span class="k">import</span> <span class="n">GSHHS_BM</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="n">GSHHS_BM</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>

            <span class="c1"># Create mask</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">polygon_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">shapes</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwmask</span><span class="p">)</span>

        <span class="c1"># Masking</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MV2</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">):</span> <span class="c1"># array</span>
                    <span class="n">vv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span> <span class="c1"># function</span>
                    <span class="n">vv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwmask</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># value</span>
                    <span class="n">vv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Attributes</span>
        <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vv</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vv</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span>
        <span class="k">if</span> <span class="n">cgrid</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="XYZ.toxy"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.toxy">[docs]</a>    <span class="k">def</span> <span class="nf">toxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outtype</span><span class="o">=</span><span class="s1">&#39;tuple&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate on random points using :func:`~vacumm.misc.grid.regridding.xy2xy`</span>

<span class="sd">        - **xo,yo**: Output positions</span>
<span class="sd">        - *mask*: It can be either:</span>

<span class="sd">            - ``None``, ``False`` or ``MV2.nomask``: no masking</span>
<span class="sd">            - a :class:`Shapes` instance (or :class:`~vacumm.bathy.shorelines.ShoreLine`) or a single char GSHHS resolution (and optionally &#39;s&#39; for Histolitt)</span>
<span class="sd">        - *outtype*: Define output type</span>

<span class="sd">            - ``&quot;tuple&quot;``: as a tuple (x, y, z)</span>
<span class="sd">            - ``&quot;xyz&quot;``: as xyz block</span>
<span class="sd">            - ``&quot;XYZ&quot;``: as an :class:`XYZ` (or subclass) instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Interpolate</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">xy2xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="c1"># Mask from polygons</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">Shapes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>

            <span class="c1"># Clip for polygons</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">kwmask</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">xo</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="n">clip</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">yo</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="n">clip</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="p">[</span><span class="n">xo</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="n">yo</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="n">xo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">yo</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dy</span><span class="p">]</span>

            <span class="c1"># Get polygons</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">Shapes</span><span class="p">):</span> <span class="c1"># Direct</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># GSHHS</span>
                <span class="kn">from</span> <span class="nn">grid.basemap</span> <span class="k">import</span> <span class="n">GSHHS_BM</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="n">GSHHS_BM</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>

            <span class="c1"># Maskit</span>
            <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span> <span class="o">=</span> <span class="n">polygon_select</span><span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">shapes</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(),</span> <span class="n">zz</span><span class="o">=</span><span class="n">zo</span><span class="p">)</span>

        <span class="c1"># Out</span>
        <span class="k">if</span> <span class="n">outype</span><span class="o">==</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">outtype</span><span class="o">==</span><span class="s1">&#39;XYZ&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">((</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">outtype</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">outtype</span><span class="p">([</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">zo</span></div>



<div class="viewcode-block" id="XYZ.plot"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">masked_alpha</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">masked_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">savefigs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">masked_zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scatter plot of bathymetry points</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **mode**, optional: &#39;valid&#39;, &#39;masked&#39; or &#39;both&#39;.</span>
<span class="sd">            - **size**, optional: Size of markers.</span>
<span class="sd">            - **color**, optional: Color of markers.</span>
<span class="sd">            - **alpha**, optional: Alpha transparency of markers.</span>
<span class="sd">            - **zorder**, optional: zorder of markers.</span>
<span class="sd">            - **m**, optional: Use this :class:`~mpl_toolkits.basemap.Basemap` instance</span>
<span class="sd">              to plot the points.</span>
<span class="sd">            - **masked_size**, optional: Size of masked markers.</span>
<span class="sd">            - **masked_alpha**, optional: Alpha transparency of masked markers.</span>
<span class="sd">            - **masked_zorder**, optional: zorder of masked markers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Params</span>
        <span class="n">kwm</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span>
        <span class="n">kwhull</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;hull&#39;</span><span class="p">)</span>
        <span class="n">kwcb</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;colorbar&#39;</span><span class="p">)</span>
        <span class="n">kwplot</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">kwplot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Limits</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span>
            <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xxres</span><span class="p">,</span> <span class="n">yyres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">xxres</span>
            <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">yyres</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">-=</span> <span class="n">margin</span><span class="o">*</span><span class="n">xres</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmax</span> <span class="o">+=</span> <span class="n">margin</span><span class="o">*</span><span class="n">xres</span>
            <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">-=</span> <span class="n">margin</span><span class="o">*</span><span class="n">yres</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">+=</span> <span class="n">margin</span><span class="o">*</span><span class="n">yres</span>

        <span class="c1"># Map</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">kwm</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
            <span class="n">kwm</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
            <span class="n">kwm</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;merc&#39;</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">map</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="n">G</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">P</span>

        <span class="c1"># Max values</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kwplot</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">):</span> <span class="n">kwplot</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zmin</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kwplot</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;vmax&#39;</span><span class="p">):</span> <span class="n">kwplot</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zmax</span>

        <span class="c1"># Valid points</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;masked&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="c1"># Points</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_</span><span class="p">(</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwplot</span><span class="p">)</span>
<span class="c1">#           # Convex hull</span>
<span class="c1">#           if hull:</span>
<span class="c1">#               xhull, yhull = self.hull(out=&#39;xy&#39;)</span>
<span class="c1">#               if callable(m):</span>
<span class="c1">#                   xhull, yhull = m(xhull, yhull)</span>
<span class="c1">#               xhull = xhull.tolist()+[xhull[0]]</span>
<span class="c1">#               yhull = yhull.tolist()+[yhull[0]]</span>
<span class="c1">#               kwhull.setdefault(&#39;alpha&#39;, masked_alpha)</span>
<span class="c1">#               kwhull.setdefault(&#39;zorder&#39;, zorder)</span>
<span class="c1">#               if color is None:</span>
<span class="c1">#                   hullcolor = &#39;#888888&#39;</span>
<span class="c1">#               else:</span>
<span class="c1">#                   hullcolor = color</span>
<span class="c1">#               kwhull.setdefault(&#39;color&#39;, hullcolor)</span>
<span class="c1">#               G.plot(xhull, yhull, &#39;-&#39;, **kwhull)</span>
        <span class="c1"># Masked points</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;masked&#39;</span><span class="p">:</span>
                <span class="n">masked_alpha</span> <span class="o">=</span> <span class="n">alpha</span>
                <span class="n">masked_size</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">masked_zorder</span> <span class="o">=</span> <span class="n">zorder</span>
            <span class="k">elif</span> <span class="n">masked_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">masked_size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_</span><span class="p">(</span><span class="s1">&#39;masked&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">masked_size</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">masked_alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">masked_zorder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwplot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Limits</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">set_axes_limits</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>

        <span class="c1"># Decorations</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">title</span>
            <span class="n">P</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="c1">#           for pt in pts:</span>
<span class="c1">#               if pt is not None:</span>
<span class="c1">#                   pt.set_label(title)</span>
<span class="c1">#                   break</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="n">_colorbar_</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwcb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">savefigs</span><span class="p">:</span>
            <span class="n">Savefigs</span><span class="p">(</span><span class="n">savefigs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pts</span></div>

    <span class="k">def</span> <span class="nf">_plot_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic plot&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>  <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>
        <span class="k">return</span>  <span class="n">G</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="XYZ.save"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZ.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyzfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save to a file</span>

<span class="sd">        - **xyzfile**: Output file name</span>

<span class="sd">            - write a netcdf file if it ends with &quot;.nc&quot; or &quot;.grd&quot;</span>
<span class="sd">            - write a sinux file if it ends with &quot;.snx&quot;</span>
<span class="sd">            - else write an ascii file with 3 columns</span>

<span class="sd">        - Other keywords are passed to :func:`numpy.savetxt` for ascii saving</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xyzfile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyzfile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.grd&#39;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span>
                <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">xyzfile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.snx&#39;</span><span class="p">):</span>
            <span class="n">write_snx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="XYZMerger"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger">[docs]</a><span class="k">class</span> <span class="nc">XYZMerger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mix different bathymetries&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_XYZ</span> <span class="o">=</span> <span class="n">XYZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Merger:&#39;</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> no datasets in the merger&#39;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> extension: xmin=</span><span class="si">%g</span><span class="s1"> xmax=</span><span class="si">%g</span><span class="s1"> ymin=</span><span class="si">%g</span><span class="s1"> ymax=</span><span class="si">%g</span><span class="s1"> zmin=</span><span class="si">%g</span><span class="s1"> zmax=</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span>\
            <span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">zmin</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">zmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> there is 1 dataset in the merger:&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> there are </span><span class="si">%i</span><span class="s1"> datasets in the merger:&#39;</span><span class="o">%</span><span class="n">n</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">3</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">sep</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">sep</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="c1">#   def __copy__(self):</span>
<span class="c1">#       return self.__class__(xmin=self._xmin, xmax=self._xmax, ymin=self._ymin, ymax=self._ymax, *self._datasets)</span>
<div class="viewcode-block" id="XYZMerger.copy"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span></div>
<span class="c1">#       return self.__copy__()</span>

    <span class="k">def</span> <span class="nf">_load_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="c1"># XYZMerger instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
        <span class="c1"># xyzmerger._load_: pas clair</span>
<span class="c1">#           if d is self: return</span>
<span class="c1">#           return d.copy()</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_XYZ</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">_datasets</span><span class="p">]</span>
        <span class="c1"># XYZ instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XYZ</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># Get XYZ from b</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">xyz</span>
        <span class="c1"># New XYZ instance</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XYZ</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<div class="viewcode-block" id="XYZMerger.tolist"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.tolist">[docs]</a>    <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the merger as a list of datasets&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span></div>

<div class="viewcode-block" id="XYZMerger.ids"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.ids">[docs]</a>    <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">]</span></div>

<div class="viewcode-block" id="XYZMerger.append"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a dataset to the merger&quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">+=</span> <span class="n">d</span></div>
<div class="viewcode-block" id="XYZMerger.remove"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a dataset from the merger&quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">-=</span> <span class="n">d</span></div>
<div class="viewcode-block" id="XYZMerger.clean"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all current dataset&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">datasets</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Dataset not in merger&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_key_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

<div class="viewcode-block" id="XYZMerger.get_xyz"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.get_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge current dataset&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;You must add at least one dataset to the merger&#39;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XYZ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">reset_exclusions</span><span class="p">()</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">reset_selections</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">reset_exclusions</span><span class="p">()</span>
                <span class="n">d</span><span class="o">.</span><span class="n">reset_selections</span><span class="p">()</span>
            <span class="n">xyz</span> <span class="o">+=</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">xyz</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span>
        <span class="n">xyz</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="k">return</span> <span class="n">xyz</span></div>
    <span class="n">xyz</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_xyz</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Coordinates and data as a (3, npts) array&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="XYZMerger.merge"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shortcut to :meth:`xyz`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="XYZMerger.togrid"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.togrid">[docs]</a>    <span class="k">def</span> <span class="nf">togrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate merged bathymetries to a grid&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">togrid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="XYZMerger.plot"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.XYZMerger.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;XYZ merger&#39;</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefigs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">xres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        - *alpha*: Alpha transparency:</span>

<span class="sd">            - applied to **all** points if ``mode=&quot;cluster&quot;``</span>
<span class="sd">            - applied to **hidden** points if ``mode=&quot;data&quot;``</span>

<span class="sd">        - *mode*: Display mode:</span>

<span class="sd">            - ``&quot;cluster&quot;``: Points from different datasets have different colors and markers,</span>
<span class="sd">                and hidden points are transparent.</span>
<span class="sd">            - ``&quot;data&quot;``: Points have the same marker, colors depends on Z value and hidden</span>
<span class="sd">                points are masked.</span>

<span class="sd">        - *marker*: Define a single or several markers to be used.</span>
<span class="sd">        - *legend*: Show a legend if ``mode=&quot;cluster&quot;``.</span>
<span class="sd">        - *title*: Title of the plot.</span>
<span class="sd">        - *m*: :class:`~mpl_toolkits.basemap.Basemap` instance.</span>
<span class="sd">        - *m_margin*: Margin for ``m``, relative to the mean resolution (see :meth:`XYZ.resol`)</span>
<span class="sd">        - *m_&lt;keywords&gt;*: Keywords are passed to :func:`~vacumm.misc.plot.map`.</span>
<span class="sd">        - Extra keywords are passed to :meth:`XYZ.plot`.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Limits</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span> <span class="ow">or</span> <span class="n">margin</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">get_xmin</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">get_xmax</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ymin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">get_ymin</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">get_ymax</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">]:</span>
            <span class="n">xxres</span><span class="p">,</span> <span class="n">yyres</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">xxres</span>
            <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">yyres</span>

        <span class="c1"># Arguments to plots</span>
        <span class="n">kwleg</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;legend&#39;</span><span class="p">)</span>
        <span class="n">kwsf</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;savefig&#39;</span><span class="p">)</span>
        <span class="n">kwsfs</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;savefigs&#39;</span><span class="p">)</span>
        <span class="n">kwplot</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">xres</span><span class="o">=</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="n">yres</span><span class="p">)</span>
        <span class="n">kwplot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Select mode</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;cluster&#39;</span><span class="p">:</span>

            <span class="c1"># Colors and symbols</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">simple_colors</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">Markers</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

            <span class="c1"># Copy all datasets</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">]</span>

            <span class="c1"># Loop on datasets</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">kwplot</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>

                <span class="c1"># Plot current dataset</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">masked_zorder</span><span class="o">=</span><span class="mi">50</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="o">**</span><span class="n">kwplot</span><span class="p">))</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_m</span>

                <span class="c1"># Mask next datasets with current one if not transparent</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_transp</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">datasets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Legend</span>
            <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="p">()</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="p">()</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">datasets</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">hh</span> <span class="o">+=</span> <span class="n">p</span><span class="p">,</span>
                        <span class="n">ll</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
                <span class="n">legend_alpha</span> <span class="o">=</span> <span class="n">kwleg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">kwleg</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">)</span>
                <span class="n">kwleg</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;shadow&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">leg</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">hh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="o">**</span><span class="n">kwleg</span><span class="p">)</span>
                <span class="n">leg</span><span class="o">.</span><span class="n">legendPatch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">legend_alpha</span><span class="p">)</span>
                <span class="n">leg</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Physical case</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwplot</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
                <span class="n">_colorbar_</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Plot attributes</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">,</span> <span class="o">**</span><span class="n">kwsf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savefigs</span><span class="p">:</span>
            <span class="n">Savefigs</span><span class="p">(</span><span class="n">savefigs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwsfs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pp</span></div></div>



<div class="viewcode-block" id="write_snx"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.write_snx">[docs]</a><span class="k">def</span> <span class="nf">write_snx</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">snxfile</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">xfmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">yfmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">zfmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write points, lines or polygons in a sinusX file&quot;&quot;&quot;</span>
    <span class="c1"># Check depth</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="p">(</span><span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">)):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">objects</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Point</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">objects</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span><span class="s1">&#39;auto&#39;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Point</span><span class="p">):</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span>

    <span class="c1"># File</span>
    <span class="n">splitfile</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snxfile</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">snxfile</span>
    <span class="k">elif</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snxfile</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">snxfile</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">splitfile</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">snxfile</span> <span class="o">=</span> <span class="n">snxfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%i</span><span class="s1">i&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))))</span>

    <span class="c1"># Loop on objects</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>

        <span class="c1"># Extract object</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">LineString</span><span class="p">):</span>
            <span class="n">oo</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;linestring&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
            <span class="n">oo</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;polygon&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Point</span><span class="p">):</span>
            <span class="n">ooo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">oo</span><span class="p">:</span>
                <span class="n">ooo</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">get_coords</span><span class="p">())</span>
            <span class="n">oo</span> <span class="o">=</span> <span class="n">ooo</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span>

        <span class="c1"># Guess type</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">n</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">n</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;polygon&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;linestring&#39;</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span>

        <span class="c1"># Write</span>
        <span class="c1"># - splited file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snxfile</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;%&#39;</span> <span class="ow">in</span> <span class="n">snxfile</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">snxfile</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="c1"># - header</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">):</span> <span class="c1"># Points</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;B S</span><span class="se">\n</span><span class="s2">CN Semis</span><span class="se">\n</span><span class="s2">CP 0 0</span><span class="se">\n</span><span class="s2">CP 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">):</span> <span class="c1"># LineString</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;B N</span><span class="se">\n</span><span class="s2">CN Niveau</span><span class="se">\n</span><span class="s2">CP 0 1</span><span class="se">\n</span><span class="s2">CP 99</span><span class="se">\n</span><span class="s2">CP 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;poly&#39;</span><span class="p">):</span> <span class="c1"># Polygon</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;B N</span><span class="se">\n</span><span class="s2">CN Niveau</span><span class="se">\n</span><span class="s2">CP 1 1</span><span class="se">\n</span><span class="s2">CP 99</span><span class="se">\n</span><span class="s2">CP 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">oo</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">zz</span> <span class="o">=</span> <span class="n">z</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zz</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xfmt</span><span class="p">,</span> <span class="n">yfmt</span><span class="p">,</span> <span class="n">zfmt</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; A</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zz</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snxfile</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;%&#39;</span> <span class="ow">in</span> <span class="n">snxfile</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">closed</span> <span class="ow">and</span> <span class="n">close</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ColoredFormatter"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ColoredFormatter">[docs]</a><span class="k">class</span> <span class="nc">ColoredFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log formatter with colors&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">full_line</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_line</span> <span class="o">=</span> <span class="n">full_line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="n">TermColors</span><span class="p">()</span><span class="o">.</span><span class="n">format</span>

<div class="viewcode-block" id="ColoredFormatter.format"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.ColoredFormatter.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_line</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">),</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">levelname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span></div></div>

<span class="k">class</span> <span class="nc">_Redirector_</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">buf</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">+</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>




<div class="viewcode-block" id="Logger"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger">[docs]</a><span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for logging facilities when subclassing.</span>
<span class="sd">    Logging may be sent to the console and/or a log file</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **name**: Name of the logger.</span>
<span class="sd">        - **logfile**, optional: Log file.</span>
<span class="sd">        - **console**, optional: Log to the console.</span>
<span class="sd">        - **maxlogsize**, optional: Maximal size of log file before rotating it.</span>
<span class="sd">        - **maxbackup**, optional: Maximal number of rotated files.</span>
<span class="sd">        - **sfmt**, optional: Format of log messages in log file.</span>
<span class="sd">        - **cfmt**, optional: Format of log message in console.</span>
<span class="sd">        - **asctime**, optional: Time format.</span>
<span class="sd">        - **level**, optional: Initialize logging level (see :meth:`set_loglevel`).</span>
<span class="sd">        - **colors**, optional: Use colors when formatting terminal messages?</span>
<span class="sd">        - **full_line**, optional: Colorize full line or just level name?</span>
<span class="sd">        - **redirect_warnings**, optional: Redirect messages issued by :mod:`warnings.warn`.</span>
<span class="sd">        - **redirect_stdout**, optional: Redirect messages issued to sys.stdout.</span>
<span class="sd">        - **redirect_stderr**, optional: Redirect messages issued to sys.stderr.</span>

<span class="sd">    :See also: :mod:`logging` module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxlogsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxbackup</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cfmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> [</span><span class="si">%(levelname)-8s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">ffmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">: </span><span class="si">%(name)s</span><span class="s1"> [</span><span class="si">%(levelname)-8s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">asctime</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full_line</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">redirect_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redirect_stderr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Create or get logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Handlers</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span>
        <span class="c1"># - file</span>
        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">logfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span>  <span class="n">l</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">handlers</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">)]):</span>
            <span class="n">checkdir</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">asfile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span>  <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span>
                <span class="n">maxBytes</span><span class="o">=</span><span class="n">maxlogsize</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="n">maxbackup</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">ffmt</span><span class="p">,</span> <span class="n">asctime</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># - console</span>
        <span class="k">if</span> <span class="n">console</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">]):</span>
            <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">colors</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">ColoredFormatter</span><span class="p">(</span><span class="n">cfmt</span><span class="p">,</span> <span class="n">full_line</span><span class="o">=</span><span class="n">full_line</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">cfmt</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="c1"># Redirections</span>
        <span class="k">if</span> <span class="n">redirect_warnings</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showwarning</span>
        <span class="k">if</span> <span class="n">redirect_stdout</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect_stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">redirect_stdout</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">_Redirector_</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="p">),</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;STDOUT: &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redirect_stderr</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect_stderr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">redirect_stderr</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">_Redirector_</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_stderr</span><span class="p">),</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;STDERR: &#39;</span><span class="p">)</span>


        <span class="c1"># Announce</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;*** Start log session ***&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Logger.debug"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a debug message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Logger.info"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a info message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Logger.warning"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.warning">[docs]</a>    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a warning message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Logger.showwarning"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.showwarning">[docs]</a>    <span class="k">def</span> <span class="nf">showwarning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;REDIRECTED: </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
            <span class="n">category</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_log_and_exit_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slevel</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a message and exit&quot;&quot;&quot;</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">slevel</span><span class="p">)(</span><span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;exiterr&#39;</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;exit&#39;</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">mode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
            <span class="n">mode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>


<div class="viewcode-block" id="Logger.error"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an error message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_and_exit_</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Logger.critical"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.critical">[docs]</a>    <span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a critical message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_and_exit_</span><span class="p">(</span><span class="s1">&#39;critical&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Logger.set_loglevel"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.set_loglevel">[docs]</a>    <span class="k">def</span> <span class="nf">set_loglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)</span>

<span class="sd">        :Example:</span>

<span class="sd">            &gt;&gt;&gt; logger.set_loglevel(&#39;DEBUG&#39;, console=&#39;INFO&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_loglevel_</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_loglevel_</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">console</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">):</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_loglevel_</span><span class="p">(</span><span class="n">console</span><span class="p">))</span></div>

<div class="viewcode-block" id="Logger.get_loglevel"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.Logger.get_loglevel">[docs]</a>    <span class="k">def</span> <span class="nf">get_loglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the log level as an integer or a string&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">asstring</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span> <span class="s1">&#39;FATAL&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">label</span>
            <span class="k">return</span> <span class="s1">&#39;NOTSET&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span></div>

    <span class="k">def</span> <span class="nf">_get_loglevel_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">level</span></div>

<span class="k">class</span> <span class="nc">TermColors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="n">ERROR</span> <span class="o">=</span> <span class="n">FAILURE</span> <span class="o">=</span> <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[31m&#39;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="n">INFO</span> <span class="o">=</span> <span class="n">OK</span> <span class="o">=</span> <span class="n">SUCCESS</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[32m&#39;</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[33m&#39;</span>
    <span class="n">NORMAL</span> <span class="o">=</span> <span class="n">DEBUG</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[39m&#39;</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[34m&#39;</span>
    <span class="n">MAGENTA</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[35m&#39;</span>
    <span class="n">CYAN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[36m&#39;</span>
    <span class="n">RESET</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">curses</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="n">curses</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="k">if</span> <span class="n">curses</span><span class="p">:</span>
            <span class="c1"># This is a feature test which may end with an exception (eg. exec through ssh session, unset TERM env var)</span>
            <span class="c1"># We don&#39;t want to see this kind error (but we are masking other potential errors...)</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">curses</span><span class="o">.</span><span class="n">setupterm</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curses</span> <span class="ow">or</span> <span class="p">(</span><span class="n">curses</span><span class="o">.</span><span class="n">tigetstr</span><span class="p">(</span><span class="s1">&#39;setf&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">curses</span><span class="o">.</span><span class="n">tigetstr</span><span class="p">(</span><span class="s1">&#39;setaf&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s2">&quot;RED ERROR FAILURE CRITICAL </span><span class="se">\</span>
<span class="s2">        GREEN INFO OK SUCCESS YELLOW WARNING </span><span class="se">\</span>
<span class="s2">        NORMAL DEBUG BLUE MAGENTA CYAN RESET&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;NORMAL&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format a string for its color printing in a terminal</span>

<span class="sd">        - **text**: simple string message</span>
<span class="sd">        - *color*: color or debug level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span> <span class="k">return</span> <span class="n">text</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span><span class="o">+</span><span class="n">text</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">RESET</span>

<div class="viewcode-block" id="netcdf3"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.netcdf3">[docs]</a><span class="k">def</span> <span class="nf">netcdf3</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Turn netcdf4 writing off with :mod:`cdms2`&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">netcdf4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="netcdf4"><a class="viewcode-back" href="../../../library/misc.io.html#vacumm.bathy.bathy.netcdf4">[docs]</a><span class="k">def</span> <span class="nf">netcdf4</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">deflate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn netcdf4 writing on and suppress compression warning&quot;&quot;&quot;</span>
    <span class="n">cdms2</span><span class="o">.</span><span class="n">setCompressionWarnings</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cdms2</span><span class="o">.</span><span class="n">setNetcdfDeflateFlag</span><span class="p">(</span><span class="n">deflate</span><span class="p">)</span>
    <span class="n">cdms2</span><span class="o">.</span><span class="n">setNetcdfShuffleFlag</span><span class="p">(</span><span class="n">shuffle</span><span class="p">)</span>
    <span class="n">cdms2</span><span class="o">.</span><span class="n">setNetcdfDeflateLevelFlag</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>
<span class="n">netcdf4</span><span class="p">()</span>

<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>

<span class="kn">from</span> <span class="nn">.atime</span> <span class="k">import</span> <span class="n">ch_units</span><span class="p">,</span> <span class="n">round_date</span><span class="p">,</span> <span class="n">are_same_units</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">has_time_pattern</span><span class="p">,</span> \
    <span class="n">tsel2slice</span><span class="p">,</span> <span class="n">is_time</span><span class="p">,</span> <span class="n">time_selector</span><span class="p">,</span> <span class="n">itv_union</span><span class="p">,</span> <span class="n">add_margin</span><span class="p">,</span> <span class="n">strptime</span><span class="p">,</span> \
    <span class="n">datetime</span> <span class="k">as</span> <span class="n">adatetime</span><span class="p">,</span> <span class="n">comptime</span><span class="p">,</span>  <span class="n">filter_time_selector</span><span class="p">,</span> <span class="n">reltime</span>
<span class="kn">from</span> <span class="nn">.axes</span> <span class="k">import</span> <span class="n">get_checker</span><span class="p">,</span> <span class="n">istime</span><span class="p">,</span> <span class="n">islon</span><span class="p">,</span> <span class="n">islat</span><span class="p">,</span> <span class="n">islevel</span>
<span class="kn">from</span> <span class="nn">.color</span> <span class="k">import</span> <span class="n">land</span><span class="p">,</span> <span class="n">simple_colors</span><span class="p">,</span> <span class="n">get_cmap</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="k">import</span> <span class="n">create_grid</span><span class="p">,</span> <span class="n">get_xy</span><span class="p">,</span> <span class="n">curv2rect</span><span class="p">,</span> <span class="n">isgrid</span>
<span class="kn">from</span> <span class="nn">.grid.masking</span> <span class="k">import</span> <span class="n">polygons</span><span class="p">,</span> <span class="n">convex_hull</span><span class="p">,</span> <span class="n">rsamp</span><span class="p">,</span> <span class="n">polygon_mask</span><span class="p">,</span> <span class="n">create_polygon</span><span class="p">,</span> \
    <span class="n">clip_shape</span>
<span class="kn">from</span> <span class="nn">.grid.regridding</span> <span class="k">import</span> <span class="n">griddata</span><span class="p">,</span> <span class="n">xy2xy</span>
<span class="kn">from</span> <span class="nn">.grid.basemap</span> <span class="k">import</span> <span class="n">get_proj</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="k">import</span> <span class="n">is_iterable</span><span class="p">,</span>  <span class="n">broadcast</span><span class="p">,</span> <span class="n">kwfilter</span><span class="p">,</span> <span class="n">set_atts</span><span class="p">,</span> <span class="n">create_selector</span><span class="p">,</span> \
    <span class="n">squeeze_variable</span><span class="p">,</span> <span class="n">checkdir</span><span class="p">,</span> <span class="n">match_atts</span><span class="p">,</span> <span class="n">get_atts</span><span class="p">,</span> <span class="n">set_atts</span>
<span class="kn">from</span> <span class="nn">.phys.units</span> <span class="k">import</span> <span class="n">deg2m</span><span class="p">,</span> <span class="n">m2deg</span>
<span class="kn">from</span> <span class="nn">.plot</span> <span class="k">import</span> <span class="n">map2</span><span class="p">,</span> <span class="n">_colorbar_</span><span class="p">,</span> <span class="n">savefigs</span> <span class="k">as</span> <span class="n">Savefigs</span><span class="p">,</span> <span class="n">markers</span> <span class="k">as</span> <span class="n">Markers</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>