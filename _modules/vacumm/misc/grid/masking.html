
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.misc.grid.masking &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../../index.html"><img src="../../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.misc.grid.masking</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;Utilities to deal with masks and selections</span>

<span class="sd">.. seealso::</span>

<span class="sd">    Tutorials: :ref:`user.tut.misc.grid.masking`, :ref:`user.tut.misc.grid.polygons`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2015)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>
<span class="c1">#print &#39;importing masking 0&#39;</span>

<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span>
<span class="n">MA</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span>
<span class="kn">from</span> <span class="nn">cdms2.hgrid</span> <span class="k">import</span> <span class="n">TransientCurveGrid</span>
<span class="kn">from</span> <span class="nn">cdms2.grid</span> <span class="k">import</span> <span class="n">AbstractGrid</span>
<span class="kn">import</span> <span class="nn">cdms2</span><span class="o">,</span> <span class="nn">MV2</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">_geoslib</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">LineString</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">genutil</span> <span class="k">import</span> <span class="n">minmax</span>
<span class="n">cdms</span> <span class="o">=</span> <span class="n">cdms2</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_coast&#39;</span><span class="p">,</span> <span class="s1">&#39;get_coastal_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;GetLakes&#39;</span><span class="p">,</span> <span class="s1">&#39;polygon_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;masked_polygon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;polygons&#39;</span><span class="p">,</span> <span class="s1">&#39;d2m&#39;</span><span class="p">,</span> <span class="s1">&#39;polygon_select&#39;</span><span class="p">,</span> <span class="s1">&#39;envelop&#39;</span><span class="p">,</span> <span class="s1">&#39;check_poly_islands&#39;</span><span class="p">,</span>
    <span class="s1">&#39;check_poly_straits&#39;</span><span class="p">,</span><span class="s1">&#39;t2uvmasks&#39;</span><span class="p">,</span> <span class="s1">&#39;mask2d&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_envelop&#39;</span><span class="p">,</span> <span class="s1">&#39;convex_hull&#39;</span><span class="p">,</span>
    <span class="s1">&#39;uniq&#39;</span><span class="p">,</span> <span class="s1">&#39;rsamp&#39;</span><span class="p">,</span> <span class="s1">&#39;zcompress&#39;</span><span class="p">,</span> <span class="s1">&#39;Lakes&#39;</span><span class="p">,</span> <span class="s1">&#39;erode_coast&#39;</span><span class="p">,</span> <span class="s1">&#39;resol_mask&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_dist_to_coast&#39;</span><span class="p">,</span> <span class="s1">&#39;get_avail_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_envelop_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;create_polygon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;clip_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;proj_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_shapes&#39;</span><span class="p">,</span> <span class="s1">&#39;merge_masks&#39;</span><span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<div class="viewcode-block" id="get_coast"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.get_coast">[docs]</a><span class="k">def</span> <span class="nf">get_coast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">borders</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a mask integer of ocean coastal points from a 2D mask</span>

<span class="sd">    - **mask**: Input mask with 0 on water and 1 on land.</span>
<span class="sd">    - *land*: If True, coast is on land [default: True]</span>
<span class="sd">    - *corners*: If True, consider borders as coastal points [default: True]</span>
<span class="sd">    - *borders:* If True, consider corners as coastal points [default: True]</span>

<span class="sd">    At each point, return 0 if not coast, else an interger ranging from 1 to (2**8-1) to describe the coast point::</span>

<span class="sd">        128 4  64</span>
<span class="sd">        8   +   2</span>
<span class="sd">        16  1  32</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize mask and its boundaries</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">imask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
    <span class="n">imask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
    <span class="n">imask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">imask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">imask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">imask</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">jp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">imask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">jp</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">imask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">ip</span><span class="p">]</span>
    <span class="c1"># Coast on land or ocean</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">land</span><span class="p">:</span>
        <span class="n">iimask</span> <span class="o">=</span> <span class="n">imask</span>
        <span class="n">imask</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">imask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iimask</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">imask</span>
    <span class="c1"># Coast along borders only</span>
    <span class="n">mborders</span> <span class="o">=</span> \
        <span class="mi">1</span>  <span class="o">*</span><span class="n">iimask</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> \
        <span class="mi">2</span>  <span class="o">*</span><span class="n">iimask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>  <span class="p">]</span><span class="o">+</span> \
        <span class="mi">4</span>  <span class="o">*</span><span class="n">iimask</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> \
        <span class="mi">8</span>  <span class="o">*</span><span class="n">iimask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Coast as corners only</span>
    <span class="n">mcorners</span> <span class="o">=</span> \
        <span class="mi">16</span> <span class="o">*</span><span class="n">iimask</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span> \
        <span class="mi">32</span> <span class="o">*</span><span class="n">iimask</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>  <span class="p">]</span><span class="o">+</span> \
        <span class="mi">64</span> <span class="o">*</span><span class="n">iimask</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">2</span><span class="p">:</span>  <span class="p">]</span><span class="o">+</span> \
        <span class="mi">128</span><span class="o">*</span><span class="n">iimask</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">mcorners</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">mborders</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mcorners</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">imask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">borders</span><span class="o">*</span><span class="n">mborders</span><span class="o">+</span><span class="n">corners</span><span class="o">*</span><span class="n">mcorners</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">imask</span><span class="p">,</span> <span class="n">iimask</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="c1"># Return</span>
    <span class="k">if</span> <span class="n">b</span><span class="p">:</span> <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="get_coastal_indices"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.get_coastal_indices">[docs]</a><span class="k">def</span> <span class="nf">get_coastal_indices</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">coast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asiijj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get indices of ocean coastal points from a 2D mask</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mask**: Input mask with 0 on water and 1 on land.</span>
<span class="sd">        - *boundary*: If True, consider outside boundary as land [default: True]</span>
<span class="sd">        - *asiijj*: Get results as II,JJ instead of [(j0,i0),(j1,i1)...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="n">MA</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">coast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coast</span> <span class="o">=</span> <span class="n">get_coast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">iy</span><span class="p">,</span><span class="n">ix</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">jj</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">coast</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">iy</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">coast</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">ix</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">asiijj</span><span class="p">:</span> <span class="k">return</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_dist_to_coast"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.get_dist_to_coast">[docs]</a><span class="k">def</span> <span class="nf">get_dist_to_coast</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the distance to coast on grid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **grid**: (x,y), grid or variable with a grid.</span>
<span class="sd">        - **mask**: Land/sea mask or variable with a mask. If not provided,</span>
<span class="sd">          gets mask from ``grid`` if it is a masked variable,</span>
<span class="sd">          or estimates it using :func:`polygon_mask`</span>
<span class="sd">          and a GHSSC shoreline resolution given by</span>
<span class="sd">          :func:`~vacumm.misc.grid.basemap.gshhs_autores`.</span>
<span class="sd">        - **proj**: Distance are computed by converting coordinates</span>
<span class="sd">          from degrees to meters.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; dist = get_dist_to_coast(sst.getGrid(), sst.mask)</span>
<span class="sd">        &gt;&gt;&gt; dist = get_dist_to_coast(sst)</span>

<span class="sd">    :See also: :func:`get_coastal_indices`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">basemap</span> <span class="k">import</span> <span class="n">gshhs_autores</span><span class="p">,</span> <span class="n">merc</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">gshhs_autores</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">polygon_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask2d</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span> <span class="n">get_coastal_indices</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">asiijj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">good</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="n">good</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">xdiff</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">ng</span><span class="p">))</span> <span class="o">-</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ydiff</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">ng</span><span class="p">))</span> <span class="o">-</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">yc</span><span class="p">,</span> <span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">xdiff</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ydiff</span><span class="o">**</span><span class="mi">2</span> <span class="p">;</span> <span class="k">del</span> <span class="n">xdiff</span><span class="p">,</span> <span class="n">ydiff</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="p">;</span> <span class="k">del</span> <span class="n">dists</span>
    <span class="n">mindists</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mindists</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">mindists</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span>
    <span class="k">del</span> <span class="n">good</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="n">mindists</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mindists</span><span class="p">)</span>
        <span class="n">mindists</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;coastdist&#39;</span>
        <span class="n">mindists</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Distance to coast&#39;</span>
        <span class="n">mindists</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
        <span class="n">M</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">mindists</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mindists</span></div>



<div class="viewcode-block" id="erode_coast"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.erode_coast">[docs]</a><span class="k">def</span> <span class="nf">erode_coast</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mask2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">hardmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Erode coastal mask of ``var`` to fit to ``mask2d`` using 2D smoothing</span>

<span class="sd">    Soothing is performed using :func:`~vacumm.misc.filters.shapiro2d`,</span>
<span class="sd">    in a convergence loop. Loop is ended if :</span>

<span class="sd">        - the mask no longer changes,</span>
<span class="sd">        - the number of iteration exceeds ``maxiter``.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Must be used only for erodeing a thin border</span>
<span class="sd">        of the coast.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: Atleast-2D A :mod:`MV2` variable with mask.</span>
<span class="sd">        - **mask2d**, optional: Reference 2D mask.</span>
<span class="sd">        - **maxiter**, optional: Maximal number of iteration for convergence loop.</span>
<span class="sd">          If equal to ``None``, no check is performed.</span>
<span class="sd">        - **corners**, optional: Weights of corners when calling :func:`~vacumm.misc.filters.shapiro2d`.</span>
<span class="sd">        - **copy**, optional: Modify the variable in place or copy it.</span>
<span class="sd">        - **hardmask**, optional: Mask always applied after an erosion step.</span>
<span class="sd">        - Other keywords are passed to :func:`~vacumm.misc.filters.shapiro2d`.</span>

<span class="sd">    :Return:</span>

<span class="sd">        - A :mod:`MV2` variable</span>

<span class="sd">    :Tutorial: :ref:`user.tut.misc.grid.masking.erode_coast`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">vacumm.misc.filters</span> <span class="k">import</span> <span class="n">shapiro2d</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">var</span>
    <span class="k">if</span> <span class="n">mask2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask2d</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">masknd</span> <span class="o">=</span> <span class="n">mask2d</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask2d</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hardmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hardmask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
        <span class="n">hardmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">hardmask</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># Not masked</span>
    <span class="k">if</span> <span class="n">varo</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="n">MV2</span><span class="o">.</span><span class="n">nomask</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">masknd</span><span class="p">,</span> <span class="n">varo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">varo</span>
    <span class="c1"># Convergence loop</span>
    <span class="n">oldnmasked</span> <span class="o">=</span> <span class="n">varo</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">maxiter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">maxiter</span><span class="p">:</span>
        <span class="n">varc</span> <span class="o">=</span> <span class="n">shapiro2d</span><span class="p">(</span><span class="n">varo</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="n">corners</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">varo</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">varc</span><span class="p">,</span> <span class="n">varo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hardmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">hardmask</span><span class="p">,</span> <span class="n">varo</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">varc</span>
        <span class="n">maskc</span> <span class="o">=</span> <span class="n">varo</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">masknd</span>
        <span class="n">nmasked</span> <span class="o">=</span> <span class="n">maskc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nmasked</span> <span class="o">==</span> <span class="n">oldnmasked</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">del</span> <span class="n">maskc</span>
        <span class="n">oldnmasked</span> <span class="o">=</span> <span class="n">nmasked</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">masknd</span><span class="p">,</span> <span class="n">varo</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">varo</span></div>


<div class="viewcode-block" id="Lakes"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes">[docs]</a><span class="k">class</span> <span class="nc">Lakes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find lakes in a 2D mask where 0 is water and 1 is land</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; from vacumm.misc.grid import Lakes</span>
<span class="sd">        &gt;&gt;&gt; import numpy as N</span>
<span class="sd">        &gt;&gt;&gt; from pylab import pcolor,show,title</span>
<span class="sd">        &gt;&gt;&gt; # Build the mask</span>
<span class="sd">        &gt;&gt;&gt; mask=N.ones((500,500))</span>
<span class="sd">        &gt;&gt;&gt; mask[3:10,100:102]=0</span>
<span class="sd">        &gt;&gt;&gt; mask[103:110,200:210]=0</span>
<span class="sd">        &gt;&gt;&gt; mask[203:210,200:220]=0</span>
<span class="sd">        &gt;&gt;&gt; # Find the lakes</span>
<span class="sd">        &gt;&gt;&gt; lakes = Lakes(mask,nmaxcells=80)</span>
<span class="sd">        &gt;&gt;&gt; print &#39;Number of lakes:&#39;, len(lakes.indices())</span>
<span class="sd">        Number of lakes: 2</span>
<span class="sd">        &gt;&gt;&gt; pcolor(lakes.mask(),shading=False)</span>
<span class="sd">        &gt;&gt;&gt; title(&#39;Lakes&#39;)</span>
<span class="sd">        &gt;&gt;&gt; show()</span>
<span class="sd">        &gt;&gt;&gt; first_two_lakes = lakes[:2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">nmaxcells</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Inits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nmaxcells</span> <span class="o">=</span> <span class="n">nmaxcells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ny</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">[:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ix</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Find lakes using labelling</span>
        <span class="kn">import</span> <span class="nn">scipy.ndimage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlakes</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_imask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncells</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="p">,</span> <span class="n">ilake</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">ilake</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlakes</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Compute indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ilake</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlakes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span> <span class="o">==</span> <span class="n">ilake</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ix</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iy</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>

        <span class="c1"># Sorting argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_argsort</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ncells</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlakes</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">lakes</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lakeid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size2ids_</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">lakes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="o">==</span><span class="n">lakeid</span><span class="p">]</span> <span class="o">=</span> <span class="n">lakeid</span>
        <span class="k">return</span> <span class="n">lakes</span>

    <span class="k">def</span> <span class="nf">_size2ids_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlakes</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_argsort</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
        <span class="n">ids</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ids</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ids</span>

<div class="viewcode-block" id="Lakes.plot"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the lakes</span>

<span class="sd">        Keywords are passed to :func`~matplotlib.pyplot.pcolor`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">P</span>
        <span class="n">P</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lakes</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Lakes.ncells"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.ncells">[docs]</a>    <span class="k">def</span> <span class="nf">ncells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of cell point for each lake&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ncells</span></div>


<div class="viewcode-block" id="Lakes.indices"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.indices">[docs]</a>    <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of lake coordinates</span>

<span class="sd">        - *id*: Select lake #&lt;id&gt;</span>
<span class="sd">        - *nbig*: Consider the first ``nbig`` greatest lakes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nbig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lakeid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size2ids_</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nbig</span><span class="p">)):</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">[</span><span class="n">lakeid</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">indices</span></div>

<div class="viewcode-block" id="Lakes.lakes"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.lakes">[docs]</a>    <span class="k">def</span> <span class="nf">lakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an array of same size as masks, but with points in lakes set to its lake id, and others to set to zero</span>

<span class="sd">        - *id*: Select lake #&lt;id&gt;</span>
<span class="sd">        - *nbig*: Consider the first ``nbig`` greatest lakes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nbig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[:</span><span class="n">nbig</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="o">==</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lakes.mask"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.mask">[docs]</a>    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a boolean land/sea mask from lakes() (land is True)</span>

<span class="sd">        - *id*: Select lake #&lt;id&gt;</span>
<span class="sd">        - *nmaxcells*: Do not consider lakes with number of points greater than nmaxcells</span>

<span class="sd">        :Example:</span>

<span class="sd">        &gt;&gt;&gt; mask_lake2 = GetLakes(mask).mask(2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lakes</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">nbig</span><span class="o">=</span><span class="n">nbig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Lakes.ocean"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.Lakes.ocean">[docs]</a>    <span class="k">def</span> <span class="nf">ocean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the biggest lake or its mask (integer type)</span>

<span class="sd">        - *mask*: If True, return the mask, not the lake [default: True]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">nbig</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>


<span class="n">GetLakes</span> <span class="o">=</span> <span class="n">Lakes</span>

<div class="viewcode-block" id="polygon_mask"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.polygon_mask">[docs]</a><span class="k">def</span> <span class="nf">polygon_mask</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;intersect&#39;</span><span class="p">,</span> <span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">],</span>
    <span class="n">ocean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">yclean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">premask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a mask on a regular or curvilinear grid according to a polygon list</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A cdms grid or variable or a tuple of (xx,yy).</span>
<span class="sd">        - **polys**: A list of polygons or GMT resolutions or Shapes instance like shorelines.</span>
<span class="sd">        - **mode**, optional: Way to decide if a grid point is masked. Possible values are:</span>

<span class="sd">            - ``intersect``, 1, ``area`` (default): Masked if land area fraction is &gt; ``thresholds[0]``.</span>
<span class="sd">              If more than one intersections, land area fraction must be &gt; ``thresholds[1]``</span>
<span class="sd">              to prevent masking straits.</span>
<span class="sd">            - else: Masked if grid point inside polygon.</span>

<span class="sd">        - **thresholds**, optional: See ``intersect`` mode [default: [.5, .75]]</span>
<span class="sd">        - **ocean**, optional: If True, keep only the ocean (= biggest lake).</span>
<span class="sd">        - **fractions**: If True or 1, return the total fraction of cells covered by the</span>
<span class="sd">          polygons; if 2, returns the total area for each cell.</span>
<span class="sd">        - **proj**, optional: Geographical projection function.</span>
<span class="sd">          See :func:`~vacumm.misc.grid.basemap.get_proj`. Use ``False`` to not</span>
<span class="sd">          convert coordinates to meters, and speed up the routine.</span>

<span class="sd">    :Result:</span>

<span class="sd">        A :mod:`numpy` array of boolean (mask) with ``False`` on land.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get proper numeric axes</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="n">curved</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">proj</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>

    <span class="c1"># Thresholds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">thresholds</span> <span class="o">+=</span> <span class="n">thresholds</span>

    <span class="c1"># Bounds if mode is &#39;intersect&#39;</span>
    <span class="n">bmode</span> <span class="o">=</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;intersect&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">]</span>
    <span class="n">fmode</span> <span class="o">=</span> <span class="n">fractions</span> <span class="c1">#mode in [2, &#39;fractions&#39;, 3]</span>
    <span class="k">if</span> <span class="n">fmode</span><span class="p">:</span>
        <span class="n">bmode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>

    <span class="n">xxb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds2d</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">yyb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds2d</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bmode</span><span class="p">:</span>
<span class="c1">#        yyb[yyb&gt;90.] = 89.99</span>
<span class="c1">#        yyb[yyb&lt;-90.] = -89.99</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xxb</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span><span class="o">/</span><span class="n">xxb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">yyb</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span><span class="o">/</span><span class="n">yyb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="n">yyb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="n">xxb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">yyb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">ymins</span> <span class="o">=</span> <span class="n">yyb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">xxb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dx</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">xxb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dx</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">yyb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span><span class="o">/</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span><span class="o">/</span><span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">ymins</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dx</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span>
    <span class="k">if</span> <span class="n">curved</span><span class="p">:</span>
        <span class="n">xxc</span><span class="p">,</span> <span class="n">yyc</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">meshcells</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dyx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yyc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yyc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dxx</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">dyx</span><span class="p">,</span> <span class="n">dyy</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">/=</span> <span class="mf">10.</span>

    <span class="k">if</span> <span class="n">premask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">premask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">premask</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>

    <span class="c1"># Get instances of Polygons</span>
    <span class="n">polys</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">shapetype</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">clip_proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Loop on grid points</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="c1"># Get polygons of the curent row</span>
        <span class="n">ypolys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">curved</span><span class="p">:</span>
            <span class="c1"># base</span>
            <span class="n">rowdown</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xxc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">yyc</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rowup</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xxc</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">yyc</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># bottom margin</span>
            <span class="n">rowdown</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">dyx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dyx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
            <span class="n">rowdown</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dyy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># top margin</span>
            <span class="n">rowup</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">dyx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dyx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
            <span class="n">rowup</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dyy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># margin at corners</span>
            <span class="k">for</span> <span class="n">ij</span><span class="p">,</span> <span class="n">ddx</span><span class="p">,</span> <span class="n">ddy</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dxx</span><span class="p">,</span> <span class="n">dxy</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dyx</span><span class="p">,</span> <span class="n">dyy</span><span class="p">):</span> <span class="c1"># x,y</span>
                <span class="n">rowdown</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ij</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ddx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ddy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">rowdown</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ij</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ddx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rowup</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ij</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ddx</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">rowup</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ij</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ddx</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ddy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rowpoly_array</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">rowdown</span><span class="p">,</span> <span class="n">rowup</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">del</span> <span class="n">rowdown</span><span class="p">,</span> <span class="n">rowup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rowpoly_array</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="o">/</span><span class="mf">10.</span><span class="p">]])</span>
        <span class="n">rowpoly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">rowpoly_array</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">rowpoly</span><span class="p">):</span>
                    <span class="n">ypolys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">rowpoly</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">del</span> <span class="n">rowpoly_array</span><span class="p">,</span> <span class="n">rowpoly</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="c1"># Pre-masking</span>
            <span class="k">if</span> <span class="n">premask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">premask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">premask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Point is inside</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bmode</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">ypolys</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">xx</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span><span class="n">yy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]:</span> <span class="k">break</span>
                <span class="k">continue</span>

            <span class="c1"># Check the cell</span>
            <span class="n">cell_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xxb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]])</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_poly</span><span class="p">,</span> <span class="p">(</span><span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span>
            <span class="n">intersect_area</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">nintersect</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ypolys</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">poly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="p">(</span><span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span>

                <span class="c1"># Check X range</span>
                <span class="k">if</span> <span class="n">xxb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="ow">or</span> \
                    <span class="n">xxb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                        <span class="k">continue</span>

                <span class="c1"># Check if polygon covers cell</span>
                <span class="k">if</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                    <span class="n">nintersect</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">intersect_area</span> <span class="o">=</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="c1"># One polygon</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>

                    <span class="c1"># Remove from list of polys if inside cell</span>
                    <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">cell_poly</span><span class="p">):</span>
                        <span class="n">intersect_area</span> <span class="o">+=</span> <span class="n">poly</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
                        <span class="n">nintersect</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">del</span> <span class="n">ypolys</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">intersections</span> <span class="o">=</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="n">intersections</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intersection</span><span class="p">,</span> <span class="p">(</span><span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">)):</span>
                            <span class="k">continue</span>
                        <span class="c1"># One intersection polygon</span>
                        <span class="n">this_area</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
                        <span class="n">intersect_area</span> <span class="o">+=</span> <span class="n">this_area</span>
                        <span class="n">nintersect</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">this_area</span> <span class="o">==</span> <span class="n">poly</span><span class="o">.</span><span class="n">area</span><span class="p">():</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">del</span> <span class="n">intersections</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="k">break</span>

            <span class="c1"># Fraction</span>
            <span class="n">land_fraction</span> <span class="o">=</span> <span class="n">intersect_area</span><span class="o">/</span><span class="n">cell_poly</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fmode</span><span class="p">:</span> <span class="c1"># Fraction only</span>
                <span class="k">if</span> <span class="n">fmode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersect_area</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">land_fraction</span>
                <span class="k">continue</span>

            <span class="c1"># Mask according to fraction (basic masking + strait checking)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">land_fraction</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">nintersect</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1">#           mask[j, i] = intersect_fraction &lt; thresholds[1] and nintersect &gt; 1</span>
            <span class="k">del</span> <span class="n">cell_poly</span>

        <span class="k">del</span> <span class="n">ypolys</span>

    <span class="c1"># Select ocean only</span>
    <span class="k">if</span> <span class="n">ocean</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GetLakes</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">ocean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mask</span></div>




<div class="viewcode-block" id="masked_polygon"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.masked_polygon">[docs]</a><span class="k">def</span> <span class="nf">masked_polygon</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mask a variable according to a polygon list</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vv**: The MV2 array.</span>
<span class="sd">        - **polys**, optional: Polygons (or something like that, see :func:`polygons`).</span>
<span class="sd">        - **copy**, optional: Copy data?.</span>
<span class="sd">        - **reverse**, optional: Reverse the mask?</span>
<span class="sd">        - Other keywords are passed to :func:`polygon_mask`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">polygon_mask</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>

    <span class="c1"># Mask the variable</span>
    <span class="n">vv2</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
    <span class="n">vv2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">vv</span><span class="o">.</span><span class="n">id</span>
    <span class="k">del</span> <span class="n">mask</span>
    <span class="k">return</span> <span class="n">vv2</span></div>

<span class="k">def</span> <span class="nf">masked_ocean</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">polys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove lakes from a variable to keep only ocean where ocean the the biggest lake</span>

<span class="sd">    - **vv**: The variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="proj_shape"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.proj_shape">[docs]</a><span class="k">def</span> <span class="nf">proj_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">proj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project a Point, a Polygon or a LineString shape using a geographical projection</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **shape**: A Point, Polygon, or a LineString instance with coordinates in degrees.</span>
<span class="sd">        - **proj**: A projection function of instance.</span>
<span class="sd">          See :func:`~vacumm.misc.grid.basemap.get_proj`.</span>

<span class="sd">    :Return: A similar instance with its coordinates converted to meters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span> <span class="k">return</span> <span class="n">shape</span>

    <span class="c1"># Point</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="n">proj</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span>

    <span class="c1"># LineString and Polygon</span>
    <span class="k">return</span> <span class="n">shape</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">proj</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="clip_shape"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.clip_shape">[docs]</a><span class="k">def</span> <span class="nf">clip_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clip a :class:`Point`, a :class:`Polygon` or a :class:`LineString`</span>
<span class="sd">    shape using clipping polygon</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **shape**: A valid :class:`Point`, a :class:`Polygon` or a</span>
<span class="sd">          :class:`LineString` instance.</span>
<span class="sd">        - **clip**, optional: A clipping polygon.</span>

<span class="sd">    :Return: A possible empty list of intersection shapes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">shape</span><span class="p">]</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">clip</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">shape</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">clip</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shape</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="clip_shapes"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.clip_shapes">[docs]</a><span class="k">def</span> <span class="nf">clip_shapes</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as :func:`clip_shape` but applied to a list of shapes&quot;&quot;&quot;</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
        <span class="n">shapes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clip_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">clip</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="create_polygon"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.create_polygon">[docs]</a><span class="k">def</span> <span class="nf">create_polygon</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a simple :class:`Polygon` instance using data</span>

<span class="sd">    :Param:</span>

<span class="sd">        - **data**: Can be either a ``(N,2)`` or ``(2,N)`` array,</span>
<span class="sd">          a ``(xmin,ymin,xmax,ymax)`` list, tuple or array, or a Polygon.</span>
<span class="sd">        - **proj**, optional: Geographical projection function.</span>
<span class="sd">        - **mode**, optional: Output mode. ``&quot;line&quot;`` = :class:`LineString`,</span>
<span class="sd">          ``&quot;verts&quot;`` = numpy vertices, else :class:`Polygon`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">boundary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># Convert to numeric</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># xmin,ymin,xmax,ymax form</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;1D form must have 4 elements (xmin,ymin,xmax,ymax), not </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>

    <span class="c1"># Check order</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Projection</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
        <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Create Polygon or LineString</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span>
    <span class="n">shaper</span> <span class="o">=</span> <span class="n">LineString</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Polygon</span>
    <span class="k">return</span> <span class="n">shaper</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_polygon"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.plot_polygon">[docs]</a><span class="k">def</span> <span class="nf">plot_polygon</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simply plot a polygon on the current plot using :func:`matplotlib.pyplot.plot`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **poly**: A valid :class:`Polygon` instance.</span>
<span class="sd">        - Extra keyword are passed to plot function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">boundary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xx</span><span class="p">,</span> <span class="n">xx</span><span class="p">[:</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">yy</span><span class="p">,</span> <span class="n">yy</span><span class="p">[:</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="k">import</span> <span class="n">gca</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="polygons"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.polygons">[docs]</a><span class="k">def</span> <span class="nf">polygons</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shapetype</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of Polygon instances</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **polys**: A tuple or list of polygon proxies (see examples).</span>
<span class="sd">        - **shapetype**: 1 = Polygons, 2=Polylines(=LineStrings) [default: 2]</span>
<span class="sd">        - **proj**: Geographical projection to convert positions. No projection</span>
<span class="sd">          by default.</span>
<span class="sd">        - **clip**, optional: Clip all polygons with this one.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; import numpy as N</span>
<span class="sd">        &gt;&gt;&gt; X = [0,1,1,0]</span>
<span class="sd">        &gt;&gt;&gt; Y = N.array([0,0,1,1])</span>
<span class="sd">        &gt;&gt;&gt; polygons( [(X,Y)]] )                                # from like grid bounds</span>
<span class="sd">        &gt;&gt;&gt; polygons( [zip(X,Y), [X,Y], N.array([X,Y])] )       # cloud</span>
<span class="sd">        &gt;&gt;&gt; polygons( [polygons(([X,Y],), polygons(([X,Y],)])   # from polygins</span>
<span class="sd">        &gt;&gt;&gt; polygons( [[min(X),min(Y),max(X),max(Y)],] )        # from bounds</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="p">(</span><span class="n">Basemap</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Shapes</span><span class="p">,</span> <span class="n">AbstractGrid</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">polys</span> <span class="o">=</span> <span class="p">[</span><span class="n">polys</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">):</span> <span class="n">proj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>
    <span class="n">kwclip</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;clip_&#39;</span><span class="p">)</span>

    <span class="c1"># Numeric or geos polygons</span>
    <span class="n">out_polys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#    gmt_polys = []</span>
    <span class="k">if</span> <span class="n">shapetype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shaper</span> <span class="o">=</span> <span class="n">LineString</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shaper</span> <span class="o">=</span> <span class="n">Polygon</span>
    <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clipl</span> <span class="o">=</span> <span class="n">clip</span> <span class="c1"># degrees</span>
        <span class="n">kwclip</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwclip</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">kwclip</span><span class="p">[</span><span class="s1">&#39;proj&#39;</span><span class="p">]</span>
        <span class="n">kwclip</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;verts&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clipl</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Loop on polygon data</span>
    <span class="kn">from</span> <span class="nn">misc</span> <span class="k">import</span> <span class="n">isgrid</span><span class="p">,</span> <span class="n">isrect</span><span class="p">,</span> <span class="n">curv2rect</span>
    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>

        <span class="c1"># Grid (cdms var, grid or tuple of axes) -&gt; get envelop</span>
        <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">islon</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">islat</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">grid_envelop</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># It&#39;s already a polygon</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="p">]</span>

        <span class="c1"># Polygon from GMT</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Basemap</span><span class="p">)):</span>
<span class="c1">#            poly = GSHHS_BM(poly)</span>
<span class="c1">#           gmt_polys.append(poly)</span>
            <span class="n">out_polys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">GSHHS_BM</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clipl</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="c1"># Shapes instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">Shapes</span><span class="p">):</span>

            <span class="c1"># Good polygon?</span>
            <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">shapetype</span><span class="p">:</span>
                <span class="k">continue</span>

<span class="c1">#            # Clip</span>
<span class="c1">#            poly.clip(clip)</span>

            <span class="c1"># Append to list</span>
            <span class="n">out_polys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">())</span>
<span class="c1">#            continue</span>

        <span class="c1"># Make sure to have a polygon with the right projection</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">create_polygon</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;line&#39;</span> <span class="k">if</span> <span class="n">shaper</span> <span class="ow">is</span> <span class="n">LineString</span> <span class="k">else</span> <span class="s1">&#39;poly&#39;</span><span class="p">)</span>

        <span class="c1"># Clip</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_polys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clip_shape</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">clip</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

<span class="c1">#   # Treat GMT polygons</span>
<span class="c1">#   from ...misc.plot import map as Map</span>
<span class="c1">#   for poly in gmt_polys:</span>
<span class="c1">#       if isinstance(poly, Basemap) and poly.resolution is not None:</span>
<span class="c1">#           # We already have all the numeric polygons</span>
<span class="c1">#           gmt_m = poly</span>
<span class="c1">#       elif isinstance(poly, str):</span>
<span class="c1">#           # We must deduce polygons from gmt resolution</span>
<span class="c1">#           print &#39;getting gmt map for mask&#39;</span>
<span class="c1">#           assert poly[0] in [&#39;f&#39;, &#39;h&#39;, &#39;i&#39;, &#39;l&#39;, &#39;c&#39;], \</span>
<span class="c1">#               &quot;Resolution must be one of [&#39;f&#39;, &#39;h&#39;, &#39;i&#39;, &#39;l&#39;, &#39;c&#39;],  not &quot;+poly[0]</span>
<span class="c1">#           # What kind of map?</span>
<span class="c1">#           if m is not None:</span>
<span class="c1">#               proj = m.projection</span>
<span class="c1">#           else:</span>
<span class="c1">#               proj = &#39;cyl&#39;</span>
<span class="c1">#           # Ok, get it</span>
<span class="c1">#           gmt_m = Map(lon=lon, lat=lat, maponly=True, res=poly[0], projection=proj)</span>
<span class="c1">#       else:</span>
<span class="c1">#           continue</span>
<span class="c1">#       out_polys.extend([Polygon(N.array(p).transpose()) for p in gmt_m.coastpolygons])</span>

    <span class="k">return</span> <span class="n">out_polys</span></div>


<span class="k">def</span> <span class="nf">_trans_</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="c1">#FIXME: see deg2map</span>
    <span class="c1"># Nothing to do</span>
    <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
    <span class="c1"># Check if we are sure to not have degrees</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">xmin</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">&gt;</span> <span class="mf">720.</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
    <span class="c1"># We use a existing basemap instance</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">trans</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
    <span class="c1"># We create an instance</span>
    <span class="n">lat_center</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">lat_0</span><span class="o">=</span><span class="n">lat_center</span><span class="p">,</span> <span class="n">lat_ts</span><span class="o">=</span><span class="n">lat_center</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">xx</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;merc&#39;</span><span class="p">,</span>
        <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span><span class="n">llcrnrlat</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span><span class="n">urcrnrlon</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span><span class="n">urcrnrlat</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
<span class="c1">#   return d2m(xx, yy)</span>

<div class="viewcode-block" id="d2m"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.d2m">[docs]</a><span class="k">def</span> <span class="nf">d2m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">deg2m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">deg2m</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></div>

<div class="viewcode-block" id="polygon_select"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.polygon_select">[docs]</a><span class="k">def</span> <span class="nf">polygon_select</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">zz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select unstructered points that are inside polygons</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xx**: Positions along X.</span>
<span class="sd">        - **yy**: Positions along Y.</span>
<span class="sd">        - **polys**: Polygons.</span>
<span class="sd">        - **zz**, optional: Values at theses positions.</span>
<span class="sd">        - **mask**, optional: Return masked positions and values of True or 1,</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; xs, ys = polygon_select(x, y, [poly1, poly2])</span>
<span class="sd">        &gt;&gt;&gt; xs, ys, zs = polygon_select(x, y, [poly1, poly2], z)</span>

<span class="sd">        &gt;&gt;&gt; xmasked, ymasked, zmasked = polygon_select(x, y, polys, z, mask=True)</span>
<span class="sd">        &gt;&gt;&gt; print N.allclose(xs, xmasked.compressed())</span>

<span class="sd">        &gt;&gt;&gt; valid = polygon_select(x, y, polys, mask=2)</span>
<span class="sd">        &gt;&gt;&gt; print N.allclose(xs, x[valid])</span>

<span class="sd">    :Outputs: Depends on ``mask``</span>

<span class="sd">        - False or 0: selected ``x,y`` or ``x,y,z``</span>
<span class="sd">        - True/1: the same but as masked arrays</span>
<span class="sd">        - 2: boolean array of valid points (the inverse of the mask)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get numeric axes</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

    <span class="c1"># Get a proper polygon list</span>
    <span class="n">polys</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="c1"># Create the mask</span>
    <span class="n">pmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                <span class="n">pmask</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

    <span class="c1"># Return mask or masked</span>
    <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">~</span><span class="n">pmask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">pmask</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> \
                <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">pmask</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> \
                <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">pmask</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Return selection</span>
    <span class="n">good</span> <span class="o">=</span> <span class="o">~</span><span class="n">pmask</span>
    <span class="k">del</span> <span class="n">pmask</span>
    <span class="n">xsel</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
    <span class="n">ysel</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsel</span><span class="p">,</span> <span class="n">ysel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="p">)</span>
    <span class="k">del</span> <span class="n">good</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="convex_hull"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.convex_hull">[docs]</a><span class="k">def</span> <span class="nf">convex_hull</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;delaunay&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the envelop of cloud of points</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xy**: (x,y) or array of size (2,nxy) (see :func:`~vacumm.misc.grid.misc.get_xy`).</span>
<span class="sd">        - *poly*:</span>

<span class="sd">            - ``True``: Return as Polygon instance.</span>
<span class="sd">            - ``False``: Return two 1D arrays ``xpts,ypts``</span>

<span class="sd">            - *method*:</span>

<span class="sd">                - ``&quot;angles&quot;``: Recursive scan of angles between points.</span>
<span class="sd">                - ``&quot;delaunay&quot;``: Use Delaunlay triangulation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Points</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Various methods</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;delau&#39;</span><span class="p">):</span>

        <span class="c1"># Delaunay</span>
        <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">ConvexHull</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ye</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quarters&#39;</span><span class="p">:</span>

        <span class="n">np</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>

        <span class="c1"># Most south point</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>
        <span class="n">ye</span> <span class="o">=</span> <span class="p">[</span><span class="n">yy</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>

        <span class="c1"># SW</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">xx</span><span class="o">&gt;</span><span class="n">xe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">good</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="k">break</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
            <span class="n">xe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="n">ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>

        <span class="c1"># NW</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">yyx</span><span class="o">&gt;</span><span class="n">ye</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">good</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="k">break</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
            <span class="n">xe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="n">ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>

        <span class="k">pass</span>
        <span class="c1">#TODO: finish convex_hull with quaters</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;angles&#39;</span><span class="p">:</span>

        <span class="c1"># Angles</span>
        <span class="n">np</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="n">xx0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span>
        <span class="n">xx1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xx1</span><span class="o">-</span><span class="n">xx0</span> <span class="p">;</span> <span class="k">del</span> <span class="n">xx0</span><span class="p">,</span> <span class="n">xx1</span>
        <span class="n">yy0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span>
        <span class="n">yy1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">yy1</span><span class="o">-</span><span class="n">yy0</span> <span class="p">;</span> <span class="k">del</span> <span class="n">yy0</span><span class="p">,</span> <span class="n">yy1</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="p">;</span> <span class="k">del</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="p">)</span>
        <span class="n">angles</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span>

        <span class="c1"># Most south point</span>
        <span class="n">ip0</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>
        <span class="n">ye</span> <span class="o">=</span> <span class="p">[</span><span class="n">yy</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>

        <span class="c1"># Recursive search</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">ip0</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">xe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="n">ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="n">ic</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ic</span> <span class="o">&gt;</span> <span class="n">np</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xe</span><span class="p">)</span>
        <span class="n">ye</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ye</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Polygon or positions?</span>
    <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">polygons</span><span class="p">([(</span><span class="n">xe</span><span class="p">,</span> <span class="n">ye</span><span class="p">)],</span> <span class="n">m</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">xe</span><span class="p">,</span> <span class="n">ye</span></div>


<div class="viewcode-block" id="uniq"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.uniq">[docs]</a><span class="k">def</span> <span class="nf">uniq</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove duplicates in data</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; import numpy as N</span>
<span class="sd">    &gt;&gt;&gt; a = N.arange(20.).reshape((10,2))</span>
<span class="sd">    &gt;&gt;&gt; a[5] = a[1]</span>
<span class="sd">    &gt;&gt;&gt; b = uniq(a)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">wdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wdata</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">bad</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span></div>


<div class="viewcode-block" id="envelop"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.envelop">[docs]</a><span class="k">def</span> <span class="nf">envelop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shortcut to :func:`convex_hull`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convex_hull</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="grid_envelop"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.grid_envelop">[docs]</a><span class="k">def</span> <span class="nf">grid_envelop</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a polygon that encloses a grid</span>

<span class="sd">    - **gg**: A cdms grid or a tuple of (lat,lon)</span>
<span class="sd">    - *centers*:</span>

<span class="sd">        - ``True``: The polygon is at the cell center.</span>
<span class="sd">        - ``False``: The polygon is at the cell corners.</span>

<span class="sd">    - *poly*:</span>

<span class="sd">        - ``True``: Return as Polygon instance.</span>
<span class="sd">        - ``False``: Return two 1D arrays ``xpts,ypts``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Axes</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Rectangular grids</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">curv2rect</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">centers</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span>  <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span>  <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">yb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span>  <span class="n">x1</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">;</span>  <span class="n">y1</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">poly</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">]],</span> <span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">]),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>

    <span class="c1"># Get the 2D axes</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">meshbounds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centers</span><span class="p">:</span>
        <span class="n">xxref</span><span class="p">,</span> <span class="n">yyref</span> <span class="o">=</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xxref</span><span class="p">,</span> <span class="n">yyref</span> <span class="o">=</span> <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Get the limits</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="c1"># bottom</span>
        <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>    <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># inner-left</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="c1"># top</span>
        <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)):</span> <span class="c1"># inner right</span>

        <span class="c1"># Border</span>
        <span class="n">xborder</span> <span class="o">=</span> <span class="n">xxref</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">yborder</span> <span class="o">=</span> <span class="n">yyref</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Smart compression</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jslice</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Along X</span>
            <span class="k">if</span> <span class="n">jslice</span><span class="p">:</span> <span class="c1"># top</span>
                <span class="n">jb0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="p">;</span> <span class="n">jb1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># bottom</span>
                <span class="n">jb0</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">jb1</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">xpoly</span> <span class="o">=</span> <span class="n">xxb</span><span class="p">[</span><span class="n">jb0</span><span class="p">:</span><span class="n">jb1</span><span class="p">,</span> <span class="n">islice</span><span class="p">][:,</span> <span class="p">::</span><span class="n">nx</span><span class="p">]</span>
            <span class="n">ypoly</span> <span class="o">=</span> <span class="n">yyb</span><span class="p">[</span><span class="n">jb0</span><span class="p">:</span><span class="n">jb1</span><span class="p">,</span> <span class="n">islice</span><span class="p">][:,</span> <span class="p">::</span><span class="n">nx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Along Y</span>
            <span class="k">if</span> <span class="n">islice</span><span class="p">:</span> <span class="c1"># right</span>
                <span class="n">ib0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="p">;</span> <span class="n">ib1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># left</span>
                <span class="n">ib0</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">ib1</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">xpoly</span> <span class="o">=</span> <span class="n">xxb</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">ib0</span><span class="p">:</span><span class="n">ib1</span><span class="p">][::</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ypoly</span> <span class="o">=</span> <span class="n">yyb</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">ib0</span><span class="p">:</span><span class="n">ib1</span><span class="p">][::</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">xline</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span><span class="p">]</span> <span class="p">;</span> <span class="n">xline</span> <span class="o">=</span> <span class="n">xline</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">xline</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yline</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span><span class="p">]</span> <span class="p">;</span> <span class="n">yline</span> <span class="o">=</span> <span class="n">yline</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">yline</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">poly1d</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">xpoly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ypoly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">xpoly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ypoly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">xpoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ypoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">xpoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ypoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]],</span> <span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="n">line1d</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">xline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yline</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xline</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yline</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span> <span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">line1d</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly1d</span><span class="p">):</span> <span class="c1"># Compression</span>
            <span class="n">xborder</span> <span class="o">=</span> <span class="n">xborder</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">xborder</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">yborder</span> <span class="o">=</span> <span class="n">yborder</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">yborder</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add it</span>
        <span class="n">xp</span> <span class="o">+=</span> <span class="n">xborder</span>
        <span class="n">yp</span> <span class="o">+=</span> <span class="n">yborder</span>

    <span class="c1"># Return the polygon or arrays</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">poly</span><span class="p">:</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xp</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="grid_envelop_mask"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.grid_envelop_mask">[docs]</a><span class="k">def</span> <span class="nf">grid_envelop_mask</span><span class="p">(</span><span class="n">ggi</span><span class="p">,</span> <span class="n">ggo</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a mask on output grid from the bounds of an input grid:</span>
<span class="sd">    points of output grid that are not within bounds of input grid are masked.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **ggi**: Input grid or (lon,lat) or cdms variable.</span>
<span class="sd">        - **ggo**: Output grid or (lon,lat) or cdms variable.</span>
<span class="sd">        - Other keywords are passed to :func:`grid_envelop`</span>

<span class="sd">    :Returns:</span>
<span class="sd">        A mask on output grid, where True means &quot;outside bounds of input grid&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">isgrid</span><span class="p">(</span><span class="n">ggi</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># Rectangular</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">ggi</span><span class="p">)</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ggo</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">ggo</span><span class="p">)</span>
        <span class="n">xxo</span><span class="p">,</span> <span class="n">yyo</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">ggo</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">xxo</span><span class="o">&lt;=</span><span class="n">xb</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">xxo</span><span class="o">&gt;=</span><span class="n">xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">yyo</span><span class="o">&lt;=</span><span class="n">yb</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">yyo</span><span class="o">&gt;=</span><span class="n">yb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">elif</span> <span class="n">poly</span><span class="p">:</span> <span class="c1"># Using a polygon</span>

        <span class="c1"># Envelop of the input grid</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">grid_envelop</span><span class="p">(</span><span class="n">ggi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Mask on output grid</span>
        <span class="k">return</span> <span class="o">~</span><span class="n">polygon_mask</span><span class="p">(</span><span class="n">ggo</span><span class="p">,</span> <span class="p">[</span><span class="n">poly</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;inside&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Using regridding</span>
        <span class="kn">from</span> <span class="nn">regridding</span> <span class="k">import</span> <span class="n">regrid2d</span>
        <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">meshbounds</span><span class="p">(</span><span class="o">*</span><span class="n">M</span><span class="o">.</span><span class="n">meshbounds</span><span class="p">(</span><span class="o">*</span><span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">ggi</span><span class="p">)))</span>
        <span class="n">vari</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xxb</span><span class="o">*</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">vari</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">vari</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">M</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">curv_grid</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span><span class="p">))</span>
        <span class="n">varo</span> <span class="o">=</span> <span class="n">regrid2d</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">ggo</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">varo</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="check_poly_islands"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.check_poly_islands">[docs]</a><span class="k">def</span> <span class="nf">check_poly_islands</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">offsetmin</span><span class="o">=.</span><span class="mi">85</span><span class="p">,</span> <span class="n">offsetmax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">dcell</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that islands as greater as a cell are taken into account</span>

<span class="sd">    - **mask**: The initial mask. A cdms variable with X (longitude) and Y (latitude), or a tuple (lon, lat, mask).</span>
<span class="sd">    - **polys**: Coastal polygons.</span>
<span class="sd">    - *offset*: Islands whose area is &gt; 1-offset and &lt; 1+offset % of the mean cell area are checked [default: .95]</span>
<span class="sd">    - *dcell*: dx and dy relative extension from the center of the cell in resolution units.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get mask and axes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gg</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Resolution</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">cell_area</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>

    <span class="c1"># Loop on islands</span>
    <span class="n">ni</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">island_poly</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>

        <span class="c1"># Select islands</span>
        <span class="n">island_area</span> <span class="o">=</span> <span class="n">island_poly</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">island_area</span> <span class="o">&lt;</span> <span class="n">cell_area</span><span class="o">*</span><span class="n">offsetmin</span> <span class="ow">or</span> <span class="n">island_area</span> <span class="o">&gt;</span> <span class="n">cell_area</span><span class="o">*</span><span class="n">offsetmax</span><span class="p">:</span> <span class="k">continue</span>

        <span class="c1"># Define cells around</span>
        <span class="n">xisland</span> <span class="o">=</span> <span class="n">island_poly</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">yisland</span> <span class="o">=</span> <span class="n">island_poly</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">xcisland</span> <span class="o">=</span> <span class="p">(</span><span class="n">xisland</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">xisland</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ycisland</span> <span class="o">=</span> <span class="p">(</span><span class="n">yisland</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">yisland</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">mapInterval</span><span class="p">((</span><span class="n">xcisland</span><span class="o">-</span><span class="n">dx</span><span class="o">*</span><span class="n">dcell</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">xcisland</span><span class="o">+</span><span class="n">dx</span><span class="o">*</span><span class="n">dcell</span><span class="o">*</span><span class="mf">1.1</span><span class="p">))</span>
        <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">mapInterval</span><span class="p">((</span><span class="n">ycisland</span><span class="o">-</span><span class="n">dy</span><span class="o">*</span><span class="n">dcell</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">ycisland</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dcell</span><span class="o">*</span><span class="mf">1.1</span><span class="p">))</span>
        <span class="n">amask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">jmin</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span> <span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>
        <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">_trans_</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">bounds2d</span><span class="p">(</span><span class="n">amask</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>  <span class="n">bounds2d</span><span class="p">(</span><span class="n">amask</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># Get intersection areas</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">amask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">amask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">amask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">cell_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xxb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">island_poly</span><span class="p">):</span>
                    <span class="n">areas</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">island_poly</span><span class="p">)</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>

        <span class="c1"># It should be masked where area is max</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">amask</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">areas</span><span class="p">)]:</span> <span class="n">ni</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">amask</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">areas</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">jmin</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span> <span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span> <span class="o">=</span> <span class="n">amask</span>

    <span class="nb">print</span> <span class="s1">&#39;Masked </span><span class="si">%i</span><span class="s1"> islands&#39;</span> <span class="o">%</span> <span class="n">ni</span>
    <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="check_poly_straits"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.check_poly_straits">[docs]</a><span class="k">def</span> <span class="nf">check_poly_straits</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">dcell</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=.</span><span class="mi">75</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that straits are opened by counting the number of polygon intersection in each cell and the area of water</span>

<span class="sd">    - **mask**: The initial mask. A cdms variable with X (longitude) and Y (latitude).</span>
<span class="sd">    - **polys**: Coastal polygons.</span>
<span class="sd">    - *dcell*: dx and dy relative extension from the center of the cell in resolution units.</span>
<span class="sd">    - *threshold*: Maximal fraction of cell area that must be covered of land (&gt; .5) [default: .25]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get mask and axes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gg</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Get cell bounds</span>
    <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">bounds2d</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span>  <span class="n">bounds2d</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

    <span class="c1"># Loop on coastal points</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">get_coastal_indices</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>

        <span class="c1"># Cell polygon</span>
        <span class="n">cell_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xxb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">yyb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">cell_area</span> <span class="o">=</span> <span class="n">cell_poly</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>

        <span class="c1"># Count polygon intersections</span>
        <span class="n">npoly</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">area</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">cell_poly</span><span class="p">):</span>
                <span class="n">intersections</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cell_poly</span><span class="p">)</span>
                <span class="n">npoly</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersections</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="n">intersections</span><span class="p">:</span>
                    <span class="n">area</span> <span class="o">+=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Several polygons = strait, so open</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">npoly</span> <span class="o">&lt;</span> <span class="mi">2</span>

    <span class="nb">print</span> <span class="s1">&#39;Opened </span><span class="si">%i</span><span class="s1"> straits&#39;</span> <span class="o">%</span><span class="n">ns</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="t2uvmasks"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.t2uvmasks">[docs]</a><span class="k">def</span> <span class="nf">t2uvmasks</span><span class="p">(</span><span class="n">tmask</span><span class="p">,</span> <span class="n">getu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compoute masks at U and V points from a mask at T points on a C grid (True is land)</span>

<span class="sd">    - **tmask**: A 2D mask.</span>
<span class="sd">    - *getu*: Get the mask at U-points</span>
<span class="sd">    - *getv*: Get the mask at V-points</span>

<span class="sd">    Return umask,vmask OR umask OR vmask depending on getu and getv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">getu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">getv</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">getu</span><span class="p">:</span>
        <span class="n">umask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmask</span><span class="p">)</span> <span class="c1"># copy</span>
        <span class="n">umask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">tmask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getv</span><span class="p">:</span> <span class="k">return</span> <span class="n">umask</span>
    <span class="n">vmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmask</span><span class="p">)</span>
    <span class="n">vmask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">|</span> <span class="n">tmask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">getu</span><span class="p">:</span> <span class="k">return</span> <span class="n">vmask</span>
    <span class="k">return</span> <span class="n">umask</span><span class="p">,</span> <span class="n">vmask</span></div>

<div class="viewcode-block" id="mask2d"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.mask2d">[docs]</a><span class="k">def</span> <span class="nf">mask2d</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a 3(or more)-D mask to 2D by performing compression on first axes</span>

<span class="sd">    .. note::</span>

<span class="sd">        Mask is False on ocean</span>

<span class="sd">    - **mask**: At least 2D mask</span>
<span class="sd">    - *method*: Compression method</span>

<span class="sd">        - ``&quot;and&quot;``: Only one point must be unmask to get the compressed dimension unmasked.</span>
<span class="sd">        - ``&quot;or&quot;``: All points must be unmask to get the compressed dimension unmasked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Mask must be at leat 2D&#39;</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">mask</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_or</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span>
    <span class="k">while</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_old_rsamp_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmean</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getmask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Undersample data points using a radius of proximity</span>

<span class="sd">    - **x**: 1D x array.</span>
<span class="sd">    - **y**: 1D Y array.</span>
<span class="sd">    - **r**: Radius of proximity.</span>
<span class="sd">    - *z*: 1D Z array.</span>
<span class="sd">    - *proj*: Geographic projection instance to convert coordinates.</span>
<span class="sd">    - *method*:</span>

<span class="sd">        - ``mean``: Average neighbouring points.</span>
<span class="sd">        - ``pickup``: Pickup only the current point within the circle of proximity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Need numpy arrays</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getmask</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dst</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">rmean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rmean</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="c1"># Projection</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Loop on valid points</span>
    <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">good</span><span class="p">[</span><span class="n">i0</span><span class="p">]:</span> <span class="k">continue</span>
        <span class="c1"># Search for neighbours</span>
        <span class="n">dst</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">close</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">&lt;</span> <span class="n">r</span>
        <span class="c1"># Average over neighbours</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rmean</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">zclose</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">close</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zclose</span><span class="p">[</span><span class="n">dst</span><span class="p">[</span><span class="n">close</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">*</span><span class="n">rmean</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">zclose</span>
        <span class="c1"># Neighbours no longer valid</span>
        <span class="n">good</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">close</span>
        <span class="n">good</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">del</span> <span class="n">dst</span><span class="p">,</span> <span class="n">close</span>
    <span class="c1"># Only the mask</span>
    <span class="k">if</span> <span class="n">getmask</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">good</span>
    <span class="c1"># Select valid points</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">z</span><span class="p">[</span><span class="n">good</span><span class="p">],</span>
    <span class="k">del</span> <span class="n">good</span>
    <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="rsamp"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.rsamp">[docs]</a><span class="k">def</span> <span class="nf">rsamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmean</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rblock</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">getmask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Undersample data points using a radius of proximity</span>

<span class="sd">    - **x**: 1D x array.</span>
<span class="sd">    - **y**: 1D Y array.</span>
<span class="sd">    - **r**: Radius of proximity.</span>
<span class="sd">    - *z*: 1D Z array.</span>
<span class="sd">    - *proj*: Geographic projection instance to convert coordinates.</span>
<span class="sd">    - *rmean*: Radius of averaging relative to ``r`` (``0&lt;rmean&lt;1``)</span>
<span class="sd">    - *rblock*: Size of blocks relative to ``r`` for computation by blocks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Need numpy arrays</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getmask</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">rmean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rmean</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">rblock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rblock</span><span class="p">))</span>

    <span class="c1"># Projection</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Setup blocks</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span> <span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
    <span class="n">xmin</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">001</span><span class="o">*</span><span class="n">dx</span> <span class="p">;</span> <span class="n">xmax</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">001</span><span class="o">*</span><span class="n">dx</span>
    <span class="n">ymin</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">001</span><span class="o">*</span><span class="n">dy</span> <span class="p">;</span> <span class="n">ymax</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">001</span><span class="o">*</span><span class="n">dy</span>
    <span class="n">nxb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">rblock</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">nyb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">rblock</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">rblock</span> <span class="o">*=</span> <span class="n">r</span>
    <span class="n">xgood</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>

    <span class="c1"># Loop on x bands</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">xmin</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="n">rblock</span>
    <span class="k">for</span> <span class="n">ixb</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nxb</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">+=</span> <span class="n">rblock</span><span class="o">-</span><span class="n">r</span>
        <span class="k">if</span> <span class="n">ixb</span> <span class="o">==</span> <span class="n">nxb</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">xmax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">rblock</span>
        <span class="n">xgood</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="n">x0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="n">x1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xgood</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="k">continue</span>

        <span class="c1"># Loop on y bands</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">ymin</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="n">rblock</span>
        <span class="k">for</span> <span class="n">iyb</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nyb</span><span class="p">):</span>
            <span class="n">y0</span> <span class="o">+=</span> <span class="n">rblock</span><span class="o">-</span><span class="n">r</span>
            <span class="k">if</span> <span class="n">iyb</span> <span class="o">==</span> <span class="n">nyb</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">ymax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">rblock</span>

            <span class="c1"># Select the block</span>
            <span class="n">block</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">xgood</span><span class="o">&amp;</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;=</span><span class="n">y0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">y</span><span class="o">&lt;=</span><span class="n">y1</span><span class="p">)</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nn</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zz</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">good</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>

            <span class="c1"># Loop on valid points</span>
            <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">gg</span><span class="p">[</span><span class="n">i0</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="c1"># Search for neighbours</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xx</span><span class="o">-</span><span class="n">xx</span><span class="p">[</span><span class="n">i0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">yy</span><span class="p">[</span><span class="n">i0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">close</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">&lt;</span> <span class="n">r</span>
                <span class="c1"># Average over neighbours</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rmean</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
                    <span class="n">zclose</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="n">close</span><span class="p">]</span>
                    <span class="n">zz</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zclose</span><span class="p">[</span><span class="n">dst</span><span class="p">[</span><span class="n">close</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">*</span><span class="n">rmean</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">zclose</span>
                <span class="c1"># Neighbours no longer valid</span>
                <span class="n">gg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">close</span>
                <span class="n">gg</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># del</span>
                <span class="k">del</span> <span class="n">dst</span><span class="p">,</span> <span class="n">close</span>

            <span class="c1"># Store results</span>
            <span class="n">good</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">gg</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">zz</span>
                <span class="k">del</span> <span class="n">zz</span>
            <span class="k">del</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">gg</span>
    <span class="c1"># Only the mask</span>
    <span class="k">if</span> <span class="n">getmask</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">good</span>
    <span class="c1"># Select valid points</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">z</span><span class="p">[</span><span class="n">good</span><span class="p">],</span>
    <span class="k">del</span> <span class="n">good</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="zcompress"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.zcompress">[docs]</a><span class="k">def</span> <span class="nf">zcompress</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">xy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compress 1D arrays according to the mask of the first one</span>

<span class="sd">    - **z**: Reference (masked) array</span>
<span class="sd">    - *xy*: Additional arrays to be compressed</span>
<span class="sd">    - *numpify*: Force convertion to numpy array</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; z, x, y = zcompress(z, x, y, numpify=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
        <span class="n">good</span> <span class="o">=</span> <span class="o">~</span><span class="n">z</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">npf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numpify&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">)</span><span class="o">+</span><span class="n">xy</span><span class="p">:</span>
            <span class="c1"># Compress</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">newvar</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newvar</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">asma</span><span class="p">()[</span><span class="n">good</span><span class="p">])</span>
                <span class="n">cp_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">newvar</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Numpify</span>
            <span class="k">if</span> <span class="n">npf</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;filled&#39;</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">newvar</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span>
                <span class="k">del</span> <span class="n">newvar</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">newvar</span><span class="p">,</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">z</span><span class="p">,</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">xy</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="resol_mask"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.resol_mask">[docs]</a><span class="k">def</span> <span class="nf">resol_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xrelres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yrelres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">relres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relmargin</span><span class="o">=.</span><span class="mi">05</span><span class="p">,</span> <span class="n">nauto</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a mask based on resolution criteria for undersampling 2D data</span>

<span class="sd">    :Params:</span>
<span class="sd">        - **grid**: A cdms array with a grid, a cdms grid or a tuple of axes.</span>
<span class="sd">        - **res**, optional: Horizontal resolution of arrows</span>
<span class="sd">            (in both directions) for undersampling [default: ``None``].</span>
<span class="sd">            If ``&#39;auto&#39;``, resolution is computed so as to have at max ``nauto``</span>
<span class="sd">            arrow in along an axis. If it is a :class:`complex` type, its imaginary part</span>
<span class="sd">            set the ``nauto`` parameter and ``res`` is set to ``&#39;auto&#39;``.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                Use of ``res`` makes the supposition that X and y units are consistent.</span>

<span class="sd">        - **xres**, optional: Same along X [default: ``res``]</span>
<span class="sd">        - **yres**, optional: Same along Y [default: ``res``]</span>
<span class="sd">        - **relres**, optional: Relative resolution</span>
<span class="sd">            (in both directions).</span>

<span class="sd">            - If &gt; 0, = ``median(res)*relres``.</span>
<span class="sd">            - If &lt; -1, =``min(res)*abs(relres)``.</span>
<span class="sd">            - If &lt; 0 and &gt; -1, =max(res)*abs(relres)</span>

<span class="sd">        - **xrelres**, optional: Same along X [default: ``relres``]</span>
<span class="sd">        - **yrelres**, optional: Same along Y [default: ``relres``]</span>
<span class="sd">        - **scaler**, optional: A callable object that transform X and Y coordinates.</span>
<span class="sd">          Transformed coordinates are used instead of original coordinates</span>
<span class="sd">          if resolutions are negatives.</span>
<span class="sd">          A typical scaler is for example a geographic projection that convert degrees</span>
<span class="sd">          to meters (like a :class:`~mpl_toolkits.basemap.Basemap` instance).</span>

<span class="sd">        - **compact**, optional: If no unsersampling is efective, returns ``False``.</span>

<span class="sd">    .. note:: A resolution value set to ``False`` implies no undersampling.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; mask = resol_mask((x2d, y2d), relres=2.5) # sampling=2.5</span>
<span class="sd">        &gt;&gt;&gt; mask = resol_mask(var.getGrid(), xres=2., scaler=mymap, yres=-100.) # 100m</span>
<span class="sd">        &gt;&gt;&gt; mask = resol_mask(var.getGrid(), res=20j) # at max 20 arrows per axis</span>
<span class="sd">        &gt;&gt;&gt; mask = resol_mask(var.getGrid(), res=&#39;auto&#39;, nauto=20) # equivalent</span>

<span class="sd">    .. note::</span>

<span class="sd">        It is usually better to regrid with a convenient method</span>
<span class="sd">        instead of unsersample because of aliasing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Params</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">complex</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nauto</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nauto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nauto</span> <span class="o">=</span> <span class="mi">20</span>


    <span class="c1"># Get numeric axes</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Scaler</span>
    <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">scaler</span><span class="p">):</span>
        <span class="n">xxs</span><span class="p">,</span> <span class="n">yys</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xxs</span><span class="p">,</span> <span class="n">yys</span> <span class="o">=</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>

    <span class="c1"># Guess reference resolution</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">if</span> <span class="n">relres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xrelres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xrelres</span> <span class="o">=</span> <span class="n">relres</span>
        <span class="k">if</span> <span class="n">yrelres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yrelres</span> <span class="o">=</span> <span class="n">relres</span>
    <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">xrelres</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">xrelres</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">yrelres</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">yrelres</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">xrelres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">yrelres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">xmode</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span>
        <span class="n">ymode</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span>
        <span class="k">if</span> <span class="n">xrelres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xrelres</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">xmode</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
            <span class="k">elif</span> <span class="n">xrelres</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xmode</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
        <span class="k">if</span> <span class="n">yrelres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yrelres</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ymode</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
            <span class="k">elif</span> <span class="n">yrelres</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ymode</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
        <span class="n">xr</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">xmode</span><span class="p">)</span> <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xres</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">ymode</span><span class="p">)</span> <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">yres</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xres</span><span class="o">/</span><span class="n">yres</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># similar coordinates</span>
            <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">resol</span><span class="p">(</span><span class="n">xxs</span><span class="p">,</span> <span class="n">yys</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="n">xmode</span><span class="p">,</span> <span class="n">ymode</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="o">-</span><span class="n">xr</span>
            <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="o">-</span><span class="n">yr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">xr</span>
            <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">yr</span>
    <span class="n">x2d</span> <span class="o">=</span> <span class="n">y2d</span> <span class="o">=</span> <span class="n">xbres</span> <span class="o">=</span> <span class="n">ybres</span> <span class="o">=</span> <span class="n">xcres</span> <span class="o">=</span> <span class="n">ycres</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">xres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span> <span class="ow">or</span> <span class="n">yres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">x2d</span> <span class="o">=</span> <span class="n">xxs</span>
        <span class="n">y2d</span> <span class="o">=</span> <span class="n">yys</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x2d</span> <span class="o">=</span> <span class="n">xx</span> <span class="k">if</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">xxs</span>
        <span class="n">y2d</span> <span class="o">=</span> <span class="n">yy</span> <span class="k">if</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">yys</span>
    <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">yres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xbres</span><span class="p">,</span> <span class="n">ybres</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">resol</span><span class="p">((</span><span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span> <span class="ow">or</span> <span class="n">yres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">xcres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">xbres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ycres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ybres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xares</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">xcres</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">nauto</span>
        <span class="n">yares</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">ycres</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">nauto</span>
        <span class="n">xres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xares</span><span class="p">,</span> <span class="n">yares</span><span class="p">)</span>
<span class="c1">#    else:</span>
<span class="c1">#        x2d = y2d = xbres = ybres = xcres = ycres = None</span>

    <span class="c1"># Resolution along X</span>
    <span class="k">if</span> <span class="n">xres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">xres</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">if</span> <span class="n">xres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># From absolute resolution</span>
        <span class="k">if</span> <span class="n">xrelres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xrelres</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">xbres</span> <span class="o">/=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xres</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xrelres</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">xcres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xcres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">xbres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xcres</span> <span class="o">/=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xres</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xrelres</span><span class="p">))</span>
            <span class="n">xcres</span> <span class="o">=</span> <span class="n">xcres</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">xdres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xcres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">xmask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">xmask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcres</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">xmask</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xdres</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">xmask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">xbres</span><span class="o">&lt;=</span><span class="mi">1</span><span class="o">-</span><span class="n">relmargin</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">xcres</span><span class="p">,</span> <span class="n">xdres</span><span class="p">,</span> <span class="n">xbres</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Resolution along Y</span>
    <span class="k">if</span> <span class="n">yres</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">yres</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">if</span> <span class="n">yres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># From absolute resolution</span>
        <span class="k">if</span> <span class="n">yrelres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yrelres</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">ybres</span> <span class="o">/=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yres</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yrelres</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ycres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ycres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ybres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ycres</span> <span class="o">/=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yres</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yrelres</span><span class="p">))</span>
            <span class="n">ycres</span> <span class="o">=</span> <span class="n">ycres</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">ydres</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ycres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ymask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">ymask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ymask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ycres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ymask</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ydres</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ymask</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ybres</span><span class="o">&lt;=</span><span class="mi">1</span><span class="o">-</span><span class="n">relmargin</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ycres</span><span class="p">,</span> <span class="n">ydres</span><span class="p">,</span> <span class="n">ybres</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ymask</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="k">return</span> <span class="n">xmask</span> <span class="o">|</span> <span class="n">ymask</span></div>

<div class="viewcode-block" id="get_avail_rate"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.get_avail_rate">[docs]</a><span class="k">def</span> <span class="nf">get_avail_rate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rate&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the availability rate of a masked array along its forst dimension</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: Mask or masked array.</span>
<span class="sd">        - **num**, optional: Get result as pure numpy array or formatted</span>
<span class="sd">          as input array when possible (MV2 array).</span>
<span class="sd">        - **mode**, optional:</span>

<span class="sd">            - &quot;rate&quot;: Output is between 0 and 1.</span>
<span class="sd">            - &quot;pct&quot;: Same but in percents from 0 to 100.</span>
<span class="sd">            - &quot;count&quot;: Count valid data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>

    <span class="c1"># Count</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;rate&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;pct&#39;</span><span class="p">:</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;pct&#39;</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">*=</span> <span class="mi">100</span>

    <span class="c1"># Format?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">num</span> <span class="ow">and</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span>
            <span class="n">rate</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Availability rate&#39;</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;pct&#39;</span><span class="p">:</span>
            <span class="n">rate</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Availability rate&#39;</span>
            <span class="n">rate</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Number of valid data&#39;</span>

    <span class="k">return</span> <span class="n">rate</span></div>


<div class="viewcode-block" id="merge_masks"><a class="viewcode-back" href="../../../../library/misc.grid.masking.html#vacumm.misc.grid.masking.merge_masks">[docs]</a><span class="k">def</span> <span class="nf">merge_masks</span><span class="p">(</span><span class="n">varlist</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge the mask of a list of variable&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varlist</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="n">varlist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">varlist</span>
    <span class="n">varlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">varlist</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">opname</span> <span class="o">=</span> <span class="s1">&#39;__or__&#39;</span> <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;max&#39;</span> <span class="k">else</span> <span class="s1">&#39;__and__&#39;</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">assert</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;All arrays must have the same shape&#39;</span>
        <span class="n">thismask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">opname</span><span class="p">)(</span><span class="n">thismask</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Not a masked array, thus cannot apply a mask without copy&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="kn">import</span> <span class="nn">misc</span> <span class="k">as</span> <span class="nn">M</span>
<span class="kn">from</span> <span class="nn">...misc.axes</span> <span class="k">import</span> <span class="n">islon</span><span class="p">,</span> <span class="n">islat</span>
<span class="kn">from</span> <span class="nn">...misc.phys.units</span> <span class="k">import</span> <span class="n">deg2m</span>
<span class="kn">from</span> <span class="nn">...misc.io</span> <span class="k">import</span> <span class="n">Shapes</span>
<span class="kn">from</span> <span class="nn">.basemap</span> <span class="k">import</span> <span class="n">GSHHS_BM</span><span class="p">,</span> <span class="n">get_proj</span>
<span class="kn">from</span> <span class="nn">...misc.misc</span> <span class="k">import</span> <span class="n">cp_atts</span><span class="p">,</span> <span class="n">kwfilter</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>