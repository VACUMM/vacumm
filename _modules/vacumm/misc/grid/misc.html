
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.misc.grid.misc &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../../index.html"><img src="../../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.misc.grid.misc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Grid utilities.</span>

<span class="sd">It deals with bounds, areas, interpolations...</span>

<span class="sd">See: :ref:`user.tut.misc.grid`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2018)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>


<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">gc</span> <span class="k">import</span> <span class="n">collect</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span><span class="o">,</span> <span class="nn">MV2</span> <span class="o">,</span><span class="nn">cdms2</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">ma</span> <span class="k">as</span> <span class="n">MA</span>
<span class="kn">from</span> <span class="nn">cdms2.coord</span> <span class="k">import</span> <span class="n">TransientAxis2D</span><span class="p">,</span> <span class="n">TransientVirtualAxis</span><span class="p">,</span> <span class="n">FileAxis2D</span>
<span class="kn">from</span> <span class="nn">cdms2.auxcoord</span> <span class="k">import</span> <span class="n">TransientAuxAxis1D</span>
<span class="kn">from</span> <span class="nn">cdms2.axis</span> <span class="k">import</span> <span class="n">TransientAxis</span>
<span class="kn">from</span> <span class="nn">cdms2.hgrid</span> <span class="k">import</span> <span class="n">AbstractCurveGrid</span><span class="p">,</span> <span class="n">TransientCurveGrid</span>
<span class="kn">from</span> <span class="nn">cdms2.grid</span> <span class="k">import</span> <span class="n">AbstractGrid</span><span class="p">,</span> <span class="n">AbstractRectGrid</span>
<span class="kn">from</span> <span class="nn">cdms2.gengrid</span> <span class="k">import</span> <span class="n">AbstractGenericGrid</span><span class="p">,</span> <span class="n">TransientGenericGrid</span>
<span class="kn">from</span> <span class="nn">genutil</span> <span class="k">import</span> <span class="n">minmax</span>
<span class="n">cdms</span> <span class="o">=</span> <span class="n">cdms2</span>
<span class="n">MV</span> <span class="o">=</span> <span class="n">MV2</span>

<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">_geoslib</span> <span class="k">import</span> <span class="n">Point</span>

<span class="n">isseq</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">isSequenceType</span>
<span class="n">isnum</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">isNumberType</span>
<span class="n">isdic</span><span class="o">=</span> <span class="n">ismap</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">isMappingType</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;isoslice&#39;</span><span class="p">,</span><span class="s1">&#39;isgrid&#39;</span><span class="p">,</span> <span class="s1">&#39;get_resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;get_distances&#39;</span><span class="p">,</span> <span class="s1">&#39;get_closest&#39;</span><span class="p">,</span> <span class="s1">&#39;get_closest_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;get_geo_area&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bounds2d&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds1d&#39;</span><span class="p">,</span> <span class="s1">&#39;get_axis&#39;</span><span class="p">,</span> <span class="s1">&#39;get_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;get_grid_axes&#39;</span><span class="p">,</span> <span class="s2">&quot;gridsel&quot;</span><span class="p">,</span>
    <span class="s1">&#39;grid2d&#39;</span><span class="p">,</span> <span class="s1">&#39;num2axes2d&#39;</span><span class="p">,</span> <span class="s1">&#39;var2d&#39;</span><span class="p">,</span> <span class="s1">&#39;axis1d_from_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;get_xy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;deg2xy&#39;</span><span class="p">,</span> <span class="s1">&#39;set_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;check_xy_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;axes2d&#39;</span><span class="p">,</span> <span class="s1">&#39;meshgrid&#39;</span><span class="p">,</span><span class="s1">&#39;meshbounds&#39;</span><span class="p">,</span> <span class="s1">&#39;meshweights&#39;</span><span class="p">,</span>
    <span class="s1">&#39;t2uvgrids&#39;</span><span class="p">,</span> <span class="s1">&#39;meshcells&#39;</span><span class="p">,</span> <span class="s1">&#39;cells2grid&#39;</span><span class="p">,</span> <span class="s1">&#39;curv_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds2mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;resol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;isregular&#39;</span><span class="p">,</span> <span class="s1">&#39;monotonic&#39;</span><span class="p">,</span> <span class="s1">&#39;transect_specs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;depth2dz&#39;</span><span class="p">,</span> <span class="s1">&#39;isdepthup&#39;</span><span class="p">,</span> <span class="s1">&#39;makedepthup&#39;</span><span class="p">,</span> <span class="s1">&#39;makealtitudeup&#39;</span><span class="p">,</span> <span class="s1">&#39;dz2depth&#39;</span><span class="p">,</span> <span class="s1">&#39;get_axis_slices&#39;</span><span class="p">,</span>
    <span class="s1">&#39;xextend&#39;</span><span class="p">,</span> <span class="s1">&#39;xshift&#39;</span><span class="p">,</span> <span class="s1">&#39;curv2rect&#39;</span><span class="p">,</span>  <span class="s1">&#39;isrect&#39;</span><span class="p">,</span> <span class="s1">&#39;create_grid2d&#39;</span><span class="p">,</span> <span class="s1">&#39;create_var2d&#39;</span><span class="p">,</span> <span class="s1">&#39;create_axes2d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;merge_axis_slice&#39;</span><span class="p">,</span> <span class="s1">&#39;merge_axis_slices&#39;</span><span class="p">,</span> <span class="s1">&#39;get_zdim&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2slice&#39;</span><span class="p">,</span> <span class="s1">&#39;mask2ind&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_aux_axes&#39;</span><span class="p">,</span> <span class="s1">&#39;create_ugrid&#39;</span><span class="p">,</span> <span class="s1">&#39;istri&#39;</span><span class="p">,</span> <span class="s1">&#39;get_tri&#39;</span><span class="p">,</span>
    <span class="s1">&#39;varsel&#39;</span><span class="p">,</span> <span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="s1">&#39;create_curv_grid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;issgrid&#39;</span><span class="p">,</span> <span class="s1">&#39;isugrid&#39;</span><span class="p">,</span> <span class="s1">&#39;get_grid_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_unstruct_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;GriddedSelector&#39;</span><span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>



<div class="viewcode-block" id="isoslice"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isoslice">[docs]</a><span class="k">def</span> <span class="nf">isoslice</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">prop</span><span class="p">,</span><span class="n">isoval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">masking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    result = isoslice(variable,property[,isoval=0])</span>

<span class="sd">    result is a a projection of variable at property == isoval in the first</span>
<span class="sd">    nonsingleton dimension.  In the case when there is more than one zero</span>
<span class="sd">    crossing, the results are averaged.</span>

<span class="sd">    EXAMPLE:</span>
<span class="sd">    Assume two three dimensional variable, s (salt), z (depth), and</span>
<span class="sd">    u (velicity), all on the same 3D grid.  x and y are the horizontal</span>
<span class="sd">    positions, with the same horizontal dimensions as z (the 3D depth</span>
<span class="sd">    field).  Here, assume the vertical dimension, that will be projected,</span>
<span class="sd">    is the first.</span>

<span class="sd">    s_at_m5  = isoslice(s,z,-5);        # s at z == -5</span>
<span class="sd">    h_at_s30 = isoslice(z,s,30);       # z at s == 30</span>
<span class="sd">    u_at_s30 = isoslice(u,s,30);       # u at s == 30</span>

<span class="sd">    Get from OCTANT library : https://github.com/hetland/octant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;variable must have at least two dimensions&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;dimension of var and prop must be identical&#39;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="o">-</span><span class="n">isoval</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#find zero-crossings (zc == 1)</span>
    <span class="n">zc</span> <span class="o">=</span>  <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">prop</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*</span><span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:])</span><span class="o">&lt;</span><span class="mf">0.0</span> <span class="p">,</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">varl</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*</span><span class="n">zc</span>
    <span class="n">varh</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">*</span><span class="n">zc</span>
    <span class="n">propl</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*</span><span class="n">zc</span>
    <span class="n">proph</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">*</span><span class="n">zc</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">varl</span> <span class="o">-</span> <span class="n">propl</span><span class="o">*</span><span class="p">(</span><span class="n">varh</span><span class="o">-</span><span class="n">varl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">proph</span><span class="o">-</span><span class="n">propl</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">zc</span><span class="o">==</span><span class="mf">1.</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">szc</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">szc</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">szc</span><span class="o">==</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">szc</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">szc</span>
    <span class="k">if</span> <span class="n">masking</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">,</span> <span class="s1">&#39;property==</span><span class="si">%f</span><span class="s1"> out of range (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">isoval</span><span class="p">,</span> <span class="p">(</span><span class="n">prop</span><span class="o">+</span><span class="n">isoval</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="p">(</span><span class="n">prop</span><span class="o">+</span><span class="n">isoval</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_grid_type"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_grid_type">[docs]</a><span class="k">def</span> <span class="nf">get_grid_type</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the grid type as one of &quot;rect&quot;, &quot;curv&quot;, &quot;unstruct&quot; or None&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">AbstractRectGrid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;rect&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">AbstractCurveGrid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;curv&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">AbstractGenericGrid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;unstruct&quot;</span></div>


<div class="viewcode-block" id="isgrid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isgrid">[docs]</a><span class="k">def</span> <span class="nf">isgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if gg is a grid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A cdms grid.</span>
<span class="sd">        - **gtype**, optional, strings, None: Grid type as one of &quot;rect&quot;,</span>
<span class="sd">          &quot;curv&quot;, &quot;unstruct&quot;. Prepend a &quot;-&quot; to inverse the test. You can also</span>
<span class="sd">          provide a list of choices.</span>
<span class="sd">        - **curv**, optional: If True, restrict to curvilinear grids. DEPRECATED</span>

<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; isgrid(grid) # is it a grid?</span>
<span class="sd">    &gt;&gt;&gt; isgrid(grid, &quot;curv&quot;) # is a curved grid?</span>
<span class="sd">    &gt;&gt;&gt; isgrid(grid, &quot;-curv&quot;) # is a grid but not a curved grid?</span>
<span class="sd">    &gt;&gt;&gt; isgrid(grid, [&quot;rect&quot;, &quot;unstruct&quot;]) # is a rectangular or unstructured grid?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">curv</span><span class="p">:</span>
        <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;curv&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gtype</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="n">get_grid_type</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">check_case</span><span class="p">(</span><span class="n">gtype</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="issgrid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.issgrid">[docs]</a><span class="k">def</span> <span class="nf">issgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a grid in structured&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="isugrid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isugrid">[docs]</a><span class="k">def</span> <span class="nf">isugrid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a grid in unstructured&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_resolution"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_resolution">[docs]</a><span class="k">def</span> <span class="nf">get_resolution</span><span class="p">(</span><span class="n">mygrid</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">lat_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the mean resolution of a grid</span>

<span class="sd">    .. warning:: Deprecated: please use :meth:`resol` instead.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mygrid</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mygrid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">mygrid</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mygrid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">mygrid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">mygrid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mygrid</span><span class="o">.</span><span class="n">getMask</span><span class="p">()</span>

    <span class="c1"># Work on 2D arrays</span>
    <span class="k">if</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1"># Initial mask</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="n">MA</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mf">999.</span><span class="p">,</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mf">999.</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1"># Geographic selection mask</span>
    <span class="k">if</span> <span class="n">lon_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_lon</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lon_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">N</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lon_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="n">MA</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_lon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">mask_lon</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lat_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_lat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">N</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="n">MA</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_lat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">mask_lon</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mf">999.</span><span class="p">,</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mf">999.</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1"># Select valid data</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="n">MA</span><span class="o">.</span><span class="n">nomask</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">compress</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">compress</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">lat</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Compute areas</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">xx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">yy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span>
    <span class="k">del</span> <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span>
    <span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Return mean resolution</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_distances"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_distances">[docs]</a><span class="k">def</span> <span class="nf">get_distances</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span> <span class="n">yya</span><span class="p">,</span> <span class="n">xxb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yyb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pairwise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the distances (in m) between a series of points</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xxa**: X coordinate of the first series</span>
<span class="sd">        - **yya**: Y //</span>
<span class="sd">        - **xxb**: X coordinate of the second series</span>
<span class="sd">        - **yyb**: Y //</span>
<span class="sd">        - **mode**, optional: distance computation mode</span>

<span class="sd">            - ``None``: use ``&quot;harversine&quot;`` if longitude and latitude axes</span>
<span class="sd">              else ``&quot;direct&quot;``</span>
<span class="sd">            - ``&quot;simple&quot;`` or ``&quot;euclidian&quot;`` or ``&quot;meters&quot;``: simple euclidian distance with no coordinate</span>
<span class="sd">              tranformation</span>
<span class="sd">            - ``&quot;harversine&quot;`` or ``&quot;sphere&quot;`` or ``&quot;degrees&quot;``: great circle distance in meters from</span>
<span class="sd">              coordinates in degrees</span>
<span class="sd">            - ``&quot;deg2m&quot;``: euclidian distance with coordinates converted</span>
<span class="sd">              from degrees to meters using :func:`~vacumm.misc.phys.units.deg2m`.</span>
<span class="sd">            - A callable object like a function that directly compute distance</span>
<span class="sd">              from coordinates::</span>

<span class="sd">                mode(xxa, yya, xxb, yyb)</span>

<span class="sd">        - **pairwise**, optional: The distances between A and B points are</span>
<span class="sd">          computed pairwise. There must have the same number of A and B points.</span>

<span class="sd">    :Return: Distances as an ``(nb,na)`` array if pairwise if false,</span>
<span class="sd">        else a ``(na,)`` array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Mode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;haversine&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">islon</span><span class="p">(</span><span class="n">xxa</span><span class="p">)</span> <span class="ow">or</span> <span class="n">islon</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">islat</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span> <span class="ow">or</span> <span class="n">islat</span><span class="p">(</span><span class="n">yyb</span><span class="p">))</span> <span class="k">else</span> <span class="s2">&quot;simple&quot;</span>
        <span class="k">if</span> <span class="n">geo</span><span class="p">:</span> <span class="c1"># backward compat</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;haversine&#39;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">valid_modes</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;haversine&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;deg2m&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="s1">&#39;euclidian&#39;</span><span class="p">,</span> <span class="s1">&#39;meters&#39;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Wrong mode (</span><span class="si">{}</span><span class="s1">). Please choose one of: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_modes</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s2">&quot;degrees&quot;</span><span class="p">]:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;harversine&#39;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meters&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidian&quot;</span><span class="p">]:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span>

    <span class="c1"># With what</span>
    <span class="k">if</span> <span class="n">xxb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xxb</span> <span class="o">=</span> <span class="n">xxa</span>
    <span class="k">if</span> <span class="n">yyb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">yya</span>

    <span class="c1"># Numerical types</span>
    <span class="n">Nma</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span> <span class="n">yya</span><span class="p">)</span>
    <span class="n">Nmb</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span> <span class="n">xxb</span><span class="p">)</span>
    <span class="n">nma</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xxa</span><span class="p">)</span> <span class="ow">and</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span> <span class="k">else</span> <span class="n">Nma</span>
    <span class="n">nmb</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span> <span class="ow">and</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">yyb</span><span class="p">)</span> <span class="k">else</span> <span class="n">Nmb</span>
    <span class="k">if</span> <span class="n">MV2</span> <span class="ow">is</span> <span class="n">Nma</span> <span class="ow">or</span> <span class="n">MV2</span> <span class="ow">is</span> <span class="n">Nmb</span><span class="p">:</span>
        <span class="n">Nm</span> <span class="o">=</span> <span class="n">MV2</span>
    <span class="k">elif</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span> <span class="ow">is</span> <span class="n">Nma</span> <span class="ow">or</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span> <span class="ow">is</span> <span class="n">Nmb</span><span class="p">:</span>
        <span class="n">Nm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Nm</span> <span class="o">=</span> <span class="n">N</span>

    <span class="c1"># Make sur to have arrays</span>
    <span class="n">oldshapea</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xxa</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xxa</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span>
    <span class="n">oldshapeb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">yyb</span><span class="p">)</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">yyb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">xxa</span><span class="p">):</span>
        <span class="n">xxa</span> <span class="o">=</span> <span class="n">xxa</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
        <span class="n">yya</span> <span class="o">=</span> <span class="n">yya</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xxa</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xxa</span><span class="p">)</span>
        <span class="n">yya</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">xxb</span><span class="p">):</span>
        <span class="n">xxb</span> <span class="o">=</span> <span class="n">xxb</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
        <span class="n">yyb</span> <span class="o">=</span> <span class="n">yyb</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xxb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span>
        <span class="n">yyb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">yyb</span><span class="p">)</span>

    <span class="c1"># Reshape them</span>
    <span class="n">xxa</span> <span class="o">=</span> <span class="n">xxa</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">yya</span> <span class="o">=</span> <span class="n">yya</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">xxb</span> <span class="o">=</span> <span class="n">xxb</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">yyb</span> <span class="o">=</span> <span class="n">yyb</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairwise</span><span class="p">:</span>
        <span class="n">xxa</span><span class="p">,</span> <span class="n">xxb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span> <span class="n">xxb</span><span class="p">)</span>
        <span class="n">yya</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yya</span><span class="p">,</span> <span class="n">yyb</span><span class="p">)</span>

    <span class="c1"># Compute it</span>
<span class="c1">#    print &#39;coords&#39;, xxa, yya, xxb, yyb</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span> <span class="n">yya</span><span class="p">,</span> <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;deg2m&#39;</span><span class="p">:</span>
            <span class="n">xxa</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="n">yya</span><span class="p">)</span>
            <span class="n">yya</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">yya</span><span class="p">)</span>
            <span class="n">xxb</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="n">yyb</span><span class="p">)</span>
            <span class="n">yyb</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">yyb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;haversine&#39;</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">haversine</span><span class="p">(</span><span class="n">xxa</span><span class="p">,</span> <span class="n">yya</span><span class="p">,</span> <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">Nm</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xxa</span><span class="o">-</span><span class="n">xxb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yya</span><span class="o">-</span><span class="n">yyb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Reform</span>
    <span class="k">if</span> <span class="n">nma</span> <span class="ow">or</span> <span class="n">nmb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pairwise</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">oldshapea</span> <span class="ow">or</span> <span class="n">oldshapeb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">oldshapeb</span> <span class="o">+</span> <span class="n">oldshapea</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span></div>

<div class="viewcode-block" id="haversine"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.haversine">[docs]</a><span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the haversine distance for a known radius&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">radius</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EARTH_RADIUS</span>
    <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
        <span class="n">xa</span> <span class="o">*=</span> <span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="n">ya</span> <span class="o">*=</span> <span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="n">xb</span> <span class="o">*=</span> <span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="n">yb</span> <span class="o">*=</span> <span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="n">Nm</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Nm</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">ya</span><span class="o">-</span><span class="n">yb</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Nm</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nm</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nm</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">xa</span><span class="o">-</span><span class="n">xb</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">EARTH_RADIUS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Nm</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">Nm</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_closest"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_closest">[docs]</a><span class="k">def</span> <span class="nf">get_closest</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">gridded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the closest unmasked point on a grid and return indices</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xx**: 1D or 2D X axis, or random positions.</span>
<span class="sd">        - **yy**: 1D or 2D Y axis, or random positions.</span>
<span class="sd">        - **xp**: X position of the point (float)</span>
<span class="sd">        - **yp**: Y //</span>
<span class="sd">        - **geo**, optional: If True, force to treat the grid as geographical,</span>
<span class="sd">          thus convert coordinates to meters using</span>
<span class="sd">          :func:`~vacumm.misc.phys.units.deg2m`.</span>
<span class="sd">        - **gridded**, optional: Treat input as gridded points,</span>
<span class="sd">          otherwise treat them as random points (flatten ``xx`` and ``yy``).</span>

<span class="sd">    :Returns:</span>

<span class="sd">        - ``(i,j)`` 2-element tuple of indices along y and x for gridded data,</span>
<span class="sd">        - OR ``i`` if not gridded.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Longitude/Latitude grid?</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">isLongitude</span><span class="p">()</span> <span class="ow">and</span> <span class="n">yy</span><span class="o">.</span><span class="n">isLatitude</span><span class="p">():</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Gridded</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">[:])</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">[:])</span>
    <span class="k">if</span> <span class="n">gridded</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Geo grid distances</span>
    <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">))</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">)</span>
        <span class="n">xp</span><span class="p">,</span><span class="n">yp</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>

    <span class="c1"># Compute the distance to all grid points</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">xp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">yp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Find the smallest distance</span>
    <span class="n">imin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gridded</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">imin</span></div>

<div class="viewcode-block" id="get_closest_depth"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_closest_depth">[docs]</a><span class="k">def</span> <span class="nf">get_closest_depth</span><span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the closest unmasked point on a depth vector and return indices</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **zz**: 1D Z axis, or random positions.</span>
<span class="sd">        - **zp**: Z position of the point (float)</span>

<span class="sd">    :Returns:</span>

<span class="sd">        - ``(i,)`` 1-element tuple of indices along z for gridded data,</span>
<span class="sd">        - OR ``i`` if not gridded.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Gridded</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">zz</span><span class="p">[:])</span>

    <span class="c1"># Compute the distance to all grid points</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zz</span> <span class="o">-</span> <span class="n">zp</span><span class="p">)</span>

    <span class="c1"># Find the smallest distance</span>
    <span class="n">imin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imin</span></div>

<div class="viewcode-block" id="get_geo_area"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_geo_area">[docs]</a><span class="k">def</span> <span class="nf">get_geo_area</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute cell areas on the a regular geographical grid.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **grid** The grid</span>
<span class="sd">        - *mask*: Force the use of this mask</span>

<span class="sd">    :Returns: 2D array of areas in m^2</span>

<span class="sd">    .. TODO:: get_geo_area: treat 2D grid + use standard projection</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getMask</span><span class="p">()</span>


    <span class="n">latBounds</span><span class="p">,</span> <span class="n">lonBounds</span>  <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>

    <span class="n">latWeights</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">latBounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">latBounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">lonWeights</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">deg2m</span><span class="p">(</span><span class="n">lonBounds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lonBounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">outerproduct</span><span class="p">(</span><span class="n">latWeights</span><span class="p">,</span><span class="n">lonWeights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">area</span></div>


<div class="viewcode-block" id="isregular"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isregular">[docs]</a><span class="k">def</span> <span class="nf">isregular</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">tol</span><span class="o">=.</span><span class="mi">05</span><span class="p">,</span> <span class="n">iaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check is an 1S or 2D axis is regular</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **axis**: A :mod:`cdms2` axis or :mod:`numpy` array</span>
<span class="sd">        - **tol**, optional: Relative tolerance</span>
<span class="sd">        - **iaxis**, optional: On which direction to operate for 2D axis</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; isregular(lon1d, dx=2., tol=.01)</span>
<span class="sd">        &gt;&gt;&gt; isregular(lon2d, iaxis=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdaxis</span> <span class="o">=</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cdaxis</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">iaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cdaxis</span><span class="p">:</span>
            <span class="n">iaxis</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iaxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">islon</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
    <span class="n">thisdx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span>
    <span class="n">dxx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">thisdx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">thisdx</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">((</span><span class="n">dxx</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">%</span><span class="mf">1.</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span></div>


<div class="viewcode-block" id="bounds1d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.bounds1d">[docs]</a><span class="k">def</span> <span class="nf">bounds1d</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">cellwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute bounds on a linear sequence or axis.</span>
<span class="sd">    It is based on :func:`cdms2.genGenericBounds` of CDAT.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; bounds1d(xx).shape</span>
<span class="sd">        360, 2</span>

<span class="sd">    :Returns: xx(nx,2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">getValues</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">[:],</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">leftPoint</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">midArray</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">rightPoint</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">leftPoint</span><span class="p">,</span><span class="n">midArray</span><span class="p">,</span><span class="n">rightPoint</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">cellwidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">cellwidth</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">delta</span><span class="p">])</span>

    <span class="c1"># Transform to (n,2) array</span>
    <span class="n">retbnds</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">retbnds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">retbnds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">retbnds</span></div>



<div class="viewcode-block" id="bounds2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.bounds2d">[docs]</a><span class="k">def</span> <span class="nf">bounds2d</span><span class="p">(</span><span class="o">*</span><span class="n">xyaxes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute bounds on a rectangular grid.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xyaxes**: 2D arrays(ny,nx) (or 2x1D arrays)</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; xx_bounds,yy_bounds = bounds2d(xx,yy)</span>

<span class="sd">    :Returns: ``xx(ny,nx,4),...``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">quart</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyaxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">xyaxes</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">xyaxes</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">xyaxes</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="s1">&#39;getValue&#39;</span><span class="p">):</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">xy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;You must pass 2d arrays as argument&#39;</span>
        <span class="n">ny</span><span class="p">,</span><span class="n">nx</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="n">inside</span> <span class="o">=</span> <span class="n">quart</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span>
                          <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">left</span>  <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">bot</span>   <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]</span> <span class="o">-</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]))</span>
        <span class="n">top</span>   <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">]))</span>
        <span class="n">left_bot</span>  <span class="o">=</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">right_bot</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">right_top</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">left_top</span>  <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>


        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside</span>

        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">bounds</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bot</span>
        <span class="n">bounds</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bot</span>
        <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span>
        <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>  <span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span>

        <span class="n">bounds</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_bot</span>
        <span class="n">bounds</span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_bot</span>
        <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_top</span>
        <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_top</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span></div>




<div class="viewcode-block" id="meshgrid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.meshgrid">[docs]</a><span class="k">def</span> <span class="nf">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pure numeric x/y axes to 2d arrays of same shape.</span>
<span class="sd">    It works like :func:`numpy.meshgrid` but is more flexible.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **x**: 1D or 2D array</span>
<span class="sd">        - **x**: 2D or 2D array</span>

<span class="sd">    :Return: ``xx(ny,nx),yy(ny,nx)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Be sure to have numpy arrays and make a copy</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_cdat2num_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Mx</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">My</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[:],</span><span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">_cdat2num_</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ymask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[:],</span><span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="n">ymask</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># All is ok</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>

    <span class="c1"># From regular grid</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ymask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xmask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ymask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ymask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="n">xmask</span><span class="p">,</span> <span class="n">ymask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">ymask</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ymask</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="c1"># From x 1d</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">Mx</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">y</span>

    <span class="c1"># From y 1d</span>
    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">My</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">yy</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;Unable to safely convert to 2D axes&quot;</span></div>

<div class="viewcode-block" id="bounds2mesh"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.bounds2mesh">[docs]</a><span class="k">def</span> <span class="nf">bounds2mesh</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert 2D 4-corners cell bounds arrays (results from :func:`bounds2d`) to 2D arrays</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xb**: array(ny,nx,4) or array(nx,2)</span>
<span class="sd">        - **yb**: None or array(ny,nx,4) or array(ny,2)</span>

<span class="sd">    :Return: ``xxb(ny+1,nx+1),yyb(ny+1,nx+1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">for</span> <span class="n">xyb</span> <span class="ow">in</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyb</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">xyb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xyb</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xyb</span><span class="p">)</span>

        <span class="c1"># 1D</span>
        <span class="k">if</span> <span class="n">xyb</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xyb</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">xy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># 1D</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">nb</span> <span class="o">=</span> <span class="n">xyb</span><span class="o">.</span><span class="n">shape</span>
            <span class="c1"># - center + lower + left</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">xyb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">xy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># - right</span>
            <span class="n">xy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># - top</span>
            <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># - top-left</span>
            <span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">yb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">xy</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">xy</span><span class="p">,</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="meshcells"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.meshcells">[docs]</a><span class="k">def</span> <span class="nf">meshcells</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a 1D or 2D array corresponding the cell corners</span>

<span class="sd">    :params:</span>

<span class="sd">        - **x**: 1D or 2D array</span>
<span class="sd">        - **y**: 1D or 2D array</span>

<span class="sd">    :Returns:</span>
<span class="sd">        ``xxb(nx+1)``x</span>
<span class="sd">        OR</span>
<span class="sd">        ``xxb(ny+1,nx+1),yyb(ny+1,nx+1)``</span>

<span class="sd">    TODO: Add full support to meshcells for xwidth and ywidth params</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>  <span class="n">bounds2mesh</span><span class="p">(</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xwidth</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bounds2mesh</span><span class="p">(</span><span class="o">*</span><span class="n">bounds2d</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bounds2mesh</span><span class="p">(</span><span class="n">bounds2d</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>

<div class="viewcode-block" id="meshweights"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.meshweights">[docs]</a><span class="k">def</span> <span class="nf">meshweights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a 1D or 2D array corresponding the cell weights</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **x**: 1D or nD array</span>
<span class="sd">        - **y**: 1D or 2D array</span>
<span class="sd">        - **proj**, optional: Geographic projection before computing weights</span>
<span class="sd">          (for 2D case only with both x and y)</span>

<span class="sd">            - ``True``: use default mercator projection (see :func:`~vacumm.misc.grid.basemap.merc`),</span>
<span class="sd">            - else, directly apply projection.</span>

<span class="sd">    :Returns:</span>
<span class="sd">        ``ww(nx)``</span>
<span class="sd">        OR</span>
<span class="sd">        ``ww(ny,nx)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Without y</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">axis</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">axis</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">def</span> <span class="nf">ss</span><span class="p">(</span><span class="o">*</span><span class="n">sss</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
            <span class="n">s</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">sss</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sss</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="k">else</span> <span class="n">sss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="n">dd</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">ss</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">del</span> <span class="n">dd</span>
        <span class="k">return</span> <span class="n">dx</span>

<span class="c1">#        # 2D</span>
<span class="c1">#        if x.ndim==2:</span>
<span class="c1">#            if axis&lt;0: axis = 2-axis</span>
<span class="c1">#            dx = x.copy()</span>
<span class="c1">#            dd = N.diff(x, axis=axis)</span>
<span class="c1">#            if axis==0:</span>
<span class="c1">#                dx[1:-1] = .5*(dd[:-1]+dd[1:])</span>
<span class="c1">#                dx[0] = dd[0]</span>
<span class="c1">#                dx[-1] = dd[-1]</span>
<span class="c1">#            else:</span>
<span class="c1">#                dx[:, 1:-1] = .5*(dd[:, :-1]+dd[:, 1:])</span>
<span class="c1">#                dx[:, 0] = dd[:, 0]</span>
<span class="c1">#                dx[:, -1] = dd[:, -1]</span>
<span class="c1">#            del dd</span>
<span class="c1">#            return dx</span>
<span class="c1">#</span>
<span class="c1">#        # 1D</span>
<span class="c1">#        return N.diff(meshcells(x))</span>

    <span class="c1"># With y</span>
    <span class="k">if</span> <span class="ow">not</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="c1"># - 2D</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">meshcells</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
            <span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span> <span class="n">yyb</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dyx</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yyb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yyb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dyx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dxx</span><span class="p">,</span> <span class="n">dyx</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dyy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">dyy</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span>
    <span class="c1"># - 1D</span>
    <span class="k">return</span> <span class="n">meshweights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">meshweights</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span></div>
<span class="c1">#    return N.diff(meshcells(x)), N.diff(meshcells(y))</span>


<div class="viewcode-block" id="cells2grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.cells2grid">[docs]</a><span class="k">def</span> <span class="nf">cells2grid</span><span class="p">(</span><span class="n">xxb</span><span class="p">,</span><span class="n">yyb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a grid of cells (grid of corners, like results from :func:`meshcells`) to a grid (grid of centers)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xxb**: X of corners (ny+1,nx+1)</span>
<span class="sd">        - **yyb**: Y of corners (ny+1,nx+1)</span>

<span class="sd">    :Returns: ``xx(ny,nx),yy(ny,nx)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numod</span><span class="p">(</span><span class="n">xxb</span><span class="p">)</span>
    <span class="n">xxyy</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">xxb</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">yyb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxb</span><span class="p">,</span><span class="n">yyb</span><span class="p">)</span>
    <span class="n">ij2ic</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">],(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Center</span>
        <span class="n">xxyy</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="c1"># Sides</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xxyy</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="n">ij2ic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">i</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ij2ic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="c1"># Bottom/top</span>
            <span class="n">xxyy</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span><span class="n">i</span><span class="p">,</span><span class="n">ij2ic</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">ij2ic</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]])</span> <span class="c1"># Left/right</span>
        <span class="c1"># Corners</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">xxyy</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">ij2ic</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">xxyy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="meshbounds"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.meshbounds">[docs]</a><span class="k">def</span> <span class="nf">meshbounds</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A shortcut to :func:`meshcells`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">meshcells</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="coord2slice"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.coord2slice">[docs]</a><span class="k">def</span> <span class="nf">coord2slice</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assubmask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert from coordinates to indices on grid or axes</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A grid, a cmds variable with a grid,</span>
<span class="sd">          a tuple of axes or an axis.</span>
<span class="sd">        - **lon/lat**: Interval of coordinates or slice. If single coordinates, the</span>
<span class="sd">          interval becomes for instance ``(lon,lon,&#39;ccb&#39;)``.</span>
<span class="sd">        - **mode**, optional: Output mode. You can pass only the first letter.</span>

<span class="sd">            - ``&quot;slice&quot;``: Return a :class:`slice` object.</span>
<span class="sd">            - ``&quot;indices&quot;``: Return a 3-element tuple as in a :class:`slice` context</span>
<span class="sd">              ``(start,stop,step)``.</span>
<span class="sd">            - ``&quot;array&quot;``: Return an array of valid indices of shape ``(2,nvalid)``,</span>
<span class="sd">              where ``out[0]`` gives the X indices and ``out[1]`` gives the Y indices.</span>

<span class="sd">        - **mask**, optional: Also use this mask to get indices</span>
<span class="sd">          (for 2D axes only).</span>
<span class="sd">        - **squeeze**, optional: If ``asslice`` is False ad</span>
<span class="sd">        - **asslice**, optional: DEPRECATED. Use ``mode=&#39;slice&#39;`` instead.</span>

<span class="sd">    :Return:</span>

<span class="sd">        In array mode, it always returns an array of indices of shape ``(2,nvalid)``,</span>
<span class="sd">        possibly empty if not intersection if found.</span>

<span class="sd">        Here ``i/jslice`` is a slice or a tuple of indices,</span>
<span class="sd">        depending on asslice. It can also be ``None`` if</span>
<span class="sd">        not intersection are found.</span>

<span class="sd">        If ``gg`` is grid, a tuple of axes or a 2D axis:</span>
<span class="sd">        ``islice, jslice, mask``.</span>
<span class="sd">        In case of a tuple of 1D axes, ``mask`` is ``None`` because not relevant.</span>

<span class="sd">        If ``gg`` is a 1D axis: ``ijslice``, just as the</span>
<span class="sd">        :meth:`mapIntervaExt`` method of 1D axes.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; ijk = coord2slice(lon1d, lon=(lon0,lon1), mode=&#39;i&#39;)</span>
<span class="sd">        &gt;&gt;&gt; xijk, yijk, mask = coord2slice((lon1d,lat1d),</span>
<span class="sd">            lon=(lon0,lon1), lat=slice(0,3), mode=&#39;i&#39;)</span>
<span class="sd">        &gt;&gt;&gt; islice, jslice, mask = coord2slice(gridcurv, lat=(lat0,lat0,&#39;ccb&#39;), mode=&#39;s&#39;)</span>
<span class="sd">        &gt;&gt;&gt; xijk, yijk, mask = coord2slice(lon2d, lon=(lon0,lon1), mode=&#39;i&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ij = coord2slice(grid, lon, lat, mode=&#39;a&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Output mode</span>
    <span class="k">if</span> <span class="s1">&#39;asslice&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;slice&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;asslice&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;indices&#39;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;slice&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;ias&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Wrong mode: </span><span class="si">%s</span><span class="s1">. Choose one of: slice, indices, array&#39;</span><span class="o">%</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span>
        <span class="n">assubmask</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Format selector specs</span>
    <span class="k">if</span> <span class="n">lon</span><span class="o">==</span><span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">lon</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">lon</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">lon</span><span class="o">==</span><span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">lon</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">lon</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">lon</span> <span class="o">+=</span> <span class="s1">&#39;cc&#39;</span><span class="p">,</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="n">lon</span> <span class="o">+=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="s1">&#39;cob&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lat</span><span class="o">==</span><span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">lat</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">lat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">lat</span> <span class="o">+=</span> <span class="s1">&#39;cc&#39;</span><span class="p">,</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="n">lat</span> <span class="o">+=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;cob&#39;</span><span class="p">)</span>

    <span class="c1"># CDMS variable</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>

        <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>

    <span class="c1"># Unstructured grid</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Not available for unstructured grids&#39;</span><span class="p">)</span>

    <span class="c1"># Strucutured grid</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>

        <span class="c1"># Get axes</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>

        <span class="c1"># 2D</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>

            <span class="c1"># As axes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
                <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">create_axes2d</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>

            <span class="c1"># Get indices</span>
            <span class="n">xii</span><span class="p">,</span> <span class="n">xjj</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">assubmask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span>
            <span class="n">yii</span><span class="p">,</span> <span class="n">yjj</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">assubmask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span>

            <span class="c1"># Merge</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xii</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yii</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xii</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yii</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">jmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xjj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yjj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xjj</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yjj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">xijk</span> <span class="o">=</span> <span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># max(xii[2],yii[2]) instead of 1?</span>
            <span class="n">yijk</span> <span class="o">=</span> <span class="p">(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">sxijk</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">xijk</span><span class="p">)</span>
            <span class="n">syijk</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">yijk</span><span class="p">)</span>

            <span class="c1"># Submask and slices</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span><span class="p">:</span>
                <span class="n">xijk</span> <span class="o">=</span> <span class="n">sxijk</span>
                <span class="n">yijk</span> <span class="o">=</span> <span class="n">syijk</span>
            <span class="k">if</span> <span class="n">assubmask</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">syijk</span><span class="p">,</span> <span class="n">sxijk</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="c1"># array of valid indices</span>
                <span class="n">iijj</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:,</span> <span class="n">syijk</span><span class="p">,</span> <span class="n">sxijk</span><span class="p">]</span>
                <span class="n">iijj</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">return</span> <span class="n">iijj</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
            <span class="k">return</span> <span class="n">xijk</span><span class="p">,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">mask</span>

        <span class="c1"># 1D</span>

        <span class="c1"># - as axes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

        <span class="c1"># - indices</span>
        <span class="n">cmode</span> <span class="o">=</span> <span class="n">mode</span> <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;a&#39;</span> <span class="k">else</span> <span class="s1">&#39;slice&#39;</span>
        <span class="n">xijk</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">cmode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">yijk</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">cmode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># - mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#        mask = N.ones((len(yy), len(xx)))</span>
<span class="c1">#        mask[slice(*yijk), slice(*xijk)] = False</span>


        <span class="c1"># - return</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">iijj</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yy</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)))[:,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">xijk</span><span class="p">]</span>
            <span class="n">iijj</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">iijj</span>
        <span class="k">return</span> <span class="n">xijk</span><span class="p">,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">mask</span>


    <span class="c1"># Single Axis</span>

    <span class="c1"># - selector</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s2">&quot;If gg is not a grid or an tuple, it must be an axis&quot;</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">isLongitude</span><span class="p">())</span>
    <span class="n">sel</span><span class="p">,</span> <span class="n">osel</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)[::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">axis</span><span class="p">:</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="o">-</span><span class="mf">720.</span><span class="p">,</span> <span class="mi">720</span>
        <span class="n">modeval</span> <span class="o">=</span> <span class="s1">&#39;mask&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span>
        <span class="n">modeval</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>

    <span class="c1"># - 2D</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>

        <span class="c1"># Selection with provided coordinates</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">ijk</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
            <span class="n">oijk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
<span class="c1">#            mask[(ijk, None)[::1-2*axis]] = False</span>
            <span class="n">mask</span><span class="p">[(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))[::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">axis</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xijk</span><span class="p">,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">_coord2ind2d_</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">minval</span><span class="o">=</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">maxval</span><span class="p">,</span> <span class="n">modeval</span><span class="o">=</span><span class="n">modeval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span>
            <span class="n">ijk</span><span class="p">,</span> <span class="n">oijk</span> <span class="o">=</span> <span class="p">(</span><span class="n">yijk</span><span class="p">,</span> <span class="n">xijk</span><span class="p">)[::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">axis</span><span class="p">]</span>

        <span class="c1"># Selection along other coordinates with slice</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">osel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">osel</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">])</span>
            <span class="n">oijk</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">oijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">oijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="n">bad</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">oijk</span><span class="p">))[::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">axis</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="n">bad</span>
            <span class="k">del</span> <span class="n">bad</span>


        <span class="c1"># Submask and slices</span>
        <span class="n">xijk</span><span class="p">,</span> <span class="n">yijk</span> <span class="o">=</span> <span class="p">(</span><span class="n">oijk</span><span class="p">,</span> <span class="n">ijk</span><span class="p">)[::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">axis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">xijk</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">xijk</span><span class="p">)</span>
            <span class="n">yijk</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">yijk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">assubmask</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">yijk</span><span class="p">,</span> <span class="n">xijk</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">assubmask</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">yijk</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">xijk</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="c1"># array of valid indices</span>
            <span class="n">iijj</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">xijk</span><span class="p">]</span>
            <span class="n">iijj</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">iijj</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
        <span class="k">return</span>  <span class="n">xijk</span><span class="p">,</span> <span class="n">yijk</span><span class="p">,</span> <span class="n">mask</span>

    <span class="c1"># - 1D</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">sel</span>
        <span class="n">ijk</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">ijk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ijk</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">ijk</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">ijk</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="p">))[</span><span class="n">ijk</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ijk</span></div>


<div class="viewcode-block" id="mask2ind"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.mask2ind">[docs]</a><span class="k">def</span> <span class="nf">mask2ind</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a mask to min and max valid indices</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mask**: N-dimensional array of logical where</span>
<span class="sd">          valid points are at False.</span>
<span class="sd">        - **extended**, optional: Extend indices. Accepts</span>
<span class="sd">          ``True``, ``False``, ``int``, ``(intmin, intmax)``.</span>

<span class="sd">    :Return: array(ndim,2) of (min,max) for each dimension</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">inds</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extended</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">extended</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">extended</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="n">extended</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">extended</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">extended</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extended</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">extended</span> <span class="o">=</span> <span class="p">(</span><span class="n">extended</span><span class="p">,</span><span class="n">extended</span><span class="p">)</span>
    <span class="n">mm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">extended</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mm</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">extended</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">inds</span>
    <span class="n">mm</span><span class="p">[</span><span class="n">mm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">mm</span></div>

<span class="k">def</span> <span class="nf">_mask4tomask_</span><span class="p">(</span><span class="n">mask4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert mask at corners to mask at center of cell using the AND operator&quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask4</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">mask4</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">mask4</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">mask4</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">_coord2ind2d_</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">minval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modeval</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert lon/lat 2d coord to index respectively with lon/lat selection</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **cc2d**(ny,nx): Coordinates.</span>
<span class="sd">        - **sel**: Coordinates interval.</span>

<span class="sd">    :Returns: ``None, None, mask`` or ``(imin,imax,istep),(jmin,jmax,jstep),mask(ny,nx)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#  No selection</span>
    <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nj</span><span class="p">,</span> <span class="n">ni</span> <span class="o">=</span> <span class="n">cc2d</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nj</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nj</span><span class="p">,</span> <span class="n">ni</span><span class="p">),</span> <span class="s1">&#39;?&#39;</span><span class="p">)]</span>
        <span class="p">[(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">),</span> <span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mask2ind</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Selection specs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">FileAxis2D</span><span class="p">):</span> <span class="n">cc2d</span> <span class="o">=</span> <span class="n">cc2d</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">cc2d</span><span class="p">):</span> <span class="n">cc2d</span> <span class="o">=</span> <span class="n">cc2d</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>

    <span class="c1"># Limits</span>
    <span class="k">if</span> <span class="n">minval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">maxval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">minval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">minval</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">maxval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">modeval</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span>
            <span class="n">cc2d</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cc2d</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>

    <span class="c1"># According to bounds of cells</span>
    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>

        <span class="c1"># Bounds become coordinates</span>
        <span class="n">cc2db</span> <span class="o">=</span> <span class="n">meshcells</span><span class="p">(</span><span class="n">cc2d</span><span class="p">)</span>

        <span class="c1"># Remove &#39;b&#39; from interval specifications</span>
        <span class="n">selb</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="mi">2</span><span class="p">],)</span>   <span class="c1"># no &#39;b&#39;</span>

        <span class="c1"># Select min first</span>
        <span class="n">selmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="mi">2</span><span class="p">],)</span>
        <span class="n">maskmin</span> <span class="o">=</span> <span class="n">_coord2ind2d_</span><span class="p">(</span><span class="n">cc2db</span><span class="p">,</span> <span class="n">selmin</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">maskonly</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">xymask</span> <span class="o">=</span> <span class="n">_mask4tomask_</span><span class="p">(</span><span class="n">maskmin</span><span class="p">)</span>
<span class="c1">#        del maskmin</span>

        <span class="c1"># Select max</span>
        <span class="n">selmax</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">sel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="mi">2</span><span class="p">],)</span>
        <span class="n">maskmax</span> <span class="o">=</span> <span class="n">_coord2ind2d_</span><span class="p">(</span><span class="n">cc2db</span><span class="p">,</span> <span class="n">selmax</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">maskonly</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">xymask</span> <span class="o">|=</span> <span class="n">_mask4tomask_</span><span class="p">(</span><span class="n">maskmax</span><span class="p">)</span>
<span class="c1">#        del maskmax</span>

        <span class="c1"># Merge</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xymask</span> <span class="o">|=</span> <span class="n">mask</span>
        <span class="k">if</span> <span class="n">maskonly</span> <span class="ow">or</span> <span class="n">xymask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">xymask</span> <span class="k">if</span> <span class="n">maskonly</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">xymask</span><span class="p">)</span>
        <span class="p">[(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">),</span> <span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mask2ind</span><span class="p">(</span><span class="n">xymask</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xymask</span><span class="p">]</span>


    <span class="c1"># Operators</span>
    <span class="n">Less</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less_equal</span>
    <span class="n">Greater</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater_equal</span>

    <span class="c1"># Mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">Less</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">Greater</span><span class="p">(</span><span class="n">cc2d</span><span class="p">,</span> <span class="n">sel</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maskonly</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">maskonly</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Indices</span>
    <span class="p">[(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">),</span> <span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mask2ind</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="p">]</span>


<div class="viewcode-block" id="create_axes2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_axes2d">[docs]</a><span class="k">def</span> <span class="nf">create_axes2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lonid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="s1">&#39;ni&#39;</span><span class="p">,</span> <span class="n">jid</span><span class="o">=</span><span class="s1">&#39;nj&#39;</span><span class="p">,</span>
        <span class="n">xatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xbounds2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ybounds2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nobounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create 2D numerical of complete axes</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; lon2d, lat2d = create_axes2d(x2d, y2d)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xaxis**, optional: 1D or 2D X axis</span>
<span class="sd">        - **xaxis**, optional: 1D or 2D Y axis</span>
<span class="sd">        - *xatts*, optional: Attributes for output 2D X axis</span>
<span class="sd">        - *yatts*, optional: Attributes for output 2D Y axis</span>
<span class="sd">        - **xbounds2d**, optional: 2D bounds of input xaxis</span>
<span class="sd">        - **ybounds2d**, optional: 2D bounds of input yaxis</span>
<span class="sd">        - **nobounds**, optional: create (True) or not (False - default) bounds of axis</span>
<span class="sd">        - **numeric**, optional: Only return numerical values instead of complete axes</span>
<span class="sd">        - **bounds**, optional: Return extended axes positioned on bounds (useful for pcolor).</span>
<span class="sd">          Deprecated: use :func:`meshbounds` instead.</span>
<span class="sd">        - **lonid**, optional: Id of longitude axis [defaut=&#39;lon&#39;].</span>
<span class="sd">        - **latid**, optional: Id of latitude axis [defaut=&#39;lat&#39;].</span>
<span class="sd">        - **iid**, optional: Id of i axis [defaut=&#39;iid&#39;].</span>
<span class="sd">        - **jid**, optional: Id of j axis [defaut=&#39;jid&#39;].</span>


<span class="sd">    :Return: ``xaxis2d,yaxis2d``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TransientAxis2D</span><span class="p">):</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">TransientAxis2D</span><span class="p">):</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># - ids</span>
    <span class="n">xaxis1d</span> <span class="o">=</span> <span class="n">yaxis1d</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">lonid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lonid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;getAxis&#39;</span><span class="p">):</span>
            <span class="n">xaxis1d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yaxis1d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">latid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">latid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;getAxis&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xaxis1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xaxis1d</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yaxis1d</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Numeric part</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xn</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create 2D from a single 1D X axis&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">yn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yn</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create 2D from a single 1D Y axis&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xn</span> <span class="k">if</span> <span class="n">hasx</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yn</span> <span class="k">if</span> <span class="n">hasy</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span> <span class="k">del</span> <span class="n">xn</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">del</span> <span class="n">yn</span>
<span class="c1">#    if hasx and hasy and xx.shape != yy.shape:</span>
<span class="c1">#        raise VACUMMError(&#39;Incomptible shape between 2D X and Y coordinates: %s != %s&#39;%(xx.shape, yy.shape))</span>
<span class="c1">#    if bounds:</span>
<span class="c1">#        if hasx: xx = meshbounds(xx)</span>
<span class="c1">#        if hasy: yy = meshbounds(yy)</span>
    <span class="k">if</span> <span class="n">numeric</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>

    <span class="c1"># 2D axes</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">xaxis2d</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xaxis2d</span> <span class="o">=</span> <span class="n">TransientAxis2D</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">yaxis2d</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yaxis2d</span> <span class="o">=</span> <span class="n">TransientAxis2D</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

    <span class="c1"># 2D bounds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nobounds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xbounds2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xaxis2d</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">xbounds2d</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xaxis2d</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xaxis2d</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bounds2d</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ybounds2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yaxis2d</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">ybounds2d</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">yaxis2d</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yaxis2d</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bounds2d</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>

    <span class="c1"># 1D axes</span>
    <span class="k">for</span> <span class="n">axis2d</span> <span class="ow">in</span> <span class="p">([</span><span class="n">xaxis2d</span><span class="p">]</span> <span class="k">if</span> <span class="n">hasx</span> <span class="k">else</span> <span class="p">[])</span><span class="o">+</span><span class="p">([</span><span class="n">yaxis2d</span><span class="p">]</span> <span class="k">if</span> <span class="n">hasy</span> <span class="k">else</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">xaxis1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis2d</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xaxis1d</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">iid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iid</span>
        <span class="k">if</span> <span class="n">yaxis1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis2d</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">yaxis1d</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">jid</span>


    <span class="c1"># Format</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xaxis2d</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">lonid</span> <span class="ow">or</span> <span class="s1">&#39;lon&#39;</span>
<span class="c1">#        xaxis2d = create_lon(xaxis2d, id=lonid or &#39;lon&#39;)</span>
        <span class="n">xaxis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">designateLongitude</span><span class="p">()</span>
        <span class="n">xaxis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">designateLatitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xaxis2d</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">xaxis2d</span><span class="o">.</span><span class="n">axis</span>
        <span class="k">if</span> <span class="n">xatts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xa</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xa</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xatts</span><span class="p">)</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">xaxis2d</span><span class="p">,</span> <span class="n">xatts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">yaxis2d</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">latid</span> <span class="ow">or</span> <span class="s1">&#39;lat&#39;</span>
<span class="c1">#        yaxis2d = create_lat(yaxis2d, id=latid or &#39;lat&#39;)</span>
        <span class="n">yaxis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">designateLongitude</span><span class="p">()</span>
        <span class="n">yaxis2d</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">designateLatitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yaxis2d</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">yaxis2d</span><span class="o">.</span><span class="n">axis</span>
        <span class="k">if</span> <span class="n">yatts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ya</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">ya</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yatts</span><span class="p">)</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">yaxis2d</span><span class="p">,</span> <span class="n">yatts</span><span class="p">)</span>

    <span class="c1"># Output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasx</span><span class="p">:</span> <span class="k">return</span> <span class="n">yaxis2d</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">return</span> <span class="n">xaxis2d</span>
    <span class="k">return</span> <span class="n">xaxis2d</span><span class="p">,</span> <span class="n">yaxis2d</span></div>

<div class="viewcode-block" id="axes2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.axes2d">[docs]</a><span class="k">def</span> <span class="nf">axes2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`create_axes2d`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_axes2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_aux_axes"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_aux_axes">[docs]</a><span class="k">def</span> <span class="nf">create_aux_axes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lonid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span>
        <span class="n">xatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ybounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nobounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create auxilary 1d axes</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; lon1d, lat1d = create_aux_axes(x1d, y1d)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xaxis**, optional: 1D axis or array</span>
<span class="sd">        - **xaxis**, optional: 1D axis or array</span>
<span class="sd">        - *xatts*, optional: Attributes for output auxilary X axis</span>
<span class="sd">        - *yatts*, optional: Attributes for output auxilary Y axis</span>
<span class="sd">        - **lonid**, optional: Id of longitude axis [defaut=&#39;lon&#39;].</span>
<span class="sd">        - **latid**, optional: Id of latitude axis [defaut=&#39;lat&#39;].</span>
<span class="sd">        - **iid**, optional: Id of i axis [defaut=&#39;iid&#39;].</span>
<span class="sd">        - **jid**, optional: Id of j axis [defaut=&#39;jid&#39;].</span>
<span class="sd">        - **xbounds2d**, optional: 2D bounds of input xaxis</span>
<span class="sd">        - **ybounds2d**, optional: 2D bounds of input yaxis</span>
<span class="sd">        - **nobounds**, optional: create (True) or not (False - default) bounds of axis</span>


<span class="sd">    :Return: ``xaxis2d,yaxis2d``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TransientAuxAxis1D</span><span class="p">):</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hasx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">TransientAuxAxis1D</span><span class="p">):</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hasy</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># - ids</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">lonid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lonid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">latid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">latid</span><span class="p">)</span>

    <span class="c1"># Numeric part</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">[:])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">yn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">[:])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xn</span> <span class="k">if</span> <span class="n">hasx</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yn</span> <span class="k">if</span> <span class="n">hasy</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span> <span class="k">del</span> <span class="n">xn</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">del</span> <span class="n">yn</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">xx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">yy</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;Incompatible sizes for auxiliary axes&#39;</span>

    <span class="c1"># Auxilary cdms axes</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="n">TransientAuxAxis1D</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">yaxis</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yaxis</span> <span class="o">=</span> <span class="n">TransientAuxAxis1D</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

    <span class="c1"># bounds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nobounds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="n">xbounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xaxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">xbounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hasy</span> <span class="ow">and</span> <span class="n">ybounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yaxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">ybounds</span><span class="p">)</span>

    <span class="c1"># Format</span>
    <span class="k">if</span> <span class="n">hasx</span><span class="p">:</span>
        <span class="n">xaxis</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">lonid</span> <span class="ow">or</span> <span class="s1">&#39;lon&#39;</span>
        <span class="n">xaxis</span><span class="o">.</span><span class="n">designateLongitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xatts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xa</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xa</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xatts</span><span class="p">)</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">xatts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasy</span><span class="p">:</span>
        <span class="n">yaxis</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">latid</span> <span class="ow">or</span> <span class="s1">&#39;lat&#39;</span>
        <span class="n">yaxis</span><span class="o">.</span><span class="n">designateLatitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">yatts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ya</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">ya</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yatts</span><span class="p">)</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">yatts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="n">hasy</span> <span class="ow">and</span> <span class="n">xaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">yaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">yaxis</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="n">xaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;axis&#39;</span><span class="p">):</span>
        <span class="n">xaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iid</span>
    <span class="k">if</span> <span class="n">hasy</span> <span class="ow">and</span> <span class="n">yaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;axis&#39;</span><span class="p">):</span>
        <span class="n">yaxis</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iid</span>

    <span class="c1"># Output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasx</span><span class="p">:</span> <span class="k">return</span> <span class="n">yaxis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasy</span><span class="p">:</span> <span class="k">return</span> <span class="n">xaxis</span>
    <span class="k">return</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span></div>


<div class="viewcode-block" id="get_axis"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_axis">[docs]</a><span class="k">def</span> <span class="nf">get_axis</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">iaxis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A robust way to get an axis from a variable or a grid</span>

<span class="sd">    This is a generic way to get a 1D and 2D axes: the only</span>
<span class="sd">    way to get longitude and latitude axes of a curvilinear grid are the</span>
<span class="sd">    :meth:`getLongitude` and :meth:`getLatitude` methods</span>
<span class="sd">    (you can&#39;t use :meth:`getAxis` with such grid).</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; lon = get_axis(grid, -1)</span>
<span class="sd">        &gt;&gt;&gt; lat = get_axis(var, 0)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: The variable or a grid (see :func:`get_grid`)</span>
<span class="sd">        - **iaxis**, optional: The axis number [default: 0]</span>

<span class="sd">    :Returns: The requested axis</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iaxis</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iaxis</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iaxis</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">iaxis</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_grid">[docs]</a><span class="k">def</span> <span class="nf">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a cdms grid from gg</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; grid = get_grid((lon, lat))</span>
<span class="sd">        &gt;&gt;&gt; grid = get_grid(var)</span>
<span class="sd">        &gt;&gt;&gt; grid = get_grid(grid) # does nothing</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **g**: A cdms variable with a grid OR cdms grid OR a tuple like (xx,yy) where xx and yy are numpy arrays or cdms axes</span>
<span class="sd">        - **intercept**, optional: Raise an error in case of problem</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># From triangulation</span>
    <span class="k">if</span> <span class="n">istri</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">create_ugrid</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gg</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tempmask</span><span class="o">=</span><span class="n">gg</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># From a grid</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">designateLongitude</span><span class="p">()</span>
            <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">designateLatitude</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gg</span>

    <span class="c1"># From a variable</span>
    <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strict</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># From a tuple of coordinates</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span>

        <span class="c1"># Check axis is compatible</span>
        <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept</span><span class="p">:</span> <span class="k">return</span>
                <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t make a grid with </span><span class="si">%s</span><span class="s2"> axis as longitude&quot;</span><span class="o">%</span><span class="n">xx</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">xx</span><span class="o">.</span><span class="n">designateLongitude</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept</span><span class="p">:</span> <span class="k">return</span>
                <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t make a grid with </span><span class="si">%s</span><span class="s2"> axis as latitude&quot;</span><span class="o">%</span><span class="n">yy</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">yy</span><span class="o">.</span><span class="n">designateLatitude</span><span class="p">()</span>

        <span class="c1"># Create grid</span>
        <span class="k">return</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="n">gtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intercept</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;No way to guess the grid&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.set_grid">[docs]</a><span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set a grid to a variable</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: A cdms variable with at least 2 dimensions</span>
<span class="sd">        - **gg**: A cdms grid or tuple or axes (see :func:`get_grid`)</span>

<span class="sd">    :Return: ``var``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">MV</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="n">intercept</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="o">-</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">var</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">var</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="get_grid_axes"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_grid_axes">[docs]</a><span class="k">def</span> <span class="nf">get_grid_axes</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the (lat,lon) axes from a grid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A cdms grid or a tuple or axes (see :func:`get_grid`)</span>
<span class="sd">        - **raw**, optional: If True, return raw axes which are different from real axes with curvilinear grids</span>

<span class="sd">    :Return: ``(lon, lat)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">(),</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_curv_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_curv_grid">[docs]</a><span class="k">def</span> <span class="nf">create_curv_grid</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a curvilinear 2D grid from 1D or 2D axes</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **xaxis**: Numeric or formatted X axis</span>
<span class="sd">        - **yaxis**: Numeric or formatted Y axis</span>
<span class="sd">        - **xatts**, optional: Attributes of X axis</span>
<span class="sd">        - **yatts**, optional: Attributes of Y axis</span>
<span class="sd">        - **id**, optional: Id of the grid</span>
<span class="sd">        - Other keywords are passed to :func:`create_axes2d`</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; curvgrid = curv_grid(lon2d, lat2d)</span>

<span class="sd">    :See also: :func:`create_grid2d`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaxis2d</span><span class="p">,</span><span class="n">yaxis2d</span> <span class="o">=</span> <span class="n">create_axes2d</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="n">xatts</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="n">yatts</span><span class="p">,</span> <span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;grid2d&#39;</span>
    <span class="k">return</span> <span class="n">TransientCurveGrid</span><span class="p">(</span><span class="n">yaxis2d</span><span class="p">,</span> <span class="n">xaxis2d</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">tempmask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></div>

<div class="viewcode-block" id="curv_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.curv_grid">[docs]</a><span class="k">def</span> <span class="nf">curv_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`create_curv_grid`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_curv_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_grid2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_grid2d">[docs]</a><span class="k">def</span> <span class="nf">create_grid2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`curv_grid`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_curv_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="grid2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.grid2d">[docs]</a><span class="k">def</span> <span class="nf">grid2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`curv_grid`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_curv_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_var2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_var2d">[docs]</a><span class="k">def</span> <span class="nf">create_var2d</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">lonid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create 2D cdms variable with on a proper 2d curvilinear grid</span>

<span class="sd">    You should generally call this routine when you want to attach 2D axes</span>
<span class="sd">    to a variable. This may happen with netcdf that doesn&#39;t follow CF</span>
<span class="sd">    conventions, as in the example bellow.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; f = cdms2.open(&#39;myfile.nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; lon2d = f(&#39;X&#39;)</span>
<span class="sd">        &gt;&gt;&gt; lat2d = f(&#39;Y&#39;)</span>
<span class="sd">        &gt;&gt;&gt; sst = f(&#39;sst&#39;)</span>
<span class="sd">        &gt;&gt;&gt; f.close()</span>
<span class="sd">        &gt;&gt;&gt; sstc = create_var2d(sst, lon2d, lat2d)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: Numeric or formatted X axis</span>
<span class="sd">        - **xaxis**, optional: Numeric or formatted X axis. Mandatory if var is not a cdms variable!</span>
<span class="sd">        - **yaxis**, optional: Numeric or formatted Y axis. Mandatory if var is not a cdms variable!</span>
<span class="sd">        - **atts**, optional: Attributes of the variable .</span>
<span class="sd">        - **xatts**, optional: Attributes of X axis.</span>
<span class="sd">        - **yatts**, optional: Attributes of Y axis.</span>
<span class="sd">        - **gid**, optional: Id of the grid.</span>
<span class="sd">        - All other keywords are passed to :func:`cdms.createVariable`</span>

<span class="sd">    :Return: A :mod:`MV2` array on a curvilinear grid.</span>

<span class="sd">    :See also: :func:`curv_grid` :func:`get_axis`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Input variable must have a at least 2d shape&#39;</span>

    <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yaxis</span> <span class="o">=</span> <span class="n">get_axis</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xaxis</span> <span class="o">=</span> <span class="n">get_axis</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">mygrid2d</span> <span class="o">=</span> <span class="n">curv_grid</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="n">xatts</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="n">yatts</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
        <span class="n">iid</span><span class="o">=</span><span class="n">iid</span><span class="p">,</span> <span class="n">jid</span><span class="o">=</span><span class="n">jid</span><span class="p">,</span> <span class="n">lonid</span><span class="o">=</span><span class="n">lonid</span><span class="p">)</span><span class="c1">#,mask=MV.getmask(var))</span>

    <span class="n">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mygrid2d</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="var2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.var2d">[docs]</a><span class="k">def</span> <span class="nf">var2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`create_var2d`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_var2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="num2axes2d"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.num2axes2d">[docs]</a><span class="k">def</span> <span class="nf">num2axes2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for :func:`axes2d`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">axes2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_ugrid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_ugrid">[docs]</a><span class="k">def</span> <span class="nf">create_ugrid</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a unstructured grid from axes&quot;&quot;&quot;</span>
    <span class="n">xykw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xykw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">xaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span> <span class="o">=</span> <span class="n">create_aux_axes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">xykw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TransientGenericGrid</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.create_grid">[docs]</a><span class="k">def</span> <span class="nf">create_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lonatts</span><span class="o">=</span><span class="p">{},</span> <span class="n">latatts</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a cdms rectangular or curvilinear grid from axes</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **lon**: Array or axis of longitudes or any argument passed to :func:`~vacumm.misc.axes.create_lon`.</span>
<span class="sd">        - **lat**: Array or axis of latitudes or any argument passed to :func:`~vacumm.misc.axes.create_lat`.</span>
<span class="sd">        - **mask**, optional: Grid mask.</span>
<span class="sd">        - **(lon/lat)atts**, optional: Attributes to set for axes.</span>
<span class="sd">        - **gtype**, optional, string: grid type as one of None, &#39;rect&#39;, &#39;curv&#39;, &#39;unstruct&#39;</span>

<span class="sd">    :Return: A :mod:`cdms2` grid object.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; create_grid([1.,3.,5.,7], numpy.arange(45., 60., .5))</span>
<span class="sd">        &gt;&gt;&gt; create_grid((.1, 8., 1.), (45., 60., .5))</span>

<span class="sd">    :See also: :func:`~vacumm.misc.axes.create_lon` :func:`~vacumm.misc.axes.create_lat`</span>
<span class="sd">               :func:`get_grid` :func:`set_grid`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;curv&#39;</span>
    <span class="k">assert</span> <span class="n">gtype</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">]</span>

    <span class="c1"># Arrays</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1"># Curvilinear 2D axes?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;curv&#39;</span>

    <span class="k">if</span> <span class="n">gtype</span> <span class="o">!=</span> <span class="s1">&#39;curv&#39;</span><span class="p">:</span> <span class="c1"># 1D axes: rect or unstruct</span>

        <span class="c1"># Guess if auxilary</span>
        <span class="k">if</span> <span class="n">gtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">N</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat</span><span class="p">)):</span>
                <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="ow">and</span>
                  <span class="n">lon</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">lat</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dxp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lon</span><span class="p">[:])</span><span class="o">&gt;</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">dxp</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="o">~</span><span class="n">dxp</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;unstruct&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">gtype</span><span class="p">:</span>
                    <span class="n">dyp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lat</span><span class="p">[:])</span><span class="o">&gt;</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">dyp</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="o">~</span><span class="n">dyp</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">gtype</span> <span class="o">=</span> <span class="s1">&#39;unstruct&#39;</span>
        <span class="k">if</span> <span class="n">gtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vcwarn</span><span class="p">(</span><span class="s2">&quot;Can&#39;t guess the type of the grid to create.&quot;</span>
                   <span class="s2">&quot; Falling back to rect.&quot;</span><span class="p">)</span>

        <span class="c1"># Unstructured</span>
        <span class="k">if</span> <span class="n">gtype</span> <span class="o">==</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">create_ugrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="n">lonatts</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="n">latatts</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get axes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">islon</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">lonatts</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">islat</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">create_lat</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">latatts</span><span class="p">)</span>

        <span class="c1"># Create rectangular grid</span>
        <span class="k">return</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createRectGrid</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Curvilinear</span>

        <span class="k">return</span> <span class="n">create_curv_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">xatts</span><span class="o">=</span><span class="n">lonatts</span><span class="p">,</span> <span class="n">yatts</span><span class="o">=</span><span class="n">latatts</span><span class="p">,</span>
                                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">clone_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clone a grid&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">id</span>

    <span class="n">lon</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
        <span class="n">iaxis</span> <span class="o">=</span> <span class="n">TransientAxis</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#.clone()</span>
        <span class="n">jaxis</span> <span class="o">=</span> <span class="n">TransientAxis</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#.clone()</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="n">jaxis</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">])</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="n">jaxis</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">])</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="n">get_grid_type</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="k">return</span> <span class="n">grid</span>


<div class="viewcode-block" id="get_unstruct_indices"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_unstruct_indices">[docs]</a><span class="k">def</span> <span class="nf">get_unstruct_indices</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get indices of valid unstructured cells according to a geographic</span>
<span class="sd">    selection&quot;&quot;&quot;</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="s1">&#39;unstruct&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">lons</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">vv</span><span class="p">[</span><span class="n">lon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">vv</span>
        <span class="k">del</span> <span class="n">vv</span>
    <span class="k">elif</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;cc&#39;</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater_equal</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less_equal</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">left</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">right</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">vv</span><span class="p">[</span><span class="n">lat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">vv</span>
        <span class="k">del</span> <span class="n">vv</span>
    <span class="k">elif</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;cc&#39;</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater_equal</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less_equal</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">less</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">left</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">right</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">valid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1">#def get_gridded_selector(grid, lon=None, lat=None, mode=&#39;selector&#39;,</span>
<span class="c1">#                         getmask=False):</span>
<span class="c1">#    &quot;&quot;&quot;Class to help XY selections on grids&quot;&quot;&quot;</span>
<span class="c1">#    assert mode in (&#39;selector&#39;, &#39;dict&#39;), (&#39;mode must be one of dict or &#39;</span>
<span class="c1">#                                          &#39;selector&#39;)</span>
<span class="c1">#</span>
<span class="c1">#    # Grid</span>
<span class="c1">#    grid = get_grid(grid, intercept=False, strict=False)</span>
<span class="c1">#</span>
<span class="c1">#    # Init selector</span>
<span class="c1">#    sel = {}</span>
<span class="c1">#</span>
<span class="c1">#    # Selections</span>
<span class="c1">#    if grid is not None:</span>
<span class="c1">#</span>
<span class="c1">#        assert isgrid(grid, [&#39;rect&#39;, &#39;curv&#39;])</span>
<span class="c1">#        islice, jslice, mask = coord2slice(grid, lon=lon, lat=lat)</span>
<span class="c1">#        sel[grid.getAxis(1).id] = islice</span>
<span class="c1">#        sel[grid.getAxis(0).id] = jslice</span>
<span class="c1">#        if mode == &#39;selector&#39; and getmask:</span>
<span class="c1">#            sel[&#39;mask&#39;] = mask</span>
<span class="c1">#</span>
<span class="c1">#    # Output</span>
<span class="c1">#    if mode == &#39;dict&#39;:</span>
<span class="c1">#        return sel</span>
<span class="c1">#    return cdms2.selectors.Selector(**sel)</span>


<div class="viewcode-block" id="GriddedSelector"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.GriddedSelector">[docs]</a><span class="k">class</span> <span class="nc">GriddedSelector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A :class:`cdms2.selectors.Selector` with grid preprocessing&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_kwargs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">apply_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># Grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">=</span> <span class="n">grid_type</span> <span class="o">=</span> <span class="n">get_grid_type</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Selection specs</span>
        <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">]:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">islice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jslice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span>
                                                              <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">get_unstruct_indices</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_kwargs</span> <span class="o">=</span> <span class="n">update_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_mask</span> <span class="o">=</span> <span class="n">apply_mask</span>

<div class="viewcode-block" id="GriddedSelector.select"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.GriddedSelector.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply selection&quot;&quot;&quot;</span>

        <span class="c1"># No grid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Unstructured</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">:</span>

            <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">asma</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">],</span>
                               <span class="n">lats</span><span class="o">.</span><span class="n">asma</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">],</span>
                               <span class="n">gtype</span><span class="o">=</span><span class="s1">&#39;unstruct&#39;</span><span class="p">,</span>
                               <span class="n">lonatts</span><span class="o">=</span><span class="n">lons</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                               <span class="n">latatts</span><span class="o">=</span><span class="n">lats</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># Rectangular and curvilinear</span>
        <span class="n">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">islice</span><span class="p">,</span>
               <span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jslice</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">sel</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mask</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">mask</span>
        <span class="k">return</span> <span class="n">var</span></div>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">select</span></div>



<div class="viewcode-block" id="gridsel"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.gridsel">[docs]</a><span class="k">def</span> <span class="nf">gridsel</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract a subregion from an axis or a grid</span>

<span class="sd">    Lat and lon generic selection are used for</span>
<span class="sd">    spatial selections.</span>

<span class="sd">    .. note:: Properly works on curved grids thanks to :func:`coord2slice`.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: cdms2 grid or tuple of cdms2 axes.</span>
<span class="sd">        - **lon/lat**, optional: A slice, or a tuple of coordinates, or &#39;:&#39;.</span>

<span class="sd">    :Return:</span>

<span class="sd">        An extraction in the same format as input format</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; gg = gridsel(gg, lon=(-6,4), lat=slice(0,34))</span>
<span class="sd">        &gt;&gt;&gt; lon,lat = gridsel((lon,lat), lat=&#39;:&#39;, lon=(0,2,&#39;ccb&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Format selector specs</span>
    <span class="k">if</span> <span class="n">lon</span><span class="o">==</span><span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">lon</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">lon</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">lon</span> <span class="o">+=</span> <span class="s1">&#39;cc&#39;</span><span class="p">,</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="n">lon</span> <span class="o">+=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">lat</span><span class="o">==</span><span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">lat</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">lat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">lat</span> <span class="o">+=</span> <span class="s1">&#39;cc&#39;</span><span class="p">,</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="n">lat</span> <span class="o">+=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">gg</span>

    <span class="c1"># Format input to always treat a grid</span>
    <span class="n">astuple</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Unstructured grids</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">):</span>

        <span class="n">lons</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">get_unstruct_indices</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">ggo</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">asma</span><span class="p">()[</span><span class="n">ii</span><span class="p">],</span> <span class="n">lats</span><span class="o">.</span><span class="n">asma</span><span class="p">()[</span><span class="n">ii</span><span class="p">],</span> <span class="n">gtype</span><span class="o">=</span><span class="s1">&#39;unstruct&#39;</span><span class="p">,</span>
                          <span class="n">lonatts</span><span class="o">=</span><span class="n">lons</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                          <span class="n">latatts</span><span class="o">=</span><span class="n">lats</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="n">ggo</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">ggo</span>

    <span class="c1"># Selection</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">):</span>  <span class="c1"># Curvilinear</span>

        <span class="c1"># Convert to slices</span>
        <span class="n">islice</span><span class="p">,</span> <span class="n">jslice</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">coord2slice</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>

        <span class="c1"># Select</span>
        <span class="n">islice</span> <span class="o">=</span> <span class="n">islice</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">jslice</span> <span class="o">=</span> <span class="n">jslice</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">subSlice</span><span class="p">(</span><span class="n">jslice</span><span class="p">,</span> <span class="n">islice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">gg</span><span class="o">.</span><span class="n">setMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span> <span class="c1"># Rectangular</span>


        <span class="n">axlon</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">axlat</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>

        <span class="c1"># Selection using slices</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axlon</span><span class="p">))</span>
            <span class="n">axlon</span> <span class="o">=</span> <span class="n">axlon</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="o">*</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axlat</span><span class="p">))</span>
            <span class="n">axlat</span> <span class="o">=</span> <span class="n">axlat</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="o">*</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Selection using coordinates</span>
        <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">lat</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">subGridRegion</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>

    <span class="c1"># Out</span>
    <span class="k">if</span> <span class="n">astuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">(),</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gg</span></div>


<span class="n">select_region</span> <span class="o">=</span> <span class="n">gridsel</span>


<div class="viewcode-block" id="varsel"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.varsel">[docs]</a><span class="k">def</span> <span class="nf">varsel</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract a subregion of a variable</span>

<span class="sd">    Lat and lon generic selection are used for</span>
<span class="sd">    spatial selections.</span>

<span class="sd">    If `var` has no grid or a rectangular grid, it simply</span>
<span class="sd">    equivalent to::</span>

<span class="sd">        var(lon=lon, lat=lat, **kwargs)</span>

<span class="sd">    .. note:: Properly works on curved grids thanks to :func:`coord2slice`.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **var**: MV2 array.</span>
<span class="sd">        - **lon/lat**: Coordinates intervals or slices.</span>
<span class="sd">        - Extra keywords are passed to the variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Gridded selector with caching</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;gridded_selector&#39;</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;gridded_selector&#39;</span><span class="p">]</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">grid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GriddedSelector</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;gridded_selector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gs</span>


    <span class="c1"># Apply it</span>
    <span class="k">return</span> <span class="n">gs</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#    # Rectangular grid</span>
<span class="c1">#    if isgrid(grid, &#39;rect&#39;) and not ext_grid:</span>
<span class="c1">#        return var(lon=lon, lat=lat, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#    # Unstructured grid</span>
<span class="c1">#    if isgrid(grid, &#39;unstruct&#39;):</span>
<span class="c1">#        indices = get_unstruct_indices(grid, lon=lon, lat=lat)</span>
<span class="c1">#        lons = grid.getLongitude()[indices]</span>
<span class="c1">#        lats = grid.getLatitude()[indices]</span>
<span class="c1">#        var = MV2.take(var, indices, axis=-1)</span>
<span class="c1">#        set_grid(var, create_grid(lons, lats))  # FIXME: grid attributes</span>
<span class="c1">#        return var(**kwargs)</span>
<span class="c1">#</span>
<span class="c1">#    # Curved grid</span>
<span class="c1">#    kw = get_gridded_selector(grid, lon=lon, lat=lat, getmask=True,</span>
<span class="c1">#                              mode=&#39;dict&#39;)</span>
<span class="c1">#    kw.update(kwargs)</span>
<span class="c1">#    return var(**kw)</span>


<div class="viewcode-block" id="axis1d_from_bounds"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.axis1d_from_bounds">[docs]</a><span class="k">def</span> <span class="nf">axis1d_from_bounds</span><span class="p">(</span><span class="n">axis1d</span><span class="p">,</span><span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a numeric of formatted 1D axis from bounds</span>

<span class="sd">    - **axis1d**: Input 1d axis from which we get bounds</span>

<span class="sd">    - *numeric*: Return a simple numeric array</span>
<span class="sd">    - *atts*: Attributes for outputs axis</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; xx = axis1d_from_bounds(xxb)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get bounds</span>
    <span class="n">mybounds1d</span> <span class="o">=</span> <span class="n">axis1d</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mybounds1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mybounds1d</span> <span class="o">=</span> <span class="n">bounds1d</span><span class="p">(</span><span class="n">axis1d</span><span class="p">)</span>
        <span class="n">axis1d</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">mybounds1d</span><span class="p">)</span>

    <span class="c1"># Numerical values</span>
    <span class="n">numax</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis1d</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">numax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mybounds1d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mybounds1d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">numax</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mybounds1d</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">mybounds1d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">numeric</span><span class="p">:</span> <span class="k">return</span> <span class="n">numax</span>

    <span class="c1"># Formatted axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">numax</span><span class="p">,</span><span class="n">savespace</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">atts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">att</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="get_xy"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_xy">[docs]</a><span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checklims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get axes from gg</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: (xx,yy) or grid (1D or 2D), cdms variable (see :func:`get_grid`),</span>
<span class="sd">          or a dict of lon/lat/x/y, or a (2,npts) numpy array.</span>
<span class="sd">        - **proj**, optional: If True or basemap instance, convert to meters.</span>
<span class="sd">          If None, check if lon and lat axes to force conversion. [default: False]</span>
<span class="sd">        - **mesh**, optional: Get axes as 2D arrays.</span>
<span class="sd">        - **num**, optional: Get axes as numpy arrays.</span>
<span class="sd">        - **checklims**, optional: For 2D axes only, mask longitudes outside (-720,720),</span>
<span class="sd">          and clip latitude outside (-90,90).</span>
<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; lon, lat = get_xy((xaxis,yaxis))</span>
<span class="sd">        &gt;&gt;&gt; lon, lat = get_xy(grid)</span>
<span class="sd">        &gt;&gt;&gt; x, y = get_xy(dict(lon=(-10,0), lat=(42,43,&#39;cc&#39;)), proj=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get axes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">xy</span><span class="p">):</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">xy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">):</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">x</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">()</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">gg</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># (xmin,xmax,&#39;ccb&#39;)</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xx</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="ow">and</span> \
        <span class="n">gg</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">gg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">]]:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">gg</span><span class="p">:</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">gg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pp</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Dictionay has no </span><span class="si">%s</span><span class="s1"> key&#39;</span><span class="o">%</span><span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">xy</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">yy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">gg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>  <span class="s1">&#39;Input must be at least a 2D array in this case&#39;</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Pure numeric?</span>
    <span class="n">xxn</span> <span class="o">=</span> <span class="n">_cdat2num_</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">yyn</span> <span class="o">=</span> <span class="n">_cdat2num_</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xxn</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yyn</span>

    <span class="c1"># Check limits of 2D axes</span>
    <span class="k">if</span> <span class="n">checklims</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xxn</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxn</span><span class="o">&lt;-</span><span class="mi">720</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">xxn</span><span class="o">&gt;</span><span class="mi">720</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="n">xx</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">yyn</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxn</span><span class="o">&lt;-</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">xxn</span><span class="o">&gt;</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="n">yy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">yy</span><span class="p">[:],</span> <span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">yy</span><span class="p">[:],</span> <span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">)</span>

    <span class="c1"># Convert to meters?</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># and islon(xx) and islat(yy):</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">deg2xy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Mesh ?</span>
    <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="c1"># and (xx[:].ndim == 1 or  yy[:].ndim == 1):</span>
        <span class="k">return</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xxn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xxn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">yyn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">xxn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span>  <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span></div>

<span class="k">def</span> <span class="nf">_cdat2num_</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert CDAT axis or variable to numeric (masked) form&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;asma&#39;</span><span class="p">):</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;getValue&#39;</span><span class="p">):</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xy</span>

<div class="viewcode-block" id="deg2xy"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.deg2xy">[docs]</a><span class="k">def</span> <span class="nf">deg2xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert from degrees to map (m) coordinates using map projection, and reverse</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **lon**: Longitudes in degrees</span>
<span class="sd">        - **lat**: Latitude in degrees</span>
<span class="sd">        - **proj**, optional: Proj object for projection. If False, returns (lon,lat).</span>
<span class="sd">          If None, a new instance using :func:`~vacumm.misc.grid.basemap.get_proj` is created,</span>
<span class="sd">          where proj is passed as a parameter.</span>
<span class="sd">        - **inverse**, optional: Inverse transform (from meters to degrees)</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; x, y = deg2xy(lon, lat)</span>
<span class="sd">        &gt;&gt;&gt; x2d, y2d = deg2xy(lon, lat, mesh=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check shapes</span>
    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">check_xy_shape</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>

    <span class="c1"># Nothing to do</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

    <span class="c1"># Check if we are sure to not have degrees</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inverse</span> <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">&gt;</span> <span class="mf">720.</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

    <span class="c1"># Need a projection instance</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">proj</span><span class="p">):</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">get_proj</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>

    <span class="c1"># Transform</span>
    <span class="k">return</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="n">inverse</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_dist2x2d_</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pairwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">get_distances</span><span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">yy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
        <span class="n">get_distances</span><span class="p">(</span><span class="n">xx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">yy</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>  <span class="o">**</span><span class="n">kw</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_dist1x1d_</span><span class="p">(</span><span class="n">xxyy</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pairwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">dslices</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">xxyy</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>

<div class="viewcode-block" id="resol"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.resol">[docs]</a><span class="k">def</span> <span class="nf">resol</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>  <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">checklims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the resolution of an axis or a grid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **axy**: It can be either</span>

<span class="sd">            - a 1D axis or array</span>
<span class="sd">            - a grid of 1D or 2D axes or tuple of (lon,lat)</span>

<span class="sd">        - **mode**, optional:</span>

<span class="sd">            - ``&quot;raw&quot;``: Get the local resolution between &quot;grid points&quot;.</span>
<span class="sd">            - ``&quot;averaged&quot;``: Return an averaged resolution (do not use if the grid highly anisotropic!!).</span>
<span class="sd">            - ``&quot;local&quot;``: The local resolution is averaged and extrapolated to grid points.</span>
<span class="sd">            - A string: An :mod:`numpy` attribute is used to compute the resolution.</span>
<span class="sd">              For instance ``&quot;median&quot;`` mode implies the use of :func:`numpy.median`.</span>
<span class="sd">            - A callable function: Directly used to compute the resolution.</span>

<span class="sd">        - **meters**, optional: Get the resolution in meters instead of degrees.</span>
<span class="sd">        - **axis**, optional: Direction on which to compute resolution if a single</span>
<span class="sd">          2D axis is passed.</span>
<span class="sd">        - **lat**, optional:: Latitude to use for projection of 1D zonal axis.</span>

<span class="sd">          .. warning:: If not provided but needed, it defaults to 45. and</span>
<span class="sd">            a warning is emitted.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        If you work on a pair of 2D axes, resolution is computed along</span>
<span class="sd">        grid axes, and NOT along X and Y.</span>
<span class="sd">        In this case, X and Y must have consistent units,</span>
<span class="sd">        and resolution along X and Y are defined by:</span>

<span class="sd">        .. math::</span>

<span class="sd">            dx_{i,j} = \sqrt{(x_{i+1,j}-x_{i,j})^2+ (y_{i+1,j}-y_{i,j})^2}</span>

<span class="sd">            dy_{i,j} = \sqrt{(x_{i,j+1}-x_{i,j})^2+ (y_{i,j+1}-y_{i,j})^2}</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; dx = resol(lon)</span>
<span class="sd">        &gt;&gt;&gt; dx,dy = resol(grid)</span>
<span class="sd">        &gt;&gt;&gt; dx2d = resol(x2d, mode=&#39;loc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dx2d, dy2d = resol((x1d, y2d))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get what to inspect</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">axy</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">axy</span><span class="p">):</span>
            <span class="n">axy</span> <span class="o">=</span> <span class="n">axy</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">axy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;You must pass a variable with a grid&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axy</span> <span class="o">=</span> <span class="n">axy</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>

    <span class="c1"># Meters?</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proj</span><span class="p">:</span> <span class="n">meters</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">meters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">meters</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check chache (for cdms grid and axes)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;averaged&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># compat</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;averaged&#39;</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">):</span>
        <span class="n">suf</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span> <span class="k">if</span> <span class="n">meters</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">pres</span> <span class="o">=</span> <span class="s1">&#39;res&#39;</span><span class="o">+</span><span class="s1">&#39;m&#39;</span> <span class="k">if</span> <span class="n">meters</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="c1"># Numerical values</span>
    <span class="n">single</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axy</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">axy</span> <span class="o">=</span> <span class="n">axy</span><span class="p">[:]</span>
        <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">axy</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># single axis</span>
        <span class="k">if</span> <span class="n">single</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span> <span class="k">if</span> <span class="n">islon</span><span class="p">(</span><span class="n">axy</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">axy</span><span class="p">):</span> <span class="n">axy</span> <span class="o">=</span> <span class="n">axy</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">axy</span><span class="p">,</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># grid or pair of axes &gt; convert to 2D arrays</span>
        <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">xy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checklims</span><span class="o">=</span><span class="n">checklims</span><span class="p">)</span>


    <span class="c1"># Local distances</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">distmode</span> <span class="o">=</span> <span class="s1">&#39;haversine&#39;</span> <span class="k">if</span> <span class="n">meters</span> <span class="k">else</span> <span class="s1">&#39;simple&#39;</span>
    <span class="n">kwdist</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">distmode</span><span class="p">)</span>
    <span class="n">warnlatmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Your axis resolution along X is computed with a default &quot;</span>
        <span class="s2">&quot;latitude of 45. You should also provide a valid Y axis or &quot;</span>
        <span class="s2">&quot;at least set this latitude properly with the lat parameter.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># 2x2D</span>

        <span class="n">xy</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_dist2x2d_</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwdist</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Single 1D or 2D</span>

        <span class="n">kwdist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pairwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># 2D</span>

            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atype</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">axis</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">+=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">atype</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="mf">45.</span>
                    <span class="n">vcwarn</span><span class="p">(</span><span class="n">warnlatmsg</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_distances</span><span class="p">(</span><span class="n">axy</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]],</span> <span class="n">lat</span><span class="p">,</span> <span class="n">axy</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]],</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdist</span><span class="p">),</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_distances</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axy</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axy</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwdist</span><span class="p">),</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">atype</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="mf">45.</span>
                    <span class="n">vcwarn</span><span class="p">(</span><span class="n">warnlatmsg</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_distances</span><span class="p">(</span><span class="n">axy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat</span><span class="p">,</span> <span class="n">axy</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdist</span><span class="p">),</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_distances</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axy</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">**</span><span class="n">kwdist</span><span class="p">),</span>


    <span class="c1"># Averages</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># 2D</span>
            <span class="n">eres</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kk</span><span class="p">):</span>

                <span class="c1"># Init output</span>
                <span class="n">eshape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">eshape</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">eres</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">],</span> <span class="n">eshape</span><span class="p">),</span>

                <span class="c1"># Slices specs</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">sle</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">eshape</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                <span class="c1"># Core</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sle</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]]</span><span class="o">+</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]])</span>

                <span class="c1"># Limits</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sle</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;firstp1&#39;</span><span class="p">]]</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sle</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;lastm1&#39;</span><span class="p">]]</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">eres</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># 1D</span>

            <span class="n">eres</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">)):</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">eres</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">eres</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">eres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">dcell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ave&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">func</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">eres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">dcell</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">eres</span><span class="p">)</span>

    <span class="c1"># Caching</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">axy</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_mres&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">axy</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pres</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">axy</span><span class="p">,</span> <span class="s1">&#39;_mres&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

<span class="c1">#    print &#39; res&#39;, repr(res)</span>
    <span class="k">if</span> <span class="n">single</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="check_xy_shape"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.check_xy_shape">[docs]</a><span class="k">def</span> <span class="nf">check_xy_shape</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that xx and yy have the same shape</span>

<span class="sd">    - **xx**: X positions (in meters or degrees).</span>
<span class="sd">    - **yy**: Y positions (in meters or degrees).</span>
<span class="sd">    - *mesh*: Return a 2D axes if True, or if None and xx and yy have not the same shape [default: None]</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; xx2d, yy2d = check_xy_shape(xx, yy, mesh=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Numpy arrays</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xx</span><span class="p">[:])</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">[:])</span>

    <span class="c1"># Check if we want 2D axes</span>
    <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Go</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh</span><span class="p">:</span> <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
    <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">yy</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span> <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>
    <span class="k">if</span> <span class="n">xx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">yy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;xx and yy must be 1D for meshgrid transform.&#39;</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span></div>


<div class="viewcode-block" id="t2uvgrids"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.t2uvgrids">[docs]</a><span class="k">def</span> <span class="nf">t2uvgrids</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">getu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a (C) grid at T-points to a grid at U- and/or V- points</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A (x,y) or a cdms grid or a cdms variable with a grid (see :func:`get_grid`)</span>
<span class="sd">        - *getu*: Get the grid at U-points [default: True]</span>
<span class="sd">        - *getv*: Get the grid at V-points [default: True]</span>
<span class="sd">        - *mask*: If False, do not try to guess masks ; if None, try to get them from</span>
<span class="sd">          original grid by conversion to U and V points with t2uvmask() [default: None]</span>

<span class="sd">    :Return: ``ugrid,vgrid`` OR ``ugrid`` OR ``vgrid`` depending on getu and getv</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; gridu, gridv = t2uvgrids(gridt)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">getu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">getv</span><span class="p">:</span> <span class="k">return</span>
    <span class="c1"># Get rights axes</span>
    <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span> <span class="n">gg</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getMask</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">islon</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">islat</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="c1"># U-points</span>
    <span class="k">if</span> <span class="n">getu</span><span class="p">:</span>
        <span class="n">xu</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">xu</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">xu</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">xu</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39; at U-points&#39;</span>
        <span class="n">yu</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">gu</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createRectGrid</span><span class="p">(</span><span class="n">yu</span><span class="p">,</span> <span class="n">xu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gu</span><span class="o">.</span><span class="n">setMask</span><span class="p">(</span><span class="n">t2uvmasks</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span> <span class="n">getv</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getv</span><span class="p">:</span> <span class="k">return</span> <span class="n">gu</span>
    <span class="c1"># V-points</span>
    <span class="n">yv</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">yv</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">yy</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">yv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">yv</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39; at V-points&#39;</span>
    <span class="n">xv</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">gv</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createRectGrid</span><span class="p">(</span><span class="n">yv</span><span class="p">,</span> <span class="n">xv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gv</span><span class="o">.</span><span class="n">setMask</span><span class="p">(</span><span class="n">t2uvmasks</span><span class="p">(</span><span class="n">vmask</span><span class="p">,</span> <span class="n">getu</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">getu</span><span class="p">:</span> <span class="k">return</span> <span class="n">gv</span>
    <span class="k">return</span> <span class="n">gu</span><span class="p">,</span> <span class="n">gv</span></div>




<div class="viewcode-block" id="rotate_grid"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.rotate_grid">[docs]</a><span class="k">def</span> <span class="nf">rotate_grid</span><span class="p">(</span><span class="n">ggi</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a grid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **ggi**: Cdms grid ou (lon,lat) or variable (see :func:`get_grid`).</span>
<span class="sd">        - **angle**: Angle in degrees.</span>
<span class="sd">        - **pivot**, optional: it can be either</span>

<span class="sd">            - A tuple of (lon, lat)</span>
<span class="sd">            - A string that specify the vertical and horizontal position.</span>
<span class="sd">              Use the following keys : ``top``, ``bottom``, ``left``, ``right``, ``center``.</span>

<span class="sd">        - Other keywords are passed to :func:`~vacumm.misc.grid.curv_grid`</span>

<span class="sd">    :Returns: A curvilinear cdms grid.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; mygrid = rotate_grid((lon,lat), 60., &#39;top right&#39;)</span>
<span class="sd">        &gt;&gt;&gt; mygrid2 = rotate_grid(mygrid, 60., (-5.,45))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get 2D axes</span>
    <span class="n">xxi</span><span class="p">,</span> <span class="n">yyi</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">get_xy</span><span class="p">(</span><span class="n">ggi</span><span class="p">))</span>

    <span class="c1"># Find pivot</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pivot</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">xpivot</span><span class="p">,</span> <span class="n">ypivot</span> <span class="o">=</span> <span class="n">pivot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xxi</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span><span class="n">pivot</span> <span class="o">=</span> <span class="s1">&#39;center center&#39;</span>
        <span class="n">sxpivot</span><span class="p">,</span> <span class="n">sypivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">ipivot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sxpivot</span><span class="p">)]</span>
        <span class="n">jpivot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][[</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sypivot</span><span class="p">)]</span>
        <span class="n">xpivot</span> <span class="o">=</span> <span class="n">xxi</span><span class="p">[</span><span class="n">jpivot</span><span class="p">,</span> <span class="n">ipivot</span><span class="p">]</span>
        <span class="n">ypivot</span> <span class="o">=</span> <span class="n">yyi</span><span class="p">[</span><span class="n">jpivot</span><span class="p">,</span> <span class="n">ipivot</span><span class="p">]</span>

    <span class="c1"># Rotate</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
    <span class="n">xxo</span> <span class="o">=</span> <span class="n">xpivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">xxi</span><span class="o">-</span><span class="n">xpivot</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">yyi</span><span class="o">-</span><span class="n">ypivot</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">yyo</span> <span class="o">=</span> <span class="n">ypivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">xxi</span><span class="o">-</span><span class="n">xpivot</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">yyi</span><span class="o">-</span><span class="n">ypivot</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">create_curv_grid</span><span class="p">(</span><span class="n">xxo</span><span class="p">,</span> <span class="n">yyo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="monotonic"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.monotonic">[docs]</a><span class="k">def</span> <span class="nf">monotonic</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make monotonic an array of longitudes</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; xxm = monotonic(xx, xref=120.)</span>
<span class="sd">    &gt;&gt;&gt; print (N.diff(xxm)&lt;0).any()</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Longitude reference</span>
    <span class="n">modulo</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">modulo</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="s1">&#39;modulo&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">360.</span>
    <span class="k">if</span> <span class="n">xref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">[:]</span><span class="o">-</span><span class="n">xref</span><span class="p">)</span><span class="o">%</span><span class="n">modulo</span><span class="o">+</span><span class="n">xref</span>

    <span class="c1"># Monotonic modulo</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bigsteps</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">&gt;</span><span class="n">modulo</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bigsteps</span><span class="p">):</span> <span class="k">return</span> <span class="n">xx</span>
    <span class="n">fixsteps</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bigsteps</span><span class="p">,</span> <span class="o">-</span><span class="n">modulo</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">fixsteps</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">fixsteps</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">fixsteps</span>
    <span class="k">return</span> <span class="n">xx</span></div>



<div class="viewcode-block" id="xextend"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.xextend">[docs]</a><span class="k">def</span> <span class="nf">xextend</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extend a variable along x axis</span>

<span class="sd">    .. note:: x is the last axis and must be 1D</span>

<span class="sd">    .. todo::</span>

<span class="sd">        Make possible to use 2D axes with :func:`xextend`</span>

<span class="sd">    :Parameters:</span>

<span class="sd">        - **vari**: :mod:`cdms2` variable</span>
<span class="sd">        - **n**: size of the extention</span>

<span class="sd">            - if an integer: ``nleft = nright = n``</span>
<span class="sd">            - else: nleft, nright = n</span>

<span class="sd">        - **mode**, optional: mode of extension</span>

<span class="sd">            - ``None``: choose ``&quot;cyclic&quot;`` is x axis</span>
<span class="sd">              has a &quot;modulo&quot; attribute</span>
<span class="sd">            - ``&quot;cyclic&quot;``: assume x axis is cyclic</span>
<span class="sd">            - ``&quot;constant&quot;``: extrapolate with first or last values</span>
<span class="sd">            - else, extend with masked values</span>
<span class="sd">              and linearly extrapolate positions</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; varo = xextend(vari, (5, 7), mode=&#39;cyclic&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get extension sizes and mode</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;modulo&#39;</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;cyclic&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">nleft</span><span class="p">,</span> <span class="n">nright</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nleft</span> <span class="o">=</span> <span class="n">nright</span> <span class="o">=</span> <span class="n">n</span>

    <span class="c1"># Intialize</span>
    <span class="n">nxi</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nxo</span> <span class="o">=</span> <span class="n">nleft</span><span class="o">+</span><span class="n">nxi</span><span class="o">+</span><span class="n">nright</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vari</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nxo</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vari</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nleft</span><span class="p">:</span><span class="n">nleft</span><span class="o">+</span><span class="n">nxi</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">varo</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>

    <span class="c1"># Extend</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;cyclic&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="s1">&#39;modulo&#39;</span><span class="p">):</span>
            <span class="n">modulo</span> <span class="o">=</span> <span class="mf">360.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modulo</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">modulo</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">nleft</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nxi</span><span class="o">-</span><span class="n">nleft</span><span class="p">:]</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nxo</span><span class="o">-</span><span class="n">nright</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">nright</span><span class="p">]</span>
        <span class="n">xleft</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">nxi</span><span class="o">-</span><span class="n">nleft</span><span class="p">:]</span><span class="o">-</span><span class="n">modulo</span>
        <span class="n">xright</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[:</span><span class="n">nright</span><span class="p">]</span><span class="o">+</span><span class="n">modulo</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dx0</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dx1</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">xleft</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleft</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx0</span>
        <span class="n">xright</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nright</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx1</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ileft</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nleft</span><span class="p">):</span>
                <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ileft</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iright</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nright</span><span class="p">):</span>
                <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nxo</span><span class="o">-</span><span class="n">iright</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Insert axes</span>
    <span class="n">xin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">xo</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xleft</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">xright</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">xin</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xo</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xo</span>
    <span class="n">varo</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">varo</span></div>

<div class="viewcode-block" id="xshift"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.xshift">[docs]</a><span class="k">def</span> <span class="nf">xshift</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">monot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shift a cyclic array along x axis</span>

<span class="sd">    .. note:: x is the last axis and must be 1D</span>

<span class="sd">    .. todo::</span>

<span class="sd">        Make possible to use 2D axes with :func:`xshift`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vari**: :mod:`cdms2` variable</span>
<span class="sd">        - **n**: size of the shift</span>

<span class="sd">            Positive means east bound is moved toward east.</span>
<span class="sd">            If ``mode is None``:</span>

<span class="sd">            - if an integer, use it as grid points</span>
<span class="sd">            - else (a float), use at as degrees.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; varo = xshift(vari, 50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get shift value</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
<span class="c1">#    if mode==&#39;left&#39;:</span>
<span class="c1">#</span>
<span class="c1">#    if mode is None:</span>
<span class="c1">#        if not isinstance(n, int):</span>
<span class="c1">#            n = float(n)</span>


    <span class="c1"># Intialize</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">xo</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">varo</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">:]</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">xo</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
        <span class="n">xo</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
        <span class="n">varo</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">:]</span>
        <span class="n">xo</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
        <span class="n">xo</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">varo</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">varo</span></div>


<div class="viewcode-block" id="curv2rect"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.curv2rect">[docs]</a><span class="k">def</span> <span class="nf">curv2rect</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a curvilinear grid to a rectangular grid</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This not an interpolation.</span>
<span class="sd">        Longitudes and latitudes are converted from 2D arrays</span>
<span class="sd">        to 1D arrays using axis averages.</span>

<span class="sd">    :Params:</span>

<span class="sd">      - **gg**: Grid, tuple of axes or MV2 variable.</span>
<span class="sd">      - **mode**, optional: what ot do when it does not seems to be rectangular</span>

<span class="sd">            - ``&quot;warn&quot;``: simply show a warning,</span>
<span class="sd">            - ``&quot;raise&quot;``: raise a :class:`VACUMMError`,</span>
<span class="sd">            - ``&quot;none&quot;`` or ``False``: don&#39;t do it.</span>
<span class="sd">            - else just convert it at your own risks.</span>
<span class="sd">        - **tol**, optional: Tolerance (passed to :func:`isrect`).</span>
<span class="sd">        - **f**, optional: File object or name (passed to :func:`isrect`).</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; rgrid = curv2rect(cgrid)</span>
<span class="sd">        &gt;&gt;&gt; rgrid = curv2rect((lon2d,lat2d))</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: A variable or a curvilinear grid (see :func:`get_grid`)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># MV2 variable</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">gg</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="n">rgrid</span> <span class="o">=</span> <span class="n">curv2rect</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">rgrid</span><span class="p">:</span>
            <span class="n">set_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">rgrid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gg</span>

    <span class="c1"># Is it rectangular?</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="n">gtype</span> <span class="o">=</span> <span class="n">get_grid_type</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gtype</span> <span class="o">==</span> <span class="s1">&#39;rect&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gg</span>
    <span class="k">elif</span> <span class="n">gtype</span> <span class="o">!=</span> <span class="s1">&#39;curv&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isrect</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;warn&quot;</span><span class="p">:</span>
            <span class="n">vcwarn</span><span class="p">(</span><span class="s2">&quot;Grid seems not rectangular. Not converted.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gg</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;raise&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Cannot convert to rectangular grid&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gg</span>

    <span class="c1"># Convert it</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">grido</span> <span class="o">=</span>  <span class="n">create_grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">)</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">(),</span> <span class="n">grido</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">())</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">(),</span> <span class="n">grido</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">grido</span></div>

<div class="viewcode-block" id="isrect"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isrect">[docs]</a><span class="k">def</span> <span class="nf">isrect</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check wether a grid is trully rectangular</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **gg**: cdms2 grid, tuple of cdms axes or variabe with a grid.</span>
<span class="sd">        - **tol**, optional: Tolerance for coordinates deformation.</span>
<span class="sd">        - **mode**, optional: Simple or real check.</span>

<span class="sd">            - ``&quot;simple&quot;``: Simply check if axes are 1D.</span>
<span class="sd">            - ``&quot;real&quot;``: Also check that axes along one direction do</span>
<span class="sd">              vary along the other direction with tolerance tol.</span>

<span class="sd">        - **f**, optional: netcdf file object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check that it&#39;s a grid</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">get_grid</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Already rectangular</span>
    <span class="n">gtype</span> <span class="o">=</span> <span class="n">get_grid_type</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
<span class="c1">#    if not mode.startswith(&#39;r&#39;):</span>
<span class="c1">#        return gtype == &#39;rect&#39;</span>
    <span class="k">if</span> <span class="n">gtype</span> <span class="o">==</span> <span class="s1">&#39;rect&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">gtype</span> <span class="o">==</span> <span class="s1">&#39;unstruct&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># File grid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocache</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">...misc.io</span> <span class="k">import</span> <span class="n">ncget_fgrid</span>
        <span class="n">fgrid</span> <span class="o">=</span> <span class="n">ncget_fgrid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">gg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fgrid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># From cache</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocache</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">fgrid</span><span class="p">,</span> <span class="n">gg</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="s1">&#39;_vacumm_isrect&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">_vacumm_isrect</span>

    <span class="c1"># Check if this grid is really rectangular</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">((</span><span class="n">xx</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span>
            <span class="n">tol</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span>
           <span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span>
            <span class="n">tol</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="c1">#    # - resolution from cache</span>
<span class="c1">#    for grid in fgrid, gg:</span>
<span class="c1">#        if grid is None: continue</span>
<span class="c1">#        res = resol(grid, cache=2)</span>
<span class="c1">#        if res is not None:</span>
<span class="c1">#            break</span>
<span class="c1">#    else:</span>
<span class="c1">#        res = resol(gg)</span>
<span class="c1">#        if fgrid is not None:</span>
<span class="c1">#            fgrid._res = res</span>
<span class="c1">#    dx, dy = res</span>
<span class="c1">#    # - relative resolution variations</span>
<span class="c1">#    xx, yy = get_xy(gg, num=True)</span>
<span class="c1">#    xx = N.ma.masked_outside(xx, -720., 720., copy=False)</span>
<span class="c1">#    yy = N.ma.clip(yy, -90, 90.)</span>
<span class="c1">#    Dx = N.ma.median(xx.ptp(axis=0))</span>
<span class="c1">#    Dy = N.ma.median(yy.ptp(axis=-1))</span>
<span class="c1">#    res = Dx &lt; tol*dx and Dy &lt; tol*dy</span>

    <span class="c1"># Cache result</span>
    <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">gg</span><span class="p">,</span> <span class="n">fgrid</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">_vacumm_isrect</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="transect_specs"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.transect_specs">[docs]</a><span class="k">def</span> <span class="nf">transect_specs</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">getxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getproj</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get specs for a transect given a grid and starting and ending points</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **lon/lat0/1**: Coordinates of first and last point in degrees.</span>
<span class="sd">        - **subsamp**, optional: Subsampling with respect to grid cell.</span>
<span class="sd">        - **getxy**, optional: Also return projected coordinates.</span>
<span class="sd">        - **getproj**, optional: Also return projection map.</span>

<span class="sd">    :Return: lons, lats[, xx, yy][, proj]</span>

<span class="sd">    :See also: :func:`resol`, :meth:`mpl_toolkits.basemap.Basemap.gcpoints`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bounds and resolution</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">resol</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;merc&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">resol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;merc&#39;</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">)</span>
    <span class="n">Dx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">Dy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>

    <span class="c1"># Number of points</span>
    <span class="k">if</span> <span class="n">dy</span><span class="o">*</span><span class="n">Dx</span> <span class="o">&gt;</span> <span class="n">dx</span><span class="o">*</span><span class="n">Dy</span><span class="p">:</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="n">Dx</span><span class="o">/</span><span class="n">dx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="n">Dy</span><span class="o">/</span><span class="n">dy</span>
    <span class="n">npts</span> <span class="o">*=</span> <span class="n">subsamp</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">npts</span><span class="p">))</span>

    <span class="c1"># Coordinates</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">gcpoints</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getxy</span><span class="p">:</span> <span class="n">ret</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getproj</span><span class="p">:</span> <span class="n">ret</span> <span class="o">+=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="depth2dz"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.depth2dz">[docs]</a><span class="k">def</span> <span class="nf">depth2dz</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert from depth to layer thickness</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **depth**: 1D or ND array of depth (variable or axis).</span>
<span class="sd">        - **axis**, optional: Axis of vertical dimension.</span>
<span class="sd">          It is guessed of not provided.</span>
<span class="sd">        - **mode**, optional: Mode for defining the reference layer.</span>
<span class="sd">          Possible values: ``&#39;first&#39;``, ``&#39;last&#39;``, ``center`` or ``None``.</span>
<span class="sd">          It is either the first or the last layer. The layer is</span>
<span class="sd">          computed normally like other layer by difference,</span>
<span class="sd">          whereas its opposite (hidden) layer is either masked or has its</span>
<span class="sd">          thickness set the the thickness of its adjacent layer.</span>
<span class="sd">          If ``mode`` is set to ``None``, it set to ``&#39;last&#39;``</span>
<span class="sd">          if depths are positive up.</span>
<span class="sd">        - **masked**, optional: If True, hidden layer is masked.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Init</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">dz</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;Layer thickness&quot;</span>
        <span class="n">dz</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;dz&#39;</span>
        <span class="n">dz</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
    <span class="k">elif</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">masked</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">dz</span><span class="p">):</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
        <span class="n">dz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="c1"># Guess axis to work on</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">_getzdim_</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="c1"># Priority mode</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">]:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))]</span>

    <span class="c1"># Compute</span>
    <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dz</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">dz</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;last&#39;</span><span class="p">:</span>

        <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]]</span><span class="o">-</span><span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
            <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firstp1&#39;</span><span class="p">]]</span>

    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;first&#39;</span><span class="p">:</span>

        <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]]</span><span class="o">-</span><span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lasts&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
            <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lastm1&#39;</span><span class="p">]]</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># center</span>

        <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lastsp1&#39;</span><span class="p">]]</span><span class="o">-</span><span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firstsm1&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
            <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;firstp1&#39;</span><span class="p">]]</span>
            <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dz</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;lastm1&#39;</span><span class="p">]]</span>

    <span class="n">dz</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dz</span></div>

<div class="viewcode-block" id="get_axis_slices"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_axis_slices">[docs]</a><span class="k">def</span> <span class="nf">get_axis_slices</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get standard slices for an axis of a ndim array</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **ndim**: The number of dimensions. It can also be</span>
<span class="sd">          a tuple (like an array shape) or an array.</span>
<span class="sd">        - **axis**: Index of the axis.</span>

<span class="sd">    :Return: A dictionary of tuples of slices. All tuples have a</span>
<span class="sd">        length of ndim, and can be used has a slice for the array</span>
<span class="sd">        (see example).</span>

<span class="sd">        - &quot;all&quot;: Select everything.</span>
<span class="sd">        - &quot;first&quot;/&quot;last&quot;: First and last.</span>
<span class="sd">        - &quot;firstp1&quot;: Second element.</span>
<span class="sd">        - &quot;firstp2&quot;: Third element.</span>
<span class="sd">        - &quot;lastm1&quot;: Element before the last one.</span>
<span class="sd">        - &quot;lastm2&quot;: Second element before the last one.</span>
<span class="sd">        - &quot;firsts&quot;: All but the last.</span>
<span class="sd">        - &quot;lasts&quot;: All but the first.</span>
<span class="sd">        - &quot;firstsm1&quot;: All but the last two.</span>
<span class="sd">        - &quot;lastsp1&quot;: All but the first two.</span>
<span class="sd">        - &quot;mid&quot;: All but the first and last.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; var = N.arange(3*4).reshape(3, 4)</span>
<span class="sd">        &gt;&gt;&gt; ss = get_axis_slices(var, axis=0)</span>
<span class="sd">        &gt;&gt;&gt; var_north = var[ss[&#39;last&#39;]]</span>
<span class="sd">        &gt;&gt;&gt; var_south = var[ss[&#39;first&#39;]]</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">ndim</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="n">ndim</span>
    <span class="n">selmid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selmid</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span> <span class="n">selmid</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selmid</span><span class="p">)</span>
    <span class="n">sellasts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellasts</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellasts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sellasts</span><span class="p">)</span>
    <span class="n">selfirsts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirsts</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirsts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selfirsts</span><span class="p">)</span>
    <span class="n">sellastsp1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellastsp1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellastsp1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sellastsp1</span><span class="p">)</span>
    <span class="n">selfirstsm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirstsm1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirstsm1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selfirstsm1</span><span class="p">)</span>
    <span class="n">sellast</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellast</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="n">sellast</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sellast</span><span class="p">)</span>
    <span class="n">selfirst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirst</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">selfirst</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selfirst</span><span class="p">)</span>
    <span class="n">sellastm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellastm1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="p">;</span> <span class="n">sellastm1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sellastm1</span><span class="p">)</span>
    <span class="n">sellastm2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">sellastm2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="p">;</span> <span class="n">sellastm2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sellastm2</span><span class="p">)</span>
    <span class="n">selfirstp1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirstp1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">selfirstp1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selfirstp1</span><span class="p">)</span>
    <span class="n">selfirstp2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">;</span> <span class="n">selfirstp2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">selfirstp2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selfirstp2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">)</span>
            <span class="n">ksel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="n">ksel</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ksel</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="n">sel</span><span class="p">,</span> <span class="n">mid</span><span class="o">=</span><span class="n">selmid</span><span class="p">,</span> <span class="n">lasts</span><span class="o">=</span><span class="n">sellasts</span><span class="p">,</span> <span class="n">firsts</span><span class="o">=</span><span class="n">selfirsts</span><span class="p">,</span>
        <span class="n">lastsp1</span><span class="o">=</span><span class="n">sellastsp1</span><span class="p">,</span> <span class="n">firstsm1</span><span class="o">=</span><span class="n">selfirstsm1</span><span class="p">,</span>
        <span class="n">last</span><span class="o">=</span><span class="n">sellast</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">selfirst</span><span class="p">,</span> <span class="n">lastm1</span><span class="o">=</span><span class="n">sellastm1</span><span class="p">,</span> <span class="n">firstp1</span><span class="o">=</span><span class="n">selfirstp1</span><span class="p">,</span>
        <span class="n">lastm2</span><span class="o">=</span><span class="n">sellastm2</span><span class="p">,</span> <span class="n">firstp2</span><span class="o">=</span><span class="n">selfirstp2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="merge_axis_slices"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.merge_axis_slices">[docs]</a><span class="k">def</span> <span class="nf">merge_axis_slices</span><span class="p">(</span><span class="n">slices1</span><span class="p">,</span> <span class="n">slices2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge standard tuples of slices stored in dictionaries created with :func:`get_axis_slices`:</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **slice1/2**: Dictionaries of tuples of slices.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; slicesx = get_axis_slices(3, -1)  # for X</span>
<span class="sd">        &gt;&gt;&gt; slicesy = get_axis_slices(3, -2)  # for Y</span>
<span class="sd">        &gt;&gt;&gt; slices12 = merge_axis_slices(slicesx, slicesy) # for X and Y</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">slicesm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">null</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slices1</span><span class="p">:</span>
        <span class="n">slicesm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_axis_slice</span><span class="p">(</span><span class="n">slices1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">slices2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">slicesm</span></div>

<div class="viewcode-block" id="merge_axis_slice"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.merge_axis_slice">[docs]</a><span class="k">def</span> <span class="nf">merge_axis_slice</span><span class="p">(</span><span class="n">sel1</span><span class="p">,</span> <span class="n">sel2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge a single tuple of slices</span>

<span class="sd">    Theses slices may have been created with :func:`get_axis_slices`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **sel1/2**: Tuples of slices.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; sel1 = (slice(None), -2)</span>
<span class="sd">        &gt;&gt;&gt; sel2 = (slice(1,4), slice(None)</span>
<span class="sd">        &gt;&gt;&gt; merge_axis_slice(sel1, sel2)</span>
<span class="sd">        (slice(1, 4, None), -2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndim1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span>
    <span class="n">ndim2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel2</span><span class="p">)</span>
    <span class="n">sel1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span>
    <span class="n">sel2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel2</span><span class="p">)</span>
    <span class="n">selm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ndim1</span><span class="o">&lt;</span><span class="n">ndim2</span><span class="p">:</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim2</span><span class="o">-</span><span class="n">ndim1</span><span class="p">)</span><span class="o">+</span><span class="n">sel1</span>
    <span class="k">elif</span> <span class="n">ndim1</span><span class="o">&gt;</span><span class="n">ndim2</span><span class="p">:</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim1</span><span class="o">-</span><span class="n">ndim2</span><span class="p">)</span><span class="o">+</span><span class="n">sel2</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sel1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">sel1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">==</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="n">sel1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">Ellipsis</span> <span class="ow">or</span> <span class="n">sel1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">selm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sel2</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sel1</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selm</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_zdim"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_zdim">[docs]</a><span class="k">def</span> <span class="nf">get_zdim</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the index of the Z dimension&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">axis</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">isdep</span><span class="p">(</span><span class="n">var</span><span class="p">)):</span> <span class="c1"># a single axis</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span> <span class="c1"># find axis index in var axes</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># find the same axis length</span>
        <span class="n">good</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">good</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span> <span class="c1"># search for z in order</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict</span> <span class="ow">and</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ndim</span><span class="o">-</span><span class="mi">3</span>
            <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">axis</span></div>
<span class="n">_getzdim_</span> <span class="o">=</span> <span class="n">get_zdim</span>

<div class="viewcode-block" id="isdepthup"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.isdepthup">[docs]</a><span class="k">def</span> <span class="nf">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Guess if depth is positive up</span>

<span class="sd">    It first check &quot;positive&quot; attribute, then guess from values:</span>
<span class="sd">    more positive values means positive down.</span>

<span class="sd">    ..warning:: Bad values must be masked</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **depth**: Depth arrays or axis.</span>
<span class="sd">        - **axis**, optional: Z axis index.</span>
<span class="sd">        - **ro**, optional: Read-only? If False and if depth</span>
<span class="sd">          is an axis, its &#39;positive&#39; attribute is marked</span>
<span class="sd">          &#39;up&#39; or &#39;down&#39; upon the results.</span>

<span class="sd">    :Return: ``None`` if not Z axis found, else ``True`` or ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># From attribute</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">positive</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">positive</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Slices</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">get_zdim</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="c1"># From values</span>
    <span class="n">firstval</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">lastval</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">isup</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">firstval</span><span class="p">)</span><span class="o">&gt;</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lastval</span><span class="p">)</span>

    <span class="c1"># Set attribute</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ro</span> <span class="ow">and</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="n">depth</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">isup</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
    <span class="k">return</span> <span class="n">isup</span></div>


<div class="viewcode-block" id="makedepthup"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.makedepthup">[docs]</a><span class="k">def</span> <span class="nf">makedepthup</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make depth and variables positive up</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vv**: A single variable or a list of them.</span>
<span class="sd">        - **depth**, optional: Explicit depths to not guess</span>
<span class="sd">          it with :meth:`getLevel`. If True or False, simply revert along Z</span>
<span class="sd">          dimension.</span>
<span class="sd">        - **axis**, optional: Z dimension (else guessed with :func:`get_zdim`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># A list of variables</span>
    <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span><span class="p">]</span>

    <span class="c1"># Get depth</span>
    <span class="n">getdepth</span> <span class="o">=</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">depth</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">depth</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">axis</span> <span class="o">=</span> <span class="n">get_zdim</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>

        <span class="c1"># No depth found</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">vv</span>
            <span class="k">if</span> <span class="n">getdepth</span><span class="p">:</span> <span class="k">return</span> <span class="n">vv</span><span class="p">,</span> <span class="n">depth</span>
            <span class="k">return</span> <span class="n">vv</span>

        <span class="c1"># Positive up?</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span>

        <span class="c1"># Revert depths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isup</span> <span class="ow">and</span> <span class="n">getdepth</span><span class="p">:</span>
            <span class="n">depth</span><span class="p">[:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
                <span class="n">depth</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="o">-</span><span class="n">depth</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">depth</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">depth</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="c1"># Revert variables or depths</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isup</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vv</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">var</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="o">-</span><span class="n">var</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">var</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">get_zdim</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">depaxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">depaxis</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="o">-</span><span class="n">depaxis</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">vv</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">vv</span>
    <span class="k">if</span> <span class="n">getdepth</span><span class="p">:</span> <span class="k">return</span> <span class="n">vv</span><span class="p">,</span> <span class="n">depth</span>
    <span class="k">return</span> <span class="n">vv</span></div>


<div class="viewcode-block" id="makealtitudeup"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.makealtitudeup">[docs]</a><span class="k">def</span> <span class="nf">makealtitudeup</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make depth and variables positive up</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vv**: A single variable or a list of them.</span>
<span class="sd">        - **depth**, optional: Explicit depths to not guess</span>
<span class="sd">          it with :meth:`getLevel`. If True or False, simply revert along Z</span>
<span class="sd">          dimension.</span>
<span class="sd">        - **axis**, optional: Z dimension (else guessed with :func:`get_zdim`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># A list of variables</span>
    <span class="n">single</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span><span class="p">]</span>

    <span class="c1"># Get depth</span>
    <span class="n">getdepth</span> <span class="o">=</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">depth</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">depth</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">axis</span> <span class="o">=</span> <span class="n">get_zdim</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>

        <span class="c1"># No depth found</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">vv</span>
            <span class="k">if</span> <span class="n">getdepth</span><span class="p">:</span> <span class="k">return</span> <span class="n">vv</span><span class="p">,</span> <span class="n">depth</span>
            <span class="k">return</span> <span class="n">vv</span>

        <span class="c1"># Positive up?</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="n">ro</span><span class="p">)</span>

        <span class="c1"># Revert depths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isup</span> <span class="ow">and</span> <span class="n">getdepth</span><span class="p">:</span>
<span class="c1">#            depth[:] *= -1</span>
            <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
                <span class="n">depth</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="n">depth</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">depth</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">depth</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="c1"># Revert variables or depths</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isup</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vv</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">var</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="n">var</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">var</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">get_zdim</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">depaxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">depaxis</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="n">depaxis</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">vv</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">vv</span>
    <span class="k">if</span> <span class="n">getdepth</span><span class="p">:</span> <span class="k">return</span> <span class="n">vv</span><span class="p">,</span> <span class="n">depth</span>
    <span class="k">return</span> <span class="n">vv</span></div>


<div class="viewcode-block" id="dz2depth"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.dz2depth">[docs]</a><span class="k">def</span> <span class="nf">dz2depth</span><span class="p">(</span><span class="n">dz</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refloc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copyaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span>
        <span class="n">zerolid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Conversion from layer thickness to depths</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **dz**: Layer thickness from bottom to top.</span>
<span class="sd">        - **ref**: Reference depth for integration, which depends</span>
<span class="sd">          on ``refloc``:</span>

<span class="sd">            - ``&quot;top&quot;`` or ``&quot;eta&quot;`` or ``&quot;ssh&quot;``: Sea surface height.</span>
<span class="sd">            - ``&quot;bottom&quot;`` or ``&quot;depth&quot;`` or ``&quot;bathy&quot;``: Bottom depth.</span>
<span class="sd">            - Else, estimated by checking the standard_name of the</span>
<span class="sd">              variable, if some values are negatives (&#39;top&#39;)</span>
<span class="sd">              or if maximal value is greater then 15. (&#39;bottom&#39;).</span>

<span class="sd">        - **refloc**, optional: ``&quot;top&quot;`` | ``&quot;eta&quot;``,</span>
<span class="sd">          ``&quot;bottom&quot;`` | ``&quot;depth&quot;``,  or ``None``.</span>
<span class="sd">        - **mode**, optional:</span>

<span class="sd">            - ``&quot;edge&quot;`` or ``&quot;edge+&quot;``: Compute depths at layer edges (interfaces).</span>
<span class="sd">              Adding a + includes the bottom layer and add a vertical level.</span>
<span class="sd">            - ``&quot;middle&quot;``: Compute depths at the middle of layers</span>

<span class="sd">        - **zerolid**, optional: Force the surface to be at a zero depth</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Init depths</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;edge&#39;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">mode</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;edg&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Invalid mode: Please choose one of: &quot;</span>
        <span class="s2">&quot;edge or middle&quot;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;edg&#39;</span>
    <span class="n">withtime</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">withtime</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">withtime</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
        <span class="n">nz</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span> <span class="o">+</span> <span class="n">dz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">withtime</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">depths</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dz</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">depths</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Depths&#39;</span>
    <span class="n">depths</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
    <span class="n">depths</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;depths&#39;</span>

    <span class="c1"># Format dz</span>
    <span class="n">dzm</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">withtime</span><span class="p">:</span>
        <span class="n">dzm</span> <span class="o">=</span> <span class="n">dzm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span><span class="o">+</span><span class="n">dzm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">#TODO: dz2depth: dzshift</span>
    <span class="c1">#TODO: dz2depth: positive up/down</span>

    <span class="c1"># Guess reference</span>
    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refloc</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">refloc</span> <span class="o">=</span> <span class="n">refloc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">refloc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;ssh&quot;</span><span class="p">]:</span> <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
    <span class="k">elif</span> <span class="n">refloc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;bathy&quot;</span><span class="p">]:</span> <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
    <span class="k">if</span> <span class="n">refloc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">]:</span> <span class="n">refloc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">refsn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span> <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="k">else</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refloc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># From standard_name (using cf)</span>
        <span class="k">if</span> <span class="n">refsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">vacumm.data.cf</span> <span class="k">import</span> <span class="n">VAR_SPECS</span>
                <span class="k">if</span> <span class="n">refsn</span> <span class="ow">in</span> <span class="n">VAR_SPECS</span><span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">][</span><span class="s1">&#39;standard_names&#39;</span><span class="p">]:</span>
                    <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
                <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">refsn</span> <span class="ow">in</span> <span class="n">VAR_SPECS</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s1">&#39;standard_names&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bathy&#39;</span><span class="p">,</span> <span class="s1">&#39;bathy_u&#39;</span><span class="p">,</span> <span class="s1">&#39;bathy_v&#39;</span><span class="p">]]:</span>
                    <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># From values</span>
        <span class="k">if</span> <span class="n">refloc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">refloc</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">15</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span>

    <span class="c1"># Integrate</span>
    <span class="n">depths</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ext</span><span class="p">):]</span> <span class="o">=</span> <span class="n">dzm</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add reference</span>
    <span class="k">if</span> <span class="n">refloc</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="c1"># zero at top</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">depths</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">-=</span> <span class="n">depths</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">zerolid</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">depths</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">ref</span>

    <span class="c1"># Substract surface for zerolid</span>
    <span class="k">if</span> <span class="n">zerolid</span> <span class="ow">and</span> <span class="n">refloc</span> <span class="o">!=</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">depths</span><span class="p">:</span>
            <span class="n">dep</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">dep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Middle of layers</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;mid&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">refloc</span><span class="o">==</span><span class="s1">&#39;top&#39;</span><span class="p">:</span>
            <span class="n">depths</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">dzm</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depths</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">dzm</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">del</span> <span class="n">dzm</span>

    <span class="c1"># Format axes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">withtime</span><span class="p">:</span> <span class="n">depths</span> <span class="o">=</span> <span class="n">depths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">copyaxes</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
            <span class="n">iaxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">withtime</span><span class="p">)</span>
            <span class="n">zaxis</span> <span class="o">=</span> <span class="n">extend1d</span><span class="p">(</span><span class="n">dz</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">zaxis</span>
        <span class="n">depths</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">dz</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depths</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">depths</span></div>


<span class="k">def</span> <span class="nf">are_same_grids</span><span class="p">(</span><span class="n">grid0</span><span class="p">,</span> <span class="n">grid1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if two grids are similars&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">grid0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">lon0</span> <span class="o">=</span> <span class="n">grid0</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()[:]</span>
    <span class="n">lat0</span> <span class="o">=</span> <span class="n">grid0</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()[:]</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()[:]</span>
    <span class="n">lat1</span> <span class="o">=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()[:]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lon0</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">lon1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lat0</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">lat0</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lat1</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="c1">#def get_triangles(x1d, y1d):</span>
<span class="c1">#    &quot;&quot;&quot;Get delaunay triangles of random positions&quot;&quot;&quot;</span>
<span class="c1">#    return _qhull.delaunay(x1d, y1d)[0]</span>

<div class="viewcode-block" id="get_tri"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.get_tri">[docs]</a><span class="k">def</span> <span class="nf">get_tri</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a :class:`scipy.spatial.Delaunay` (scipy) or</span>
<span class="sd">    a :class:`matplotlib.tri.Triangulation` (mpl) instance&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;tri&#39;</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;tri&#39;</span><span class="p">]</span>

    <span class="c1"># Scipy Delaunay</span>
    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">istri</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">xy</span>
        <span class="k">if</span> <span class="n">istri</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">):</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xy</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">xy</span><span class="o">.</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">isugrid</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()[:]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()[:]</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">T</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial</span> <span class="k">as</span> <span class="nn">S</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

    <span class="c1"># Matplotlib Triangulation</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">istri</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">xy</span>
        <span class="k">if</span> <span class="n">istri</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">):</span>
            <span class="n">triangles</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">simplices</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">isugrid</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()[:]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()[:]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="k">import</span> <span class="n">Triangulation</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">triangles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">get_tri_mask</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">tri</span><span class="o">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;tri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri</span>
    <span class="k">return</span> <span class="n">tri</span></div>


<div class="viewcode-block" id="istri"><a class="viewcode-back" href="../../../../library/misc.grid.misc.html#vacumm.misc.grid.misc.istri">[docs]</a><span class="k">def</span> <span class="nf">istri</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if tri is a :class:`scipy.spatial.Delaunay` (scipy) or</span>
<span class="sd">    a :class:`matplotlib.tri.Triangulation` instance (mpl)&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial</span> <span class="k">as</span> <span class="nn">S</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;mpl&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="k">import</span> <span class="n">Triangulation</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">Triangulation</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">def</span> <span class="nf">get_tri_type</span><span class="p">(</span><span class="n">tri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the triangulation instance type, either &#39;scipy&#39;, &#39;mpl&#39; or None&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="k">import</span> <span class="n">Triangulation</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">Triangulation</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;mpl&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy.spatial</span> <span class="k">as</span> <span class="nn">S</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;scipy&quot;</span>


<span class="k">def</span> <span class="nf">get_tri_mask</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">dmask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the triangulation mask from points mask&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="s1">&#39;simplices&#39;</span><span class="p">):</span>
        <span class="n">triangles</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">simplices</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">triangles</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">triangles</span>
    <span class="n">tmask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">triangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">dmask</span><span class="p">):</span>
        <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">mask</span>
    <span class="k">while</span> <span class="n">dmask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dmask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">tmask</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">dmask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">triangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tmask</span> <span class="o">|=</span> <span class="n">dmask</span><span class="p">[</span><span class="n">triangles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">tmask</span>

<span class="c1">######################################################################</span>
<span class="c1">######################################################################</span>
<span class="kn">from</span> <span class="nn">...misc.atime</span> <span class="k">import</span> <span class="n">ch_units</span><span class="p">,</span><span class="n">compress</span>
<span class="kn">from</span> <span class="nn">...misc</span> <span class="k">import</span> <span class="n">cp_atts</span><span class="p">,</span><span class="n">get_atts</span><span class="p">,</span><span class="n">set_atts</span><span class="p">,</span><span class="n">intersect</span><span class="p">,</span> <span class="n">numod</span><span class="p">,</span>  <span class="n">check_case</span><span class="p">,</span> <span class="n">kwfilter</span>
<span class="kn">from</span> <span class="nn">...misc.axes</span> <span class="k">import</span> <span class="p">(</span><span class="n">check_axes</span><span class="p">,</span> <span class="n">islon</span><span class="p">,</span> <span class="n">islat</span><span class="p">,</span> <span class="n">islev</span><span class="p">,</span> <span class="n">istime</span><span class="p">,</span> <span class="n">create_lon</span><span class="p">,</span>
    <span class="n">create_lat</span><span class="p">,</span> <span class="n">isaxis</span><span class="p">,</span> <span class="n">isdep</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">...misc.phys</span> <span class="k">import</span> <span class="n">units</span><span class="p">,</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">.basemap</span> <span class="k">import</span> <span class="n">get_map</span><span class="p">,</span> <span class="n">cached_map</span><span class="p">,</span> <span class="n">cache_map</span><span class="p">,</span> <span class="n">get_proj</span>
<span class="kn">from</span> <span class="nn">.masking</span> <span class="k">import</span> <span class="n">t2uvmasks</span>
<span class="kn">from</span> <span class="nn">.regridding</span> <span class="k">import</span> <span class="n">extend1d</span>
<span class="kn">from</span> <span class="nn">...__init__</span> <span class="k">import</span> <span class="n">VACUMMError</span><span class="p">,</span> <span class="n">VACUMMWarning</span><span class="p">,</span> <span class="n">vcwarn</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>