
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.misc.atime &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" accesskey="U">vacumm</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.misc.atime</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Time utilities</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2015)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">DT</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">isNumberType</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">ge</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">le</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="k">import</span> <span class="n">split</span> <span class="k">as</span> <span class="n">resplit</span><span class="p">,</span><span class="n">match</span><span class="p">,</span> <span class="nb">compile</span> <span class="k">as</span> <span class="n">recompile</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span><span class="o">,</span> <span class="nn">MV2</span><span class="o">,</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">MA</span><span class="o">,</span> <span class="nn">cdtime</span><span class="o">,</span> <span class="nn">cdms2</span> <span class="k">as</span> <span class="nn">cdms</span><span class="o">,</span> <span class="nn">cdutil</span><span class="o">,</span> <span class="nn">cdms2</span>
<span class="kn">from</span> <span class="nn">cdms2.axis</span> <span class="k">import</span> <span class="n">CdtimeTypes</span><span class="p">,</span><span class="n">AbstractAxis</span><span class="p">,</span><span class="n">ComptimeType</span><span class="p">,</span><span class="n">ReltimeType</span><span class="p">,</span><span class="n">FileAxis</span>
<span class="kn">from</span> <span class="nn">dateutil.rrule</span> <span class="k">import</span> <span class="n">rrule</span><span class="p">,</span> <span class="n">MO</span><span class="p">,</span> <span class="n">TU</span><span class="p">,</span> <span class="n">WE</span><span class="p">,</span> <span class="n">TH</span><span class="p">,</span> <span class="n">FR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SU</span><span class="p">,</span> <span class="n">YEARLY</span><span class="p">,</span> \
     <span class="n">MONTHLY</span><span class="p">,</span> <span class="n">WEEKLY</span><span class="p">,</span> <span class="n">DAILY</span><span class="p">,</span> <span class="n">HOURLY</span><span class="p">,</span> <span class="n">MINUTELY</span><span class="p">,</span> <span class="n">SECONDLY</span>
<span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="k">import</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">num2date</span><span class="p">,</span> <span class="n">date2num</span>
<span class="c1">#from pytz import timezone, all_timezones</span>



<span class="c1"># Attributes</span>
<span class="n">STR_UNIT_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;years&#39;</span><span class="p">,</span><span class="s1">&#39;months&#39;</span><span class="p">,</span><span class="s1">&#39;days&#39;</span><span class="p">,</span><span class="s1">&#39;hours&#39;</span><span class="p">,</span><span class="s1">&#39;minutes&#39;</span><span class="p">,</span><span class="s1">&#39;seconds&#39;</span><span class="p">]</span>
<span class="n">RE_SPLIT_DATE</span> <span class="o">=</span> <span class="n">recompile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[ Z:T\-]&#39;</span><span class="p">)</span>
<span class="n">RE_MATCH_TIME_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[0-2]?\d?\d?\d(-[01]?\d(-[0-3]?\d([ TZ][0-2]?\d(:[0-6]?\d(:[0-6]?\d(\.\d+)?)?)?)?)?)?&#39;</span>
<span class="n">RE_MATCH_TIME</span> <span class="o">=</span> <span class="n">recompile</span><span class="p">(</span><span class="n">RE_MATCH_TIME_PATTERN</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
<span class="n">RE_MATCH_UNITS_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) since &#39;</span><span class="o">%</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STR_UNIT_TYPES</span><span class="p">)</span><span class="o">+</span><span class="n">RE_MATCH_TIME_PATTERN</span><span class="o">+</span><span class="s1">&#39;[ \w]*&#39;</span>
<span class="n">RE_MATCH_UNITS</span> <span class="o">=</span> <span class="n">recompile</span><span class="p">(</span><span class="n">RE_MATCH_UNITS_PATTERN</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

<span class="c1">#: Time units for CNES julian days</span>
<span class="n">JULIANDAY_TIME_UNITS_CNES</span> <span class="o">=</span> <span class="s1">&#39;days since 1950-01-01&#39;</span>

<span class="c1">#: Time units for NASA julian days</span>
<span class="n">JULIANDAY_TIME_UNITS_NASA</span> <span class="o">=</span> <span class="s1">&#39;days since 1958-01-01&#39;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STR_UNIT_TYPES&#39;</span><span class="p">,</span><span class="s1">&#39;RE_SPLIT_DATE&#39;</span><span class="p">,</span><span class="s1">&#39;now&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_add&#39;</span><span class="p">,</span> <span class="s1">&#39;add_time&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="s1">&#39;are_same_units&#39;</span><span class="p">,</span> <span class="s1">&#39;are_valid_units&#39;</span><span class="p">,</span> <span class="s1">&#39;ch_units&#39;</span><span class="p">,</span> <span class="s1">&#39;comptime&#39;</span><span class="p">,</span> <span class="s1">&#39;reltime&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_cdtime&#39;</span><span class="p">,</span> <span class="s1">&#39;is_reltime&#39;</span><span class="p">,</span> <span class="s1">&#39;is_comptime&#39;</span><span class="p">,</span> <span class="s1">&#39;is_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;check_range&#39;</span><span class="p">,</span> <span class="s1">&#39;is_in_time_interval&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_to_ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaps&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_type&#39;</span><span class="p">,</span> <span class="s1">&#39;get_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;reduce&#39;</span><span class="p">,</span> <span class="s1">&#39;yearly&#39;</span><span class="p">,</span>
    <span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly&#39;</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_exact&#39;</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;detrend&#39;</span><span class="p">,</span> <span class="s1">&#39;strftime&#39;</span><span class="p">,</span> <span class="s1">&#39;strptime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tz_to_tz&#39;</span><span class="p">,</span> <span class="s1">&#39;from_utc&#39;</span><span class="p">,</span> <span class="s1">&#39;to_utc&#39;</span><span class="p">,</span> <span class="s1">&#39;paris_to_utc&#39;</span><span class="p">,</span> <span class="s1">&#39;DateSorter&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecialDateFormatter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;interp&#39;</span><span class="p">,</span> <span class="s1">&#39;is_time&#39;</span><span class="p">,</span> <span class="s1">&#39;round_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Intervals&#39;</span><span class="p">,</span> <span class="s1">&#39;utc_to_paris&#39;</span><span class="p">,</span> <span class="s1">&#39;ascii_to_num&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lindates&#39;</span><span class="p">,</span> <span class="s1">&#39;itv_intersect&#39;</span><span class="p">,</span> <span class="s1">&#39;itv_union&#39;</span><span class="p">,</span><span class="s1">&#39;day_of_the_year&#39;</span><span class="p">,</span> <span class="s1">&#39;pat2freq&#39;</span><span class="p">,</span>  <span class="s1">&#39;strtime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_strtime&#39;</span><span class="p">,</span> <span class="s1">&#39;time_type&#39;</span><span class="p">,</span> <span class="s1">&#39;is_axistime&#39;</span><span class="p">,</span> <span class="s1">&#39;notz&#39;</span><span class="p">,</span>  <span class="s1">&#39;IterDates&#39;</span><span class="p">,</span> <span class="s1">&#39;numtime&#39;</span><span class="p">,</span>  <span class="s1">&#39;is_numtime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pat2glob&#39;</span><span class="p">,</span> <span class="s1">&#39;midnight_date&#39;</span><span class="p">,</span> <span class="s1">&#39;midnight_interval&#39;</span><span class="p">,</span><span class="s1">&#39;reduce_old&#39;</span><span class="p">,</span> <span class="s1">&#39;daily_bounds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hourly_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;time_split&#39;</span><span class="p">,</span> <span class="s1">&#39;time_split_nmax&#39;</span><span class="p">,</span> <span class="s1">&#39;add_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;fixcomptime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_interval&#39;</span><span class="p">,</span> <span class="s1">&#39;has_time_pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;tsel2slice&#39;</span><span class="p">,</span> <span class="s1">&#39;tic&#39;</span><span class="p">,</span> <span class="s1">&#39;toc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;filter_time_selector&#39;</span><span class="p">,</span><span class="s1">&#39;time_selector&#39;</span><span class="p">,</span> <span class="s1">&#39;selector&#39;</span><span class="p">,</span>
    <span class="s1">&#39;julday&#39;</span><span class="p">,</span> <span class="s1">&#39;interp_clim&#39;</span><span class="p">,</span> <span class="s1">&#39;round_interval&#39;</span><span class="p">]</span>

<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<div class="viewcode-block" id="pat2freq"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.pat2freq">[docs]</a><span class="k">def</span> <span class="nf">pat2freq</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the maximal frequency (&quot;days&quot;, &quot;hours&quot;, etc) associated with a date pattern</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **pattern**: A string containg date patterns (like &#39;%d&#39; or &#39;%%d&#39;)</span>

<span class="sd">    :Return:</span>

<span class="sd">        One of ``None``, ``&quot;seconds&quot;``, ``&quot;minutes&quot;``, ``&quot;hours&quot;``,</span>
<span class="sd">        ``&quot;days&quot;``, ``&quot;months&quot;``, ``&quot;yaers&quot;``.</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; print pat2freq(&#39;%d/%m/%Y&#39;)</span>
<span class="sd">    days</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Patterns</span>
    <span class="n">pats</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;seconds&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;months&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;years&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="c1"># Search</span>
    <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pats</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;%&#39;</span><span class="o">+</span><span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">freq</span></div>

<div class="viewcode-block" id="pat2glob"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.pat2glob">[docs]</a><span class="k">def</span> <span class="nf">pat2glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">esc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a date pattern to a rough global matching pattern</span>

<span class="sd">    .. note::</span>

<span class="sd">        A global matching pattern is a UNIX file pattern.</span>
<span class="sd">        See :func:`glob.glob` for more information.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The output global pattern is NOT strict, and thus</span>
<span class="sd">        may embed more than requested by the date pattern.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **pattern**: A string containg date patterns (like &#39;%d&#39; or &#39;%%d&#39;)</span>
<span class="sd">        - **esc**, optional: If ``True``, date patterns are escaped (like &#39;%%d&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span>    <span class="s1">&#39;???&#39;</span><span class="p">,</span>
        <span class="s1">&#39;A&#39;</span><span class="p">:</span>    <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span>    <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;B&#39;</span><span class="p">:</span>    <span class="s1">&#39;???&#39;</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span>    <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;d&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-3][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;H&#39;</span><span class="p">:</span>    <span class="s1">&#39;[012][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;I&#39;</span><span class="p">:</span>    <span class="s1">&#39;[01][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;j&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-3][0-9][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;m&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-1][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;M&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-5][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;p&#39;</span><span class="p">:</span>    <span class="s1">&#39;[AP]M&#39;</span><span class="p">,</span>
        <span class="s1">&#39;S&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-6][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;U&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-5][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;w&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-6]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;W&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-5][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span>    <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;X&#39;</span><span class="p">:</span>    <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-9][0-9]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Y&#39;</span><span class="p">:</span>    <span class="s1">&#39;[0-2][0-9][0-9][0-9]&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">esc</span> <span class="k">else</span> <span class="s1">&#39;%&#39;</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">pats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pc</span><span class="o">+</span><span class="n">d</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pattern</span></div>



<div class="viewcode-block" id="day_of_the_year"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.day_of_the_year">[docs]</a><span class="k">def</span> <span class="nf">day_of_the_year</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the day of the year of a specified date&quot;&quot;&quot;</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">ctyear</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="n">tunits</span> <span class="o">=</span> <span class="s1">&#39;days since </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ctyear</span>
    <span class="k">return</span> <span class="n">ctime</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="mi">1</span></div>

<div class="viewcode-block" id="lindates"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.lindates">[docs]</a><span class="k">def</span> <span class="nf">lindates</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a list of linearly incrementing dates</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **first**: first date</span>
<span class="sd">        - **last**: first date</span>
<span class="sd">        - **incr**: increment step OR number of steps if units is None</span>
<span class="sd">        - **units**: units like &quot;days&quot; (see :func:`unit_type`) or None</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; dates = lindates(&#39;2000&#39;, &#39;2002-05&#39;, 3, &#39;months&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dates = lindates(&#39;2000&#39;, &#39;2002-05&#39;, 8)</span>

<span class="sd">    :Return:</span>

<span class="sd">        - list of :func:`cdtime.comptime` dates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ct0</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
    <span class="n">ct1</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
    <span class="n">tunits</span> <span class="o">=</span> <span class="s1">&#39;hours since 2000&#39;</span>
    <span class="n">rt0</span> <span class="o">=</span> <span class="n">ct0</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rt1</span> <span class="o">=</span> <span class="n">ct1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">rt1</span> <span class="o">&lt;</span> <span class="n">rt0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Fixed number of steps</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rt0</span><span class="p">,</span>  <span class="n">rt1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">incr</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">]</span>

    <span class="c1"># Fixed step</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">unit_type</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct0</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">rt1</span><span class="p">:</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_time</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">incr</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">rt1</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dates</span></div>

<div class="viewcode-block" id="now"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.now">[docs]</a><span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">utc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return current time as :func:`cdtime.comptime`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **utc**, optional: Return UTC time [default: False]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">comptime</span><span class="p">(</span><span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">comptime</span><span class="p">(</span><span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span></div>



<div class="viewcode-block" id="add_time"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.add_time">[docs]</a><span class="k">def</span> <span class="nf">add_time</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add value to time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Target time, list of times or time axis.</span>
<span class="sd">        - **amount**: Value to add.</span>
<span class="sd">        - **units**, optional: Units, needed if ``mytime`` is not a time axis.</span>
<span class="sd">        - **copy**, optional: Copy list or time axis?</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; add_time(&#39;2008-02&#39;, 3, &#39;days&#39;)</span>
<span class="sd">        &#39;2008-2-4 0:0:0.0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Time axis</span>
    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mytime</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mytime</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">amount</span>
            <span class="k">return</span> <span class="n">mytime</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">),</span> <span class="s1">&#39;Your time axis must have an &quot;units&quot; attribute&#39;</span>
        <span class="n">mytime</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">add_time</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">mytime</span><span class="o">.</span><span class="n">asRelativeTime</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">mytime</span>

    <span class="c1"># Handle lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">intimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">outtimes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intimes</span><span class="p">)</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">intimes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mytime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intimes</span><span class="p">):</span>

        <span class="c1"># Guess type</span>
        <span class="n">typeback</span> <span class="o">=</span> <span class="n">time_type</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span>  <span class="n">out</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typeback</span> <span class="o">==</span> <span class="n">reltime</span><span class="p">:</span>
            <span class="n">myUnits</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">units</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

        <span class="c1"># Units</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">unit_type</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;You must provide valid time units&#39;</span>

        <span class="c1"># Add</span>
        <span class="n">newtime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

        <span class="c1"># Correction</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">!=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Second</span><span class="p">:</span>
            <span class="n">mytimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mytime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">mytime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">mytime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">mytime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span><span class="n">mytime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span><span class="n">mytime</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
            <span class="n">newtimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">newtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">newtime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">newtime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">newtime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span><span class="n">newtime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span><span class="n">newtime</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
            <span class="n">myunits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Month</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">,</span>
                <span class="n">cdtime</span><span class="o">.</span><span class="n">Hour</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Second</span><span class="p">]</span>
            <span class="n">iunits</span> <span class="o">=</span> <span class="n">myunits</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iunits</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">newtimes</span><span class="p">[</span><span class="n">iunits</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">mytimes</span><span class="p">[</span><span class="n">iunits</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">newtime</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="o">*</span><span class="n">newtimes</span><span class="p">)</span>

        <span class="c1"># Back to correct type</span>
        <span class="k">if</span> <span class="n">typeback</span> <span class="o">==</span> <span class="n">reltime</span><span class="p">:</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">typeback</span><span class="p">(</span><span class="n">newtime</span><span class="p">,</span> <span class="n">myUnits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">typeback</span><span class="p">(</span><span class="n">newtime</span><span class="p">)</span>
        <span class="n">outtimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mytime</span>

    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">outtimes</span><span class="p">)</span></div>


<span class="c1"># Obsolete :</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">add_time</span>
<span class="n">axis_add</span> <span class="o">=</span> <span class="n">add_time</span>



<div class="viewcode-block" id="mpl"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.mpl">[docs]</a><span class="k">def</span> <span class="nf">mpl</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to Matplotlib units.</span>

<span class="sd">    Time objects (or list of them) are converted to</span>
<span class="sd">    pure numerical values.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytimes**: Time object (or list), or time axis.</span>
<span class="sd">        - **copy**, optional: Copy time axis or not?</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function does not use :func:`ch_units`.</span>
<span class="sd">        It uses Matplotlib internal function</span>
<span class="sd">        :func:`matplotlib.dates.date2num` instead.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; taxis = create_time((0, 10.), &#39;hours since 2000-01-01&#39;)</span>
<span class="sd">        &gt;&gt;&gt; maxis = mpl(taxis)</span>
<span class="sd">        &gt;&gt;&gt; print maxis[0]</span>
<span class="sd">        730120.0</span>
<span class="sd">        &gt;&gt;&gt; print maxis.units</span>
<span class="sd">        days since 0001</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Variable</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">taxis</span> <span class="o">=</span> <span class="n">mpl</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
            <span class="n">mytimes</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">mytimes</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">),</span> <span class="n">taxis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mytimes</span>

    <span class="c1"># Time axis</span>
    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span> <span class="n">mytimes</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">_data_</span> <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="s1">&#39;matplotlib_compatible&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">matplotlib_compatible</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mytimes</span>
        <span class="c1"># Values</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">assignValue</span><span class="p">(</span><span class="n">mytimes</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
        <span class="n">datetimes</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
        <span class="n">mytimes</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">datetimes</span><span class="p">]</span>
        <span class="c1"># Units</span>
        <span class="n">ct0</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">datetimes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">datetimes</span>
        <span class="n">rt0</span> <span class="o">=</span> <span class="n">ct0</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;days since </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ct0</span><span class="p">)</span>
        <span class="n">ctref</span> <span class="o">=</span> <span class="n">ct0</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rt0</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">mytimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Days</span><span class="p">)</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ctref</span><span class="p">)</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">matplotlib_compatible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">mytimes</span>

    <span class="c1"># Time or list</span>
    <span class="n">mytimes</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
    <span class="n">intimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">datetime</span><span class="p">(</span><span class="n">intimes</span><span class="p">)])</span></div>



<span class="c1"># Obsolete :</span>
<span class="n">axis_to_mpl</span> <span class="o">=</span> <span class="n">mpl</span>
<span class="n">to_mpl</span> <span class="o">=</span> <span class="n">mpl</span>

<div class="viewcode-block" id="are_same_units"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.are_same_units">[docs]</a><span class="k">def</span> <span class="nf">are_same_units</span><span class="p">(</span><span class="n">units1</span><span class="p">,</span> <span class="n">units2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare time units</span>

<span class="sd">    &gt;&gt;&gt; are_same_units(&#39;days since 1900-1&#39;, &#39;days since 1900-01-01 00:00:0.0&#39;)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">units1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">==</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">units2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span></div>

<div class="viewcode-block" id="are_valid_units"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.are_valid_units">[docs]</a><span class="k">def</span> <span class="nf">are_valid_units</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that units are well formatted</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; from vacumm.misc.atime import are_good_units</span>
<span class="sd">    &gt;&gt;&gt; are_good_units(&#39;months since 2000&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; are_good_units(&#39;months since 2000-01-01 10h20&#39;)</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
<span class="c1">#    try:</span>
<span class="c1">#        cdtime.reltime(100,  units)</span>
<span class="c1">#        return True</span>
<span class="c1">#    except:</span>
<span class="c1">#        return False</span>
<span class="c1">#    for rem in &#39; UTC.&#39;, &#39; UTC&#39;:</span>
<span class="c1">#        units = units.replace(rem, &#39;&#39;)</span>
    <span class="k">return</span> <span class="n">RE_MATCH_UNITS</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>
<span class="n">are_good_units</span> <span class="o">=</span> <span class="n">are_valid_units</span>
<span class="n">check_units</span> <span class="o">=</span> <span class="n">are_valid_units</span>
<div class="viewcode-block" id="ch_units"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.ch_units">[docs]</a><span class="k">def</span> <span class="nf">ch_units</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="n">newunits</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change units of a CDAT time axis or a list (or single element) or cdtime times</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytimes**: CDAT axis time object, a CDAT variable with a time axis,</span>
<span class="sd">          a valid time ot list of times.</span>
<span class="sd">        - **newunits**: New time units.</span>
<span class="sd">        - **copy**, optional: Create a new axis instead of updating</span>
<span class="sd">          the current one.</span>

<span class="sd">           .. note:: If ``mytimes is True``, then ``copy`` is set to ``False``.</span>

<span class="sd">    :Return:</span>

<span class="sd">        New time axis, or relatives times.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; mytimes = ch_units(time_axis,relative=False,value=False,copy=True)</span>

<span class="sd">    .. warning::</span>

<span class="sd">        In the case of a single time object or a list of them, all object</span>
<span class="sd">        that is not :func:`cdtime.reltime` object will not be converted.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If a variable with time axis</span>
    <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="n">check_axes</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
        <span class="n">torder</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torder</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable must have a valid time axis&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch_units</span><span class="p">(</span><span class="n">mytimes</span><span class="o">.</span><span class="n">getTime</span><span class="p">(),</span> <span class="n">newunits</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Time axis</span>
    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span> <span class="n">mytimes</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">mytimes</span><span class="o">.</span><span class="n">_data_</span> <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">mytimes</span><span class="o">.</span><span class="n">toRelativeTime</span><span class="p">(</span><span class="n">newunits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mytimes</span>

    <span class="c1"># Single or list of times</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
    <span class="n">intimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">outtimes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intimes</span><span class="p">)</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">intimes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mytime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intimes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">outtimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">newunits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">outtimes</span><span class="p">)</span></div>


<div class="viewcode-block" id="time_type"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.time_type">[docs]</a><span class="k">def</span> <span class="nf">time_type</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the type of time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: A time of one of the following types:</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`,</span>
<span class="sd">          :func:`datetime.datetime` or a date string.</span>
<span class="sd">        - **out**, optional: Output format, one of:</span>

<span class="sd">            - ``&quot;string&quot;``: Return one of ``&quot;comptime&quot;``, ``&quot;reltime&quot;``</span>
<span class="sd">              ``&quot;datetime&quot;``, ``&quot;strtime&quot;``, ``&quot;numtime&quot;``.</span>
<span class="sd">            - ``&quot;type&quot;``: Simply return result of ``type(mytime)``</span>
<span class="sd">            - ``&quot;func&quot;``: Return the function used to convert</span>
<span class="sd">              to this type : :func:`comptime`, :func:`reltime`,</span>
<span class="sd">              :func:`datetime`, :func:`numtime`.</span>

<span class="sd">    :Return: ``None`` if not a time, or see **out**.</span>

<span class="sd">    :Example:</span>

<span class="sd">            &gt;&gt;&gt; time_type(&#39;2000-10&#39;)</span>
<span class="sd">            &#39;str&#39;</span>
<span class="sd">            &gt;&gt;&gt; time_type(cdtime.comptime(2000,10), out=&#39;func&#39;)</span>
<span class="sd">            &lt;function comptime at 0x31c4aa0&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">stype</span> <span class="ow">in</span> <span class="s1">&#39;strtime&#39;</span><span class="p">,</span> <span class="s1">&#39;comptime&#39;</span><span class="p">,</span>  <span class="s1">&#39;reltime&#39;</span><span class="p">,</span>  <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>  <span class="s1">&#39;numtime&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;is_&#39;</span><span class="o">+</span><span class="n">stype</span><span class="p">)(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">stype</span>
            <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">stype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Time of wrong type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mytime</span></div>


<span class="k">def</span> <span class="nf">_nummode_</span><span class="p">(</span><span class="n">nummode</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nummode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nummode</span> <span class="o">=</span> <span class="s1">&#39;mpl&#39;</span>
    <span class="n">valid_nummodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="s1">&#39;julday&#39;</span><span class="p">,</span> <span class="s1">&#39;cnes&#39;</span><span class="p">,</span> <span class="s1">&#39;nasa&#39;</span><span class="p">]</span>
    <span class="n">nummode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nummode</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nummode</span> <span class="ow">in</span> <span class="n">valid_nummodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nummode</span><span class="o">==</span><span class="s1">&#39;mpl&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nummode</span>
        <span class="k">if</span> <span class="n">nummode</span><span class="o">==</span><span class="s1">&#39;julday&#39;</span><span class="p">:</span>
            <span class="n">nummode</span> <span class="o">=</span> <span class="s1">&#39;cnes&#39;</span>
        <span class="k">if</span> <span class="n">nummode</span><span class="o">==</span><span class="s1">&#39;cnes&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JULIANDAY_TIME_UNITS_CNES</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JULIANDAY_TIME_UNITS_NASA</span>
    <span class="k">if</span> <span class="n">are_valid_units</span><span class="p">(</span><span class="n">nummode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nummode</span>
    <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;nummode must be either a valid time units&#39;</span>
        <span class="s1">&#39; string, or within: &#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_nummodes</span><span class="p">))</span>

<div class="viewcode-block" id="comptime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.comptime">[docs]</a><span class="k">def</span> <span class="nf">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">nummode</span><span class="o">=</span><span class="s1">&#39;mpl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to :func:`cdtime.comptime` format</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>
<span class="sd">        - **nummod**, optional: Numeric case mode.</span>

<span class="sd">            - ``&quot;mpl&quot;``: Converted using :func:`matplotlib.dates.num2date`</span>
<span class="sd">              and :class:`cdtime.comptime`.</span>
<span class="sd">            - ``&quot;julday&quot;``, ``&quot;cnes&quot;``, ``&quot;nasa&quot;``: Considered as juldian days.</span>
<span class="sd">            - Valid time units string: Converted using :class:`cdtime.reldate`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; from datetime import datetime ; import cdtime</span>
<span class="sd">    &gt;&gt;&gt; from vacumm.misc.atime import comptime</span>
<span class="sd">    &gt;&gt;&gt; comptime(datetime(2000,1,1))</span>
<span class="sd">    2000-1-1 0:0:0.0</span>
<span class="sd">    &gt;&gt;&gt; comptime(cdtime.reltime(10,&#39;days since 2008&#39;)).day</span>
<span class="sd">    10</span>
<span class="sd">    &gt;&gt;&gt; comptime(&#39;1900-01-01&#39;).year</span>
<span class="sd">    1900</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`reltime()` :func:`datetime()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Numeric mode</span>
    <span class="n">tunits</span> <span class="o">=</span> <span class="n">_nummode_</span><span class="p">(</span><span class="n">nummode</span><span class="p">)</span>

    <span class="c1"># Time axis</span>
    <span class="k">if</span> <span class="n">is_axistime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>

    <span class="c1"># Argument</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">mytimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">mytime</span> <span class="ow">in</span> <span class="n">mytimes</span><span class="p">:</span>

        <span class="c1"># Component time</span>
        <span class="k">if</span> <span class="n">is_comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Float or int</span>
        <span class="k">if</span> <span class="n">is_numtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tunits</span><span class="o">==</span><span class="s1">&#39;mpl&#39;</span><span class="p">:</span>
                <span class="n">mytime</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mytime</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span>

        <span class="c1"># Datetime</span>
        <span class="k">if</span> <span class="n">is_datetime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">struct_time</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="o">*</span><span class="n">mytime</span><span class="p">[:</span><span class="mi">6</span><span class="p">]))</span>
            <span class="k">continue</span>

        <span class="c1"># String</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;TZ_&#39;</span><span class="p">:</span>
                <span class="n">mytime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">s2c</span><span class="p">(</span><span class="n">mytime</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># Relative time</span>
        <span class="k">if</span> <span class="n">is_reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mytime</span><span class="o">.</span><span class="n">tocomp</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

    <span class="c1"># Fix 60s</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">fixcomptime</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="fixcomptime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.fixcomptime">[docs]</a><span class="k">def</span> <span class="nf">fixcomptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fix the 60s bug of :class:`cdtime.comptime` objects</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Comptime or list of comptimes&quot;&quot;&quot;</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">mytimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">copy</span> <span class="ow">and</span> <span class="n">LH</span><span class="o">.</span><span class="n">listtype</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">mytimes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ComptimeType</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span><span class="o">==</span><span class="mi">60</span><span class="p">:</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Minute</span><span class="p">)</span>
            <span class="n">mytimes</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span></div>

<div class="viewcode-block" id="reltime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.reltime">[docs]</a><span class="k">def</span> <span class="nf">reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to func:`cdtime.reltime` format</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`, a number</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`comptime` :func:`datetime` :func:`strtime`   :func:`numtime`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Time axis</span>
    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">are_same_units</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">mytime</span><span class="o">.</span><span class="n">units</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mytime</span>
        <span class="k">return</span> <span class="n">mytime</span><span class="o">.</span><span class="n">toRelativeTime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

    <span class="c1"># Other</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">ct</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()])</span></div>

<div class="viewcode-block" id="datetime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.datetime">[docs]</a><span class="k">def</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="n">nummode</span><span class="o">=</span><span class="s1">&#39;mpl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to :class:`datetime.datetime` format</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytimes**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`, a number,</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`comptime` :func:`reltime`   :func:`strtime`    :func:`numtime`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Numeric mode</span>
    <span class="n">tunits</span> <span class="o">=</span> <span class="n">_nummode_</span><span class="p">(</span><span class="n">nummode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">):</span>
        <span class="n">mytimes</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytimes</span><span class="p">,</span> <span class="n">nummode</span><span class="o">=</span><span class="n">tunits</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytimes</span><span class="p">)</span>
    <span class="n">mytimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mytime</span> <span class="ow">in</span> <span class="n">mytimes</span><span class="p">:</span>

        <span class="c1"># Numeric</span>
        <span class="k">if</span> <span class="n">is_numtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tunits</span><span class="o">==</span><span class="s1">&#39;mpl&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num2date</span><span class="p">(</span><span class="n">mytime</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mytime</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">tunits</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span>

        <span class="c1"># Tuple</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mytime</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">mytime</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">mytime</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">mytime</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># Others</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
        <span class="n">ct_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">second</span><span class="p">))</span>
        <span class="n">ct_microseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="o">.</span><span class="n">second</span><span class="o">-</span><span class="n">ct_seconds</span><span class="p">)</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>

        <span class="c1"># Quick fix for stupid seconds at 60</span>
        <span class="k">if</span> <span class="n">ct_seconds</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">ct_seconds</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Minute</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
            <span class="n">ct</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">ct_seconds</span><span class="p">,</span> <span class="n">ct_microseconds</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="strtime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.strtime">[docs]</a><span class="k">def</span> <span class="nf">strtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to valid string date</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`, a number,</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`comptime` :func:`reltime`  :func:`datetime`  :func:`numtime`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctimes</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">ctimes</span><span class="p">)</span>
    <span class="n">ctimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctimes</span><span class="p">])</span></div>

<div class="viewcode-block" id="numtime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.numtime">[docs]</a><span class="k">def</span> <span class="nf">numtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to a numeric time using :func:`~matplotlib.dates.date2num`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`, a number</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`comptime` :func:`reltime`  :func:`datetime`  :func:`strtime`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtimes</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">dtimes</span><span class="p">)</span>
    <span class="n">dtimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dtimes</span><span class="p">])</span></div>

<div class="viewcode-block" id="julday"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.julday">[docs]</a><span class="k">def</span> <span class="nf">julday</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cnes&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to a CNES julian days, i.e. days from 1950 (CNES) or 1958 (NASA)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: Time as string, :class:`~datetime.datetime`,</span>
<span class="sd">          :func:`cdtime.comptime`, :func:`cdtime.reltime`, a number</span>
<span class="sd">          or a: mod:`cdms2` time axis.</span>
<span class="sd">        - **ref**, optional: computation mode</span>

<span class="sd">            - ``&quot;cnes&quot;``: days from 1958-01-01</span>
<span class="sd">            - ``&quot;nasa&quot;``: days from 1958-01-01</span>

<span class="sd">    .. note::</span>

<span class="sd">        If not an :mod:`cdms2` time axis, first argument may be a list.</span>
<span class="sd">        In this case, a list is also returned.</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`comptime` :func:`reltime`  :func:`datetime`  :func:`strtime`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;cnes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cnes&#39;</span><span class="p">,</span> <span class="s1">&#39;nasa&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;cnes&#39;</span><span class="p">:</span>
        <span class="n">tunits</span> <span class="o">=</span> <span class="n">JULIANDAY_TIME_UNITS_CNES</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tunits</span> <span class="o">=</span> <span class="n">JULIANDAY_TIME_UNITS_NASA</span>
    <span class="n">rtimes</span> <span class="o">=</span> <span class="n">reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">tunits</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">rtimes</span><span class="p">)</span>
    <span class="n">rtimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">rt</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">rtimes</span><span class="p">])</span></div>


<div class="viewcode-block" id="notz"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.notz">[docs]</a><span class="k">def</span> <span class="nf">notz</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Suppres time zone</span>

<span class="sd">    :Params:</span>

<span class="sd">        - A :class:`datetime.datetime`</span>

<span class="sd">    :Return:</span>

<span class="sd">        - A :class:`datetime.datetime` instance with not TZ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">mytime</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[:</span><span class="mi">6</span><span class="p">])</span></div>

<div class="viewcode-block" id="is_cdtime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_cdtime">[docs]</a><span class="k">def</span> <span class="nf">is_cdtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a mytime is a cdat time (from cdtime)</span>

<span class="sd">    Equivalent to::</span>

<span class="sd">        is_reltime(mytime) or is_comptime()</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; import cdtime</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; from vacumm.misc.atime import is_cdtime</span>
<span class="sd">        &gt;&gt;&gt; is_cdtime(cdtime.reltime(2,&#39;days since 2000&#39;))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; is_cdtime(cdtime.comptime(2000,2))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; is_cdtime(datetime(2000,2,1)</span>
<span class="sd">        False</span>

<span class="sd">    :See also:</span>

<span class="sd">        :func:`is_comptime()`:func:`is_reltime()`  :func:`is_time()`   :func:`is_datetime()`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CdtimeTypes</span></div>

<div class="viewcode-block" id="is_reltime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_reltime">[docs]</a><span class="k">def</span> <span class="nf">is_reltime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is a cdat reltime (from :mod:`cdtime`)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_comptime()` :func:`is_reltime()` :func:`is_cdtime()`   :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">ReltimeType</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_comptime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_comptime">[docs]</a><span class="k">def</span> <span class="nf">is_comptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is a cdat comptime (from :mod:`cdtime`)</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_datetime()` :func:`is_reltime()` :func:`is_cdtime()`  :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">ComptimeType</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_datetime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_datetime">[docs]</a><span class="k">def</span> <span class="nf">is_datetime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is a :class:`datetime.datetime` time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_comptime()` :func:`is_reltime()` :func:`is_cdtime()`   :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_axistime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_axistime">[docs]</a><span class="k">def</span> <span class="nf">is_axistime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is a :mod:`cdms2` time axis</span>

<span class="sd">    Simple shortcut to :func:`~vacumm.misc.axes.istime`.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`~vacumm.misc.axes.istime` :func:`is_comptime()`</span>
<span class="sd">        :func:`is_reltime()` :func:`is_cdtime()`   :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_strtime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_strtime">[docs]</a><span class="k">def</span> <span class="nf">is_strtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is a valid string date</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_datetime()` :func:`is_comptime()` :func:`is_reltime()`</span>
<span class="sd">        :func:`is_cdtime()`   :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">RE_MATCH_TIME</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span></div>
    <span class="c1">#try:</span>
        <span class="c1">#cdtime.s2c(mytime)</span>
        <span class="c1">#return True</span>
    <span class="c1">#except:</span>
        <span class="c1">#return False</span>


<div class="viewcode-block" id="is_numtime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_numtime">[docs]</a><span class="k">def</span> <span class="nf">is_numtime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simply check if a mytime is a number !</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mytime**: object to check</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_datetime()` :func:`is_comptime()` :func:`is_reltime()`</span>
<span class="sd">        :func:`is_cdtime()`   :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span> <span class="ow">and</span> <span class="n">N</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">mytime</span><span class="p">))</span></div>



<div class="viewcode-block" id="check_range"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.check_range">[docs]</a><span class="k">def</span> <span class="nf">check_range</span><span class="p">(</span><span class="n">this_time</span><span class="p">,</span><span class="n">time_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check wether a time is before, within or after a range</span>

<span class="sd">    :Params:</span>

<span class="sd">    - **this_time**: time to check (string or cdat time)</span>
<span class="sd">    - **time_range**: 2(or 3)-element range (strings or cdat times) like (&#39;1975&#39;,1980-10-01&#39;,&#39;co)</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; from vacumm.misc.atime import comptime, reltime, check_range</span>
<span class="sd">        &gt;&gt;&gt; check_range(&#39;2000-12&#39;, (&#39;2000-11&#39;, &#39;2001&#39;))</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; check_range(comptime(2000), (comptime(2000), (&#39;2000&#39;,&#39;20001&#39;,&#39;oc&#39;)))</span>
<span class="sd">    -1</span>

<span class="sd">    :Returns: -1 is before, 0 if within, 1 if after</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Range type</span>
    <span class="n">time_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">range_type</span> <span class="o">=</span> <span class="s1">&#39;co&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">range_type</span> <span class="o">=</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Convert to component time</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">this_time</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
            <span class="n">time_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Before</span>
    <span class="k">if</span> <span class="n">ctime</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="s1">&#39;o&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># After</span>
    <span class="k">if</span> <span class="n">ctime</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">range_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="s1">&#39;o&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># Within</span>
    <span class="k">return</span> <span class="mi">0</span></div>




<div class="viewcode-block" id="is_in_time_interval"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_in_time_interval">[docs]</a><span class="k">def</span> <span class="nf">is_in_time_interval</span><span class="p">(</span><span class="n">this_time</span><span class="p">,</span><span class="n">time_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a time is in specified closed/open range</span>

<span class="sd">    :Params:</span>

<span class="sd">         - **this_time**: time to check (string or cdat time)</span>
<span class="sd">         - **time_range**: 2(or 3)-element range (strings or cdat times) like (&#39;1975&#39;,1980-10-01&#39;,&#39;co)</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; is_in_range(&#39;2000-12&#39;, (&#39;2000-11&#39;, &#39;2001&#39;))</span>
<span class="sd">        True</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`check_range()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="ow">not</span> <span class="n">check_range</span><span class="p">(</span><span class="n">this_time</span><span class="p">,</span><span class="n">time_range</span><span class="p">)</span></div>

<span class="n">is_in_range</span> <span class="o">=</span> <span class="n">is_in_time_interval</span>

<div class="viewcode-block" id="num_to_ascii"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.num_to_ascii">[docs]</a><span class="k">def</span> <span class="nf">num_to_ascii</span><span class="p">(</span><span class="n">yyyy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ss</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert from [yyyy,mm,dd,hh,mn,ss] or component time  or relative time to &#39;yyyy-mm-dd hh:mn:ss&#39;</span>

<span class="sd">    :Params:</span>

<span class="sd">        - *yyyy*: int year OR component OR relative time (cdms) [default: 1]</span>
<span class="sd">        - *mm*: month [default: 1]</span>
<span class="sd">        - *dd*: day [default: 1]</span>
<span class="sd">        - *hh*: hour [default: 0]</span>
<span class="sd">        - *mn*: minute [default: 0]</span>
<span class="sd">        - *ss*: second [default: 0]</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; num_to_ascii(month=2)</span>
<span class="sd">        0001-02-01 00:00:00</span>
<span class="sd">        &gt;&gt;&gt; num_to_ascii(comptime(2000,10))</span>
<span class="sd">        2000-10-01 00:00:00</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_cdtime</span><span class="p">(</span><span class="n">yyyy</span><span class="p">):</span>
        <span class="n">yyyy</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">yyyy</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">second</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">minute</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">day</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">month</span>
        <span class="n">yyyy</span> <span class="o">=</span> <span class="n">yyyy</span><span class="o">.</span><span class="n">year</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%04i</span><span class="s1">-</span><span class="si">%02i</span><span class="s1">-</span><span class="si">%02i</span><span class="s1"> </span><span class="si">%02i</span><span class="s1">:</span><span class="si">%02i</span><span class="s1">:</span><span class="si">%02g</span><span class="s1">&#39;</span> <span class="o">%</span> \
           <span class="p">(</span><span class="n">yyyy</span><span class="p">,</span><span class="n">mm</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">hh</span><span class="p">,</span><span class="n">mn</span><span class="p">,</span><span class="n">ss</span><span class="p">)</span></div>



<div class="viewcode-block" id="ascii_to_num"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.ascii_to_num">[docs]</a><span class="k">def</span> <span class="nf">ascii_to_num</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert from &#39;yyyy-mm-dd hh:mn:ss&#39; to [yyyy,mm,dd,hh,mn,ss]</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; ascii_to_num(&#39;2000-01&#39;)</span>
<span class="sd">        2000, 1, 1, 0, 0, 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sstr</span> <span class="o">=</span>  <span class="n">ss</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">yyyy</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">sstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">sstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="Gaps"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Gaps">[docs]</a><span class="k">class</span> <span class="nc">Gaps</span><span class="p">(</span><span class="n">cdms</span><span class="o">.</span><span class="n">tvariable</span><span class="o">.</span><span class="n">TransientVariable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find time gaps in a variable</span>

<span class="sd">    A gap is defined as a missing time step or data.</span>
<span class="sd">    With this class, you can:</span>

<span class="sd">    - get the gaps as a variable (the object itself)</span>
<span class="sd">    - where 1 refers to the start of gap and -1 to the end</span>
<span class="sd">    - print them (:meth:`show()`)</span>
<span class="sd">    - plot them (:meth:`plot()`)</span>
<span class="sd">    - save them in a netcdf or an ascii file (:meth:`save()`)</span>

<span class="sd">    :Parameters:</span>

<span class="sd">        - **var**: A cdms variable with a cdms time axis</span>
<span class="sd">        - *dt*: Time step [default: minimal time step]</span>
<span class="sd">        - *tolerance*: There is a gap when dt varies  of more than tolerance*min(dt) [default: 0.1]</span>
<span class="sd">        - *keyparam*: verbose Verbose mode</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; import vacumm.misc as M</span>
<span class="sd">        &gt;&gt;&gt; import MV2</span>
<span class="sd">        &gt;&gt;&gt; time = M.axes.create_time([1,2,4,5],units=&#39;days since 2000&#39;)</span>
<span class="sd">        &gt;&gt;&gt; var = MV2.arange</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Check that we have a valid time axis</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span><span class="s1">&#39;Your variable is not a cdms variable&#39;</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mytime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span><span class="s1">&#39;Your variable has no time axis&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_units</span> <span class="o">=</span>  <span class="n">mytime</span><span class="o">.</span><span class="n">units</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s1">&#39;Your time axis needs units&#39;</span>
        <span class="n">kwdt</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">get_dt</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdt</span><span class="p">)</span>

        <span class="c1"># Time compression according to mask</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;...t&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">var</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctbounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctime</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span> <span class="o">=</span> <span class="n">mpl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctbounds</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">getValue</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># Derivatives</span>
        <span class="n">dtf</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">dtr</span> <span class="o">=</span>  <span class="n">dtf</span><span class="o">/</span> <span class="n">dt</span> <span class="c1"># Relative time steps</span>
        <span class="n">dtr</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dtr</span> <span class="o">%</span> <span class="mf">1.</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tolerance</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dtr</span><span class="p">),</span><span class="n">dtr</span><span class="p">)</span>
        <span class="n">dtr</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dtr</span> <span class="o">%</span> <span class="mf">1.</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.</span><span class="o">-</span><span class="n">tolerance</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dtr</span><span class="p">),</span><span class="n">dtr</span><span class="p">)</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span><span class="mf">1.</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">tolerance</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_gap_len</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">gapstime</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gaps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gaps</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_gap_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaps</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">ibefore</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">)[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">)</span>
            <span class="n">gaps</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">gapstime</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">gapstime</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">ibefore</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span>
            <span class="n">gapstime</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">ibefore</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span>
<span class="c1">#            N.put(gapstime,ii,N.take(tt,ibefore)+0.5*dt)</span>
<span class="c1">#            N.put(gapstime,ii+1,N.take(tt,ibefore+1)-0.5*dt)</span>


        <span class="c1"># Time axis of gaps</span>
        <span class="n">gapstime</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">gapstime</span><span class="p">)</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">units</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">designateTime</span><span class="p">(</span><span class="n">calendar</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">DefaultCalendar</span><span class="p">)</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">gapstime</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctime</span> <span class="o">=</span> <span class="n">gapstime</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>

        <span class="c1"># Create cdms variable</span>
        <span class="n">cdms</span><span class="o">.</span><span class="n">tvariable</span><span class="o">.</span><span class="n">TransientVariable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="n">gapstime</span><span class="p">,),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;gaps&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Time gaps&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">gapstime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Found </span><span class="si">%i</span><span class="s1"> gaps&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">headsep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">gaps</span><span class="p">,</span><span class="n">tt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="Gaps.show"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Gaps.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print out gaps</span>

<span class="sd">        Parameters are passed to col_printer()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;No gaps to print&#39;</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.io</span> <span class="k">import</span> <span class="n">col_printer</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">col_printer</span><span class="p">([[</span><span class="s1">&#39;LENGTH&#39;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">],[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">],[</span><span class="s1">&#39;END&#39;</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">]],</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">igap</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">):</span>
            <span class="n">cp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gaps</span><span class="p">[</span><span class="n">igap</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctime</span><span class="p">[</span><span class="n">igap</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctime</span><span class="p">[</span><span class="n">igap</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">cp</span></div>

<div class="viewcode-block" id="Gaps.plot"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Gaps.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mf">2.</span><span class="p">),</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
        <span class="n">subplots_adjust</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span><span class="n">show_time_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the gaps</span>

<span class="sd">        :Params:</span>

<span class="sd">            - *color*: Color of gaps [default: &#39;red&#39;]</span>
<span class="sd">            - *figure*: Show results on a figure if there are gaps [default: True]</span>
<span class="sd">            - *show*: Show the figure plotted if gaps are found [default: True]</span>
<span class="sd">            - *title*: Use this title for the figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;No gaps to plot&#39;</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">plot</span> <span class="k">import</span> <span class="n">xdate</span><span class="p">,</span><span class="n">P</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">mpl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTime</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">igap</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">times</span><span class="p">[</span><span class="n">igap</span><span class="o">*</span><span class="mi">2</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">times</span><span class="p">[</span><span class="n">igap</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="o">**</span><span class="n">subplots_adjust</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_toplot</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis_date</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">()</span>
        <span class="n">P</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Gaps&#39;</span><span class="p">,),</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xdate</span><span class="p">(</span><span class="o">**</span><span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span><span class="s1">&#39;xdate&#39;</span><span class="p">))</span>
        <span class="n">P</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="p">))</span>
        <span class="n">P</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Time gaps&#39;</span>
        <span class="n">P</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_time_range</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Start: </span><span class="si">%s</span><span class="s1">  /  End: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctbounds</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#888888&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savefig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Gaps.save"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Gaps.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save gaps to a netcdf or an ascii file</span>

<span class="sd">        If the file name does not end with &#39;cdf&#39; or &#39;nc&#39;,</span>
<span class="sd">        gaps are printed to an ascii file with the save format</span>
<span class="sd">        as displayed by (show())</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **file**: Netcdf file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span><span class="s1">&#39;cdf&#39;</span><span class="p">]:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngap</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NO GAPS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="unit_type"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.unit_type">[docs]</a><span class="k">def</span> <span class="nf">unit_type</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">string_type</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a type of units in a suitable form with checkings.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **units**: A valid string or cdtime type of units.</span>
<span class="sd">        - *string_type*: Returns a string type instead of a cdtime type [default: False]</span>

<span class="sd">    :Return: A valid string or cdtime type of units</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; unit_type(&#39;minutes&#39;)</span>
<span class="sd">        &gt;&gt;&gt; unit_type(cdtime.Minutes,True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span> <span class="n">units</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">STR_UNIT_TYPES</span><span class="p">:</span>
        <span class="n">this_cdt_type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;cdtime.&#39;</span><span class="o">+</span><span class="n">tt</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">this_cdt_type</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">string_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">this_cdt_type</span>
    <span class="k">if</span> <span class="n">raiseerr</span><span class="p">:</span>  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Wrong type of units: &quot;</span><span class="si">%s</span><span class="s1">&quot;. Valid units are: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">STR_UNIT_TYPES</span><span class="p">))</span></div>




<div class="viewcode-block" id="get_dt"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.get_dt">[docs]</a><span class="k">def</span> <span class="nf">get_dt</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the time steps of an axis.</span>
<span class="sd">    Value is computed according to the median time step,</span>
<span class="sd">    and returned in original or specified units.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **axis**: A time axis.</span>
<span class="sd">        - **units**, optional: Another valid unit type (cdtime or string)</span>

<span class="sd">    :Return: Time step</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; get_dt(var.getTime()</span>
<span class="sd">        &gt;&gt;&gt; get_dt(var.getTime(), cdtime.Months)</span>
<span class="sd">        &gt;&gt;&gt; get_dt(var.getTime(), &#39;months&#39;)</span>

<span class="sd">    :See also: :func:`unit_type()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">istime</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="s1">&#39;You must specify a valid time axis&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;your time axis must have at least 2 elements&#39;</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">unit_type</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Same units</span>
    <span class="n">time_units</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">axis</span><span class="p">[:]))</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">units</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dt</span>

    <span class="c1"># Other units</span>
    <span class="n">time_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
    <span class="n">time_units</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">time_units</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">r2r</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="n">time_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">r2r</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="n">time_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span></div>


<div class="viewcode-block" id="compress"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.compress">[docs]</a><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compress along time&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Find time axis</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">designateTime</span><span class="p">(</span><span class="n">calendar</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">DefaultCalendar</span><span class="p">)</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>

    <span class="c1"># Time is first axis</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>

    <span class="c1"># Reference slab</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">snap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snap</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
        <span class="n">ii0</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="n">nt</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">snap</span><span class="p">)))[:,</span><span class="n">ii0</span><span class="p">]</span>
    <span class="n">slab</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="o">~</span><span class="n">MA</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Select data</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">slab</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">slab</span><span class="p">]</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tt</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()[</span><span class="n">slab</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_dt"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.plot_dt">[docs]</a><span class="k">def</span> <span class="nf">plot_dt</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">time_axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nice</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot axis time step of a netcdf file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="n">plot_date</span><span class="p">,</span><span class="n">show</span><span class="p">,</span><span class="n">plot</span><span class="p">,</span><span class="n">ylim</span>
    <span class="k">if</span> <span class="n">time_axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">time_axis</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">tt</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">tt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nice</span><span class="p">:</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">axis_to_mpl</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">plot_date</span><span class="p">(</span><span class="n">mm</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
    <span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="reduce_old"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.reduce_old">[docs]</a><span class="k">def</span> <span class="nf">reduce_old</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduce a variable in time by performing time average on time step that have the same time or time bounds.</span>

<span class="sd">    - **data**: A cdms variable with first axis supposed to be time.</span>
<span class="sd">    - *comp*: Call to :meth:`compress()` before reducing [default: True]</span>
<span class="sd">    - *fast*: Convert to pure numpy before processing, then convert back to cdms variable [default: True]</span>

<span class="sd">    Return: The new variable on its new time axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">grid.misc</span> <span class="k">import</span> <span class="n">set_grid</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your data must have a valid time axis&#39;</span>

    <span class="c1"># Time compression</span>
    <span class="k">if</span> <span class="n">fast</span><span class="p">:</span> <span class="n">comp</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Find interval for averages</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
    <span class="n">tv</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tt</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">tt</span><span class="p">[:]))</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">tv</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dt</span><span class="p">,[</span><span class="mf">1.</span><span class="p">]))</span>
    <span class="n">dbb</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">bb</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dbb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dbb</span><span class="p">,[[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]]))</span>
    <span class="n">itv</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span><span class="n">MA</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="n">MA</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">dbb</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">),</span>
          <span class="n">N</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">dbb</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.</span><span class="p">)),</span><span class="n">itv</span><span class="p">)</span>
    <span class="n">itv</span> <span class="o">=</span> <span class="n">itv</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>

    <span class="c1"># Fast algo = use Numeric</span>
    <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
        <span class="n">mydata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
        <span class="n">missing_value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getMissing</span><span class="p">()</span>
        <span class="n">AV</span> <span class="o">=</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mydata</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">AV</span> <span class="o">=</span> <span class="n">MV</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">AV</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">typecode</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span><span class="n">savespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute averages</span>
    <span class="n">atime</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">abounds</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">bb</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abounds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">it_first</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">it_last</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itv</span><span class="p">):</span>
        <span class="n">adata</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">AV</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">mydata</span><span class="p">[</span><span class="n">it_first</span><span class="p">:</span><span class="n">it_last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atime</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[</span><span class="n">it_last</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abounds</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="n">it_last</span><span class="p">]</span>
            <span class="n">atime</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">abounds</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">it_first</span> <span class="o">=</span> <span class="n">it_last</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># New time axis</span>
    <span class="n">atime</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">abounds</span><span class="p">)</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">atime</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">atime</span><span class="o">.</span><span class="n">designateTime</span><span class="p">(</span><span class="n">calendar</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">DefaultCalendar</span><span class="p">)</span>

    <span class="c1"># New variable</span>
    <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_object</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">missing_value</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">atime</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">rank</span><span class="p">()):</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_grid</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
        <span class="c1">#adata.setGrid(data.getGrid())</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">adata</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">adata</span></div>

<div class="viewcode-block" id="yearly"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.yearly">[docs]</a><span class="k">def</span> <span class="nf">yearly</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to yearly means</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: A cdms variable.</span>

<span class="sd">    :Return: A cdms variable on a hourly time axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your data must have a valid time axis&#39;</span>

    <span class="n">hdata</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cdutil</span><span class="o">.</span><span class="n">setTimeBoundsYearly</span><span class="p">(</span><span class="n">hdata</span><span class="p">)</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">hdata</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">hdata</span>
    <span class="n">cdutil</span><span class="o">.</span><span class="n">setTimeBoundsYearly</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_data</span></div>

<div class="viewcode-block" id="monthly"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.monthly">[docs]</a><span class="k">def</span> <span class="nf">monthly</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to monthly means</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: A cdms variable.</span>

<span class="sd">    :Return: A cdms variable on a hourly time axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your data must have a valid time axis&#39;</span>

    <span class="n">hdata</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cdutil</span><span class="o">.</span><span class="n">setTimeBoundsMonthly</span><span class="p">(</span><span class="n">hdata</span><span class="p">)</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">hdata</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">hdata</span>
    <span class="n">cdutil</span><span class="o">.</span><span class="n">setTimeBoundsMonthly</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_data</span></div>

<div class="viewcode-block" id="hourly"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.hourly">[docs]</a><span class="k">def</span> <span class="nf">hourly</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to hourly means</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: A cdms variable.</span>
<span class="sd">        - *frequency* Used when different from hourly is requested [default: 24]</span>

<span class="sd">    :Return: A cdms variable on a hourly time axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">daily</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="daily"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.daily">[docs]</a><span class="k">def</span> <span class="nf">daily</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hstart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to daily means</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: A cdms variable with a time axis.</span>
<span class="sd">        - *hstart*: First hour of daily intervals.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; dsst = daily(sst, hstart=12)</span>

<span class="sd">    :See also: :func:`daily_bounds` :func:`reduce`</span>

<span class="sd">    :Return: A cdms variable on a daily time axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your data must have a valid time axis&#39;</span>
    <span class="n">oldbounds</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">taxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">daily_bounds</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">hstart</span><span class="o">=</span><span class="n">hstart</span><span class="p">))</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">taxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">oldbounds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">varo</span></div>


<div class="viewcode-block" id="hourly_exact"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.hourly_exact">[docs]</a><span class="k">def</span> <span class="nf">hourly_exact</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">time_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">maxgap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctlims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linearly interpolate data at exact beginning of hours</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **data**: Cdms variable.</span>
<span class="sd">        - *time_units*: Change time units.</span>
<span class="sd">        - *maxgap*: Maximal gap in hours to enable interpolation [default: None].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">grid.misc</span> <span class="k">import</span> <span class="n">set_grid</span>

    <span class="c1"># Check time</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your data must have a valid time axis&#39;</span>
    <span class="n">old_order</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
    <span class="n">tbounds</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">get_dt</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span><span class="s1">&#39;hour&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">maxgap</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;maxgap (</span><span class="si">%g</span><span class="s1">h) is greater than your time step (</span><span class="si">%g</span><span class="s1">h)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">maxgap</span><span class="p">,</span><span class="n">dt</span><span class="p">))</span>
            <span class="n">maxgap</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create the new hourly time axis</span>
    <span class="k">if</span> <span class="n">ctlims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctlims</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctlims</span> <span class="o">=</span> <span class="p">[</span><span class="n">comptime</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctlims</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">second</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hctlim0</span> <span class="o">=</span> <span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hctlim0</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Hour</span><span class="p">)</span>
    <span class="n">hunits</span> <span class="o">=</span> <span class="s1">&#39;hours since &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hctlim0</span><span class="p">)</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">hunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">ctlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">hunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">htaxis</span> <span class="o">=</span> <span class="n">cdms</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span><span class="n">typecode</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
    <span class="n">htaxis</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">htaxis</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
    <span class="n">htaxis</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">hunits</span>
    <span class="n">htaxis</span><span class="o">.</span><span class="n">designateTime</span><span class="p">(</span><span class="n">calendar</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">DefaultCalendar</span><span class="p">)</span>
    <span class="n">htvalue</span> <span class="o">=</span> <span class="n">htaxis</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
    <span class="n">htaxis</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">bounds1d</span><span class="p">(</span><span class="n">htvalue</span><span class="p">))</span>
    <span class="n">cts</span> <span class="o">=</span> <span class="n">htaxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>

    <span class="c1"># Create the new variable</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htaxis</span>
    <span class="n">hdata</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">typecode</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span><span class="n">savespace</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hdata</span><span class="p">[:]</span> <span class="o">*=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">hdata</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hdata</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">set_grid</span><span class="p">(</span><span class="n">hdata</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
    <span class="c1">#hdata.setGrid(data.getGrid())</span>

    <span class="c1"># Convert to hunits</span>
    <span class="k">def</span> <span class="nf">hvalue</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">r2r</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">taxis</span><span class="o">.</span><span class="n">units</span><span class="p">),</span><span class="n">hunits</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Interpolate to hours</span>
    <span class="n">ith</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">hvalue</span><span class="p">(</span><span class="n">taxis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">it0</span> <span class="o">=</span> <span class="n">it1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">ith</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">htaxis</span><span class="p">):</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">htvalue</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span>
        <span class="c1"># Find the right input interval</span>
        <span class="k">while</span> <span class="n">t1</span> <span class="o">&lt;</span> <span class="n">th</span><span class="p">:</span>
            <span class="n">it1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">hvalue</span><span class="p">(</span><span class="n">taxis</span><span class="p">[</span><span class="n">it1</span><span class="p">])</span>
            <span class="n">it0</span> <span class="o">=</span> <span class="n">it1</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">hvalue</span><span class="p">(</span><span class="n">taxis</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">it0</span><span class="p">,</span><span class="mi">0</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">maxgap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxgap</span><span class="p">:</span> <span class="c1"># Too large interpolation</span>
            <span class="n">dith</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="c1">##          hdata[ith:ith+dith]</span>
            <span class="n">ith</span> <span class="o">+=</span> <span class="n">dith</span> <span class="c1"># We skip these hours</span>
        <span class="k">elif</span> <span class="n">it1</span> <span class="o">==</span> <span class="n">it0</span><span class="p">:</span> <span class="c1"># Strict equality</span>
            <span class="n">hdata</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">it0</span><span class="p">]</span>
            <span class="n">ith</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Linear interpolation</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">it0</span><span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">it1</span><span class="p">]</span>
            <span class="n">hdata</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span><span class="o">-</span><span class="n">v0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">th</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
            <span class="n">ith</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">it0</span> <span class="o">=</span> <span class="n">it1</span>

    <span class="c1"># Change time units</span>
    <span class="k">if</span> <span class="n">time_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">htaxis</span> <span class="o">=</span> <span class="n">ch_units</span><span class="p">(</span><span class="n">htaxis</span><span class="p">,</span><span class="n">time_units</span><span class="p">)</span>
        <span class="n">hdata</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">htaxis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hdata</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">old_order</span><span class="p">)</span></div>



<div class="viewcode-block" id="trend"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.trend">[docs]</a><span class="k">def</span> <span class="nf">trend</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get linear trend&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">genutil.statistics</span> <span class="k">import</span> <span class="n">linearregression</span>
    <span class="kn">from</span> <span class="nn">grid.misc</span> <span class="k">import</span> <span class="n">set_grid</span>

    <span class="c1"># Expansion of first axis</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span><span class="n">typecode</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span><span class="n">sh</span><span class="p">)</span>

    <span class="c1"># Coeffs</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="n">linearregression</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="c1"># Trend</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">var_trend</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sh</span><span class="p">)</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">+</span> <span class="n">MV2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sh</span><span class="p">))</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var_trend</span><span class="p">)</span>
    <span class="n">var_trend</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s1">&#39;_trend&#39;</span>
    <span class="n">var_trend</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">var_trend</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="n">var_trend</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">):</span>
        <span class="n">var_trend</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Linear trend of &#39;</span><span class="o">+</span><span class="n">var_trend</span><span class="o">.</span><span class="n">long_name</span>
    <span class="n">var_trend</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
    <span class="n">set_grid</span><span class="p">(</span><span class="n">var_trend</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
    <span class="c1">#var_trend.setGrid(var.getGrid())</span>

    <span class="k">return</span> <span class="n">var_trend</span></div>

<div class="viewcode-block" id="detrend"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.detrend">[docs]</a><span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear detrend&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">grid.misc</span> <span class="k">import</span> <span class="n">set_grid</span>

    <span class="n">var_detrend</span> <span class="o">=</span> <span class="n">var</span> <span class="o">-</span> <span class="n">trend</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var_detrend</span><span class="p">)</span>
    <span class="n">var_detrend</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;detrended_&#39;</span><span class="o">+</span><span class="n">var</span><span class="o">.</span><span class="n">id</span>
    <span class="n">var_detrend</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">var_detrend</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="n">var_detrend</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">):</span>
        <span class="n">var_detrend</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detrended &#39;</span><span class="o">+</span><span class="n">var_detrend</span><span class="o">.</span><span class="n">long_name</span>
    <span class="n">var_detrend</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
    <span class="n">set_grid</span><span class="p">(</span><span class="n">var_detrend</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
    <span class="c1">#var_detrend.setGrid(var.getGrid())</span>

    <span class="k">return</span> <span class="n">var_detrend</span></div>


<div class="viewcode-block" id="strftime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.strftime">[docs]</a><span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="n">mytime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert current time, datetime, cdtime or string time to strftime</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **fmt**: Time format with date patterns, like ``&quot;%Y-%m-%d&quot;``.</span>
<span class="sd">        - **mytime**, optional: If None, takes current time using</span>
<span class="sd">         (:meth:`~datetime.datetime.now()`)</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; print strftime(&#39;%Y-%m-%d&#39;)</span>
<span class="sd">        2014-02-25</span>
<span class="sd">        &gt;&gt;&gt; ctime = strftime(&#39;%Hh%M&#39;, &#39;2020&#39;)</span>
<span class="sd">        00h00</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :meth:`datetime.datetime.strftime` and</span>
<span class="sd">        `this link &lt;http://docs.python.org/dev/library/datetime.html#strftime-strptime-behavior&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mytime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">mytime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span></div>

<div class="viewcode-block" id="strptime"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.strptime">[docs]</a><span class="k">def</span> <span class="nf">strptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="n">fmt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a string according to a format to retreive a component time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **fmt**: Time format with date patterns, like ``&quot;%Y-%m-%d&quot;``.</span>
<span class="sd">        - **mytime**: Date string.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; print strptime(&#39;25 Jan 2000, &#39;%d %b %Y&#39;).month</span>
<span class="sd">        1</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :meth:`datetime.datetime.strptime` and</span>
<span class="sd">        `this link &lt;http://docs.python.org/dev/library/datetime.html#strftime-strptime-behavior&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="n">fmt</span><span class="p">))</span></div>


<span class="n">_re_has_time_pattern</span> <span class="o">=</span> <span class="n">recompile</span><span class="p">(</span><span class="s1">&#39;%[aAbBcdfHIjmpSUwWxXyYzZ]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
<div class="viewcode-block" id="has_time_pattern"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.has_time_pattern">[docs]</a><span class="k">def</span> <span class="nf">has_time_pattern</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does ss string contains date pattern like %Y?&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_re_has_time_pattern</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DT</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">ss</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="tz_to_tz"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.tz_to_tz">[docs]</a><span class="k">def</span> <span class="nf">tz_to_tz</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">old_tz</span><span class="p">,</span> <span class="n">new_tz</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert time from one time zone to another one&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">timezone</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;You must install pytz package to add time zone support&#39;</span>
            <span class="s1">&#39; to vacumm&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_tz</span><span class="p">,</span><span class="n">basestring</span><span class="p">):</span> <span class="n">old_tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">old_tz</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_tz</span><span class="p">,</span><span class="n">basestring</span><span class="p">):</span> <span class="n">new_tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span>

    <span class="c1"># Variable</span>
    <span class="k">if</span> <span class="n">cdms</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
        <span class="n">check_axes</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Your variable must have a valid time axis&#39;</span>
        <span class="k">return</span> <span class="n">tz_to_tz</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">old_tz</span><span class="p">,</span> <span class="n">new_tz</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

    <span class="c1"># Time axis case</span>
    <span class="k">if</span> <span class="n">istime</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span> <span class="n">mytime</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">ctimes</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctimes</span><span class="p">):</span>
            <span class="n">new_ct</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">old_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">))</span>
            <span class="n">mytime</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ct</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">mytime</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">mytime</span>

    <span class="c1"># Loop</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">_LH_</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">intimes</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">outtimes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intimes</span><span class="p">)</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">intimes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mytime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intimes</span><span class="p">):</span>

        <span class="c1"># Guess type</span>
        <span class="n">typeback</span> <span class="o">=</span> <span class="n">time_type</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span>  <span class="n">out</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typeback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Time of wrong type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mytime</span>
        <span class="k">if</span> <span class="n">typeback</span> <span class="o">==</span> <span class="n">reltime</span><span class="p">:</span>
            <span class="n">myUnits</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">units</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

        <span class="c1"># Change zone</span>
        <span class="n">new_dt</span> <span class="o">=</span> <span class="n">old_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">new_tz</span><span class="p">)</span>

        <span class="c1"># Back to correct type</span>
        <span class="k">if</span> <span class="n">typeback</span> <span class="o">==</span> <span class="n">reltime</span><span class="p">:</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">typeback</span><span class="p">(</span><span class="n">new_dt</span><span class="p">,</span> <span class="n">myUnits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mytime</span> <span class="o">=</span> <span class="n">typeback</span><span class="p">(</span><span class="n">new_dt</span><span class="p">)</span>
        <span class="n">outtimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mytime</span>

    <span class="k">return</span> <span class="n">LH</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">outtimes</span><span class="p">)</span></div>


<div class="viewcode-block" id="from_utc"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.from_utc">[docs]</a><span class="k">def</span> <span class="nf">from_utc</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="n">new_tz</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tz_to_tz</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="n">new_tz</span><span class="p">)</span></div>
<div class="viewcode-block" id="to_utc"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.to_utc">[docs]</a><span class="k">def</span> <span class="nf">to_utc</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="n">old_tz</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tz_to_tz</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="n">old_tz</span><span class="p">,</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="paris_to_utc"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.paris_to_utc">[docs]</a><span class="k">def</span> <span class="nf">paris_to_utc</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tz_to_tz</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">,</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="utc_to_paris"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.utc_to_paris">[docs]</a><span class="k">def</span> <span class="nf">utc_to_paris</span><span class="p">(</span><span class="n">mytime</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tz_to_tz</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">tzname_to_tz</span><span class="p">(</span><span class="n">mytzname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get first time zone found from time zone short name</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; tz = tzname_to_tz(&#39;CEST&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">all_timezones</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;You must install pytz package to add time zone support&#39;</span>
            <span class="s1">&#39; to vacumm&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_timezones</span><span class="p">:</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tz</span><span class="p">,</span> <span class="s1">&#39;_tzinfos&#39;</span><span class="p">):</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">utcoffset</span><span class="p">,</span> <span class="n">daylight</span><span class="p">,</span> <span class="n">tzname</span><span class="p">),</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tz</span><span class="o">.</span><span class="n">_tzinfos</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tzname</span> <span class="o">==</span> <span class="n">mytzname</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tz</span>



<div class="viewcode-block" id="DateSorter"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.DateSorter">[docs]</a><span class="k">class</span> <span class="nc">DateSorter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort a list of date string, optionally using a date pattern</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from vacumm.misc.atime import DateSorter</span>
<span class="sd">        &gt;&gt;&gt; dates = [&#39;annee 2006&#39;, &#39;annee 2002&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ds = DateSorter(&#39;annee %Y&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dates.sort(ds)</span>
<span class="sd">        &gt;&gt;&gt; print dates</span>
<span class="sd">        [&#39;2002&#39;, &#39;2006&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">basename</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">:</span>
                <span class="n">arg1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
                <span class="n">arg2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span>
            <span class="n">date1</span> <span class="o">=</span> <span class="n">strptime</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">date2</span> <span class="o">=</span> <span class="n">strptime</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date1</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
            <span class="n">date2</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span>
        <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;seconds since 2000&#39;</span>
        <span class="n">date1</span> <span class="o">=</span> <span class="n">date1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">date2</span> <span class="o">=</span> <span class="n">date2</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">date1</span> <span class="o">==</span> <span class="n">date2</span><span class="p">:</span><span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">date1</span> <span class="o">&lt;</span> <span class="n">date2</span><span class="p">:</span><span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SpecialDateFormatter"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.SpecialDateFormatter">[docs]</a><span class="k">class</span> <span class="nc">SpecialDateFormatter</span><span class="p">(</span><span class="n">DateFormatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Special formatter for dates</span>
<span class="sd">    Example: [&#39;00h 01/10/2000&#39; &#39;02h&#39; .... &#39;23h&#39;  &#39;00h 01/10/2000&#39;] to mark days and keep hours</span>
<span class="sd">    Here the &#39;phase&#39; is 0 (00h) and the level is 3 (=&#39;day&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">special_fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">join</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>


        <span class="c1"># Which level?</span>
        <span class="n">slevels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slevels</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">slevels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="c1"># Autoformat</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Year</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%b&#39;</span>
            <span class="k">if</span> <span class="n">special_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">special_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y&#39;</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Month</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%e</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">special_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">special_fmt</span> <span class="o">=</span> <span class="s1">&#39;%B&#39;</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Day</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%Hh&#39;</span>
            <span class="k">if</span> <span class="n">special_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">special_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Hour</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%M&#39;&quot;</span>
            <span class="k">if</span> <span class="n">special_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">special_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Hh&#39;</span>
            <span class="k">if</span> <span class="n">join</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">join</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># Minute</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%S&#39;&#39;&quot;</span>
            <span class="k">if</span> <span class="n">special_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">special_fmt</span> <span class="o">=</span> <span class="s2">&quot;%M&#39;&quot;</span>
            <span class="k">if</span> <span class="n">join</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">join</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y&#39;</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%M&#39;%Ss&#39;&#39;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-</span><span class="si">%d</span><span class="s1">-%m %H:%M&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>

        <span class="n">DateFormatter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fmt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span>

        <span class="c1"># Joined format</span>
        <span class="k">if</span> <span class="n">join</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">join</span> <span class="o">=</span> <span class="s1">&#39;%n&#39;</span>
        <span class="k">if</span> <span class="n">join</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_fmt</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fmt</span><span class="p">,</span><span class="n">special_fmt</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_fmt</span> <span class="o">=</span> <span class="n">special_fmt</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
        <span class="c1"># Main label</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:]):</span><span class="c1">#(0,)*(4-self.level):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_fmt</span><span class="p">)</span>
        <span class="c1"># Intermediate label</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">)</span></div>



<div class="viewcode-block" id="interp"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.interp">[docs]</a><span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span><span class="n">outtimes</span><span class="p">,</span><span class="n">squeeze</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear interpolation in time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vari****: A cdms variable with a time axis</span>
<span class="sd">        - **outtimes**: A time axis, or a list (or single element) of date strings, comptime, reltime, datetime times.</span>
<span class="sd">        - *squeeze*: Remove uneeded output dimensions [default: 1]</span>
<span class="sd">        - all other keywords are passed to :func:`~vacumm.misc.grid.regridding.interp1d`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to time axis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">istime</span><span class="p">(</span><span class="n">outtimes</span><span class="p">):</span>
        <span class="n">outtimes</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">outtimes</span><span class="p">)</span>

    <span class="c1"># Call to interp1d</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">regridding</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">outtimes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Squeeze?</span>
    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="n">varo</span> <span class="o">=</span> <span class="n">varo</span><span class="p">(</span><span class="n">squeeze</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">varo</span></div>



<div class="viewcode-block" id="is_time"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_time">[docs]</a><span class="k">def</span> <span class="nf">is_time</span><span class="p">(</span><span class="n">mytime</span><span class="p">,</span> <span class="n">alsonum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if mytime is a CDAT time, a :class:`datetime.datetime` or date valid string.</span>

<span class="sd">    Equivalent to::</span>

<span class="sd">        timetype(mytime) is not None</span>

<span class="sd">    :Sea also:</span>

<span class="sd">        :func:`is_datetime()` :func:`is_reltime()` :func:`is_cdtime()`</span>
<span class="sd">        :func:`is_numtime()` :func:`is_time()`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ttype</span> <span class="o">=</span> <span class="n">time_type</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ttype</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alsonum</span> <span class="ow">or</span> <span class="n">ttype</span><span class="o">!=</span><span class="s1">&#39;numtime&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_interval"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.is_interval">[docs]</a><span class="k">def</span> <span class="nf">is_interval</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if interval is a valid time interval</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **interval**: It should be in the following generic form</span>
<span class="sd">        ``(&lt;time0&gt;,&lt;time1&gt;[,&lt;bounds&gt;])``, where ``&lt;time?&gt;`` is a valid time</span>
<span class="sd">        (see :func:`time_type` and :func:`is_valid`) and ``&lt;bounds&gt;`` are</span>
<span class="sd">        interval bounds such as ``&quot;co&quot;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_time</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_time</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">basestring</span><span class="p">)</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="round_date"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.round_date">[docs]</a><span class="k">def</span> <span class="nf">round_date</span><span class="p">(</span><span class="n">mydate</span><span class="p">,</span> <span class="n">round_type</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Round a date to a step in year, month, day, hour, minute or second</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **mydate**: A date compatible with :func:`comptime`.</span>
<span class="sd">        - **round_type**: A string like &quot;year&quot; or a tuple like (3, &quot;year&quot;).</span>
<span class="sd">        - **mode**, optional: Rounding mode</span>

<span class="sd">            - ``&quot;ceil&quot;``: Choose the upper time.</span>
<span class="sd">            - ``&quot;floor&quot;``: Choose the lower time.</span>
<span class="sd">            - Else choose the nearest.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">round_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">step</span><span class="p">,</span> <span class="n">round_type</span> <span class="o">=</span> <span class="n">round_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">round_type</span><span class="p">):</span>
        <span class="n">round_type</span> <span class="o">=</span> <span class="n">STR_UNIT_TYPES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">unit_type</span><span class="p">(</span><span class="n">round_type</span><span class="p">,</span> <span class="n">string_type</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">stype</span> <span class="o">=</span> <span class="n">STR_UNIT_TYPES</span><span class="p">[</span><span class="n">round_type</span><span class="p">]</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mydate</span><span class="p">)</span>
    <span class="n">sdate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">RE_SPLIT_DATE</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span> <span class="k">if</span> <span class="n">ss</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">][:</span><span class="n">round_type</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="n">round_type</span><span class="p">]</span> <span class="c1"># [year, month, ...]</span>
    <span class="n">rectif</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">base</span><span class="p">)</span> <span class="o">%</span> <span class="n">step</span>
    <span class="n">ct0</span> <span class="o">=</span> <span class="n">add_time</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">),</span> <span class="o">-</span><span class="n">rectif</span><span class="p">,</span> <span class="n">stype</span><span class="p">)</span>
    <span class="n">ct1</span> <span class="o">=</span> <span class="n">ct0</span> <span class="k">if</span> <span class="n">ct</span><span class="o">==</span><span class="n">ct0</span> <span class="k">else</span> <span class="n">add_time</span><span class="p">(</span><span class="n">ct0</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">stype</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since &#39;</span><span class="o">+</span><span class="n">sdate</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;floor&#39;</span><span class="p">,</span> <span class="s1">&#39;ceil&#39;</span><span class="p">]:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;round&#39;</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;round&#39;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;ceil&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">ct0</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ct1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;floor&#39;</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;ceil&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ct1</span>
    <span class="k">return</span> <span class="n">ct0</span></div>

<div class="viewcode-block" id="round_interval"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.round_interval">[docs]</a><span class="k">def</span> <span class="nf">round_interval</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">round_type</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Round an time interval using :func:`round_date`</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **time**: A time interval like ``(time0, time1, &#39;cce&#39;)``</span>
<span class="sd">        - **round_type**: A string like &quot;year&quot; or a tuple like (3, &quot;year&quot;).</span>
<span class="sd">        - **mode**, optional: Rounding mode</span>

<span class="sd">            - ``&quot;inner&quot;``: Upper for the lower bound and lower for the upper bound.</span>
<span class="sd">            - ``&quot;outer&quot;``: Opposite to &quot;inner&quot;</span>
<span class="sd">            - tuple: first is applied to lower bound, second to upper bound.</span>
<span class="sd">            - Else, passed to :func:`round_date` and applied to both bounds.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Mode</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;inner&#39;</span><span class="p">:</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;outer&#39;</span><span class="p">:</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">round_date</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">round_type</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">round_date</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">round_type</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span></div>

<div class="viewcode-block" id="midnight_date"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.midnight_date">[docs]</a><span class="k">def</span> <span class="nf">midnight_date</span><span class="p">(</span><span class="n">mydate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Round a date to the closest midnight</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; print midnight_date(&#39;2010-11-29 23:10&#39;)</span>
<span class="sd">        2010-11-30 0:0:0.0</span>


<span class="sd">    :Return: :class:`cdtime.comptime` date at midnight</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">mydate</span><span class="p">)</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ctime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ctime</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hour</span><span class="o">&gt;=</span><span class="mi">12</span><span class="p">:</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ctime</span></div>

<div class="viewcode-block" id="midnight_interval"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.midnight_interval">[docs]</a><span class="k">def</span> <span class="nf">midnight_interval</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Round dates of a closed interval to the closest midnight</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; print midnight_interval(&#39;2010-11-29 23:10&#39;)</span>
<span class="sd">        (2010-11-30 0:0:0.0, 2010-11-30 0:0:0.0, &#39;ccb&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print midnight_interval((&#39;2010-11-29 23:10&#39;,&#39;2010-11-30 04&#39;))</span>
<span class="sd">        (2010-11-30 0:0:0.0, 2010-11-30 0:0:0.0, &#39;ccb&#39;)</span>

<span class="sd">    :Return: :class:`cdtime.comptime` interval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">midnight_date</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">midnight_date</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="s1">&#39;ccb&#39;</span><span class="p">)</span>
    <span class="n">mydate</span> <span class="o">=</span> <span class="p">[</span><span class="n">midnight_date</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">midnight_date</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="n">mydate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mydate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="n">mydate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mydate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">)</span>
    <span class="n">mydate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ccb&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">mydate</span><span class="p">)</span></div>


<div class="viewcode-block" id="daily_bounds"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.daily_bounds">[docs]</a><span class="k">def</span> <span class="nf">daily_bounds</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">hstart</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a daily time bounds array from a time axis</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **taxis**: A time axis or a variable with a time axis.</span>
<span class="sd">        - **hstart**, optional: First hour of each daily bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input variable has no valid time axis&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">istime</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input axis in not a valid time axis&#39;</span><span class="p">)</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">units</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()):</span>
        <span class="n">bref</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">hstart</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ct</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="n">hstart</span><span class="p">:</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Day</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">bb</span></div>

<div class="viewcode-block" id="hourly_bounds"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.hourly_bounds">[docs]</a><span class="k">def</span> <span class="nf">hourly_bounds</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">mstart</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a hourly time bounds array from a time axis</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **taxis**: A time axis or a variable with a time axis.</span>
<span class="sd">        - **mstart**, optional: First minute of each daily bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span>
        <span class="n">taxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input variable has no valid time axis&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">istime</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input axis in not a valid time axis&#39;</span><span class="p">)</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">units</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()):</span>
        <span class="n">bref</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">mstart</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ct</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;=</span> <span class="n">mstart</span><span class="p">:</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Hour</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">Hour</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">bb</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bref</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">bb</span></div>


<div class="viewcode-block" id="reduce"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.reduce">[docs]</a><span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">geterr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Average time steps that have the same bounds or time</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **vari**: Aray with a valid time axis.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; taxis = sst.getTime()</span>
<span class="sd">        &gt;&gt;&gt; tbounds = daily_bounds(taxis, hstart=12)</span>
<span class="sd">        &gt;&gt;&gt; taxis.setBounds(tbounds)</span>
<span class="sd">        &gt;&gt;&gt; nightly_sst = reduce(sst)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">grid.misc</span> <span class="k">import</span> <span class="n">set_grid</span>

    <span class="c1"># Inits</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">taxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input variable has no valid time axis&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span>
    <span class="n">vari</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">nti</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>

    <span class="c1"># Compression intervals</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nti</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">it_lasts</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="n">dt</span><span class="o">!=</span><span class="mf">0.</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">tv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nti</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ddt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">it_lasts</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[(</span><span class="n">ddt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ddt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">it_lasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nti</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Init output</span>
    <span class="n">nto</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_lasts</span><span class="p">)</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nto</span><span class="p">,)</span><span class="o">+</span><span class="n">vari</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">vari</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">cp_atts</span><span class="p">(</span><span class="n">vari</span><span class="p">,</span> <span class="n">varo</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vari</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">set_grid</span><span class="p">(</span><span class="n">varo</span><span class="p">,</span><span class="n">vari</span><span class="o">.</span><span class="n">getGrid</span><span class="p">())</span>
    <span class="c1">#varo.setGrid(vari.getGrid())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vari</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">varo</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">varo</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">dtime</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nto</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbounds</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nto</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">geterr</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">varo</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">err</span><span class="o">.</span><span class="n">id</span> <span class="o">+=</span> <span class="s1">&#39;_error&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">):</span>
            <span class="n">err</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+=</span> <span class="s1">&#39; average error&#39;</span>

    <span class="c1"># Loop on intervals</span>
    <span class="n">mvari</span> <span class="o">=</span> <span class="n">vari</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
    <span class="n">it_first</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">it_last</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it_lasts</span><span class="p">):</span>
        <span class="n">varo</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">mvari</span><span class="p">[</span><span class="n">it_first</span><span class="p">:</span><span class="n">it_last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geterr</span><span class="p">:</span>
            <span class="n">err</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">mvari</span><span class="p">[</span><span class="n">it_first</span><span class="p">:</span><span class="n">it_last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtime</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="n">it_last</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbounds</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="n">it_last</span><span class="p">]</span>
            <span class="n">dtime</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="n">it_last</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">bb</span><span class="p">[</span><span class="n">it_last</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">it_first</span> <span class="o">=</span> <span class="n">it_last</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># Finish</span>
    <span class="n">dtime</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">taxis</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtime</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">dbounds</span><span class="p">)</span>
    <span class="n">varo</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtime</span><span class="p">)</span>
    <span class="n">varo</span> <span class="o">=</span> <span class="n">varo</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">geterr</span><span class="p">:</span>
        <span class="n">err</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtime</span><span class="p">)</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">varo</span><span class="p">,</span> <span class="n">err</span>
    <span class="k">return</span> <span class="n">varo</span></div>


<div class="viewcode-block" id="add_margin"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.add_margin">[docs]</a><span class="k">def</span> <span class="nf">add_margin</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">lmargin</span><span class="p">,</span> <span class="n">rmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a margin to an interval</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **interval**: A time interval or selector such as ``(&#39;2000&#39;, &#39;20001&#39;, &#39;co&#39;)``</span>
<span class="sd">          Specified times may be of any valid type.</span>
<span class="sd">        - **lmargin**: Left margin. Examples:</span>

<span class="sd">            - ``(3,&#39;months&#39;)``: explicit.</span>
<span class="sd">            - ``&#39;hours&#39;``: Same as ````(1,&#39;hours&#39;)``.</span>
<span class="sd">            - ``4``: Relative margin of size ``(interval[1]-interval[0)/4``.</span>
<span class="sd">            - ``False``: no margin.</span>

<span class="sd">          A negative margin decrease the size of the interval.</span>

<span class="sd">        - **rmargin**, optional: Right margin (defaults to the left).</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; print add_margin((&#39;2000&#39;, &#39;2001&#39;, &#39;co&#39;), (5, &#39;days&#39;))</span>
<span class="sd">        (&#39;1999-12-27 0:0:0.0&#39;, &#39;2001-1-6 0:0:0.0&#39;, &#39;co&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Interval</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_interval</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Wrong time interval&#39;</span><span class="p">)</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Format margin</span>
    <span class="k">if</span> <span class="n">lmargin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">margins</span> <span class="o">=</span> <span class="p">[</span><span class="n">lmargin</span><span class="p">,</span> <span class="n">rmargin</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">margin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">margins</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">margin</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="c1"># only units</span>
                <span class="n">newmargin</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">unit_type</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span> <span class="n">string_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> <span class="c1"># fraction of interval</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rtimes</span> <span class="o">=</span> <span class="n">reltime</span><span class="p">(</span><span class="n">interval</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;seconds since 2000&#39;</span><span class="p">)</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">rtimes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">rtimes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">margin</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">newmargin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newmargin</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="n">margin</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">basestring</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Wrong time margin&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newmargin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="n">margins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newmargin</span><span class="p">)</span>
    <span class="n">margins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">margins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Apply</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">interval</span><span class="p">)([</span><span class="n">add_time</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">margins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">add_time</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">margins</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">+</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span></div>


<div class="viewcode-block" id="Intervals"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Intervals">[docs]</a><span class="k">class</span> <span class="nc">Intervals</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator on intervals</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **time_range**: Time range (optionally with bounds).</span>
<span class="sd">        - **dt**: Size of intervals.</span>
<span class="sd">        - **reverse**, optional: Reverse the iterator.</span>
<span class="sd">        - **roundto**, optional: Round times  to this time units (like &#39;hours&#39;, etc).</span>
<span class="sd">        - **bounds**, optional: Add bounds specs to the intervals (like &quot;co&quot;).</span>
<span class="sd">        - **l/rmargin**, optional: Add a margin to the left and/or right of each interval.</span>
<span class="sd">          See :func:`add_margin`.</span>
<span class="sd">        - **innerbounds**, optional: Add bounds specs to inner intervals (like &quot;cc&quot;).</span>
<span class="sd">        - **roundmode**, optional:</span>
<span class="sd">            - &quot;all&quot;: Round all dates.</span>
<span class="sd">            - &quot;inner&quot;: Round only inner dates, not first and last.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; for itv in Intervals((&#39;2000&#39;,&#39;2001&#39;,&#39;co&#39;),(2,&#39;month&#39;)): print itv</span>
<span class="sd">        &gt;&gt;&gt; Intervals((&#39;2000&#39;,&#39;2001&#39;,&#39;co&#39;),12).tolist()</span>
<span class="sd">        &gt;&gt;&gt; Intervals((cdtime.comptime(2000), &#39;2001&#39;, &#39;month&#39;,</span>
<span class="sd">        ... reverse=True, lmargin=(3,&#39;hours&#39;))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roundto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lmargin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">innerbounds</span><span class="o">=</span><span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="n">roundmode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>

        <span class="c1"># Global range</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_interval</span><span class="p">(</span><span class="n">time_range</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;Wrong time interval&#39;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># dt</span>
        <span class="k">if</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;seconds since 2000&#39;</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">end_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">start_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">,</span>
                <span class="s1">&#39;second&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Round this range</span>
        <span class="k">if</span> <span class="n">roundto</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">roundto</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">roundmode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roundmode</span> <span class="o">=</span> <span class="n">roundmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span> <span class="o">=</span> <span class="n">roundto</span>
        <span class="k">if</span> <span class="n">roundmode</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmargin</span> <span class="o">=</span> <span class="n">lmargin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmargin</span> <span class="o">=</span> <span class="n">rmargin</span>

        <span class="c1"># Closed or open?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innerbounds</span> <span class="o">=</span> <span class="n">innerbounds</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span> <span class="o">=</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span> <span class="o">=</span> <span class="s1">&#39;co&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_innerbounds</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Inits the iterator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">][</span><span class="n">reverse</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">][::</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">reverse</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="n">reverse</span>

        <span class="c1"># Interval as (value,units)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">reverse</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="Intervals.round"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Intervals.round">[docs]</a>    <span class="k">def</span> <span class="nf">round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mydate</span><span class="p">):</span>
<span class="c1">#        if self._roundto and (self._roundmode==&#39;all&#39; or</span>
<span class="c1">#                (mydate!=self._first_date and mydate!=self._last_date)):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">round_date</span><span class="p">(</span><span class="n">mydate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mydate</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Intervals.next"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Intervals.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Iterator is consumed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="c1"># Compute end of interval</span>
        <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">add_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

        <span class="c1"># We just passed the end</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="ow">and</span> <span class="n">next_date</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="ow">and</span> <span class="n">next_date</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span>

        <span class="c1"># Save new state</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">=</span> <span class="n">next_date</span>

        <span class="c1"># Return interval</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">next_date</span><span class="p">,</span> <span class="n">current_date</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span>
                      <span class="k">if</span> <span class="n">current_date</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_first_date</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                      <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_innerbounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">current_date</span><span class="p">,</span> <span class="n">next_date</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastbounds</span>
                      <span class="k">if</span> <span class="n">next_date</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span><span class="p">)</span>
                      <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_innerbounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmargin</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmargin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">add_margin</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmargin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmargin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Intervals.tolist"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.Intervals.tolist">[docs]</a>    <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="IterDates"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.IterDates">[docs]</a><span class="k">class</span> <span class="nc">IterDates</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator on dates</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from vacumm.misc.atime import IterDates</span>
<span class="sd">        &gt;&gt;&gt; for date in IterDates((&#39;2000&#39;,&#39;2001&#39;),(1,&#39;month&#39;)): print date</span>
<span class="sd">        &gt;&gt;&gt; for date in IterDates((&#39;2000&#39;,&#39;2001&#39;),12,closed=False): print date</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roundto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Global range</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># dt</span>
        <span class="k">if</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;seconds since 2000&#39;</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">end_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">start_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">dt</span><span class="p">,</span>
                <span class="s1">&#39;second&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Round this range</span>
        <span class="k">if</span> <span class="n">roundto</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">roundto</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span> <span class="o">=</span> <span class="n">roundto</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Closed or open?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="n">closed</span>

        <span class="c1"># Inits the iterator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">][</span><span class="n">reverse</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">][</span><span class="mi">1</span><span class="o">-</span><span class="n">reverse</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="n">reverse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">oper</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="k">else</span> <span class="s1">&#39;g&#39;</span>
        <span class="n">oper</span> <span class="o">+=</span> <span class="s1">&#39;t&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="k">else</span> <span class="s1">&#39;e&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oper</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">oper</span><span class="p">)</span>

        <span class="c1"># Interval as (value,units)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">reverse</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="IterDates.round"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.IterDates.round">[docs]</a>    <span class="k">def</span> <span class="nf">round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mydate</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">round_date</span><span class="p">(</span><span class="n">mydate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundto</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mydate</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="IterDates.next"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.IterDates.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Next date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_date</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">add_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

        <span class="c1"># Iterator is consumed</span>
        <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;seconds since 2000&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oper</span><span class="p">(</span><span class="n">next_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_date</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="c1"># Save and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">=</span> <span class="n">next_date</span>
        <span class="k">return</span> <span class="n">next_date</span></div>

<div class="viewcode-block" id="IterDates.tolist"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.IterDates.tolist">[docs]</a>    <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">date</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="time_split"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.time_split">[docs]</a><span class="k">def</span> <span class="nf">time_split</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">roundit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bb</span><span class="o">=</span><span class="s1">&#39;co&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic function to split an interval into subintervals</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **what**: Time interval, dates or time axis</span>
<span class="sd">          that can be converted using :func:`comptime`.</span>
<span class="sd">        - **how**: Splitting specifications.</span>

<span class="sd">            #. A number: divide the interval in equal subintervals.</span>
<span class="sd">            #. A single or a list of dates: build subintervals</span>
<span class="sd">               with theses dates.</span>
<span class="sd">            #. A :class:`IterDates` instance: generate a list of</span>
<span class="sd">               dates and make as in 2.</span>
<span class="sd">            #. A :class:`Intervals` instance: directly generate</span>
<span class="sd">               a list of intervals.</span>

<span class="sd">        - **roundit**, optional: Round interval. Valid only if</span>
<span class="sd">          ``how`` is an time step specification such as</span>
<span class="sd">          ``(1,&#39;year&#39;)`` or ``&quot;year&quot;`` (see :class:`Intervals`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to comptime</span>
    <span class="n">bbw</span> <span class="o">=</span> <span class="s1">&#39;cc&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">bbw</span> <span class="o">=</span> <span class="n">what</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">what</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">what</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">what</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t split a single date&quot;</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="n">tminmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">bbw</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">how</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tminmax</span>

    <span class="c1"># Single date</span>
    <span class="k">if</span> <span class="n">is_time</span><span class="p">(</span><span class="n">how</span><span class="p">):</span> <span class="n">how</span> <span class="o">=</span> <span class="p">[</span><span class="n">how</span><span class="p">]</span>

    <span class="c1"># dt</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isNumberType</span><span class="p">(</span><span class="n">how</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">or</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">how</span> <span class="o">=</span> <span class="n">Intervals</span><span class="p">(</span><span class="n">tminmax</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">how</span><span class="p">,</span> <span class="n">roundto</span><span class="o">=</span><span class="n">roundit</span><span class="p">)</span>

    <span class="c1"># Interval interator</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="n">Intervals</span><span class="p">):</span>
        <span class="n">how</span> <span class="o">=</span> <span class="p">[</span><span class="n">itv</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">how</span><span class="p">]</span>

    <span class="c1"># Date iterator</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="n">IterDates</span><span class="p">):</span>
        <span class="n">how</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">IterDates</span><span class="p">]</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;hours since 2000&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">how</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">tminmax</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">how</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">how</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">how</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">how</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># single date</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">how</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span>
                        <span class="n">tmax</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">how</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">how</span> <span class="o">=</span> <span class="p">[</span><span class="n">tmin</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">tmax</span><span class="p">]</span>
            <span class="n">how</span> <span class="o">=</span> <span class="p">[(</span><span class="n">how</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">how</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;co&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">how</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t recognize the split specification&quot;</span>

    <span class="c1"># Checks</span>
    <span class="n">itvs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">how</span><span class="p">:</span>
        <span class="n">itc</span> <span class="o">=</span> <span class="n">itv_intersect</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">tminmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">itc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">itc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">itvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itc</span><span class="p">)</span>
    <span class="n">itvs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">itvs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">bb</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">itvs</span></div>


<div class="viewcode-block" id="time_split_nmax"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.time_split_nmax">[docs]</a><span class="k">def</span> <span class="nf">time_split_nmax</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">roundit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Smartly split an interval with a length into subintervals of max length&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Please provide a time axis, a list of dates, or IterDates or Intervals iterators.&quot;</span>
    <span class="n">ctimes</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctimes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t split a single date&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctimes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ctimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">ctimes</span><span class="p">)</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">how</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">itvs</span> <span class="o">=</span> <span class="n">time_split</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">roundit</span><span class="o">=</span><span class="n">roundit</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">itvs</span><span class="p">:</span>
            <span class="n">ijk</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ijk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ijk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">itvs</span></div>



<div class="viewcode-block" id="itv_intersect"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.itv_intersect">[docs]</a><span class="k">def</span> <span class="nf">itv_intersect</span><span class="p">(</span><span class="n">itv1</span><span class="p">,</span> <span class="n">itv2</span><span class="p">,</span> <span class="n">bb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aslogical</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the intersection of 2 time intervals</span>


<span class="sd">    :Return: The interval or ``False`` if not intersection is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check bounds</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="s1">&#39;cc&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itv1</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="s1">&#39;cc&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itv2</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Comptime</span>
    <span class="n">itv1</span> <span class="o">=</span> <span class="p">[</span><span class="n">comptime</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itv1</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">itv2</span> <span class="o">=</span> <span class="p">[</span><span class="n">comptime</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itv2</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;hours since 2000&#39;</span>

    <span class="c1"># Min</span>
    <span class="n">bbi</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">b2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">bbi</span> <span class="k">else</span> <span class="s1">&#39;o&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">imin</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="n">bbi</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>

    <span class="c1"># Max</span>
    <span class="n">bbi</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">b2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">itv</span> <span class="o">+=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">bbi</span> <span class="k">else</span> <span class="s1">&#39;o&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">itv</span> <span class="o">+=</span> <span class="p">(</span><span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">imax</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">+=</span> <span class="n">bbi</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">bbo</span>

    <span class="c1"># Check</span>
    <span class="k">if</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
            <span class="ow">and</span> <span class="s1">&#39;o&#39;</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">aslogical</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">itv</span><span class="o">+</span><span class="p">(</span><span class="n">bb</span><span class="p">,))</span> <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">itv</span></div>


<div class="viewcode-block" id="itv_union"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.itv_union">[docs]</a><span class="k">def</span> <span class="nf">itv_union</span><span class="p">(</span><span class="n">itv1</span><span class="p">,</span> <span class="n">itv2</span><span class="p">,</span> <span class="n">bb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the union of 2 time intervals&quot;&quot;&quot;</span>

    <span class="c1"># Check bounds</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="s1">&#39;cc&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itv1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="s1">&#39;cc&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itv2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="s1">&#39;hours since 2000&#39;</span>

    <span class="c1"># Comptime</span>
    <span class="n">itv1</span> <span class="o">=</span> <span class="p">[</span><span class="n">comptime</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itv1</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">itv2</span> <span class="o">=</span> <span class="p">[</span><span class="n">comptime</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itv2</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>


    <span class="c1"># Min</span>
    <span class="n">bbi</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">b2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">bbi</span> <span class="k">else</span> <span class="s1">&#39;o&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">imin</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="n">bbi</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>

    <span class="c1"># Max</span>
    <span class="n">bbi</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">b2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">itv</span> <span class="o">+=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">bbi</span> <span class="k">else</span> <span class="s1">&#39;o&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tu</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">itv</span> <span class="o">+=</span> <span class="p">(</span><span class="n">itv1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">itv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">imax</span><span class="p">],</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="p">:</span> <span class="n">bbo</span> <span class="o">+=</span> <span class="n">bbi</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">bbo</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">itv</span><span class="o">+</span><span class="p">(</span><span class="n">bb</span><span class="p">,))</span> <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">itv</span></div>


<span class="k">class</span> <span class="nc">_LH_</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To handle argument and result possibily as a list or tuple&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myarg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">myarg</span> <span class="o">=</span> <span class="n">myarg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="o">=</span> <span class="nb">list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="o">=</span> <span class="nb">tuple</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">myarg</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">myarg</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="o">=</span> <span class="nb">list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">myarg</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get input argument as a list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get output argument as original type&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listtype</span> <span class="ow">is</span> <span class="n">func</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_d2sel_</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">dsel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract time selections from a dict&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">sel</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">sel</span> <span class="ow">in</span> <span class="n">dsel</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">taxis</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">+</span><span class="n">cdms2</span><span class="o">.</span><span class="n">convention</span><span class="o">.</span><span class="n">time_aliases</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">sel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">tsel2slice_old</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert time selections on a time axis to a valid slice or None</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **asind**, optional: Return indices instead of a slice.</span>
<span class="sd">        - **nonone**, optional: Return the full slice instead of ``None`` if everything is selected.</span>
<span class="sd">        - Positional argument can be coordinates intervals, slices,</span>
<span class="sd">          dictionaries or cdms2 selectors.</span>
<span class="sd">        - Optional arguments must have a key identified as time or be the axis id,</span>
<span class="sd">          and a value as coordinates or slice.</span>

<span class="sd">    :Return:</span>

<span class="sd">        - A :class:`slice` or ``(i,j,k)`` when possible.</span>
<span class="sd">        - ``None`` or the full slice if no slice needed (everything is selected).</span>
<span class="sd">        - ``False`` if no intersection is found.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, (&#39;2000&#39;, &#39;2002&#39;, &#39;co&#39;), time=slice(4,6))</span>
<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, cdms2.selectors.Selector(lon=(5,6), time=(&#39;2000&#39;,&#39;2002&#39;))</span>
<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, slice(10,12), dict(time=slice(4,5), time=(&#39;2000&#39;,&#39;2002&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Inits</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">istime</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span> <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;taxis must be a valid time axis&#39;</span><span class="p">)</span>
    <span class="n">asind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;asind&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">nonone</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nonone&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">fullslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)))</span>

    <span class="c1"># Convert to list of tuples or slices</span>
    <span class="n">selects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ntup</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">selectors</span><span class="o">.</span><span class="n">Selector</span><span class="p">):</span>
            <span class="n">psel</span><span class="p">,</span> <span class="n">asel</span> <span class="o">=</span> <span class="n">split_selector</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">selects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_d2sel_</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">asel</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">selects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_d2sel_</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">==</span><span class="s1">&#39;:&#39;</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
                <span class="n">ntup</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">arg</span><span class="p">,</span><span class="s1">&#39;ccb&#39;</span><span class="p">)</span>
            <span class="n">selects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">selects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_d2sel_</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selects</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">asind</span><span class="p">:</span> <span class="n">fullslice</span> <span class="o">=</span> <span class="n">fullslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="n">fullslice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="n">fullslice</span><span class="o">.</span><span class="n">step</span>
        <span class="k">return</span> <span class="n">fullslice</span> <span class="k">if</span> <span class="n">nonone</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Apply successive selections</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">isel</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selects</span><span class="p">):</span>

        <span class="c1"># From coordinates to slice</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">ijk</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">ijk</span><span class="p">)</span>

        <span class="c1"># Work on indices</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Subaxis for future use</span>
        <span class="k">if</span> <span class="n">ntup</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="n">taxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">subAxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Deduce final indices</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonone</span> <span class="ow">and</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">==</span><span class="n">fullslice</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">asind</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>

<div class="viewcode-block" id="time_selector"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.time_selector">[docs]</a><span class="k">def</span> <span class="nf">time_selector</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Time selector formatter that returns start date and end date as component times</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; selector(&#39;2006&#39;,&#39;2007&#39;) # between two dates</span>
<span class="sd">        &gt;&gt;&gt; selector(comptime(1950)) # from a date to now</span>
<span class="sd">        &gt;&gt;&gt; selector(1,&#39;month&#39;,&#39;co&#39;) # from now into the past</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Interval</span>
    <span class="k">if</span> <span class="n">arg1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># from a date to now</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">comptime</span><span class="p">(</span><span class="n">arg0</span><span class="p">),</span> <span class="n">now</span><span class="p">(</span><span class="n">utc</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">arg0</span><span class="p">):</span> <span class="c1"># from now into the past</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">now</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_time</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="o">-</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">),</span> <span class="n">nn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># between two dates</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">comptime</span><span class="p">(</span><span class="n">arg0</span><span class="p">),</span> <span class="n">comptime</span><span class="p">(</span><span class="n">arg1</span><span class="p">))</span>

    <span class="c1"># Bounds</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">selection</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">selection</span></div>



<div class="viewcode-block" id="filter_time_selector"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.filter_time_selector">[docs]</a><span class="k">def</span> <span class="nf">filter_time_selector</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a pure time selector from all arguments</span>

<span class="sd">    All components that are not recognized as a time selection are not kept.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **ids**, optional: Special keyword to specify allowed time ids in addition</span>
<span class="sd">          to generic ones defined by :attr:`cdms2.convention.time_aliases`.</span>
<span class="sd">        - **out**, optional: Inverse the process by removing all time selections</span>
<span class="sd">          (see :func:`~vacumm.misc.misc.filter_selector`)?</span>
<span class="sd">        - **keeppos**, optional: Remove positional components</span>
<span class="sd">          (see :func:`~vacumm.misc.misc.filter_selector`)?</span>
<span class="sd">        - **noslice**, optional: Remove slices</span>
<span class="sd">          (see :func:`~vacumm.misc.misc.filter_selector`)?</span>
<span class="sd">        - Positional argument can be coordinates intervals, slices,</span>
<span class="sd">          dictionaries or cdms2 selectors.</span>
<span class="sd">        - Optional arguments must have a key identified as time,</span>
<span class="sd">          and a value as coordinates or slice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Valid ids for filtering</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">keeppos</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keeppos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cdms2</span><span class="o">.</span><span class="n">convention</span><span class="o">.</span><span class="n">time_aliases</span>

    <span class="c1"># Build the selector using refinements</span>
    <span class="n">newargs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">selectors</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">selector</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Filter</span>
    <span class="n">filter_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">keeppos</span><span class="o">=</span><span class="n">keeppos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">selector</span></div>

<span class="n">selector</span> <span class="o">=</span> <span class="n">filter_time_selector</span>

<div class="viewcode-block" id="tsel2slice"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.tsel2slice">[docs]</a><span class="k">def</span> <span class="nf">tsel2slice</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert time selections on a time axis to a valid slice or None</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **asind**, optional: Return indices instead of a slice.</span>
<span class="sd">        - **nonone**, optional: Return the full slice instead of ``None`` if everything is selected.</span>
<span class="sd">        - Positional argument can be coordinates intervals, slices,</span>
<span class="sd">          dictionaries or cdms2 selectors.</span>
<span class="sd">        - Optional arguments must have a key identified as time or be the axis id,</span>
<span class="sd">          and a value as coordinates or slice.</span>

<span class="sd">    :Return:</span>

<span class="sd">        - A :class:`slice` or ``(i,j,k)`` when possible.</span>
<span class="sd">        - ``None`` or the full slice if no slice needed (everything is selected).</span>
<span class="sd">        - ``False`` if no intersection is found.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, (&#39;2000&#39;, &#39;2002&#39;, &#39;co&#39;), time=slice(4,6))</span>
<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, cdms2.selectors.Selector(lon=(5,6), time=(&#39;2000&#39;,&#39;2002&#39;))</span>
<span class="sd">        &gt;&gt;&gt; myslice = tsel2slice(taxis, slice(10,12), dict(time=slice(4,5), time=(&#39;2000&#39;,&#39;2002&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Inits</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">istime</span><span class="p">(</span><span class="n">taxis</span><span class="p">):</span> <span class="k">raise</span> <span class="n">VACUMMError</span><span class="p">(</span><span class="s1">&#39;taxis must be a valid time axis&#39;</span><span class="p">)</span>
    <span class="n">asind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;asind&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">nonone</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nonone&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">fullslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)))</span>

    <span class="c1"># Convert to list valid time selector</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">taxis</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">filter_time_selector</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># No selection</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">components</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">asind</span><span class="p">:</span> <span class="n">fullslice</span> <span class="o">=</span> <span class="n">fullslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="n">fullslice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="n">fullslice</span><span class="o">.</span><span class="n">step</span>
        <span class="k">return</span> <span class="n">fullslice</span> <span class="k">if</span> <span class="n">nonone</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Select</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">))</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">taxis</span><span class="o">.</span><span class="n">designateTime</span><span class="p">()</span>
    <span class="n">ii</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">taxis</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Deduce final indices</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonone</span> <span class="ow">and</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">==</span><span class="n">fullslice</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">asind</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="tic"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.tic">[docs]</a><span class="k">def</span> <span class="nf">tic</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Launch a time counter at the begining of your program.</span>


<span class="sd">    :Return:</span>

<span class="sd">        - A time to be used with the toc() function.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; stime = tic()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">tc</span>
    <span class="n">stime</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="nb">print</span> <span class="n">tc</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stime</span></div>

<div class="viewcode-block" id="toc"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.toc">[docs]</a><span class="k">def</span> <span class="nf">toc</span><span class="p">(</span><span class="n">stime</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the cost of the computation and display in an adapted format.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **stime**, optional: The initial time given by the tic() function.</span>

<span class="sd">    :Return:</span>

<span class="sd">        - Display the time spent in the program.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        &gt;&gt;&gt; stime = tic()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; toc(stime=stime)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">tc</span>
    <span class="c1"># print tc.asctime()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mi">3600</span><span class="p">),</span> <span class="s2">&quot;hours&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span> <span class="s2">&quot; minutes&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">tc</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span></div>


<div class="viewcode-block" id="interp_clim"><a class="viewcode-back" href="../../../library/misc.atime.html#vacumm.misc.atime.interp_clim">[docs]</a><span class="k">def</span> <span class="nf">interp_clim</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interpolate a climatology at specified dates&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.grid.regridding</span> <span class="k">import</span> <span class="n">regrid1d</span><span class="p">,</span> <span class="n">extend1d</span>
    <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">taxis</span><span class="p">[:])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="s1">&#39;Output times must be monotonically increasing&#39;</span>
    <span class="k">assert</span> <span class="n">clim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span>
    <span class="n">ctimes</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="n">months</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ct</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctimes</span><span class="p">])</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctimes</span><span class="p">])</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">clim</span><span class="p">)</span>
    <span class="n">cmonths</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="n">cyears</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">12</span>

    <span class="n">left_extent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">right_extent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">left_extent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">months</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
        <span class="n">right_extent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">months</span><span class="o">==</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">months</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">left_extent</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">months</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">left_extent</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">months</span><span class="o">==</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">right_extent</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">months</span><span class="o">==</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">right_extent</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">left_extent</span> <span class="ow">or</span> <span class="n">right_extent</span><span class="p">:</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">extend1d</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="n">left_extent</span><span class="p">,</span> <span class="n">right_extent</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cylic&#39;</span><span class="p">)</span>
        <span class="n">cmonths</span> <span class="o">=</span> <span class="n">cmonths</span><span class="p">[</span><span class="mi">12</span><span class="o">-</span><span class="n">left_extent</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cmonths</span> <span class="o">+</span> <span class="n">cmonths</span><span class="p">[:</span><span class="n">right_extent</span><span class="p">]</span>
        <span class="n">cyears</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">left_extent</span> <span class="o">+</span> <span class="n">cyears</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">right_extent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">old_clim_taxis</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">climo</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">),</span> <span class="p">)</span><span class="o">+</span><span class="n">clim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">N</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">years</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">((</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;co&#39;</span><span class="p">))</span>
        <span class="n">year_axis</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">([</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">year</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cyears</span><span class="p">,</span> <span class="n">cmonths</span><span class="p">)])</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">year_axis</span><span class="p">)</span>
        <span class="n">climo</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">regrid1d</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="n">taxis</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">left_extent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">right_extent</span><span class="p">:</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">old_clim_taxis</span><span class="p">)</span>
    <span class="n">climo</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="n">taxis</span><span class="p">]</span><span class="o">+</span><span class="n">clim</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">climo</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">set_atts</span><span class="p">(</span><span class="n">climo</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">climo</span></div>





<span class="c1">#####################################################################</span>
<span class="c1">######################################################################</span>

<span class="kn">import</span> <span class="nn">grid</span> <span class="k">as</span> <span class="nn">G</span>
<span class="kn">from</span> <span class="nn">.axes</span> <span class="k">import</span> <span class="n">istime</span><span class="p">,</span><span class="n">check_axes</span><span class="p">,</span><span class="n">check_axis</span><span class="p">,</span><span class="n">create_time</span><span class="p">,</span> <span class="n">isaxis</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="k">import</span> <span class="p">(</span><span class="n">cp_atts</span><span class="p">,</span><span class="n">isnumber</span><span class="p">,</span><span class="n">kwfilter</span><span class="p">,</span><span class="n">split_selector</span><span class="p">,</span> <span class="n">filter_selector</span><span class="p">,</span>
    <span class="n">get_atts</span><span class="p">,</span> <span class="n">set_atts</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">vacumm</span> <span class="k">import</span> <span class="n">VACUMMError</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../vacumm.html" >vacumm</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>