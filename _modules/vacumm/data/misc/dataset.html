
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.data.misc.dataset &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../../index.html"><img src="../../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../data.html" accesskey="U">vacumm.data</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.data.misc.dataset</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2017)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># TODO:</span>
<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1"># - Move variable mapping feature from data.misc.profile to this module</span>
<span class="c1"># - Determine reference/run date from Catalog datasets, sort the loaded dataset,</span>
<span class="c1">#   move dataset aggregation over time into the Catalog class)</span>
<span class="c1"># - Add an interface (class) defining the root base feature of a Dataset</span>
<span class="c1">#   (aggregation using catalog, get_[time,depth,latitude,longitude,variable], get_grid, ...)</span>
<span class="c1">#   to provide a data format abstraction base.</span>
<span class="c1"># - Ensure compatibilty of possibly different axes coordinates (lat, lon, sigma, depths, ...)</span>
<span class="c1">#   over multiple dataset (e.g. about sigma: user.algo.readers.html)</span>
<span class="c1"># - Force variables order in dedicated data loaders (get_section, get_hovmoller, ...)</span>
<span class="c1">#</span>
<span class="c1"># - Check why</span>
<span class="c1">#     vacumm.misc.io.NcIterBestEstimate(files = [...],time = (..., &#39;co&#39;))</span>
<span class="c1">#   produces empty slices (e.g slice(14,2)), but doesnt if &#39;ccb&#39; is used</span>
<span class="c1"># ==============================================================================</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Jonathan Wilkins&#39;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s1">&#39;wilkins@actimar.fr&#39;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s1">&#39;2011-01-17&#39;</span>
<span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;Common dataset utilities&#39;</span>


<span class="c1"># ==============================================================================</span>


<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="k">import</span> <span class="n">format_exc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">cdms2</span><span class="o">,</span> <span class="nn">MV2</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">pylab</span><span class="o">,</span> <span class="nn">seawater</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="k">import</span> <span class="n">colorbar</span><span class="p">,</span> <span class="n">tight_layout</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">numpy</span>

<span class="kn">from</span> <span class="nn">vacumm.misc</span> <span class="k">import</span> <span class="n">auto_scale</span><span class="p">,</span> <span class="n">MV2_concatenate</span><span class="p">,</span> <span class="n">MV2_axisConcatenate</span><span class="p">,</span> <span class="n">create_selector</span><span class="p">,</span> \
    <span class="n">split_selector</span><span class="p">,</span> <span class="n">dict_merge</span><span class="p">,</span> <span class="n">dict_check_defaults</span><span class="p">,</span> <span class="n">set_atts</span><span class="p">,</span> <span class="n">broadcast</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">add</span> <span class="k">as</span> <span class="n">add_time</span><span class="p">,</span> <span class="n">comptime</span><span class="p">,</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">adatetime</span><span class="p">,</span> <span class="n">Intervals</span><span class="p">,</span> \
    <span class="n">filter_time_selector</span><span class="p">,</span> <span class="n">itv_intersect</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.axes</span> <span class="k">import</span> <span class="n">create_time</span><span class="p">,</span> <span class="n">create_dep</span><span class="p">,</span> <span class="n">create_lat</span><span class="p">,</span> <span class="n">create_lon</span><span class="p">,</span> <span class="n">guess_timeid</span><span class="p">,</span> <span class="n">get_axis_type</span><span class="p">,</span> <span class="n">isaxis</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.bases</span> <span class="k">import</span> <span class="n">Object</span>
<span class="kn">import</span> <span class="nn">vacumm.misc.color</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.io</span> <span class="k">import</span> <span class="p">(</span><span class="n">ncget_var</span><span class="p">,</span> <span class="n">ncfind_var</span><span class="p">,</span> <span class="n">ncfind_obj</span><span class="p">,</span> <span class="n">ncfind_axis</span><span class="p">,</span>
    <span class="n">list_forecast_files</span><span class="p">,</span> <span class="n">ncread_files</span><span class="p">,</span> <span class="n">ncmatch_obj</span><span class="p">,</span>
    <span class="n">ncread_best_estimate</span><span class="p">,</span> <span class="n">NcIterBestEstimate</span><span class="p">,</span> <span class="n">ncget_time</span><span class="p">,</span> <span class="n">ncget_lon</span><span class="p">,</span> <span class="n">ncget_lat</span><span class="p">,</span> <span class="n">ncget_level</span><span class="p">,</span>
    <span class="n">ncget_grid</span><span class="p">,</span> <span class="n">ncget_axis</span><span class="p">,</span> <span class="n">NcIterTimeSlice</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.misc</span> <span class="k">import</span> <span class="n">meshweights</span><span class="p">,</span> <span class="n">resol</span><span class="p">,</span> <span class="n">create_grid</span><span class="p">,</span> <span class="n">set_grid</span><span class="p">,</span> \
    <span class="n">dz2depth</span><span class="p">,</span> <span class="n">depth2dz</span><span class="p">,</span> <span class="n">isdepthup</span><span class="p">,</span> <span class="n">gridsel</span><span class="p">,</span> <span class="n">makedepthup</span><span class="p">,</span> <span class="n">curv2rect</span><span class="p">,</span> <span class="n">isgrid</span><span class="p">,</span>  \
    <span class="n">coord2slice</span><span class="p">,</span> <span class="n">clone_grid</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.regridding</span> <span class="k">import</span> <span class="n">resol</span><span class="p">,</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">regrid1d</span><span class="p">,</span> <span class="n">grid2xy</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span>  \
    <span class="n">shift1d</span><span class="p">,</span> <span class="n">shift2d</span><span class="p">,</span> <span class="n">extend1d</span><span class="p">,</span> <span class="n">extend2d</span><span class="p">,</span> <span class="n">regrid1dold</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.misc</span> <span class="k">import</span> <span class="n">is_iterable</span><span class="p">,</span> <span class="n">kwfilter</span><span class="p">,</span> <span class="n">squeeze_variable</span><span class="p">,</span> <span class="n">dict_filter_out</span><span class="p">,</span>  \
    <span class="n">get_atts</span><span class="p">,</span> <span class="n">set_atts</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.phys.constants</span> <span class="k">import</span> <span class="n">GRAVITY</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.plot</span> <span class="k">import</span> <span class="n">map2</span><span class="p">,</span> <span class="n">curve2</span><span class="p">,</span> <span class="n">section2</span><span class="p">,</span> <span class="n">hov2</span><span class="p">,</span> <span class="n">add_map_lines</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.axes</span> <span class="k">import</span> <span class="n">islon</span><span class="p">,</span> <span class="n">islat</span><span class="p">,</span> <span class="n">isdep</span>
<span class="kn">from</span> <span class="nn">vacumm.data</span> <span class="k">import</span> <span class="n">register_dataset</span>
<span class="kn">from</span> <span class="nn">vacumm.data.misc.sigma</span> <span class="k">import</span> <span class="n">NcSigma</span>
<span class="kn">from</span> <span class="nn">vacumm.data.misc.arakawa</span> <span class="k">import</span> <span class="n">ArakawaGrid</span><span class="p">,</span> <span class="n">AGrid</span><span class="p">,</span> <span class="n">CGrid</span><span class="p">,</span> <span class="n">ARAKAWA_LOCATIONS</span> <span class="k">as</span> <span class="n">arakawa_locations</span><span class="p">,</span>  \
    <span class="n">set_grid_type</span><span class="p">,</span> <span class="n">get_grid_type</span><span class="p">,</span> <span class="n">_cdms2_atts</span> <span class="k">as</span> <span class="n">cdms2_arakawa_atts</span>
<span class="kn">from</span> <span class="nn">vacumm.data.cf</span> <span class="k">import</span> <span class="p">(</span><span class="n">VAR_SPECS</span><span class="p">,</span> <span class="n">AXIS_SPECS</span><span class="p">,</span> <span class="n">cf2search</span><span class="p">,</span> <span class="n">cf2atts</span><span class="p">,</span>
    <span class="n">CF_AXIS_SPECS</span><span class="p">,</span> <span class="n">CF_VAR_SPECS</span><span class="p">,</span> <span class="n">format_axis</span><span class="p">,</span> <span class="n">format_var</span><span class="p">,</span> <span class="n">get_loc</span><span class="p">,</span> <span class="n">no_loc_single</span><span class="p">,</span>
    <span class="n">DEFAULT_LOCATION</span><span class="p">,</span> <span class="n">change_loc</span><span class="p">,</span> <span class="n">HIDDEN_CF_ATTS</span><span class="p">,</span> <span class="n">change_loc_single</span><span class="p">,</span> <span class="n">format_grid</span><span class="p">,</span>
    <span class="n">CF_DICT_MERGE_KWARGS</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">vacumm</span> <span class="k">import</span> <span class="n">VACUMMError</span>
<span class="kn">from</span> <span class="nn">vacumm.diag.dynamics</span> <span class="k">import</span> <span class="n">barotropic_geostrophic_velocity</span><span class="p">,</span> <span class="n">kinetic_energy</span>
<span class="kn">from</span> <span class="nn">vacumm.diag.thermdyn</span> <span class="k">import</span> <span class="n">mixed_layer_depth</span><span class="p">,</span> <span class="n">density</span>

<span class="kn">from</span> <span class="nn">vacumm.misc.misc</span> <span class="k">import</span> <span class="n">grow_variables</span>

<span class="c1"># Kwargs which are pop&#39;ed from intermediate plots</span>
<span class="c1"># (e.g. plot section, then trajectory map, then post plot using these kwargs)</span>
<span class="n">POST_PLOT_ARGS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;savefig&#39;</span><span class="p">,</span> <span class="s1">&#39;savefigs&#39;</span><span class="p">)</span>
<span class="n">post_plot_args</span> <span class="o">=</span> <span class="n">POST_PLOT_ARGS</span> <span class="c1"># compat</span>

<span class="n">_geonames</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">}</span>


<span class="c1">############################################################################</span>
<span class="c1">###  AUTO-GENERATION AND AUTO-FORMATTING OF CODE</span>
<span class="c1">############################################################################</span>

<span class="k">def</span> <span class="nf">_get_var_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to be used as a method for getting variables at a specific location</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **name**: Generic name.</span>
<span class="sd">        - Extra keywords are passed to :method:`Dataset.get_variable`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">warn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">gname</span> <span class="o">=</span> <span class="n">no_loc_single</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">ploc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;physloc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid_type</span><span class="p">:</span> <span class="n">ploc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># From variable (no interpolation at all, just search for names)</span>
    <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

        <span class="c1"># Direct try</span>
        <span class="n">var</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># No location info -&gt; generic search allowed</span>
        <span class="k">if</span> <span class="n">gname</span><span class="o">!=</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ploc</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1">#&#39;usurf_u&#39; = &#39;usurf&#39;</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># Generic name -&gt; search at physical location only (U at &#39;_u&#39;)</span>
        <span class="k">elif</span> <span class="n">gname</span><span class="o">==</span><span class="n">name</span> <span class="ow">and</span> <span class="n">ploc</span><span class="p">:</span>
            <span class="n">pname</span> <span class="o">=</span> <span class="n">change_loc_single</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">ploc</span><span class="p">)</span> <span class="c1"># &#39;usurf&#39; -&gt; &#39;usurf_u&#39;</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># We failed</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get </span><span class="si">%(name)s</span><span class="s2"> from file&quot;</span><span class="o">%</span><span class="nb">locals</span><span class="p">())</span>
            <span class="k">return</span>

    <span class="c1"># Get it from other locations</span>
    <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;stag&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">toloc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">toloc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">toloc</span> <span class="o">=</span> <span class="n">get_loc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_LOCATION</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arakawa_locations</span><span class="p">)</span>
        <span class="n">locations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">toloc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ploc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ploc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span> <span class="n">locations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ploc</span><span class="p">)</span>
            <span class="n">locations</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ploc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fromloc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span> <span class="c1">#TODO: arakawa: clever order for loc2loc tries (use closer neighbours)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">change_loc_single</span><span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">fromloc</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">toloc</span><span class="p">,</span> <span class="n">at_fromloc</span><span class="o">=</span><span class="n">fromloc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>

        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;stag&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get </span><span class="si">%(name)s</span><span class="s2"> from any locations&quot;</span><span class="o">%</span><span class="nb">locals</span><span class="p">())</span>
            <span class="k">return</span>

    <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get </span><span class="si">%(name)s</span><span class="s2"> in any way&quot;</span><span class="o">%</span><span class="nb">locals</span><span class="p">())</span>


<span class="n">getvar_decmet_tpl</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;def get_var(self, **kwargs):</span>
<span class="s2">    return _get_var_(self, &#39;</span><span class="si">%(name)s</span><span class="s2">&#39;, **kwargs)&quot;&quot;&quot;</span>


<div class="viewcode-block" id="getvar_decmets"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.getvar_decmets">[docs]</a><span class="k">def</span> <span class="nf">getvar_decmets</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate methods such as :meth:`get_sst` based on the :attr:`auto_generic_var_names`</span>
<span class="sd">    attributes that provides a list of generic names of variables</span>

<span class="sd">    These generic names must be the keys of :mod:`vacumm.data.cf.GENERIC_VAR_SPECS`.</span>
<span class="sd">    The docstring of the each method is formatted using :func:`getvar_fmtdoc`.</span>

<span class="sd">    Methods that already exist are not overwritten.</span>

<span class="sd">    When a generic name does not start with a &quot;+&quot;, its name appended with</span>
<span class="sd">    a location suffix (&#39;_t&#39;, &#39;_u&#39;, &#39;_v&#39;, &#39;_w&#39;, &#39;_f&#39;) is also treated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the basic list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;auto_generic_var_names&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">cls</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">auto_generic_var_names</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">auto_generic_var_names</span><span class="p">]</span>

    <span class="c1"># Add names for other positions (u, v, etc) if available.</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">auto_generic_var_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">continue</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">arakawa_locations</span><span class="p">:</span> <span class="c1">#&#39;u&#39;, &#39;v&#39;, &#39;w&#39;, &#39;f&#39;:</span>
            <span class="n">namep</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">p</span>
            <span class="k">if</span> <span class="n">namep</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namep</span><span class="p">)</span>

    <span class="c1"># Declarations</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

        <span class="c1"># Check existence</span>
        <span class="n">metname</span> <span class="o">=</span> <span class="s2">&quot;get_&quot;</span><span class="o">+</span><span class="n">name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">metname</span><span class="p">):</span> <span class="k">continue</span>

        <span class="c1"># Declare the method</span>
        <span class="n">exec</span> <span class="n">getvar_decmet_tpl</span><span class="o">%</span><span class="nb">locals</span><span class="p">()</span>

        <span class="c1"># Change its name</span>
        <span class="n">get_var</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">metname</span>

        <span class="c1"># Change its docstring</span>
        <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_var</span><span class="p">)</span>

        <span class="c1"># Attach it to the class</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">get_var</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">get_var</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span></div>




<span class="c1">#: Template for auto formatting methods that get variables (like :meth:`get_sst`)</span>
<span class="n">getvar_fmtdoc_tpl</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">%(func_name)s</span><span class="s2">(time=None, level=None, lat=None, lon=None, squeeze=False, order=None, asvar=None, at=None, format=None, torect=True, verbose=None, warn=None, mode=None, **kwargs)</span>

<span class="s2">    Read the </span><span class="si">%(long_name)s</span><span class="s2"> </span><span class="si">%(units)s</span><span class="s2"></span>

<span class="s2">    :Params:</span>

<span class="s2">        - **time/level/lat/lon**, optional: For selection (tuples or slices).</span>
<span class="s2">        - **squeeze**, optional: Squeeze singleton dimensions</span>
<span class="s2">          (see :func:`~vacumm.misc.misc.squeeze_variable`, like</span>
<span class="s2">          ``True``, ``z`` or ``[&#39;x&#39;,&#39;y&#39;]``).</span>
<span class="s2">        </span><span class="si">%(other_params)s</span><span class="s2">- **asvar**, optional: Grow variable to match the ``asvar`` variable,</span>
<span class="s2">          using :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="s2">        - **asvar**, optional: Reshape as this variable.</span>
<span class="s2">        - **at**, optional: Interpolate to this grid location using</span>
<span class="s2">          :meth:`Datatset.toloc`.</span>
<span class="s2">        - **format**, optional: Format the variable and its axes using</span>
<span class="s2">          :func:`~vacumm.data.cf.format_var`.</span>
<span class="s2">        - **torect**, optional: If possible, convert a curvilinear grid to</span>
<span class="s2">          a rectilinar grid using :func:`~vacumm.misc.grid.regridding.curv2rect`.</span>
<span class="s2">        - **order**, optional: Change order of axes (like ``&#39;xty&#39;``).</span>
<span class="s2">        </span><span class="si">%(kwargs_params)s</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">_default_modes</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Retreiving mode</span>
<span class="s2">            - ``&quot;var&quot;``: Get from netcdf variable only.</span>
<span class="s2">            - ``&quot;stag&quot;``: Get it from another grid location.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="getvar_fmtdoc"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.getvar_fmtdoc">[docs]</a><span class="k">def</span> <span class="nf">getvar_fmtdoc</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format the docstring of methods that get variables</span>

<span class="sd">    It uses the :attr:`getvar_fmtdoc_tpl` template.</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **func**: Method (or function) name that must be in the form ``get_&lt;name&gt;``,</span>
<span class="sd">          where ``&lt;name&gt;`` must be a generic var names in</span>
<span class="sd">          :attr:`vacumm.data.cf.GENERIC_VAR_SPECS`.</span>
<span class="sd">        - Extra keywords define extra options in the docstring.</span>
<span class="sd">          Keys must correspond to a keyword name, and values correspond to a keyword</span>
<span class="sd">          description.</span>

<span class="sd">    :Example:</span>
<span class="sd">        ::</span>

<span class="sd">            # Manual way</span>
<span class="sd">            getvar_fmtdoc(OceanDataset.get_sst, extra_param=&#39;Its description&#39;)</span>

<span class="sd">            # Decorator way</span>
<span class="sd">            @getvar_fmtdoc</span>
<span class="sd">            def get_sst(self, *args, **kwargs):</span>
<span class="sd">                ...</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs_params</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_kwargs&#39;</span><span class="p">,</span> <span class="s2">&quot;Other keywords are passed to :func:`~vacumm.misc.io.ncread_files`.&quot;</span><span class="p">)</span>
    <span class="n">func_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get_&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="n">var_name</span> <span class="o">=</span> <span class="n">func_name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span>


    <span class="c1"># Long name and units</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">long_name</span> <span class="o">=</span> <span class="n">VAR_SPECS</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;long_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">long_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="n">long_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">VAR_SPECS</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot; [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span><span class="n">VAR_SPECS</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Extra keywords</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">_default_modes</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]:</span> <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">other_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span>
        <span class="n">keys</span> <span class="o">=</span>  <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">other_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- **</span><span class="si">%s</span><span class="s1">**, optional: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="n">other_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_params</span><span class="p">)</span><span class="c1">#+&#39;\n&#39;</span>
        <span class="n">other_params</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">other_params</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">kwargs_params</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="o">+</span><span class="n">kwargs_params</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs_params</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Format using template</span>
    <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">getvar_fmtdoc_tpl</span><span class="o">%</span><span class="nb">locals</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">func</span></div>



<span class="c1">############################################################################</span>
<span class="c1">### CATALOG</span>
<span class="c1">############################################################################</span>


<div class="viewcode-block" id="CatalogError"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CatalogError">[docs]</a><span class="k">class</span> <span class="nc">CatalogError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Catalog"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Catalog">[docs]</a><span class="k">class</span> <span class="nc">Catalog</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Build dataset files list based on self.get_config</span>

<span class="sd">    Variables in config (all optionnal):</span>

<span class="sd">        - **files**: explicit list of datasets files</span>
<span class="sd">        - **filepattern** , **time**: see :func:`~vacumm.misc.io.list_forecast_files`</span>

<span class="sd">    These configuration can be passed when creating the Catalog object</span>
<span class="sd">    like any other Object, examples:</span>

<span class="sd">        &gt;&gt;&gt; c = Catalog(config=&#39;configfile.cfg&#39;)</span>
<span class="sd">        &gt;&gt;&gt; c = Catalog(config=dict(files=(&#39;file1.nc&#39;, &#39;file2.nc&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; c = Catalog(config=dict(filepattern=&#39;model_%Y-%m-%d&#39;, time=(&#39;2010-01-01&#39;, &#39;2011-01-01&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; c = Catalog(config=dict(filepattern=&#39;model_%Y-%m-%d&#39;, time=(&#39;2010-01-01&#39;, &#39;2011-01-01&#39;), files=(&#39;file1.nc&#39;, &#39;file2.nc&#39;)))</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filepattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">files</span><span class="p">,</span> <span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Catalog.find_datasets"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Catalog.find_datasets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">find_datasets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform dataset search using :func:`~vacumm.misc.io.list_forecast_files`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Searching datasets using pattern: </span><span class="si">%s</span><span class="s1">, time: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filepattern</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="n">findings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepattern</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">filepattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">filepattern</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepattern</span><span class="p">:</span>
            <span class="n">findings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list_forecast_files</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%s</span><span class="s1"> datasets&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">findings</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">findings</span></div>

<div class="viewcode-block" id="Catalog.get_datasets"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Catalog.get_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">get_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the logical view of datasets.</span>

<span class="sd">        Datasets are specified by this object configuration (:meth:`~vacumm.misc.bases.Object.get_config`) using:</span>
<span class="sd">            - files: use files specified directly</span>
<span class="sd">            - filepattern and time: perform dataset search using :func:`~find_datasets`</span>

<span class="sd">        :Return:</span>
<span class="sd">            - List of strings, the dataset files found</span>

<span class="sd">        .. todo::</span>
<span class="sd">            - Ensure returned dataset order (by (run)date)</span>
<span class="sd">            - Add a tutorial about :class:`Catalog`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepattern</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
            <span class="n">datasets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">datasets</span></div></div>

<span class="c1">############################################################################</span>
<span class="c1">### BASES</span>
<span class="c1">############################################################################</span>

<div class="viewcode-block" id="DatasetError"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.DatasetError">[docs]</a><span class="k">class</span> <span class="nc">DatasetError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Dataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic dataset representation.</span>

<span class="sd">    Handle multiple datasets (files) in a best time serie view.</span>

<span class="sd">    Variables specifications are stored in :attr:`ncobj_specs`.</span>
<span class="sd">    This global attribute must be refined for all new dataset.</span>

<span class="sd">    .. attribute:: ncobj_specs</span>

<span class="sd">        Dictionary describing variable specifications: final id</span>
<span class="sd">        of the variable as the keys, and aliases ad slice as the content.</span>
<span class="sd">        Here is an example::</span>

<span class="sd">            ncobj_specs = {</span>
<span class="sd">                &#39;u10m&#39;:dict(</span>
<span class="sd">                    search=dict(id=[&#39;u&#39;, &#39;u10&#39;, &#39;uwind&#39;, &#39;.*u.*&#39;]),</span>
<span class="sd">                    select=(Ellipsis, 0)),</span>
<span class="sd">                &#39;sst&#39;:dict(</span>
<span class="sd">                    search=dict(standard_name=&quot;sea_surface_temperature&quot;),</span>
<span class="sd">                    select=(Ellipsis, -1)),</span>
<span class="sd">                    atts=dict(units=&quot;DegC&quot;),</span>
<span class="sd">            }</span>

<span class="sd">    :Params:</span>
<span class="sd">        - **dataset**: A dataset or list of dataset (see :meth:`load_dataset`).</span>
<span class="sd">          Argument to are either a :class:`Catalog` instance, or compatible with</span>
<span class="sd">          :func:`~vacumm.misc.io.list_forecast_files`. In this latter case,</span>
<span class="sd">          please read the documentation of this function carefully.</span>
<span class="sd">        - **select**: A selector to be applied by default.</span>
<span class="sd">        - **time**: Time for searching files (see :func:`~vacumm.misc.io.list_forecast_files`)</span>
<span class="sd">          which overwrites configuration.</span>
<span class="sd">        - **sort/nopat/patfreq/patfmtfunc/check**, optional: These arguments are passed to</span>
<span class="sd">          :func:`~vacumm.misc.io.list_forecast_files`.</span>
<span class="sd">        - Extra keywords are passed to Object.__init__, you may then pass a</span>
<span class="sd">          config filepath/dict/ConfigObj.</span>

<span class="sd">    :See also: :ref:`user.desc.dataset`.</span>

<span class="sd">    :Examples:</span>

<span class="sd">        Classical cases:</span>

<span class="sd">        &gt;&gt;&gt; d = Dataset(&quot;mars.*.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; d = Dataset(&quot;mars.%Y%m%d%H00.nc&quot;, time=(&#39;2000&#39;,&#39;2000-02-15&#39;))</span>
<span class="sd">        &gt;&gt;&gt; d = Dataset([&#39;file1.nc&#39;, &#39;file2.nc&#39;])</span>
<span class="sd">        &gt;&gt;&gt; d = Dataset(&#39;http://opendap.net/mars.nc&#39;)</span>

<span class="sd">        With :meth:`load_dataset`:</span>

<span class="sd">        &gt;&gt;&gt; d = Dataset()</span>
<span class="sd">        &gt;&gt;&gt; d.load_dataset(&#39;file1.nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; d.load_dataset([&#39;file2.nc&#39;, &#39;file3.nc&#39;], append=True)</span>

<span class="sd">        Is equivalent to:</span>

<span class="sd">        &gt;&gt;&gt; d = Dataset([&#39;file1.nc&#39;, &#39;file2.nc&#39;, &#39;file3.nc&#39;])</span>


<span class="sd">        Another example using configuration:</span>

<span class="sd">        &gt;&gt;&gt; d = Dataset(config=&#39;dataset.cfg&#39;)</span>

<span class="sd">        With configuration file &#39;dataset.cfg&#39;:</span>
<span class="sd">            [Dataset]</span>
<span class="sd">                [[Catalog]]</span>
<span class="sd">                    files = &#39;file1.nc&#39;, &#39;file2.nc&#39;, &#39;file3.nc&#39;</span>

<span class="sd">        .. note::</span>
<span class="sd">            For a subclass of Dataset, say for example MyModel, the configuration would be:</span>
<span class="sd">                [MyModel]</span>
<span class="sd">                    [[Catalog]]</span>
<span class="sd">                        files = &#39;file1.nc&#39;, &#39;file2.nc&#39;, &#39;file3.nc&#39;</span>

<span class="sd">     :Attributes:</span>


<span class="sd">        .. attribute:: selector</span>

<span class="sd">            A :class:`cdms2.selectors.Selector` created at initialization time.</span>

<span class="sd">        .. attribute:: selects</span>

<span class="sd">            Same as :attr:`selector` but as dictionary.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#: Arakawa grid type (see :mod:`vacumm.data.misc.arakawa`)</span>
    <span class="n">arakawa_grid_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;corio&#39;</span><span class="p">]</span>

    <span class="n">ncobj_specs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ncobj_specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nopat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patfmtfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Load dataset</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_selects_</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sselects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sselector</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sselects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="o">=</span> <span class="n">squeeze</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">nopat</span><span class="o">=</span><span class="n">nopat</span><span class="p">,</span> <span class="n">patfreq</span><span class="o">=</span><span class="n">patfreq</span><span class="p">,</span>
            <span class="n">patfmtfunc</span><span class="o">=</span><span class="n">patfmtfunc</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nibeid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="c1"># IterBestEstimate id</span>

        <span class="c1"># Arakawa grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid</span> <span class="o">=</span> <span class="n">ArakawaGrid</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid_type</span><span class="p">)</span>

        <span class="c1"># Load specs of variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ncobj_specs_</span><span class="p">(</span><span class="n">ncobj_specs</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_parse_selects_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_load_ncobj_specs_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncobj_specs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the :attr:`ncobj_specs` attribute and reformat it&quot;&quot;&quot;</span>
        <span class="c1"># Get specs</span>
        <span class="k">if</span> <span class="n">ncobj_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncobj_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncobj_specs</span> <span class="c1"># local</span>
            <span class="n">ncobj_specs</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">ncobj_specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherited_ncobj_specs_</span><span class="p">(),</span>
                                     <span class="o">**</span><span class="n">CF_DICT_MERGE_KWARGS</span><span class="p">)</span> <span class="c1"># inherited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncobj_specs</span> <span class="o">=</span> <span class="n">ncobj_specs</span> <span class="c1"># set it</span>

        <span class="c1"># Loop on variables to format their specs</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">specs</span> <span class="ow">in</span> <span class="n">ncobj_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_single_ncobj_specs_</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_inherited_ncobj_specs_</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get merged specs from current and parent classes&quot;&quot;&quot;</span>
        <span class="n">ncobj_specs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;ncobj_specs&#39;</span><span class="p">):</span>
                <span class="n">ncobj_specs</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">ncobj_specs</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_inherited_ncobj_specs_</span><span class="p">(),</span>
                                         <span class="o">**</span><span class="n">CF_DICT_MERGE_KWARGS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ncobj_specs</span>

    <span class="k">def</span> <span class="nf">_format_single_ncobj_specs_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and reformat ncobj_specs dictionary</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **specs**: Dictionary of the following possible form::</span>

<span class="sd">                {&#39;search&#39;: {</span>
<span class="sd">                    &#39;id&#39;:[name1,...],</span>
<span class="sd">                    &#39;standard_name&#39;: [standard_name1,...],</span>
<span class="sd">                    &#39;long_name&#39;: [long_name1,...]</span>
<span class="sd">                    },</span>
<span class="sd">                 &#39;atts&#39;: {&#39;units&#39;:units,...},</span>
<span class="sd">                 &#39;select&#39;: select,</span>
<span class="sd">                 &#39;squeeze&#39;: squeeze_specs,</span>
<span class="sd">                }</span>

<span class="sd">              If ``search`` is not found, it is taken from :mod:`vacumm.data.cf`.</span>
<span class="sd">              If ``&#39;units&#39;`` and ``&#39;long_name&#39;`` are not found in ``atts``,</span>

<span class="sd">              ``select`` is selector as a dictionary, cdms2 selector, tuple or list,</span>
<span class="sd">              passed to :func:`~vacumm.misc.io.ncread_var`.</span>

<span class="sd">            - **name**, optional: Name (id) of the variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        # From another generic variable</span>
<span class="c1">#        if &#39;fromobj&#39; in specs:</span>
<span class="c1">#            from_specs = self._get_ncobj_specs_(specs[&#39;fromobj&#39;])</span>
<span class="c1">#            specs.update(dict_merge(specs, from_specs))</span>
<span class="c1">#            del specs[&#39;fromobj&#39;]</span>


        <span class="c1"># Search specs</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">search</span>
        <span class="c1"># - id (as a list, and with name as its first element)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">search</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="c1"># - standard_name (as a list)</span>
        <span class="k">if</span> <span class="s1">&#39;standard_name&#39;</span> <span class="ow">in</span> <span class="n">search</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]]</span>
        <span class="c1"># - removes everything else</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">search</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Attributes</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;atts&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;atts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atts</span>
        <span class="c1"># - put id</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># - put standard_name</span>
        <span class="k">if</span> <span class="s1">&#39;standard_name&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
            <span class="n">atts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="n">search</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Selection (slices -&gt; select)</span>
        <span class="k">if</span> <span class="s1">&#39;slices&#39;</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;select&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">]</span>

<span class="c1">#        # Squeeze (as a list)</span>
<span class="c1">#        if &#39;squeeze&#39; in specs and not isinstance(specs[&#39;squeeze&#39;], list):</span>
<span class="c1">#            specs[&#39;squeeze&#39;] = [specs[&#39;squeeze&#39;]]</span>

        <span class="k">return</span> <span class="n">specs</span>

    <span class="k">def</span> <span class="nf">_get_ncobj_merged_specs_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get object specs merged from :mod:`vacumm.data.cf`</span>
<span class="sd">        and class level specification (attribute :attr:`ncobj_specs`)</span>

<span class="sd">        Merging is done in the following order:</span>

<span class="sd">            1. Specs from :mod:`vacumm.data.cf`.</span>
<span class="sd">            2. Specs declared at the class definition level (attribute :attr:`ncobj_specs`).</span>
<span class="sd">            3. Specs from another variable specified through the &#39;fromobj&#39;</span>
<span class="sd">               specification key.</span>

<span class="sd">        Found specs are reformatted to provide ``search`` and ``atts`` specs using</span>
<span class="sd">        :func:`~vacumm.data.cf.cf2search` and :func:`~vacumm.data.cf.cf2atts`.</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: Valid generic name.</span>

<span class="sd">        :Return:</span>

<span class="sd">            A dictionary of specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Specs from CF specs (vacumm.data.cf)</span>
        <span class="n">fromobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span> <span class="ow">or</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">CF_AXIS_SPECS</span><span class="p">:</span>

            <span class="c1"># Search and atts</span>
            <span class="n">cf_specs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">search</span><span class="o">=</span><span class="n">cf2search</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">),</span>
                <span class="n">atts</span><span class="o">=</span><span class="n">cf2atts</span><span class="p">(</span><span class="n">varname</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Get &#39;physloc&#39;</span>
            <span class="n">axvar_specs</span> <span class="o">=</span> <span class="p">(</span><span class="n">VAR_SPECS</span> <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span> <span class="k">else</span> <span class="n">AXIS_SPECS</span><span class="p">)[</span><span class="n">varname</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;physloc&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">axvar_specs</span><span class="p">:</span>
                    <span class="n">cf_specs</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">axvar_specs</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>

            <span class="n">genname</span> <span class="o">=</span> <span class="n">varname</span>
            <span class="n">fromobj</span> <span class="o">=</span> <span class="n">cf_specs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fromobj&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cf_specs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Specs from current class</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncobj_specs</span><span class="p">:</span>
            <span class="n">local_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncobj_specs</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">genname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">genname</span> <span class="o">=</span> <span class="n">varname</span>
            <span class="n">fromobj</span> <span class="o">=</span> <span class="n">local_specs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;inherit&#39;</span><span class="p">,</span> <span class="n">fromobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_specs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># From other var</span>
        <span class="k">if</span> <span class="n">fromobj</span><span class="p">:</span>
            <span class="n">from_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_merged_specs_</span><span class="p">(</span><span class="n">fromobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_specs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Merge</span>
        <span class="k">if</span> <span class="n">from_specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cf_specs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">local_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatasetError</span><span class="p">((</span><span class="s1">&#39;Generic var/axis name &quot;</span><span class="si">{}</span><span class="s1">&quot; has no &#39;</span>
                                <span class="s1">&#39;specification defined in current class or &#39;</span>
                                <span class="s1">&#39;module vacumm.data.cf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">))</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">cf_specs</span><span class="p">,</span> <span class="n">local_specs</span><span class="p">,</span> <span class="n">from_specs</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">CF_DICT_MERGE_KWARGS</span><span class="p">)</span>

        <span class="c1"># Final check</span>
        <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;search&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">specs</span>

    <span class="k">def</span> <span class="nf">_get_ncobj_specs_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">attsingle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get specs for searching, selecting and setting defaults of a variable</span>

<span class="sd">        Calls :meth:`_get_ncobj_merged_specs_` for merging specifications.</span>

<span class="sd">        :Return: dict with following keys: genname, search, select, squeeze, atts and physloc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Init outputs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">()</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">genname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span>
        <span class="n">physloc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">search</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generic name -&gt; cf specs and/or class level specs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span> <span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_merged_specs_</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
            <span class="n">genname</span> <span class="o">=</span> <span class="n">varname</span>


        <span class="c1"># Dict of specifications</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

            <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_single_ncobj_specs_</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;fromobj&#39;</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                <span class="n">from_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_merged_specs_</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;fromobj&#39;</span><span class="p">],</span>
                    <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
                <span class="n">specs</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">from_specs</span><span class="p">,</span> <span class="o">**</span><span class="n">CF_DICT_MERGE_KWARGS</span><span class="p">)</span>


        <span class="c1"># Single (+varname) or list of netcdf names</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span> <span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span> <span class="c1"># Netcdf name</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">varname</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">search</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">search</span><span class="p">)</span>

        <span class="c1"># Get search, selector and attributes from specs</span>
        <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Search</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">search</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

            <span class="c1"># Selector</span>
            <span class="n">vselect</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vselect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">select</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">create_selector</span><span class="p">(</span><span class="n">vselect</span><span class="p">))</span>

            <span class="c1"># Attributes</span>
            <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">atts</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atts</span> <span class="ow">and</span> <span class="n">attsingle</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">atts</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">atts</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Squeeze</span>
            <span class="n">squeeze</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1">#[])</span>
            <span class="n">squeeze</span> <span class="o">=</span> <span class="n">merge_squeeze_specs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">)</span>
<span class="c1">#            if not isinstance(squeeze, list):</span>
<span class="c1">#                squeeze = [squeeze]</span>

            <span class="c1"># Physical location</span>
            <span class="n">physloc</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;physloc&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">search</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">genname</span><span class="o">=</span><span class="n">genname</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span>
            <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">,</span> <span class="n">physloc</span><span class="o">=</span><span class="n">physloc</span><span class="p">)</span>
<span class="c1">#        return genname, search, select, squeeze, atts</span>

<div class="viewcode-block" id="Dataset.apply_config"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.apply_config">[docs]</a>    <span class="k">def</span> <span class="nf">apply_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply passed configuration (usually internal call from load_config)</span>

<span class="sd">        Call :meth:`~vacumm.misc.bases.Object.apply_config` and</span>
<span class="sd">        load datasets (if config has a Catalog section)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Applying configuration:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">()))</span>
        <span class="n">Object</span><span class="o">.</span><span class="n">apply_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.load_dataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.load_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load dataset files.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **dataset**: can be either:</span>
<span class="sd">                - an instance or list of strings (filepath/filepattern/url) that</span>
<span class="sd">                  will be passed to :func:`~vacumm.misc.io.list_forecast_files`.</span>
<span class="sd">                - an instance of :class:`Catalog`</span>
<span class="sd">            - **time**: used with :meth:`Catalog.find_datasets` when</span>
<span class="sd">              dataset is a string (or list of strings).</span>
<span class="sd">            - Extra keywords are passed to :func:`~vacumm.misc.io.list_forecast_files`</span>
<span class="sd">              (via :meth:`Catalog.find_datasets`).</span>


<span class="sd">        :Keyword parameters:</span>
<span class="sd">            - **append**: keep previously loaded datasets if True</span>

<span class="sd">        :Return: The list of (newly) loaded datasets</span>

<span class="sd">        :Example:</span>

<span class="sd">            &gt;&gt;&gt; d.load_dataset(&#39;../../data/model/mars/champs_%Y%m_BOBI.nc&#39;, (&#39;2004-01-01&#39;, &#39;2004-04-01&#39;), patfreq=(2,&#39;month&#39;), verbose=True)</span>
<span class="sd">            [2013-01-14 09:42:43 CET Catalog INFO] Searching datasets using pattern: [&#39;../../data/model/mars/champs_%Y%m_BOBI.nc&#39;], time: (&#39;2004-01-01&#39;, &#39;2004-04-01&#39;)</span>
<span class="sd">            Guessing file list using:</span>
<span class="sd">               filepattern: ../../data/model/mars/champs_%Y%m_BOBI.nc</span>
<span class="sd">               time selector: (&#39;2004-01-01&#39;, &#39;2004-03-31&#39;)</span>
<span class="sd">            Found 2 files</span>
<span class="sd">            [2013-01-14 09:42:43 CET Catalog INFO] Found 2 datasets</span>
<span class="sd">            [2013-01-14 09:42:43 CET Dataset INFO] Loading datasets:</span>
<span class="sd">            [2013-01-14 09:42:43 CET Dataset INFO] - ../../data/model/mars/champs_200401_BOBI.nc</span>
<span class="sd">            [2013-01-14 09:42:43 CET Dataset INFO] - ../../data/model/mars/champs_200403_BOBI.nc</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Catalog case: get its dataset files (copy logger level too)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Catalog</span><span class="p">):</span>

            <span class="n">oldlevel</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_loglevel</span><span class="p">()</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_loglevel</span><span class="p">())</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">()</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="n">oldlevel</span><span class="p">)</span>

        <span class="c1"># Other cases: let Catalog find files using filepaths / filepatterns &amp; time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">]</span>

            <span class="n">oldlevel</span> <span class="o">=</span> <span class="n">Catalog</span><span class="o">.</span><span class="n">get_loglevel</span><span class="p">()</span>
            <span class="n">Catalog</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_loglevel</span><span class="p">())</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">Catalog</span><span class="o">.</span><span class="n">find_datasets</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">Catalog</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="n">oldlevel</span><span class="p">)</span>

        <span class="c1"># Open new datasets</span>
        <span class="k">if</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading datasets:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># If append mode, extend internal list</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

        <span class="c1"># Otherwise close internal list and overwrite it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

        <span class="c1"># Return the new datasets</span>
        <span class="k">return</span> <span class="n">datasets</span></div>

<div class="viewcode-block" id="Dataset.close"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">_status_</span> <span class="o">!=</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error closing dataset </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Dataset.get_variable_names"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_variable_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of netcdf variable names of the first file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">listvariables</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.get_selector"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_selector">[docs]</a>    <span class="k">def</span> <span class="nf">get_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a cdms2.selectors.Selector from specified time/lat/lon/level selection</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **time/lon/lat/level**, optional: Refine or set the selector with these components.</span>
<span class="sd">            - **only**, optional: Work only on one component, like &quot;time&quot; or &quot;t&quot;.</span>
<span class="sd">            - **merge**, optional: Merge with selector created at initialization time (stored</span>
<span class="sd">              in attribute :attr:`selector`.)</span>
<span class="sd">            - **split**, optional: return a splitted selector (see :func:`~vacumm.misc.misc.split_selector`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Only on one component</span>
        <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Init</span>
            <span class="n">myselect</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">()</span>

            <span class="c1"># Check &quot;only&quot;</span>
            <span class="n">onlies</span> <span class="o">=</span> <span class="n">only</span>
            <span class="k">for</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">onlies</span><span class="p">:</span>
                <span class="n">only</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">only</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">_geonames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">}</span>
                <span class="n">allowed</span> <span class="o">=</span> <span class="n">_geonames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">+</span><span class="n">_geonames</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Wrong selector type for &quot;only&quot;. Please choose on of: &#39;</span><span class="o">%</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">only</span> <span class="ow">in</span>  <span class="n">_geonames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">only</span> <span class="o">=</span> <span class="n">_geonames</span><span class="p">[</span><span class="n">only</span><span class="p">]</span>

                <span class="c1"># Get and merge</span>
                <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="n">only</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">myselect</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">only</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="n">only</span><span class="p">]})</span>
                <span class="k">if</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">only</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">myselect</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">only</span><span class="p">:</span><span class="nb">locals</span><span class="p">()[</span><span class="n">only</span><span class="p">]})</span>

            <span class="k">return</span> <span class="n">split_selector</span><span class="p">(</span><span class="n">myselect</span><span class="p">)</span> <span class="k">if</span> <span class="n">split</span> <span class="k">else</span> <span class="n">myselect</span>

        <span class="c1"># Full selector</span>
        <span class="n">myselect</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
            <span class="n">myselect</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">del</span> <span class="n">kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">myselect</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">split_selector</span><span class="p">(</span><span class="n">myselect</span><span class="p">)</span> <span class="k">if</span> <span class="n">split</span> <span class="k">else</span> <span class="n">myselect</span></div>

<div class="viewcode-block" id="Dataset.get_seltimes"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_seltimes">[docs]</a>    <span class="k">def</span> <span class="nf">get_seltimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a zero to two elements time selector specifications</span>


<span class="sd">        It is the addition of non global and local time selection specs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seltimes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seltimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seltimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seltimes</span></div>

<div class="viewcode-block" id="Dataset.get_axis"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">getid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retreive a 1D or 2D axis.</span>

<span class="sd">        :Params:</span>
<span class="sd">          - **name**: Generic axis name.</span>
<span class="sd">          - **select** optional: Selection along this axis.</span>
<span class="sd">            Only slices are accepted for 2D axes.</span>
<span class="sd">          - **select2** optional: Selection on the other dimension</span>
<span class="sd">            for 2D axes.</span>
<span class="sd">          - **dataset** optional: find axis based on this dataset.</span>
<span class="sd">          - **getid**, optional: If True, only return the id (netcdf name) or None.</span>
<span class="sd">          - **warn**, optional: Display a warning in case of problem.</span>
<span class="sd">          - **searchmode**, optional: Search order (see :func:`~vacumm.misc.io.ncfind_obj`).</span>
<span class="sd">          - **format**, optional: Format the axis using :func:`~vacumm.data.cf.format_axis`?</span>

<span class="sd">        :Return:</span>
<span class="sd">            - cdms2 axis or None if not found, or id</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Inits</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Searching axis </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> found, dataset is empty&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using reference dataset: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Get specs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attsingle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
        <span class="n">genname</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;long_name&#39;</span> <span class="ow">in</span> <span class="n">atts</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">atts</span> <span class="ow">and</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">atts</span> <span class="ow">and</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

        <span class="c1"># Check cache first</span>
        <span class="n">ncname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_ncid_</span><span class="p">(</span><span class="n">genname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getid</span> <span class="ow">and</span> <span class="n">ncname</span><span class="p">:</span> <span class="k">return</span> <span class="n">ncname</span>

        <span class="c1"># Search id if not available</span>
        <span class="k">if</span> <span class="n">ncname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Find</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ncname</span> <span class="o">=</span> <span class="n">ncfind_obj</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">regexp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">getid</span><span class="p">:</span> <span class="k">return</span> <span class="n">ncname</span>
                <span class="k">if</span> <span class="n">ncname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Generic axis not found with search specs: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">search</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">getid</span> <span class="ow">and</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error searching for generic axis  &#39;</span>
                    <span class="s1">&#39;with specs: </span><span class="si">%s</span><span class="s1">. Message: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="n">format_exc</span><span class="p">()))</span>
                <span class="k">return</span>

        <span class="c1"># Cache result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cached_ncid_</span><span class="p">(</span><span class="n">genname</span><span class="p">,</span> <span class="n">ncname</span><span class="p">)</span>

        <span class="c1"># Read</span>
        <span class="k">if</span> <span class="n">ncname</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listvariables</span><span class="p">():</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">ncname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">ncname</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># Format</span>
        <span class="k">if</span> <span class="n">genname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">format_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">genname</span><span class="p">)</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">_notuplist_</span><span class="p">(</span><span class="n">atts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">atts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Select</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">select2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>

            <span class="c1"># Curv case</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>

                <span class="n">axtype</span> <span class="o">=</span> <span class="n">get_axis_type</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checkatts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="n">axtype</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">genname</span> <span class="ow">and</span> <span class="n">genname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">islon</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">aname</span> <span class="o">=</span> <span class="s1">&#39;lat&#39;</span>
                        <span class="k">if</span> <span class="n">genname</span><span class="p">:</span> <span class="n">aname</span> <span class="o">+=</span> <span class="n">genname</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">aname</span><span class="p">)(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">iaxis</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">genname</span> <span class="ow">and</span> <span class="n">genname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">islat</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">aname</span> <span class="o">=</span> <span class="s1">&#39;lon&#39;</span>
                        <span class="k">if</span> <span class="n">genname</span><span class="p">:</span> <span class="n">aname</span> <span class="o">+=</span> <span class="n">genname</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">aname</span><span class="p">)(</span><span class="kc">False</span><span class="p">),</span> <span class="n">axis</span>
                        <span class="n">iaxis</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">select</span><span class="p">,</span> <span class="n">select2</span> <span class="o">=</span> <span class="n">select2</span><span class="p">,</span> <span class="n">select</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_on_axis_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">select2</span><span class="p">,</span>
                        <span class="n">global_select</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="n">genname</span><span class="p">)[</span><span class="n">iaxis</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_on_axis_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">select2</span><span class="p">,</span> <span class="n">global_select</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="n">genname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axis</span></div>

    <span class="k">def</span> <span class="nf">_select_on_axis_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">select1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">global_select</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Global and local selection applied to a 1D or 2D axis</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **axis**: cdms2 axis on which to operate, or a tuple of them (2D case).</span>
<span class="sd">            - **select1**: local lon selection if axis is lon, else lat selection.</span>
<span class="sd">            - **select2**: local lat selection if axis is lon, else lon selection.</span>
<span class="sd">            - **global_select**: also apply a global selection (using self.selects).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">select1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">axis</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># 1D axis</span>

            <span class="n">selects</span> <span class="o">=</span> <span class="p">[</span><span class="n">select1</span> <span class="ow">or</span> <span class="n">select2</span><span class="p">]</span>
            <span class="n">axtype</span> <span class="o">=</span> <span class="n">get_axis_type</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checkatts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axtype</span> <span class="ow">and</span> <span class="n">global_select</span><span class="p">:</span> <span class="n">selects</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="n">axtype</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">selects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">ijk</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">mapIntervalExt</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ijk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t appy selection </span><span class="si">%s</span><span class="s2"> to axis </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">genname</span> <span class="ow">or</span> <span class="n">axis</span><span class="p">))</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ijk</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;Selection must be a tuple or a slice: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sel</span><span class="p">)</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Global selection</span>
            <span class="k">if</span> <span class="n">global_select</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">global_select</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">global_select</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_select</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Local selection</span>
            <span class="k">if</span> <span class="n">select1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">select2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># No selection</span>
                <span class="n">local_select</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">axtarget</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">axis</span>
                <span class="n">axtype</span> <span class="o">=</span> <span class="n">get_axis_type</span><span class="p">(</span><span class="n">axtarget</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checkatts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">select1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">select2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Along X and Y</span>
                    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">select1</span><span class="p">,</span> <span class="n">select2</span>
                <span class="k">elif</span> <span class="n">select1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axtype</span><span class="o">==</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="n">select1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="n">select1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axtype</span><span class="o">==</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="n">select2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="n">select2</span>
                <span class="n">local_select</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">[</span><span class="n">global_select</span><span class="p">,</span> <span class="n">local_select</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">sel</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sel</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">gridsel</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">**</span><span class="n">sel</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axis</span>

    <span class="k">def</span> <span class="nf">_get_cached_ncid_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">genname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ncids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">genname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_cached_ncid_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genname</span><span class="p">,</span> <span class="n">ncid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">genname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncids</span><span class="p">[</span><span class="n">genname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncid</span>


<div class="viewcode-block" id="Dataset.get_variable"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="s1">&#39;is&#39;</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load a variable in a best time serie fashion.</span>

<span class="sd">        :Params:</span>
<span class="sd">          - **varname**: Either a generic variable name listed in</span>
<span class="sd">            :attr:`~vacumm.data.cf.CF_VAR_SPECS`, a netcdf name with a &#39;+&#39; a prefix,</span>
<span class="sd">            a tuple of netcdf variable names</span>
<span class="sd">            or dictionnary of specification names with a search argument of</span>
<span class="sd">            :func:`~vacumm.misc.io.ncfind_var` (tuple of netcdf names</span>
<span class="sd">            or dictionary).</span>
<span class="sd">          - **time/lon/lat/level**: Selector components.</span>
<span class="sd">          - **squeeze**: If true, call :func:`squeeze_variable` on the returned variable.</span>
<span class="sd">          - **order**: If not None, specify the output variable axes order.</span>
<span class="sd">          - **depthup**: Make depths up.</span>
<span class="sd">          - **torect**: Make grid rectangular if possible.</span>
<span class="sd">          - **at/toloc**: Interpolate the variable to another location on the grid</span>
<span class="sd">            using :meth:`toloc`. Note that the :attr:`arakawa_grid_type` must be defined.</span>
<span class="sd">          - **format**: Format the variable and its axes using</span>
<span class="sd">            :func:`~vacumm.data.cf.format_var`?</span>
<span class="sd">          - **warn**: Display a warning message if the variable can&quot;t be retreived.</span>
<span class="sd">          - Other kwargs are passed to :func:`~vacumm.misc.io.ncread_files`.</span>

<span class="sd">        :Return:</span>
<span class="sd">            cdms2 variable or None if not found</span>

<span class="sd">        :Example:</span>

<span class="sd">            &gt;&gt;&gt; get_variable(&#39;ssh&#39;, lon=(-10,0))</span>
<span class="sd">            &gt;&gt;&gt; get_variable(&#39;+xe&#39;)</span>
<span class="sd">            &gt;&gt;&gt; get_variable(dict(search={&#39;standard_name&#39;:&#39;sea_surface_height_above_sea_level&#39;}))</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">selstring</span> <span class="o">=</span> <span class="s1">&#39;time: </span><span class="si">%(time)s</span><span class="s1">, level: </span><span class="si">%(level)s</span><span class="s1">, lat: </span><span class="si">%(lat)s</span><span class="s1">, lon: </span><span class="si">%(lon)s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">locals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting variable: </span><span class="si">%(varname)s</span><span class="s1">,  </span><span class="si">%(selstring)s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> variable found, dataset is empty&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Specifications for searching, selecting and modifying the variable</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable_names</span><span class="p">()):</span>
                <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">)</span>  <span class="c1"># direct from file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No valid specs to search for </span><span class="si">%s</span><span class="s1"> and not in file&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">genname</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span>
        <span class="n">base_squeeze</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">]</span>

        <span class="c1"># Refine selector</span>
        <span class="n">select</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">seltimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seltimes</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seltimes</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">seltime</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">for</span> <span class="n">seltime</span> <span class="ow">in</span> <span class="n">seltimes</span><span class="p">]):</span>
            <span class="n">seltimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">itv_intersect</span><span class="p">(</span><span class="o">*</span><span class="n">seltimes</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="s1">&#39;squeeze&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">select</span><span class="o">.</span><span class="n">squeeze</span><span class="p">:</span>
            <span class="n">squeeze</span> <span class="o">=</span> <span class="n">merge_squeeze_specs</span><span class="p">(</span><span class="n">base_squeeze</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">squeeze</span><span class="p">)</span>


        <span class="c1"># Search for the variable now</span>
        <span class="n">ncvarid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_ncid_</span><span class="p">(</span><span class="n">genname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncvarid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncvarid</span> <span class="o">=</span> <span class="n">ncfind_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">search</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cached_ncid_</span><span class="p">(</span><span class="n">genname</span><span class="p">,</span> <span class="n">ncvarid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncvarid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">isaxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ncvarid</span><span class="p">]):</span>
            <span class="n">ncvarid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ncvarid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Variable not found with search specs: </span><span class="si">%s</span><span class="s1"> (in file </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="c1"># TODO: if grid not found and specs say that there must have a grid, create it with get_lon/get_lat</span>

        <span class="c1"># Curved grid case</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ncvarid</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">var_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ncvarid</span><span class="p">]</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">var_grid</span>
                <span class="n">kwg</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">var_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="n">var_grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">yid</span><span class="o">=</span><span class="n">var_grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curvsel</span> <span class="o">=</span> <span class="n">CurvedSelector</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kwg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curvsel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Intercept kwargs before ncread_files</span>

        <span class="c1"># Read</span>
        <span class="n">kwncr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwncr</span><span class="p">[</span><span class="s1">&#39;torect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dict_filter_out</span><span class="p">(</span><span class="n">kwncr</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
<span class="c1">#        seltime = filter_time_selector(select, ids=self.get_timeid())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">ncread_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>  <span class="c1">#[d.id for d in self.dataset],</span>
                <span class="n">ncvarid</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">timeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeid</span><span class="p">(),</span>
                <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_debug</span><span class="p">(),</span>
                <span class="n">squeeze</span><span class="o">=</span><span class="n">base_squeeze</span><span class="p">,</span> <span class="n">nibeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nibeid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="o">**</span><span class="n">kwncr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data found for variable: </span><span class="si">%s</span><span class="s1">, local select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">selstring</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">VACUMMError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error reading variable: </span><span class="si">%s</span><span class="s1">. Message: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">varname</span><span class="p">,</span>  <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Finalize</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

            <span class="c1"># Minimal formatting</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">and</span> <span class="n">genname</span> <span class="ow">and</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">var</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">genname</span>

            <span class="c1"># Post process</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seltimes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">seltimes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="n">genname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="n">asvar</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="n">depthup</span><span class="p">,</span> <span class="n">curvsel</span><span class="o">=</span><span class="n">curvsel</span><span class="p">,</span>
                <span class="n">at</span><span class="o">=</span><span class="n">at</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Loaded variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="Dataset.get"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic way to get a variable</span>

<span class="sd">        It first tries to find a ``get_*`` method, then call</span>
<span class="sd">        :meth:`get_variable` if no method is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span></div>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">get</span>

<span class="c1">#    def get_time(self, *args, **kwargs):</span>
<span class="c1">#        return self.get_axis(&#39;t&#39;, *args, **kwargs)</span>

<div class="viewcode-block" id="Dataset.get_timeid"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_timeid">[docs]</a>    <span class="k">def</span> <span class="nf">get_timeid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the time id&quot;&quot;&quot;</span>
        <span class="c1"># From cache</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_ncid_</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>  <span class="n">timeid</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No time found, dataset is empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Find time id</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">genname</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="n">ncfind_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">search</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cached_ncid_</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">timeid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timeid</span></div>


<div class="viewcode-block" id="Dataset.get_time"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load time axis in a best time serie fashion.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **time**: time selector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting time, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="c1"># Find time id</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeid</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">timeid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Loop on files with first level selection</span>
        <span class="n">allaxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">timeid</span><span class="p">:</span>

            <span class="c1"># Pre and post time selectors</span>
            <span class="n">iter_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">post_times</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">this_time</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">time</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iter_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">iter_time</span> <span class="o">=</span> <span class="n">this_time</span>
                <span class="k">elif</span> <span class="n">this_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                    <span class="n">post_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_time</span><span class="p">)</span>

            <span class="c1"># Build iterator</span>
            <span class="nb">iter</span> <span class="o">=</span> <span class="n">NcIterBestEstimate</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">],</span> <span class="n">iter_time</span><span class="p">,</span>
                <span class="n">timeid</span><span class="o">=</span><span class="n">timeid</span><span class="p">,</span> <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">iter_time</span><span class="p">))</span>

            <span class="c1"># Iterate</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_status_</span><span class="o">==</span><span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="nb">iter</span><span class="o">.</span><span class="n">timeid</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">):</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">allaxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="nb">iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Finalize</span>
            <span class="k">if</span> <span class="n">allaxes</span> <span class="p">:</span>

                <span class="c1"># Concatenate</span>
                <span class="n">axis</span> <span class="o">=</span>  <span class="n">MV2_axisConcatenate</span><span class="p">(</span><span class="n">allaxes</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Final selections</span>
                <span class="k">for</span> <span class="n">this_time</span> <span class="ow">in</span> <span class="n">post_times</span><span class="p">:</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_on_axis_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">this_time</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                        <span class="n">global_select</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Format</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">format_axis</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">axis</span>


        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No time found for select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_ctime"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_ctime">[docs]</a>    <span class="k">def</span> <span class="nf">get_ctime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get time axis as a list of :class:`cdtime.comptime`</span>

<span class="sd">        It is a simple shortcut to:</span>

<span class="sd">            &gt;&gt;&gt; ds.get_time().asComponentTime()</span>

<span class="sd">        :Params: All arguments are passed to :meth:`get_time`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.get_time_res"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_time_res">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the estimated  time resolution, based on the two first time coordinates</span>

<span class="sd">        :Return:</span>
<span class="sd">            - resolution as datetime.timedelta</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ctime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ctime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">ctime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">ctime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Dataset.get_lon"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lon">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get longitude axis&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">get_longitude</span> <span class="o">=</span> <span class="n">get_lon</span>

<div class="viewcode-block" id="Dataset.get_lon_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lon_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get longitude axis at T location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lon_t&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lon_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lon_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get longitude axis at U location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lon_u&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lon_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lon_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get longitude axis at V location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lon_v&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lon_f"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lon_f">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get longitude axis at F location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lon_f&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lat"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lat">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get latitude axis&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">get_latitude</span> <span class="o">=</span> <span class="n">get_lat</span>

<div class="viewcode-block" id="Dataset.get_lat_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lat_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get latitude axis at T location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lat_t&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lat_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lat_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get latitude axis at U location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lat_u&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lat_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lat_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get latitude axis at V location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lat_v&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_lat_f"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_lat_f">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get latitude axis at F location&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;lat_f&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_grid_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="s1">&#39;si&#39;</span><span class="p">):</span>

        <span class="c1"># Loc</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">loc_</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">longenname</span> <span class="o">=</span> <span class="s1">&#39;lon&#39;</span> <span class="o">+</span> <span class="n">loc_</span>
        <span class="n">latgenname</span> <span class="o">=</span> <span class="s1">&#39;lat&#39;</span> <span class="o">+</span> <span class="n">loc_</span>

        <span class="c1"># Search specs</span>
        <span class="n">searches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">longenname</span><span class="p">,</span> <span class="n">latgenname</span><span class="p">:</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncobj_specs_</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attsingle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">)</span>
<span class="c1">#            genname = specs[&#39;genname&#39;]</span>
            <span class="n">searches</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>
            <span class="n">atts</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;long_name&#39;</span> <span class="ow">in</span> <span class="n">atts</span><span class="p">:</span>
                <span class="n">searches</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">atts</span> <span class="ow">and</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">atts</span> <span class="ow">and</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                <span class="n">searches</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>


        <span class="c1"># Inits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Searching for a grid that matches: (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latgenname</span><span class="p">,</span> <span class="n">longenname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> found, dataset is empty&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using reference dataset: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">grids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">longenname</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()),</span>
                    <span class="p">(</span><span class="n">latgenname</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">())]:</span>

                <span class="n">valid</span> <span class="o">&amp;=</span> <span class="n">ncmatch_obj</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">searchmode</span><span class="o">=</span><span class="n">searchmode</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">searches</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<span class="c1">#                bool(ncfind_obj(dataset, search, regexp=True,</span>
<span class="c1">#                    searchmode=searchmode))</span>

            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t get grid&quot;</span>
                <span class="k">if</span> <span class="n">loc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;at </span><span class="si">{}</span><span class="s1"> location&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Select</span>
        <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">gridsel</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># clone</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">clone_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Format</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">format_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">format_subaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid</span>


<div class="viewcode-block" id="Dataset.get_grid"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_grid_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_grid_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_grid_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_grid_f"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_f">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#    def get_grid(self, lon=None, lat=None, format=True, warn=True):</span>
<span class="c1">#        &#39;&#39;&#39;Get grid&#39;&#39;&#39;</span>
<span class="c1">#        warn2 = max(int(warn)-1, 0)</span>
<span class="c1">#        axlon = self.get_lon(lon, lat, format=format, warn=warn2)</span>
<span class="c1">#        axlat = self.get_lat(lat, lon, format=format, warn=warn2)</span>
<span class="c1">#        if axlon is None or axlat is None:</span>
<span class="c1">#            if warn: self.warning(&quot;Can&#39;t get grid&quot;)</span>
<span class="c1">#            return None</span>
<span class="c1">#        grid = create_grid(axlon, axlat)</span>
<span class="c1">#        return grid</span>

<div class="viewcode-block" id="Dataset.get_grid_t_old"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_t_old">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_t_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get grid at T location&#39;&#39;&#39;</span>
        <span class="n">warn2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">axlon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_t</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="n">axlat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_t</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axlon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axlat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get grid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="Dataset.get_grid_u_old"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_u_old">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_u_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get grid at U location&#39;&#39;&#39;</span>
        <span class="n">warn2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">axlon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_u</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="n">axlat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_u</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axlon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axlat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get grid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="Dataset.get_grid_v_old"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_v_old">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_v_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get grid at V location&#39;&#39;&#39;</span>
        <span class="n">warn2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">axlon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_v</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="n">axlat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_v</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axlon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axlat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get grid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="Dataset.get_grid_f_old"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_grid_f_old">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid_f_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get grid at F location&#39;&#39;&#39;</span>
        <span class="n">warn2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">axlon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_f</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="n">axlat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_f</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axlon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axlat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get grid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">axlon</span><span class="p">,</span> <span class="n">axlat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="Dataset.get_shape"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_shape">[docs]</a>    <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;tzyx&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the dataset shape from known generic dims</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **dims**, optional: Letters that select the generic dimensions to consider.</span>

<span class="sd">        :Return: A tuple of the size of dimensions. If a requested dim is not found,</span>
<span class="sd">            None is returned for its size.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">getters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">getters</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">getters</span><span class="p">[</span><span class="n">d</span><span class="p">])()</span>
                <span class="n">sh</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">sh</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># 2D axes</span>
                        <span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;y&#39;</span> <span class="k">else</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sh</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid generic dim: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">d</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">+=</span> <span class="n">sh</span><span class="p">,</span>
        <span class="k">return</span> <span class="n">shape</span></div>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="o">=</span><span class="n">get_shape</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Generic shape of the dataset&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dxy_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">atp</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">dict_check_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">kwgeo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">kwg</span> <span class="o">=</span> <span class="n">kwgeo</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwgeo</span><span class="p">)</span>
        <span class="n">rmode</span> <span class="o">=</span> <span class="s1">&#39;raw&#39;</span> <span class="k">if</span> <span class="n">local</span> <span class="k">else</span> <span class="s2">&quot;median&quot;</span>
        <span class="k">if</span> <span class="n">frompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">frompt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">frompt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">at</span><span class="p">,</span> <span class="s1">&#39;centered&#39;</span><span class="p">))</span>

        <span class="c1"># X or Y</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">xy</span><span class="o">==</span><span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">genname_deg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dlat&#39;</span><span class="p">,</span> <span class="s1">&#39;dlon&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>

        <span class="c1"># In meters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">degrees</span><span class="p">:</span>

            <span class="c1"># Using sizes</span>
            <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
                <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">xy</span><span class="o">+</span><span class="n">atp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span> <span class="ow">and</span> <span class="n">dxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dxy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dxy</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">dxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span> <span class="n">dxy</span>

            <span class="c1"># Using coordinates</span>
            <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

                <span class="c1"># Estimate</span>
                <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord2res_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord2dxy_</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="n">frompt</span><span class="p">,</span> <span class="n">kwg</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">)</span>

                <span class="c1"># Finalize</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_dxy_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">atp</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">xy</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="c1"># In degrees</span>
        <span class="c1"># - estimate</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord2res_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord2dlonlat_</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="n">frompt</span><span class="p">,</span> <span class="n">kwg</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">)</span>
        <span class="c1"># - finalize</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_dxy_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">atp</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">genname_deg</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coord2res_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="n">frompt</span><span class="p">,</span> <span class="n">kwg</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate resolution in meters or degrees from coordinates at several locations&quot;&quot;&quot;</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frompt</span><span class="p">:</span> <span class="c1"># [(&#39;u&#39;, -1)] # FIXME: WE MUST DOT IT HERE AND USE FINALISE/AT INSTEAD</span>
            <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">transforms</span> <span class="ow">in</span> <span class="n">frompt</span><span class="p">:</span>

                <span class="c1"># Compute it</span>
                <span class="n">dxy</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">rmode</span><span class="o">!=</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">dxy</span>

                <span class="c1"># Loop on transforms</span>
                <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>

                    <span class="c1"># Centered estimation</span>
                    <span class="k">if</span> <span class="n">transform</span><span class="o">==</span><span class="s1">&#39;centered&#39;</span><span class="p">:</span>

                        <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dxy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">sh</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">dxy_</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
                        <span class="n">sl</span> <span class="o">=</span> <span class="n">get_axis_slices</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
                        <span class="n">dxy_</span><span class="p">[</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;firsts&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">shift1d</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                        <span class="n">dxy_</span><span class="p">[</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">shift1d</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)[</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]]</span>
                        <span class="n">dxy</span> <span class="o">=</span> <span class="n">dxy_</span>

                    <span class="k">else</span><span class="p">:</span> <span class="c1"># Using specified transforms</span>

                        <span class="n">transfunc</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">transform</span>
                        <span class="n">dxy</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">dxy</span>


    <span class="k">def</span> <span class="nf">_coord2dxy_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwgeo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate resolution in meters from coordinates&quot;&quot;&quot;</span>
        <span class="n">atp</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_grid&#39;</span><span class="o">+</span><span class="n">atp</span><span class="p">)(</span><span class="o">**</span><span class="n">kwgeo</span><span class="p">)</span> <span class="c1"># lat is also needed for projection</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span>  <span class="n">resol</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">rmode</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)[</span><span class="mi">1</span><span class="o">+</span><span class="n">axis</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_coord2dlonlat_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">rmode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwgeo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate resolution in degrees from coordinates&quot;&quot;&quot;</span>
        <span class="n">atp</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">atp</span><span class="p">)(</span><span class="o">**</span><span class="n">kwgeo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span> <span class="n">resol</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">rmode</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_finalize_dxy_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">atp</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">genname</span><span class="p">,</span> <span class="n">kwgeo</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reshape, put on grid and finalize as other variables&quot;&quot;&quot;</span>
        <span class="c1"># Nothing</span>
        <span class="k">if</span> <span class="n">dxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t estimate resolution from coordinates&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">dxy</span><span class="p">):</span> <span class="k">return</span> <span class="n">dxy</span>

        <span class="c1"># Put on grid</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dxy</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_grid&#39;</span><span class="o">+</span><span class="n">atp</span><span class="p">)(</span><span class="o">**</span><span class="n">kwgeo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dxy</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dxy</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">dxy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dxy</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">set_grid</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Finalize</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="n">genname</span><span class="o">+</span><span class="n">atp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="Dataset.get_dx"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dx">[docs]</a>    <span class="k">def</span> <span class="nf">get_dx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along X</span>

<span class="sd">        It can be stored as an variable or computed from coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})])]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_dx_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dx_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_dx_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along X at U location&quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})])]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_dx_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dx_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_dx_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along X at V location&quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}),</span>
                <span class="p">(</span><span class="n">shift1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shift&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})]),</span>
            <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">shift1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shift&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})]),</span>
            <span class="p">]</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_dy"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dy">[docs]</a>    <span class="k">def</span> <span class="nf">get_dy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along Y</span>

<span class="sd">        It can be stored as an variable or computed from coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})])]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_dy_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dy_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_dy_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along Y at V location&quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})])]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_dy_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_dy_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_dy_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the grid resolution along Y at U location&quot;&quot;&quot;</span>
        <span class="n">frompt</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">extend1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}),</span>
                <span class="p">(</span><span class="n">shift1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shift&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})]),</span>
            <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">shift1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shift&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})]),</span>
            <span class="p">]</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_dxy_</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">frompt</span><span class="o">=</span><span class="n">frompt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.get_resol"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_resol">[docs]</a>    <span class="k">def</span> <span class="nf">get_resol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the horizontal grid resolutions</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **degrees**, optional: In degrees or meters?</span>
<span class="sd">            - **local**, optional: Get resolution at each point?</span>

<span class="sd">        :Return: ``dx,dy``</span>

<span class="sd">        :See also: :meth:`get_dx` :meth:`get_dy` :meth:`get_grid` :func:`~vacumm.misc.grid.misc.resol`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># In meters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">degrees</span><span class="p">:</span>

            <span class="c1"># Using sizes</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dx_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dy_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>

        <span class="c1"># Using coordinates (degrees or meters)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dx2</span> <span class="o">=</span> <span class="n">dy2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dx2</span><span class="p">,</span> <span class="n">dy2</span> <span class="o">=</span>  <span class="n">resol</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="ow">not</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dx</span> <span class="ow">or</span> <span class="n">dx2</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">or</span> <span class="n">dy2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t properly estimate resolution along both X and Y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="Dataset.get_level"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_level">[docs]</a>    <span class="k">def</span> <span class="nf">get_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get level axis, based on :func:`get_axis`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#    @getvar_fmtdoc</span>
<span class="c1">#    def get_corio(self, **kwargs):</span>
<span class="c1">#        &#39;&#39;&#39;Get Coriolis parameter&#39;&#39;&#39;</span>
<span class="c1">#        return self.get_variable(&#39;corio&#39;, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#    @getvar_fmtdoc</span>
<span class="c1">#    def get_corio_u(self, **kwargs):</span>
<span class="c1">#        &#39;&#39;&#39;Get Coriolis parameter&#39;&#39;&#39;</span>
<span class="c1">#        return self.get_variable(&#39;corio_u&#39;, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#    @getvar_fmtdoc</span>
<span class="c1">#    def get_corio_v(self, **kwargs):</span>
<span class="c1">#        &#39;&#39;&#39;Get Coriolis parameter&#39;&#39;&#39;</span>
<span class="c1">#        return self.get_variable(&#39;corio_v&#39;, **kwargs)</span>

<div class="viewcode-block" id="Dataset.get_transect"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_transect">[docs]</a>    <span class="k">def</span> <span class="nf">get_transect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a transect between two points</span>

<span class="sd">        It uses :func:`~vacumm.misc.grid.regridding.transect`.</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: Generic var name.</span>
<span class="sd">            - **lons/lats**: Specification of transect, either</span>

<span class="sd">                - Coordinates of first and last point in degrees as</span>
<span class="sd">                  tuples in the form ``(lon0,lon1)`` and ``(lat0,lat1)``.</span>
<span class="sd">                  The array of coordinates is generated using :func:`transect_specs`.</span>
<span class="sd">                - Or explicit array of coordinates (as scalars, lists or arrays).</span>

<span class="sd">            - **times**, optional: For time transect too.</span>
<span class="sd">            - **subsamp**, optional: Subsampling with respect to grid cell.</span>
<span class="sd">            - **method**, optional: Interpolation method</span>
<span class="sd">              (see :func:`~vacumm.misc.grid.regridding.grid2xy`).</span>
<span class="sd">            - **getcoords**, optional: Also get computed coordinates.</span>
<span class="sd">            - **outaxis**, optional: Output axis.</span>

<span class="sd">                - A cdms2 axis.</span>
<span class="sd">                - ``None`` or ``&#39;auto&#39;``: Longitudes or latitudes depending</span>
<span class="sd">                  on the range.</span>
<span class="sd">                - ``&#39;lon&#39;`` or ``&#39;x&#39;``: Longitudes.</span>
<span class="sd">                - ``&#39;lat&#39;`` or ``&#39;y&#39;``: Latitudes.</span>
<span class="sd">                - ``&#39;dist&#39;`` or ``&#39;d&#39;``: Distance in km.</span>

<span class="sd">            - **timeavg**, optional: Time average of results.</span>

<span class="sd">        :Return:</span>

<span class="sd">            ``tvar`` or ``tvar,tlons,tlats``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Params</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctimes</span> <span class="o">=</span> <span class="n">comptime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ccn&#39;</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;torect&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;squeeze&#39;</span><span class="p">,</span> <span class="s1">&#39;asvar&#39;</span><span class="p">],</span>
            <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">warn</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Get data</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Your variable needs at least to be YX for a transect&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">var</span>


        <span class="c1"># Make transect</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">transect</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="n">subsamp</span><span class="p">,</span>
            <span class="n">getcoords</span><span class="o">=</span><span class="n">getcoords</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">outaxis</span><span class="o">=</span><span class="n">outaxis</span><span class="p">)</span>
        <span class="n">tvar</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">getcoords</span> <span class="k">else</span> <span class="n">res</span>

        <span class="c1"># Time average</span>
        <span class="k">if</span> <span class="n">timeavg</span> <span class="ow">and</span> <span class="n">tvar</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Averaging transect along time&#39;</span><span class="p">)</span>
            <span class="n">tvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">tvar</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">tvar</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">tvar</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getcoords</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">tvar</span><span class="p">,</span> <span class="p">)</span><span class="o">+</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">tvar</span></div>

<div class="viewcode-block" id="Dataset.plot_transect"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.plot_transect">[docs]</a>    <span class="k">def</span> <span class="nf">plot_transect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">outaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(long_name)s</span><span class="s1"> along transect&#39;</span><span class="p">,</span> <span class="n">minimap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot a transect between two points</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: Generic var name.</span>
<span class="sd">            - **lons/lats/times**: Specification of transect (see :meth:`get_transect`).</span>
<span class="sd">            - **title**, optional: Title of the figure.</span>
<span class="sd">            - **minimap**, optional: If True, add a minimap showing the transect</span>
<span class="sd">              on a map; if False, display nothing; if None, display if no minimap</span>
<span class="sd">              already displayed.</span>
<span class="sd">            - **minimap_&lt;param&gt;**, optional: Passed to :func:`~vacumm.misc.plot.add_map_lines`.</span>
<span class="sd">            - Some params are passed to :meth:`get_transect`.</span>
<span class="sd">            - Other params are passed to the plot function :func:`~vacumm.misc.plot.curve2`</span>
<span class="sd">              for 1D plots and, :func:`~vacumm.misc.plot.hov2` or</span>
<span class="sd">              :func:`~vacumm.misc.plot.section2` for 2D plots.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get data</span>
        <span class="n">kwts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="n">subsamp</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="n">timeavg</span><span class="p">,</span>
            <span class="n">outaxis</span><span class="o">=</span><span class="n">outaxis</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
            <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwts</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
            <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timeavg</span> <span class="ow">or</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ct1</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">title</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2"> period&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">title</span><span class="p">,</span><span class="n">ct0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get time information. Error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get transect on variable&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;ocean&quot;</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;atmos&quot;</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span> <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check dimension</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Forcing time average to have a 2D transect&#39;</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Main plot</span>
        <span class="n">kwmap</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;minimap_&#39;</span><span class="p">)</span>
        <span class="n">post_plot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_plot&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">post_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># - 1D</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">curve2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># - T-</span>
        <span class="k">elif</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">():</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">hov2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># - Z-</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1"># - Modif GC: Masked depth converted to 0.</span>
            <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMA</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
                <span class="n">depth</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">section2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Minimap</span>
        <span class="k">if</span> <span class="n">minimap</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span> <span class="n">minimap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">minimap</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">minimap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;_minimap&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">kwmap</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;map_zoom&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">add_map_lines</span><span class="p">(((</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),(</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="o">**</span><span class="n">kwmap</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_minimap</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">post_plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;atmos&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#tight_layout()</span>
        <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="Dataset.get_hsection"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.get_hsection">[docs]</a>    <span class="k">def</span> <span class="nf">get_hsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeavg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a horizontal section of a variable for a specified depth</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: Generic var name.</span>
<span class="sd">            - **depth**: Target depth.</span>
<span class="sd">            - **timeavg**, optional: Time average of results.</span>
<span class="sd">            - **depth_&lt;param&gt;**, optional: Param is passed to :meth:`get_depth`.</span>
<span class="sd">            - **interp_&lt;param&gt;**, optional: Param is passed to</span>
<span class="sd">              :meth:`~vacumm.misc.grid.regridding.interp1d`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Params</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;torect&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">warn</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">kwdepth</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;depth_&#39;</span><span class="p">)</span>
        <span class="n">kwdepth</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="n">kwinterp</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;interp_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">kwinterp</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>

        <span class="c1"># Get data</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;ocean&quot;</span><span class="p">:</span>
            <span class="n">vardepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="o">**</span><span class="n">kwdepth</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;atmos&quot;</span><span class="p">:</span>
            <span class="n">vardepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_altitude</span><span class="p">(</span><span class="o">**</span><span class="n">kwdepth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vardepth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot get var or depths for hsection&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Get time information</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
            <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timeavg</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ct1</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ctime</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2"> period&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">ct0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get time information. Error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Interpolate</span>
        <span class="n">lvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_at_depths_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">vardepth</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="o">**</span><span class="n">kwinterp</span><span class="p">)</span>

        <span class="c1"># Time average</span>
        <span class="k">if</span> <span class="n">timeavg</span> <span class="ow">and</span> <span class="n">lvar</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">lvar</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">lvar</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">ctime</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_interp_at_depths_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">vardepth</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;ocean&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">domain</span><span class="o">==</span><span class="s2">&quot;ocean&quot;</span><span class="p">:</span> <span class="n">depths</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;atmos&quot;</span><span class="p">:</span> <span class="n">depths</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">create_dep</span><span class="p">([</span><span class="n">depths</span><span class="p">]</span> <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="k">else</span> <span class="n">depths</span><span class="p">[:])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vardepth</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">vardepth</span> <span class="o">=</span> <span class="n">vardepth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iaxi</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vardepth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#            var, vardepth = grow_variables(var, vardepth)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">axi</span><span class="o">=</span><span class="n">vardepth</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
            <span class="n">iaxo</span> <span class="o">=</span> <span class="n">iaxi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iaxo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">regrid1d</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">zo</span><span class="p">,</span> <span class="n">iaxi</span><span class="o">=</span><span class="n">iaxi</span><span class="p">,</span> <span class="n">iaxo</span><span class="o">=</span><span class="n">iaxo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="Dataset.plot_hsection"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.plot_hsection">[docs]</a>    <span class="k">def</span> <span class="nf">plot_hsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeavg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(long_name)s</span><span class="s1"> at </span><span class="si">%(depth)i</span><span class="s1">m&#39;</span><span class="p">,</span> <span class="n">mask_land</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot a horizontal section of a variable for a specified depth</span>

<span class="sd">        Section is computed with :meth:`get_hsection`.</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: Generic var name.</span>
<span class="sd">            - **depth**: Target depth.</span>
<span class="sd">            - **timeavg**, optional: Time average of results.</span>
<span class="sd">            - **depth_&lt;param&gt;**, optional: Param is passed to :meth:`get_depth`.</span>
<span class="sd">            - **interp_&lt;param&gt;**, optional: Param is passed to</span>
<span class="sd">              :meth:`~vacumm.misc.grid.regridding.interp1d`.</span>
<span class="sd">            - Other arguments are passed to :func:`~vacumm.misc.plot.map2`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get section</span>
        <span class="n">interp2depth</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">generic</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">interp2depth</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hsection</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span>
                <span class="n">timeavg</span><span class="o">=</span><span class="n">timeavg</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%(long_name)s</span><span class="s2"> at level &quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">start</span><span class="p">)))</span>

        <span class="c1"># Atmosphere : Mask fields to remove contours on land</span>
        <span class="k">if</span> <span class="n">mask_land</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">==</span><span class="s2">&quot;atmos&quot;</span><span class="p">:</span>
            <span class="n">land</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oro</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">land</span> <span class="o">&gt;</span> <span class="mf">0.</span>
            <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">land</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>



        <span class="c1"># Plot it</span>
        <span class="n">long_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">title</span><span class="p">,</span><span class="n">ctime</span><span class="p">))</span>
        <span class="n">dict_check_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">map2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="o">%</span><span class="nb">locals</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.squeeze_variable"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.squeeze_variable">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">squeeze_variable</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Squeeze a variable, preserving remaining axis</span>


<span class="sd">        :See also: :func:`vacumm.misc.misc.squeeze_variable`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Squeezing variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span></div>
        <span class="c1">#axes = [a for a in var.getAxisList() if a.shape[0] &gt; 1]</span>
        <span class="c1">#var = var.squeeze()</span>
        <span class="c1">#if numpy.size(var):</span>
            <span class="c1">#var.setAxisList(axes)</span>
        <span class="c1">#return var</span>

<div class="viewcode-block" id="Dataset.toloc"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.toloc">[docs]</a>    <span class="k">def</span> <span class="nf">toloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">fromloc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate a variable to another location</span>

<span class="sd">        It has no effect if the current :class:`Dataset` instance has no valid</span>
<span class="sd">        :attr:`arakawa_grid_type` defined (``None``).</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **var**: A CDAT array.</span>
<span class="sd">            - **loc**: A physical location (see :attr:`vacumm.data.misc.arakawa.ARAKAWA_LOCATIONS`).</span>
<span class="sd">            - **fromloc**, optional: Originating location. If ``None`` it is guessed</span>
<span class="sd">              from its attributes (id, standard_name and long_name), and default</span>
<span class="sd">              to :attr:`~vacumm.data.cf.DEFAULT_LOCATION`).</span>
<span class="sd">            - Extra keywords are passed to</span>
<span class="sd">              :meth:`vacumm.data.misc.arakawa.ArakawaGrid.loc2loc`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No grid type</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">get_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">HIDDEN_CF_ATTS</span><span class="o">+</span><span class="n">cdms2_arakawa_atts</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid_type</span><span class="p">:</span><span class="c1"># or var.getGrid() is None:</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">atts</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># Originating location</span>
        <span class="k">if</span> <span class="n">fromloc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fromloc</span> <span class="o">=</span> <span class="n">get_loc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ext&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fromloc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fromloc</span> <span class="o">=</span> <span class="n">DEFAULT_LOCATION</span>

        <span class="c1"># Interpolate</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fromloc</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Reformat location</span>
        <span class="n">change_loc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="Dataset.finalize_object"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.finalize_object">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">genname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">curvsel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize a variable or an axis</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **genname**, optional: Generic name to format the variable.</span>
<span class="sd">            - **format**, optional: Format the variable and its axes with</span>
<span class="sd">              :func:`~vacumm.data.cf.format_var`?</span>
<span class="sd">            - **atts**, optional: Set these attributes to the variable.</span>
<span class="sd">            - **squeeze**, optional: If not False, squeeze singletons axes using</span>
<span class="sd">              :func:`~vacumm.misc.misc.squeeze_variable`.</span>
<span class="sd">            - **order**, optional: If not None, change the axes order of the variable.</span>
<span class="sd">              It must contains letters like &#39;txyz-&#39;.</span>
<span class="sd">            - **asvar**, optional: Grow variable to match the ``asvar`` variable,</span>
<span class="sd">              using :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **asvar_&lt;param&gt;**: Param passed to :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **torect**, optinal: Try to convert curvilinear grid to rectangular</span>
<span class="sd">              grid using :func:`~vacumm.misc.grid.misc.curv2rect`.</span>
<span class="sd">            - **lon/lat**, optional: Additional spatial selection.</span>
<span class="sd">            - **curvsel**, optional: :class:`CurvedSelector` instance.</span>
<span class="sd">            - **at/toloc**: Interpolate the variable to another location on the grid</span>
<span class="sd">              using :meth:`toloc`. Note that the :attr:`arakawa_grid_type` must be defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">kwasvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;asvar_&#39;</span><span class="p">)</span>
        <span class="n">kwat</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;at_&#39;</span><span class="p">)</span>
        <span class="n">kwat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;toloc_&#39;</span><span class="p">))</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;toloc&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">atts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>

            <span class="c1"># Curved selector</span>
            <span class="k">if</span> <span class="n">curvsel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">curvsel</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="c1"># Format</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">and</span> <span class="p">(</span><span class="n">genname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span><span class="p">):</span>
                <span class="n">format_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">genname</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atts</span><span class="p">:</span>
                <span class="n">set_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">)</span>

            <span class="c1"># Squeeze singletons.</span>
            <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Squeezing variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">asmv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Reorder</span>
            <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reordering variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

            <span class="c1"># Rectangular if possible</span>
            <span class="k">if</span> <span class="n">torect</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torect</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">curvsel</span><span class="p">)</span>

            <span class="c1"># At/toloc</span>
            <span class="k">if</span> <span class="n">at</span><span class="p">:</span>
                <span class="n">kwat</span><span class="p">[</span><span class="s1">&#39;copy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toloc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="o">**</span><span class="n">kwat</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">format</span> <span class="ow">and</span> <span class="p">(</span><span class="n">genname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">CF_VAR_SPECS</span><span class="p">):</span>
            <span class="n">format_axis</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">genname</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">atts</span><span class="p">:</span>
            <span class="n">set_atts</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">)</span>


        <span class="c1"># Grow variables or axes</span>
        <span class="k">if</span> <span class="n">asvar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">asvar</span><span class="p">):</span>
                <span class="n">asvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asvar</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">grow_variables</span><span class="p">(</span><span class="n">asvar</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwasvar</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Not an axis</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isaxis</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>

            <span class="c1"># Post spatial selection</span>
            <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">create_selector</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">))</span>

            <span class="c1"># Some attributes</span>
            <span class="n">set_grid_type</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arakawa_grid_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="Dataset.torect"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.Dataset.torect">[docs]</a>    <span class="k">def</span> <span class="nf">torect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">curvsel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place a variable on rectangular grid if possible using</span>
<span class="sd">        :func:`~vacumm.misc.grid.regridding.curv2rect`</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **var**: CDAT variable or grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the grid</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">var</span> <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># Ids</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="n">lonid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">latid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;_oldid&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">lonid</span><span class="p">,</span> <span class="n">latid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvsel</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="n">curvsel</span><span class="o">.</span><span class="n">geosels</span><span class="p">,</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="c1"># Check cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rgrids&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rgrids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rgrids</span><span class="p">:</span>
<span class="c1">#            print &#39;datset: got rect from cache&#39;</span>
            <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rgrids</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
            <span class="n">set_grid</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rgrids</span><span class="p">[</span><span class="n">ids</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># Estimate it</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">curv2rect</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="c1"># Cache it if rectangular</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">var</span> <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">curv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="c1">#            print &#39;dataset: we cache rect&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rgrids</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>

        <span class="k">return</span> <span class="n">var</span></div></div>




<span class="c1">############################################################################</span>
<span class="c1">### OCEAN AND ATMOS</span>
<span class="c1">############################################################################</span>

<div class="viewcode-block" id="AtmosSurfaceDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosSurfaceDataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">AtmosSurfaceDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;atmossurface&#39;</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nethf&#39;</span><span class="p">,</span> <span class="s1">&#39;senhf&#39;</span><span class="p">,</span> <span class="s1">&#39;hfsen&#39;</span><span class="p">,</span> <span class="s1">&#39;lathf&#39;</span><span class="p">,</span> <span class="s1">&#39;hflat&#39;</span><span class="p">,</span> <span class="s1">&#39;swhf&#39;</span><span class="p">,</span> <span class="s1">&#39;lwhf&#39;</span><span class="p">,</span> <span class="s1">&#39;evap&#39;</span><span class="p">,</span> <span class="s1">&#39;rain&#39;</span><span class="p">,</span>
        <span class="s1">&#39;taux&#39;</span><span class="p">,</span> <span class="s1">&#39;tauy&#39;</span><span class="p">,</span> <span class="s1">&#39;u10m&#39;</span><span class="p">,</span> <span class="s1">&#39;v10m&#39;</span><span class="p">,</span> <span class="s1">&#39;t2m&#39;</span><span class="p">,</span> <span class="s1">&#39;hu2m&#39;</span><span class="p">,</span> <span class="s1">&#39;z0a&#39;</span><span class="p">,</span> <span class="s1">&#39;cda&#39;</span><span class="p">,</span> <span class="s1">&#39;cha&#39;</span><span class="p">,</span> <span class="s1">&#39;cea&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="OceanSurfaceDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanSurfaceDataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">OceanSurfaceDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;oceansurface&#39;</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;sss&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;usurf&#39;</span><span class="p">,</span> <span class="s1">&#39;vsurf&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WaveSurfaceDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.WaveSurfaceDataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">WaveSurfaceDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wave&#39;</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span><span class="s1">&#39;mss&#39;</span><span class="p">,</span><span class="s1">&#39;mssx&#39;</span><span class="p">,</span><span class="s1">&#39;mssy&#39;</span><span class="p">,</span><span class="s1">&#39;mss&#39;</span><span class="p">,</span><span class="s1">&#39;dir&#39;</span><span class="p">,</span><span class="s1">&#39;fp&#39;</span><span class="p">,</span><span class="s1">&#39;t0m1&#39;</span><span class="p">,</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ubot&#39;</span><span class="p">,</span><span class="s1">&#39;uubr&#39;</span><span class="p">,</span><span class="s1">&#39;vubr&#39;</span><span class="p">,</span><span class="s1">&#39;bhd&#39;</span><span class="p">,</span><span class="s1">&#39;foc&#39;</span><span class="p">,</span><span class="s1">&#39;utwo&#39;</span><span class="p">,</span><span class="s1">&#39;vtwo&#39;</span><span class="p">,</span><span class="s1">&#39;utaw&#39;</span><span class="p">,</span><span class="s1">&#39;vtaw&#39;</span><span class="p">,</span><span class="s1">&#39;uuss&#39;</span><span class="p">,</span><span class="s1">&#39;vuss&#39;</span><span class="p">,</span><span class="s1">&#39;utus&#39;</span><span class="p">,</span><span class="s1">&#39;vtus&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fbb&#39;</span><span class="p">,</span><span class="s1">&#39;utbb&#39;</span><span class="p">,</span><span class="s1">&#39;vtbb&#39;</span><span class="p">,</span><span class="s1">&#39;mapsta&#39;</span><span class="p">,</span><span class="s1">&#39;bathy&#39;</span><span class="p">,</span><span class="s1">&#39;wlv&#39;</span><span class="p">,</span><span class="s1">&#39;ucur&#39;</span><span class="p">,</span><span class="s1">&#39;vcur&#39;</span><span class="p">,</span><span class="s1">&#39;uwnd&#39;</span><span class="p">,</span><span class="s1">&#39;vwnd&#39;</span><span class="p">,</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span><span class="s1">&#39;cha&#39;</span><span class="p">,</span><span class="s1">&#39;utaw&#39;</span><span class="p">,</span><span class="s1">&#39;vtaw&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="OceanDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">OceanDataset</span><span class="p">(</span><span class="n">OceanSurfaceDataset</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ocean&#39;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;ocean&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Generic ocean dataset&#39;</span>
    <span class="n">default_depth_search_mode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;sal&#39;</span><span class="p">,</span> <span class="s1">&#39;u3d&#39;</span><span class="p">,</span> <span class="s1">&#39;v3d&#39;</span><span class="p">,</span> <span class="s1">&#39;ubt&#39;</span><span class="p">,</span> <span class="s1">&#39;vbt&#39;</span><span class="p">,</span> <span class="s1">&#39;kz&#39;</span><span class="p">,</span> <span class="s1">&#39;bathy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;eke&#39;</span><span class="p">,</span> <span class="s1">&#39;tke&#39;</span><span class="p">]</span>



    <span class="k">def</span> <span class="nf">_parse_selects_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>

        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">squeeze</span>



    <span class="k">def</span> <span class="nf">_parse_level_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Convert level argument from string</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>

            <span class="c1"># Selector</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;surf&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">surf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">()</span> <span class="k">else</span> <span class="n">bottom</span>
            <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">bottom</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">()</span> <span class="k">else</span> <span class="n">surf</span>
            <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;3d&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatasetError</span><span class="p">(</span><span class="s1">&#39;Invalid level selector string: &#39;</span><span class="o">+</span><span class="n">level</span><span class="p">)</span>

            <span class="c1"># Squeeze Z dim</span>
            <span class="n">squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="n">merge_squeeze_specs</span><span class="p">(</span><span class="n">squeeze</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span>

<div class="viewcode-block" id="OceanDataset.get_selector"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_selector">[docs]</a>    <span class="k">def</span> <span class="nf">get_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Argument</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="n">selector</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">selector</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">selectors</span><span class="o">.</span><span class="n">Selector</span><span class="p">):</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">squeeze</span> <span class="o">=</span> <span class="n">squeeze</span>

        <span class="k">return</span> <span class="n">selector</span></div>

    <span class="n">get_selector</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_selector</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="OceanDataset.finalize_object"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.finalize_object">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">depthup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize a variable</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **squeeze**, optional: If not False, squeeze singletons axes using</span>
<span class="sd">              :func:`~vacumm.misc.misc.squeeze_variable`.</span>
<span class="sd">            - **order**, optional: If not None, change the axes order of the variable.</span>
<span class="sd">              It must contains letters like &#39;txyz-&#39;.</span>
<span class="sd">            - **asvar**, optional: Grow variable to match the ``asvar`` variable,</span>
<span class="sd">              using :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **asvar_&lt;param&gt;**: Param passed to :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **torect**, optinal: Try to convert curvilinear grid to rectangular</span>
<span class="sd">              grid using :func:`~vacumm.misc.grid.misc.curv2rect`.</span>
<span class="sd">            - **depthup**, optional: If not False, try the make depth positive up</span>
<span class="sd">              using :func:`~vacumm.misc.grid.misc.makedepthup`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Make depth positive up</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
            <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">depthup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_makedepthup_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depthup</span><span class="p">)</span>

        <span class="c1"># Generic stuff</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="n">asvar</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span></div>


    <span class="k">def</span> <span class="nf">_get_dz_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness&quot;&quot;&quot;</span>
        <span class="n">atp</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># forward warning</span>

        <span class="c1"># First, find a variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;dz&#39;</span><span class="o">+</span><span class="n">atp</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span> <span class="n">dz</span>

        <span class="c1"># Second, guess from vertical coordinates</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="c1"># - read depths</span>
            <span class="n">dz2dmode</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">loc</span> <span class="ow">in</span> <span class="s1">&#39;tr&#39;</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;-dz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># from W points</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;-dz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># from T points</span>
                    <span class="n">dz2dmode</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
            <span class="k">elif</span> <span class="n">loc</span><span class="o">==</span><span class="s1">&#39;w&#39;</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;-dz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># from T points</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;-dz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># from W points</span>
                    <span class="n">dz2dmode</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Computing dz from depths at points other than T and W is yet not implemented&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get depth to compute dz&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># - compute thicknesses</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">format_var</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="s1">&#39;dz&#39;</span><span class="o">+</span><span class="n">atp</span><span class="p">)</span>
            <span class="n">isup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># At T from W depth</span>
                <span class="n">dz2dmode</span><span class="o">=</span> <span class="s1">&#39;top&#39;</span> <span class="k">if</span> <span class="n">isup</span> <span class="k">else</span> <span class="s1">&#39;bottom&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># At W from T depth</span>
                <span class="n">dz2dmode</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">isup</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span>
            <span class="n">dz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">depth2dz</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">dz2dmode</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dz</span>

    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;depth&quot;``: Estimate from depth (see :meth:`get_depth`)</span>

<span class="s2">          You can also negate the search with</span>
<span class="s2">          a &#39;-&#39; sigme before: ``&quot;-depth&quot;``.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OceanDataset.get_dz"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dz">[docs]</a>    <span class="k">def</span> <span class="nf">get_dz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness testing all locations&quot;&quot;&quot;</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwarn</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;tuvw&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dz_</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dz</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get dz at location &quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">)</span></div>
    <span class="n">get_dz</span> <span class="o">=</span> <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dz</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_dz_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dz_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_dz_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness at T location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dz_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">get_dz_t</span> <span class="o">=</span> <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dz_t</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_dz_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dz_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_dz_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness at U location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dz_</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dz_u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_dz_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dz_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_dz_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness at V location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dz_</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dz_v</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_dz_w"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dz_w">[docs]</a>    <span class="k">def</span> <span class="nf">get_dz_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer thickness at W location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dz_</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dz_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">_mode_doc</span>


<div class="viewcode-block" id="OceanDataset.get_variable"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">get_variable</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_variable</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="nf">_isdepthup_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Guess if depths are positive up&quot;&quot;&quot;</span>
        <span class="c1"># Cache</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="o">==</span><span class="s1">&#39;up&#39;</span>

        <span class="c1"># Get depth</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># no depth = no problem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Guess</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">isup</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
        <span class="k">return</span> <span class="n">isup</span>

    <span class="k">def</span> <span class="nf">_makedepthup_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make depths positive up&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">isdep</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isup</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">if</span> <span class="n">isdep</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">makedepthup</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">makedepthup</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_depth_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zerolid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">formula_terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">depth</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_depth_search_mode</span>

        <span class="c1"># Where?</span>
        <span class="n">at_p</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">atz</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;ver&#39;</span><span class="p">)</span>
        <span class="n">at_z</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;ver&#39;</span><span class="p">)</span>
        <span class="n">at_xy</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">)</span>

        <span class="c1"># Setup keywords</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="n">asvar</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">at</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwvar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwfinal</span><span class="p">)</span>
        <span class="n">kwvarnoat</span> <span class="o">=</span> <span class="n">kwvar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwvarnoat</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">)</span>

        <span class="c1"># First, try to find a depth variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="o">+</span><span class="n">at_p</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makedepthup_</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Get selector for other tries</span>
        <span class="n">sselector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
        <span class="n">seltimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seltimes</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="c1">#        selnotime = None</span>
        <span class="n">gridmet</span> <span class="o">=</span> <span class="s1">&#39;get_grid&#39;</span><span class="o">+</span><span class="n">at_xy</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridmet</span><span class="p">)()</span><span class="c1">#False)</span>
        <span class="n">curvsel</span> <span class="o">=</span> <span class="n">CurvedSelector</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">sselector</span><span class="p">)</span>
        <span class="n">kwfinal</span><span class="p">[</span><span class="s1">&#39;curvsel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curvsel</span>
        <span class="n">kwfinal</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genname</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span> <span class="o">+</span> <span class="n">at_p</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seltimes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">kwfinal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">seltimes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kwfinalz</span> <span class="o">=</span> <span class="n">kwfinal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">at_p</span> <span class="ow">and</span> <span class="n">at_z</span><span class="o">!=</span><span class="n">at_p</span><span class="p">:</span> <span class="c1"># from T or W to U, etc</span>
            <span class="n">kwfinalz</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genname</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span> <span class="o">+</span> <span class="n">at_z</span>
            <span class="n">kwfinalz</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span>

        <span class="c1"># Second, try from sigma-like coordinates at W and T points only (for now)</span>
        <span class="k">if</span> <span class="n">formula_terms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formula_terms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;formula_terms&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">sigma_converter</span> <span class="o">=</span> <span class="n">NcSigma</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">formula_terms</span><span class="o">=</span><span class="n">formula_terms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">sigma_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_converter</span><span class="o">.</span><span class="n">stype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sigma_converter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sigma_converter</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">sigma_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found depth referring to a sigma level, processing sigma to depth conversion&#39;</span><span class="p">)</span>
                <span class="n">allvars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">slice</span><span class="p">):</span>
                    <span class="n">nib</span> <span class="o">=</span> <span class="n">NcIterTimeSlice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">tslice</span><span class="o">=</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nib</span> <span class="o">=</span> <span class="n">NcIterBestEstimate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nibeid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">tslice</span> <span class="ow">in</span> <span class="n">nib</span><span class="p">:</span>

                    <span class="c1"># - init</span>
                    <span class="k">if</span> <span class="n">tslice</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">continue</span> <span class="c1"># and when no time??? None-&gt; ok we continue</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">sigma_converter</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">tslice</span><span class="p">)</span>
<span class="c1">#                    if selnotime is None:</span>
<span class="c1">#                        selnotime = filter_time_selector(selector, ids=nib.timeid, out=True)</span>
<span class="c1">#                    sel.refine(selnotime)</span>
                    <span class="n">sel</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">sselector</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;- dataset: </span><span class="si">%s</span><span class="s1">: sigma: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">sigma_converter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>

                    <span class="c1"># - try it</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">sigma_converter</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">atz</span><span class="p">,</span> <span class="n">copyaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
                            <span class="n">zerolid</span><span class="o">=</span><span class="n">zerolid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get depth from sigma. Error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sigma to depth result: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="n">allvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="c1"># Concatenate loaded depth</span>
                <span class="k">if</span> <span class="n">allvars</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">MV2_concatenate</span><span class="p">(</span><span class="n">allvars</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinalz</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span>
<span class="c1">#        if sigma_converter is not None:</span>
<span class="c1">#            sigma_converter.close()</span>

        <span class="c1"># Third, estimate from layer thickness</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;dz&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">atz</span><span class="o">==</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="c1"># at T-location</span>
                <span class="n">dzw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dz_w</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvarnoat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dzw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bathy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bathy</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bathy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dzw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">depth</span> <span class="o">=</span> <span class="n">dz2depth</span><span class="p">(</span><span class="n">dzw</span><span class="p">,</span> <span class="n">bathy</span><span class="p">,</span> <span class="n">refloc</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">atz</span><span class="o">==</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="c1"># at W-location</span>

                <span class="n">dzt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dz_t</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvarnoat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dzt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ssh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ssh</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ssh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dzt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">depth</span> <span class="o">=</span> <span class="n">dz2depth</span><span class="p">(</span><span class="n">dzt</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">refloc</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;dz&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinalz</span><span class="p">)</span>

        <span class="c1"># Finally, find a depth axis</span>
        <span class="k">if</span> <span class="n">sigma_converter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;axis&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span> <span class="c1"># no Z axis for sigma coordinates</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="o">+</span><span class="n">at_p</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">format</span><span class="p">:</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">format_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="o">+</span><span class="n">at_p</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Found no way to estimate depths at </span><span class="si">%s</span><span class="s1"> location&#39;</span><span class="o">%</span><span class="n">at</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>


    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;sigma&quot;``: Estimate from sigma coordinates.</span>
<span class="s2">          - ``&quot;dz&quot;``: Estimate from layer thinknesses (see :meth:`get_dz`)</span>
<span class="s2">          - ``&quot;axis&quot;``: Read it from an axis (if not sigma coordinates)</span>

<span class="s2">          You can specifiy a list of them: ``[&#39;dz&#39;, &#39;sigma&#39;]``</span>
<span class="s2">          You can also negate the search with</span>
<span class="s2">          a &#39;-&#39; sigme before: ``&quot;-dz&quot;``.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="OceanDataset.get_depth"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_depth">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer depth testing all locations&quot;&quot;&quot;</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwarn</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;tuvw&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">depth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get depth at location &quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_depth</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_depth_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_depth_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get depth at T location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_depth_t</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_depth_w"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_depth_w">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get depth at W location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_depth_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_depth_u"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_depth_u">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get depth at U location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_depth_u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="OceanDataset.get_depth_v"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_depth_v">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get depth at V location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_depth_</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_depth_v</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">_mode_doc</span>


    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;tempsal&quot;``: Estimate from temperature and salinity.&quot;&quot;&quot;</span>
    <span class="n">_extra_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dens_&lt;param&gt;&#39;</span><span class="p">:</span><span class="s1">&#39;Passed to :func:`~vacumm.diag.thermdyn.density&#39;</span><span class="p">,</span>
        <span class="s1">&#39;depth_&lt;param&gt;&#39;</span><span class="p">:</span><span class="s1">&#39;Passed to :meth:`get_depth`&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="n">_mode_doc</span><span class="p">}</span>

<div class="viewcode-block" id="OceanDataset.get_dens"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_dens">[docs]</a>    <span class="k">def</span> <span class="nf">get_dens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">potential</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get 4D density&#39;&#39;&#39;</span>


        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;torect&#39;</span><span class="p">],</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;asvar&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">],</span> <span class="n">genname</span><span class="o">=</span><span class="s1">&#39;dens&#39;</span><span class="p">)</span>
        <span class="n">kwdens</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;dens_&#39;</span><span class="p">)</span>
        <span class="n">kwdepth</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;depth_&#39;</span><span class="p">)</span>
        <span class="n">kwdepth</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="n">kwdens</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">potential</span>

        <span class="c1"># First, try to find a dens variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># Estimate it from temperature and salinity</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;tempsal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_temp</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="n">sal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sal</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">potential</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="o">**</span><span class="n">kwdepth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">format_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;tempsal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to get density&#39;</span><span class="p">)</span></div>

    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_dens</span><span class="p">,</span> <span class="o">**</span><span class="n">_extra_doc</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">_extra_doc</span><span class="p">[</span><span class="s1">&#39;depth_&lt;param&gt;&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="OceanDataset.get_ssd"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_ssd">[docs]</a>    <span class="k">def</span> <span class="nf">get_ssd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get sea surface density&#39;&#39;&#39;</span>

        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;torect&#39;</span><span class="p">],</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;asvar&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">],</span> <span class="n">genname</span><span class="o">=</span><span class="s1">&#39;dens&#39;</span><span class="p">)</span>
        <span class="n">kwdens</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;dens_&#39;</span><span class="p">)</span>
        <span class="n">kwdens</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># First, try to find a ssd variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;ssd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># Estimate it from temperature and salinity</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;tempsal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">sst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sst</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="n">sss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sss</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ssd</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="n">sss</span><span class="p">,</span> <span class="n">format_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ssd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;tempsal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">ssd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to get surface density&#39;</span><span class="p">)</span></div>

    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_ssd</span><span class="p">,</span> <span class="o">**</span><span class="n">_extra_doc</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">_extra_doc</span><span class="p">,</span> <span class="n">_mode_doc</span>


    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;ssh&quot;``: Estimate from ssh.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OceanDataset.get_uvgbt"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_uvgbt">[docs]</a>    <span class="nd">@getvar_fmtdoc</span>
    <span class="k">def</span> <span class="nf">get_uvgbt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">getu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get zonal and meridional geostrophic velocity from SSH&quot;&quot;&quot;</span>
        <span class="c1"># Params</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;torect&#39;</span><span class="p">],</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;asvar&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">])</span>
        <span class="n">kwfinalu</span> <span class="o">=</span> <span class="n">kwfinal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwfinalu</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ugbt&#39;</span>
        <span class="n">kwfinalv</span> <span class="o">=</span> <span class="n">kwfinal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwfinalv</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;vgbt&#39;</span>
        <span class="n">kwssh</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;ssh_&#39;</span><span class="p">)</span>
        <span class="n">kwssh</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>

        <span class="c1"># First, try to find a variable</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">getu</span><span class="p">:</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;ugbt&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">getv</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;vgbt&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">()</span>
                <span class="k">if</span> <span class="n">getu</span><span class="p">:</span> <span class="n">res</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinalu</span><span class="p">),</span>
                <span class="k">if</span> <span class="n">getv</span><span class="p">:</span> <span class="n">res</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinalv</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Estimate it</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ssh</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dx_u</span><span class="p">(</span><span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dy_v</span><span class="p">(</span><span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">sshok</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ssh</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">]]</span>
            <span class="n">mstrict</span> <span class="o">=</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sshok</span> <span class="ow">or</span> <span class="n">mstrict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sshok</span><span class="p">:</span>
                    <span class="n">us</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">barotropic_geostrophic_velocity</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">dxy</span><span class="o">=</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>
                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">u</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mstrict</span> <span class="k">else</span> <span class="n">us</span><span class="p">),</span> <span class="o">**</span><span class="n">kwfinalu</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mstrict</span> <span class="k">else</span> <span class="n">vs</span><span class="p">),</span> <span class="o">**</span><span class="n">kwfinalv</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">()</span>
                <span class="k">if</span> <span class="n">getu</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="n">u</span><span class="p">,</span>
                <span class="k">if</span> <span class="n">getv</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="n">v</span><span class="p">,</span>
                <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t estimate barotropic geostrophic velocities&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OceanDataset.get_ugbt"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_ugbt">[docs]</a>    <span class="nd">@getvar_fmtdoc</span>
    <span class="k">def</span> <span class="nf">get_ugbt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get zonal barotropic geostrophic velocity from SSH&#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;getv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uvgbt</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OceanDataset.get_vgbt"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_vgbt">[docs]</a>    <span class="nd">@getvar_fmtdoc</span>
    <span class="k">def</span> <span class="nf">get_vgbt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get meridional barotropic geostrophic velocity from SSH&#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;getu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uvgbt</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;uvgbt&quot;``: Estimate from barotropic geostrophic velocity (:meth:`get_uvgbt`).&quot;&quot;&quot;</span>
<div class="viewcode-block" id="OceanDataset.get_ke"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_ke">[docs]</a>    <span class="k">def</span> <span class="nf">get_ke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get kinetic energy&quot;</span>

<span class="sd">        :See also: :func:`~vacumm.diag.dynamics.kinetic_energy`</span>
<span class="sd">            :meth:`get_uvgbt`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Params</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;torect&#39;</span><span class="p">],</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;asvar&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">],</span> <span class="n">genname</span><span class="o">=</span><span class="s1">&#39;ke&#39;</span><span class="p">)</span>
        <span class="n">kwuvgbt</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;uvgbt_&#39;</span><span class="p">)</span>
        <span class="n">kwuvgbt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>

        <span class="c1"># First, try to find a variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;ke&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># Estimate it</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;uvgbt&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">ugbt</span><span class="p">,</span> <span class="n">vgbt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uvgbt</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ugbt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;uvgbt&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">ke</span> <span class="o">=</span> <span class="n">kinetic_energy</span><span class="p">((</span><span class="n">ugbt</span><span class="p">,</span> <span class="n">vgbt</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t estimate the kinetic energy&quot;</span><span class="p">)</span></div>

    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_ke</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>


    <span class="c1">############################################################################</span>


<div class="viewcode-block" id="OceanDataset.get_layer"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_layer">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an horizontal section of a variable at a specified depth</span>

<span class="sd">        .. warning:: This method is now an alias for method :meth:`get_hsection`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_layer is deprecated by get_hsection&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Getting layer data&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  variable:  </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  depth:      </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  timeavg:      </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">timeavg</span><span class="p">)</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_hsection</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdesc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;out: &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span></div>



<div class="viewcode-block" id="OceanDataset.get_section"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_section">[docs]</a>    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a (vertical) section data along a straight trajectory, not necessary zonal or meridional.</span>

<span class="sd">        .. warning:: This method is deprecated by the :meth:`get_transect` method.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **varname**: variable to process</span>
<span class="sd">            - **xmin**: westernmost longitude coordinate</span>
<span class="sd">            - **ymin**: southernmost latitude coordinate</span>
<span class="sd">            - **xmax**: eastermost longitude coordinate</span>
<span class="sd">            - **ymax**: northernmost latitude coordinate</span>
<span class="sd">            - **timeavg**: if true, average date along time if needed</span>

<span class="sd">        :Return: A list containing in order:</span>
<span class="sd">            - var(level,position): section variable</span>
<span class="sd">            - depth(level) FOR 3D VARIABLES ONLY: depth corresponding to var&#39;s level</span>
<span class="sd">            - latitude(position): latitude corresponding to var&#39;s position</span>
<span class="sd">            - longitude(position): longitude corresponding to var&#39;s position</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get variable</span>
        <span class="n">tvar</span><span class="p">,</span> <span class="n">tlons</span><span class="p">,</span> <span class="n">tlats</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span>
            <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> found&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">varname</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">tvar</span><span class="p">]</span>

        <span class="c1"># Depth?</span>
        <span class="k">if</span> <span class="n">tvar</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tdep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span>
                <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tdep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No depth found&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdep</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">tlats</span><span class="p">,</span> <span class="n">tlons</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Final Section data:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="OceanDataset.get_hovmoller"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_hovmoller">[docs]</a>    <span class="k">def</span> <span class="nf">get_hovmoller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">outaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a hovmoller(time,position) section data along a straight trajectory, zonal or meridional.</span>

<span class="sd">        .. warning:: This method is deprecated and must be rewritten has a special case of</span>
<span class="sd">            method :meth:`get_transect`.</span>

<span class="sd">        Coordinates xorymin and xorymax are longitudes and xory a latitude if the section is zonal,</span>
<span class="sd">        latitudes and a longitude if the section is meridonal</span>

<span class="sd">        Level must be defined using the select parameter.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **varname**: variable to process</span>
<span class="sd">            - **xorymin**: westernmost longitude or southernmost latitude coordinate</span>
<span class="sd">            - **xorymax**: eastermost longitude or northernmost latitude coordinate</span>
<span class="sd">            - **xory**:  longitude or latitude coordinate</span>
<span class="sd">            - **meridional**:  if true, hovmoller is meridional, at a longitude and along given latitude range (default is zonal)</span>
<span class="sd">            - **lon/lat/level/time**: Selection.</span>
<span class="sd">            - Other keywords are passed to :meth:`get_transect`.</span>

<span class="sd">        :Return: A list containing in order:</span>
<span class="sd">            - var(time,position): hovmoller variable</span>
<span class="sd">            - latitude(position): latitude corresponding to var&#39;s position</span>
<span class="sd">            - longitude(position): longitude corresponding to var&#39;s position</span>

<span class="sd">        :Example:</span>
<span class="sd">            &gt;&gt;&gt;  get_hovmoller(self, &#39;sst&#39;, -10, -6, 47):</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Please use the more generic method get_transect&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Getting hovmoller data&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  variable:    </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymin:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymax:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xory:        </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  meridional:  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="p">)</span>

        <span class="c1"># Transect</span>
        <span class="n">kwts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="n">subsamp</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="n">timeavg</span><span class="p">,</span>
            <span class="n">outaxis</span><span class="o">=</span><span class="n">outaxis</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span> <span class="n">xory</span><span class="p">)</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">)</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span> <span class="n">xory</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get hovmoller&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">vo</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="n">ts</span>

<span class="c1">#        grid = self.get_grid(varname)</span>
<span class="c1">#        if grid is None:</span>
<span class="c1">#            raise Exception(&#39;No grid found&#39;)</span>
<span class="c1">#        xres, yres = resol(grid)</span>
<span class="c1">#        if select is None: select = dict()</span>
<span class="c1">#        if meridional:</span>
<span class="c1">#            subgrid = grid.subGridRegion((xorymin, xorymax, &#39;oo&#39;), (xory, xory, &#39;ccb&#39;))</span>
<span class="c1">#            xoryax = subgrid.getLatitude()[:]</span>
<span class="c1">#            select.update(longitude=(xory-xres, xory+xres, &#39;ccb&#39;), latitude=(xorymin-yres, xorymax+yres, &#39;ccb&#39;))</span>
<span class="c1">#            yo = numpy.concatenate(([xorymin], xoryax, [xorymax]))</span>
<span class="c1">#            xo = numpy.ones(len(yo)) * xory</span>
<span class="c1">#        else:</span>
<span class="c1">#            subgrid = grid.subGridRegion((xory, xory, &#39;ccb&#39;), (xorymin, xorymax, &#39;oo&#39;))</span>
<span class="c1">#            xoryax = subgrid.getLongitude()[:]</span>
<span class="c1">#            select.update(longitude=(xorymin-xres, xorymax+xres, &#39;ccb&#39;), latitude=(xory-yres, xory+yres, &#39;ccb&#39;))</span>
<span class="c1">#            xo = numpy.concatenate(([xorymin], xoryax, [xorymax]))</span>
<span class="c1">#            yo = numpy.ones(len(xo)) * xory</span>
<span class="c1">#</span>
<span class="c1">#        select = self.get_selector(select)</span>
<span class="c1">#        var = self.get_variable(varname, select=select, squeeze=True)</span>
<span class="c1">#        if var is None:</span>
<span class="c1">#            raise Exception(&#39;No %s found&#39;%(varname))</span>
<span class="c1">#</span>
<span class="c1">#        # interp var</span>
<span class="c1">#        vo = grid2xy(var, xo, yo, method=&#39;nat&#39;)</span>
<span class="c1">#</span>
<span class="c1">#        axes = vo.getAxisList()</span>
<span class="c1">#        if meridional:</span>
<span class="c1">#            axes[-1] = create_lat(yo)</span>
<span class="c1">#        else:</span>
<span class="c1">#            axes[-1] = create_lon(xo)</span>
<span class="c1">#        vo.setAxisList(axes)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">vo</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting longitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">xo</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting latitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">yo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">xo</span></div>

<div class="viewcode-block" id="OceanDataset.get_extrema_location"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_extrema_location">[docs]</a>    <span class="k">def</span> <span class="nf">get_extrema_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extrema</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get positions of min/max values of variable extremas along a straight trajectory, zonal or meridional.</span>

<span class="sd">        Coordinates xorymin and xorymax are longitudes and xory a latitude if the section is zonal,</span>
<span class="sd">        latitudes and a longitude if the section is meridonal</span>

<span class="sd">        Level must be defined using the select parameter.</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **varname**: variable to process</span>
<span class="sd">            - **xorymin**: westernmost longitude or southernmost latitude coordinate</span>
<span class="sd">            - **xorymax**: eastermost longitude or northernmost latitude coordinate</span>
<span class="sd">            - **xory**:  longitude or latitude coordinate</span>
<span class="sd">            - **meridional**:  if true, hovmoller is meridional, at a longitude and along given latitude range (default is zonal)</span>
<span class="sd">            - **extrema**: type of extrema, one of:</span>

<span class="sd">                - **min**: retrieve minimum values positions</span>
<span class="sd">                - **max**: retrieve maximum values positions</span>

<span class="sd">            - **select**: selector (should at least restrict to one level)</span>

<span class="sd">                - select=dict(level=slice(-1,None),time=slice(0,2))</span>

<span class="sd">        :Return: A list containing in order:</span>

<span class="sd">            - var(time,position): loaded variable  data</span>
<span class="sd">            - latitude(position): latitude corresponding to var&#39;s position</span>
<span class="sd">            - longitude(position): longitude corresponding to var&#39;s position</span>

<span class="sd">        :Example:</span>
<span class="sd">            &gt;&gt;&gt;  get_extrema_location(self, &#39;temp&#39;, -10, -6, 47, select=dict(level=slice(-1,None))):</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Getting extrema location data&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  variable:    </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymin:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymax:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xory:        </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  meridional:  </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  extrema:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  select:      </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="p">,</span> <span class="n">extrema</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="c1">#var, lat, lon = self.get_hovmoller(varname, xorymin, xorymax, xory, meridional, select)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;times&#39;</span><span class="p">])</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span><span class="n">xory</span><span class="p">),</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Squeezing variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="n">ex</span> <span class="o">=</span> <span class="n">extrema</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">exfunc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="p">,</span> <span class="s1">&#39;arg</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">exfunc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid extrema: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span>

        <span class="c1"># Position of extrema along time with masked values</span>
        <span class="c1">#iex = exfunc(var, axis=1, fill_value=-1)</span>
        <span class="n">iex</span> <span class="o">=</span> <span class="n">exfunc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#bad = iex == -1</span>

        <span class="c1"># Initialize localization variable</span>
        <span class="n">vo</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">vo</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Latitude of </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">vo</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>
            <span class="n">lonorlat</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vo</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Longitude of </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">vo</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
            <span class="n">lonorlat</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span>

        <span class="c1"># Fill with lon/lat coordinates</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">iex</span><span class="p">):</span>
            <span class="n">vo</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonorlat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Remasking</span>
        <span class="c1">#vo[:] = MV2.masked_where(bad, vo, copy=0)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">vo</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting longitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting latitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vo</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="OceanDataset.get_localized_computed_values"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_localized_computed_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_computed_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get min/max/mean values of a variable along a straight trajectory, zonal or meridional.</span>

<span class="sd">        Coordinates xorymin and xorymax are longitudes and xory a latitude if the section is zonal,</span>
<span class="sd">        latitudes and a longitude if the section is meridonal</span>

<span class="sd">        Level must be defined using the select parameter.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **varname**: variable to process</span>
<span class="sd">            - **xorymin**: westernmost longitude or southernmost latitude coordinate</span>
<span class="sd">            - **xorymax**: eastermost longitude or northernmost latitude coordinate</span>
<span class="sd">            - **xory**:  longitude or latitude coordinate</span>
<span class="sd">            - **meridional**:  if true, hovmoller is meridional, at a longitude and along given latitude range (default is zonal)</span>
<span class="sd">            - **operation**: type of operation, one of:</span>

<span class="sd">                - **min**: retrieve minimum values</span>
<span class="sd">                - **mean**: retrieve mean values</span>
<span class="sd">                - **max**: retrieve maximum values</span>

<span class="sd">            - **select**: selector (should at least restrict to one level)</span>

<span class="sd">                - select=dict(level=slice(-1,None),time=slice(0,2))</span>

<span class="sd">        :Return: A list containing in order:</span>
<span class="sd">            - var(time,position): loaded variable  data</span>
<span class="sd">            - latitude(position): latitude corresponding to var&#39;s position</span>
<span class="sd">            - longitude(position): longitude corresponding to var&#39;s position</span>

<span class="sd">        :Example:</span>
<span class="sd">            &gt;&gt;&gt;  get_localized_computed_values(self, &#39;temp&#39;, -10, -6, 47, select=dict(level=slice(-1,None))):</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Getting localized computed data&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  variable:    </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymin:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xorymax:     </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  xory:        </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  meridional:  </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  operation:   </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  select:      </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="c1">#var, lat, lon = self.get_hovmoller(varname, xorymin, xorymax, xory, meridional, select)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;times&#39;</span><span class="p">])</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span><span class="n">xory</span><span class="p">),</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Squeezing variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;avg&#39;</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid extrema: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">extrema</span><span class="p">))</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">MV2</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid operation: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">operation</span><span class="p">))</span>
        <span class="n">vo</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vo</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span>
        <span class="n">vo</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Resulting variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">vo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vo</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="OceanDataset.get_stratification_data"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_stratification_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_stratification_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">timeavg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get stratification data</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector</span>
<span class="sd">            - **timeavg**: if true, average date along time if needed</span>

<span class="sd">        :Return:</span>
<span class="sd">            - temp, sal, dens, depth, deltadepth with shape ([time],depth,latitude,longitude)</span>
<span class="sd">            - densmin, densmax, densmean with shape ([time],latitude,longitude)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_temp</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sal</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># TODO: depth may not have a time axis !</span>
        <span class="n">depth</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Initial stratification data for select=</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tzyx&#39;</span><span class="p">,</span><span class="s1">&#39;zyx&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid order: </span><span class="si">%s</span><span class="s1">, [t]zyx expected&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()))</span>
        <span class="k">def</span> <span class="nf">compute_strat</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Compute strat data for one time step&#39;&#39;&#39;</span>
            <span class="c1"># Epaisseurs</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ddepth</span> <span class="o">=</span> <span class="n">meshweights</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ddepth</span> <span class="o">=</span> <span class="n">ddepth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="c1"># Pression</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">csiro</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lat</span><span class="p">[:],</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="c1"># DensitÃ©</span>
            <span class="n">dens</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">csiro</span><span class="o">.</span><span class="n">dens</span><span class="p">(</span><span class="n">sal</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">pres</span><span class="p">)</span>
            <span class="c1"># DensitÃ© min/max</span>
            <span class="n">densmin</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">densmax</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># DensitÃ© moyenne</span>
            <span class="n">densmean</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">ddepth</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">ddepth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">getOrder</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Computing stratification along time&#39;</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Processing time: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_strat</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">sal</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">d</span><span class="p">]))</span>
            <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">ddepth</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">ddepth</span> <span class="o">=</span> <span class="n">compute_strat</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
        <span class="n">ddepth</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">ddepth</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
        <span class="n">densmin</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">densmin</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;densmin&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">densmax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">densmax</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;densmax&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">densmean</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">densmean</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;densmean&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ddepth</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">timeavg</span> <span class="ow">and</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">getOrder</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Averaging along time&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Averaging </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Final stratification data:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;deltatemp&quot;``: Estimate from a difference in temperature.</span>
<span class="s2">          - ``&quot;deltadens&quot;``: Estimate from a difference in density.</span>
<span class="s2">          - ``&quot;twolayers&quot;``: Shalow water mode with two density layers.</span>
<span class="s2">          - ``&quot;kz&quot;``: Depth where ks becomes low.</span>

<span class="s2">          You can specifiy a list of them: ``[&#39;deltadens&#39;, &#39;deltatemp&#39;]``</span>
<span class="s2">          You can also negate the search with</span>
<span class="s2">          a &#39;-&#39; sigme before: ``&quot;-kz&quot;``.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="OceanDataset.get_mld"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_mld">[docs]</a>    <span class="k">def</span> <span class="nf">get_mld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Params</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;torect&#39;</span><span class="p">])</span>
        <span class="n">kwvar</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">kwvar</span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwarn</span>
        <span class="n">kwdens</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;dens_&#39;</span><span class="p">)</span>
        <span class="n">kwdens</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="n">kwdens</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kwdepth</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;depth_&#39;</span><span class="p">)</span>
        <span class="n">kwdepth</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwvar</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwfinal</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;depthup&#39;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwmld</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mld_&#39;</span><span class="p">,</span>  <span class="s1">&#39;deltatemp&#39;</span><span class="p">,</span>  <span class="s1">&#39;deltadens&#39;</span><span class="p">,</span>  <span class="s1">&#39;kzmax&#39;</span><span class="p">])</span>

        <span class="c1"># First, try to find a MLD variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">mld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;mld&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">mld</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># Estimate it</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="o">**</span><span class="n">kwdepth</span><span class="p">)</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># - deltadens</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;deltatemp&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_temp</span><span class="p">(</span><span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mld</span> <span class="o">=</span> <span class="n">mixed_layer_depth</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;deltatemp&#39;</span><span class="p">,</span>
                    <span class="n">format_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwmld</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;deltatemp&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">mld</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># - deltadens and twolayers (density)</span>
        <span class="k">for</span> <span class="n">testmode</span> <span class="ow">in</span> <span class="s1">&#39;deltadens&#39;</span><span class="p">,</span> <span class="s1">&#39;twolayers&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="n">testmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dens</span><span class="p">(</span><span class="o">**</span><span class="n">kwdens</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mld</span> <span class="o">=</span> <span class="n">mixed_layer_depth</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">testmode</span><span class="p">,</span> <span class="n">format_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwmld</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="n">testmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">mld</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="c1"># - Kz</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;kz&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

            <span class="n">kz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kz</span><span class="p">(</span><span class="o">**</span><span class="n">kwdens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mld</span> <span class="o">=</span> <span class="n">mixed_layer_depth</span><span class="p">(</span><span class="n">kz</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kz&#39;</span><span class="p">,</span>
                    <span class="n">format_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwmld</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;twolayers&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">kwfinal</span><span class="p">[</span><span class="s1">&#39;depthup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">mld</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to get mixed layer depth with mode: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mode</span><span class="p">)</span></div>

    <span class="n">get_mld</span> <span class="o">=</span> <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_mld</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">,</span>
        <span class="n">deltatemp</span><span class="o">=</span><span class="s1">&#39;Temperature difference with surface.&#39;</span><span class="p">,</span>
        <span class="n">deltadens</span><span class="o">=</span><span class="s1">&#39;Density difference with surface&#39;</span><span class="p">,</span>
        <span class="n">kzmax</span><span class="o">=</span><span class="s1">&#39;Kz max for search for low values&#39;</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="OceanDataset.get_mixed_layer_depth"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_mixed_layer_depth">[docs]</a>    <span class="k">def</span> <span class="nf">get_mixed_layer_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get mixed layer depth</span>

<span class="sd">        .. warning:: This method is deprecated by :meth:`get_mld`.</span>

<span class="sd">        MLD is computed for each time step and then averaged</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector with at least a time component</span>

<span class="sd">        :Return:</span>
<span class="sd">            - mld with shape (latitude,longitude)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_mixed_layer_depth is deprecated by get_mld&#39;</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">mlds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_res</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mi">86400</span><span class="o">+</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected model time step: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">Intervals</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itv</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;co&#39;</span><span class="p">]</span>
            <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ddepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stratification_data</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># Profondeur max (max+demi Ã©paisseur)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ddepth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span>
            <span class="n">mld</span> <span class="o">=</span> <span class="n">H</span><span class="o">*</span><span class="p">(</span><span class="n">densmax</span><span class="o">-</span><span class="n">densmean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">densmax</span><span class="o">-</span><span class="n">densmin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MLD[time=</span><span class="si">%s</span><span class="s1">]: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">itv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">mld</span><span class="p">))</span>
            <span class="n">mlds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mld</span><span class="p">])</span>
        <span class="n">mlds</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mlds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mld</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">mlds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;MLD&#39;</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Mixed layer depth&#39;</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AVG MLD: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">mld</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mld</span></div>


<div class="viewcode-block" id="OceanDataset.get_potential_energy_deficit"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.get_potential_energy_deficit">[docs]</a>    <span class="k">def</span> <span class="nf">get_potential_energy_deficit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get potential energy deficit</span>

<span class="sd">        PED is computed for each time step and then averaged</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector with at least a time component</span>

<span class="sd">        :Return:</span>
<span class="sd">            - ped with shape (latitude,longitude)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">peds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_res</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mi">86400</span><span class="o">+</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected model time step: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">Intervals</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span>
            <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ddepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stratification_data</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># Anomalie de densitÃ©</span>
            <span class="n">danom</span> <span class="o">=</span> <span class="n">dens</span><span class="o">-</span><span class="n">densmean</span>
            <span class="c1"># Ãnergie potentielle disponible</span>
            <span class="n">ape</span> <span class="o">=</span> <span class="n">danom</span> <span class="o">*</span> <span class="n">GRAVITY</span>
            <span class="n">ape</span> <span class="o">*=</span> <span class="n">ddepth</span>
            <span class="c1"># Deficit</span>
            <span class="n">ped</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">ddepth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PED[time=</span><span class="si">%s</span><span class="s1">]: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">itv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ped</span><span class="p">))</span>
            <span class="n">peds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ped</span><span class="p">])</span>
        <span class="n">peds</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">peds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ped</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">peds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;PED&#39;</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;J.m^{-2}&#39;</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Potential energy deficit&quot;</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AVG PED: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ped</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ped</span></div>


    <span class="c1">############################################################################</span>


<div class="viewcode-block" id="OceanDataset.plot_trajectory_map"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_trajectory_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_trajectory_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the &quot;legend&quot; map of a trajectory using :func:`~vacumm.misc.plot.add_map_lines`</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **lon/lat**: Coordinates (in degrees) as 1D arrays.</span>
<span class="sd">        .. todo::</span>
<span class="sd">            - replace this method usage by vacumm.misc.plot.add_map_lines</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">varname</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;varname&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">glob_lon</span><span class="p">,</span> <span class="n">glob_lat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">getLatitude</span><span class="p">()</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">glob_lon</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">glob_lon</span><span class="p">)),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">glob_lat</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">glob_lat</span><span class="p">)),</span>
                <span class="n">axes_rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                <span class="n">drawmeridians_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">drawparallels_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                <span class="n">show</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># FIXME: make post_plot available for standalone trajectory plot ?</span>
        <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="c1"># The map itself</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># The section line</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mp</span></div>


<div class="viewcode-block" id="OceanDataset.plot_layer"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_layer">[docs]</a>    <span class="k">def</span> <span class="nf">plot_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot a layer</span>

<span class="sd">        .. warning:: This method is deprecated by :meth:`plot_hsection`.</span>

<span class="sd">        Params:</span>
<span class="sd">            - **map_&lt;keyword&gt;**: passed to :func:`~vacumm.misc.plot.map2`</span>
<span class="sd">            - **plot_&lt;keyword&gt;**: passed to created map :func:`post_plot`</span>

<span class="sd">        Other params are passed to :func:`get_layer`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;plot_layer is deprecated by plot_hsection&#39;</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mp</span><span class="p">:</span> <span class="n">mp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mp</span></div>


<div class="viewcode-block" id="OceanDataset.plot_section"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_section">[docs]</a>    <span class="k">def</span> <span class="nf">plot_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a section plot.</span>

<span class="sd">        .. warning:: This method is deprecated by :meth:`plot_transect`.</span>

<span class="sd">        :Params: see :func:`get_section`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **sec_&lt;keyword&gt;**: are passed to the section plot function :func:`~vacumm.misc.plot.section2` *excepting* those about post plotting described below</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        .. todo::</span>
<span class="sd">            - add lat/lon position lines indicator</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;plot_section is deprecated by plot_transect&#39;</span><span class="p">)</span>
        <span class="n">datakw</span>  <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="c1"># Get section data</span>
        <span class="n">var</span><span class="p">,</span><span class="n">dep</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">datakw</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compute scaling/informationnal data</span>
<span class="c1">#        vmin,vmax = numpy.min(var), numpy.max(var)</span>
<span class="c1">#        vstep = abs(vmax-vmin)/10.</span>
        <span class="n">dmin</span><span class="p">,</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dep</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
<span class="c1">#        dstep = abs(dmax-dmin)/10.</span>
<span class="c1">#        if dmax &gt; 0: dmax = 0</span>
<span class="c1">#        var, dep = var[::-1], dep[::-1]</span>
<span class="c1">#        print dep[::4,0]</span>
<span class="c1">#        print var[::4,0]</span>
        <span class="n">seckw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;contourf&#39;</span><span class="p">,</span>
                <span class="n">xlong_name</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="c1">#xmin=, xmax=,</span>
                <span class="c1">#xlim=(pos[0],pos[-1]), xfmt=&#39;%s&#39;, xtickfmt=&#39;%s&#39;,</span>
                <span class="n">ylong_name</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">yunits</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="c1">#ymin=dmin, ymax=dmax,</span>
                <span class="c1">#ylim=(dmin,dmax), ytickfmt=&#39;%s&#39;, yfmt=&#39;%s&#39;,</span>
                <span class="c1">#vmin=vmin, vmax=vmax, units=var.units,</span>
                <span class="c1">#colorbar_ticks=numpy.arange(vmin, vmax+vstep, vstep),</span>
                <span class="n">axes_rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the section</span>
        <span class="n">seckw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yaxis</span><span class="o">=</span><span class="n">dep</span><span class="p">,</span> <span class="n">levels_mode</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">section2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">seckw</span><span class="p">)</span>
<span class="c1">#        from vacumm.misc.plot import section</span>
<span class="c1">#        section(var, **seckw)</span>
        <span class="kn">from</span> <span class="nn">vacumm.misc.plot</span> <span class="k">import</span> <span class="n">add_grid</span>
        <span class="n">add_grid</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="n">dep</span><span class="p">))</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pmap</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_trajectory_map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Vertical section of </span><span class="si">%s</span><span class="se">\n</span><span class="s1">time: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">lon: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">select</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sc</span></div>


<div class="viewcode-block" id="OceanDataset.plot_hovmoller"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_hovmoller">[docs]</a>    <span class="k">def</span> <span class="nf">plot_hovmoller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a hovmoller plot.</span>

<span class="sd">        :Params: see :func:`get_hovmoller`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **hov_&lt;keyword&gt;**: are passed to the section plot function :func:`~vacumm.misc.plot.hov2` *excepting* those about post plotting described below</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">select</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">select</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Get section data</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span><span class="n">xory</span><span class="p">),</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">),</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transect</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xory</span><span class="p">,</span><span class="n">xory</span><span class="p">),</span> <span class="n">getcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subsamp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get transect on variable&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Squeezing variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="c1"># Compute scaling/informationnal data</span>
        <span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">vstep</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="n">meridional</span> <span class="ow">and</span> <span class="s1">&#39;Latitude&#39;</span> <span class="ow">or</span> <span class="s1">&#39;Longitude&#39;</span>
        <span class="n">hovkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;hov&#39;</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;contourf&#39;</span><span class="p">,</span>
                <span class="n">xlong_name</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">#xmin=, xmax=,</span>
                <span class="n">ylong_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">yunits</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">#ymin=dmin, ymax=dmax,</span>
                <span class="c1">#vmin=vmin, vmax=vmax, units=var.units,</span>
                <span class="c1">#colorbar_ticks=numpy.arange(vmin, vmax+vstep, vstep),</span>
                <span class="n">axes_rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">hovkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the section</span>
        <span class="n">hovkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time_vertical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">hv</span> <span class="o">=</span> <span class="n">hov2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">hovkw</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pmap</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_trajectory_map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">hovtype</span> <span class="o">=</span> <span class="s1">&#39;Meridional&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xory</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hovtype</span> <span class="o">=</span> <span class="s1">&#39;Zonal&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">)</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
            <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ct1</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2"> period&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get time information. Error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Hovmoller of </span><span class="si">%s</span><span class="se">\n</span><span class="s1">time: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hovtype</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)),</span> <span class="n">lonlat</span><span class="p">))</span>
        <span class="n">hv</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span></div>
        <span class="c1">#tight_layout()</span>


<div class="viewcode-block" id="OceanDataset.plot_extrema_location"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_extrema_location">[docs]</a>    <span class="k">def</span> <span class="nf">plot_extrema_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extrema</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce 1D plot of min/max positions.</span>

<span class="sd">        :Params: see :func:`get_extrema_location`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **cur_&lt;keyword&gt;**: are passed to the section plot function :func:`~vacumm.misc.plot.curve2` *excepting* those about post plotting described below</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">datakw</span>  <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="c1"># Get data</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extrema_location</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="p">,</span> <span class="n">extrema</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">datakw</span><span class="p">)</span>
        <span class="c1"># Compute scaling/informationnal data</span>
        <span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">vstep</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="n">meridional</span> <span class="ow">and</span> <span class="s1">&#39;Latitude&#39;</span> <span class="ow">or</span> <span class="s1">&#39;Longitude&#39;</span>
        <span class="n">curkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;cur&#39;</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">xlong_name</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xorymax</span><span class="p">,</span> <span class="c1">#xmin=vmin+vstep, xmax=vmax+vstep,</span>
                <span class="n">ylong_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="c1">#yunits=, #ymin=dmin, ymax=dmax,</span>
                <span class="c1">#vmin=vmin, vmax=vmax, units=var.units,</span>
                <span class="n">axes_rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">curkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the location curve</span>
        <span class="n">curkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">curve2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">curkw</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pmap</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_trajectory_map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">curtype</span> <span class="o">=</span> <span class="s1">&#39;Meridional&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xory</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curtype</span> <span class="o">=</span> <span class="s1">&#39;Zonal&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ct1</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> location of </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">time: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">curtype</span><span class="p">,</span> <span class="n">extrema</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)),</span> <span class="n">lonlat</span><span class="p">))</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="c1">#tight_layout()</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="OceanDataset.plot_localized_computed_values"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_localized_computed_values">[docs]</a>    <span class="k">def</span> <span class="nf">plot_localized_computed_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce 1D plot of min/max values.</span>

<span class="sd">        :Params: see :func:`get_localized_computed_values`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **cur_&lt;keyword&gt;**: are passed to the section plot function :func:`~vacumm.misc.plot.curve2` *excepting* those about post plotting described below</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">datakw</span>  <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="c1"># Get data</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_localized_computed_values</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">,</span> <span class="n">meridional</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">datakw</span><span class="p">)</span>
        <span class="c1"># Compute scaling/informationnal data</span>
        <span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">vstep</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">curkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;cur&#39;</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">xlong_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="c1">#xunits=, #xmin=, xmax=,</span>
                <span class="n">ylong_name</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="c1">#yunits=var.units, ymin=vmin, ymax=vmax,</span>
                <span class="c1">#vmin=vmin, vmax=vmax, units=var.units,</span>
                <span class="n">axes_rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">curkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the computed curve</span>
        <span class="n">curkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#, order=&#39;td&#39;)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">curve2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">curkw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pmap</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_trajectory_map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="k">if</span> <span class="n">meridional</span><span class="p">:</span>
            <span class="n">curtype</span> <span class="o">=</span> <span class="s1">&#39;Meridional&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xory</span><span class="p">,</span> <span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curtype</span> <span class="o">=</span> <span class="s1">&#39;Zonal&#39;</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="s1">&#39;lon: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">, lat: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xorymin</span><span class="p">,</span> <span class="n">xorymax</span><span class="p">,</span> <span class="n">xory</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="n">ct0</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ct1</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="se">\n</span><span class="s1">time: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">curtype</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ct0</span><span class="p">,</span><span class="n">ct1</span><span class="p">)),</span> <span class="n">lonlat</span><span class="p">))</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="OceanDataset.plot_mld"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_mld">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce mixed layer depth map.</span>

<span class="sd">        :Params: see :func:`get_mixed_layer_depth`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function</span>
<span class="sd">              :func:`~vacumm.misc.plot.map2` *excepting*</span>
<span class="sd">               those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post</span>
<span class="sd">              plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot`</span>
<span class="sd">              at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="n">mld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mixed_layer_depth</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">auto_scale</span><span class="p">((</span><span class="n">mld</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mld</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">cmap_magic</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="c1">#c = C.cmap_rainbow()</span>
        <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">c</span><span class="p">))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="n">mld</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="p">,</span><span class="n">c</span></div>


<div class="viewcode-block" id="OceanDataset.plot_ped"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.OceanDataset.plot_ped">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce potential energy deficit map.</span>

<span class="sd">        :Params: see :func:`get_potential_energy_deficit`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="n">ped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_potential_energy_deficit</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">auto_scale</span><span class="p">((</span><span class="n">ped</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ped</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">cmap_magic</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="c1">#c = C.cmap_rainbow()</span>
        <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">c</span><span class="p">))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="n">ped</span><span class="p">,</span> <span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="p">,</span><span class="n">c</span></div></div>

<div class="viewcode-block" id="AtmosDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset">[docs]</a><span class="nd">@getvar_decmets</span>
<span class="k">class</span> <span class="nc">AtmosDataset</span><span class="p">(</span><span class="n">AtmosSurfaceDataset</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;atmos&#39;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;atmos&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Generic atmospheric dataset&#39;</span>
    <span class="n">default_altitude_search_mode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># For auto-declaring methods</span>
    <span class="n">auto_generic_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;oro&#39;</span><span class="p">,</span><span class="s1">&#39;wdir&#39;</span><span class="p">,</span><span class="s1">&#39;wspd&#39;</span><span class="p">,</span><span class="s1">&#39;uair&#39;</span><span class="p">,</span><span class="s1">&#39;vair&#39;</span><span class="p">,</span><span class="s1">&#39;wair&#39;</span><span class="p">,</span><span class="s1">&#39;tair&#39;</span><span class="p">,</span><span class="s1">&#39;pa&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tkea&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_selects_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>

        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">squeeze</span>

    <span class="k">def</span> <span class="nf">_parse_level_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Convert level argument from string</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>

            <span class="c1"># Selector</span>
            <span class="n">top</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;surf&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">surf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">()</span> <span class="k">else</span> <span class="n">top</span>
            <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;top&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">top</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">()</span> <span class="k">else</span> <span class="n">surf</span>
            <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;3d&#39;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatasetError</span><span class="p">(</span><span class="s1">&#39;Invalid level selector string: &#39;</span><span class="o">+</span><span class="n">level</span><span class="p">)</span>

            <span class="c1"># Squeeze Z dim</span>
            <span class="n">squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="n">merge_squeeze_specs</span><span class="p">(</span><span class="n">squeeze</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span>

<div class="viewcode-block" id="AtmosDataset.get_selector"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.get_selector">[docs]</a>    <span class="k">def</span> <span class="nf">get_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Argument</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="n">selector</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">selector</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">selectors</span><span class="o">.</span><span class="n">Selector</span><span class="p">):</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">squeeze</span> <span class="o">=</span> <span class="n">squeeze</span>

        <span class="k">return</span> <span class="n">selector</span></div>

    <span class="n">get_selector</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_selector</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="AtmosDataset.finalize_object"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.finalize_object">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">depthup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize a variable</span>

<span class="sd">        :Params:</span>

<span class="sd">            - **squeeze**, optional: If not False, squeeze singletons axes using</span>
<span class="sd">              :func:`~vacumm.misc.misc.squeeze_variable`.</span>
<span class="sd">            - **order**, optional: If not None, change the axes order of the variable.</span>
<span class="sd">              It must contains letters like &#39;txyz-&#39;.</span>
<span class="sd">            - **asvar**, optional: Grow variable to match the ``asvar`` variable,</span>
<span class="sd">              using :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **asvar_&lt;param&gt;**: Param passed to :func:`~vacumm.misc.misc.grow_variables`.</span>
<span class="sd">            - **torect**, optinal: Try to convert curvilinear grid to rectangular</span>
<span class="sd">              grid using :func:`~vacumm.misc.grid.misc.curv2rect`.</span>
<span class="sd">            - **depthup**, optional: If not False, try the make depth positive up</span>
<span class="sd">              using :func:`~vacumm.misc.grid.misc.makedepthup`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Make depth positive up</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
            <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">depthup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_makealtitudeup_</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">altitude</span><span class="o">=</span><span class="n">depthup</span><span class="p">)</span>

        <span class="c1"># Generic stuff</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="n">asvar</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="AtmosDataset.get_variable"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_level_</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">get_variable</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">get_variable</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="nf">_isdepthup_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Guess if depths are positive up&quot;&quot;&quot;</span>
        <span class="c1"># Cache</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="o">==</span><span class="s1">&#39;up&#39;</span>

        <span class="c1"># Get depth</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># no depth = no problem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Guess</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="n">isdepthup</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">isup</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
        <span class="k">return</span> <span class="n">isup</span>

    <span class="k">def</span> <span class="nf">_makealtitudeup_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">altitude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make altitudes positive up&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">altitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">altitude</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">isdep</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">altitude</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">if</span> <span class="n">altitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="n">isup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdepthup_</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isup</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">if</span> <span class="n">isdep</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">makealtitudeup</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">makealtitudeup</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_altitude_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zerolid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">altitude</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_altitude_search_mode</span>

        <span class="c1"># Where?</span>
        <span class="n">at_p</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">atz</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;ver&#39;</span><span class="p">)</span>
        <span class="n">at_z</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;ver&#39;</span><span class="p">)</span>
        <span class="n">at_xy</span> <span class="o">=</span> <span class="n">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">)</span>

        <span class="c1"># Setup keywords</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwfinal</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="n">squeeze</span><span class="p">,</span> <span class="n">asvar</span><span class="o">=</span><span class="n">asvar</span><span class="p">,</span> <span class="n">torect</span><span class="o">=</span><span class="n">torect</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">at</span><span class="p">)</span>
        <span class="n">kwvar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">fwarn</span><span class="p">)</span>
        <span class="n">kwvar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwfinal</span><span class="p">)</span>
        <span class="n">kwvarnoat</span> <span class="o">=</span> <span class="n">kwvar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwvarnoat</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">)</span>

        <span class="c1"># First, try to find a altitude variable</span>
        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
            <span class="n">altitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;altitude&#39;</span><span class="o">+</span><span class="n">at_p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">altitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makealtitudeup_</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">altitude</span><span class="p">)</span>

        <span class="c1"># Get selector for other tries</span>
        <span class="n">sselector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
        <span class="n">seltimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seltimes</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="c1">#        selnotime = None</span>
        <span class="n">gridmet</span> <span class="o">=</span> <span class="s1">&#39;get_grid&#39;</span><span class="o">+</span><span class="n">at_xy</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridmet</span><span class="p">)()</span><span class="c1">#False)</span>
        <span class="n">curvsel</span> <span class="o">=</span> <span class="n">CurvedSelector</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">sselector</span><span class="p">)</span>
        <span class="n">kwfinal</span><span class="p">[</span><span class="s1">&#39;curvsel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curvsel</span>
        <span class="n">kwfinal</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genname</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span> <span class="o">+</span> <span class="n">at_p</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seltimes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">kwfinal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">seltimes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kwfinalz</span> <span class="o">=</span> <span class="n">kwfinal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">at_p</span> <span class="ow">and</span> <span class="n">at_z</span><span class="o">!=</span><span class="n">at_p</span><span class="p">:</span> <span class="c1"># from T or W to U, etc</span>
            <span class="n">kwfinalz</span><span class="p">[</span><span class="s1">&#39;genname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genname</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span> <span class="o">+</span> <span class="n">at_z</span>
            <span class="n">kwfinalz</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span>

        <span class="c1"># Second, try from sigma-like coordinates at W and T points only (for now)</span>
        <span class="n">sigma_converter</span> <span class="o">=</span> <span class="n">NcSigma</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">sigma_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_converter</span><span class="o">.</span><span class="n">stype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sigma_converter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sigma_converter</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">sigma_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found depth referring to a sigma level, processing sigma to depth conversion&#39;</span><span class="p">)</span>
                <span class="n">allvars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">slice</span><span class="p">):</span>
                    <span class="n">nib</span> <span class="o">=</span> <span class="n">NcIterTimeSlice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">tslice</span><span class="o">=</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nib</span> <span class="o">=</span> <span class="n">NcIterBestEstimate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">seltimes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nibeid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">tslice</span> <span class="ow">in</span> <span class="n">nib</span><span class="p">:</span>

                    <span class="c1"># - init</span>
                    <span class="k">if</span> <span class="n">tslice</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">continue</span> <span class="c1"># and when no time??? None-&gt; ok we continue</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">sigma_converter</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">create_selector</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">tslice</span><span class="p">)</span>
<span class="c1">#                    if selnotime is None:</span>
<span class="c1">#                        selnotime = filter_time_selector(selector, ids=nib.timeid, out=True)</span>
<span class="c1">#                    sel.refine(selnotime)</span>
                    <span class="n">sel</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">sselector</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;- dataset: </span><span class="si">%s</span><span class="s1">: sigma: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">sigma_converter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>

                    <span class="c1"># - try it</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">sigma_converter</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">atz</span><span class="p">,</span> <span class="n">copyaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
                            <span class="n">zerolid</span><span class="o">=</span><span class="n">zerolid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get altitude from sigma. Error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sigma to altitude result: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="n">allvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="c1"># Concatenate loaded depth</span>
                <span class="k">if</span> <span class="n">allvars</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">MV2_concatenate</span><span class="p">(</span><span class="n">allvars</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_object</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depthup</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwfinalz</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">check_mode</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Found no way to estimate depths at </span><span class="si">%s</span><span class="s1"> location&#39;</span><span class="o">%</span><span class="n">at</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="n">_mode_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Computing mode</span>

<span class="s2">          - ``None``: Try all modes, in the following order.</span>
<span class="s2">          - ``&quot;var&quot;``: Read it from a variable.</span>
<span class="s2">          - ``&quot;sigma&quot;``: Estimate from sigma coordinates.</span>
<span class="s2">          #not yet- ``&quot;dz&quot;``: Estimate from layer thinknesses (see :meth:`get_dz`)</span>
<span class="s2">          #not yet- ``&quot;axis&quot;``: Read it from an axis (if not sigma coordinates)</span>

<span class="s2">          #You can specifiy a list of them: ``[&#39;dz&#39;, &#39;sigma&#39;]``</span>
<span class="s2">          #You can also negate the search with</span>
<span class="s2">          #a &#39;-&#39; sigme before: ``&quot;-dz&quot;``.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AtmosDataset.get_altitude"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.get_altitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get layer altitude testing all locations&quot;&quot;&quot;</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">fwarn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">warn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwarn</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;tuvw&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
            <span class="n">altitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_altitude_</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">altitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">altitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get altitude at location &quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_altitude_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_altitude</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="AtmosDataset.get_altitude_t"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.get_altitude_t">[docs]</a>    <span class="k">def</span> <span class="nf">get_altitude_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get altitude at T location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_altitude_</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_altitude_t</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span>

<div class="viewcode-block" id="AtmosDataset.get_altitude_w"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.AtmosDataset.get_altitude_w">[docs]</a>    <span class="k">def</span> <span class="nf">get_altitude_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get altitude at W location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_altitude_</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">getvar_fmtdoc</span><span class="p">(</span><span class="n">get_altitude_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_mode_doc</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_at_</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">squeezet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert location letters&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">at</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="n">at</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>

    <span class="c1"># Aliases</span>
    <span class="k">if</span> <span class="n">at</span> <span class="ow">in</span> <span class="s1">&#39;rts&#39;</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>

    <span class="c1"># Focus on hor. or ver.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">focus</span><span class="o">==</span><span class="s2">&quot;hor&quot;</span> <span class="ow">or</span> <span class="n">focus</span><span class="o">==</span><span class="s1">&#39;h&#39;</span> <span class="ow">or</span> <span class="n">focus</span><span class="o">==</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">at</span> <span class="ow">in</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
    <span class="k">elif</span> <span class="n">focus</span><span class="o">==</span><span class="s2">&quot;ver&quot;</span> <span class="ow">or</span> <span class="n">focus</span><span class="o">==</span><span class="s1">&#39;z&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">at</span> <span class="ow">in</span> <span class="s1">&#39;uv&#39;</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
        <span class="k">elif</span> <span class="n">at</span> <span class="ow">in</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>

    <span class="c1"># Squeeze t</span>
    <span class="k">if</span> <span class="n">squeezet</span> <span class="ow">and</span> <span class="n">at</span><span class="o">==</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">at</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Prefix</span>
    <span class="k">if</span> <span class="n">at</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">at</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="n">at</span>

    <span class="k">return</span> <span class="n">at</span>

<div class="viewcode-block" id="check_mode"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.check_mode">[docs]</a><span class="k">def</span> <span class="nf">check_mode</span><span class="p">(</span><span class="n">validmodes</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check at least one of the checked modes is valid</span>

<span class="sd">    :Params:</span>

<span class="sd">        - **validmodes**: Valid modes as a single or list of strings.</span>
<span class="sd">        - **modes**: Modes to check. ``None`` is accepted.</span>
<span class="sd">        - **strict**, optional: If a checked mode is ``None``,</span>
<span class="sd">          it returns ``True`` if strict is ``True`` else ``False``.</span>

<span class="sd">    :Example:</span>

<span class="sd">        &gt;&gt;&gt; check_mode(&#39;var&#39;, &#39;var&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; validmodes = [&#39;var&#39;, &#39;depth&#39;]</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, &#39;toto&#39;)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, None)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, &#39;var&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, &#39;var&#39;, &#39;toto&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, [&#39;var&#39;, &#39;toto&#39;])</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_mode(validmodes, &#39;-axis&#39;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">validmodes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">validmodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">validmodes</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">modes</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strict</span> <span class="ow">and</span> <span class="n">rev</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">rev</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validmodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">rev</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">validmodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>

<span class="k">def</span> <span class="nf">_notuplist_</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert lists and tuples to single elements in dict (after copy)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dd</span>

<div class="viewcode-block" id="GenericDataset"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.GenericDataset">[docs]</a><span class="k">class</span> <span class="nc">GenericDataset</span><span class="p">(</span><span class="n">AtmosDataset</span><span class="p">,</span> <span class="n">OceanDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic :class:`Dataset` class to load everything&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;generic&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Generic dataset&#39;</span></div>

<div class="viewcode-block" id="CurvedSelector"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CurvedSelector">[docs]</a><span class="k">class</span> <span class="nc">CurvedSelector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Curved grid multiple selector&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geosels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_geosels</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geosels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_sel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">getLongitude</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geosels</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curv</span> <span class="ow">or</span> <span class="n">force</span><span class="p">):</span>
            <span class="n">islice</span><span class="p">,</span> <span class="n">jslice</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span>  <span class="n">coord2slice</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geosels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">islice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">islice</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="k">if</span> <span class="n">jslice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">jslice</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_geosels</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">xid</span> <span class="ow">or</span> <span class="n">grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yid</span> <span class="o">=</span> <span class="n">yid</span> <span class="ow">or</span> <span class="n">grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
            <span class="n">select</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xid</span><span class="p">:</span><span class="n">islice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yid</span><span class="p">:</span><span class="n">jslice</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_sel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">select</span>


<div class="viewcode-block" id="CurvedSelector.togrid"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CurvedSelector.togrid">[docs]</a>    <span class="k">def</span> <span class="nf">togrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a copy and put it on another grid with new xid and yid&quot;&quot;&quot;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s1">&#39;xid&#39;</span><span class="p">):</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">xid</span> <span class="ow">or</span> <span class="n">grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">yid</span> <span class="o">=</span> <span class="n">yid</span> <span class="ow">or</span> <span class="n">grid</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">cs</span></div>

<div class="viewcode-block" id="CurvedSelector.finalize"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CurvedSelector.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_sel</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geosels</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curv</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">var</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>  <span class="s1">&#39;Incomptible grids&#39;</span>
            <span class="n">islice</span><span class="p">,</span> <span class="n">jslice</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span>  <span class="n">coord2slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geosels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">islice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">islice</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="k">if</span> <span class="n">jslice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">jslice</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xid</span><span class="p">:</span><span class="n">islice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yid</span><span class="p">:</span><span class="n">jslice</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="CurvedSelector.extract_geosels"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CurvedSelector.extract_geosels">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_geosels</span><span class="p">(</span><span class="n">select</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert select to a list of (lon,lat) selection specs&quot;&quot;&quot;</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">components</span><span class="p">():</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">id</span><span class="o">==</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span>
                <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span><span class="o">==</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span>
                <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span></div>

<div class="viewcode-block" id="CurvedSelector.remove_geosels"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.CurvedSelector.remove_geosels">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_geosels</span><span class="p">(</span><span class="n">select</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove lon and lat component selections&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">components</span><span class="p">():</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">]:</span>
                <span class="n">select</span><span class="o">.</span><span class="n">_Selector__components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">select</span></div></div>


<div class="viewcode-block" id="merge_squeeze_specs"><a class="viewcode-back" href="../../../../library/data.misc.dataset.html#vacumm.data.misc.dataset.merge_squeeze_specs">[docs]</a><span class="k">def</span> <span class="nf">merge_squeeze_specs</span><span class="p">(</span><span class="n">squeeze1</span><span class="p">,</span> <span class="n">squeeze2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">squeeze1</span><span class="o">==</span><span class="n">squeeze2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">squeeze1</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">squeeze1</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">squeeze2</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">squeeze1</span> <span class="ow">or</span> <span class="n">squeeze1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s1</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">((</span><span class="n">squeeze2</span> <span class="ow">or</span> <span class="n">squeeze2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s2</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">s1</span> <span class="ow">and</span> <span class="n">s2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">squeeze1</span> <span class="o">+</span> <span class="n">squeeze2</span>
    <span class="k">if</span> <span class="n">s1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">squeeze1</span>
    <span class="k">if</span> <span class="n">s2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">squeeze2</span>
    <span class="k">return</span> <span class="n">s1</span> <span class="ow">or</span> <span class="n">s2</span></div>


<span class="c1"># Register dataset classes</span>
<span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GenericDataset</span><span class="p">,</span> <span class="n">OceanDataset</span><span class="p">,</span> <span class="n">AtmosDataset</span><span class="p">,</span> <span class="n">AtmosSurfaceDataset</span><span class="p">,</span>
        <span class="n">OceanSurfaceDataset</span><span class="p">,</span> <span class="n">WaveSurfaceDataset</span><span class="p">):</span>
    <span class="n">register_dataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../data.html" >vacumm.data</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>