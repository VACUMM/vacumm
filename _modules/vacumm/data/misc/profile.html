
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vacumm.data.misc.profile &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../../index.html"><img src="../../../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../data.html" accesskey="U">vacumm.data</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vacumm.data.misc.profile</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright or Â© or Copr. Actimar/IFREMER (2010-2015)</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to provide</span>
<span class="c1"># utilities for handling oceanographic and atmospheric data,</span>
<span class="c1"># with the ultimate goal of validating the MARS model from IFREMER.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>
<span class="c1">#</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Jonathan Wilkins&#39;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s1">&#39;wilkins@actimar.fr&#39;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s1">&#39;2015-02-27&#39;</span>
<span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">This module provides vertical profiles managers.</span>

<span class="s1">It is intented to be used with the two main goals:</span>

<span class="s1">- convert various profiles, eventually merged, to a standardized format</span>
<span class="s1">- operate on standardized profiles</span>

<span class="s1">The main classes are:</span>

<span class="s1">- :class:`Profile`: mainly used internally to store variables of one profile</span>
<span class="s1">- :class:`AbstractProfiles`: abstract base class used to handle a list of :class:`Profile`,</span>
<span class="s1">  it define what Profiles or other subclasses must implement to be used by other classes</span>
<span class="s1">  like :class:`ProfilesMerger`.</span>
<span class="s1">- :class:`Profiles`: concrete base class which implements the :class:`AbstractProfiles`:</span>
<span class="s1">  required methods. This class define a :meth:`Profiles.save` method which write a standardized</span>
<span class="s1">  NetCDF profiles file. It also define some utility methods like plotting utilities.</span>
<span class="s1">- :class:`ProfilesDuplicatesFilter`: a class used by default by :class:`ProfilesMerger`:</span>
<span class="s1">- :class:`ProfilesMerger`: split Profiles into unique / duplicate Profiles</span>
<span class="s1">- :class:`ProfilesDataset`:</span>

<span class="s1">Two classes may be used as a program entry point using their main class method:</span>

<span class="s1">- :func:`ProfilesMerger.main`</span>

<span class="s1">    - load profiles</span>
<span class="s1">    - save two profiles files: filtered (unique) and rejected (duplicates)</span>

<span class="s1">- :func:`ProfilesDataset.main`:</span>

<span class="s1">    - load a standardized profiles file</span>
<span class="s1">    - plot distribution, histogram and profile variables data</span>
<span class="s1">    - convert into a standardized profiles file format</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># NOTES</span>
<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1"># * Some profile time value are invalid (e.g. [&#39;1&#39; &#39;9&#39; &#39;9&#39; &#39;8&#39; &#39;0&#39; &#39;6&#39; &#39;0&#39; &#39;2&#39; &#39;9&#39; &#39;9&#39; &#39;9&#39; &#39;9&#39; &#39;0&#39; &#39;0&#39;]</span>
<span class="c1">#   in MANGA_SISMER_PR_CT.nc).</span>
<span class="c1">#   In this case, the time component will be set to 12H</span>
<span class="c1">#   Then when searching for duplicates, the first matching duplicate being in the</span>
<span class="c1">#   time range [T - N hours, T + N hours] will replace the time corrupted profile.</span>
<span class="c1">#   (with T the corrupted profile datetime and N a configurable number of hours)</span>
<span class="c1"># * Operations on masked values throws numpy warnings, this can be ignored with the following instruction</span>
<span class="c1">#     numpy.seterr(divide=&#39;ignore&#39;, over=&#39;ignore&#39;)</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<span class="c1"># TODO</span>
<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1"># ~ Add quality flag filter (multiple checks: on depth, time, pos and variable data)</span>
<span class="c1"># x Add platform_code variable and check</span>
<span class="c1"># * Add threshold in lat,lon duplicate test ?</span>
<span class="c1"># x Replace time corrupted profile with valid duplicate if any.</span>
<span class="c1"># x Duplicates file must also contain the profiles of valid file</span>
<span class="c1"># * Depth selection</span>
<span class="c1"># * Check output data values (precision)</span>
<span class="c1"># * Check loaded depth/pressure units for seawater conversions (m/db)</span>
<span class="c1"># ~ Standardize outputs (names and attributes)</span>
<span class="c1"># * Do not convert depth at loading time, let level data abstract until usage</span>
<span class="c1"># * Defer in memory data loads when possible (keep FileVariable object</span>
<span class="c1">#   =&gt; imply keeping files opened : warn about limitation on number of opened files)</span>
<span class="c1"># * Track side effect of data manipulations for an api usage</span>
<span class="c1"># * Opt: add util methods:</span>
<span class="c1">#   - Profiles.get_profile(profile_slice, level_slice)</span>
<span class="c1">#   - Profile.get_profile(level_slice)</span>
<span class="c1">#   - Variables unit checks</span>
<span class="c1">#   - Export variable mapping functionnality to a dedicated module</span>
<span class="c1"># ==============================================================================</span>

<span class="kn">import</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">optparse</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">cdms2</span><span class="o">,</span> <span class="nn">cdtime</span><span class="o">,</span> <span class="nn">MV2</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">pylab</span>
<span class="kn">from</span> <span class="nn">_geoslib</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>


<span class="kn">from</span> <span class="nn">vacumm.data.misc.dataset</span> <span class="k">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">POST_PLOT_ARGS</span><span class="p">,</span> <span class="n">OceanDataset</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">create_time</span><span class="p">,</span> <span class="n">ch_units</span><span class="p">,</span> <span class="n">comptime</span><span class="p">,</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">adatetime</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.atime</span> <span class="k">import</span> <span class="n">is_in_range</span> <span class="k">as</span> <span class="n">is_time_in_range</span><span class="p">,</span> <span class="n">reltime</span><span class="p">,</span> <span class="n">Intervals</span><span class="p">,</span> <span class="n">round_date</span><span class="p">,</span> <span class="n">add</span> <span class="k">as</span> <span class="n">add_date</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.axes</span> <span class="k">import</span> <span class="n">create</span><span class="p">,</span> <span class="n">create_time</span><span class="p">,</span> <span class="n">create_dep</span><span class="p">,</span> <span class="n">create_lat</span><span class="p">,</span> <span class="n">create_lon</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.bases</span> <span class="k">import</span> <span class="n">Object</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.color</span> <span class="k">import</span> <span class="n">cmap_magic</span><span class="p">,</span> <span class="n">StepsNorm</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.config</span> <span class="k">import</span> <span class="n">ConfigManager</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.exception</span> <span class="k">import</span> <span class="n">getDetailedExceptionInfo</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.file</span> <span class="k">import</span> <span class="n">find</span><span class="p">,</span> <span class="n">efind</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid</span> <span class="k">import</span> <span class="n">meshweights</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.masking</span> <span class="k">import</span> <span class="n">masked_polygon</span><span class="c1">#, polygons</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.grid.regridding</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.io</span> <span class="k">import</span> <span class="n">ncget_var</span><span class="p">,</span> <span class="n">netcdf3</span><span class="p">,</span> <span class="n">netcdf4</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.log</span> <span class="k">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.misc</span> <span class="k">import</span> <span class="n">kwfilter</span><span class="p">,</span> <span class="n">is_iterable</span>
<span class="kn">from</span> <span class="nn">vacumm.misc.plot</span> <span class="k">import</span> <span class="n">bar2</span><span class="p">,</span> <span class="n">curve2</span><span class="p">,</span> <span class="n">map2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">vacumm.diag.thermdyn</span> <span class="k">import</span> <span class="n">sw_depth</span><span class="p">,</span> <span class="n">sw_pres</span><span class="p">,</span> <span class="n">sw_dens</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Failed to import seawater fonctions, depth&lt;=&gt;pressure conversions not available&#39;</span><span class="p">)</span>

<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="Profile"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profile">[docs]</a><span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A profile variables container.</span>
<span class="sd">    Store variables in a dictionnary with variables identifiers as keys, cdms variables as values.</span>
<span class="sd">    Variables must share the same profile properties: platform code, datetime, position and depth.</span>

<span class="sd">    **NOTE: At present, this loads (copy) all data in memory ..!**</span>

<span class="sd">    :Required named argmuments:</span>
<span class="sd">            - **platform_code**: a string</span>
<span class="sd">            - **datetime**: datetime.datetime</span>
<span class="sd">            - **latitude**: float</span>
<span class="sd">            - **longitude**: float</span>
<span class="sd">            - **datetime_corrupted**: boolean indicating if the time component is corrupted (arbitrary set)</span>
<span class="sd">            - **depth**: cdms variable with shape (level)</span>
<span class="sd">            - **variables**: cdms variables dictionnary, variables with shape (level)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__properties</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;platform_code&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime_corrupted&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># - Remove slot mecanism if it does not optimize memory usage</span>
        <span class="c1"># - Store depth as axis</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__properties</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_code</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platform_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_code</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_code</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid depth shape, expecting 1D array, got </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s%s</span><span class="s1"> does not match expected shape: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,))</span>
            <span class="c1">#v = cdms2.createVariable(v, id=n)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__newstr__</span>

    <span class="c1"># Replace __str__ once all __init__ actions are completed</span>
    <span class="k">def</span> <span class="nf">__newstr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">, depth shape: </span><span class="si">%s</span><span class="s1">, variables: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__properties</span><span class="p">[:</span><span class="mi">5</span><span class="p">])),</span> <span class="c1"># update this on properties changes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="Profile.get_depth_min"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profile.get_depth_min">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the minimum depth value.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span></div>

<div class="viewcode-block" id="Profile.get_depth_max"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profile.get_depth_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the maximum depth value.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span></div>

<div class="viewcode-block" id="Profile.get_depth_range"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profile.get_depth_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the depth range (min,max).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth_min</span><span class="p">(),</span> <span class="n">get_depth_max</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profile.plot"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a 1D plot of the profile variable with depth as Y axis.</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **variables**: optional list of strings used to restrict the variable to display</span>
<span class="sd">            - **args, kwargs**: passed to the underlying plot function</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">(</span><span class="n">variables</span><span class="p">,)</span>
        <span class="n">save</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">gobjs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">varid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span>
            <span class="n">ckwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ckwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1"> time: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">latitude: </span><span class="si">%s</span><span class="s1">, longitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span>
            <span class="n">ckwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
            <span class="n">gobjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">ckwargs</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">save</span><span class="p">:</span> <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;profile_</span><span class="si">%s</span><span class="s1">.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">varid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gobjs</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="AbstractProfiles"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles">[docs]</a><span class="k">class</span> <span class="nc">AbstractProfiles</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Profile objects collection.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># TODO: Add NotImplementedError messages ?</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> size: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

<div class="viewcode-block" id="AbstractProfiles.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses.</span>
<span class="sd">        This method must return a string identifier of the profile type&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not define a get_type method !&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span></div>
<div class="viewcode-block" id="AbstractProfiles.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses.</span>
<span class="sd">        This method must return a dict with variables identifiers strings as keys,</span>
<span class="sd">        list of variables candidates strings as values.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.can_handle_dataset"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.can_handle_dataset">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">can_handle_dataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses.</span>
<span class="sd">        Return a boolean indicating if a file can be handled by the concrete subclass.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractProfiles.get_default_variables"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.get_default_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses.</span>
<span class="sd">        Return the list of strings indicating the default variables to be processed.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractProfiles.load_variable"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_variable">[docs]</a>    <span class="k">def</span> <span class="nf">load_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_platform_code"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_platform_code">[docs]</a>    <span class="k">def</span> <span class="nf">load_platform_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_filename"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_filename">[docs]</a>    <span class="k">def</span> <span class="nf">load_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_time"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_time">[docs]</a>    <span class="k">def</span> <span class="nf">load_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_longitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_longitude">[docs]</a>    <span class="k">def</span> <span class="nf">load_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_latitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_latitude">[docs]</a>    <span class="k">def</span> <span class="nf">load_latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_depth"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_depth">[docs]</a>    <span class="k">def</span> <span class="nf">load_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="AbstractProfiles.load_pressure"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.load_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">load_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must be defined by implementing subclasses&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractProfiles.get_types"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.get_types">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_types</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a dict of known profiles types as keys, implementing classes as values.</span>

<span class="sd">        Available profiles types are based on this module AbstractProfiles implementation classes,</span>
<span class="sd">        with types determined by the get_type method.</span>

<span class="sd">        .. todo::</span>
<span class="sd">            - add a way to plug external profiles types (from other modules)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                    <span class="n">types</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get_type</span><span class="p">()]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">types</span></div>

<div class="viewcode-block" id="AbstractProfiles.factory"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.AbstractProfiles.factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a Profiles object from nothing, a profile type, a profile dataset and/or profiles specification.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; factory(type=&#39;PROFILE_TYPE_ID&#39;)</span>
<span class="sd">            &gt;&gt;&gt; factory(dataset=&#39;/path/to/dataset&#39;)</span>
<span class="sd">            &gt;&gt;&gt; factory(dataset=&#39;/path/to/dataset&#39;, type=&#39;PROFILE_TYPE&#39;)</span>
<span class="sd">            &gt;&gt;&gt; factory(dataset=&#39;/path/to/dataset&#39;, load=True)</span>
<span class="sd">            &gt;&gt;&gt; factory(dataset=&#39;/path/to/dataset&#39;, type=&#39;PROFILE_TYPE&#39;, load=True)</span>

<span class="sd">        The dataset argument, if provided, is the dataset to use, either as a uri string, or CdmsFile.</span>
<span class="sd">        The type argument, if provided, is the profiles type identifier as returned by get_type.</span>
<span class="sd">        The load argument, if provided, indicate to load the provided file path.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">pdataset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;safe&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_types</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ptype</span> <span class="ow">and</span> <span class="n">pdataset</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">can_handle_dataset</span><span class="p">(</span><span class="n">pdataset</span><span class="p">):</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">ptype</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">safe</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported profiles type: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ptype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pdataset</span> <span class="ow">and</span> <span class="n">load</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pdataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span></div></div>


<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Profiles"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles">[docs]</a><span class="k">class</span> <span class="nc">Profiles</span><span class="p">(</span><span class="n">AbstractProfiles</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of AbstractProfiles.</span>

<span class="sd">    Define the load, get*, select and save features.</span>

<span class="sd">    This class contains a variable_map attribute which is a dict with</span>
<span class="sd">    variables identifiers strings as keys,  list of variables candidates</span>
<span class="sd">    strings as values. See load_variable for this mapping mecanism.</span>
<span class="sd">    Subclasses may modify this mapping attribute.</span>

<span class="sd">    :Params:</span>
<span class="sd">        - **profiles**: a list of Profile objects or Profiles instance or profiles file string.</span>
<span class="sd">        - **spec**: see below</span>
<span class="sd">        - **the spec attributes below can also be passed directly as keyword arguments**</span>

<span class="sd">    If the spec attribute is provided, it must be an object (usually another Profiles instance) with the following attributes:</span>
<span class="sd">        - **variables_map**: the variable mapping, default to :func:`get_variables_map`</span>
<span class="sd">        - **variables**: identifiers of variables to be loaded, default is from :func:`get_default_variables`</span>
<span class="sd">        - **qualities**: quality codes filter, default is from :func:`get_default_variables`</span>
<span class="sd">        - **time_units**: time unit for internal time axis, default is &#39;seconds since 1900-01-01 00:00:00&#39;</span>

<span class="sd">    :Note:</span>
<span class="sd">        - When Profile or Profiles instances are given, their nested Profile objects are referenced, note copied.</span>

<span class="sd">    :Examples:</span>
<span class="sd">        &gt;&gt;&gt; import glob</span>
<span class="sd">        &gt;&gt;&gt; import vacumm.misc.axes as A</span>
<span class="sd">        &gt;&gt;&gt; import vacumm.data.misc.profile as P</span>
<span class="sd">        &gt;&gt;&gt; p = P.Profiles(</span>
<span class="sd">                profiles=glob.glob(&#39;argo-profiles-*.nc&#39;),</span>
<span class="sd">                logger_level=&#39;debug&#39;,</span>
<span class="sd">                variables_map={</span>
<span class="sd">                    &#39;time&#39;:(&#39;TIME&#39;,),</span>
<span class="sd">                    &#39;depth&#39;:(&#39;DEPH&#39;,),</span>
<span class="sd">                    &#39;latitude&#39;:(&#39;LATITUDE&#39;,),</span>
<span class="sd">                    &#39;longitude&#39;:(&#39;LONGITUDE&#39;,),</span>
<span class="sd">                    &#39;temperature&#39;:(&#39;TEMP&#39;,),</span>
<span class="sd">                    &#39;salinity&#39;:(&#39;PSAL&#39;,),</span>
<span class="sd">                },</span>
<span class="sd">                variables=(&#39;temperature&#39;,&#39;salinity&#39;)</span>
<span class="sd">            )</span>
<span class="sd">        &gt;&gt;&gt; time = p.get_time()</span>
<span class="sd">        &gt;&gt;&gt; print &#39;time:&#39;, A.create_time(time, units=time.units).asComponentTime()</span>
<span class="sd">        &gt;&gt;&gt; print &#39;depth:&#39;, p.describe(p.get_depth(), stats=True)</span>
<span class="sd">        &gt;&gt;&gt; print &#39;latitude:&#39;, p.describe(p.get_latitude(), stats=True)</span>
<span class="sd">        &gt;&gt;&gt; print &#39;longitude:&#39;, p.describe(p.get_longitude(), stats=True)</span>
<span class="sd">        &gt;&gt;&gt; temp = p.get_variable(&#39;temperature&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print &#39;temperature:&#39;, p.describe(temp, stats=True)</span>
<span class="sd">        &gt;&gt;&gt; psal = p.get_variable(&#39;salinity&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print &#39;salinity:&#39;, p.describe(psal, stats=True)</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - fix load of single depth profile file</span>
<span class="sd">        - check depth quality test</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># See docstring above.</span>
    <span class="n">default_variables_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;platform_code&#39;</span><span class="p">:[</span><span class="s1">&#39;platform_code&#39;</span><span class="p">],</span>
        <span class="c1">#&#39;time&#39;:[&#39;time&#39;, &#39;station_date_time&#39;],</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;juld&#39;</span><span class="p">],</span>
        <span class="s1">&#39;time_qc&#39;</span><span class="p">:[</span><span class="s1">&#39;time_qc&#39;</span><span class="p">,</span> <span class="s1">&#39;juld_qc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
        <span class="s1">&#39;position_qc&#39;</span><span class="p">:[</span><span class="s1">&#39;position_qc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;depth&#39;</span><span class="p">:[</span><span class="s1">&#39;deph&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">],</span>
        <span class="s1">&#39;depth_qc&#39;</span><span class="p">:[</span><span class="s1">&#39;depth_qc&#39;</span><span class="p">,</span> <span class="s1">&#39;pres_qc&#39;</span><span class="p">],</span> <span class="c1"># ok ?</span>
        <span class="s1">&#39;pressure&#39;</span><span class="p">:[</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;pres&#39;</span><span class="p">],</span>
        <span class="s1">&#39;temperature&#39;</span><span class="p">:[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">],</span>
        <span class="s1">&#39;salinity&#39;</span><span class="p">:[</span><span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;psal&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">default_time_units</span> <span class="o">=</span> <span class="s1">&#39;seconds since 1900-01-01 00:00:00&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_variables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_qualities</span><span class="p">()</span>
        <span class="c1"># Cloning</span>
        <span class="c1"># Note: A dedicated copy method should exists to copy the contained</span>
        <span class="c1">#       Profile objects (and their variables data) then add a kwarg</span>
        <span class="c1">#       to apply this here</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">Profiles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">profiles</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="s1">&#39;variables_map&#39;</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;qualities&#39;</span><span class="p">,</span> <span class="s1">&#39;time_units&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">a</span><span class="p">)))</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Profile</span><span class="p">),</span> <span class="n">profiles</span><span class="p">)</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Profile</span><span class="p">),</span> <span class="n">profiles</span><span class="p">)</span>
        <span class="c1"># Apply args</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;variables_map&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">vmap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;qualities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;timerange&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lonrange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lonrange&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latrange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;latrange&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;time_units&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_time_units</span><span class="p">)</span>
        <span class="n">AbstractProfiles</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Initialize </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Requested variables identifiers: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Valid quality flags: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Time range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timerange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Longitude range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonrange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Latitude range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latrange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

<div class="viewcode-block" id="Profiles.summary"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a summary string of nested profiles.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">  size: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  variables: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  qualities: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  time: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  depth: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  latitude: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  longitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
            <span class="c1">#numpy.unique(numpy.concatenate([p.variables.keys() for p in self]))[:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_time_range</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth_range</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_range</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_range</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">info</span></div>

<div class="viewcode-block" id="Profiles.get_time_min"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_time_min">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the minimum date of nested profiles as a datetime object&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">datetime</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_time_max"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_time_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the maximum date of nested profiles as a datetime object&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">datetime</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_time_range"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_time_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get time min and max&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_max</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_depth_min"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_depth_min">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the minimum depth value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_depth_min</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_depth_max"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_depth_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the maxnimum depth value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_depth_max</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_depth_range"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_depth_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get depth min and max&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth_min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth_max</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_lat_min"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lat_min">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the minimum latitude value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_lat_max"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lat_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the maximum latitude value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_lat_range"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lat_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get lat min and max&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_max</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_lon_min"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lon_min">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the minimum longitude value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_lon_max"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lon_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the maximum longitude value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_lon_range"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_lon_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get lon min and max&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_max</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the profiles type identifier, used by :func:`get_types`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Profiles.can_handle_dataset"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.can_handle_dataset">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">can_handle_dataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return True if this class can handle the profiles of the given dataset.</span>
<span class="sd">        If dataset is a AbstractProfiles object, check that types matches.</span>
<span class="sd">        Else check that the type identifier is contained in the dataset file path, case insensitive (e.g. &#39;/path/to/profiles_pr_ba_xxxx.nc&#39; and type is &#39;pr_ba&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">AbstractProfiles</span><span class="p">):</span> <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">t</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CdmsFile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="n">dataset</span>
        <span class="k">return</span> <span class="n">t</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">uri</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a copy of variable_map</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_variables_map</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.get_default_variables"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_default_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the variables identifiers this class should load by default&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">()</span><span class="c1">#&#39;temperature&#39;, &#39;salinity&#39;)</span></div>

<div class="viewcode-block" id="Profiles.get_default_qualities"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_default_qualities">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_qualities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the quality code this class would filter by default&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">()</span><span class="c1">#&#39;1&#39;, &#39;2&#39;)</span></div>

<div class="viewcode-block" id="Profiles.sort"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sort profiles.</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **cmp**: If a string, use a predifined sort behavior in:</span>
<span class="sd">                - &#39;time&#39;: Sort the nested profiles based on their datetime</span>
<span class="sd">        Other parameters passed to the original sort method</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">__builtin__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">cmp</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="nb">cmp</span> <span class="o">=</span> <span class="nb">cmp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">cmp</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">AbstractProfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">:</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">datetime</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid sort method: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="nb">cmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AbstractProfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="nb">cmp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_variable"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_variable">[docs]</a>    <span class="k">def</span> <span class="nf">load_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">varid</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load a variable</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **dataset**: a CdmsFile object</span>
<span class="sd">            - **varid**: variable identifier</span>
<span class="sd">            - **as_axis**: if True, convert the loaded (1D) variable into a csdms axis</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Variables candidates are case insensitive</span>
        <span class="n">pfx</span><span class="p">,</span> <span class="n">sfx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varid</span><span class="p">,</span> <span class="n">varid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">varnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">varnames</span><span class="p">,)</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sfx</span><span class="p">),</span> <span class="n">varnames</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">varname</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getVariable</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">varname</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">var</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded </span><span class="si">%s%s%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">varid</span><span class="p">,</span> <span class="n">sfx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;as_axis&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="c1">#if kwargs.get(&#39;as_variable&#39;, None):</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Could not load </span><span class="si">%s%s%s</span><span class="s1">: No matching variable using varnames: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">varid</span><span class="p">,</span> <span class="n">sfx</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;variable map: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Profiles.load_platform_code"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_platform_code">[docs]</a>    <span class="k">def</span> <span class="nf">load_platform_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the platform code variable (using :func:`load_variable`)&#39;&#39;&#39;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;platform_code&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span>
        <span class="c1"># Try getting platform code from global attributes</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;wmo_platform_code&#39;</span><span class="p">,</span> <span class="s1">&#39;platform_code&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="n">platcode</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">platcode</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded platform code from global attribute </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">platcode</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">platcode</span>
        <span class="c1"># Try getting platform code from filename last &#39;_&#39; delimited component</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="n">platcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded platform code from file name: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">platcode</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">platcode</span></div>

<div class="viewcode-block" id="Profiles.load_filename"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_filename">[docs]</a>    <span class="k">def</span> <span class="nf">load_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the filename&#39;&#39;&#39;</span>
        <span class="n">filevar</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filevar</span></div>

<div class="viewcode-block" id="Profiles.load_time"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_time">[docs]</a>    <span class="k">def</span> <span class="nf">load_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the time variable as an axis (using :func:`load_variable`)</span>

<span class="sd">        An extra keyword arguments getcflag indicates if the date corrupted flag must also be returned</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;as_axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">timevar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#if timevar.dtype.kind in &#39;Sa&#39;:</span>
        <span class="k">if</span> <span class="n">timevar</span><span class="o">.</span><span class="n">typecode</span><span class="p">()</span> <span class="ow">in</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">parsetime</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">])</span>
                <span class="c1"># cf: time corruption flag</span>
                <span class="n">cf</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">:</span>   <span class="n">cf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">hour</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="k">if</span> <span class="n">minute</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">:</span> <span class="n">cf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">minute</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">second</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">:</span> <span class="n">cf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">second</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ct</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ct</span><span class="p">,</span> <span class="n">cf</span>
            <span class="n">times</span><span class="p">,</span> <span class="n">corrflags</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">parsetime</span><span class="p">,</span> <span class="n">timevar</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">timevar</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_units</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">corrflags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timevar</span> <span class="o">=</span> <span class="n">ch_units</span><span class="p">(</span><span class="n">timevar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;getcflag&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">return</span> <span class="n">timevar</span><span class="p">,</span> <span class="n">corrflags</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">timevar</span></div>

<div class="viewcode-block" id="Profiles.load_time_quality"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_time_quality">[docs]</a>    <span class="k">def</span> <span class="nf">load_time_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the time quality variable (using :func:`load_variable`)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;time_qc&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_longitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_longitude">[docs]</a>    <span class="k">def</span> <span class="nf">load_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the longitude variable (using :func:`load_variable`)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_latitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_latitude">[docs]</a>    <span class="k">def</span> <span class="nf">load_latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the latitude variable (using :func:`load_variable`)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_position_quality"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_position_quality">[docs]</a>    <span class="k">def</span> <span class="nf">load_position_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the position quality variable (using :func:`load_variable`)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;position_qc&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_depth"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_depth">[docs]</a>    <span class="k">def</span> <span class="nf">load_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the depth variable (using :func:`load_variable`)</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **tryconv**: if true, try to convert pressure to depth if depth cannot be loaded</span>
<span class="sd">            - **frompres**: force pressure to depth conversion</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">frompres</span><span class="p">,</span> <span class="n">tryconv</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;frompres&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tryconv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frompres</span><span class="p">:</span>
            <span class="n">tryconv</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tryconv</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">frompres</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No depth found, now trying to convert pressure to depth&#39;</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_latitude</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Latitude is needed for this conversion&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pressure</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">tryconv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Pressure is needed for this conversion&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Latitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Pressure: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">pres</span><span class="p">))</span>
            <span class="c1"># Get negative depth values</span>
            <span class="c1"># NOTE: pressure in decibar, depth in meters, latitude in decimal degrees [-90,+90]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sw_depth</span><span class="p">(</span><span class="n">pres</span><span class="p">[:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">lat</span><span class="p">[:])</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># TODO: add explicit named axes</span>
            <span class="n">proax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span>
            <span class="n">depax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="n">proax</span><span class="p">,</span> <span class="n">depax</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Computed depth: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check negative depth values</span>
            <span class="n">nmod</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">depth</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">depth</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Loaded depth[</span><span class="si">%s</span><span class="s1">] contains positive values, expecting positive up (min: </span><span class="si">%s</span><span class="s1">, max: </span><span class="si">%s</span><span class="s1">, avg: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">av</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">av</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Loaded depth[</span><span class="si">%s</span><span class="s1">] average is positive, converting to negative values&#39;</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">d</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">depth</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">d</span>
                    <span class="n">nmod</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nmod</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Depth of </span><span class="si">%s</span><span class="s1"> profiles were converted to negative values&#39;</span><span class="p">,</span> <span class="n">nmod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">depth</span></div>

<div class="viewcode-block" id="Profiles.load_depth_quality"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_depth_quality">[docs]</a>    <span class="k">def</span> <span class="nf">load_depth_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the depth quality variable (using variable_map)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;depth_qc&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profiles.load_pressure"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">load_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load and return the pressure variable (using :func:`load_variable`)</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **tryconv**: if true, try to convert depth to pressure if depth cannot be loaded</span>
<span class="sd">            - **frompres**: force depth to pressure conversion</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fromdepth</span><span class="p">,</span> <span class="n">tryconv</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fromdepth&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tryconv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fromdepth</span><span class="p">:</span>
            <span class="n">tryconv</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tryconv</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fromdepth</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No pressure found, now trying to convert depth to pressure&#39;</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_latitude</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Latitude is needed for this conversion&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_depth</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">tryconv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Depth is needed for this conversion&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Latitude: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Depth: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
            <span class="c1"># NOTE: pressure in decibar, depth in meters, latitude in decimal degrees [-90,+90]</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">sw_pres</span><span class="p">(</span><span class="n">depth</span><span class="p">[:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">lat</span><span class="p">[:])</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># TODO: add explicit named axes</span>
            <span class="n">proax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span>
            <span class="n">depax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="n">proax</span><span class="p">,</span> <span class="n">depax</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Computed pressure: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">pres</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pres</span></div>

<div class="viewcode-block" id="Profiles.load"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load a dataset.</span>

<span class="sd">        This loads a dataset or list of datasets and process quality filtering.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **dataset**: instance or list of instance of string (path) or CdmsFile</span>
<span class="sd">            - **variables**: variable identifiers to be loaded, defaults to self.variables</span>
<span class="sd">            - **qualities**: qualitie codes for filtering, defaults to self.qualities</span>
<span class="sd">            - **timerange**: if present, a time range for accepted profiles, defaults to self.timerange</span>
<span class="sd">            - **lonrange**: if present, a longitude range for accepted profiles, defaults to self.lonrange</span>
<span class="sd">            - **latrange**: if present, a latitude range for accepted profiles, defaults to self.latrange</span>

<span class="sd">        :Note: **this load all data into memory !**</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span> <span class="c1"># replace this by is_iterable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> loading </span><span class="si">%s</span><span class="s1"> profiles&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger_config</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="c1"># safe=True ?</span>
                <span class="n">p</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> loading: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="n">varids</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">qualities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qualities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">)</span>
        <span class="n">timerange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timerange&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timerange</span><span class="p">)</span>
        <span class="n">lonrange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lonrange&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonrange</span><span class="p">)</span>
        <span class="n">latrange</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latrange&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latrange</span><span class="p">)</span>
        <span class="n">qtype</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="c1"># int # lambda o:str(o).strip()</span>
        <span class="c1">#qualities = map(qtype, qualities)</span>
        <span class="n">qualities</span> <span class="o">=</span> <span class="n">MV2z</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qualities</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qtype</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># TODO: quality types in vars and in self ???</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Valid quality flags: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">qualities</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Requested variables identifiers: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Time range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timerange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Longitude range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lonrange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Latitude range filter: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">latrange</span><span class="p">)</span>
        <span class="n">dsfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">dsfile</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="c1"># Load dimensions or associated variables</span>
            <span class="n">platvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_platform_code</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">filevar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_filename</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">timevar</span><span class="p">,</span> <span class="n">timecflag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span><span class="p">(</span><span class="n">dsfile</span><span class="p">,</span> <span class="n">getcflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">timeqcvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_time_quality</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">latvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_latitude</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">lonvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_longitude</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">posqcvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_position_quality</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">depvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_depth</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">depqcvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_depth_quality</span><span class="p">(</span><span class="n">dsfile</span><span class="p">)</span>
            <span class="n">deprank</span> <span class="o">=</span> <span class="n">depvar</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
            <span class="c1"># TODO:</span>
            <span class="c1"># - add other checks (var shapes, qc shapes)</span>
            <span class="c1"># - add variables standardisation in load_variable ?</span>
            <span class="k">if</span> <span class="n">platvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No platform code variable found&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deprank</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported depth rank: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">depvar</span><span class="o">.</span><span class="n">rank</span><span class="p">()))</span>
            <span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span> <span class="o">=</span> <span class="n">timevar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">varshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span><span class="p">)</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Load variables</span>
            <span class="k">for</span> <span class="n">varid</span> <span class="ow">in</span> <span class="n">varids</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_variable</span><span class="p">(</span><span class="n">dsfile</span><span class="p">,</span> <span class="n">varid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#self.warning(&#39;Could not find %s &#39;, varid)</span>
                    <span class="k">continue</span>
                <span class="c1"># Check shape</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">varshape</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s%s</span><span class="s1"> mismatch expected shape: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">varshape</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1">#self.verbose(&#39;Found %s: %s&#39;, varid, self.describe(var))</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualities</span><span class="p">)</span> <span class="ow">and</span> <span class="n">timeqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not perform time quality tests: quality flag not available&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">timeqcvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeqcvar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualities</span><span class="p">)</span> <span class="ow">and</span> <span class="n">posqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not perform position quality tests: quality flag not available&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">posqcvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posqcvar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualities</span><span class="p">)</span> <span class="ow">and</span> <span class="n">depqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not perform depth quality tests: quality flag not available&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">depqcvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depqcvar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qtype</span><span class="p">)</span>
            <span class="n">timeqcerr</span> <span class="o">=</span> <span class="n">timeqcexc</span> <span class="o">=</span> <span class="n">posqcerr</span> <span class="o">=</span> <span class="n">posqcexc</span> <span class="o">=</span> <span class="n">depqcerr</span> <span class="o">=</span> <span class="n">depqcexc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Load profiles timesteps</span>
            <span class="n">npro</span> <span class="o">=</span> <span class="n">timevar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ipro</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">npro</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing profile[</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>

                <span class="n">ptime</span> <span class="o">=</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">timevar</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">timerange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">timerange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">ptime</span> <span class="o">&lt;=</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">timerange</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile no </span><span class="si">%s</span><span class="s1">: longitude </span><span class="si">%s</span><span class="s1"> not in range&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">lonvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">lonrange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lonrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lonvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lonrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile no </span><span class="si">%s</span><span class="s1">: longitude </span><span class="si">%s</span><span class="s1"> not in range&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">lonvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">latrange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">latrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">latvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">latrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile no </span><span class="si">%s</span><span class="s1">: latitude </span><span class="si">%s</span><span class="s1"> not in range&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">latvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualities</span><span class="p">)</span> <span class="ow">or</span> <span class="n">timeqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">MV2</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">timeqcvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not perform time quality test of profile no </span><span class="si">%s</span><span class="s1">: quality flag not set&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                    <span class="n">timeqcerr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking time quality flag of profile no </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">timeqcvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">q</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qualities</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile no </span><span class="si">%s</span><span class="s1">: time quality=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                        <span class="n">timeqcexc</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualities</span><span class="p">)</span> <span class="ow">or</span> <span class="n">posqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">MV2</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">posqcvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not perform position quality test of profil[</span><span class="si">%s</span><span class="s1">]: quality flag not set&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                    <span class="n">posqcerr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking position quality flag of profile[</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">posqcvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">q</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qualities</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile no </span><span class="si">%s</span><span class="s1">: position quality=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                        <span class="n">posqcexc</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">deprank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">pdepth</span> <span class="o">=</span> <span class="n">depvar</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">pdepth</span> <span class="o">=</span> <span class="n">depvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pdepth</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
                    <span class="n">pdepth</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pdepth</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">depvar</span><span class="o">.</span><span class="n">getMissing</span><span class="p">())</span>
                <span class="n">pvars</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">varid</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">pvars</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">timecflag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cftime</span> <span class="o">=</span> <span class="n">timecflag</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">cftime</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platvar</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">platcode</span> <span class="o">=</span> <span class="n">platvar</span>
                <span class="k">elif</span> <span class="n">platvar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">platcode</span> <span class="o">=</span> <span class="n">platvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">platcode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># Determine masked data based on the depth variable</span>
                <span class="c1"># This is done to optimize the memory/disk usage</span>
                <span class="k">if</span> <span class="n">pdepth</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">orgshape</span> <span class="o">=</span> <span class="n">pdepth</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">pdepth</span><span class="o">.</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding profile[</span><span class="si">%s</span><span class="s1">]: depth is entirely masked&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">pdepth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">varid</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="n">pvars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">pvars</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Shape of profile[</span><span class="si">%s</span><span class="s1">] after depth optimization: </span><span class="si">%s</span><span class="s1"> =&gt; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">orgshape</span><span class="p">,</span> <span class="n">pdepth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">##############################</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># meth1</span>
<span class="c1">##############################</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">qualities</span> <span class="ow">or</span> <span class="n">depqcvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking depth quality flag of profile no </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">depqcvar</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">pdepqc</span> <span class="o">=</span> <span class="n">depqcvar</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">pdepqc</span> <span class="o">=</span> <span class="n">depqcvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span>
                        <span class="n">valid_indexes</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">idep</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdepqc</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">MV2</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not perform depth no </span><span class="si">%s</span><span class="s1"> quality test of profile no </span><span class="si">%s</span><span class="s1">: quality flag not set&#39;</span><span class="p">,</span> <span class="n">idep</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                                <span class="n">depqcerr</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qualities</span><span class="p">:</span> <span class="n">valid_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idep</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Excluding depth no </span><span class="si">%s</span><span class="s1"> of profile no </span><span class="si">%s</span><span class="s1">: depth quality=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">idep</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                        <span class="n">pdepth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indexes</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">varid</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">pvars</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvars</span><span class="p">[</span><span class="n">varid</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indexes</span><span class="p">)</span>
<span class="c1">##############################</span>
<span class="c1"># OR meth2</span>
<span class="c1">##############################</span>
<span class="c1">#                    if not len(qualities) or depqcvar is None: pass</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        if depqcvar.rank() == 1: pdepqc = depqcvar</span>
<span class="c1">#                        else: pdepqc = depqcvar[ipro]</span>
<span class="c1">#                        valid_indexes = []</span>
<span class="c1">#                        for qual in qualities:</span>
<span class="c1">#                            valid_indexes.extend(numpy.where(pdepqc==qual)[0])</span>
<span class="c1">#                        print pdepqc.shape</span>
<span class="c1">#                        pdepth = pdepth.take(valid_indexes)</span>
<span class="c1">#                        print pdepqc.shape</span>
<span class="c1">#                        for varid,var in variables.items():</span>
<span class="c1">#                            pvars[varid] = pvars[varid].take(valid_indexes)</span>
<span class="c1">##############################</span>
<span class="c1"># PRES_QC unknown format in /home11/caparmor/mars/VALID/DATA/MANGA/HYDRO_SISMER/MANGA_SISMER_PR_BO.nc</span>
<span class="c1">##############################</span>

                <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span>
                    <span class="n">parent</span><span class="o">=</span><span class="n">dsfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ipro</span><span class="p">,</span>
                    <span class="n">platform_code</span><span class="o">=</span><span class="n">platcode</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">filevar</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">=</span><span class="n">ptime</span><span class="p">,</span> <span class="n">datetime_corrupted</span><span class="o">=</span><span class="n">cftime</span><span class="p">,</span>
                    <span class="n">latitude</span><span class="o">=</span><span class="n">latvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span>
                    <span class="n">longitude</span><span class="o">=</span><span class="n">lonvar</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span>
                    <span class="n">depth</span><span class="o">=</span><span class="n">pdepth</span><span class="p">,</span>
                    <span class="n">variables</span><span class="o">=</span><span class="n">pvars</span><span class="p">,</span>
                    <span class="n">logger_config</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

                <span class="c1">#self.debug(&#39;Adding profile: %s&#39;, profile)</span>

            <span class="k">if</span> <span class="n">qualities</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeqcerr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ignored masked time quality flag of </span><span class="si">%s</span><span class="s1"> profile</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeqcerr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">timeqcerr</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">posqcerr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ignored masked position quality flag of </span><span class="si">%s</span><span class="s1"> profile</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">posqcerr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">posqcerr</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">depqcerr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ignored masked depth quality flag of </span><span class="si">%s</span><span class="s1"> depth</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">depqcerr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">depqcerr</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">timeqcexc</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Excluded time quality flag of </span><span class="si">%s</span><span class="s1"> profile</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeqcexc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">timeqcexc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">posqcexc</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Excluded position quality flag of </span><span class="si">%s</span><span class="s1"> profile</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">posqcexc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">posqcexc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">depqcexc</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Excluded depth quality flag of </span><span class="si">%s</span><span class="s1"> depth</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">depqcexc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">depqcexc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Loaded </span><span class="si">%s</span><span class="s1"> profile</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="n">n</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error loading </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dsfile</span><span class="p">:</span> <span class="n">dsfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Profiles.get_profile_axis"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_profile_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_profile_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the profile cdms axis of the nested profiles&#39;&#39;&#39;</span>
        <span class="c1">#indexes = numpy.array(range(len(self)))</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
        <span class="n">pro</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
        <span class="n">pro</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Index of profile in original file&#39;</span>
        <span class="k">return</span> <span class="n">pro</span></div>

<div class="viewcode-block" id="Profiles.get_level_axis"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_level_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_level_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the level cdms axis of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">npro</span><span class="p">:</span>
            <span class="n">ndep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ndep</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
        <span class="n">depth</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;level&#39;</span>
        <span class="n">depth</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Level&#39;</span>
        <span class="n">depth</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
        <span class="k">return</span> <span class="n">depth</span></div>

<div class="viewcode-block" id="Profiles.get_platform_code"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_platform_code">[docs]</a>    <span class="k">def</span> <span class="nf">get_platform_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the platform code cdms variable of the nested profiles, if suitable, None otherwise&#39;&#39;&#39;</span>
        <span class="n">platmaxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">platform_code</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">platmaxlen</span><span class="p">:</span>
            <span class="n">platax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">platmaxlen</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;platform_code_string&#39;</span><span class="p">)</span>
            <span class="n">platarr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">platform_code</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">platmaxlen</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">platmaxlen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
            <span class="n">platvar</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">platarr</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;platform_code&#39;</span><span class="p">,</span> <span class="n">typecode</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),</span> <span class="n">platax</span><span class="p">),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">platvar</span></div>

<div class="viewcode-block" id="Profiles.get_origin_filename"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_origin_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_origin_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the filename cdms variable of the nested profiles &#39;&#39;&#39;</span>
        <span class="n">filemaxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">filemaxlen</span><span class="p">:</span>
            <span class="n">fileax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">filemaxlen</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;filename_string&#39;</span><span class="p">)</span>
            <span class="n">filearr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">filemaxlen</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">filemaxlen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
            <span class="n">filevar</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">filearr</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">typecode</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),</span> <span class="n">fileax</span><span class="p">),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
            <span class="n">filevar</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;File name of the original file&#39;</span>
            <span class="k">return</span> <span class="n">filevar</span></div>

<div class="viewcode-block" id="Profiles.get_time"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the time cdms variable of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reltime</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]),</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="s1">&#39;T&#39;</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_units</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">time</span></div>

<div class="viewcode-block" id="Profiles.get_latitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_latitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the latitude cdms variable of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]),</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;degree_north&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">90.0</span><span class="p">,</span> <span class="s1">&#39;valid_max&#39;</span><span class="p">:</span><span class="mf">90.0</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">lat</span></div>

<div class="viewcode-block" id="Profiles.get_longitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_longitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the longitude cdms variable of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]),</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;degree_east&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">180.0</span><span class="p">,</span> <span class="s1">&#39;valid_max&#39;</span><span class="p">:</span><span class="mf">180.0</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">lon</span></div>

<div class="viewcode-block" id="Profiles.get_depth"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_depth">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the depth cdms variable of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">npro</span><span class="p">:</span>
            <span class="n">ndep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span><span class="p">))</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">pdep</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">depth</span><span class="p">[:]</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">pdep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pdep</span>
            <span class="n">depth</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">pdep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pdep</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">depthvar</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_level_axis</span><span class="p">()),</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span><span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_min&#39;</span><span class="p">:</span><span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;valid_max&#39;</span><span class="p">:</span><span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">depthvar</span></div>

<div class="viewcode-block" id="Profiles.get_variable"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the varname (identifier) cdms variable of the nested profiles&#39;&#39;&#39;</span>
        <span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">npro</span><span class="p">:</span>
            <span class="n">ndep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="n">varattrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">:{</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;sea water temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;degree_Celsius&#39;</span><span class="p">},</span>
            <span class="s1">&#39;salinity&#39;</span><span class="p">:{</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;sea water salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span><span class="s1">&#39;sea_water_salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;PSU&#39;</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emptyvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndep</span><span class="p">,))</span>
        <span class="n">emptyvar</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">emptyvar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emptyvar</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">emptyvar</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile_axis</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_level_axis</span><span class="p">()),</span>
            <span class="n">attributes</span><span class="o">=</span><span class="n">varattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="Profiles.save"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save profiles in a netcdf file.</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **filepath**: output netcdf file path</span>
<span class="sd">            - **variables**: list of variable identifiers to be saved, default is self.variables</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving profiles in: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Requested variables identifiers: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">npro</span><span class="p">,</span> <span class="n">ndep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">npro</span><span class="p">:</span>
                <span class="n">ndep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">npro</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;There is no profile to save, aborting&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ndep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;There is no profile depth to save, aborting&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of profiles: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">npro</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of levels:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ndep</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">tim</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">plat</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latitude</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longitude</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_platform_code</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_origin_filename</span><span class="p">()</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No filename variable&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Cannot write filename variable&#39;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No platform code variable&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plat</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Cannot write platform variable&#39;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing variable </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">varname</span><span class="p">))</span>
            <span class="n">creation_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">software_version</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">__date__</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="n">creation_date</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> : Creation&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">creation_date</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Profiles&#39;</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">southernmost_latitude</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">northernmost_latitude</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">westernmost_longitude</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">easternmost_longitude</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to save file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Profiles.select"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a new Profiles instance (profiles are still referenced) of selected profiles.</span>

<span class="sd">        :Params:</span>
<span class="sd">            -**variables**: variables identifiers filtering</span>
<span class="sd">            -**time**: time filtering, see :func:`is_time_in_range`</span>
<span class="sd">            -**polys**: list of polygons (_geoslib.Polygon) for position filtering</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">profiles</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">(</span><span class="n">variables</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">polys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">polys</span> <span class="o">=</span> <span class="p">(</span><span class="n">polys</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">ipro</span><span class="p">,</span><span class="n">pro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Check at least one variable matches</span>
            <span class="k">if</span> <span class="n">variables</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> variables </span><span class="si">%s</span><span class="s1"> match </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">pro</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">variables</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="c1"># Check time matches</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_time_in_range</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> datetime </span><span class="si">%s</span><span class="s1"> not in range </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">pro</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Check at least on polygon matches</span>
            <span class="k">if</span> <span class="n">polys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">Point</span><span class="p">((</span><span class="n">pro</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">pro</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> position </span><span class="si">%s</span><span class="s1"> is in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">pro</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span> <span class="n">ipoly</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> position </span><span class="si">%s</span><span class="s1"> not in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">pro</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span> <span class="n">ipoly</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pro</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Profiles after selection:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">profiles</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">profiles</span></div></div>



<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="ProfilesWithDepthFromPres"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesWithDepthFromPres">[docs]</a><span class="k">class</span> <span class="nc">ProfilesWithDepthFromPres</span><span class="p">(</span><span class="n">Profiles</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A special Profiles type which forces trying to load depth from pressure first.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="ProfilesWithDepthFromPres.load_depth"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesWithDepthFromPres.load_depth">[docs]</a>    <span class="k">def</span> <span class="nf">load_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Force using pressure first if available</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frompres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">load_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;A depth from pressure conversion was expected but no pressure was found. Now trying to load depth&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frompres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">load_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Profiles_PR_BA"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BA">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_BA</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils BATHY provenant du GTS&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_BA.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BA.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_BA&#39;</span></div>

<div class="viewcode-block" id="Profiles_PR_BA.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BA.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="c1"># We need to insert DEPH at the start of the depth names list</span>
        <span class="c1"># to ensure this will be the first name to be checked.</span>
        <span class="c1"># In these profiles, the DEPTH variable is not the one we are looking for !</span>
        <span class="c1"># NOTE: this is now the default behavior, see Profiles class</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;DEPH&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div></div>


<div class="viewcode-block" id="Profiles_PR_BO"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BO">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_BO</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils Bouteilles&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_BO.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BO.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_BO&#39;</span></div>

<div class="viewcode-block" id="Profiles_PR_BO.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_BO.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth_qc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;PROFILE_PRES_QC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div></div>


<div class="viewcode-block" id="Profiles_PR_CT"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_CT">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_CT</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils CTD&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_CT.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_CT.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_CT&#39;</span></div></div>


<div class="viewcode-block" id="Profiles_PR_PF"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_PF">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_PF</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils flotteurs Argo&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_PF.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_PF.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_PF&#39;</span></div>

<div class="viewcode-block" id="Profiles_PR_PF.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_PF.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="c1"># We need to remove DEPTH because this kind of profiles do not really</span>
        <span class="c1"># provide it, this will cause to fall into pressure to depth conversion</span>
        <span class="c1"># NOTE: now this is done by subclassing ProfilesWithDepthFromPres</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">m</span></div></div>


<div class="viewcode-block" id="Profiles_PR_RE"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_RE">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_RE</span><span class="p">(</span><span class="n">Profiles</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils Recopesca&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_RE.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_RE.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_RE&#39;</span></div></div>


<div class="viewcode-block" id="Profiles_PR_TE"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_TE">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_TE</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils TESAC provenant du GTS&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_TE.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_TE.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_TE&#39;</span></div></div>

<div class="viewcode-block" id="Profiles_PR_XB"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_XB">[docs]</a><span class="k">class</span> <span class="nc">Profiles_PR_XB</span><span class="p">(</span><span class="n">Profiles</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils XBT ou XCTD&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_PR_XB.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_PR_XB.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;PR_XB&#39;</span></div></div>


<div class="viewcode-block" id="Profiles_Selmed"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_Selmed">[docs]</a><span class="k">class</span> <span class="nc">Profiles_Selmed</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils utilises pour BOBYCLIM&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_Selmed.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_Selmed.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;selmed&#39;</span></div>

<div class="viewcode-block" id="Profiles_Selmed.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_Selmed.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="c1"># We need to remove DEPTH because this kind of profiles do not really</span>
        <span class="c1"># provide it, this will cause to fall into pressure to depth conversion</span>
        <span class="c1"># NOTE: now this is done by subclassing ProfilesWithDepthFromPres</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;STATION_DATE_TIME&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;time_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PRES&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LONGITUDE&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PSAL&#39;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">m</span></div></div>

<div class="viewcode-block" id="Profiles_ArgoGeo"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_ArgoGeo">[docs]</a><span class="k">class</span> <span class="nc">Profiles_ArgoGeo</span><span class="p">(</span><span class="n">ProfilesWithDepthFromPres</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Profils ARGO - Geo&#39;&#39;&#39;</span>
<div class="viewcode-block" id="Profiles_ArgoGeo.get_type"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_ArgoGeo.get_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;_prof.nc&#39;</span></div>

<div class="viewcode-block" id="Profiles_ArgoGeo.get_variables_map"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.Profiles_ArgoGeo.get_variables_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variables_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">get_variables_map</span><span class="p">()</span>
        <span class="c1"># We need to remove DEPTH because this kind of profiles do not really</span>
        <span class="c1"># provide it, this will cause to fall into pressure to depth conversion</span>
        <span class="c1"># NOTE: now this is done by subclassing ProfilesWithDepthFromPres</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;platform_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PLATFORM_NUMBER&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;JULD&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;time_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;JULD_QC&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PRES_ADJUSTED&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;depth_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PRES_QC&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LONGITUDE&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;position_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;POSITION_QC&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEMP_ADJUSTED&#39;</span><span class="p">,)</span>
        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PSAL_ADJUSTED&#39;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">m</span></div></div>


<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="ProfilesFilter"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesFilter">[docs]</a><span class="k">class</span> <span class="nc">ProfilesFilter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
<div class="viewcode-block" id="ProfilesFilter.filter"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesFilter.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Must be defined by implementing subclasses</span>
<span class="sd">        This method must return two Profiles instances (filtered and rejected)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ProfilesDuplicatesFilter"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDuplicatesFilter">[docs]</a><span class="k">class</span> <span class="nc">ProfilesDuplicatesFilter</span><span class="p">(</span><span class="n">ProfilesFilter</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a profiles list into two profiles list:</span>
<span class="sd">        - a list of unique profile (filtered)</span>
<span class="sd">        - a list of duplicated profiles (rejected)</span>

<span class="sd">    The duplication criterias are based on the equality of the profile&#39;s attributes:</span>
<span class="sd">        - platform code</span>
<span class="sd">        - latitude and longitude</span>
<span class="sd">        - datetime</span>

<span class="sd">    The profiles datetime must be flagged with a **datetime_corrupted** attribute</span>
<span class="sd">    indicating if the time component of the datetime atribute is reliable (False)</span>
<span class="sd">    or has been arbitrary set to 12H (True).</span>
<span class="sd">    In this case, two profiles are duplicates if the timedelta between their datetimes</span>
<span class="sd">    is less than **maxtimedelta**.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxtimedelta</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **maxtimedelta**: number of seconds or timedelta representing the difference</span>
<span class="sd">              between two profiles dates from which they are not considered duplicates.</span>
<span class="sd">              This is only used when profiles have their datetime_corrupted flagged to True.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ProfilesFilter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maxtimedelta</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="n">maxtimedelta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">maxtimedelta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxtimedelta</span> <span class="o">=</span> <span class="n">maxtimedelta</span>

<div class="viewcode-block" id="ProfilesDuplicatesFilter.is_duplicate"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDuplicatesFilter.is_duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">is_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pro1</span><span class="p">,</span> <span class="n">pro2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a boolean indicating if pro1 and pro2 are considered duplicates.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check some attributes equality</span>
        <span class="k">if</span> <span class="n">pro1</span><span class="o">.</span><span class="n">latitude</span> <span class="o">!=</span> <span class="n">pro2</span><span class="o">.</span><span class="n">latitude</span> \
        <span class="ow">or</span> <span class="n">pro1</span><span class="o">.</span><span class="n">longitude</span> <span class="o">!=</span> <span class="n">pro2</span><span class="o">.</span><span class="n">longitude</span> \
        <span class="ow">or</span> <span class="n">pro1</span><span class="o">.</span><span class="n">platform_code</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pro2</span><span class="o">.</span><span class="n">platform_code</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># If one of the datetimes is corrupted, equality is based on the dates timedelta</span>
        <span class="k">if</span> <span class="n">pro1</span><span class="o">.</span><span class="n">datetime_corrupted</span> <span class="ow">or</span> <span class="n">pro2</span><span class="o">.</span><span class="n">datetime_corrupted</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pro1</span><span class="o">.</span><span class="n">datetime</span> <span class="o">-</span> <span class="n">pro2</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxtimedelta</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Else check strict equality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pro1</span><span class="o">.</span><span class="n">datetime</span> <span class="o">!=</span> <span class="n">pro2</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Here we are, the two profiles are considered duplicates</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ProfilesDuplicatesFilter.filter"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDuplicatesFilter.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Filter profiles, split them into two list of filtered (unique) and rejected (duplicates).</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **profiles**: A Profiles instance to be filtered</span>
<span class="sd">        :Return:</span>
<span class="sd">            - **filtered**: A Profiles instance</span>
<span class="sd">            - **rejected**: A Profiles instance</span>
<span class="sd">        :Note:</span>
<span class="sd">            The returned profiles are initialized with the same input profiles specification.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Build two list of profile indexes, unique and duplicates</span>
        <span class="n">filtered_indexes</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">rejected_indexes</span><span class="p">,</span> <span class="n">rejected</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="c1"># Loop on profiles</span>
        <span class="k">for</span> <span class="n">icur</span><span class="p">,</span><span class="n">curpro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profiles</span><span class="p">):</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Loop on other profiles remove duplicates</span>
            <span class="c1"># and to find a replacement candidate if needed</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profiles</span><span class="p">):</span>
                <span class="c1"># Check they don&#39;t refer to the same object</span>
                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">curpro</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="n">pro</span><span class="p">):</span>
                    <span class="c1"># If curpro and pro are considered duplicates</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_duplicate</span><span class="p">(</span><span class="n">curpro</span><span class="p">,</span> <span class="n">pro</span><span class="p">):</span>
                        <span class="c1"># If curpro has a corrupted datetime and pro has a valid datetime and curpro has not been replaced</span>
                        <span class="k">if</span> <span class="n">curpro</span><span class="o">.</span><span class="n">datetime_corrupted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pro</span><span class="o">.</span><span class="n">datetime_corrupted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">replaced</span><span class="p">:</span>
                            <span class="c1"># Add pro as a replacement of curpro, rejecting curpro</span>
                            <span class="n">filtered_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">rejected_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">icur</span><span class="p">)</span>
                            <span class="c1"># Also add curpro</span>
                            <span class="n">rejected_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Else curpro&#39;s datetime is valid or has been replaced</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rejected_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># If curpro has not been replaced because it has a valid datetime or no replacement was found</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replaced</span><span class="p">:</span>
                <span class="n">filtered_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">icur</span><span class="p">)</span>
        <span class="n">filtered_indexes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filtered_indexes</span><span class="p">)</span>
        <span class="n">rejected_indexes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rejected_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_indexes</span><span class="p">):</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">filtered_indexes</span><span class="p">)[:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_indexes</span><span class="p">):</span> <span class="n">rejected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">rejected_indexes</span><span class="p">)[:]</span>
        <span class="k">return</span> <span class="n">Profiles</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">profiles</span><span class="p">),</span> <span class="n">Profiles</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">profiles</span><span class="p">)</span></div></div>


<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="ProfilesMerger"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesMerger">[docs]</a><span class="k">class</span> <span class="nc">ProfilesMerger</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Hold a Profiles object which must be populated with the load method and then merged</span>
<span class="sd">    with the merge method.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="k">if</span> <span class="n">spec</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

<div class="viewcode-block" id="ProfilesMerger.load"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesMerger.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add profile(s) to the internal instance.</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **dataset**: can be single or list of objects accepted by :meth:`AbstractProfiles.factory`</span>
<span class="sd">            - **kwargs**: additionnal arguments merged with self.spec and passed to :meth:`AbstractProfiles.factory`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># This dataset collection detection is also available in Profiles, but here we</span>
        <span class="c1"># want to load them separatly to exclude unloadable profiles without a crash</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># self.psinfo()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="n">Profiles</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">logger_config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Could not process </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesMerger.merge"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesMerger.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reject_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reject_sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Merge the profiles applying a filter originally designed to seperate duplicate profiles.</span>
<span class="sd">        See :class:`ProfilesDuplicatesFilter`.</span>
<span class="sd">        :Params:</span>
<span class="sd">            - **filter**: the filter class to be used</span>
<span class="sd">            - **filter_file**: optionnal, string, the filtered profiles output file path</span>
<span class="sd">            - **reject_file**: optionnal, string, the filtered profiles output file path</span>
<span class="sd">            - **filter_sort**: optional, string, see :meth:`Profiles.sort`</span>
<span class="sd">            - **reject_sort**: optional, string, see :meth:`Profiles.sort`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Merging </span><span class="si">%s</span><span class="s1"> profiles with filter </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">),</span> <span class="nb">filter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="c1"># self.psinfo()</span>
        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="n">filtered</span><span class="p">,</span> <span class="n">rejected</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered</span><span class="p">,</span> <span class="n">rejected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span> <span class="p">,</span> <span class="n">Profiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Number of filtered profiles: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Number of rejected profiles: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected</span><span class="p">))</span>
        <span class="c1"># self.psinfo()</span>
        <span class="k">if</span> <span class="n">filtered</span> <span class="ow">and</span> <span class="n">filter_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_sort</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Sorting filtered profiles with method: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filter_sort</span><span class="p">)</span>
                <span class="n">filtered</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">filter_sort</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Saving filtered profiles in file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filter_file</span><span class="p">)</span>
            <span class="n">filtered</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filter_file</span><span class="p">)</span>
            <span class="c1"># self.psinfo()</span>
        <span class="k">if</span> <span class="n">rejected</span> <span class="ow">and</span> <span class="n">reject_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reject_sort</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Sorting rejected profiles with method: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reject_sort</span><span class="p">)</span>
                <span class="n">rejected</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reject_sort</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Saving rejected profiles in file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reject_file</span><span class="p">)</span>
            <span class="n">rejected</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">reject_file</span><span class="p">)</span>
            <span class="c1"># self.psinfo()</span>
        <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">rejected</span></div>

<div class="viewcode-block" id="ProfilesMerger.main"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesMerger.main">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Entry point of the bin/merge_profiles.py script. See merge_profiles.py --help.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **args**: passed to config.ConfigManager.opt_parse</span>

<span class="sd">        .. note::</span>
<span class="sd">            - You may pass the &quot;args&quot; argument to override command line arguments</span>

<span class="sd">        :Examples:</span>

<span class="sd">            &gt;&gt;&gt; ProfilesMerger.main(args=&#39;--cfgfile myconf.cfg --verbose --ProfilesMerger-load-timerange &quot;2010-01-01 2010-03-31&quot;&#39;.split())</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create the command line parser</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Merge various vertical profiles into a netcdf file&#39;</span><span class="p">,</span>
                <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;%prog [options] [profilesA.nc] [profilesB.nc] [...] &#39;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">__date__</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--netcdf3&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;netcdf3&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save files in NetCDF version 3&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--compress&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the compression level for NetCDF version 4 (default: </span><span class="si">%d</span><span class="s1">efault, range [0,9], only used with --convert)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--nonumpywarnings&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nonumpywarnings&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Hide all numpy warnings&#39;</span><span class="p">)</span>
            <span class="c1"># Add logging options</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">add_optparser_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span><span class="c1">#, prefix=&#39;log&#39;)</span>

            <span class="c1"># Prepare the configuration</span>
            <span class="c1"># Specifications config file</span>
            <span class="n">cfgini</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.ini&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Configuration section name</span>
            <span class="n">cfgsec</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="c1"># The configuration manager, using the specification file above</span>
            <span class="n">cfgm</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">cfgini</span><span class="p">)</span>
            <span class="c1"># Get default configuration</span>
            <span class="n">cfgo</span> <span class="o">=</span> <span class="n">cfgm</span><span class="o">.</span><span class="n">defaults</span><span class="p">()</span>
            <span class="c1"># The manager parse the command line arguments and return a configuration</span>
            <span class="n">cfgp</span> <span class="o">=</span> <span class="n">cfgm</span><span class="o">.</span><span class="n">opt_parse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
            <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">largs</span>
            <span class="c1"># If a configuration file is given, load it and override defaults</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">):</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Configuration file does not exists: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Loading configuration file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">)</span>
                    <span class="n">cfgf</span> <span class="o">=</span> <span class="n">cfgm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">)</span>
                    <span class="n">cfgm</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfgo</span><span class="p">,</span> <span class="n">cfgf</span><span class="p">)</span>
            <span class="c1"># Last override from command line arguments</span>
            <span class="n">cfgm</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfgo</span><span class="p">,</span> <span class="n">cfgp</span><span class="p">)</span>
            <span class="c1"># Apply logging command line arguments</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">apply_class_optparser_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="c1"># Show the final configuration</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded configuration:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cfgo</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>

            <span class="c1"># Operations on masked values throws numpy warnings, this can be ignored with the following instruction</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nonumpywarnings</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="c1"># NetCDF format</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">netcdf3</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Using on NetCDF version 3 writting mode&#39;</span><span class="p">)</span>
                <span class="n">netcdf3</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Using on NetCDF version 4 writting mode with compression level </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">)</span>
                <span class="n">netcdf4</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">)</span>

            <span class="c1"># Get the load section</span>
            <span class="n">loadkw</span> <span class="o">=</span> <span class="n">cfgo</span><span class="p">[</span><span class="n">cfgsec</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># Check that variable are requested (no sense to create a profile without data ?)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">loadkw</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No variables were specified&#39;</span><span class="p">)</span>

            <span class="c1"># Create the merger with the load configuration (variables, qualities, time/lon/lat range, ...)</span>
            <span class="n">merger</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">loadkw</span><span class="p">)</span>

            <span class="c1"># Load profiles specified as command line arguments</span>
            <span class="n">merger</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="c1"># Load profiles from explicit list of config file or command line option</span>
            <span class="n">input_files</span> <span class="o">=</span> <span class="n">cfgo</span><span class="p">[</span><span class="n">cfgsec</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">input_files</span><span class="p">:</span>
                <span class="n">merger</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span>

            <span class="c1"># Load profiles with a search specified from config file or command line option</span>
            <span class="n">findkw</span> <span class="o">=</span> <span class="n">cfgo</span><span class="p">[</span><span class="n">cfgsec</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">findkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">regex</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">findkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">findkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">regex</span> <span class="ow">and</span> <span class="n">pattern</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Use regex or pattern option, not both&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">regex</span><span class="p">:</span>
                    <span class="n">findkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">findfunc</span> <span class="o">=</span> <span class="n">efind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">findkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;regex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">findfunc</span> <span class="o">=</span> <span class="n">find</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Searching files using method </span><span class="si">%s</span><span class="s1"> and options: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">findfunc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">findkw</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">findfunc</span><span class="p">(</span><span class="o">**</span><span class="n">findkw</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%s</span><span class="s1"> file</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">merger</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

            <span class="c1"># Now merge the profiles with filters specified in configuration (e.g. duplicates filtering)</span>
            <span class="n">merger</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="o">**</span><span class="n">cfgo</span><span class="p">[</span><span class="n">cfgsec</span><span class="p">][</span><span class="s1">&#39;merge&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Fatal error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span></div></div>


<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="ProfilesDataset"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset">[docs]</a><span class="k">class</span> <span class="nc">ProfilesDataset</span><span class="p">(</span><span class="n">OceanDataset</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for handling standardized profiles dataset as created by :meth:`Profiles.save`</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - allow to load files with different depth size</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_platcodeid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;platform_code&#39;</span><span class="p">,)</span>
    <span class="n">_filenameid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,)</span>
    <span class="n">_timeid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span>
    <span class="n">_latid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,)</span>
    <span class="n">_lonid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,)</span>
    <span class="n">_depid</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,)</span>

<div class="viewcode-block" id="ProfilesDataset.get_axis"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axname</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: add dataset.get_axis by id behavior</span>
        <span class="c1"># TODO: make this method works with profiles dataset having different levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting axis: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">axname</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> axis found, dataset is empty&#39;</span><span class="p">,</span> <span class="n">axname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">orgselect</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">select</span><span class="p">)</span> <span class="o">=</span> <span class="n">select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">select</span><span class="p">)</span>
        <span class="n">seltime</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seltime</span><span class="p">:</span> <span class="n">seltime</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">comptime</span><span class="p">,</span> <span class="n">seltime</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sellat</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sellat</span><span class="p">:</span> <span class="n">sellat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">sellat</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sellon</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sellon</span><span class="p">:</span> <span class="n">sellon</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">sellon</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">selpolys</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polygons&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selpolys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">selpolys</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">selpolys</span> <span class="o">=</span> <span class="p">(</span><span class="n">selpolys</span><span class="p">,)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">allaxes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">axname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Axis </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">axname</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">axname</span> <span class="o">==</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">seltime</span> <span class="ow">or</span> <span class="n">sellat</span> <span class="ow">or</span> <span class="n">sellon</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">):</span>
                <span class="n">tmpax</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">seltime</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeid</span><span class="p">)</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sellat</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">:</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">create_lat</span><span class="p">(</span><span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sellon</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">:</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lonid</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ipro</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)):</span>
                    <span class="c1"># Check time matches</span>
                    <span class="c1">#if seltime and not (adatetime(seltime[0]) &lt;= adatetime(time[ipro]) &lt;= adatetime(seltime[1])): continue</span>
                    <span class="k">if</span> <span class="n">seltime</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seltime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">time</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seltime</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="k">continue</span>
                    <span class="c1"># Check position matches</span>
                    <span class="k">if</span> <span class="n">sellat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sellat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sellat</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">sellon</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sellon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sellon</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="c1"># Check at least on polygon matches</span>
                    <span class="k">if</span> <span class="n">selpolys</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selpolys</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Point</span><span class="p">((</span><span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> is in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">ipoly</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> not in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">ipoly</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="c1"># Selects pass, load the profile</span>
                    <span class="n">tmpax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tmpax</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">tmpax</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">allaxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allaxes</span><span class="p">:</span>
            <span class="n">refax</span> <span class="o">=</span> <span class="n">allaxes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">refax</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">allaxes</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="n">refax</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Loaded axis: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span>
            <span class="c1"># self.psinfo()</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data found for axis: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">axname</span><span class="p">,</span> <span class="n">orgselect</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_variable"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: make this method works with profiles dataset having different levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting variable: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> variable found, dataset is empty&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">select</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">orgselect</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">select</span><span class="p">)</span> <span class="o">=</span> <span class="n">select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selector</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">select</span><span class="p">)</span>
        <span class="n">seltime</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seltime</span><span class="p">:</span> <span class="n">seltime</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">comptime</span><span class="p">,</span> <span class="n">seltime</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sellat</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sellat</span><span class="p">:</span> <span class="n">sellat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">sellat</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sellon</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sellon</span><span class="p">:</span> <span class="n">sellon</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">sellon</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">selpolys</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polygons&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selpolys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">selpolys</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">selpolys</span> <span class="o">=</span> <span class="p">(</span><span class="n">selpolys</span><span class="p">,)</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">allvars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># NOTE: data have to be loaded now (otherwise MV2.concatenate will not use the masks!)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="o">**</span><span class="n">select</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seltime</span> <span class="ow">or</span> <span class="n">sellat</span> <span class="ow">or</span> <span class="n">sellon</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
                <span class="n">pro</span><span class="p">,</span> <span class="n">tmppro</span><span class="p">,</span> <span class="n">tmpvar</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">seltime</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeid</span><span class="p">)</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sellat</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">:</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">create_lat</span><span class="p">(</span><span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sellon</span> <span class="ow">or</span> <span class="n">selpolys</span><span class="p">:</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">create_lon</span><span class="p">(</span><span class="n">ncget_var</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lonid</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ipro</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="c1"># Check time matches</span>
                    <span class="c1">#if seltime and not (adatetime(seltime[0]) &lt;= adatetime(time[ipro]) &lt;= adatetime(seltime[1])): continue</span>
                    <span class="k">if</span> <span class="n">seltime</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seltime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">time</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seltime</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="k">continue</span>
                    <span class="c1"># Check position matches</span>
                    <span class="k">if</span> <span class="n">sellat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sellat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sellat</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">sellon</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sellon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sellon</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="c1"># Check at least on polygon matches</span>
                    <span class="k">if</span> <span class="n">selpolys</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selpolys</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Point</span><span class="p">((</span><span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">]))</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> is in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">ipoly</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;profile </span><span class="si">%s</span><span class="s1"> not in poly </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipro</span><span class="p">,</span> <span class="n">ipoly</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="c1"># Selects pass, load the profile</span>
                    <span class="n">tmppro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pro</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                    <span class="n">tmpvar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tmppro</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">newpro</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">tmppro</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pro</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">newpro</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">tmpvar</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">newpro</span><span class="p">]</span><span class="o">+</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">attributes</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">allvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allvars</span><span class="p">:</span>
            <span class="n">refvar</span> <span class="o">=</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">refvar</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allvars</span><span class="p">]),</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">refvar</span><span class="o">.</span><span class="n">getAxisIds</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">refvar</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">refvar</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">allvars</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="n">refvar</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Loaded variable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="c1"># self.psinfo()</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data found for variable: </span><span class="si">%s</span><span class="s1">, select: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">orgselect</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_platform_code"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_platform_code">[docs]</a>    <span class="k">def</span> <span class="nf">get_platform_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_platcodeid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_origin_filename"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_origin_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_origin_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filenameid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_time"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_latitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_latitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_latid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_longitude"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_longitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lonid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_depth"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_depth">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_depid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># TODO: check if profile/gridded data can be handled directly in Dataset</span>
<div class="viewcode-block" id="ProfilesDataset.get_layer"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_layer">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get layer data for a specified depth.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **variable**: variable name</span>
<span class="sd">            - **depth**: layer depth</span>
<span class="sd">            - **select**: selector</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span><span class="c1">#, squeeze=True)#, order=&#39;-z&#39;)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> not found&#39;</span><span class="o">%</span><span class="n">varname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid var order: </span><span class="si">%s</span><span class="s1">, -z expected&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()))</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longitude</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latitude</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span><span class="c1">#, squeeze=True)#, order=&#39;-z&#39;)</span>
        <span class="k">if</span> <span class="n">dep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Depth not found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid depth order: </span><span class="si">%s</span><span class="s1">, -z expected&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">getOrder</span><span class="p">()))</span>
        <span class="n">npro</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Exclude entirely masked depth/var coordinates</span>
        <span class="n">goodfct</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">depgood</span><span class="p">,</span> <span class="n">vargood</span> <span class="o">=</span> <span class="n">goodfct</span><span class="p">(</span><span class="n">dep</span><span class="p">),</span> <span class="n">goodfct</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">depgood</span> <span class="o">&amp;</span> <span class="n">vargood</span>
        <span class="n">depcnt</span><span class="p">,</span> <span class="n">varcnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">depgood</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">vargood</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">totcnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of profiles with valid data:&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  depth:            </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="si">%-18s%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  total:            </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">depcnt</span><span class="p">,</span> <span class="n">npro</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">varcnt</span><span class="p">,</span> <span class="n">npro</span><span class="p">,</span> <span class="n">totcnt</span><span class="p">,</span> <span class="n">npro</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">totcnt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No valid profiles, aborting&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">igood</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">takefct</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">MV2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">igood</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dep</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">takefct</span><span class="p">(</span><span class="n">dep</span><span class="p">),</span> <span class="n">takefct</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="c1"># Depth interpolation axis</span>
        <span class="n">odep</span> <span class="o">=</span> <span class="n">create_dep</span><span class="p">(</span><span class="n">is_iterable</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="ow">and</span> <span class="n">depth</span> <span class="ow">or</span> <span class="p">[</span><span class="n">depth</span><span class="p">])</span>
        <span class="n">ovar</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axo</span><span class="o">=</span><span class="n">odep</span><span class="p">,</span> <span class="n">xmap</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xmapper</span><span class="o">=</span><span class="n">dep</span><span class="p">)</span> <span class="c1"># Required order: ...z</span>
        <span class="n">ovar</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">ovar</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">odep</span><span class="p">],</span> <span class="n">attributes</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ovar</span><span class="p">,</span> <span class="n">odep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ovar</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_hist"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_hist">[docs]</a>    <span class="k">def</span> <span class="nf">get_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstep</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get histogram data.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **tstep**: bars time coverage (n,units) (ex: 1,&#39;month&#39;)</span>
<span class="sd">            - **kwargs**: passed to :func:`get_time`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">create_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
        <span class="n">npro</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">hist_time</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">Intervals</span><span class="p">((</span><span class="n">round_date</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dtime</span><span class="p">),</span> <span class="n">tstep</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">round_date</span><span class="p">(</span><span class="n">add_date</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dtime</span><span class="p">),</span> <span class="n">tstep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tstep</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tstep</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">tstep</span><span class="p">):</span>
            <span class="n">hist_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adatetime</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtime</span><span class="p">))</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Interval </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">itv</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">hist_time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">hist_time</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="n">hist_time</span><span class="p">,),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">hist</span></div>

<div class="viewcode-block" id="ProfilesDataset.plot_layer"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_layer">[docs]</a>    <span class="k">def</span> <span class="nf">plot_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot a layer for a specified depth.</span>

<span class="sd">        See :func:`get_layer`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">POST_PLOT_ARGS</span><span class="p">:</span> <span class="n">mapkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Averaging layer along depth&#39;</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magic&#39;</span><span class="p">))</span><span class="c1"># cmap=cmap))</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>
        <span class="c1"># Plot profiles scatter points</span>
        <span class="n">scakw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">scakw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.plot_hist"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_hist">[docs]</a>    <span class="k">def</span> <span class="nf">plot_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a histogram plot.</span>

<span class="sd">        :Keyword arguments:</span>
<span class="sd">            - **plot_&lt;keyword&gt;**: are passed to the plot function :func:`~vacumm.misc.plot.bar2`</span>

<span class="sd">        Other arguments, see :func:`get_hist`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No hist data&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Histogram&#39;</span><span class="p">)</span>
<span class="c1">#        vmin, vmax = MV2.min(hist), MV2.max(hist)</span>
<span class="c1">#        vamp = vmax - vmin</span>
<span class="c1">#        pmin, pmax = 0, vmax + (vamp / 10 or 1)</span>
<span class="c1">#        plotkw.setdefault(&#39;ylim&#39;, (pmin,pmax))</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="s1">&#39;number of profiles&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
        <span class="n">bar2</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkw</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProfilesDataset.plot_dist"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_dist">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drawpro</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">drawpol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drawcnt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a map of profiles distribution.</span>

<span class="sd">        The polygons variable determine the plot mode:</span>
<span class="sd">            - if None, only profiles positions are drawn</span>
<span class="sd">            - otherwise, distribution is represented using colors for each specified polygon</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **polygons**: list of distribution polygon (of type _geoslib.Polygon). Activate colored distribution if not None.</span>
<span class="sd">            - **drawpro**: symbol identifier of profiles (profiles not plotted if None)</span>
<span class="sd">            - **drawpol**: draw polygons contours if True</span>
<span class="sd">            - **drawcnt**: show textual profiles counts if True</span>

<span class="sd">        :Keyword arguments:</span>
<span class="sd">            - **plot_&lt;keyword&gt;**: are passed to the plot function :func:`~vacumm.misc.plot.map2`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">:</span> <span class="n">polygons</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polygons</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">polygons</span> <span class="o">=</span> <span class="p">(</span><span class="n">polygons</span><span class="p">,)</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No dist data&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">npro</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latitude</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longitude</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lat_min</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npro</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
                <span class="n">lon_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">))</span>
                <span class="n">lat_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">))</span>
                <span class="n">lon_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lon_max</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">))</span>
                <span class="n">lat_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lat_max</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">))</span>
            <span class="n">lon_off</span><span class="p">,</span> <span class="n">lat_off</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span>
            <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lon_min&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_min</span> <span class="o">-</span> <span class="n">lon_off</span><span class="p">))</span>
            <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lat_min&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_min</span> <span class="o">-</span> <span class="n">lat_off</span><span class="p">))</span>
            <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lon_max&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">+</span> <span class="n">lon_off</span><span class="p">))</span>
            <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lat_max&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">+</span> <span class="n">lat_off</span><span class="p">))</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;Distribution&#39;</span><span class="p">))</span>
        <span class="n">show</span> <span class="o">=</span> <span class="n">plotkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">plotkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">=</span><span class="p">(</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">)))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span>
        <span class="n">polyscounts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ipro</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">npro</span><span class="p">):</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pt</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
                    <span class="n">polyscounts</span><span class="p">[</span><span class="n">ipoly</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">drawpro</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">ipro</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">ipro</span><span class="p">])</span>
                <span class="c1">#t = &#39;PRO:%s&#39;%ipro</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">drawpro</span><span class="o">%</span><span class="nb">vars</span><span class="p">()</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">7.75</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">maxcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">polyscounts</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">maxcount</span><span class="o">/</span><span class="n">nsteps</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxcount</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.colorbar</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#0040FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#0080FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#00A2FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#00FFFB&#39;</span><span class="p">,</span> <span class="s1">&#39;#00FF98&#39;</span><span class="p">,</span> <span class="s1">&#39;#5DFF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#BFFF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#F1FF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFDD00&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFAC00&#39;</span><span class="p">,</span> <span class="s1">&#39;#FF1800&#39;</span><span class="p">,</span> <span class="s1">&#39;#CE1300&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="o">-</span><span class="n">nsteps</span><span class="p">:]</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxcount</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="n">bbox_polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lon_min&#39;</span><span class="p">],</span> <span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lat_min&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lon_max&#39;</span><span class="p">],</span> <span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lat_min&#39;</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lon_max&#39;</span><span class="p">],</span> <span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lat_max&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lon_min&#39;</span><span class="p">],</span> <span class="n">plotkw</span><span class="p">[</span><span class="s1">&#39;lat_max&#39;</span><span class="p">]]]))</span>
        <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
<span class="c1">#            if not poly.within(bbox_polygon):</span>
<span class="c1">#                self.verbose(&#39;Ignoring polygon %s, not within bbox&#39;, ipoly)</span>
<span class="c1">#                continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> profiles within polygon </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">polyscounts</span><span class="p">[</span><span class="n">ipoly</span><span class="p">],</span> <span class="n">ipoly</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">polyscounts</span><span class="p">[</span><span class="n">ipoly</span><span class="p">])</span> <span class="o">/</span> <span class="n">maxcount</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drawpol</span><span class="p">:</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drawcnt</span><span class="p">:</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span>
                    <span class="c1">#&#39;POL:%d\nCNT:%s&#39;%(ipoly, polyscounts[ipoly]),</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">polyscounts</span><span class="p">[</span><span class="n">ipoly</span><span class="p">]),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">7.75</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Number of profiles&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProfilesDataset.plot_pro"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_pro">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce a 1D plot of the profiles with depth as Y axis.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **varname**: variable name</span>
<span class="sd">            - **index**: profile(s) indexe(s) (after optionnal selection)</span>

<span class="sd">        :Keyword arguments:</span>
<span class="sd">            - **select**: selector</span>
<span class="sd">            - **plot_&lt;keyword&gt;**: are passed to the plot function :func:`~vacumm.misc.plot.curve2`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1">#show = plotkw.get(&#39;plot&#39;, False)</span>
        <span class="n">curves</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">icur</span><span class="p">,</span><span class="n">ipro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ipro</span><span class="p">,</span><span class="n">ipro</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> not found or index </span><span class="si">%s</span><span class="s1"> out of range&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">platcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_platform_code</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">platcode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">platcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">platcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">create_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latitude</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longitude</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span> <span class="n">dep</span>
            <span class="c1"># Exclude masked data based on the depth variable</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">orgshape</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">d</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No valid data for variable </span><span class="si">%s</span><span class="s1"> profile at index </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ipro</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span>
            <span class="c1"># Reverse depth</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reversing data and level to go from bottom to surface&#39;</span><span class="p">)</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># tmp fix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="c1">#l = cdms2.createAxis(range(d.shape[0]), id=&#39;level&#39;)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">designateLevel</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">attributes</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">attributes</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
            <span class="n">curkw</span> <span class="o">=</span> <span class="n">plotkw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">curkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;zd&#39;</span><span class="p">)</span>
            <span class="n">curkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Profile </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">curkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;i: </span><span class="si">%(ipro)s</span><span class="s1">, c: </span><span class="si">%(platcode)s</span><span class="s1">, t: %Y-%m-</span><span class="si">%d</span><span class="s1"> %Hh, x: </span><span class="si">%(lon).3f</span><span class="s1">, y: </span><span class="si">%(lat).3f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curkw</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]:</span> <span class="n">curkw</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adatetime</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">curkw</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span><span class="o">%</span><span class="nb">vars</span><span class="p">()</span>
            <span class="n">curkw</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">curves</span><span class="p">[</span><span class="n">icur</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve2</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">curkw</span><span class="p">)</span>
        <span class="c1">#if show: pylab.show()</span>
        <span class="k">return</span> <span class="n">curves</span></div>

<div class="viewcode-block" id="ProfilesDataset.main"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.main">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Entry point of the bin/profile.py script. See profile.py - -help.</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **args** and **kwargs**: passed to optparse.OptionParser.parse_args</span>

<span class="sd">        .. note::</span>
<span class="sd">            - You may pass the &quot;args&quot; named argument to override command line arguments</span>

<span class="sd">        .. todo:</span>
<span class="sd">            - Use config.ConfigManager instead of optparse.OptionParser</span>

<span class="sd">        :Examples:</span>

<span class="sd">            &gt;&gt;&gt; ProfilesDataset.main(args=(&#39;myprofiles.nc&#39;, &#39;--pro&#39;, &#39;0,1,2&#39;))</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">optparse</span> <span class="k">import</span> <span class="n">IndentedHelpFormatter</span>
            <span class="k">class</span> <span class="nc">IndentedHelpFormatterWithNL</span><span class="p">(</span><span class="n">IndentedHelpFormatter</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">format_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">description</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span>
                    <span class="sd">&#39;&#39;&#39;\</span>
<span class="sd">Show profiles informations: distribution, historgram, profile variable data</span>

<span class="sd">Input file[s] must be standardized profiles NetCDF file produced by merge_profiles.py or by this</span>
<span class="sd">program convertion utility (see --convert option).</span>

<span class="sd">Examples:</span>
<span class="sd">  This will produce a map with the profiles position for the given variable:</span>
<span class="sd">    %prog profiles.nc -v temperature --dist</span>
<span class="sd">  This will produce a map with the profiles distribution for the given variable and set of polygons:</span>
<span class="sd">    %prog profiles.nc -v temperature -t 2000,2005 --hist --dist -P data/polygon_manga/polygon_manga.txt</span>
<span class="sd">                    &#39;&#39;&#39;</span><span class="p">,</span>
                <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;%prog [options] [file1] [file2] [...]&#39;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">__date__</span><span class="p">,</span>
                <span class="n">formatter</span><span class="o">=</span><span class="n">IndentedHelpFormatterWithNL</span><span class="p">())</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--cfgfile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;cfgfile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Configuration file&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--hist&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;n,units&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plot profiles histogram with interval n,units (ex: &quot;1,month&quot; , &quot;2,weeks&quot; , ...)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--dist&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plot profiles distribution (position and, if polygons are specified, the colored count of profiles per polygon)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--drawpro&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;drawpro&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plot profiles position in distribution plot when using polygons&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--pro&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pro&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plot a profile at specified comma separated indexes. Ranges may also be specified using start:stop[:step] notation, resulting in [start,...,stop[ indexes. Example: 0,1,2:5,5:11:1 would plot profiles 0 to 10&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--time&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Restrict timerange to be processed, format is &quot;datemin,datemax&quot; with date format: &quot;YYYY-mm-ddTHH:MM:SS&quot;&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--bbox&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;bbox&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the map bounding box, format is lon_min,lat_min,lon_max,lat_max&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--variables&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Variables to be processed, Aliases may be specified using comma separated names. Repeat this option for each required variable. Ex: -v temperature,TEMP -v salinity,PSAL&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--poly&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Add a polygon for profile restriction and accounting, polygon format is x1,y1,x2,y2,x3,y3,x4,y4... At least 4 couples must be set, otherwise if 4 values are set, it is considered as lonmin,latmin,lonmax,latmax&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--polyfile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;polyfile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify a polygon file containing couples coordinates (in lat, lon order), with values separated by a whitespace or coma&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="s1">&#39;--polysfile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;polysfile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify a polygons file (one per line)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(plot)s</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output files pattern (default: &quot;</span><span class="si">%d</span><span class="s1">efault&quot; with plot replaced by the </span><span class="si">%(plot)s</span><span class="s1"> type)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--convert&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;convert&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;converted_profiles.nc&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert given profile file(s) into a standard netcdf output file. Variables must be specified using the -v option.&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--save&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save figures, you may also use the -o option&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--show&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show figures (enabled by default if --save is not used)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--netcdf3&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;netcdf3&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save files in NetCDF version 3 (only used with --convert)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--compress&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the compression level for NetCDF version 4 (default: </span><span class="si">%d</span><span class="s1">efault, range [0,9], only used with --convert)&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--nonumpywarnings&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nonumpywarnings&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Hide all numpy warnings&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Debug mode&#39;</span><span class="p">)</span>

            <span class="c1">#Logger.add_optparser_options(parser)</span>
            <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1">#Logger.apply_class_optparser_options(options)</span>

            <span class="c1"># Operations on masked values throws numpy warnings, this can be ignored with the following instruction</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nonumpywarnings</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">:</span>
                <span class="n">Object</span><span class="o">.</span><span class="n">load_default_config</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">load_default_config</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">get_default_config</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Object</span><span class="p">,</span><span class="n">ProfilesDataset</span><span class="p">]</span><span class="o">+</span><span class="n">Profiles</span><span class="o">.</span><span class="n">get_types</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">_log_obj_stats</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># format variables to a list of variables candidates</span>
            <span class="c1"># ex: [[&#39;temperature&#39;,&#39;TEMP&#39;], [&#39;salinity&#39;,&#39;PSAL&#39;]]</span>
            <span class="n">options</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">options</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
                <span class="n">select</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">bbox</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">select</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">poly</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">polyfile</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">polysfile</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">polys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">polys</span><span class="p">:</span>
                <span class="n">select</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># two possible delimiters: whitespaces and &#39;,&#39;</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">poly</span><span class="o">.</span><span class="n">split</span><span class="p">():</span> <span class="n">c</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]))</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">c</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid format in polygon </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ipoly</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">select</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loaded polygon </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> coordinates&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ipoly</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">boundary</span><span class="p">)))</span>

            <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">bbox</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">plot_lon_min</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_lat_min</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plot_lon_max</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plot_lat_max</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">convert</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">netcdf3</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Using on NetCDF version 3 writting mode&#39;</span><span class="p">)</span>
                    <span class="n">netcdf3</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Using on NetCDF version 4 writting mode with compression level </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">)</span>
                    <span class="n">netcdf4</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">compress</span><span class="p">)</span>
                <span class="n">vmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">vmap</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">profiles</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">(</span><span class="n">variables_map</span><span class="o">=</span><span class="n">vmap</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">vmap</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">qualities</span><span class="o">=</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">profiles</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">profiles</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">convert</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No variable were specifed&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">profiles</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">:</span>
                <span class="n">profiles</span><span class="o">.</span><span class="n">load_default_config</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="p">:</span>
                <span class="n">hist_kwargs</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Plotting histogram&#39;</span><span class="p">,)</span>
                <span class="n">profiles</span><span class="o">.</span><span class="n">plot_hist</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hist</span><span class="p">,</span> <span class="o">**</span><span class="n">hist_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">%</span><span class="nb">dict</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Saving </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show</span><span class="p">:</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dist</span><span class="p">:</span>
                <span class="n">dist_kwargs</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dist_kwargs</span><span class="p">[</span><span class="s1">&#39;drawpro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">select</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polygons&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">drawpro</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">dist_kwargs</span><span class="p">[</span><span class="s1">&#39;drawcnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">dist_kwargs</span><span class="p">[</span><span class="s1">&#39;drawpol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Plotting distribution&#39;</span><span class="p">)</span>
                <span class="n">profiles</span><span class="o">.</span><span class="n">plot_dist</span><span class="p">(</span><span class="n">polygons</span><span class="o">=</span><span class="n">select</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polygons&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="o">**</span><span class="n">dist_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">%</span><span class="nb">dict</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="s1">&#39;dist&#39;</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Saving </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show</span><span class="p">:</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">pro</span><span class="p">:</span>
                <span class="n">pro_kwargs</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pro_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_axes_rect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">pro</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span> <span class="n">indexes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid profiles indexes format: </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">pro</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;At least one variable option is required for profile plot&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">pylab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Plotting profiles of variable </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
                    <span class="n">curves</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">plot_pro</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="o">*</span><span class="n">indexes</span><span class="p">,</span> <span class="o">**</span><span class="n">pro_kwargs</span><span class="p">)</span>
                    <span class="c1">#pylab.legend(loc=&#39;best&#39;)</span>
                    <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.15</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">%</span><span class="nb">dict</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="s1">&#39;pro_&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">)</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;Saving </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                        <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show</span><span class="p">:</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Fatal error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ProfilesDataset.get_stratification_data"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_stratification_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_stratification_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get stratification data</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector</span>

<span class="sd">        :Return:</span>
<span class="sd">            - time, lat, lon, depth, depthimax, deltadepth, temp, sal, dens, densmin, densmax, densmean with shape (profile,)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="n">sal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Initial stratification data:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="n">lev</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">depth</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span><span class="n">sal</span><span class="p">)))</span>

        <span class="c1"># Set intial order for masked profiles exclusion</span>
        <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">),</span> <span class="n">sal</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">),</span> <span class="n">depth</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">)</span>

        <span class="c1"># Exclude entirely masked depth/temp/sal coordinates</span>
        <span class="n">goodfct</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">depgood</span><span class="p">,</span> <span class="n">tempgood</span><span class="p">,</span> <span class="n">salgood</span> <span class="o">=</span> <span class="n">goodfct</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">goodfct</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">goodfct</span><span class="p">(</span><span class="n">sal</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">depgood</span> <span class="o">&amp;</span> <span class="n">tempgood</span> <span class="o">&amp;</span> <span class="n">salgood</span>
        <span class="n">depcnt</span><span class="p">,</span> <span class="n">tempcnt</span><span class="p">,</span> <span class="n">salcnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">depgood</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempgood</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">salgood</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">totcnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of profiles with valid data:&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  depth:        </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  temperature:  </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  salinity:     </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  total:        </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">depcnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">tempcnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">salcnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">totcnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">totcnt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No valid profiles, aborting&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">igood</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">takefct</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">MV2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">igood</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">takefct</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">takefct</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">takefct</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">takefct</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">depth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span> <span class="o">=</span> <span class="n">takefct</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">takefct</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">takefct</span><span class="p">(</span><span class="n">sal</span><span class="p">)</span>

        <span class="c1"># Restore axes as tz as loaded above</span>
        <span class="n">prof</span><span class="p">,</span> <span class="n">lev</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span><span class="p">),</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">lev</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="n">prof</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">depth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">([</span><span class="n">prof</span><span class="p">,</span> <span class="n">lev</span><span class="p">])</span>
        <span class="c1"># Set correct order for calculation</span>
        <span class="n">depth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;z-&#39;</span><span class="p">),</span> <span class="n">temp</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;z-&#39;</span><span class="p">),</span> <span class="n">sal</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;z-&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Selected data:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prof</span><span class="p">,</span><span class="n">lev</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">depth</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span><span class="n">sal</span><span class="p">)))</span>

        <span class="c1"># Maximum depth indice</span>
        <span class="n">depthimax</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">~</span><span class="n">temp</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;depthimax&#39;</span><span class="p">)</span>
        <span class="c1"># Compute thick for each level</span>
        <span class="n">deltadepth</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">meshweights</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;deltadepth&#39;</span><span class="p">)</span>
        <span class="c1"># Adjust thick of last level</span>
        <span class="c1">#####</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">ddiff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># Error when depth shape is (.., 1) (one profile) ...???</span>
            <span class="c1">#self.exception(&#39;&#39;)</span>
            <span class="n">ddiff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#ddiff = numpy.swapaxes(ddiff, 0, 1)</span>
        <span class="c1">#####</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ddiff: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ddiff</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">depthimax</span><span class="p">):</span>
            <span class="n">deltadepth</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ddiff</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># Compute pressure</span>
        <span class="n">pres</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sw_pres</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;pres&#39;</span><span class="p">)</span>
        <span class="c1"># Compute pressure density</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sw_dens</span><span class="p">(</span><span class="n">sal</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">pres</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;dens&#39;</span><span class="p">)</span>
        <span class="c1"># Compute pressure density min, max and mean</span>
        <span class="n">densmin</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">densmin</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;densmin&#39;</span>
        <span class="n">densmax</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">densmax</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;densmax&#39;</span>
        <span class="n">densmean</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">deltadepth</span><span class="p">)</span>
        <span class="n">densmean</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;densmean&#39;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depthimax</span><span class="p">,</span> <span class="n">deltadepth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Final stratification data:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="ProfilesDataset.get_mld"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_mld">[docs]</a>    <span class="k">def</span> <span class="nf">get_mld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get mixed layer depth</span>

<span class="sd">        MLD is computed for each selected profiles</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector</span>

<span class="sd">        :Return:</span>
<span class="sd">            - mld with shape (profile,)</span>
<span class="sd">            - lat with shape (profile,)</span>
<span class="sd">            - lon with shape (profile,)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depthimax</span><span class="p">,</span> <span class="n">deltadepth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stratification_data</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="c1"># Maximum depth (max + thick * 0.5)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">depth</span><span class="p">[</span><span class="n">depthimax</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltadepth</span><span class="p">[</span><span class="n">depthimax</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;H:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>
        <span class="c1"># Compute Mixed Layer Depth</span>
        <span class="n">mld</span> <span class="o">=</span> <span class="n">H</span><span class="o">*</span><span class="p">(</span><span class="n">densmax</span> <span class="o">-</span> <span class="n">densmean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">densmax</span> <span class="o">-</span> <span class="n">densmin</span><span class="p">)</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;MLD&#39;</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
        <span class="n">mld</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Profondeur de la couche de melange&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;MLD:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">mld</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mld</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="ProfilesDataset.get_ped"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.get_ped">[docs]</a>    <span class="k">def</span> <span class="nf">get_ped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get potential energy deficit</span>

<span class="sd">        PED is computed for each selected profiles</span>

<span class="sd">        :Params:</span>
<span class="sd">            - **select**: selector</span>

<span class="sd">        :Return:</span>
<span class="sd">            - ped with shape (profile,)</span>
<span class="sd">            - lat with shape (profile,)</span>
<span class="sd">            - lon with shape (profile,)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depthimax</span><span class="p">,</span> <span class="n">deltadepth</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sal</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">densmin</span><span class="p">,</span> <span class="n">densmax</span><span class="p">,</span> <span class="n">densmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stratification_data</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">vacumm.misc.phys.constants</span> <span class="k">import</span> <span class="n">g</span>
        <span class="c1"># Anomalie de densitÃ©</span>
        <span class="n">danom</span> <span class="o">=</span> <span class="n">dens</span> <span class="o">-</span> <span class="n">densmean</span>
        <span class="c1"># Ãnergie potentielle disponible</span>
        <span class="n">ape</span> <span class="o">=</span> <span class="n">danom</span> <span class="o">*</span> <span class="n">g</span>
        <span class="n">ape</span> <span class="o">*=</span> <span class="n">deltadepth</span>
        <span class="c1"># Deficit</span>
        <span class="n">ped</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">deltadepth</span><span class="p">)</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;PED&#39;</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;J.m^{-2}&#39;</span>
        <span class="n">ped</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Potential energy deficit&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;PED:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">ped</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ped</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>



<div class="viewcode-block" id="ProfilesDataset.plot_mld"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_mld">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce mixed layer depth map.</span>

<span class="sd">        :Params: see :func:`get_mld`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mld</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mld</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="c1"># Plot</span>
        <span class="c1">#self.psinfo()</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mld</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mld</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;magic&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the map if not provided</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1">#            from matplotlib import mpl</span>
<span class="c1">#            import matplotlib.colorbar</span>
<span class="c1">#            nsteps = 10</span>
<span class="c1">#            step = (vmax-vmin)/nsteps</span>
<span class="c1">#            levels = range(0, vmax+step, step)</span>
<span class="c1">#            colors = [&#39;#0040FF&#39;, &#39;#0080FF&#39;, &#39;#00A2FF&#39;, &#39;#00FFFB&#39;, &#39;#00FF98&#39;, &#39;#5DFF00&#39;, &#39;#BFFF00&#39;, &#39;#F1FF00&#39;, &#39;#FFDD00&#39;, &#39;#FFAC00&#39;, &#39;#FF1800&#39;, &#39;#CE1300&#39;]</span>
<span class="c1">#            colors = colors[-nsteps:]</span>
<span class="c1">#            cmap = mpl.colors.ListedColormap(colors)</span>
<span class="c1">#            norm = mpl.colors.Normalize(vmin=vmin, vmax=vmax)</span>
<span class="c1">#            alpha = 0.8</span>
<span class="c1">#            fig = pylab.gcf()</span>
<span class="c1">#            l,b,w,h = 0.85, 0.1, 0.05, 0.8</span>
<span class="c1">#            ax = fig.add_axes((l,b,w,h))</span>
<span class="c1">#            cb = matplotlib.colorbar.ColorbarBase(ax, cmap=cmap, norm=norm, ticks=levels, alpha=alpha)</span>
<span class="c1">#            cb.set_label(&#39;&#39;)</span>

            <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">c</span><span class="p">))</span>
            <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>

        <span class="c1"># Plot profiles scatter points</span>
        <span class="n">scakw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mld</span><span class="p">,</span> <span class="o">**</span><span class="n">scakw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1">#plotkw.setdefault(&#39;title&#39;, &#39;&#39;)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProfilesDataset.plot_ped"><a class="viewcode-back" href="../../../../library/data.misc.profile.html#vacumm.data.misc.profile.ProfilesDataset.plot_ped">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Produce potential energy deficit map.</span>

<span class="sd">        :Params: see :func:`get_ped`</span>

<span class="sd">        :Plot params:</span>
<span class="sd">            - **map_&lt;keyword&gt;**: are passed to the map plot function :func:`~vacumm.misc.plot.map2` *excepting* those about post plotting described below</span>
<span class="sd">            - **plot_[show|close|savefig|savefigs]**: are passed to the post plotting function :func:`~vacumm.misc.core_plot.Plot.post_plot` at end of plotting operations</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ped</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ped</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="c1"># Plot</span>
        <span class="c1">#self.psinfo()</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ped</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ped</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;magic&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the map if not provided</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1">#            from matplotlib import mpl</span>
<span class="c1">#            import matplotlib.colorbar</span>
<span class="c1">#            nsteps = 10</span>
<span class="c1">#            step = (vmax-vmin)/nsteps</span>
<span class="c1">#            levels = range(0, vmax+step, step)</span>
<span class="c1">#            colors = [&#39;#0040FF&#39;, &#39;#0080FF&#39;, &#39;#00A2FF&#39;, &#39;#00FFFB&#39;, &#39;#00FF98&#39;, &#39;#5DFF00&#39;, &#39;#BFFF00&#39;, &#39;#F1FF00&#39;, &#39;#FFDD00&#39;, &#39;#FFAC00&#39;, &#39;#FF1800&#39;, &#39;#CE1300&#39;]</span>
<span class="c1">#            colors = colors[-nsteps:]</span>
<span class="c1">#            cmap = mpl.colors.ListedColormap(colors)</span>
<span class="c1">#            norm = mpl.colors.Normalize(vmin=vmin, vmax=vmax)</span>
<span class="c1">#            alpha = 0.8</span>
<span class="c1">#            fig = pylab.gcf()</span>
<span class="c1">#            l,b,w,h = 0.85, 0.1, 0.05, 0.8</span>
<span class="c1">#            ax = fig.add_axes((l,b,w,h))</span>
<span class="c1">#            cb = matplotlib.colorbar.ColorbarBase(ax, cmap=cmap, norm=norm, ticks=levels, alpha=alpha)</span>
<span class="c1">#            cb.set_label(&#39;&#39;)</span>

            <span class="n">mapkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">c</span><span class="p">))</span>
            <span class="n">mapkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">map2</span><span class="p">(</span><span class="o">**</span><span class="n">mapkw</span><span class="p">)</span>

        <span class="c1"># Plot profiles scatter points</span>
        <span class="n">scakw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;sca&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ped</span><span class="p">,</span> <span class="o">**</span><span class="n">scakw</span><span class="p">)</span>
        <span class="c1"># Post plotting</span>
        <span class="n">plotkw</span> <span class="o">=</span> <span class="n">kwfilter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">)</span>
        <span class="c1">#plotkw.setdefault(&#39;title&#39;, &#39;&#39;)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">post_plot</span><span class="p">(</span><span class="o">**</span><span class="n">plotkw</span><span class="p">)</span></div></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">Profiles</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>




</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../vacumm.html" >vacumm</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../data.html" >vacumm.data</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>