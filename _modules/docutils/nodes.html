
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>docutils.nodes &#8212; VACUMM v3.6.2 documentation</title>
    <link rel="stylesheet" href="../../_static/vacumm.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<!--<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../static/logo_vacumm.png" border="0" alt="vacumm"/></a>
</div>-->

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo_vacumm.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for docutils.nodes</h1><div class="highlight"><pre>
<span></span><span class="c1"># $Id: nodes.py 7788 2015-02-16 22:10:52Z milde $</span>
<span class="c1"># Author: David Goodger &lt;goodger@python.org&gt;</span>
<span class="c1"># Maintainer: docutils-develop@lists.sourceforge.net</span>
<span class="c1"># Copyright: This module has been placed in the public domain.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Docutils document tree element class library.</span>

<span class="sd">Classes in CamelCase are abstract base classes or auxiliary classes. The one</span>
<span class="sd">exception is `Text`, for a text (PCDATA) node; uppercase is used to</span>
<span class="sd">differentiate from element classes.  Classes in lower_case_with_underscores</span>
<span class="sd">are element classes, matching the XML element generic identifiers in the DTD_.</span>

<span class="sd">The position of each node (the level at which it can occur) is significant and</span>
<span class="sd">is represented by abstract base classes (`Root`, `Structural`, `Body`,</span>
<span class="sd">`Inline`, etc.).  Certain transformations will be easier because we can use</span>
<span class="sd">``isinstance(node, base_class)`` to determine the position of the node in the</span>
<span class="sd">hierarchy.</span>

<span class="sd">.. _DTD: http://docutils.sourceforge.net/docs/ref/docutils.dtd</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;reStructuredText&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>

<span class="c1"># ==============================</span>
<span class="c1">#  Functional Node Base Classes</span>
<span class="c1"># ==============================</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Abstract base class of nodes in a document tree.&quot;&quot;&quot;</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Back-reference to the Node immediately containing this Node.&quot;&quot;&quot;</span>

    <span class="n">document</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The `document` node at the root of the tree containing this Node.&quot;&quot;&quot;</span>

    <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Path or description of the input source which generated this Node.&quot;&quot;&quot;</span>

    <span class="n">line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The line number (1-based) of the beginning of this Node in `source`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Node instances are always true, even if they&#39;re empty.  A node is more</span>
<span class="sd">        than a simple container.  Its boolean &quot;truth&quot; does not depend on</span>
<span class="sd">        having one or more subnodes in the doctree.</span>

<span class="sd">        Use `len()` to check node length.  Use `None` to represent a boolean</span>
<span class="sd">        false value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="c1"># on 2.x, str(node) will be a byte string with Unicode</span>
        <span class="c1"># characters &gt; 255 escaped; on 3.x this is no longer necessary</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;raw_unicode_escape&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asdom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a DOM **fragment** representation of this Node.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">xml.dom.minidom</span> <span class="k">as</span> <span class="nn">dom</span>
        <span class="n">domroot</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">Document</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dom_node</span><span class="p">(</span><span class="n">domroot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an indented pseudo-XML representation, for test purposes.</span>

<span class="sd">        Override in subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of self.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a deep copy of self (also copying children).&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">setup_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_line</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Traverse a tree of `Node` objects, calling the</span>
<span class="sd">        `dispatch_visit()` method of `visitor` when entering each</span>
<span class="sd">        node.  (The `walkabout()` method is similar, except it also</span>
<span class="sd">        calls the `dispatch_departure()` method before exiting each</span>
<span class="sd">        node.)</span>

<span class="sd">        This tree traversal supports limited in-place tree</span>
<span class="sd">        modifications.  Replacing one node with one or more nodes is</span>
<span class="sd">        OK, as is removing an element.  However, if the node removed</span>
<span class="sd">        or replaced occurs after the current node, the old node will</span>
<span class="sd">        still be traversed, and any new nodes will not.</span>

<span class="sd">        Within ``visit`` methods (and ``depart`` methods for</span>
<span class="sd">        `walkabout()`), `TreePruningException` subclasses may be raised</span>
<span class="sd">        (`SkipChildren`, `SkipSiblings`, `SkipNode`, `SkipDeparture`).</span>

<span class="sd">        Parameter `visitor`: A `NodeVisitor` object, containing a</span>
<span class="sd">        ``visit`` implementation for each `Node` subclass encountered.</span>

<span class="sd">        Return true if we should stop the traversal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;docutils.nodes.Node.walk calling dispatch_visit for </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">visitor</span><span class="o">.</span><span class="n">dispatch_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">SkipChildren</span><span class="p">,</span> <span class="n">SkipNode</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">stop</span>
            <span class="k">except</span> <span class="n">SkipDeparture</span><span class="p">:</span>           <span class="c1"># not applicable; ignore</span>
                <span class="k">pass</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">[:]:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">visitor</span><span class="p">):</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="n">SkipSiblings</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="n">StopTraversal</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">stop</span>

    <span class="k">def</span> <span class="nf">walkabout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a tree traversal similarly to `Node.walk()` (which</span>
<span class="sd">        see), except also call the `dispatch_departure()` method</span>
<span class="sd">        before exiting each node.</span>

<span class="sd">        Parameter `visitor`: A `NodeVisitor` object, containing a</span>
<span class="sd">        ``visit`` and ``depart`` implementation for each `Node`</span>
<span class="sd">        subclass encountered.</span>

<span class="sd">        Return true if we should stop the traversal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">call_depart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;docutils.nodes.Node.walkabout calling dispatch_visit for </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">visitor</span><span class="o">.</span><span class="n">dispatch_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SkipNode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stop</span>
            <span class="k">except</span> <span class="n">SkipDeparture</span><span class="p">:</span>
                <span class="n">call_depart</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">[:]:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="n">visitor</span><span class="p">):</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="n">SkipSiblings</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="n">SkipChildren</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">StopTraversal</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">call_depart</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;docutils.nodes.Node.walkabout calling dispatch_departure &#39;</span>
                <span class="s1">&#39;for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">dispatch_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stop</span>

    <span class="k">def</span> <span class="nf">_fast_traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specialized traverse() that only supports instance checks.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">_fast_traverse</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_all_traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specialized traverse() that doesn&#39;t check for a condition.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">_all_traverse</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">descend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">siblings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ascend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterable containing</span>

<span class="sd">        * self (if include_self is true)</span>
<span class="sd">        * all descendants in tree traversal order (if descend is true)</span>
<span class="sd">        * all siblings (if siblings is true) and their descendants (if</span>
<span class="sd">          also descend is true)</span>
<span class="sd">        * the siblings of the parent (if ascend is true) and their</span>
<span class="sd">          descendants (if also descend is true), and so on</span>

<span class="sd">        If `condition` is not None, the iterable contains only nodes</span>
<span class="sd">        for which ``condition(node)`` is true.  If `condition` is a</span>
<span class="sd">        node class ``cls``, it is equivalent to a function consisting</span>
<span class="sd">        of ``return isinstance(node, cls)``.</span>

<span class="sd">        If ascend is true, assume siblings to be true as well.</span>

<span class="sd">        For example, given the following tree::</span>

<span class="sd">            &lt;paragraph&gt;</span>
<span class="sd">                &lt;emphasis&gt;      &lt;--- emphasis.traverse() and</span>
<span class="sd">                    &lt;strong&gt;    &lt;--- strong.traverse() are called.</span>
<span class="sd">                        Foo</span>
<span class="sd">                    Bar</span>
<span class="sd">                &lt;reference name=&quot;Baz&quot; refid=&quot;baz&quot;&gt;</span>
<span class="sd">                    Baz</span>

<span class="sd">        Then list(emphasis.traverse()) equals ::</span>

<span class="sd">            [&lt;emphasis&gt;, &lt;strong&gt;, &lt;#text: Foo&gt;, &lt;#text: Bar&gt;]</span>

<span class="sd">        and list(strong.traverse(ascend=True)) equals ::</span>

<span class="sd">            [&lt;strong&gt;, &lt;#text: Foo&gt;, &lt;#text: Bar&gt;, &lt;reference&gt;, &lt;#text: Baz&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ascend</span><span class="p">:</span>
            <span class="n">siblings</span><span class="o">=</span><span class="kc">True</span>
        <span class="c1"># Check for special argument combinations that allow using an</span>
        <span class="c1"># optimized version of traverse()</span>
        <span class="k">if</span> <span class="n">include_self</span> <span class="ow">and</span> <span class="n">descend</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">siblings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_traverse</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">,</span> <span class="nb">type</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fast_traverse</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="c1"># Check if `condition` is a class (check for TypeType for Python</span>
        <span class="c1"># implementations that use only new-style classes, like PyPy).</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">,</span> <span class="nb">type</span><span class="p">)):</span>
            <span class="n">node_class</span> <span class="o">=</span> <span class="n">condition</span>
            <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_class</span><span class="o">=</span><span class="n">node_class</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_class</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">include_self</span> <span class="ow">and</span> <span class="p">(</span><span class="n">condition</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">condition</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">descend</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">descend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">siblings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ascend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">siblings</span> <span class="ow">or</span> <span class="n">ascend</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sibling</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sibling</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">descend</span><span class="o">=</span><span class="n">descend</span><span class="p">,</span>
                                              <span class="n">siblings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ascend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ascend</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">next_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">descend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">siblings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ascend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first node in the iterable returned by traverse(),</span>
<span class="sd">        or None if the iterable is empty.</span>

<span class="sd">        Parameter list is the same as of traverse.  Note that</span>
<span class="sd">        include_self defaults to 0, though.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
                                 <span class="n">include_self</span><span class="o">=</span><span class="n">include_self</span><span class="p">,</span> <span class="n">descend</span><span class="o">=</span><span class="n">descend</span><span class="p">,</span>
                                 <span class="n">siblings</span><span class="o">=</span><span class="n">siblings</span><span class="p">,</span> <span class="n">ascend</span><span class="o">=</span><span class="n">ascend</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">iterable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="k">class</span> <span class="nc">reprunicode</span><span class="p">(</span><span class="n">unicode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A unicode sub-class that removes the initial u from unicode&#39;s repr.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">unicode</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>


<span class="k">else</span><span class="p">:</span>
    <span class="n">reprunicode</span> <span class="o">=</span> <span class="n">unicode</span>


<span class="k">def</span> <span class="nf">ensure_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Failsave conversion of `unicode` to `str`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;backslashreplace&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">Text</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">reprunicode</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instances are terminal nodes (leaves) containing text only; no child</span>
<span class="sd">    nodes or attributes.  Initialize by passing a string to the constructor.</span>
<span class="sd">    Access the text itself with the `astext` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tagname</span> <span class="o">=</span> <span class="s1">&#39;#text&#39;</span>

    <span class="n">children</span> <span class="o">=</span> <span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Text nodes have no children, and cannot have children.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Prevent the rawsource argument from propagating to str.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;expecting str data, not bytes&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reprunicode</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Prevent the rawsource argument from propagating to str.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">reprunicode</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rawsource</span> <span class="o">=</span> <span class="n">rawsource</span>
        <span class="sd">&quot;&quot;&quot;The raw text from which this element was constructed.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">shortrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">maxlen</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">,</span> <span class="n">reprunicode</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortrepr</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">68</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dom_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domroot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domroot</span><span class="o">.</span><span class="n">createTextNode</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reprunicode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Note about __unicode__: The implementation of __unicode__ here,</span>
    <span class="c1"># and the one raising NotImplemented in the superclass Node had</span>
    <span class="c1"># to be removed when changing Text to a subclass of unicode instead</span>
    <span class="c1"># of UserString, since there is no way to delegate the __unicode__</span>
    <span class="c1"># call to the superclass unicode:</span>
    <span class="c1"># unicode itself does not have __unicode__ method to delegate to</span>
    <span class="c1"># and calling unicode(self) or unicode.__new__ directly creates</span>
    <span class="c1"># an infinite loop</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">reprunicode</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">rawsource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rawsource</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">*</span> <span class="n">level</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># rstrip and lstrip are used by substitution definitions where</span>
    <span class="c1"># they are expected to return a Text instance, this was formerly</span>
    <span class="c1"># taken care of by UserString. Note that then and now the</span>
    <span class="c1"># rawsource member is lost.</span>

    <span class="k">def</span> <span class="nf">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">reprunicode</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">lstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">reprunicode</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `Element` is the superclass to all specific elements.</span>

<span class="sd">    Elements contain attributes and child nodes.  Elements emulate</span>
<span class="sd">    dictionaries for attributes, indexing by attribute name (a string).  To</span>
<span class="sd">    set the attribute &#39;att&#39; to &#39;value&#39;, do::</span>

<span class="sd">        element[&#39;att&#39;] = &#39;value&#39;</span>

<span class="sd">    There are two special attributes: &#39;ids&#39; and &#39;names&#39;.  Both are</span>
<span class="sd">    lists of unique identifiers, and names serve as human interfaces</span>
<span class="sd">    to IDs.  Names are case- and whitespace-normalized (see the</span>
<span class="sd">    fully_normalize_name() function), and IDs conform to the regular</span>
<span class="sd">    expression ``[a-z](-?[a-z0-9]+)*`` (see the make_id() function).</span>

<span class="sd">    Elements also emulate lists for child nodes (element nodes and/or text</span>
<span class="sd">    nodes), indexing by integer.  To get the first child node, use::</span>

<span class="sd">        element[0]</span>

<span class="sd">    Elements may be constructed using the ``+=`` operator.  To add one new</span>
<span class="sd">    child node to element, do::</span>

<span class="sd">        element += node</span>

<span class="sd">    This is equivalent to ``element.append(node)``.</span>

<span class="sd">    To add a list of multiple child nodes at once, use the same ``+=``</span>
<span class="sd">    operator::</span>

<span class="sd">        element += [node1, node2]</span>

<span class="sd">    This is equivalent to ``element.extend([node1, node2])``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">basic_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="s1">&#39;dupnames&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;List attributes which are defined for every Element-derived class</span>
<span class="sd">    instance and can be safely transferred to a different node.&quot;&quot;&quot;</span>

    <span class="n">local_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;backrefs&#39;</span><span class="p">,)</span>
    <span class="sd">&quot;&quot;&quot;A list of class-specific attributes that should not be copied with the</span>
<span class="sd">    standard attributes when replacing a node.</span>

<span class="sd">    NOTE: Derived classes should override this value to prevent any of its</span>
<span class="sd">    attributes being copied by adding to the value in its parent class.&quot;&quot;&quot;</span>

    <span class="n">list_attributes</span> <span class="o">=</span> <span class="n">basic_attributes</span> <span class="o">+</span> <span class="n">local_attributes</span>
    <span class="sd">&quot;&quot;&quot;List attributes, automatically initialized to empty lists for</span>
<span class="sd">    all nodes.&quot;&quot;&quot;</span>

    <span class="n">known_attributes</span> <span class="o">=</span> <span class="n">list_attributes</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,)</span>
    <span class="sd">&quot;&quot;&quot;List attributes that are known to the Element base class.&quot;&quot;&quot;</span>

    <span class="n">tagname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The element generic identifier. If None, it is set as an instance</span>
<span class="sd">    attribute to the name of the class.&quot;&quot;&quot;</span>

    <span class="n">child_text_separator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="sd">&quot;&quot;&quot;Separator for child nodes, used by `astext()` method.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawsource</span> <span class="o">=</span> <span class="n">rawsource</span>
        <span class="sd">&quot;&quot;&quot;The raw text from which this element was constructed.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of child nodes (elements and/or `Text`).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>           <span class="c1"># maintain parent info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of attribute {name: value}.&quot;&quot;&quot;</span>

        <span class="c1"># Initialize list attributes.</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_attributes</span><span class="p">:</span>
                <span class="c1"># mutable list; make a copy for this node</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">_dom_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domroot</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">domroot</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attlist</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">serial_escape</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">element</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">_dom_node</span><span class="p">(</span><span class="n">domroot</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">element</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">shortrepr</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">56</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ensure_str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]]),</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shortrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;...&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ensure_str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">...&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(),</span>
                                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">unicode</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">endtag</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptytag</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="c1"># 2to3 doesn&#39;t convert __unicode__ to __str__</span>
        <span class="fm">__str__</span> <span class="o">=</span> <span class="n">__unicode__</span>

    <span class="k">def</span> <span class="nf">starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quoteattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># the optional arg is used by the docutils_xml writer</span>
        <span class="k">if</span> <span class="n">quoteattr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">quoteattr</span> <span class="o">=</span> <span class="n">pseudo_quoteattr</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attlist</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>           <span class="c1"># boolean attribute</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=&quot;True&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">serial_escape</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">quoteattr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;/</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span>

    <span class="k">def</span> <span class="nf">emptytag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">/&gt;&#39;</span> <span class="o">%</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attlist</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># support both membership test for children and attributes</span>
        <span class="c1"># (has_key is translated to &quot;in&quot; by 2to3)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;cannot handle slice with stride&#39;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">key</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;element index must be an integer, a slice, or &#39;</span>
                              <span class="s1">&#39;an attribute name string&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;cannot handle slice with stride&#39;</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">key</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;element index must be an integer, a slice, or &#39;</span>
                              <span class="s1">&#39;an attribute name string&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;cannot handle slice with stride&#39;</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">key</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;element index must be an integer, a simple &#39;</span>
                              <span class="s1">&#39;slice, or an attribute name string&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a node or a list of nodes to `self.children`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_text_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
              <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">non_default_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_default</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">atts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">atts</span>

    <span class="k">def</span> <span class="nf">attlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_default_attributes</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">attlist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attlist</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">failobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">failobj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>

    <span class="k">def</span> <span class="nf">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">failobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">failobj</span><span class="p">)</span>

    <span class="n">has_key</span> <span class="o">=</span> <span class="nb">hasattr</span>

    <span class="c1"># support operator ``in``</span>
    <span class="fm">__contains__</span> <span class="o">=</span> <span class="nb">hasattr</span>

    <span class="k">def</span> <span class="nf">get_language_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return node&#39;s language tag.</span>

<span class="sd">        Look iteratively in self and parents for a class argument</span>
<span class="sd">        starting with ``language-`` and return the remainder of it</span>
<span class="sd">        (which should be a `BCP49` language tag) or the `fallback`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;language-&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_language</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fallback</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_not_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update_basic_atts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) from node or dictionary `dict_`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_attr_list</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">def</span> <span class="nf">append_attr_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each element in values, if it does not exist in self[attr], append</span>
<span class="sd">        it.</span>

<span class="sd">        NOTE: Requires self[attr] and values to be sequence type and the</span>
<span class="sd">        former should specifically be a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List Concatenation</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">coerce_append_attr_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First, convert both self[attr] and value to a non-string sequence</span>
<span class="sd">        type; if either is not already a sequence, convert it to a list of one</span>
<span class="sd">        element.  Then call append_attr_list.</span>

<span class="sd">        NOTE: self[attr] and value both must not be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List Concatenation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_attr_list</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replace_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If self[attr] does not exist or force is True or omitted, set</span>
<span class="sd">        self[attr] to value, otherwise do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># One or the other</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">copy_attr_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If attr is an attribute of self, set self[attr] to</span>
<span class="sd">        [self[attr], value], otherwise set self[attr] to value.</span>

<span class="sd">        NOTE: replace is not used by this function and is kept only for</span>
<span class="sd">              compatibility with the other copy functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coerce_append_attr_list</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_attr_coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If attr is an attribute of self and either self[attr] or value is a</span>
<span class="sd">        list, convert all non-sequence values to a sequence of 1 element and</span>
<span class="sd">        then concatenate the two sequence, setting the result to self[attr].</span>
<span class="sd">        If both self[attr] and value are non-sequences and replace is True or</span>
<span class="sd">        self[attr] is None, replace self[attr] with value. Otherwise, do</span>
<span class="sd">        nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coerce_append_attr_list</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replace_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_attr_concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If attr is an attribute of self and both self[attr] and value are</span>
<span class="sd">        lists, concatenate the two sequences, setting the result to</span>
<span class="sd">        self[attr].  If either self[attr] or value are non-sequences and</span>
<span class="sd">        replace is True or self[attr] is None, replace self[attr] with value.</span>
<span class="sd">        Otherwise, do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_attr_list</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replace_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_attr_consistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If replace is True or selfpattr] is None, replace self[attr] with</span>
<span class="sd">        value.  Otherwise, do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replace_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_all_atts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">update_fun</span> <span class="o">=</span> <span class="n">copy_attr_consistent</span><span class="p">,</span>
                        <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">and_source</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all attributes from node or dictionary `dict_`.</span>

<span class="sd">        Appends the basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) and then, for all other attributes in</span>
<span class="sd">        dict_, updates the same attribute in self.  When attributes with the</span>
<span class="sd">        same identifier appear in both self and dict_, the two values are</span>
<span class="sd">        merged based on the value of update_fun.  Generally, when replace is</span>
<span class="sd">        True, the values in self are replaced or merged with the values in</span>
<span class="sd">        dict_; otherwise, the values in self may be preserved or merged.  When</span>
<span class="sd">        and_source is True, the &#39;source&#39; attribute is included in the copy.</span>

<span class="sd">        NOTE: When replace is False, and self contains a &#39;source&#39; attribute,</span>
<span class="sd">              &#39;source&#39; is not replaced even when dict_ has a &#39;source&#39;</span>
<span class="sd">              attribute, though it may still be merged into a list depending</span>
<span class="sd">              on the value of update_fun.</span>
<span class="sd">        NOTE: It is easier to call the update-specific methods then to pass</span>
<span class="sd">              the update_fun method to this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">attributes</span>

        <span class="c1"># Include the source attribute when copying?</span>
        <span class="k">if</span> <span class="n">and_source</span><span class="p">:</span>
            <span class="n">filter_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_list_attribute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_known_attribute</span>

        <span class="c1"># Copy the basic attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_basic_atts</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>

        <span class="c1"># Grab other attributes in dict_ not in self except the</span>
        <span class="c1"># (All basic attributes should be copied already)</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">filter_fun</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
            <span class="n">update_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">dict_</span><span class="p">[</span><span class="n">att</span><span class="p">],</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_all_atts_consistantly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">and_source</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all attributes from node or dictionary `dict_`.</span>

<span class="sd">        Appends the basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) and then, for all other attributes in</span>
<span class="sd">        dict_, updates the same attribute in self.  When attributes with the</span>
<span class="sd">        same identifier appear in both self and dict_ and replace is True, the</span>
<span class="sd">        values in self are replaced with the values in dict_; otherwise, the</span>
<span class="sd">        values in self are preserved.  When and_source is True, the &#39;source&#39;</span>
<span class="sd">        attribute is included in the copy.</span>

<span class="sd">        NOTE: When replace is False, and self contains a &#39;source&#39; attribute,</span>
<span class="sd">              &#39;source&#39; is not replaced even when dict_ has a &#39;source&#39;</span>
<span class="sd">              attribute, though it may still be merged into a list depending</span>
<span class="sd">              on the value of update_fun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_atts</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Element</span><span class="o">.</span><span class="n">copy_attr_consistent</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span>
                             <span class="n">and_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_all_atts_concatenating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="n">and_source</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all attributes from node or dictionary `dict_`.</span>

<span class="sd">        Appends the basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) and then, for all other attributes in</span>
<span class="sd">        dict_, updates the same attribute in self.  When attributes with the</span>
<span class="sd">        same identifier appear in both self and dict_ whose values aren&#39;t each</span>
<span class="sd">        lists and replace is True, the values in self are replaced with the</span>
<span class="sd">        values in dict_; if the values from self and dict_ for the given</span>
<span class="sd">        identifier are both of list type, then the two lists are concatenated</span>
<span class="sd">        and the result stored in self; otherwise, the values in self are</span>
<span class="sd">        preserved.  When and_source is True, the &#39;source&#39; attribute is</span>
<span class="sd">        included in the copy.</span>

<span class="sd">        NOTE: When replace is False, and self contains a &#39;source&#39; attribute,</span>
<span class="sd">              &#39;source&#39; is not replaced even when dict_ has a &#39;source&#39;</span>
<span class="sd">              attribute, though it may still be merged into a list depending</span>
<span class="sd">              on the value of update_fun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_atts</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Element</span><span class="o">.</span><span class="n">copy_attr_concatenate</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span>
                             <span class="n">and_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_all_atts_coercion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">and_source</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all attributes from node or dictionary `dict_`.</span>

<span class="sd">        Appends the basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) and then, for all other attributes in</span>
<span class="sd">        dict_, updates the same attribute in self.  When attributes with the</span>
<span class="sd">        same identifier appear in both self and dict_ whose values are both</span>
<span class="sd">        not lists and replace is True, the values in self are replaced with</span>
<span class="sd">        the values in dict_; if either of the values from self and dict_ for</span>
<span class="sd">        the given identifier are of list type, then first any non-lists are</span>
<span class="sd">        converted to 1-element lists and then the two lists are concatenated</span>
<span class="sd">        and the result stored in self; otherwise, the values in self are</span>
<span class="sd">        preserved.  When and_source is True, the &#39;source&#39; attribute is</span>
<span class="sd">        included in the copy.</span>

<span class="sd">        NOTE: When replace is False, and self contains a &#39;source&#39; attribute,</span>
<span class="sd">              &#39;source&#39; is not replaced even when dict_ has a &#39;source&#39;</span>
<span class="sd">              attribute, though it may still be merged into a list depending</span>
<span class="sd">              on the value of update_fun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_atts</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Element</span><span class="o">.</span><span class="n">copy_attr_coerce</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span>
                             <span class="n">and_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_all_atts_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">and_source</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all attributes from node or dictionary `dict_`.</span>

<span class="sd">        Appends the basic attributes (&#39;ids&#39;, &#39;names&#39;, &#39;classes&#39;,</span>
<span class="sd">        &#39;dupnames&#39;, but not &#39;source&#39;) and then, for all other attributes in</span>
<span class="sd">        dict_, updates the same attribute in self.  When attributes with the</span>
<span class="sd">        same identifier appear in both self and dict_ then first any non-lists</span>
<span class="sd">        are converted to 1-element lists and then the two lists are</span>
<span class="sd">        concatenated and the result stored in self; otherwise, the values in</span>
<span class="sd">        self are preserved.  When and_source is True, the &#39;source&#39; attribute</span>
<span class="sd">        is included in the copy.</span>

<span class="sd">        NOTE: When replace is False, and self contains a &#39;source&#39; attribute,</span>
<span class="sd">              &#39;source&#39; is not replaced even when dict_ has a &#39;source&#39;</span>
<span class="sd">              attribute, though it may still be merged into a list depending</span>
<span class="sd">              on the value of update_fun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_atts</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">Element</span><span class="o">.</span><span class="n">copy_attr_convert</span><span class="p">,</span>
                             <span class="n">and_source</span> <span class="o">=</span> <span class="n">and_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace one child `Node` with another child or children.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_child</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">elif</span> <span class="n">new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">replace_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace `self` node with `new`, where `new` is a node or a</span>
<span class="sd">        list of nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="c1"># `new` is a list; update first child.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">update</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>
            <span class="n">update</span><span class="o">.</span><span class="n">update_basic_atts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># `update` is a Text node or `new` is an empty list.</span>
            <span class="c1"># Assert that we aren&#39;t losing any attributes.</span>
            <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_attributes</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">[</span><span class="n">att</span><span class="p">],</span> \
                       <span class="s1">&#39;Losing &quot;</span><span class="si">%s</span><span class="s1">&quot; attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">att</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">first_child_matching_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">childclass</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the index of the first child whose class exactly matches.</span>

<span class="sd">        Parameters:</span>

<span class="sd">        - `childclass`: A `Node` subclass to search for, or a tuple of `Node`</span>
<span class="sd">          classes. If a tuple, any of the classes may match.</span>
<span class="sd">        - `start`: Initial index to check.</span>
<span class="sd">        - `end`: Initial index to *not* check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">childclass</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">childclass</span> <span class="o">=</span> <span class="p">(</span><span class="n">childclass</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">end</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">childclass</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">c</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">index</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">first_child_not_matching_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">childclass</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">end</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the index of the first child whose class does *not* match.</span>

<span class="sd">        Parameters:</span>

<span class="sd">        - `childclass`: A `Node` subclass to skip, or a tuple of `Node`</span>
<span class="sd">          classes. If a tuple, none of the classes may match.</span>
<span class="sd">        - `start`: Initial index to check.</span>
<span class="sd">        - `end`: Initial index to *not* check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">childclass</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">childclass</span> <span class="o">=</span> <span class="p">(</span><span class="n">childclass</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">end</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">childclass</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">c</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">())]</span> <span class="o">+</span>
                       <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">rawsource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rawsource</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">child</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">set_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new class to the &quot;classes&quot; attribute.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;docutils.nodes.Element.set_class deprecated; &#39;</span>
                      <span class="s2">&quot;append to Element[&#39;classes&#39;] list attribute directly&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">note_referenced_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that this Element has been referenced by its name</span>
<span class="sd">        `name` or id `id`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referenced</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Element.expect_referenced_by_* dictionaries map names or ids</span>
        <span class="c1"># to nodes whose ``referenced`` attribute is set to true as</span>
        <span class="c1"># soon as this node is referenced by the given name or id.</span>
        <span class="c1"># Needed for target propagation.</span>
        <span class="n">by_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;expect_referenced_by_name&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">by_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;expect_referenced_by_id&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">by_name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">by_name</span><span class="o">.</span><span class="n">referenced</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">by_id</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">by_id</span><span class="o">.</span><span class="n">referenced</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_not_list_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if and only if the given attribute is NOT one of the</span>
<span class="sd">        basic list attributes defined for all Elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">list_attributes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_not_known_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if and only if the given attribute is NOT recognized by</span>
<span class="sd">        this class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">known_attributes</span>


<span class="k">class</span> <span class="nc">TextElement</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An element which directly contains text.</span>

<span class="sd">    Its children are all `Text` or `Inline` subclass nodes.  You can</span>
<span class="sd">    check whether an element&#39;s context is inline simply by checking whether</span>
<span class="sd">    its immediate parent is a `TextElement` instance (including subclasses).</span>
<span class="sd">    This is handy for nodes like `image` that can appear both inline and as</span>
<span class="sd">    standalone body elements.</span>

<span class="sd">    If passing children to `__init__()`, make sure to set `text` to</span>
<span class="sd">    ``&#39;&#39;`` or some other suitable value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">child_text_separator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot;Separator for child nodes, used by `astext()` method.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">textnode</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">Element</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="n">textnode</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Element</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FixedTextElement</span><span class="p">(</span><span class="n">TextElement</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An element which directly contains preformatted text.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="n">TextElement</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;xml:space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;preserve&#39;</span>


<span class="c1"># ========</span>
<span class="c1">#  Mixins</span>
<span class="c1"># ========</span>

<span class="k">class</span> <span class="nc">Resolvable</span><span class="p">:</span>

    <span class="n">resolved</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">BackLinkable</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">add_backref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refid</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;backrefs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refid</span><span class="p">)</span>


<span class="c1"># ====================</span>
<span class="c1">#  Element Categories</span>
<span class="c1"># ====================</span>

<span class="k">class</span> <span class="nc">Root</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Titular</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">PreBibliographic</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Category of Node which may occur before Bibliographic Nodes.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Bibliographic</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Decorative</span><span class="p">(</span><span class="n">PreBibliographic</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Structural</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Body</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">General</span><span class="p">(</span><span class="n">Body</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Sequential</span><span class="p">(</span><span class="n">Body</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List-like elements.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Admonition</span><span class="p">(</span><span class="n">Body</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Special</span><span class="p">(</span><span class="n">Body</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Special internal body elements.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Invisible</span><span class="p">(</span><span class="n">PreBibliographic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal elements that don&#39;t appear in output.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Part</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Inline</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Referential</span><span class="p">(</span><span class="n">Resolvable</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Targetable</span><span class="p">(</span><span class="n">Resolvable</span><span class="p">):</span>

    <span class="n">referenced</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">indirect_reference_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Holds the whitespace_normalized_name (contains mixed case) of a target.</span>
<span class="sd">    Required for MoinMoin/reST compatibility.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Labeled</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Contains a `label` as its first element.&quot;&quot;&quot;</span>


<span class="c1"># ==============</span>
<span class="c1">#  Root Element</span>
<span class="c1"># ==============</span>

<span class="k">class</span> <span class="nc">document</span><span class="p">(</span><span class="n">Root</span><span class="p">,</span> <span class="n">Structural</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The document root element.</span>

<span class="sd">    Do not instantiate this class directly; use</span>
<span class="sd">    `docutils.utils.new_document()` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Element</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Path to or description of the input source being processed.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Line number (1-based) of `current_source`.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="sd">&quot;&quot;&quot;Runtime settings data record.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span> <span class="o">=</span> <span class="n">reporter</span>
        <span class="sd">&quot;&quot;&quot;System message generator.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indirect_targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of indirect target nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">substitution_defs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of substitution names to substitution_definition nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">substitution_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of case-normalized substitution names to case-sensitive</span>
<span class="sd">        names.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refnames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of names to lists of referencing nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of ids to lists of referencing nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of names to unique id&#39;s.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nametypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of names to hyperlink type (boolean: True =&gt; explicit,</span>
<span class="sd">        False =&gt; implicit.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of ids to nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">footnote_refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of footnote labels to lists of footnote_reference nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">citation_refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Mapping of citation labels to lists of citation_reference nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autofootnotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of auto-numbered footnote nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autofootnote_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of auto-numbered footnote_reference nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_footnotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of symbol footnote nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_footnote_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of symbol footnote_reference nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of manually-numbered footnote nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">citations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of citation nodes.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autofootnote_start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="sd">&quot;&quot;&quot;Initial auto-numbered footnote number.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_footnote_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;Initial symbol footnote symbol index.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="sd">&quot;&quot;&quot;Initial ID number.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;System messages generated while parsing.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;System messages generated while applying transforms.&quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">docutils.transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Storage for transforms to be applied to this document.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decoration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Document&#39;s `decoration` node.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dict with unpicklable references removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reporter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;transformer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">asdom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a DOM representation of this document.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">xml.dom.minidom</span> <span class="k">as</span> <span class="nn">dom</span>
        <span class="n">domroot</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">Document</span><span class="p">()</span>
        <span class="n">domroot</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dom_node</span><span class="p">(</span><span class="n">domroot</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">domroot</span>

    <span class="k">def</span> <span class="nf">set_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">msgnode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">severe</span><span class="p">(</span><span class="s1">&#39;Duplicate ID: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">msgnode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msgnode</span> <span class="o">+=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">+</span> <span class="n">make_id</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">or</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">auto_id_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_start</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">id_start</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">set_name_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msgnode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `self.nameids` maps names to IDs, while `self.nametypes` maps names to</span>
<span class="sd">        booleans representing hyperlink type (True==explicit,</span>
<span class="sd">        False==implicit).  This method updates the mappings.</span>

<span class="sd">        The following state transition table shows how `self.nameids` (&quot;ids&quot;)</span>
<span class="sd">        and `self.nametypes` (&quot;types&quot;) change with new input (a call to this</span>
<span class="sd">        method), and what actions are performed (&quot;implicit&quot;-type system</span>
<span class="sd">        messages are INFO/1, and &quot;explicit&quot;-type system messages are ERROR/3):</span>

<span class="sd">        ====  =====  ========  ========  =======  ====  =====  =====</span>
<span class="sd">         Old State    Input          Action        New State   Notes</span>
<span class="sd">        -----------  --------  -----------------  -----------  -----</span>
<span class="sd">        ids   types  new type  sys.msg.  dupname  ids   types</span>
<span class="sd">        ====  =====  ========  ========  =======  ====  =====  =====</span>
<span class="sd">        -     -      explicit  -         -        new   True</span>
<span class="sd">        -     -      implicit  -         -        new   False</span>
<span class="sd">        None  False  explicit  -         -        new   True</span>
<span class="sd">        old   False  explicit  implicit  old      new   True</span>
<span class="sd">        None  True   explicit  explicit  new      None  True</span>
<span class="sd">        old   True   explicit  explicit  new,old  None  True   [#]_</span>
<span class="sd">        None  False  implicit  implicit  new      None  False</span>
<span class="sd">        old   False  implicit  implicit  new,old  None  False</span>
<span class="sd">        None  True   implicit  implicit  new      None  True</span>
<span class="sd">        old   True   implicit  implicit  new      old   True</span>
<span class="sd">        ====  =====  ========  ========  =======  ====  =====  =====</span>

<span class="sd">        .. [#] Do not clear the name-to-id map or invalidate the old target if</span>
<span class="sd">           both old and new targets are external and refer to identical URIs.</span>
<span class="sd">           The new target is invalidated regardless.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_duplicate_name_id</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">,</span> <span class="n">explicit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nametypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">explicit</span>

    <span class="k">def</span> <span class="nf">set_duplicate_name_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">,</span> <span class="n">explicit</span><span class="p">):</span>
        <span class="n">old_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">old_explicit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nametypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nametypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_explicit</span> <span class="ow">or</span> <span class="n">explicit</span>
        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_explicit</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">old_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">old_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">old_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;refuri&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                        <span class="n">refuri</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">old_node</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> \
                               <span class="ow">and</span> <span class="s1">&#39;refuri&#39;</span> <span class="ow">in</span> <span class="n">old_node</span> \
                               <span class="ow">and</span> <span class="n">old_node</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">refuri</span><span class="p">:</span>
                            <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># just inform if refuri&#39;s identical</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dupname</span><span class="p">(</span><span class="n">old_node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">system_message</span><span class="p">(</span>
                    <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;Duplicate explicit target name: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                    <span class="n">backrefs</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">base_node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">msgnode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msgnode</span> <span class="o">+=</span> <span class="n">msg</span>
                <span class="n">dupname</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                <span class="k">if</span> <span class="n">old_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">old_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">old_id</span><span class="p">]</span>
                    <span class="n">dupname</span><span class="p">(</span><span class="n">old_node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">old_explicit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">old_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">old_id</span><span class="p">]</span>
                <span class="n">dupname</span><span class="p">(</span><span class="n">old_node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">dupname</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">explicit</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">old_explicit</span> <span class="ow">and</span> <span class="n">old_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Duplicate implicit target name: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                <span class="n">backrefs</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">base_node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msgnode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msgnode</span> <span class="o">+=</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">has_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameids</span>

    <span class="c1"># &quot;note&quot; here is an imperative verb: &quot;take note of&quot;.</span>
    <span class="k">def</span> <span class="nf">note_implicit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">msgnode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name_id_map</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_explicit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">msgnode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name_id_map</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msgnode</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_refname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refnames</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refname&#39;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_refid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refids</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_indirect_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indirect_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note_refname</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_anonymous_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_autofootnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnote</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autofootnotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_autofootnote_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autofootnote_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_symbol_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnote</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_footnotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_symbol_footnote_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_footnote_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnote</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_footnote_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnote_refs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;refname&#39;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note_refname</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citation</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_citation_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citation_refs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;refname&#39;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note_refname</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_substitution_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdef</span><span class="p">,</span> <span class="n">def_name</span><span class="p">,</span> <span class="n">msgnode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">whitespace_normalize_name</span><span class="p">(</span><span class="n">def_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitution_defs</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                  <span class="s1">&#39;Duplicate substitution definition name: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                  <span class="n">base_node</span><span class="o">=</span><span class="n">subdef</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msgnode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msgnode</span> <span class="o">+=</span> <span class="n">msg</span>
            <span class="n">oldnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitution_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">dupname</span><span class="p">(</span><span class="n">oldnode</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># keep only the last definition:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substitution_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdef</span>
        <span class="c1"># case-insensitive mapping:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substitution_names</span><span class="p">[</span><span class="n">fully_normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">note_substitution_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subref</span><span class="p">,</span> <span class="n">refname</span><span class="p">):</span>
        <span class="n">subref</span><span class="p">[</span><span class="s1">&#39;refname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">whitespace_normalize_name</span><span class="p">(</span><span class="n">refname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">add_pending</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_parse_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_transform_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="p">,</span>
                              <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_decoration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoration</span> <span class="o">=</span> <span class="n">decoration</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_child_not_matching_class</span><span class="p">(</span><span class="n">Titular</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoration</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoration</span>


<span class="c1"># ================</span>
<span class="c1">#  Title Elements</span>
<span class="c1"># ================</span>

<span class="k">class</span> <span class="nc">title</span><span class="p">(</span><span class="n">Titular</span><span class="p">,</span> <span class="n">PreBibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">subtitle</span><span class="p">(</span><span class="n">Titular</span><span class="p">,</span> <span class="n">PreBibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">rubric</span><span class="p">(</span><span class="n">Titular</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># ========================</span>
<span class="c1">#  Bibliographic Elements</span>
<span class="c1"># ========================</span>

<span class="k">class</span> <span class="nc">docinfo</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">author</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">authors</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">organization</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">address</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">contact</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">version</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">revision</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">status</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">date</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">copyright</span><span class="p">(</span><span class="n">Bibliographic</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># =====================</span>
<span class="c1">#  Decorative Elements</span>
<span class="c1"># =====================</span>

<span class="k">class</span> <span class="nc">decoration</span><span class="p">(</span><span class="n">Decorative</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_footer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">footer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footer</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">header</span><span class="p">(</span><span class="n">Decorative</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">footer</span><span class="p">(</span><span class="n">Decorative</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># =====================</span>
<span class="c1">#  Structural Elements</span>
<span class="c1"># =====================</span>

<span class="k">class</span> <span class="nc">section</span><span class="p">(</span><span class="n">Structural</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">topic</span><span class="p">(</span><span class="n">Structural</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Topics are terminal, &quot;leaf&quot; mini-sections, like block quotes with titles,</span>
<span class="sd">    or textual figures.  A topic is just like a section, except that it has no</span>
<span class="sd">    subsections, and it doesn&#39;t have to conform to section placement rules.</span>

<span class="sd">    Topics are allowed wherever body elements (list, table, etc.) are allowed,</span>
<span class="sd">    but only at the top level of a section or document.  Topics cannot nest</span>
<span class="sd">    inside topics, sidebars, or body elements; you can&#39;t have a topic inside a</span>
<span class="sd">    table, list, block quote, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">sidebar</span><span class="p">(</span><span class="n">Structural</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sidebars are like miniature, parallel documents that occur inside other</span>
<span class="sd">    documents, providing related or reference material.  A sidebar is</span>
<span class="sd">    typically offset by a border and &quot;floats&quot; to the side of the page; the</span>
<span class="sd">    document&#39;s main text may flow around it.  Sidebars can also be likened to</span>
<span class="sd">    super-footnotes; their content is outside of the flow of the document&#39;s</span>
<span class="sd">    main text.</span>

<span class="sd">    Sidebars are allowed wherever body elements (list, table, etc.) are</span>
<span class="sd">    allowed, but only at the top level of a section or document.  Sidebars</span>
<span class="sd">    cannot nest inside sidebars, topics, or body elements; you can&#39;t have a</span>
<span class="sd">    sidebar inside a table, list, block quote, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">transition</span><span class="p">(</span><span class="n">Structural</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># ===============</span>
<span class="c1">#  Body Elements</span>
<span class="c1"># ===============</span>

<span class="k">class</span> <span class="nc">paragraph</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">compound</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">container</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">bullet_list</span><span class="p">(</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">enumerated_list</span><span class="p">(</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">list_item</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">definition_list</span><span class="p">(</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">definition_list_item</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">term</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">classifier</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">definition</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">field_list</span><span class="p">(</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">field</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">field_name</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">field_body</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">option</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="n">child_text_separator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


<span class="k">class</span> <span class="nc">option_argument</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TextElement</span><span class="o">.</span><span class="n">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">option_group</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="n">child_text_separator</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>


<span class="k">class</span> <span class="nc">option_list</span><span class="p">(</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">option_list_item</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="n">child_text_separator</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>


<span class="k">class</span> <span class="nc">option_string</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">description</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">literal_block</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">doctest_block</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">math_block</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">line_block</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">line</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span>

    <span class="n">indent</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">block_quote</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">attribution</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">attention</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">caution</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">danger</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">error</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">important</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">note</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">tip</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">hint</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">warning</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">admonition</span><span class="p">(</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">comment</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">Invisible</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">substitution_definition</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">Invisible</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">target</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">Invisible</span><span class="p">,</span> <span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">,</span> <span class="n">Targetable</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">footnote</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">BackLinkable</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Labeled</span><span class="p">,</span> <span class="n">Targetable</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">citation</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">BackLinkable</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Labeled</span><span class="p">,</span> <span class="n">Targetable</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">label</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">figure</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">caption</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">legend</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">table</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">tgroup</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">colspec</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">thead</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">tbody</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">row</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">entry</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">system_message</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">BackLinkable</span><span class="p">,</span> <span class="n">PreBibliographic</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    System message element.</span>

<span class="sd">    Do not instantiate this class directly; use</span>
<span class="sd">    ``document.reporter.info/warning/error/severe()`` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">paragraph</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">,)</span> <span class="o">+</span> <span class="n">children</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Element</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;system_message: children=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">children</span><span class="p">,)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">: (</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">],</span> <span class="n">Element</span><span class="o">.</span><span class="n">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">pending</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">Invisible</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The &quot;pending&quot; element is used to encapsulate a pending operation: the</span>
<span class="sd">    operation (transform), the point at which to apply it, and any data it</span>
<span class="sd">    requires.  Only the pending operation&#39;s location within the document is</span>
<span class="sd">    stored in the public document tree (by the &quot;pending&quot; object itself); the</span>
<span class="sd">    operation and its data are stored in the &quot;pending&quot; object&#39;s internal</span>
<span class="sd">    instance attributes.</span>

<span class="sd">    For example, say you want a table of contents in your reStructuredText</span>
<span class="sd">    document.  The easiest way to specify where to put it is from within the</span>
<span class="sd">    document, with a directive::</span>

<span class="sd">        .. contents::</span>

<span class="sd">    But the &quot;contents&quot; directive can&#39;t do its work until the entire document</span>
<span class="sd">    has been parsed and possibly transformed to some extent.  So the directive</span>
<span class="sd">    code leaves a placeholder behind that will trigger the second phase of its</span>
<span class="sd">    processing, something like this::</span>

<span class="sd">        &lt;pending ...public attributes...&gt; + internal attributes</span>

<span class="sd">    Use `document.note_pending()` so that the</span>
<span class="sd">    `docutils.transforms.Transformer` stage of processing can run all pending</span>
<span class="sd">    transforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rawsource</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="n">Element</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="sd">&quot;&quot;&quot;The `docutils.transforms.Transform` class implementing the pending</span>
<span class="sd">        operation.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Detail data (dictionary) required by the pending operation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">internals</span> <span class="o">=</span> <span class="p">[</span>
              <span class="s1">&#39;.. internal attributes:&#39;</span><span class="p">,</span>
              <span class="s1">&#39;     .transform: </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
              <span class="s1">&#39;     .details:&#39;</span><span class="p">]</span>
        <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">details</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="n">internals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7s%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">internals</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%9s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">pformat</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> \
                  <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Node</span><span class="p">):</span>
                <span class="n">internals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7s%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">internals</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%9s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">pformat</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">internals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7s%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Element</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s1">&#39;    </span><span class="si">%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">internals</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawsource</span><span class="p">,</span>
                              <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">raw</span><span class="p">(</span><span class="n">Special</span><span class="p">,</span> <span class="n">Inline</span><span class="p">,</span> <span class="n">PreBibliographic</span><span class="p">,</span> <span class="n">FixedTextElement</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raw data that is to be passed untouched to the Writer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="c1"># =================</span>
<span class="c1">#  Inline Elements</span>
<span class="c1"># =================</span>

<span class="k">class</span> <span class="nc">emphasis</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">strong</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">literal</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">reference</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Inline</span><span class="p">,</span> <span class="n">Referential</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">footnote_reference</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">Referential</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">citation_reference</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">Referential</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">substitution_reference</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">title_reference</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">abbreviation</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">acronym</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">superscript</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">subscript</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">math</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">image</span><span class="p">(</span><span class="n">General</span><span class="p">,</span> <span class="n">Inline</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">inline</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">problematic</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">generated</span><span class="p">(</span><span class="n">Inline</span><span class="p">,</span> <span class="n">TextElement</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># ========================================</span>
<span class="c1">#  Auxiliary Classes, Functions, and Data</span>
<span class="c1"># ========================================</span>

<span class="n">node_class_names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Text</span>
<span class="s2">    abbreviation acronym address admonition attention attribution author</span>
<span class="s2">        authors</span>
<span class="s2">    block_quote bullet_list</span>
<span class="s2">    caption caution citation citation_reference classifier colspec comment</span>
<span class="s2">        compound contact container copyright</span>
<span class="s2">    danger date decoration definition definition_list definition_list_item</span>
<span class="s2">        description docinfo doctest_block document</span>
<span class="s2">    emphasis entry enumerated_list error</span>
<span class="s2">    field field_body field_list field_name figure footer</span>
<span class="s2">        footnote footnote_reference</span>
<span class="s2">    generated</span>
<span class="s2">    header hint</span>
<span class="s2">    image important inline</span>
<span class="s2">    label legend line line_block list_item literal literal_block</span>
<span class="s2">    math math_block</span>
<span class="s2">    note</span>
<span class="s2">    option option_argument option_group option_list option_list_item</span>
<span class="s2">        option_string organization</span>
<span class="s2">    paragraph pending problematic</span>
<span class="s2">    raw reference revision row rubric</span>
<span class="s2">    section sidebar status strong subscript substitution_definition</span>
<span class="s2">        substitution_reference subtitle superscript system_message</span>
<span class="s2">    table target tbody term tgroup thead tip title title_reference topic</span>
<span class="s2">        transition</span>
<span class="s2">    version</span>
<span class="s2">    warning&quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;A list of names of all concrete Node subclasses.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">NodeVisitor</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;Visitor&quot; pattern [GoF95]_ abstract superclass implementation for</span>
<span class="sd">    document tree traversals.</span>

<span class="sd">    Each node class has corresponding methods, doing nothing by</span>
<span class="sd">    default; override individual methods for specific and useful</span>
<span class="sd">    behaviour.  The `dispatch_visit()` method is called by</span>
<span class="sd">    `Node.walk()` upon entering a node.  `Node.walkabout()` also calls</span>
<span class="sd">    the `dispatch_departure()` method before exiting a node.</span>

<span class="sd">    The dispatch methods call &quot;``visit_`` + node class name&quot; or</span>
<span class="sd">    &quot;``depart_`` + node class name&quot;, resp.</span>

<span class="sd">    This is a base class for visitors whose ``visit_...`` &amp; ``depart_...``</span>
<span class="sd">    methods should be implemented for *all* node types encountered (such as</span>
<span class="sd">    for `docutils.writers.Writer` subclasses).  Unimplemented methods will</span>
<span class="sd">    raise exceptions.</span>

<span class="sd">    For sparse traversals, where only certain node types are of interest,</span>
<span class="sd">    subclass `SparseNodeVisitor` instead.  When (mostly or entirely) uniform</span>
<span class="sd">    processing is desired, subclass `GenericNodeVisitor`.</span>

<span class="sd">    .. [GoF95] Gamma, Helm, Johnson, Vlissides. *Design Patterns: Elements of</span>
<span class="sd">       Reusable Object-Oriented Software*. Addison-Wesley, Reading, MA, USA,</span>
<span class="sd">       1995.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">optional</span> <span class="o">=</span> <span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tuple containing node class names (as strings).</span>

<span class="sd">    No exception will be raised if writers do not implement visit</span>
<span class="sd">    or departure functions for these node classes.</span>

<span class="sd">    Used to ensure transitional compatibility with existing 3rd-party writers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">document</span>

    <span class="k">def</span> <span class="nf">dispatch_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call self.&quot;``visit_`` + node class name&quot; with `node` as</span>
<span class="sd">        parameter.  If the ``visit_...`` method does not exist, call</span>
<span class="sd">        self.unknown_visit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;visit_&#39;</span> <span class="o">+</span> <span class="n">node_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_visit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;docutils.nodes.NodeVisitor.dispatch_visit calling </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">node_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispatch_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call self.&quot;``depart_`` + node class name&quot; with `node` as</span>
<span class="sd">        parameter.  If the ``depart_...`` method does not exist, call</span>
<span class="sd">        self.unknown_departure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;depart_&#39;</span> <span class="o">+</span> <span class="n">node_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_departure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;docutils.nodes.NodeVisitor.dispatch_departure calling </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">node_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unknown_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when entering unknown `Node` types.</span>

<span class="sd">        Raise an exception unless overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">strict_visitor</span>
             <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optional</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> visiting unknown node type: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">unknown_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called before exiting unknown `Node` types.</span>

<span class="sd">        Raise exception unless overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">strict_visitor</span>
             <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optional</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> departing unknown node type: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">SparseNodeVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for sparse traversals, where only certain node types are of</span>
<span class="sd">    interest.  When ``visit_...`` &amp; ``depart_...`` methods should be</span>
<span class="sd">    implemented for *all* node types (such as for `docutils.writers.Writer`</span>
<span class="sd">    subclasses), subclass `NodeVisitor` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">GenericNodeVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic &quot;Visitor&quot; abstract superclass, for simple traversals.</span>

<span class="sd">    Unless overridden, each ``visit_...`` method calls `default_visit()`, and</span>
<span class="sd">    each ``depart_...`` method (when using `Node.walkabout()`) calls</span>
<span class="sd">    `default_departure()`. `default_visit()` (and `default_departure()`) must</span>
<span class="sd">    be overridden in subclasses.</span>

<span class="sd">    Define fully generic visitors by overriding `default_visit()` (and</span>
<span class="sd">    `default_departure()`) only. Define semi-generic visitors by overriding</span>
<span class="sd">    individual ``visit_...()`` (and ``depart_...()``) methods also.</span>

<span class="sd">    `NodeVisitor.unknown_visit()` (`NodeVisitor.unknown_departure()`) should</span>
<span class="sd">    be overridden for default behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">default_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override for generic, uniform traversals.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">default_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override for generic, uniform traversals.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">def</span> <span class="nf">_call_default_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_call_default_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_departure</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_nop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_add_node_class_names</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save typing with dynamic assignments:&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">GenericNodeVisitor</span><span class="p">,</span> <span class="s2">&quot;visit_&quot;</span> <span class="o">+</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_call_default_visit</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">GenericNodeVisitor</span><span class="p">,</span> <span class="s2">&quot;depart_&quot;</span> <span class="o">+</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_call_default_departure</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">SparseNodeVisitor</span><span class="p">,</span> <span class="s1">&#39;visit_&#39;</span> <span class="o">+</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_nop</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">SparseNodeVisitor</span><span class="p">,</span> <span class="s1">&#39;depart_&#39;</span> <span class="o">+</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_nop</span><span class="p">)</span>

<span class="n">_add_node_class_names</span><span class="p">(</span><span class="n">node_class_names</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TreeCopyVisitor</span><span class="p">(</span><span class="n">GenericNodeVisitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a complete copy of a tree or branch, including element attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="n">GenericNodeVisitor</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get_tree_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">default_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy the current node, and make it the new acting parent.&quot;&quot;&quot;</span>
        <span class="n">newnode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newnode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">default_departure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore the previous acting parent.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TreePruningException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for `NodeVisitor`-related tree pruning exceptions.</span>

<span class="sd">    Raise subclasses from within ``visit_...`` or ``depart_...`` methods</span>
<span class="sd">    called from `Node.walk()` and `Node.walkabout()` tree traversals to prune</span>
<span class="sd">    the tree traversed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SkipChildren</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not visit any children of the current node.  The current node&#39;s</span>
<span class="sd">    siblings and ``depart_...`` method are not affected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SkipSiblings</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not visit any more siblings (to the right) of the current node.  The</span>
<span class="sd">    current node&#39;s children and its ``depart_...`` method are not affected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SkipNode</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not visit the current node&#39;s children, and do not call the current</span>
<span class="sd">    node&#39;s ``depart_...`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SkipDeparture</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not call the current node&#39;s ``depart_...`` method.  The current node&#39;s</span>
<span class="sd">    children and siblings are not affected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">NodeFound</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise to indicate that the target of a search has been found.  This</span>
<span class="sd">    exception must be caught by the client; it is not caught by the traversal</span>
<span class="sd">    code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">StopTraversal</span><span class="p">(</span><span class="n">TreePruningException</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop the traversal alltogether.  The current node&#39;s ``depart_...`` method</span>
<span class="sd">    is not affected.  The parent nodes ``depart_...`` methods are also called</span>
<span class="sd">    as usual.  No other nodes are visited.  This is an alternative to</span>
<span class="sd">    NodeFound that does not cause exception handling to trickle up to the</span>
<span class="sd">    caller.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">make_id</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert `string` into an identifier and return it.</span>

<span class="sd">    Docutils identifiers will conform to the regular expression</span>
<span class="sd">    ``[a-z](-?[a-z0-9]+)*``.  For CSS compatibility, identifiers (the &quot;class&quot;</span>
<span class="sd">    and &quot;id&quot; attributes) should have no underscores, colons, or periods.</span>
<span class="sd">    Hyphens may be used.</span>

<span class="sd">    - The `HTML 4.01 spec`_ defines identifiers based on SGML tokens:</span>

<span class="sd">          ID and NAME tokens must begin with a letter ([A-Za-z]) and may be</span>
<span class="sd">          followed by any number of letters, digits ([0-9]), hyphens (&quot;-&quot;),</span>
<span class="sd">          underscores (&quot;_&quot;), colons (&quot;:&quot;), and periods (&quot;.&quot;).</span>

<span class="sd">    - However the `CSS1 spec`_ defines identifiers based on the &quot;name&quot; token,</span>
<span class="sd">      a tighter interpretation (&quot;flex&quot; tokenizer notation; &quot;latin1&quot; and</span>
<span class="sd">      &quot;escape&quot; 8-bit characters have been replaced with entities)::</span>

<span class="sd">          unicode     \\[0-9a-f]{1,4}</span>
<span class="sd">          latin1      [&amp;iexcl;-&amp;yuml;]</span>
<span class="sd">          escape      {unicode}|\\[ -~&amp;iexcl;-&amp;yuml;]</span>
<span class="sd">          nmchar      [-a-z0-9]|{latin1}|{escape}</span>
<span class="sd">          name        {nmchar}+</span>

<span class="sd">    The CSS1 &quot;nmchar&quot; rule does not include underscores (&quot;_&quot;), colons (&quot;:&quot;),</span>
<span class="sd">    or periods (&quot;.&quot;), therefore &quot;class&quot; and &quot;id&quot; attributes should not contain</span>
<span class="sd">    these characters. They should be replaced with hyphens (&quot;-&quot;). Combined</span>
<span class="sd">    with HTML&#39;s requirements (the first character must be a letter; no</span>
<span class="sd">    &quot;unicode&quot;, &quot;latin1&quot;, or &quot;escape&quot; characters), this results in the</span>
<span class="sd">    ``[a-z](-?[a-z0-9]+)*`` pattern.</span>

<span class="sd">    .. _HTML 4.01 spec: http://www.w3.org/TR/html401</span>
<span class="sd">    .. _CSS1 spec: http://www.w3.org/TR/REC-CSS1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_non_id_translate_digraphs</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_non_id_translate</span><span class="p">)</span>
    <span class="c1"># get rid of non-ascii characters.</span>
    <span class="c1"># &#39;ascii&#39; lowercase to prevent problems with turkish locale.</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span>\
         <span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="c1"># shrink runs of whitespace and replace by hyphen</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">_non_id_chars</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">_non_id_at_ends</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

<span class="n">_non_id_chars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[^a-z0-9]+&#39;</span><span class="p">)</span>
<span class="n">_non_id_at_ends</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^[-0-9]+|-+$&#39;</span><span class="p">)</span>
<span class="n">_non_id_translate</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x00f8</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>       <span class="c1"># o with stroke</span>
    <span class="mh">0x0111</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>       <span class="c1"># d with stroke</span>
    <span class="mh">0x0127</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>       <span class="c1"># h with stroke</span>
    <span class="mh">0x0131</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;i&#39;</span><span class="p">,</span>       <span class="c1"># dotless i</span>
    <span class="mh">0x0142</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;l&#39;</span><span class="p">,</span>       <span class="c1"># l with stroke</span>
    <span class="mh">0x0167</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>       <span class="c1"># t with stroke</span>
    <span class="mh">0x0180</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>       <span class="c1"># b with stroke</span>
    <span class="mh">0x0183</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>       <span class="c1"># b with topbar</span>
    <span class="mh">0x0188</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>       <span class="c1"># c with hook</span>
    <span class="mh">0x018c</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>       <span class="c1"># d with topbar</span>
    <span class="mh">0x0192</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;f&#39;</span><span class="p">,</span>       <span class="c1"># f with hook</span>
    <span class="mh">0x0199</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>       <span class="c1"># k with hook</span>
    <span class="mh">0x019a</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;l&#39;</span><span class="p">,</span>       <span class="c1"># l with bar</span>
    <span class="mh">0x019e</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;n&#39;</span><span class="p">,</span>       <span class="c1"># n with long right leg</span>
    <span class="mh">0x01a5</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;p&#39;</span><span class="p">,</span>       <span class="c1"># p with hook</span>
    <span class="mh">0x01ab</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>       <span class="c1"># t with palatal hook</span>
    <span class="mh">0x01ad</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>       <span class="c1"># t with hook</span>
    <span class="mh">0x01b4</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>       <span class="c1"># y with hook</span>
    <span class="mh">0x01b6</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;z&#39;</span><span class="p">,</span>       <span class="c1"># z with stroke</span>
    <span class="mh">0x01e5</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>       <span class="c1"># g with stroke</span>
    <span class="mh">0x0225</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;z&#39;</span><span class="p">,</span>       <span class="c1"># z with hook</span>
    <span class="mh">0x0234</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;l&#39;</span><span class="p">,</span>       <span class="c1"># l with curl</span>
    <span class="mh">0x0235</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;n&#39;</span><span class="p">,</span>       <span class="c1"># n with curl</span>
    <span class="mh">0x0236</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>       <span class="c1"># t with curl</span>
    <span class="mh">0x0237</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;j&#39;</span><span class="p">,</span>       <span class="c1"># dotless j</span>
    <span class="mh">0x023c</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>       <span class="c1"># c with stroke</span>
    <span class="mh">0x023f</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>       <span class="c1"># s with swash tail</span>
    <span class="mh">0x0240</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;z&#39;</span><span class="p">,</span>       <span class="c1"># z with swash tail</span>
    <span class="mh">0x0247</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;e&#39;</span><span class="p">,</span>       <span class="c1"># e with stroke</span>
    <span class="mh">0x0249</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;j&#39;</span><span class="p">,</span>       <span class="c1"># j with stroke</span>
    <span class="mh">0x024b</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;q&#39;</span><span class="p">,</span>       <span class="c1"># q with hook tail</span>
    <span class="mh">0x024d</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>       <span class="c1"># r with stroke</span>
    <span class="mh">0x024f</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>       <span class="c1"># y with stroke</span>
<span class="p">}</span>
<span class="n">_non_id_translate_digraphs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x00df</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;sz&#39;</span><span class="p">,</span>      <span class="c1"># ligature sz</span>
    <span class="mh">0x00e6</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;ae&#39;</span><span class="p">,</span>      <span class="c1"># ae</span>
    <span class="mh">0x0153</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;oe&#39;</span><span class="p">,</span>      <span class="c1"># ligature oe</span>
    <span class="mh">0x0238</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;db&#39;</span><span class="p">,</span>      <span class="c1"># db digraph</span>
    <span class="mh">0x0239</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;qp&#39;</span><span class="p">,</span>      <span class="c1"># qp digraph</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">dupname</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">node</span><span class="p">[</span><span class="s1">&#39;dupnames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">node</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># Assume that this method is referenced, even though it isn&#39;t; we</span>
    <span class="c1"># don&#39;t want to throw unnecessary system_messages.</span>
    <span class="n">node</span><span class="o">.</span><span class="n">referenced</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">fully_normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a case- and whitespace-normalized name.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">whitespace_normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a whitespace-normalized name.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">serial_escape</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Escape string values that are elements of a list, for serialization.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ &#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pseudo_quoteattr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quote attributes for pseudo-xml&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span>

<span class="c1"># 
</span>
<span class="c1">#</span>
<span class="c1"># Local Variables:</span>
<span class="c1"># indent-tabs-mode: nil</span>
<span class="c1"># sentence-end-double-space: t</span>
<span class="c1"># fill-column: 78</span>
<span class="c1"># End:</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../contents.html">Docs</a>|&nbsp;</li>
        <li><a href="../../user.faq.html">FAQ</a>|&nbsp;</li>
<!--         <li><a href="../../search.html">chercher</a>|&nbsp;</li> -->
        <li><a href="../../gallery.html">Gallery</a>|&nbsp;</li>
        <li><a href="https://forge.ifremer.fr/projects/vacumm">Forge</a>&nbsp; &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Actimar/IFREMER.
      Last updated on 21 Jan 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>